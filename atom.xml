<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å­™åŒç”Ÿçš„åšå®¢</title>
  
  <subtitle>ä¸ºç¾å¥½çš„ä¸–ç•ŒçŒ®ä¸Šç¥ç¦</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://developerdoc.com/"/>
  <updated>2024-06-11T12:51:28.669Z</updated>
  <id>https://developerdoc.com/</id>
  
  <author>
    <name>SunTongSheng</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS Appå¯åŠ¨ä¼˜åŒ–</title>
    <link href="https://developerdoc.com/App%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/"/>
    <id>https://developerdoc.com/Appå¯åŠ¨ä¼˜åŒ–/</id>
    <published>2022-06-06T12:57:54.000Z</published>
    <updated>2024-06-11T12:51:28.669Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¯åŠ¨è¿‡ç¨‹"><a href="#å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹"></a>å¯åŠ¨è¿‡ç¨‹</h3><p>iOSåº”ç”¨çš„å¯åŠ¨å¯åˆ†ä¸ºpre-mainé˜¶æ®µå’Œmain()é˜¶æ®µï¼Œpre-mainé˜¶æ®µä¸ºmainå‡½æ•°æ‰§è¡Œä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œmainé˜¶æ®µä¸ºmainå‡½æ•°åˆ°é¦–é¡µå±•ç¤ºé˜¶æ®µã€‚å…¶ä¸­ç³»ç»Ÿåšçš„äº‹æƒ…ä¸ºï¼š</p><ul><li>premain<ul><li>åŠ è½½æ‰€æœ‰ä¾èµ–çš„Mach-Oæ–‡ä»¶ï¼ˆé€’å½’è°ƒç”¨Mach-OåŠ è½½çš„æ–¹æ³•ï¼‰</li><li>åŠ è½½åŠ¨æ€é“¾æ¥åº“åŠ è½½å™¨dyldï¼ˆdynamic loaderï¼‰</li><li>å®šä½å†…éƒ¨ã€å¤–éƒ¨æŒ‡é’ˆå¼•ç”¨ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å‡½æ•°ç­‰</li><li>åŠ è½½ç±»æ‰©å±•ï¼ˆCategoryï¼‰ä¸­çš„æ–¹æ³•</li><li>C++é™æ€å¯¹è±¡åŠ è½½ã€è°ƒç”¨ObjCçš„ +load å‡½æ•°</li><li>æ‰§è¡Œå£°æ˜ä¸º<strong>attribute</strong>((constructor))çš„Cå‡½æ•°</li></ul></li><li>main<ul><li>è°ƒç”¨main()</li><li>è°ƒç”¨UIApplicationMain()</li><li>è°ƒç”¨applicationWillFinishLaunching</li></ul></li></ul><a id="more"></a><h3 id="ä¼˜åŒ–æ€è·¯"><a href="#ä¼˜åŒ–æ€è·¯" class="headerlink" title="ä¼˜åŒ–æ€è·¯"></a>ä¼˜åŒ–æ€è·¯</h3><ul><li>æœ€å¤šçš„ç”¨æ—¶è¿˜æ˜¯åœ¨imageåŠ è½½å’ŒOCç±»çš„åˆå§‹åŒ–ï¼Œå…±å ç”¨æ€»æ—¶é•¿çš„79.3%ï¼Œç²¾ç®€frameworkçš„å¼•å…¥å’ŒOCç±»æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚ä¼˜åŒ–ç‚¹ï¼š<ul><li>å‡å°‘ä¸å¿…è¦çš„frameworkï¼Œå› ä¸ºåŠ¨æ€é“¾æ¥æ¯”è¾ƒè€—æ—¶ | ä¸è¦è‡ªå·±ä½¿ç”¨dlopenæ–¹æ³•ï¼Œè®©ç³»ç»Ÿæ¥å¤„ç†æ¨¡å—åŠ è½½</li><li>åˆå¹¶æˆ–è€…åˆ å‡ä¸€äº›OCç±»ï¼Œå…³äºæ¸…ç†é¡¹ç›®ä¸­æ²¡ç”¨åˆ°çš„ç±»ï¼Œä½¿ç”¨å·¥å…·AppCodeä»£ç æ£€æŸ¥åŠŸèƒ½ï¼ŒæŸ¥åˆ°å½“å‰é¡¹ç›®ä¸­æ²¡æœ‰ç”¨åˆ°çš„ç±»å¦‚ä¸‹ï¼š</li><li>åˆ å‡ä¸€äº›æ— ç”¨çš„é™æ€å˜é‡ | åˆ å‡æ²¡æœ‰è¢«è°ƒç”¨åˆ°æˆ–è€…å·²ç»åºŸå¼ƒçš„æ–¹æ³•</li><li>å°†ä¸å¿…é¡»åœ¨+loadæ–¹æ³•ä¸­åšçš„äº‹æƒ…å»¶è¿Ÿ</li></ul></li><li>å¯¹äºmain()å‡½æ•°è°ƒç”¨ä¹‹å‰æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–çš„ç‚¹æœ‰ï¼š<ul><li>ä¸ä½¿ç”¨xibï¼Œç›´æ¥è§†ç”¨ä»£ç åŠ è½½é¦–é¡µè§†å›¾ | é¦–é¡µéª¨æ¶å± é»˜è®¤æ•°æ®</li><li>NSUserDefaultså®é™…ä¸Šæ˜¯åœ¨Libraryæ–‡ä»¶å¤¹ä¸‹ä¼šç”Ÿäº§ä¸€ä¸ªplistæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å¤ªå¤§çš„è¯ä¸€æ¬¡èƒ½è¯»å–åˆ°å†…å­˜ä¸­å¯èƒ½å¾ˆè€—æ—¶ï¼Œè¿™ä¸ªå½±å“éœ€è¦è¯„ä¼°ï¼Œå¦‚æœè€—æ—¶å¾ˆå¤§çš„è¯éœ€è¦æ‹†åˆ†(éœ€è€ƒè™‘è€ç‰ˆæœ¬è¦†ç›–å®‰è£…å…¼å®¹é—®é¢˜)</li><li>æ¯æ¬¡ç”¨NSLogæ–¹å¼æ‰“å°ä¼šéšå¼çš„åˆ›å»ºä¸€ä¸ªCalendarï¼Œå› æ­¤éœ€è¦åˆ å‡å¯åŠ¨æ—¶å„ä¸šåŠ¡æ–¹æ‰“çš„logï¼Œæˆ–è€…ä»…ä»…é’ˆå¯¹å†…æµ‹ç‰ˆè¾“å‡ºlog</li><li>å¯¹didFinishLaunchingé‡Œçš„å‡½æ•°è€ƒè™‘èƒ½å¦æŒ–æ˜å¯ä»¥å»¶è¿ŸåŠ è½½æˆ–è€…æ‡’åŠ è½½ï¼Œéœ€è¦ä¸å„ä¸ªä¸šåŠ¡æ–¹pmå’Œrdå…±åŒcheck å¯¹äºä¸€äº›å·²ç»ä¸‹çº¿çš„ä¸šåŠ¡ï¼Œåˆ å‡å†—ä½™ä»£ç ã€‚ å¯¹äºä¸€äº›ä¸UIå±•ç¤ºæ— å…³çš„ä¸šåŠ¡ï¼Œå¦‚å¾®åšè®¤è¯è¿‡æœŸæ£€æŸ¥ã€å›¾ç‰‡æœ€å¤§ç¼“å­˜ç©ºé—´è®¾ç½®ç­‰åšå»¶è¿ŸåŠ è½½</li></ul></li></ul><h3 id="ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•"><a href="#ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•" class="headerlink" title="ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•"></a>ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•</h3><p>è¿™ä¸€é˜¶æ®µå°±æ˜¯éœ€è¦å¯¹å¯åŠ¨è¿‡ç¨‹çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œæ¢³ç†ï¼Œç¡®è®¤å“ªäº›æ˜¯å¯ä»¥å»¶è¿ŸåŠ è½½çš„ï¼Œå“ªäº›å¯ä»¥æ”¾åœ¨å­çº¿ç¨‹åŠ è½½ï¼Œä»¥åŠå“ªäº›æ˜¯å¯ä»¥æ‡’åŠ è½½å¤„ç†çš„ã€‚åŒæ—¶å¯¹è€—æ—¶æ¯”è¾ƒä¸¥é‡çš„æ–¹æ³•è¿›è¡Œreviewå¹¶æå‡ºä¼˜åŒ–ç­–ç•¥è¿›è¡Œä¼˜åŒ–ã€‚</p><blockquote><p>DYLD_PRINT_STATISTICS_DETAILS<br>instrument TimeProfile</p></blockquote><p>Instrumentsçš„TimeProfileæ¥ç»Ÿè®¡å¯åŠ¨æ—¶çš„ä¸»è¦æ–¹æ³•è€—æ—¶ï¼ŒCall Tree-&gt;Hide System Libraries</p><blockquote><p>æ‰“å°æ—¶é—´çš„æ–¹å¼æ¥ç»Ÿè®¡å„ä¸ªå‡½æ•°çš„è€—æ—¶</p></blockquote><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> launchTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">[SDWebImageManager sharedManager];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"launchTime = %fç§’"</span>, <span class="built_in">CFAbsoluteTimeGetCurrent</span>() - launchTime);</span><br></pre></td></tr></table></figure><blockquote><p>+loadæ–¹æ³•ç»Ÿè®¡</p></blockquote><p>åŒæ ·çš„æˆ‘ä»¬å¯ä»¥é€šè¿‡Instrumentsæ¥ç»Ÿè®¡å¯åŠ¨æ—¶æ‰€æœ‰çš„+loadæ–¹æ³•ï¼Œä»¥åŠ+loadæ–¹æ³•æ‰€ç”¨è€—æ—¶</p><h3 id="loadä¼˜åŒ–-ä¸-attribute"><a href="#loadä¼˜åŒ–-ä¸-attribute" class="headerlink" title="+loadä¼˜åŒ– ä¸ attribute"></a>+loadä¼˜åŒ– ä¸ attribute</h3><p>ä½¿ç”¨__attributeä¼˜åŒ–+loadæ–¹æ³• ç”±äºåœ¨æˆ‘ä»¬çš„å·¥ç¨‹ä¸­å­˜åœ¨å¾ˆå¤šçš„+loadæ–¹æ³•ï¼Œè€Œå…¶ä¸­ä¸€å¤§éƒ¨åˆ†ä¸ºcellæ¨¡æ¿æ³¨å†Œçš„+loadæ–¹æ³•(æˆ‘ä»¬çš„æ¯ä¸€ä¸ªcellå¯¹åº”ä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åè¯¥æ¨¡æ¿å¯¹åº”ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å¯åŠ¨æ—¶æ‰€æœ‰çš„æ¨¡æ¿æ–¹æ³•éƒ½åœ¨+loadä¸­æ³¨å†Œå¯¹åº”çš„å­—ç¬¦ä¸²å³åœ¨å­—å…¸ä¸­å­˜å‚¨å­—ç¬¦ä¸²å’Œå¯¹åº”çš„cellæ¨¡æ¿ï¼Œç„¶ååŠ¨æ€ä¸‹å‘å±•ç¤ºå¯¹åº”çš„cell)ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ç¼–è¯‘å™¨æä¾›äº†æˆ‘ä»¬ä¸€ç§__attribute__((section(&quot;xxxæ®µï¼ŒxxxèŠ‚&quot;)çš„æ–¹å¼è®©æˆ‘ä»¬å°†ä¸€ä¸ªæŒ‡å®šçš„æ•°æ®å‚¨å­˜åˆ°æˆ‘ä»¬éœ€è¦çš„èŠ‚å½“ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">åœ¨BeeHiveæ¡†æ¶ä¸­ï¼š</span><br><span class="line"></span><br><span class="line">```objc</span><br><span class="line">@class BeeHive; char * kShopModule_mod __attribute((used, section(&quot;__DATA,&quot;&quot;BeehiveMods&quot;&quot;&quot;))) = &quot;&quot;&quot;ShopModule&quot;&quot;&quot;;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä½¿ç”¨<strong>attribute</strong>((section(â€œnameâ€)))æ¥æŒ‡æ˜å“ªä¸ªæ®µã€‚æ•°æ®åˆ™ç”¨<strong>attribute</strong>((used))æ¥æ ‡è®°ï¼Œé˜²æ­¢é“¾æ¥å™¨ä¼šä¼˜åŒ–åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ®µã€‚</p><p>è¯»å–sectionä¸­çš„å€¼ attribute((constructor))<br>constructor å’Œ +load éƒ½æ˜¯åœ¨ main å‡½æ•°æ‰§è¡Œå‰è°ƒç”¨ï¼Œä½† +load æ¯” constructor æ›´åŠ æ—©ä¸€ä¸¢ä¸¢ï¼Œå› ä¸º dyldï¼ˆåŠ¨æ€é“¾æ¥å™¨ï¼Œç¨‹åºçš„æœ€åˆèµ·ç‚¹ï¼‰åœ¨åŠ è½½ imageï¼ˆå¯ä»¥ç†è§£æˆ Mach-O æ–‡ä»¶ï¼‰æ—¶ä¼šå…ˆé€šçŸ¥ objc runtime å»åŠ è½½å…¶ä¸­æ‰€æœ‰çš„ç±»ï¼Œæ¯åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œå®ƒçš„ +load éšä¹‹è°ƒç”¨ï¼Œå…¨éƒ¨åŠ è½½å®Œæˆåï¼Œdyld æ‰ä¼šè°ƒç”¨è¿™ä¸ª image ä¸­æ‰€æœ‰çš„ constructor æ–¹æ³•ã€‚æ‰€ä»¥ constructor æ˜¯ä¸€ä¸ªå¹²åäº‹çš„ç»ä½³æ—¶æœºï¼š</p><ul><li>æ‰€æœ‰Classéƒ½å·²ç»åŠ è½½å®Œæˆ</li><li>main å‡½æ•°è¿˜æœªæ‰§è¡Œ</li><li>æ— éœ€åƒ +load è¿˜å¾—æŒ‚è½½åœ¨ä¸€ä¸ªClassä¸­</li></ul><p>åœ¨BeeHiveæºç ä¸­æœ‰ä¸‹é¢ä¸€æ®µä»£ç ï¼š</p><p><code>_dyld_register_func_for_add_image</code> :è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥æ³¨å†Œå›è°ƒï¼Œå½“dyldé“¾æ¥ç¬¦å·æ—¶ï¼Œè°ƒç”¨æ­¤å›è°ƒå‡½æ•°ã€‚åœ¨dyldåŠ è½½é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°</p><p>å¯¹äºæ¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é•œåƒï¼Œå½“å®ƒè¢«åŠ¨æ€é“¾æ¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒvoid (func)(const struct mach_header mh, intptr_t vmaddr_slide)ï¼Œä¼ å…¥æ–‡ä»¶çš„mach_headerä»¥åŠä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ intptr_tã€‚</p><p>é€šè¿‡è°ƒç”¨BHReadConfigurationå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°ä¹‹å‰æ³¨å†Œåˆ°BeehiveModsç‰¹æ®Šæ®µé‡Œé¢çš„å„ä¸ªModuleçš„ç±»åï¼Œè¯¥å‡½æ•°è¿”å›ç±»åå­—ç¬¦ä¸²çš„æ•°ç»„ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="keyword">void</span> initProphet() &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(dyld_callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> dyld_callback(<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mhp, intptr_t vmaddr_slide)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *mods = BHReadConfiguration(BeehiveModSectName, mhp);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *modName <span class="keyword">in</span> mods) &#123;</span><br><span class="line">        Class cls;</span><br><span class="line">        <span class="keyword">if</span> (modName) &#123;</span><br><span class="line">            cls = <span class="built_in">NSClassFromString</span>(modName);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                [[BHModuleManager sharedManager] registerDynamicModule:cls];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt;* BHReadConfiguration(<span class="keyword">char</span> *sectionName,<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mhp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *configs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#ifndef __LP64__</span></span><br><span class="line">    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &amp;size);</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *mhp64 = (<span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *)mhp;</span><br><span class="line">    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &amp;size);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> counter = size/<span class="keyword">sizeof</span>(<span class="keyword">void</span>*);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; counter; ++idx)&#123;</span><br><span class="line">        <span class="keyword">char</span> *string = (<span class="keyword">char</span>*)memory[idx];</span><br><span class="line">        <span class="built_in">NSString</span> *str = [<span class="built_in">NSString</span> stringWithUTF8String:string];</span><br><span class="line">        <span class="keyword">if</span>(!str)<span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        BHLog(<span class="string">@"config = %@"</span>, str);</span><br><span class="line">        <span class="keyword">if</span>(str) [configs addObject:str];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> configs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äºŒè¿›åˆ¶é‡æ’-é™æ€æ’æ¡©"><a href="#äºŒè¿›åˆ¶é‡æ’-é™æ€æ’æ¡©" class="headerlink" title="äºŒè¿›åˆ¶é‡æ’ + é™æ€æ’æ¡©"></a>äºŒè¿›åˆ¶é‡æ’ + é™æ€æ’æ¡©</h3><p>é™æ€æ’æ¡©å®é™…ä¸Šæ˜¯åœ¨ç¼–è¯‘æœŸå°±åœ¨æ¯ä¸€ä¸ªå‡½æ•°å†…éƒ¨äºŒè¿›åˆ¶æºæ•°æ®æ·»åŠ  hook ä»£ç  ( æˆ‘ä»¬æ·»åŠ çš„ __sanitizer_cov_trace_pc_guard å‡½æ•° ) æ¥å®ç°å…¨å±€çš„æ–¹æ³• hook çš„æ•ˆæœ .</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __sanitizer_cov_trace_pc_guard(uint32_t *guard) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!*guard) <span class="keyword">return</span>;  <span class="comment">// Duplicate the guard check.</span></span><br><span class="line">    <span class="comment">//å®ƒçš„ä½œç”¨å…¶å®å°±æ˜¯å»è¯»å– x30 ä¸­æ‰€å­˜å‚¨çš„è¦è¿”å›æ—¶ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ . æ‰€ä»¥ä»–åç§°å«åš __builtin_return_address . æ¢å¥è¯è¯´ , è¿™ä¸ªåœ°å€å°±æ˜¯æˆ‘å½“å‰è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•å , è¦è¿”å›åˆ°å“ªé‡Œå» .</span></span><br><span class="line">    <span class="keyword">void</span> *PC = __builtin_return_address(<span class="number">0</span>);</span><br><span class="line">    Dl_info info;</span><br><span class="line">    dladdr(PC, &amp;info);</span><br><span class="line">    </span><br><span class="line">    printf(<span class="string">"fname=%s \nfbase=%p \nsname=%s\nsaddr=%p \n"</span>,info.dli_fname,info.dli_fbase,info.dli_sname,info.dli_saddr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> PcDescr[<span class="number">1024</span>];</span><br><span class="line">    printf(<span class="string">"guard: %p %x PC %s\n"</span>, guard, *guard, PcDescr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>é—®é¢˜ç‚¹</p></blockquote><ul><li>å¤šçº¿ç¨‹é—®é¢˜<ul><li>è€ƒè™‘åˆ°è¿™ä¸ªæ–¹æ³•ä¼šæ¥ç‰¹åˆ«å¤šæ¬¡ , ä½¿ç”¨é”ä¼šå½±å“æ€§èƒ½ , è¿™é‡Œä½¿ç”¨è‹¹æœåº•å±‚çš„åŸå­é˜Ÿåˆ— ( åº•å±‚å®é™…ä¸Šæ˜¯ä¸ªæ ˆç»“æ„ , åˆ©ç”¨é˜Ÿåˆ—ç»“æ„ + åŸå­æ€§æ¥ä¿è¯é¡ºåº ) æ¥å®ç°</li></ul></li><li>å¾ªç¯å¼•ç”¨<ul><li>Other C Flags ä¿®æ”¹ä¸ºå¦‚ä¸‹ :-fsanitize-coverage=func,trace-pc-guard</li></ul></li><li>swift å·¥ç¨‹ / æ··ç¼–å·¥ç¨‹<pre><code>* Other Swift Flags , æ·»åŠ ä¸¤æ¡é…ç½®å³å¯ : -sanitize-coverage=func -sanitize=undefined</code></pre></li></ul><h3 id="å‹ç¼©èµ„æºå›¾ç‰‡"><a href="#å‹ç¼©èµ„æºå›¾ç‰‡" class="headerlink" title="å‹ç¼©èµ„æºå›¾ç‰‡"></a>å‹ç¼©èµ„æºå›¾ç‰‡</h3><p>å‹ç¼©å›¾ç‰‡ä¸ºä»€ä¹ˆèƒ½åŠ å¿«å¯åŠ¨é€Ÿåº¦å‘¢ï¼Ÿå› ä¸ºå¯åŠ¨çš„æ—¶å€™å¤§å¤§å°å°çš„å›¾ç‰‡åŠ è½½ä¸ªåæ¥äºŒåä¸ªæ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå›¾ç‰‡å°äº†ï¼ŒIOæ“ä½œé‡å°±å°äº†ï¼Œå¯åŠ¨å½“ç„¶å°±ä¼šå¿«äº†ã€‚</p><p>äº‹å®ä¸Šï¼ŒXcodeåœ¨ç¼–è¯‘Appçš„æ—¶å€™ï¼Œå·²ç»è‡ªåŠ¨æŠŠéœ€è¦æ‰“åŒ…åˆ°Appé‡Œçš„èµ„æºå›¾ç‰‡å‹ç¼©è¿‡ä¸€éäº†ã€‚ç„¶è€ŒXcodeçš„å‹ç¼©ä¼šç›¸å¯¹æ¯”è¾ƒä¿å®ˆã€‚</p><p>è§£å†³å„ç§çŸ›ç›¾çš„æ–¹æ³•å°±æ˜¯è¦æ‰¾å‡ºä¸€ç§ç›¸å½“é è°±çš„å‹ç¼©æ–¹æ³•ï¼Œè€Œä¸”æœ€å¥½æ˜¯åŸºæœ¬æ— æŸçš„ï¼Œè€Œä¸”å‹ç¼©ç‡è¿˜è¦ç‰¹åˆ«é«˜ï¼Œè‡³å°‘è¦æ¯”Xcodeè‡ªåŠ¨å‹ç¼©çš„æ•ˆæœè¦æ›´å¥½æ‰æœ‰æ„ä¹‰ã€‚ç»è¿‡å„ç§è¯•éªŒï¼Œæœ€åå‘ç°å”¯ä¸€å¯é çš„å‹ç¼©ç®—æ³•æ˜¯TinyPNG</p><h3 id="å›¾ç‰‡é¢„åŠ è½½"><a href="#å›¾ç‰‡é¢„åŠ è½½" class="headerlink" title="å›¾ç‰‡é¢„åŠ è½½"></a>å›¾ç‰‡é¢„åŠ è½½</h3><blockquote><p>åœ¨çœ‹ [UIImage imageNamed:] æ–‡æ¡£æ—¶å‘ç°ä¸€å¥è¯<br>In iOS 9 and later, this method is thread safe.</p></blockquote><p>çœ‹åˆ°å®ƒä¹‹åç«‹åˆ»æƒ³åˆ°ï¼Œèƒ½å¦åœ¨è¿›ç¨‹å¯åŠ¨æ—©æœŸé€šè¿‡å­çº¿ç¨‹é¢„å…ˆåŠ è½½é¦–é¡µå›¾ç‰‡ã€‚ä¸ºä»€ä¹ˆåœ¨æ—©æœŸå‘¢ï¼Ÿé€šè¿‡ Instruments åˆ†æå¯çœ‹åˆ°åœ¨æ”¯ä»˜å®å¯åŠ¨æ—©æœŸï¼ŒCPU å ç”¨æ˜¯ä¸é‚£ä¹ˆæ»¡çš„ï¼Œä¸ºäº†è®©å¯åŠ¨è¿‡ç¨‹ä¸­å……åˆ†åˆ©ç”¨ CPUï¼Œå°±å°½é‡åœ¨æ—©æœŸå¯åŠ¨å­çº¿ç¨‹ã€‚</p><blockquote><p>é—®é¢˜ä¸è§£å†³</p></blockquote><p>åœ¨ä¼˜åŒ–ä¹‹åï¼Œä¹Ÿä¼´éšè€Œæ¥ä¸€äº›ä¸ç¨³å®šçš„é—®é¢˜ï¼š</p><p>App å¯åŠ¨ä¼šæœ‰å°æ¦‚ç‡çš„ Crashã€‚</p><p>æ ¹æ®åˆ†æï¼Œæˆ‘ä»¬å†³å®šæŠŠè¿™æ®µä»£ç ç§»åˆ° AppDelegate çš„ didFinishLaunching ä¸­ï¼Œå¹¶ä¸”å¢åŠ å¼€å…³ã€‚</p><p>iPhone7 ä¸éœ€è¦é¢„åŠ è½½</p><p>åœ¨ iPhone7 è®¾å¤‡å‡ºæ¥åï¼Œæˆ‘ä»¬å‘ç° iPhone7 çš„å¯åŠ¨æ€§èƒ½åè€Œä¸å¦‚ iPhone6Sã€‚åˆ†æåå‘ç°ï¼Œåœ¨æ€§èƒ½æ›´å¥½çš„ iPhone7 ä¸Šï¼Œç”±äºå¯åŠ¨å¾ˆå¿«ï¼Œå¯¼è‡´å­çº¿ç¨‹çš„ imageNamed ä¸ ä¸»çº¿ç¨‹çš„ imageNamed ç›¸äº’ç©¿æ’è°ƒç”¨ï¼Œè€Œ imageNamed å†…éƒ¨çš„çº¿ç¨‹å®‰å…¨é”çš„ç²’åº¦å¾ˆå°ï¼Œå¯¼è‡´é”çš„æ¶ˆè€—è¿‡å¤§ã€‚</p><h3 id="å¯åŠ¨ä»»åŠ¡åˆ†ç±»"><a href="#å¯åŠ¨ä»»åŠ¡åˆ†ç±»" class="headerlink" title="å¯åŠ¨ä»»åŠ¡åˆ†ç±»"></a>å¯åŠ¨ä»»åŠ¡åˆ†ç±»</h3><p>Appå¯åŠ¨ä¸­çš„ä»»åŠ¡å¯ä»¥ç®€å•åˆ†ä¸ºä¸‹é¢å‡ ç±»ï¼š</p><ul><li>å¿…é¡»æœ€æ—©åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–çš„ä»»åŠ¡</li><li>å¯ä»¥å­çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡</li><li>å¯ä»¥ä¸2ä¸­çš„ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œçš„ä¸»çº¿ç¨‹ä»»åŠ¡</li><li>å¯ä»¥åœ¨é¦–é¡µæ˜¾ç¤ºåå­çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡</li></ul><h3 id="Background-Fetch-ç®€ä»‹"><a href="#Background-Fetch-ç®€ä»‹" class="headerlink" title="Background Fetch ç®€ä»‹"></a>Background Fetch ç®€ä»‹</h3><p>Background Fetch ç±»ä¼¼ä¸€ç§æ™ºèƒ½çš„è½®è¯¢æœºåˆ¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯è¿›è¡Œé€‚åº”ï¼Œåœ¨ç”¨æˆ·çœŸæ­£å¯åŠ¨åº”ç”¨ä¹‹å‰ï¼Œè§¦å‘åå°æ›´æ–°ï¼Œæ¥è·å–æ•°æ®å¹¶ä¸”æ›´æ–°é¡µé¢ã€‚</p><p>é’ˆå¯¹è¿™æ ·çš„ç­–ç•¥ï¼Œå¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘è™‘ï¼Œè¿™ç§é¢‘ç¹çš„åå°å¯åŠ¨ä¼šä¸ä¼šå¢åŠ è€—ç”µé‡ï¼Ÿ å½“ç„¶ä¸ä¼šï¼Œç³»ç»Ÿä¼šæ ¹æ®è®¾å¤‡çš„ç”µé‡å’Œæ•°æ®ä½¿ç”¨æƒ…å†µæ¥è°ƒç”¨é¢‘ç‡æ§åˆ¶ï¼Œé¿å…åœ¨éæ´»è·ƒæ—¶é—´é¢‘ç¹çš„è·å–æ•°æ®ã€‚è€Œä¸”ï¼Œè¿›ç¨‹å¯åŠ¨ååå­˜æ´»çš„æ—¶é—´å¾ˆçŸ­ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¼šç«‹å³ suspend</p><blockquote><p>å®è·µ</p></blockquote><ul><li>Info.plist ä¸­ UIBackgroundModes èŠ‚ç‚¹é…ç½® fetch æ•°å€¼</li><li>didFinishLaunching æ—¶é…ç½®[[UIApplication sharedApplication] setMinimumBackgroundFetchInterval:UIApplicationBackgroundFetchIntervalMinimum];<br>è¿™ä¸€æ­¥é…ç½®çš„minimum intervalï¼Œå•ä½æ˜¯ç§’ï¼Œåªæ˜¯ç»™ç³»ç»Ÿçš„å»ºè®®ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šæŒ‰ç…§ç»™å®šçš„æ—¶é—´é—´éš”æŒ‰è§„å¾‹çš„å”¤é†’è¿›ç¨‹ã€‚</li><li>å®ç°ä¸‹é¢çš„å›è°ƒï¼Œå¹¶è°ƒç”¨ completionHandler- (void)application:(UIApplication *)application performFetchWithCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler</li></ul><p>ç”±äº Background Fetch æœºåˆ¶æ˜¯ä¸ºäº†è®©Appåœ¨åå°æ‹‰å–å‡†å¤‡æ•°æ®ï¼Œä½†æ”¯ä»˜å®åªæ˜¯ä¸ºäº†å®ç°â€ç§’èµ·â€œã€‚è°ƒç”¨ completionHandler åç³»ç»Ÿå°†æŠŠ App è¿›ç¨‹æŒ‚èµ·ã€‚ä¸”ç³»ç»Ÿå¿…é¡»åœ¨30ç§’å†…è°ƒç”¨ completionHandlerï¼Œå¦åˆ™è¿›ç¨‹å°†è¢«æ€æ­»ã€‚æ­¤å¤–æ ¹æ®æ–‡æ¡£ï¼Œç³»ç»Ÿä¼šæ ¹æ®åå°è°ƒç”¨ completionHandler çš„æ—¶é—´æ¥å†³å®šåå°å”¤èµ·Appçš„é¢‘ç‡ã€‚å› æ­¤ï¼Œè®¤ä¸ºå¯ä»¥â€œä¼ªé€ â€œ1ç§’çš„å»¶è¿Ÿæ—¶é—´ï¼Œå³1ç§’åè°ƒç”¨ completionHandlerã€‚ç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application performFetchWithCompletionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIBackgroundFetchResult</span>))completionHandler&#123;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        completionHandler(<span class="built_in">UIBackgroundFetchResultNewData</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿›ç¨‹å¿«é€ŸæŒ‚èµ·å¯¼è‡´ Sync æˆåŠŸç‡ä¸‹é™<ul><li>ç°åº¦æœŸé—´ï¼Œå¼€å‘åŒå­¦å‘ç°åŒæ­¥æœåŠ¡ Sync æˆåŠŸç‡ä¸‹é™å¾ˆå¤šï¼Œæ‰¾æ¥æ‰¾å»å‘ç°åŸå› ï¼šç”±äºè¿›ç¨‹å”¤é†’åï¼Œç½‘ç»œé•¿è¿æ¥çº¿ç¨‹è¢«æ¿€æ´»å¹¶é©¬ä¸Šå»ºç«‹é•¿è¿æ¥ï¼Œè€Œ1ç§’åè°ƒç”¨completionHandlerï¼Œè¿›ç¨‹åˆè¢«æŒ‚èµ·ã€‚æœåŠ¡å™¨ç«¯çš„syncæ¶ˆæ¯åˆ™å‘é€è¶…æ—¶ã€‚</li></ul></li><li>è¿›ç¨‹é¢‘ç¹æŒ‚èµ·ã€å”¤é†’å¯¼è‡´ç½‘ç»œå»ºè¿æ¬¡æ•°å¢åŠ <ul><li>ç³»ç»Ÿé¢„æµ‹ç”¨æˆ·ä½¿ç”¨ App çš„æ—¶é—´ï¼Œå¹¶åœ¨ç”¨æˆ·å®ç° App å‰å”¤é†’ Appï¼Œç»™äºˆ App åå°å‡†å¤‡æ•°æ®çš„æœºä¼šã€‚å†åŠ ä¸Šé¢„æµ‹çš„å‡†ç¡®æ€§é—®é¢˜ï¼Œè¿™æ ·è¿›ç¨‹è¢«å”¤é†’çš„æ¬¡æ•°è¿œå¤§äºç”¨æˆ·ä½¿ç”¨çš„æ¬¡æ•°ã€‚è¿›ç¨‹å”¤é†’åï¼Œç½‘ç»œé•¿è¿æ¥ä¼šç«‹å³å»ºç«‹ã€‚å› æ­¤å¯¼è‡´ç½‘ç»œå»ºè¿æ¬¡æ•°å¤§å¢ï¼Œç”šè‡³ç¿»å€ã€‚</li></ul></li><li>ç”±äºè¿›ç¨‹æŒ‚èµ·ï¼Œå¯¼è‡´å®šæ—¶å™¨ã€å»¶è¿Ÿè°ƒç”¨ç­‰æ—¶é—´â€œä¸é¢„æƒ³çš„æ—¶é—´ä¸åŒâ€<ul><li>ä¾‹å¦‚ï¼Œä¸€ä¸ªé—´éš”é—´éš”æ—¶é—´ä¸º 60 ç§’çš„å®šæ—¶å™¨ï¼Œç”±äºè¿›ç¨‹æŒ‚èµ·æ—¶é—´è¶…è¿‡ 60 ç§’ï¼Œåˆ™ä¸‹æ¬¡è¿›ç¨‹å”¤é†’æ—¶ä¼šç«‹åˆ»è§¦å‘åˆ°æ—¶ã€‚ï¼ˆå»¶è¿Ÿè°ƒç”¨ dispatch_after ç­‰ç±»ä¼¼ï¼‰ã€‚å¯¹äºè¿›ç¨‹è‡ªèº«æ¥è¯´ï¼Œå¯èƒ½å®šæ—¶å™¨æœ‰ç‚¹ä¸æ­£å¸¸ï¼Œéœ€è¦æ’æŸ¥æ‰€æœ‰çš„å®šæ—¶å™¨é€»è¾‘ï¼Œæ˜¯å¦ä¼šå› ä¸ºæŒ‚èµ·å¯¼è‡´â€œä¸šåŠ¡å±‚é¢çš„å¼‚å¸¸â€ã€‚</li></ul></li><li>è·å–æ—¶é—´æˆ³<ul><li>ç”±äºè¿›ç¨‹æŒ‚èµ·ï¼Œå¯¼è‡´å‰åè·å–çš„æ—¶é—´æˆ³é—´éš”å¾ˆå¤§</li></ul></li></ul><p>ä¸ºè§£å†³ä»¥ä¸Šé‡åˆ°çš„ã€ä»¥åŠé¢„æµ‹åˆ°çš„é—®é¢˜ï¼Œç»è¿‡è®¨è®ºï¼Œå†³å®šåœ¨ Background Fetch åå°å”¤é†’çš„æ—¶å€™ï¼Œä¸å»ºç«‹é•¿è¿æ¥ã€‚</p><blockquote><p>è§£å†³</p></blockquote><ul><li>å»¶å 10 ç§’è°ƒç”¨ completionHandlerã€‚<ul><li>åå°å”¤é†’å­˜åœ¨ä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä»æ— åˆ°æœ‰ï¼Œè¿›ç¨‹ä»æŒ‚èµ·åˆ°æ¢å¤ã€‚å‰è€…éœ€è¦æœ‰å……è¶³çš„æ—¶é—´å®Œæˆ App çš„åå°å†·å¯åŠ¨è¿‡ç¨‹ï¼Œå› æ­¤å®šä¹‰äº† 10 ç§’çš„æ—¶é—´ã€‚</li></ul></li><li>åå° Background Fetch çš„æ—¶é—´å†…ä¸å»ºç«‹é•¿è¿æ¥ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#å¯åŠ¨è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å¯åŠ¨è¿‡ç¨‹&quot;&gt;&lt;/a&gt;å¯åŠ¨è¿‡ç¨‹&lt;/h3&gt;&lt;p&gt;iOSåº”ç”¨çš„å¯åŠ¨å¯åˆ†ä¸ºpre-mainé˜¶æ®µå’Œmain()é˜¶æ®µï¼Œpre-mainé˜¶æ®µä¸ºmainå‡½æ•°æ‰§è¡Œä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œmainé˜¶æ®µä¸ºmainå‡½æ•°åˆ°é¦–é¡µå±•ç¤ºé˜¶æ®µã€‚å…¶ä¸­ç³»ç»Ÿåšçš„äº‹æƒ…ä¸ºï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;premain&lt;ul&gt;
&lt;li&gt;åŠ è½½æ‰€æœ‰ä¾èµ–çš„Mach-Oæ–‡ä»¶ï¼ˆé€’å½’è°ƒç”¨Mach-OåŠ è½½çš„æ–¹æ³•ï¼‰&lt;/li&gt;
&lt;li&gt;åŠ è½½åŠ¨æ€é“¾æ¥åº“åŠ è½½å™¨dyldï¼ˆdynamic loaderï¼‰&lt;/li&gt;
&lt;li&gt;å®šä½å†…éƒ¨ã€å¤–éƒ¨æŒ‡é’ˆå¼•ç”¨ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å‡½æ•°ç­‰&lt;/li&gt;
&lt;li&gt;åŠ è½½ç±»æ‰©å±•ï¼ˆCategoryï¼‰ä¸­çš„æ–¹æ³•&lt;/li&gt;
&lt;li&gt;C++é™æ€å¯¹è±¡åŠ è½½ã€è°ƒç”¨ObjCçš„ +load å‡½æ•°&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œå£°æ˜ä¸º&lt;strong&gt;attribute&lt;/strong&gt;((constructor))çš„Cå‡½æ•°&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;main&lt;ul&gt;
&lt;li&gt;è°ƒç”¨main()&lt;/li&gt;
&lt;li&gt;è°ƒç”¨UIApplicationMain()&lt;/li&gt;
&lt;li&gt;è°ƒç”¨applicationWillFinishLaunching&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="iOSå¼€å‘è¿›é˜¶" scheme="https://developerdoc.com/categories/iOS%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>InjectionIII ä½¿ç”¨åŸç†ä»‹ç»</title>
    <link href="https://developerdoc.com/essay/injectIII/"/>
    <id>https://developerdoc.com/essay/injectIII/</id>
    <published>2021-01-04T03:42:18.000Z</published>
    <updated>2021-01-16T08:34:21.473Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>iOS åŸç”Ÿä»£ç çš„ç¼–è¯‘è°ƒè¯•ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€éåˆä¸€éåœ°ç¼–è¯‘é‡å¯ APPæ¥è¿›è¡Œçš„ã€‚æ‰€ä»¥é¡¹ç›®ä»£ç é‡è¶Šå¤§ï¼Œç¼–è¯‘æ—¶é—´å°±è¶Šé•¿ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥å°†éƒ¨åˆ†ä»£ç å…ˆç¼–è¯‘æˆäºŒè¿›åˆ¶é›†æˆåˆ°å·¥ç¨‹é‡Œï¼Œæ¥é¿å…æ¯æ¬¡éƒ½å…¨é‡ç¼–è¯‘æ¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œä½†å³ä½¿è¿™æ ·ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½è¿˜æ˜¯éœ€è¦é‡å¯Appï¼Œéœ€è¦å†èµ°ä¸€éè°ƒè¯•æµç¨‹ã€‚</p></blockquote><p>å¹¸è¿çš„æ˜¯ï¼ŒJohn Holdsworth å¼€å‘äº†ä¸€ä¸ªå«åš InjectionIII çš„å·¥å…·å¯ä»¥åŠ¨æ€åœ°å°† Swift æˆ– Objective-C çš„ä»£ç åœ¨å·²è¿è¡Œçš„ç¨‹åºä¸­æ‰§è¡Œï¼Œä»¥åŠ å¿«è°ƒè¯•é€Ÿåº¦ï¼ŒåŒæ—¶ä¿è¯ç¨‹åºä¸ç”¨é‡å¯ã€‚</p><a id="more"></a><h3 id="InjectionIIIä¸‹è½½ä½¿ç”¨"><a href="#InjectionIIIä¸‹è½½ä½¿ç”¨" class="headerlink" title="InjectionIIIä¸‹è½½ä½¿ç”¨"></a>InjectionIIIä¸‹è½½ä½¿ç”¨</h3><h4 id="ä¸‹è½½InjectionIII"><a href="#ä¸‹è½½InjectionIII" class="headerlink" title="ä¸‹è½½InjectionIII"></a>ä¸‹è½½InjectionIII</h4><p>å¦‚æœä»…ç”¨äºä½¿ç”¨çš„è¯åœ¨mac appStoreä¸‹è½½å°±å¯ä»¥äº†ï¼š</p><p><img src="/res/InjectionIII/1.png" width="50%"></p><h4 id="åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç "><a href="#åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç " class="headerlink" title="åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç "></a>åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç </h4><p>åœ¨ - (BOOL)application:(UIApplication <em>)application willFinishLaunchingWithOptions:(NSDictionary </em>)launchOptions æ–¹æ³•é‡Œæ·»åŠ å¦‚ä¸‹ä»£ç </p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    [[<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@"/Applications/InjectionIII.app/Contents/Resources/iOSInjection.bundle"</span>] load;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//æˆåŠŸæ—¶æ§åˆ¶å°ä¼šæ‰“å°ï¼š</span><br><span class="line">ğŸ’‰ Injection connected ğŸ‘</span><br><span class="line"></span><br><span class="line">//æ²¡æœ‰è¿è¡ŒInjectionIII æ§åˆ¶å°ä¼šæ‰“å°</span><br><span class="line">ğŸ’‰ Injection loaded but could not connect. Is InjectionIII.app running?</span><br></pre></td></tr></table></figure><h4 id="è¿è¡ŒInjectionIII-å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•"><a href="#è¿è¡ŒInjectionIII-å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•" class="headerlink" title="è¿è¡ŒInjectionIII å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•"></a>è¿è¡ŒInjectionIII å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•</h4><p>ä½¿ç”¨çš„æ—¶å€™ä¼šè®©ä½ é€‰æ‹©é¡¹ç›®ç›®å½•ï¼ŒInjectionIII å°±æ˜¯ç›‘æ§çš„è¿™ä¸ªç›®å½•ï¼Œé‡Œé¢æ–‡ä»¶å˜åŠ¨ä¼šæœ‰é€šçŸ¥ã€‚</p><p><img src="/res/InjectionIII/2.png" width="50%"></p><h4 id="ä½¿ç”¨InjectionIII-å¹¶æµ‹è¯•å‡ ç§åœºæ™¯"><a href="#ä½¿ç”¨InjectionIII-å¹¶æµ‹è¯•å‡ ç§åœºæ™¯" class="headerlink" title="ä½¿ç”¨InjectionIII å¹¶æµ‹è¯•å‡ ç§åœºæ™¯:"></a>ä½¿ç”¨InjectionIII å¹¶æµ‹è¯•å‡ ç§åœºæ™¯:</h4><p>ä½ å¯ä»¥åœ¨åœ¨å¯¹åº”çš„VCæ§åˆ¶å™¨ä¸­å®ç° - (void)injected ç¼–å†™ä»£ç ï¼Œå†™å®Œåï¼Œcommand+s ä¿å­˜åˆ‡æ‰§è¡Œä»£ç ï¼ŒInjjectionå°±å¼€å§‹ç¼–è¯‘ä¿®æ”¹è¿‡çš„æ–‡ä»¶ä¸ºåŠ¨æ€åº“ï¼Œç„¶åæˆ‘ä»¬åœ¨Injectedæ–¹æ³•å†…åšUI reloadå·¥ä½œï¼Œå³å¯é‡ç»˜UIã€‚</p><p>ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹ä½ æƒ³æµ‹è¯•çš„VCä»£ç ï¼Œç„¶åé€€å‡ºé‡è¿›å³å¯é‡è½½VCã€‚</p><p>æµ‹è¯•ä¸€ä¸‹å››ç§åœºæ™¯ï¼š </p><ul><li>ä¿®æ”¹æ–¹æ³•</li><li>æ–°å¢æ–¹æ³•</li><li>æ–°å¢å±æ€§</li><li>æ–°å¢ç±»</li></ul><p>å…¶ä¸­ ä¿®æ”¹æ–¹æ³•/æ–°å¢æ–¹æ³•/æ–°å¢ç±» éƒ½å¯ä»¥åŠ¨æ€ä¿®æ”¹</p><p><img src="/res/InjectionIII/3.gif" alt></p><p>è€Œå½“åŠ¨æ€æ·»åŠ å±æ€§æ—¶åˆ™ä¼šæŠ¥é”™</p><p><img src="/res/InjectionIII/4.png" width="50%"></p><p>æˆ‘ä»¬å¾ˆè‡ªç„¶çš„æƒ³åˆ°å› ä¸ºä¸èƒ½å‘å·²æœ‰ç±»åŠ¨æ€æ·»åŠ å±æ€§ï¼Œä½†æ˜¯InjectionIIIåˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®æ¥çœ‹çœ‹InjectionIIIçš„åŸç†</p><blockquote><p>æ²¡æœ‰çœ‹åˆ°æ•ˆæœçš„é—®é¢˜?</p></blockquote><ul><li>ç¡®è®¤ Injection ç›‘å¬çš„ç›®å½•å’Œ Xcode é¡¹ç›®ç›®å½•æ˜¯å¦ä¸€è‡´ã€‚</li><li>å†çœ‹ä¸‹æœ‰æ²¡æœ‰ä¿å­˜æˆåŠŸï¼Œä¹Ÿå°±æ˜¯é’ˆç­’çš„é¢œè‰²ç”±ç»¿è‰²å˜æˆçº¢è‰²ã€‚</li><li>ç¡®è®¤ä¸Šé¢é‚£å¥è¯æœ‰æ²¡æœ‰æ‰“å°ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰æ²¡æœ‰çœŸçš„è¿è¡Œè¿™ä¸ªå·¥å…·ã€‚</li><li>å¦‚æœä¿®æ”¹çš„æ˜¯ cell / item ä¸Šé¢çš„å†…å®¹ï¼Œéœ€è¦ä¸Šä¸‹æ»šåŠ¨æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚</li><li>å¦‚æœä¿®æ”¹çš„æ˜¯ä¸€ä¸ªæ™®é€šé¡µé¢çš„å†…å®¹ï¼Œæœ€å¥½æ˜¯é€€å‡ºè¿™ä¸ªé¡µé¢ï¼Œå†è¿›å…¥è¿™ä¸ªé¡µé¢ã€‚</li><li>ç¡®è®¤ Xcode çš„ç‰ˆæœ¬å’Œå¯åŠ¨æ—¶æ·»åŠ çš„ä»£ç æ˜¯å¦åŒ¹é…ï¼ŒXcode10 éœ€è¦ iOSInjection10.bundle æ‰èƒ½ç”Ÿæ•ˆ</li></ul><h3 id="InjectionIIIåŸç†"><a href="#InjectionIIIåŸç†" class="headerlink" title="InjectionIIIåŸç†"></a>InjectionIIIåŸç†</h3><h4 id="å¤§è‡´æµç¨‹æ¢³ç†"><a href="#å¤§è‡´æµç¨‹æ¢³ç†" class="headerlink" title="å¤§è‡´æµç¨‹æ¢³ç†"></a>å¤§è‡´æµç¨‹æ¢³ç†</h4><p><img src="/res/InjectionIII/8.png" alt></p><ul><li>InjectionIII åˆ†ä¸ºserver å’Œ clientéƒ¨åˆ†ï¼Œ</li><li>clientéƒ¨åˆ†åœ¨ä½ çš„é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ä¼šä½œä¸º bundle load è¿›å»ï¼Œserveréƒ¨åˆ†åœ¨Mac Appé‚£è¾¹ï¼Œserver å’Œ client éƒ½ä¼šåœ¨åå°å‘é€å’Œç›‘å¬ Socket æ¶ˆæ¯ï¼Œå®ç°é€»è¾‘åˆ†åˆ«åœ¨ InjectionServer.mm å’Œ InjectionClient.mm é‡Œçš„ runInBackground æ–¹æ³•é‡Œé¢ã€‚</li><li>InjectionIII ä¼šç›‘å¬æºä»£ç æ–‡ä»¶çš„å˜åŒ–ï¼Œå¦‚æœæ–‡ä»¶è¢«æ”¹åŠ¨äº†ï¼Œserver å°±ä¼šé€šè¿‡ Socket é€šçŸ¥ client è¿›è¡Œ rebuildClass é‡æ–°å¯¹è¯¥æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œæ‰“åŒ…æˆåŠ¨æ€åº“ï¼Œä¹Ÿå°±æ˜¯ .dylib æ–‡ä»¶ã€‚</li><li>ç„¶åé€šè¿‡ dlopen æŠŠåŠ¨æ€åº“æ–‡ä»¶è½½å…¥è¿è¡Œçš„ App é‡Œï¼Œæ¥ä¸‹æ¥ dlsym ä¼šå¾—åˆ°åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ï¼Œç„¶åå°±å¯ä»¥å¤„ç†ç±»çš„æ›¿æ¢å·¥ä½œã€‚</li><li>å½“ç±»çš„æ–¹æ³•è¢«æ›¿æ¢åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹é‡æ–°ç»˜åˆ¶ç•Œé¢äº†ã€‚æ•´ä¸ªè¿‡ç¨‹æ— éœ€é‡æ–°ç¼–è¯‘å’Œé‡è½½ Appï¼Œä½¿ç”¨åŠ¨æ€åº“æ–¹å¼æé€Ÿè°ƒè¯•çš„ç›®çš„å°±è¾¾æˆäº†ã€‚</li></ul><p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿå™¨ä¸‹iOSå¯åŠ è½½Macä»»æ„æ–‡ä»¶ï¼Œè€ŒçœŸæœºè®¾å¤‡å¦‚æœåŠ è½½åŠ¨æ€åº“ï¼Œåªèƒ½åŠ è½½App.contentç›®å½•ä¸‹çš„ï¼Œæ¢å¥è¯è¯´ï¼Œè¿™ä¸ªå·¥å…·åªæ”¯æŒæ¨¡æ‹Ÿå™¨ã€‚</p><h4 id="ç¼–è¯‘InjectionIIIå·¥ç¨‹"><a href="#ç¼–è¯‘InjectionIIIå·¥ç¨‹" class="headerlink" title="ç¼–è¯‘InjectionIIIå·¥ç¨‹"></a>ç¼–è¯‘InjectionIIIå·¥ç¨‹</h4><p>è¦äº†è§£ä¸€ä¸ªå·¥å…·ï¼Œæœ€å¥½çš„æ–¹å¼å½“ç„¶ç›´æ¥çœ‹æºç äº†ã€‚InjectionIII çš„æºä»£ç é“¾æ¥å¦‚ä¸‹ï¼š<a href="https://github.com/johnno1962/InjectionIII" target="_blank" rel="noopener">https://github.com/johnno1962/InjectionIII</a>ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥å¯¹ç€æºç åˆ†æã€‚</p><p><img src="/res/InjectionIII/5.png" width="50%"></p><p>ä¸‹è½½/clone InjectionIII ä¸»å·¥ç¨‹ä»£ç ï¼Œå­å·¥ç¨‹ remote SwiftTrace XprobePlugin ä¹Ÿä¸€å¹¶ç‚¹è¿›é“¾æ¥ä¸‹è½½åˆ°å¯¹åº”ç›®å½•ã€‚</p><p>ç„¶åè§£å†³ä¸‹è¯ä¹¦é—®é¢˜ ï¼Œç›´æ¥å‹¾é€‰ Automatically manage signingï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸‹å›¢é˜Ÿï¼Œæ³¨æ„ InjectionIII å’Œ InjectionBundle ä¸¤ä¸ª target éƒ½è¦é€‰æ‹©å¥½ã€‚å°±å¯ä»¥æ„‰å¿«çš„ç¼–è¯‘äº†~</p><p>æœ€åè¯´ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨æºç åˆ†æï¼Œå½“ç„¶è¦å°†æºç ç¼–è¯‘èµ·æ¥ï¼Œæ‰“æ–­ç‚¹çœ‹æµç¨‹ã€‚è¿™æ ·çš„è¯å°±åœ¨ willFinishLaunchingWithOptions é‡Œé¢åŠ è½½çš„è·¯å¾„å°±è¦ç›¸åº”ä¿®æ”¹äº†ï¼Œæˆ‘è¿™è¾¹æ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    [[<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@"/Users/suntongsheng/Library/Developer/Xcode/DerivedData/InjectionIII-aornltecfreqqwezgayglgjnnckg/Build/Products/Debug/InjectionIII.app/Contents/Resources/iOSInjection.bundle"</span>] load];</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><h5 id="ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥"><a href="#ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥" class="headerlink" title="ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥"></a>ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥</h5><p><code>Serverç«¯ å³æ˜¯InjectionIIIå·¥ç¨‹ä¸­çš„Target-InjectionIII</code> åˆå§‹åŒ–è°ƒç”¨ SimpleSocket çš„ startServer æ–¹æ³•å¹¶ä¼ å…¥ç«¯å£å· åœ¨åå°è¿è¡Œå¼€å¯æœåŠ¡ç«¯socket æœåŠ¡ç”¨äºå’Œå®¢æˆ·ç«¯çš„é€šè®¯ï¼Œå¹¶è¿è¡Œ InjectionServer ç±»çš„ runInBackground æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå¼¹å‡ºé€‰æ‹©é¡¹ç›®ç›®å½•å¯¹è¯æ¡†ï¼Œå¦‚æœä¹‹å‰é€‰æ‹©è¿‡çš„è¯å°±ä¸ä¼šå¼¹å‡ºã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">+ (void)startServer:(<span class="type">NSString</span> *)address &#123;</span><br><span class="line">    <span class="type">NSLog</span>(@<span class="string">" %s %p "</span>,__func__,<span class="keyword">self</span>);</span><br><span class="line">    [<span class="keyword">self</span> performSelectorInBackground:@selector(runServer:) withObject:address];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)runServer:(<span class="type">NSString</span> *)address &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">serverAddr</span>;</span></span><br><span class="line"><span class="class">    [<span class="title">self</span> <span class="title">parseV4Address</span>:<span class="title">address</span> <span class="title">into</span>:&amp;<span class="title">serverAddr</span>];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">serverSocket</span> = [<span class="title">self</span> <span class="title">newSocket</span>:<span class="title">serverAddr</span>.<span class="title">ss_family</span>];</span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">serverSocket</span> &lt; 0)</span></span><br><span class="line"><span class="class">        <span class="title">return</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">bind</span>(<span class="title">serverSocket</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">serverAddr</span>, <span class="title">serverAddr</span>.<span class="title">ss_len</span>) &lt; 0)</span></span><br><span class="line"><span class="class">        [<span class="title">self</span> <span class="title">error</span>:@"<span class="title">Could</span> <span class="title">not</span> <span class="title">bind</span> <span class="title">service</span> <span class="title">socket</span>: %<span class="title">s</span>"];</span></span><br><span class="line"><span class="class">    <span class="title">else</span> <span class="title">if</span> (<span class="title">listen</span>(<span class="title">serverSocket</span>, 5) &lt; 0)</span></span><br><span class="line"><span class="class">        [<span class="title">self</span> <span class="title">error</span>:@"<span class="title">Service</span> <span class="title">socket</span> <span class="title">would</span> <span class="title">not</span> <span class="title">listen</span>: %<span class="title">s</span>"];</span></span><br><span class="line"><span class="class">    <span class="title">else</span></span></span><br><span class="line"><span class="class">        <span class="title">while</span> (<span class="title">TRUE</span>) </span>&#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class">            <span class="title">socklen_t</span> <span class="title">addrLen</span> = <span class="title">sizeof</span> <span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">            <span class="title">int</span> <span class="title">clientSocket</span> = <span class="title">accept</span>(<span class="title">serverSocket</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">clientAddr</span>, &amp;<span class="title">addrLen</span>);</span></span><br><span class="line"><span class="class">            <span class="title">if</span> (<span class="title">clientSocket</span> &gt; 0) </span>&#123;</span><br><span class="line">                @autoreleasepool &#123;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">v4Addr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)&amp;<span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class">                    <span class="title">NSLog</span>(@"<span class="title">Connection</span> <span class="title">from</span> %<span class="title">s</span>:%<span class="title">d</span>\<span class="title">n</span>",</span></span><br><span class="line"><span class="class">                          <span class="title">inet_ntoa</span>(<span class="title">v4Addr</span>-&gt;<span class="title">sin_addr</span>), <span class="title">ntohs</span>(<span class="title">v4Addr</span>-&gt;<span class="title">sin_port</span>));</span></span><br><span class="line"><span class="class">                    [[[<span class="title">self</span> <span class="title">alloc</span>] <span class="title">initSocket</span>:<span class="title">clientSocket</span>] <span class="title">run</span>];</span></span><br><span class="line"><span class="class">                &#125;</span></span><br><span class="line"><span class="class">            &#125;</span></span><br><span class="line"><span class="class">            <span class="title">else</span></span></span><br><span class="line"><span class="class">                [<span class="title">NSThread</span> <span class="title">sleepForTimeInterval</span>:.5];</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><p><code>Clientç«¯ å³æ˜¯InjectionIIIå·¥ç¨‹ä¸­çš„Target-InjectionBundle</code> ä¼šåœ¨æˆ‘ä»¬çš„demoå·¥ç¨‹ä¸­åŠ è½½ï¼Œé¡¹ç›®å¯åŠ¨ä»¥åå¯ä»¥åœ¨æ§åˆ¶å°æ‰§è¡Œ image list -o -f æŸ¥çœ‹åŠ è½½çš„åŠ¨æ€åº“ï¼Œå¯ä»¥çœ‹åˆ° iOSInjection.bundle ç¡®å®å·²ç»ä»¥åŠ¨æ€åº“çš„å½¢å¼åŠ è½½è¿›æ¥äº†ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image list -o -f</span><br><span class="line"></span><br><span class="line">[377] 0x0000000102b13000 /Users/suntongsheng/Library/Developer/Xcode/DerivedData/InjectionIII-aornltecfreqqwezgayglgjnnckg/Build/Products/Debug/InjectionIII.app/Contents/Resources/iOSInjection.bundle/iOSInjection</span><br></pre></td></tr></table></figure><p>å…¶åˆå§‹åŒ–åœ¨InjectionClient ç±»çš„ +load æ–¹æ³•ã€‚åœ¨ InjectionClient ç±»çš„ +load æ–¹æ³•é‡Œä¼šè°ƒç”¨å…¶ connectTo æ–¹æ³•ä¼ å…¥å¯¹åº”çš„ç«¯å£å·æ¥è¿æ¥æœåŠ¡ç«¯çš„ socket æœåŠ¡ç”¨äºé€šè®¯ï¼Œå¹¶è¿è¡Œå…¶runInBackground æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+ (void)load &#123;</span><br><span class="line">    <span class="type">NSLog</span>(@<span class="string">" %s %p "</span>,__func__,<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">// connect to InjectionIII.app using socket</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">InjectionClient</span> *client = [<span class="keyword">self</span> connectTo:<span class="type">INJECTION_ADDRESS</span>])</span><br><span class="line">        [client run];</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        printf(<span class="string">"ğŸ’‰ Injection loaded but could not connect. Is InjectionIII.app running?\n"</span>);</span><br><span class="line">#ifndef __IPHONE_OS_VERSION_MIN_REQUIRED</span><br><span class="line">        printf(<span class="string">"âš ï¸ For a macOS app you need to turn off the sandbox to connect. âš ï¸\n"</span>);</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InjectionIII è¿è¡Œä»¥åä¼šåœ¨åå°ç›‘å¬ socket æ¶ˆæ¯ï¼Œæ¯éš”0.5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥è¿‡æ¥ï¼Œç­‰æˆ‘ä»¬app å¯åŠ¨ä»¥ååŠ è½½äº† iOSInjection.bundleï¼Œå°±ä¼šå¯åŠ¨ client è·Ÿ server å»ºç«‹è¿æ¥ï¼Œç„¶åå°±å¯ä»¥å‘é€æ¶ˆæ¯äº†ã€‚</p><h5 id="äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹"><a href="#äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹"></a>äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹</h5><p>å½“æˆ‘ä»¬åœ¨è°ƒè¯•å·¥ç¨‹ä¸­ä¿®æ”¹äº†ä»£ç å¹¶ä¿å­˜åï¼ŒFileWatcher ä¼šç«‹å³æ”¶åˆ°æ–‡ä»¶æ”¹å˜çš„å›è°ƒï¼ŒFileWatcher ä½¿ç”¨ Mac OS ä¸Šçš„ FSEvents æ¡†æ¶å®ç°ï¼Œ<code>FileWatcher</code> ä¸­é€šè¿‡ <code>filesChanged</code> å‘Šè¯‰å›è°ƒæ–¹æ³•å³<code>InjectionServer</code>ä¸­çš„<code>fileChangeHandler</code>æ–¹æ³•</p><p><img src="/res/InjectionIII/6.png" alt></p><p>åœ¨<code>InjectionServer</code>æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºè‡ªåŠ¨æ³¨å…¥ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œ injectPending æ–¹æ³•ï¼Œé€šè¿‡ socket å¯¹å®¢æˆ·ç«¯ä¸‹å‘InjectionInject ä»£ç æ³¨å…¥å‘½ä»¤å¹¶ä¼ å…¥éœ€è¦ä»£ç æ³¨å…¥çš„æ–‡ä»¶åç‰©ç†è·¯å¾„ã€‚å¦‚æœä¸æ˜¯è‡ªåŠ¨æ³¨å…¥é‚£ä¹ˆå°±åœ¨æ§åˆ¶å°è¾“å‡ºâ€œxxæ–‡ä»¶å·²ä¿å­˜ï¼Œè¾“å…¥ctrl-=è¿›è¡Œæ³¨å…¥â€å‘Šè¯‰æˆ‘ä»¬æ‰‹åŠ¨æ³¨å…¥çš„è§¦å‘æ–¹å¼ã€‚</p><h5 id="ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å"><a href="#ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å" class="headerlink" title="ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å"></a>ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å</h5><p>æ–‡ä»¶ä¿®æ”¹åè‹¥æ˜¯è‡ªåŠ¨æ³¨å…¥<code>injectPending</code>æ–¹æ³•ä¼šè°ƒç”¨ <code>recompileAndInject</code>æ–¹æ³•å®é™…ä¸Šä¼šè°ƒç”¨ SwiftEval å•ä¾‹çš„ rebuildClass æ–¹æ³•æ¥è¿›è¡Œä¿®æ”¹æ–‡ä»¶çš„é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾åï¼š</p><p>é¦–å…ˆæ ¹æ®ä¿®æ”¹çš„ç±»æ–‡ä»¶ååœ¨ Injection App çš„æ²™ç›’è·¯å¾„ç”Ÿæˆå¯¹åº”çš„ç¼–è¯‘è„šæœ¬ï¼Œè„šæœ¬å‘½åä¸ºeval+æ•°å­—ï¼Œæ•°å­—ä»¥100ä¸ºåŸºæ•°ï¼Œæ¯æ¬¡é€’å¢1ã€‚è„šæœ¬ç”Ÿæˆè°ƒç”¨æ–¹æ³•å¦‚ä¸‹å›¾ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">injectionNumber += <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> tmpfile = <span class="type">URL</span>(fileURLWithPath: tmpDir)</span><br><span class="line">    .appendingPathComponent(<span class="string">"eval\(injectionNumber)"</span>).path</span><br><span class="line"><span class="keyword">let</span> logfile = <span class="string">"\(tmpfile).log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">var</span> (compileCommand, sourceFile) = <span class="keyword">try</span> compileByClass[classNameOrFile] ??</span><br><span class="line">    findCompileCommand(logsDir: logsDir, classNameOrFile: classNameOrFile, tmpfile: tmpfile) ??</span><br><span class="line">    <span class="type">SwiftEval</span>.longTermCache[classNameOrFile].flatMap(&#123; ($<span class="number">0</span> <span class="keyword">as</span>! <span class="type">String</span>, classNameOrFile) &#125;) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> evalError(<span class="string">"""</span></span><br><span class="line"><span class="string">        Could not locate compile command for \(classNameOrFile).</span></span><br><span class="line"><span class="string">        This could be due to one of the following:</span></span><br><span class="line"><span class="string">        1. Injection does not work with Whole Module Optimization.</span></span><br><span class="line"><span class="string">        2. There are restrictions on characters allowed in paths.</span></span><br><span class="line"><span class="string">        3. File paths in the simulator paths are case sensitive.</span></span><br><span class="line"><span class="string">        Try a build clean then rebuild to make logs available or</span></span><br><span class="line"><span class="string">        consult: "\(commandFile)".</span></span><br><span class="line"><span class="string">        """</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ findCompileCommand ä¸ºç”Ÿæˆ sh è„šæœ¬çš„å…·ä½“æ–¹æ³•ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å½“å‰ä¿®æ”¹ç±»è®¾ç½®å¯¹åº”çš„ç¼–è¯‘è„šæœ¬å‘½ä»¤ã€‚ç”±äºè„šæœ¬å¤ªé•¿ï¼Œè¿™é‡Œå°±ä¸è´´ä¸Šæ¥äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><p>ä½¿ç”¨æ”¹åŠ¨ç±»çš„ç¼–è¯‘è„šæœ¬å¯ä»¥ç”Ÿæˆå…¶.oæ–‡ä»¶ï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> toolchain = ((<span class="keyword">try</span>! <span class="type">NSRegularExpression</span>(pattern: <span class="string">"\\s*(\\S+?\\.xctoolchain)"</span>, options: []))</span><br><span class="line">    .firstMatch(<span class="keyword">in</span>: compileCommand, options: [], range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, compileCommand.utf16.<span class="built_in">count</span>))?</span><br><span class="line">    .range(at: <span class="number">1</span>)).flatMap &#123; compileCommand[$<span class="number">0</span>] &#125; ?? <span class="string">"\(xcodeDev)/Toolchains/XcodeDefault.xctoolchain"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> osSpecific: <span class="type">String</span></span><br><span class="line"><span class="keyword">if</span> compileCommand.<span class="built_in">contains</span>(<span class="string">"iPhoneSimulator.platform"</span>) &#123;</span><br><span class="line">    osSpecific = <span class="string">"-isysroot \(xcodeDev)/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk -mios-simulator-version-min=9.0 -L\(toolchain)/usr/lib/swift/iphonesimulator -undefined dynamic_lookup"</span><span class="comment">// -Xlinker -bundle_loader -Xlinker \"\(Bundle.main.executablePath!)\""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé’ˆå¯¹æ¨¡æ‹Ÿå™¨ç¯å¢ƒè¿›è¡Œè„šæœ¬é…ç½®ï¼Œé…ç½®å®Œæˆåä½¿ç”¨ clang å‘½ä»¤æŠŠå¯¹åº”çš„.oæ–‡ä»¶ç”Ÿæˆç›¸åŒåå­—çš„åŠ¨æ€åº“ï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼š</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> shell(command: <span class="string">"""</span></span><br><span class="line"><span class="string">    \(xcodeDev)/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -arch "\(arch)" -bundle \(osSpecific) -dead_strip -Xlinker -objc_abi_version -Xlinker 2 -fobjc-arc -fprofile-instr-generate \"\(tmpfile).o\" -L "\(frameworks)" -F "\(frameworks)" -rpath "\(frameworks)" -o \"\(tmpfile).dylib\" &gt;&gt;\"\(logfile)\" 2&gt;&amp;1</span></span><br><span class="line"><span class="string">    """</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> evalError(<span class="string">"Link failed, check \(commandFile)\n\(try! String(contentsOfFile: logfile))"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿‡ç¨‹ä¸­äº§ç”Ÿçš„äº§ç‰©å¦‚ä¸‹ï¼š</p><p><img src="/res/InjectionIII/7.png" width="50%"></p><p>è‹¹æœä¼šå¯¹åŠ è½½çš„åŠ¨æ€åº“è¿›è¡Œç­¾åæ ¡éªŒï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥éœ€è¦å¯¹è¿™ä¸ªåŠ¨æ€åº“ç­¾å,ç”±äºç­¾åéœ€è¦ä½¿ç”¨ Xcode ç¯å¢ƒï¼Œæ‰€ä»¥å®¢æˆ·ç«¯æ˜¯æ— æ³•è¿›è¡Œçš„ï¼Œåªèƒ½é€šè¿‡ socket å‘Šè¯‰æœåŠ¡ç«¯æ¥è¿›è¡Œæ“ä½œã€‚å½“æœåŠ¡ç«¯æ”¶åˆ° InjectionSign ç­¾åå‘½ä»¤åä¼šè°ƒç”¨ SignerService ç±»çš„ codesignDylib æ¥å¯¹ç›¸åº”çš„åŠ¨æ€åº“è¿›è¡Œç­¾åæ“ä½œ</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@implementation <span class="type">SignerService</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">BOOL</span>)codesignDylib:(<span class="type">NSString</span> *)dylib identity:(<span class="type">NSString</span> *)identity &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">NSString</span> *adhocSign = @<span class="string">"-"</span>;</span><br><span class="line">    <span class="type">NSString</span> *command = [<span class="type">NSString</span> stringWithFormat:@<span class="string">""</span></span><br><span class="line">                         <span class="string">"(export CODESIGN_ALLOCATE=/Applications/Xcode.app"</span></span><br><span class="line">                         <span class="string">"/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/codesign_allocate; "</span></span><br><span class="line">                         <span class="string">"if /usr/bin/file \"%@\" | grep ' bundle ' &gt;/dev/null;"</span></span><br><span class="line">                         <span class="string">"then /usr/bin/codesign --force -s \"%@\" \"%@\";"</span></span><br><span class="line">                         <span class="string">"else exit 1; fi)"</span>,</span><br><span class="line">                         dylib, identity ?: adhocSign, dylib];</span><br><span class="line">    <span class="keyword">return</span> system(command.<span class="type">UTF8String</span>) &gt;&gt; <span class="number">8</span> == <span class="type">EXIT_SUCCESS</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)runInBackground &#123;</span><br><span class="line">    char __unused skip, buffer[<span class="number">1000</span>];</span><br><span class="line">    buffer[read(clientSocket, buffer, <span class="built_in">sizeof</span> buffer-<span class="number">1</span>)] = '\<span class="number">000</span>';</span><br><span class="line">    <span class="type">NSString</span> *path = [[<span class="type">NSString</span> stringWithUTF8String:buffer] componentsSeparatedByString:@<span class="string">" "</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="class"><span class="keyword">class</span>] <span class="title">codesignDylib</span>:<span class="title">path</span> <span class="title">identity</span>:<span class="title">nil</span>]) </span>&#123;</span><br><span class="line">        snprintf(buffer, <span class="built_in">sizeof</span> buffer, <span class="string">"HTTP/1.0 200 OK\r\n\r\n"</span>);</span><br><span class="line">        write(clientSocket, buffer, strlen(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ä¿®æ”¹æ–‡ä»¶çš„é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾åæ“ä½œå°±å…¨éƒ¨å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢äº†ã€‚</p><h5 id="å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢"><a href="#å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢" class="headerlink" title="å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢"></a>å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢</h5><p>åœ¨ç”ŸæˆåŠ¨æ€åº“å å…ˆä½¿ç”¨dlopenæ–¹æ³•æŠŠå¯¹åº”çš„åŠ¨æ€åº“åŠ è½½åˆ°å½“å‰è¿è¡Œçš„è°ƒè¯•å·¥ç¨‹çš„è¿›ç¨‹ä¸­ å¹¶æ‹¿åˆ°è¿”å›çš„æŒ‡é’ˆdlï¼Œç„¶åä½¿ç”¨dlsymæ‹¿åˆ°åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ã€‚</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">loadAndInject</span><span class="params">(tmpfile: String, oldClass: AnyClass? = <span class="literal">nil</span>)</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">AnyClass</span>] &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> dl = dlopen(<span class="string">"\(tmpfile).dylib"</span>, <span class="type">RTLD_NOW</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> oldClass != <span class="literal">nil</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// grep out symbols for classes being injected from object file</span></span><br><span class="line">        <span class="comment">//æ­£å¸¸æµç¨‹ä¼šèµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> extractClasses(dl: dl, tmpfile: tmpfile)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Overridden by SwiftInjectionEval subclass for injection</span></span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">extractClasses</span><span class="params">(dl: UnsafeMutableRawPointer,</span></span></span><br><span class="line"><span class="function"><span class="params">                          tmpfile: String)</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">AnyClass</span>] &#123;</span><br><span class="line">    <span class="keyword">guard</span> shell(command: <span class="string">"""</span></span><br><span class="line"><span class="string">        \(xcodeDev)/Toolchains/XcodeDefault.xctoolchain/usr/bin/nm \(tmpfile).o | grep -E ' S _OBJC_CLASS_\\$_| _(_T0|\\$S|\\$s).*CN$' | awk '&#123;print $3&#125;' &gt;\(tmpfile).classes</span></span><br><span class="line"><span class="string">        """</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> evalError(<span class="string">"Could not list class symbols"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">var</span> classSymbolNames = (<span class="keyword">try</span>? <span class="type">String</span>(contentsOfFile: <span class="string">"\(tmpfile).classes"</span>))?.components(separatedBy: <span class="string">"\n"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> evalError(<span class="string">"Could not load class symbol list"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    classSymbolNames.removeLast()</span><br><span class="line">    <span class="keyword">let</span> result =  <span class="type">Set</span>(classSymbolNames.compactMap &#123;</span><br><span class="line">        dlsym(dl, <span class="type">String</span>($<span class="number">0</span>.<span class="built_in">dropFirst</span>())) &#125;)</span><br><span class="line">        .<span class="built_in">map</span> &#123; <span class="built_in">unsafeBitCast</span>($<span class="number">0</span>, to: <span class="type">AnyClass</span>.<span class="keyword">self</span>) &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œdlopen ä¼šæŠŠ tmpfile åŠ¨æ€åº“æ–‡ä»¶è½½å…¥è¿è¡Œçš„ App é‡Œï¼Œè¿”å›æŒ‡é’ˆ dlã€‚å›åˆ°æµ‹è¯•å·¥ç¨‹ä½¿ç”¨ <code>lldb image list -o -f</code> ç¡®å®çœ‹åˆ°eval101.dylib è¢«åŠ è½½è¿›æ¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[408] 0x0000000111bfe000 /var/folders/tw/nl7v5_cd577bbdzfgxjy63bw0000gn/T/com.johnholdsworth.InjectionIII/eval101.dylib</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œ dlsym ä¼šå¾—åˆ° tmpfile åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ï¼Œç„¶åå°±å¯ä»¥å¤„ç†ç±»çš„æ›¿æ¢å·¥ä½œäº†ã€‚åœ¨æ‹¿åˆ°æ–°ç±»çš„ç¬¦å·åœ°å€åï¼Œæˆ‘ä»¬æŠŠæ–°ç±»é‡Œæ‰€æœ‰çš„ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•éƒ½æ›¿æ¢åˆ°å¯¹åº”çš„æ—§ç±»ä¸­ï¼Œä½¿ç”¨çš„æ˜¯SwiftInjection çš„ injection æ–¹æ³•ï¼Œé€šè¿‡OC runtime çš„class_replaceMethodæŠŠæ•´ä¸ªç±»çš„å®ç°æ–¹æ³•éƒ½æ›¿æ¢äº†</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">injection</span><span class="params">(swizzle newClass: AnyClass?, onto oldClass: AnyClass?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> methodCount: <span class="type">UInt32</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> methods = class_copyMethodList(newClass, &amp;methodCount) &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="type">Int</span>(methodCount) &#123;</span><br><span class="line">            <span class="keyword">let</span> method = method_getName(methods[i])</span><br><span class="line">            <span class="keyword">var</span> replacement = method_getImplementation(methods[i])</span><br><span class="line">            <span class="keyword">if</span> traceInjection, <span class="keyword">let</span> tracer = <span class="type">SwiftTrace</span></span><br><span class="line">                .trace(name: injectedPrefix+<span class="type">NSStringFromSelector</span>(method),</span><br><span class="line">                objcMethod: methods[i], objcClass: newClass,</span><br><span class="line">                original: autoBitCast(replacement)) &#123;</span><br><span class="line">                replacement = autoBitCast(tracer)</span><br><span class="line">            &#125;</span><br><span class="line">            class_replaceMethod(oldClass, method, replacement,</span><br><span class="line">                                method_getTypeEncoding(methods[i]))</span><br><span class="line">        &#125;</span><br><span class="line">        free(methods)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;iOS åŸç”Ÿä»£ç çš„ç¼–è¯‘è°ƒè¯•ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€éåˆä¸€éåœ°ç¼–è¯‘é‡å¯ APPæ¥è¿›è¡Œçš„ã€‚æ‰€ä»¥é¡¹ç›®ä»£ç é‡è¶Šå¤§ï¼Œç¼–è¯‘æ—¶é—´å°±è¶Šé•¿ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥å°†éƒ¨åˆ†ä»£ç å…ˆç¼–è¯‘æˆäºŒè¿›åˆ¶é›†æˆåˆ°å·¥ç¨‹é‡Œï¼Œæ¥é¿å…æ¯æ¬¡éƒ½å…¨é‡ç¼–è¯‘æ¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œä½†å³ä½¿è¿™æ ·ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½è¿˜æ˜¯éœ€è¦é‡å¯Appï¼Œéœ€è¦å†èµ°ä¸€éè°ƒè¯•æµç¨‹ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¹¸è¿çš„æ˜¯ï¼ŒJohn Holdsworth å¼€å‘äº†ä¸€ä¸ªå«åš InjectionIII çš„å·¥å…·å¯ä»¥åŠ¨æ€åœ°å°† Swift æˆ– Objective-C çš„ä»£ç åœ¨å·²è¿è¡Œçš„ç¨‹åºä¸­æ‰§è¡Œï¼Œä»¥åŠ å¿«è°ƒè¯•é€Ÿåº¦ï¼ŒåŒæ—¶ä¿è¯ç¨‹åºä¸ç”¨é‡å¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSå¼€å‘è¿›é˜¶" scheme="https://developerdoc.com/categories/iOS%E5%BC%80%E5%8F%91%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§4 ç½‘ç»œç›‘æ§-NSURLProtocol</title>
    <link href="https://developerdoc.com/essay/APM/iOSAPM4/"/>
    <id>https://developerdoc.com/essay/APM/iOSAPM4/</id>
    <published>2020-10-15T14:36:51.000Z</published>
    <updated>2020-10-20T11:25:37.966Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨iOSä¸­è‹¹æœæä¾›äº†NSURLConnectionã€NSURLSessionç­‰ä¼˜ç§€çš„ç½‘è·¯æ¥å£ä¾›æˆ‘ä»¬æ¥è°ƒç”¨ï¼Œå¼€æºç¤¾åŒºä¹Ÿæœ‰å¾ˆå¤šçš„å¼€æºåº“ï¼Œå¦‚ä¹‹å‰çš„ASIHttpRequest ç°åœ¨çš„AFNetworkingå’ŒAlamofireï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»çš„NSURLProtocolï¼Œéƒ½å¯ä»¥ç›‘æ§åˆ°è¿™äº›å¼€æºåº“çš„ç½‘ç»œè¯·æ±‚ã€‚</p><h3 id="NSURLProtocol"><a href="#NSURLProtocol" class="headerlink" title="NSURLProtocol"></a>NSURLProtocol</h3><p>NSURLProtocolæ˜¯iOSç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­å¾ˆå¼ºçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿å­ç±»åŒ–æ¥æ‹¦æˆªAPPä¸­çš„ç½‘ç»œè¯·æ±‚ã€‚</p><p>ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p><ul><li>æˆ‘ä»¬çš„APPå†…çš„æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦å¢åŠ å…¬å…±çš„å¤´ï¼Œåƒè¿™ç§æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡NSURLProtocolæ¥å®ç°ï¼Œå½“ç„¶å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§</li><li>æˆ‘ä»¬éœ€è¦å°†APPæŸä¸ªAPIè¿›è¡Œä¸€äº›è®¿é—®çš„ç»Ÿè®¡</li><li>æˆ‘ä»¬éœ€è¦ç»Ÿè®¡APPå†…çš„ç½‘ç»œè¯·æ±‚å¤±è´¥ç‡</li></ul><p>ç­‰ç­‰ï¼Œéƒ½å¯ä»¥ç”¨åˆ° NSURLProtocolæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬éœ€è¦å­ç±»åŒ–æ‰èƒ½å®ç°ç½‘ç»œè¯·æ±‚æ‹¦æˆªã€‚</p><a id="more"></a><h3 id="æ–°å»º-NSURLProtocolçš„å­ç±»"><a href="#æ–°å»º-NSURLProtocolçš„å­ç±»" class="headerlink" title="æ–°å»º NSURLProtocolçš„å­ç±»"></a>æ–°å»º NSURLProtocolçš„å­ç±»</h3><p>æ–°å»º NSURLProtocolçš„å­ç±» å¹¶ä¸”éœ€è¦é‡å†™ä¸€äº›æ–¹æ³• </p><h3 id="é‡å†™-canâ€‹Initâ€‹Withâ€‹Request"><a href="#é‡å†™-canâ€‹Initâ€‹Withâ€‹Request" class="headerlink" title="é‡å†™ canâ€‹Initâ€‹Withâ€‹Request :"></a>é‡å†™ <code>canâ€‹Initâ€‹Withâ€‹Request</code> :</h3><p>æˆ‘ä»¬éœ€è¦å‘Šè¯‰å®ƒå“ªäº›ç½‘ç»œè¯·æ±‚æ˜¯éœ€è¦æˆ‘ä»¬æ‹¦æˆªçš„ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡æ–¹æ³•canâ€‹Initâ€‹Withâ€‹Request:â€‹æ¥å®ç°çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦æ‹¦æˆªå…¨éƒ¨çš„HTTPå’ŒHTTPSè¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘æˆ‘ä»¬å°±å¯ä»¥åœ¨canâ€‹Initâ€‹Withâ€‹Request:â€‹ä¸­æ¥å®šä¹‰</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> éœ€è¦æ§åˆ¶çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param request æ­¤æ¬¡è¯·æ±‚</span></span><br><span class="line"><span class="comment"> @return æ˜¯å¦éœ€è¦ç›‘æ§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (BOOL)canInitWithRequest:(NSURLRequest *)request &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![request.URL.scheme isEqualToString:@<span class="string">"http"</span>] &amp;&amp;</span><br><span class="line">        ![request.URL.scheme isEqualToString:@<span class="string">"https"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡å†™-canonicalRequestForRequest"><a href="#é‡å†™-canonicalRequestForRequest" class="headerlink" title="é‡å†™ canonicalRequestForRequest:"></a>é‡å†™ <code>canonicalRequestForRequest:</code></h3><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å½“å‰çš„è¯·æ±‚requestï¼Œé€šè¿‡é‡å†™ canonicalRequestForRequest: æ¥å®ç°ã€‚å½“ç„¶å¦‚æœä¸éœ€è¦è‡ªå®šä¹‰ï¼Œç›´æ¥è¿”å›å°±è¡Œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è®¾ç½®æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰è¯·æ±‚</span></span><br><span class="line"><span class="comment"> å¯ä»¥åœ¨è¿™é‡Œç»Ÿä¸€åŠ ä¸Šå¤´ä¹‹ç±»çš„</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param request åº”ç”¨çš„æ­¤æ¬¡è¯·æ±‚</span></span><br><span class="line"><span class="comment"> @return æˆ‘ä»¬è‡ªå®šä¹‰çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (NSURLRequest *)canonicalRequestForRequest:(NSURLRequest *)request &#123;</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±å·²ç»èƒ½å¤Ÿæ‹¦æˆªä½iOSçš„ç½‘ç»œè¯·æ±‚äº† </p><h3 id="canâ€‹Initâ€‹Withâ€‹Request-ä¸-canonicalRequestForRequest"><a href="#canâ€‹Initâ€‹Withâ€‹Request-ä¸-canonicalRequestForRequest" class="headerlink" title="canâ€‹Initâ€‹Withâ€‹Request: ä¸ canonicalRequestForRequest"></a><code>canâ€‹Initâ€‹Withâ€‹Request:</code> ä¸ <code>canonicalRequestForRequest</code></h3><p>åœ¨æˆ‘ä»¬ä¸Šå±‚ä¸šåŠ¡è°ƒç”¨ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨æˆ‘ä»¬çš„canâ€‹Initâ€‹Withâ€‹Request:æ–¹æ³•ï¼Œè¯¢é—®æ˜¯å¦å¯¹è¯¥è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ¥ç€ä¼šè°ƒç”¨æˆ‘ä»¬çš„canonicalRequestForRequest:æ¥è‡ªå®šä¹‰ä¸€ä¸ªrequestï¼Œæ¥ç€åˆä¼šå»è°ƒç”¨canâ€‹Initâ€‹Withâ€‹Request:è¯¢é—®è‡ªå®šä¹‰çš„requestæ˜¯å¦éœ€è¦å¤„ç†ï¼Œæˆ‘ä»¬åˆè¿”å›YESï¼Œç„¶ååˆå»è°ƒç”¨äº†canonicalRequestForRequest:ï¼Œè¿™æ ·ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªæ­»å¾ªç¯äº†ï¼Œè¿™è‚¯å®šæ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚</p><p>æœ‰ä¸ªå¤„ç†æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªå¤„ç†è¿‡çš„requestè¿›è¡Œæ ‡è®°ï¼Œåœ¨åˆ¤æ–­å¦‚æœè¿™ä¸ªrequestå·²ç»å¤„ç†è¿‡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸å†è¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å°±æœ‰æ•ˆé¿å…äº†æ­»å¾ªç¯</p><p>åœ¨æˆ‘ä»¬è‡ªå®šä¹‰requestçš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥è®¾ç½®å¤„ç†æ ‡å¿—</p><ul><li><p>(NSURLRequest <em>)canonicalRequestForRequest:(NSURLRequest </em>)request {<br>  NSMutableURLRequest *mutableReqeust = [request mutableCopy];<br>  [NSURLProtocol setProperty:@YES</p><pre><code>   forKey:PPSHTTPinRequest:mutableReqeust];</code></pre><p>  return [mutableReqeust copy];<br>}<br>ç„¶ååœ¨æˆ‘ä»¬çš„è¯¢é—®å¤„ç†æ–¹æ³•ä¸­ï¼Œé€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰å¤„ç†è¿‡çš„æ ‡å¿—ï¼Œæ¥è¿›è¡Œæ‹¦æˆª</p></li><li><p>(BOOL)canInitWithRequest:(NSURLRequest *)request {</p><p>  if (![request.URL.scheme isEqualToString:@â€httpâ€] &amp;&amp;</p><pre><code>![request.URL.scheme isEqualToString:@&quot;https&quot;]) {return NO;</code></pre><p>  }<br>  //å¦‚æœæ˜¯å·²ç»æ‹¦æˆªè¿‡çš„  å°±æ”¾è¡Œ<br>  if ([NSURLProtocol propertyForKey:PPSHTTP inRequest:request] ) {</p><pre><code>return NO;</code></pre><p>  }<br>  return YES;<br>}<br>è¿™æ ·ï¼Œæˆ‘ä»¬å°±é¿å…äº†æ­»å¾ªç¯</p></li></ul><h3 id="é‡å†™-startLoading-å’Œ-stopLoading"><a href="#é‡å†™-startLoading-å’Œ-stopLoading" class="headerlink" title="é‡å†™ startLoading å’Œ stopLoading"></a>é‡å†™ <code>startLoading</code> å’Œ <code>stopLoading</code></h3><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯éœ€è¦å°†è¿™ä¸ªrequestå‘é€å‡ºå»äº†ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬ä¸å¤„ç†è¿™ä¸ªrequestè¯·æ±‚ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‘å‡ºè¿™ä¸ªç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å¤„ç†äº†è¿™ä¸ªè¯·æ±‚ï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è¿›è¡Œå‘é€äº†ã€‚</p><p>æˆ‘ä»¬è¦æ‰‹åŠ¨å‘é€è¿™ä¸ªç½‘ç»œè¯·æ±‚ï¼Œéœ€è¦é‡å†™startLoadingæ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startLoading &#123;</span><br><span class="line">    NSURLRequest *request = [[self class] canonicalRequestForRequest:self.request];</span><br><span class="line">    self.connection = [[NSURLConnection alloc] initWithRequest:request delegate:self startImmediately:YES];</span><br><span class="line">    self.pps_request = self.request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬æ‹¦æˆªçš„è¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªçœŸå®çš„è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºè¿™æ ·ä¸€ä¸ªçœŸå®çš„ç½‘ç»œè¯·æ±‚ï¼Œåœ¨ç¬¬äºŒè¡Œä»£ç ä¸­ï¼Œå°†æˆ‘ä»¬è‡ªå®šä¹‰åˆ›å»ºçš„requestå‘äº†å‡ºäº†ï¼Œç¬¬ä¸‰è¡Œæ˜¯ä¸ºäº†ä¿å­˜å½“å‰çš„requestï¼Œä½œä¸ºæˆ‘ä»¬åé¢çš„å¤„ç†å¯¹è±¡ã€‚</p><p>å½“ç„¶ï¼Œæœ‰startå°±æœ‰stopï¼Œstopå°±å¾ˆç®€å•äº†</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)stopLoading &#123;</span><br><span class="line">    [self.connection cancel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NSURLConnectionDelegate-è½¬å‘"><a href="#NSURLConnectionDelegate-è½¬å‘" class="headerlink" title="NSURLConnectionDelegate è½¬å‘"></a>NSURLConnectionDelegate è½¬å‘</h3><p>åœ¨startLoadingä¸­ï¼Œæˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ªNSURLConnectionçš„è¯·æ±‚ï¼Œå› ä¸ºNSURLProtocolä½¿æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ç½‘ç»œè¯·æ±‚çš„ä¸€ç³»åˆ—æ“ä½œå…¨éƒ¨ä¼ é€’å‡ºå»ï¼Œä¸ç„¶ä¸Šå±‚å°±ä¸çŸ¥é“å½“å‰ç½‘ç»œçš„ä¸€ä¸ªè¯·æ±‚çŠ¶æ€ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå°†è¿™ä¸ªç½‘ç»œçŠ¶æ€ä¼ åˆ°ä¸Šå±‚ï¼Ÿæ¯ä¸ªprotocolæœ‰ä¸€ä¸ªNSURLProtocolClientå®ä¾‹ï¼Œæˆ‘ä»¬å°±é€šè¿‡è¿™ä¸ªclientæ¥ä¼ é€’ã€‚</p><p>ä¼ é€’ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæ— å¤–ä¹å°±æ˜¯ä¼ é€’è¯·æ±‚çš„ä¸€äº›è¿‡ç¨‹ï¼Œæ•°æ®ï¼Œç»“æœç­‰ç­‰ã€‚ å‘èµ·äº†å‘èµ·äº†ä¸€ä¸ªNSURLConnectionçš„è¯·æ±‚ï¼Œå®ç°å®ƒçš„delegateå°±èƒ½å¤ŸçŸ¥é“ç½‘ç»œè¯·æ±‚çš„ä¸€ç³»åˆ—æ“ä½œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - NSURLConnectionDelegate</span></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didFailWithError:(NSError *)error&#123;</span><br><span class="line">    [self.client URLProtocol:self didFailWithError:error];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)connectionShouldUseCredentialStorage:(NSURLConnection *)connection&#123;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge&#123;</span><br><span class="line">    [self.client URLProtocol:self didReceiveAuthenticationChallenge:challenge];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection</span><br><span class="line">didCancelAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge &#123;</span><br><span class="line">    [self.client URLProtocol:self didCancelAuthenticationChallenge:challenge];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - NSURLConnectionDataDelegate</span></span><br><span class="line">-(NSURLRequest *)connection:(NSURLConnection *)connection willSendRequest:(NSURLRequest *)request redirectResponse:(NSURLResponse *)response&#123;</span><br><span class="line">    <span class="keyword">if</span> (response != nil) &#123;</span><br><span class="line">        self.pps_response = response;</span><br><span class="line">        [self.client URLProtocol:self wasRedirectedToRequest:request redirectResponse:response];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection</span><br><span class="line">didReceiveResponse:(NSURLResponse *)response &#123;</span><br><span class="line">    [[self client] URLProtocol:self didReceiveResponse:response cacheStoragePolicy:NSURLCacheStorageAllowed];</span><br><span class="line">    self.pps_response = response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data &#123;</span><br><span class="line">    [self.client URLProtocol:self didLoadData:data];</span><br><span class="line">    [self.pps_data appendData:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSCachedURLResponse *)connection:(NSURLConnection *)connection</span><br><span class="line">                  willCacheResponse:(NSCachedURLResponse *)cachedResponse &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedResponse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connectionDidFinishLoading:(NSURLConnection *)connection &#123;</span><br><span class="line">    [[self client] URLProtocolDidFinishLoading:self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ‹¦æˆªç½‘ç»œ"><a href="#æ‹¦æˆªç½‘ç»œ" class="headerlink" title="æ‹¦æˆªç½‘ç»œ"></a>æ‹¦æˆªç½‘ç»œ</h3><p>è¿™æ ·ï¼ŒåŸºæœ¬çš„protocolå°±å·²ç»å®ç°å®Œæˆï¼Œé‚£ä¹ˆæ€æ ·æ¥æ‹¦æˆªç½‘ç»œã€‚æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocolé€šè¿‡NSURLProtocolæ³¨å†Œåˆ°æˆ‘ä»¬çš„ç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­ï¼Œå‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å¤„ç†ç±»ä¸å†æ˜¯é»˜è®¤çš„NSURLProtocolï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocol</p><p>ã€‚æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocolé€šè¿‡NSURLProtocolæ³¨å†Œåˆ°æˆ‘ä»¬çš„ç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­ï¼Œå‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å¤„ç†ç±»ä¸å†æ˜¯é»˜è®¤çš„NSURLProtocolï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocol</p><p>æˆ‘ä»¬åœ¨PPSURLProtocolæš´éœ²ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">@interface PPSURLProtocol : NSURLProtocol</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)start;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)end;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æˆ‘ä»¬çš„APPå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨startï¼Œå°±å¯ä»¥ç›‘å¬åˆ°æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    PPSURLSessionConfiguration *sessionConfiguration = [PPSURLSessionConfiguration defaultConfiguration];</span><br><span class="line">    [NSURLProtocol registerClass:[PPSURLProtocol <span class="class"><span class="keyword">class</span>]];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)end &#123;</span><br><span class="line">    PPSURLSessionConfiguration *sessionConfiguration = [PPSURLSessionConfiguration defaultConfiguration];</span><br><span class="line">    [NSURLProtocol unregisterClass:[PPSURLProtocol <span class="class"><span class="keyword">class</span>]];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–å¤„ç†"><a href="#å…¶ä»–å¤„ç†" class="headerlink" title="å…¶ä»–å¤„ç†"></a>å…¶ä»–å¤„ç†</h3><p>ä¸Šé¢çš„ä»£ç å·²ç»èƒ½å¤Ÿç›‘æ§åˆ°ç»å¤§éƒ¨åˆ†çš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯å‘¢ï¼Œæœ‰ä¸€ä¸ªå´æ˜¯ç‰¹æ®Šçš„ã€‚</p><p>å¯¹äºNSURLSessionå‘èµ·çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡sharedå¾—åˆ°çš„sessionå‘èµ·çš„ç½‘ç»œè¯·æ±‚éƒ½èƒ½å¤Ÿç›‘å¬åˆ°ï¼Œä½†æ˜¯é€šè¿‡æ–¹æ³•<em>sessionWithConfiguration:delegate:delegateQueue:</em>å¾—åˆ°çš„sessionï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½ç›‘å¬åˆ°çš„ï¼ŒåŸå› å°±å‡ºåœ¨NSURLSessionConfigurationä¸Šï¼Œæˆ‘ä»¬è¿›åˆ°NSURLSessionConfigurationé‡Œé¢çœ‹ä¸€ä¸‹ï¼Œä»–æœ‰ä¸€ä¸ªå±æ€§</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nullable, copy) NSArray&lt;Class&gt; *protocolClasses;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªNSURLProtocolæ•°ç»„ï¼Œä¸Šé¢æˆ‘ä»¬æåˆ°äº†ï¼Œæˆ‘ä»¬ç›‘æ§ç½‘ç»œæ˜¯é€šè¿‡æ³¨å†ŒNSURLProtocolæ¥è¿›è¡Œç½‘ç»œç›‘æ§çš„ï¼Œä½†æ˜¯é€šè¿‡<em>sessionWithConfiguration:delegate:delegateQueue:å¾—åˆ°çš„sessionï¼Œä»–çš„configurationä¸­å·²ç»æœ‰ä¸€ä¸ªNSURLProtocolï¼Œæ‰€ä»¥ä»–ä¸ä¼šèµ°æˆ‘ä»¬çš„protocolæ¥ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°†NSURLSessionConfigurationçš„å±æ€§protocolClassesçš„getæ–¹æ³•hookæ‰ï¼Œé€šè¿‡è¿”å›æˆ‘ä»¬è‡ªå·±çš„protocolï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿç›‘æ§åˆ°é€šè¿‡sessionWithConfiguration:delegate:delegateQueue:</em>å¾—åˆ°çš„sessionçš„ç½‘ç»œè¯·æ±‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> hook çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> BOOL isHookWorking = NO;</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">NSURLSessionConfiguration</span> <span class="params">(FSAPM)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Life Cycle</span></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> swizzle method</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_once_t</span> onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// é¿å…ä½¿ç”¨ç§æœ‰ APImï¼Œä¸è¿‡å®¡</span></span><br><span class="line">        Class cls = NSClassFromString([NSString stringWithFormat:@<span class="string">"%@%@%@"</span>, @<span class="string">"__NSCFU"</span>, @<span class="string">"RLSessionCon"</span>, @<span class="string">"figuration"</span>]) ?: NSClassFromString(@<span class="string">"NSURLSessionConfiguration"</span>);</span><br><span class="line">        Method origMethod = class_getInstanceMethod(cls, @selector(protocolClasses));</span><br><span class="line">        Method replMethod = class_getInstanceMethod(self, @selector(fs_protocolClasses));</span><br><span class="line">        <span class="keyword">if</span> (origMethod &amp;&amp; replMethod) &#123;</span><br><span class="line">            <span class="keyword">if</span> (class_addMethod(cls, @selector(protocolClasses), method_getImplementation(replMethod), method_getTypeEncoding(replMethod))) &#123;</span><br><span class="line">                class_replaceMethod(self, @selector(fs_protocolClasses), method_getImplementation(origMethod), method_getTypeEncoding(origMethod));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                method_exchangeImplementations(origMethod, replMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Public Method</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å¼€å¯ hook</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    isHookWorking = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å…³é—­ hook</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)stop &#123;</span><br><span class="line">    isHookWorking = NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Private Method</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å°† FSURLProtocol å¯¹è±¡æ”¾åœ¨é¦–ä½</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return NSArray&lt;NSURLProtocol&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (NSArray&lt;Class&gt; *)fs_protocolClasses &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHookWorking) &#123;</span><br><span class="line">        <span class="keyword">return</span> [self fs_protocolClasses];</span><br><span class="line">    &#125;</span><br><span class="line">    NSMutableArray *<span class="built_in">array</span> = [[self fs_protocolClasses] mutableCopy];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">array</span>.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> @[[FSURLProtocol class]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="built_in">array</span> containsObject:[FSURLProtocol class]]) &#123;</span><br><span class="line">        [<span class="built_in">array</span> insertObject:[FSURLProtocol <span class="class"><span class="keyword">class</span>] <span class="title">atIndex</span>:</span><span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">array</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ–¹æ³•æ›¿æ¢æ‰ï¼Œåœ¨ç§»é™¤ç›‘å¬çš„æ—¶å€™ï¼Œæ¢å¤ä¹‹å‰çš„æ–¹æ³•</p><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ç›‘å¬å°±å®Œæˆäº†ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å°†è¿™æ‰€æœ‰çš„ç›‘å¬å­˜èµ·æ¥ï¼Œåœ¨protocolçš„startæˆ–è€…stopä¸­è·å–åˆ°requestå’Œresponseï¼Œå°†ä»–ä»¬å­˜å‚¨èµ·æ¥å°±è¡Œï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ®è‹¹æœçš„å®˜æ–¹è¯´æ˜ï¼Œå› ä¸ºè¯·æ±‚å‚æ•°å¯èƒ½ä¼šå¾ˆå¤§ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œè¯·æ±‚å‚æ•°æ˜¯æ²¡æœ‰è¢«æ‹¦æˆªæ‰çš„ï¼Œå°±æ˜¯postçš„HTTPBodyæ˜¯æ²¡æœ‰çš„</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨iOSä¸­è‹¹æœæä¾›äº†NSURLConnectionã€NSURLSessionç­‰ä¼˜ç§€çš„ç½‘è·¯æ¥å£ä¾›æˆ‘ä»¬æ¥è°ƒç”¨ï¼Œå¼€æºç¤¾åŒºä¹Ÿæœ‰å¾ˆå¤šçš„å¼€æºåº“ï¼Œå¦‚ä¹‹å‰çš„ASIHttpRequest ç°åœ¨çš„AFNetworkingå’ŒAlamofireï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»çš„NSURLProtocolï¼Œéƒ½å¯ä»¥ç›‘æ§åˆ°è¿™äº›å¼€æºåº“çš„ç½‘ç»œè¯·æ±‚ã€‚&lt;/p&gt;
&lt;h3 id=&quot;NSURLProtocol&quot;&gt;&lt;a href=&quot;#NSURLProtocol&quot; class=&quot;headerlink&quot; title=&quot;NSURLProtocol&quot;&gt;&lt;/a&gt;NSURLProtocol&lt;/h3&gt;&lt;p&gt;NSURLProtocolæ˜¯iOSç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­å¾ˆå¼ºçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿å­ç±»åŒ–æ¥æ‹¦æˆªAPPä¸­çš„ç½‘ç»œè¯·æ±‚ã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾å‡ ä¸ªä¾‹å­ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æˆ‘ä»¬çš„APPå†…çš„æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦å¢åŠ å…¬å…±çš„å¤´ï¼Œåƒè¿™ç§æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡NSURLProtocolæ¥å®ç°ï¼Œå½“ç„¶å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬éœ€è¦å°†APPæŸä¸ªAPIè¿›è¡Œä¸€äº›è®¿é—®çš„ç»Ÿè®¡&lt;/li&gt;
&lt;li&gt;æˆ‘ä»¬éœ€è¦ç»Ÿè®¡APPå†…çš„ç½‘ç»œè¯·æ±‚å¤±è´¥ç‡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ç­‰ç­‰ï¼Œéƒ½å¯ä»¥ç”¨åˆ° NSURLProtocolæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬éœ€è¦å­ç±»åŒ–æ‰èƒ½å®ç°ç½‘ç»œè¯·æ±‚æ‹¦æˆªã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="APM" scheme="https://developerdoc.com/categories/APM/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§3 FPSä¸å¡é¡¿</title>
    <link href="https://developerdoc.com/essay/APM/iOSAPM3/"/>
    <id>https://developerdoc.com/essay/APM/iOSAPM3/</id>
    <published>2020-10-13T09:09:27.000Z</published>
    <updated>2020-10-13T11:48:49.331Z</updated>
    
    <content type="html"><![CDATA[<h3 id="FPS"><a href="#FPS" class="headerlink" title="FPS"></a>FPS</h3><p>FPSï¼ˆFrames Per Secondï¼‰æ˜¯æŒ‡ç”»é¢æ¯ç§’ä¼ è¾“çš„å¸§æ•°ã€‚æ¯ç§’å¸§æ•°è¶Šå¤šï¼Œæ‰€æ˜¾ç¤ºçš„åŠ¨ç”»å°±è¶Šæµç•…ï¼Œä¸€èˆ¬åªè¦ä¿æŒ FPS åœ¨ 50-60ï¼ŒApp å°±ä¼šæœ‰æµç•…çš„ä½“éªŒï¼Œåä¹‹ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚</p><h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p><code>CADisplayLink</code> æ˜¯ä¸€ä¸ªèƒ½è®©æˆ‘ä»¬ä»¥å’Œå±å¹•åˆ·æ–°ç‡ç›¸åŒçš„é¢‘ç‡å°†å†…å®¹ç”»åˆ°å±å¹•ä¸Šçš„å®šæ—¶å™¨ã€‚</p><p>ä¸€æ—¦ CADisplayLink ä»¥ç‰¹å®šçš„æ¨¡å¼æ³¨å†Œåˆ° runloop ä¹‹åï¼Œæ¯å½“å±å¹•éœ€è¦åˆ·æ–°æ—¶ï¼Œrunloop å°±ä¼šè°ƒç”¨ CADisplayLink ç»‘å®šçš„ target ä¸Šçš„ selectorï¼Œæ­¤æ—¶ target å¯ä»¥è¯»å–åˆ° CADisplayLink çš„æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´æˆ³ï¼Œç”¨æ¥å‡†å¤‡ä¸‹ä¸€å¸§æ˜¾ç¤ºéœ€è¦çš„æ•°æ®ã€‚å¦‚ï¼šä¸€ä¸ªè§†é¢‘åº”ç”¨ä½¿ç”¨æ—¶é—´æˆ³æ¥è®¡ç®—ä¸‹ä¸€å¸§è¦æ˜¾ç¤ºçš„è§†é¢‘æ•°æ®ã€‚</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ç°é˜¶æ®µï¼Œå¸¸ç”¨çš„ FPS ç›‘æ§å‡ ä¹éƒ½æ˜¯åŸºäº CADisplayLink å®ç°çš„ã€‚</p><a id="more"></a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// swift</span></span><br><span class="line">final <span class="class"><span class="keyword">class</span> <span class="title">FPSMonitor</span>:</span> NSObject &#123;</span><br><span class="line">    <span class="keyword">private</span> var timer: Timer?</span><br><span class="line">    <span class="keyword">private</span> var link: CADisplayLink?</span><br><span class="line">    <span class="keyword">private</span> var count: UInt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> var lastTime: TimeInterval = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    func enableMonitor() &#123;</span><br><span class="line">        <span class="keyword">if</span> link == nil &#123;</span><br><span class="line">            link = CADisplayLink(target: self, selector: #selector(fpsInfoCalculate(_:)))</span><br><span class="line">            link?.add(to: RunLoop.main, forMode: .common)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            link?.isPaused = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    func disableMonitor() &#123;</span><br><span class="line">        <span class="keyword">if</span> let link = link &#123;</span><br><span class="line">            link.isPaused = <span class="literal">true</span></span><br><span class="line">            link.invalidate()</span><br><span class="line">            self.link = nil</span><br><span class="line">            lastTime = <span class="number">0</span></span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @objc</span><br><span class="line">    func fpsInfoCalculate(_ link: CADisplayLink) &#123;</span><br><span class="line">        <span class="keyword">if</span> lastTime == <span class="number">0</span> &#123;</span><br><span class="line">            lastTime = link.timestamp</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        let delta = link.timestamp - lastTime</span><br><span class="line">        <span class="keyword">if</span> delta &gt;= <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// é—´éš”è¶…è¿‡ 1 ç§’</span></span><br><span class="line">            lastTime = link.timestamp</span><br><span class="line">            let fps = Double(count) / delta</span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            let intFps = Int(fps + <span class="number">0.5</span>)</span><br><span class="line">            print(<span class="string">"å¸§ç‡ï¼š\(intFps)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CADisplayLink å®ç°çš„ FPS åœ¨ç”Ÿäº§åœºæ™¯ä¸­åªæœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œä¸èƒ½ä»£è¡¨çœŸå®çš„ FPSã€‚å› ä¸ºåŸºäº CADisplayLink å®ç°çš„ FPS æ— æ³•å®Œå…¨æ£€æµ‹å‡ºå½“å‰ Core Animation çš„æ€§èƒ½æƒ…å†µï¼Œåªèƒ½æ£€æµ‹å‡ºå½“å‰ RunLoop çš„å¸§ç‡ã€‚</p><h3 id="å¦‚ä½•ç›‘æ§å¡é¡¿"><a href="#å¦‚ä½•ç›‘æ§å¡é¡¿" class="headerlink" title="å¦‚ä½•ç›‘æ§å¡é¡¿"></a>å¦‚ä½•ç›‘æ§å¡é¡¿</h3><p>é‚£æ€ä¹ˆç›‘æ§åº”ç”¨çš„å¡é¡¿æƒ…å†µï¼Ÿé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆ</p><ul><li>FPS ç›‘æ§ï¼šè¿™æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹æ¡ˆï¼Œå¦‚æœå¸§ç‡è¶Šé«˜æ„å‘³ç€ç•Œé¢è¶Šæµç•…ï¼Œä¸Šæ–‡ä¹Ÿç»™å‡ºäº†è®¡ç®— FPS çš„å®ç°æ–¹å¼ï¼Œé€šè¿‡ä¸€æ®µè¿ç»­çš„ FPS è®¡ç®—ä¸¢å¸§ç‡æ¥è¡¡é‡å½“å‰é¡µé¢ç»˜åˆ¶çš„è´¨é‡ã€‚<ul><li>FPS çš„åˆ·æ–°é¢‘ç‡éå¸¸å¿«ï¼Œå¹¶ä¸”å®¹æ˜“å‘ç”ŸæŠ–åŠ¨ï¼Œå› æ­¤ç›´æ¥é€šè¿‡æ¯”è¾ƒ FPS æ¥ä¾¦æµ‹å¡é¡¿æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼›æ­¤å¤–ï¼Œä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§ä¹Ÿä¼šå‘ç”ŸæŠ–åŠ¨ï¼Œæ‰€ä»¥å¾®ä¿¡è¯»ä¹¦å›¢é˜Ÿç»™å‡ºä¸€ç§ç»¼åˆæ–¹æ¡ˆï¼Œç»“åˆä¸»çº¿ç¨‹ç›‘æ§ã€FPS ç›‘æ§ï¼Œä»¥åŠ CPU ä½¿ç”¨ç‡ç­‰æŒ‡æ ‡ï¼Œä½œä¸ºåˆ¤æ–­å¡é¡¿çš„æ ‡å‡†ã€‚Bugly çš„å¡é¡¿æ£€æµ‹ä¹Ÿæ˜¯åŸºäºè¿™å¥—æ ‡å‡†ã€‚</li></ul></li><li>çº¿ç¨‹å¡é¡¿ç›‘æ§ï¼šè¿™æ˜¯ä¸šå†…å¸¸ç”¨çš„ä¸€ç§æ£€æµ‹å¡é¡¿çš„æ–¹æ³•ï¼Œé€šè¿‡å¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹æ¥ç›‘æ§ä¸»çº¿ç¨‹çš„ RunLoopï¼Œå½“ä¸¤ä¸ªçŠ¶æ€åŒºåŸŸä¹‹é—´çš„è€—æ—¶å¤§äºé˜ˆå€¼æ—¶ï¼Œå°±è®°ä¸ºå‘ç”Ÿä¸€æ¬¡å¡é¡¿ã€‚ç¾å›¢çš„ç§»åŠ¨ç«¯æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ Hertz é‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼</li></ul><p>ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§çš„å®ç°æ€è·¯ï¼šå¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶åå®æ—¶è®¡ç®— kCFRunLoopBeforeSources å’Œ kCFRunLoopAfterWaiting ä¸¤ä¸ªçŠ¶æ€åŒºåŸŸä¹‹é—´çš„è€—æ—¶æ˜¯å¦è¶…è¿‡æŸä¸ªé˜€å€¼ï¼Œæ¥æ–­å®šä¸»çº¿ç¨‹çš„å¡é¡¿æƒ…å†µï¼Œå¯ä»¥å°†è¿™ä¸ªè¿‡ç¨‹æƒ³è±¡æˆæ“åœºä¸Šè·‘åœˆçš„è¿åŠ¨å‘˜ï¼Œæˆ‘ä»¬ä¼šæ¯éš”ä¸€æ®µæ—¶é—´é—´éš”å»åˆ¤æ–­æ˜¯å¦è·‘äº†ä¸€åœˆï¼Œå¦‚æœå‘ç°åœ¨æŒ‡å®šæ—¶é—´é—´éš”æ²¡æœ‰è·‘å®Œä¸€åœˆï¼Œåˆ™è®¤ä¸ºåœ¨æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ä¸­è€—æ—¶å¤ªå¤šï¼Œè§†ä¸ºä¸»çº¿ç¨‹å¡é¡¿ã€‚</p><h3 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ CFRunLoopObserverRef å®æ—¶è·å– NSRunLoop çš„çŠ¶æ€ã€‚å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª CFRunLoopObserverContext è§‚å¯Ÿè€… observerã€‚ç„¶åå°†è§‚å¯Ÿè€… observer æ·»åŠ åˆ°ä¸»çº¿ç¨‹ RunLoop çš„ kCFRunLoopCommonModes æ¨¡å¼ä¸‹è¿›è¡Œè§‚å¯Ÿã€‚</p><p>ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªæŒç»­çš„å­çº¿ç¨‹ä¸“é—¨ç”¨æ¥ç›‘æ§ä¸»çº¿ç¨‹çš„ RunLoop çŠ¶æ€ã€‚ä¸ºäº†è®©è®¡ç®—æ›´ç²¾ç¡®ï¼Œéœ€è¦è®©å­çº¿ç¨‹æ›´åŠæ—¶çš„è·çŸ¥ä¸»çº¿ç¨‹ RunLoop çŠ¶æ€å˜åŒ–ï¼Œdispatch_semaphore_t æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦å¤–ï¼Œå¡é¡¿éœ€è¦è¦†ç›–å¤šæ¬¡è¿ç»­çŸ­æ—¶é—´å¡é¡¿å’Œå•æ¬¡é•¿æ—¶é—´å¡é¡¿ä¸¤ç§æƒ…æ™¯ï¼Œæ‰€ä»¥åˆ¤å®šæ¡ä»¶ä¹Ÿéœ€è¦åšé€‚å½“ä¼˜åŒ–ã€‚ä¼˜åŒ–åçš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runLoopObserverCallBack</span><span class="params">(CFRunLoopObserverRef observer, CFRunLoopActivity activity, <span class="keyword">void</span> *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyClass *object = (__bridge MyClass*)info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•çŠ¶æ€å€¼</span></span><br><span class="line">    object-&gt;activity = activity;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€ä¿¡å·</span></span><br><span class="line">    <span class="keyword">dispatch_semaphore_t</span> semaphore = moniotr-&gt;semaphore;</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerObserver</span><br><span class="line">&#123;</span><br><span class="line">    CFRunLoopObserverContext context = &#123;<span class="number">0</span>,(__bridge <span class="keyword">void</span>*)self,<span class="literal">NULL</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    CFRunLoopObserverRef observer = CFRunLoopObserverCreate(kCFAllocatorDefault,</span><br><span class="line">                                                            kCFRunLoopAllActivities,</span><br><span class="line">                                                            YES,</span><br><span class="line">                                                            <span class="number">0</span>,</span><br><span class="line">                                                            &amp;runLoopObserverCallBack,</span><br><span class="line">                                                            &amp;context);</span><br><span class="line">    CFRunLoopAddObserver(CFRunLoopGetMain(), observer, kCFRunLoopCommonModes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¿¡å·</span></span><br><span class="line">    semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨å­çº¿ç¨‹ç›‘æ§æ—¶é•¿</span></span><br><span class="line">    dispatch_async(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="keyword">while</span> (YES)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å‡å®šè¿ç»­5æ¬¡è¶…æ—¶50msè®¤ä¸ºå¡é¡¿(å½“ç„¶ä¹ŸåŒ…å«äº†å•æ¬¡è¶…æ—¶250ms)</span></span><br><span class="line">            <span class="keyword">long</span> st = dispatch_semaphore_wait(semaphore, dispatch_time(DISPATCH_TIME_NOW, <span class="number">50</span>*NSEC_PER_MSEC));</span><br><span class="line">            <span class="keyword">if</span> (st != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (activity==kCFRunLoopBeforeSources || activity==kCFRunLoopAfterWaiting)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (++timeoutCount &lt; <span class="number">5</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// æ£€æµ‹åˆ°å¡é¡¿ï¼Œè¿›è¡Œå¡é¡¿ä¸ŠæŠ¥</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            timeoutCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;FPS&quot;&gt;&lt;a href=&quot;#FPS&quot; class=&quot;headerlink&quot; title=&quot;FPS&quot;&gt;&lt;/a&gt;FPS&lt;/h3&gt;&lt;p&gt;FPSï¼ˆFrames Per Secondï¼‰æ˜¯æŒ‡ç”»é¢æ¯ç§’ä¼ è¾“çš„å¸§æ•°ã€‚æ¯ç§’å¸§æ•°è¶Šå¤šï¼Œæ‰€æ˜¾ç¤ºçš„åŠ¨ç”»å°±è¶Šæµç•…ï¼Œä¸€èˆ¬åªè¦ä¿æŒ FPS åœ¨ 50-60ï¼ŒApp å°±ä¼šæœ‰æµç•…çš„ä½“éªŒï¼Œåä¹‹ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;a href=&quot;#ç›¸å…³ç³»ç»ŸåŸç†&quot; class=&quot;headerlink&quot; title=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;/a&gt;ç›¸å…³ç³»ç»ŸåŸç†&lt;/h3&gt;&lt;p&gt;&lt;code&gt;CADisplayLink&lt;/code&gt; æ˜¯ä¸€ä¸ªèƒ½è®©æˆ‘ä»¬ä»¥å’Œå±å¹•åˆ·æ–°ç‡ç›¸åŒçš„é¢‘ç‡å°†å†…å®¹ç”»åˆ°å±å¹•ä¸Šçš„å®šæ—¶å™¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€æ—¦ CADisplayLink ä»¥ç‰¹å®šçš„æ¨¡å¼æ³¨å†Œåˆ° runloop ä¹‹åï¼Œæ¯å½“å±å¹•éœ€è¦åˆ·æ–°æ—¶ï¼Œrunloop å°±ä¼šè°ƒç”¨ CADisplayLink ç»‘å®šçš„ target ä¸Šçš„ selectorï¼Œæ­¤æ—¶ target å¯ä»¥è¯»å–åˆ° CADisplayLink çš„æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´æˆ³ï¼Œç”¨æ¥å‡†å¤‡ä¸‹ä¸€å¸§æ˜¾ç¤ºéœ€è¦çš„æ•°æ®ã€‚å¦‚ï¼šä¸€ä¸ªè§†é¢‘åº”ç”¨ä½¿ç”¨æ—¶é—´æˆ³æ¥è®¡ç®—ä¸‹ä¸€å¸§è¦æ˜¾ç¤ºçš„è§†é¢‘æ•°æ®ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ä»£ç å®ç°&quot;&gt;&lt;a href=&quot;#ä»£ç å®ç°&quot; class=&quot;headerlink&quot; title=&quot;ä»£ç å®ç°&quot;&gt;&lt;/a&gt;ä»£ç å®ç°&lt;/h3&gt;&lt;p&gt;ç°é˜¶æ®µï¼Œå¸¸ç”¨çš„ FPS ç›‘æ§å‡ ä¹éƒ½æ˜¯åŸºäº CADisplayLink å®ç°çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="APM" scheme="https://developerdoc.com/categories/APM/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§2 Memoryä¿¡æ¯</title>
    <link href="https://developerdoc.com/essay/APM/iOSAPM2/"/>
    <id>https://developerdoc.com/essay/APM/iOSAPM2/</id>
    <published>2020-10-12T11:55:01.000Z</published>
    <updated>2020-10-13T11:36:53.426Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><p>æˆ‘ä»¬å¯ä»¥è”æƒ³ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µæ˜¯å¦ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼CPUçš„æ–¹å¼è·å–åˆ°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p><h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p>å†…å­˜æ˜¯æœ‰é™ä¸”ç³»ç»Ÿå…±äº«çš„èµ„æºï¼Œä¸€ä¸ªç¨‹åºå ç”¨è¶Šå¤šï¼Œç³»ç»Ÿå’Œå…¶ä»–ç¨‹åºæ‰€èƒ½ç”¨çš„å°±è¶Šå°‘ã€‚ç¨‹åºå¯åŠ¨å‰éƒ½éœ€è¦å…ˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„æ•°æ®æ“ä½œä¹Ÿä¼šå ç”¨ä¸€å®šçš„å†…å­˜èµ„æºã€‚å‡å°‘å†…å­˜å ç”¨ä¹Ÿèƒ½åŒæ—¶å‡å°‘å…¶å¯¹ CPU æ—¶é—´ç»´åº¦ä¸Šçš„æ¶ˆè€—ï¼Œä»è€Œä½¿ä¸ä»…ä½¿ App ä»¥åŠæ•´ä¸ªç³»ç»Ÿä¹Ÿéƒ½èƒ½è¡¨ç°çš„æ›´å¥½ã€‚</p><p>MacOS å’Œ iOS éƒ½é‡‡ç”¨äº†è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ¥çªç ´ç‰©ç†å†…å­˜çš„å¤§å°é™åˆ¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€æ®µç”±å¤šä¸ªå¤§å°ç›¸åŒçš„é¡µï¼ˆPageï¼‰æ‰€æ„æˆçš„é€»è¾‘åœ°å€ç©ºé—´ã€‚å¤„ç†å™¨å’Œå†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼ŒMemory Management Unitï¼‰ç»´æŠ¤ç€ç”±é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„ é¡µé¢æ˜ å°„è¡¨ï¼ˆç®€ç§° é¡µè¡¨ï¼‰ï¼Œå½“ç¨‹åºè®¿é—®é€»è¾‘å†…å­˜åœ°å€æ—¶ï¼Œç”± MMU æ ¹æ®é¡µè¡¨å°†é€»è¾‘åœ°å€è½¬æ¢ä¸ºçœŸå®çš„ç‰©ç†åœ°å€ã€‚åœ¨æ—©æœŸçš„è‹¹æœè®¾å¤‡ä¸­ï¼Œæ¯ä¸ªé¡µçš„å¤§å°ä¸º 4KBï¼›åŸºäº A7 å’Œ A8 å¤„ç†å™¨çš„ç³»ç»Ÿä¸º 64 ä½ç¨‹åºæä¾›äº† 16KB çš„è™šæ‹Ÿå†…å­˜åˆ†é¡µå’Œ 4KB çš„ç‰©ç†å†…å­˜åˆ†é¡µï¼›åœ¨ A9 ä¹‹åï¼Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„åˆ†é¡µå¤§å°éƒ½è¾¾åˆ°äº† 16KBã€‚</p><p>è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼ˆVirtual Pageï¼ŒVPï¼‰æœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li>Cleanï¼šæŒ‡èƒ½å¤Ÿè¢«ç³»ç»Ÿæ¸…ç†å‡ºå†…å­˜ä¸”åœ¨éœ€è¦æ—¶èƒ½é‡æ–°åŠ è½½çš„æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š<ul><li>å†…å­˜æ˜ å°„æ–‡ä»¶</li><li>Frameworks ä¸­çš„ __DATA_CONST éƒ¨åˆ†</li><li>åº”ç”¨çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶</li></ul></li><li>Dirtyï¼šæŒ‡ä¸èƒ½è¢«ç³»ç»Ÿå›æ”¶çš„å†…å­˜å ç”¨ï¼ŒåŒ…æ‹¬ï¼š<ul><li>æ‰€æœ‰å †ä¸Šçš„å¯¹è±¡</li><li>å›¾ç‰‡è§£ç ç¼“å†²æ•°æ®</li><li>Framework ä¸­çš„ DATA å’Œ DATA_DIRTY éƒ¨åˆ†</li></ul></li></ul><a id="more"></a><p>ç”±äºå†…å­˜å®¹é‡å’Œè¯»å†™å¯¿å‘½çš„é™åˆ¶ï¼ŒiOS ä¸Šæ²¡æœ‰ Disk Swap æœºåˆ¶ï¼Œå–è€Œä»£ä¹‹ä½¿ç”¨ Compressed Memory æŠ€æœ¯ã€‚ Disk Swap æ˜¯æŒ‡åœ¨ macOS ä»¥åŠä¸€äº›å…¶ä»–æ¡Œé¢æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“å†…å­˜å¯ç”¨èµ„æºç´§å¼ æ—¶ï¼Œç³»ç»Ÿå°†å†…å­˜ä¸­çš„å†…å®¹å†™å…¥ç£ç›˜ä¸­çš„backing storeï¼ˆSwapping outï¼‰ï¼Œå¹¶ä¸”åœ¨éœ€è¦è®¿é—®æ—¶ä»ç£ç›˜ä¸­å†è¯»å…¥ RAMï¼ˆSwapping inï¼‰ã€‚ä¸å¤§å¤šæ•° UNIX ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼ŒmacOS æ²¡æœ‰é¢„å…ˆåˆ†é…ç£ç›˜ä¸­çš„ä¸€éƒ¨åˆ†ä½œä¸º backing storeï¼Œè€Œæ˜¯åˆ©ç”¨å¼•å¯¼åˆ†åŒºæ‰€æœ‰å¯ç”¨çš„ç£ç›˜ç©ºé—´ã€‚</p><p>è‹¹æœæœ€åˆåªæ˜¯å…¬å¼€äº†ä» OS X Mavericks å¼€å§‹ä½¿ç”¨ Compressed Memory æŠ€æœ¯ï¼Œä½† iOS ç³»ç»Ÿä¹Ÿä» iOS 7 å¼€å§‹æ‚„æ‚„åœ°ä½¿ç”¨ã€‚</p><p>Compressed Memory æŠ€æœ¯åœ¨å†…å­˜ç´§å¼ æ—¶èƒ½å¤Ÿå°†æœ€è¿‘ä½¿ç”¨è¿‡çš„å†…å­˜å ç”¨å‹ç¼©è‡³åŸæœ‰å¤§å°çš„ä¸€åŠä»¥ä¸‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨éœ€è¦æ—¶è§£å‹å¤ç”¨ã€‚å®ƒåœ¨èŠ‚çœå†…å­˜çš„åŒæ—¶æé«˜äº†ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼Œå…¶ç‰¹ç‚¹å¯ä»¥å½’ç»“ä¸ºï¼š</p><ul><li>å‡å°‘äº†ä¸æ´»è·ƒå†…å­˜å ç”¨</li><li>æ”¹å–„ç”µæºæ•ˆç‡ï¼Œé€šè¿‡å‹ç¼©å‡å°‘ç£ç›˜ IO å¸¦æ¥çš„æŸè€—</li><li>å‹ç¼©/è§£å‹éå¸¸å¿«ï¼Œèƒ½å¤Ÿå°½å¯èƒ½å‡å°‘ CPU çš„æ—¶é—´å¼€é”€</li><li>æ”¯æŒå¤šæ ¸æ“ä½œ</li></ul><p>æœ¬è´¨ä¸Šï¼ŒCompressed Memory ä¹Ÿæ˜¯ Dirty Memoryã€‚å› æ­¤ï¼Œmemory footprint = dirty size + compressed sizeï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦å¹¶ä¸”èƒ½å¤Ÿå°è¯•å»å‡å°‘çš„å†…å­˜å ç”¨ã€‚</p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>åœ¨ /usr/include/mach/task_info.h ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° mach_task_basic_info å’Œ task_basic_info ç»“æ„ä½“çš„å®šä¹‰ï¼Œåˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºã€‚äº‹å®ä¸Šï¼Œè‹¹æœå…¬å¸å·²ç»ä¸å»ºè®®å†ä½¿ç”¨ task_basic_info ç»“æ„ä½“äº†ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_TASK_BASIC_INFO     20         <span class="comment">/* always 64-bit basic info */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_task_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  virtual_size;       <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  resident_size;      <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  resident_size_max;  <span class="comment">/* maximum resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;          <span class="comment">/* total user run time for</span></span><br><span class="line"><span class="comment">                                               terminated threads */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;        <span class="comment">/* total system run time for</span></span><br><span class="line"><span class="comment">                                               terminated threads */</span></span><br><span class="line">        <span class="keyword">policy_t</span>        policy;             <span class="comment">/* default policy for new threads */</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;      <span class="comment">/* suspend count for task */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* localized structure - cannot be safely passed between tasks of differing sizes */</span></span><br><span class="line"><span class="comment">/* Don't use this, use MACH_TASK_BASIC_INFO instead */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;  <span class="comment">/* suspend count for task */</span></span><br><span class="line">        <span class="keyword">vm_size_t</span>       virtual_size;   <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">vm_size_t</span>       resident_size;  <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;      <span class="comment">/* total user run time for</span></span><br><span class="line"><span class="comment">                                           terminated threads */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;    <span class="comment">/* total system run time for</span></span><br><span class="line"><span class="comment">                                           terminated threads */</span></span><br><span class="line"><span class="keyword">policy_t</span>policy;<span class="comment">/* default policy for new threads */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>mach_task_basic_info ç»“æ„ä½“å­˜å‚¨äº† Mach task çš„å†…å­˜ä½¿ç”¨ä¿¡æ¯ï¼Œå…¶ä¸­ resident_size æ˜¯ App ä½¿ç”¨çš„é©»ç•™å†…å­˜å¤§å°ï¼Œvirtual_size æ˜¯ App ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜å¤§å°ã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºä¸ºå†…å­˜ä½¿ç”¨æƒ…å†µçš„ä»£ç å®ç°ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ app å†…å­˜ä½¿ç”¨é‡</span></span><br><span class="line">+ (NSInteger)useMemoryForApp &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mach_task_basic_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count = MACH_TASK_BASIC_INFO_COUNT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">kern_return_t</span> kr = task_info(mach_task_self(), MACH_TASK_BASIC_INFO, (<span class="keyword">task_info_t</span>) &amp;info, &amp;count);</span><br><span class="line"><span class="keyword">if</span> (kr == KERN_SUCCESS) &#123;</span><br><span class="line"><span class="keyword">return</span> info.resident_size;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œæˆ‘ç”¨ é€šè¿‡æ­¤æ–¹æ³•è·å–åˆ°çš„å†…å­˜ä¿¡æ¯ä¸ Instruments ä¸­çš„ Activity Monitor é‡‡é›†åˆ°çš„å†…å­˜ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°å‰è€…è¦å¤šå‡ºå°†è¿‘ 100MBã€‚ç»è¿‡è°ƒç ”å‘ç°ï¼Œè‹¹æœä½¿ç”¨äº†ä¸Šè¿°çš„ Compressed Memoryï¼Œæˆ‘çŒœæµ‹ï¼šresident_size å¯èƒ½æ˜¯å°† Compressed Memory è§£å‹åæ‰€ç»Ÿè®¡åˆ°çš„ä¸€ä¸ªæ•°å€¼ã€‚<strong>çœŸå®çš„ç‰©ç†å†…å­˜çš„å€¼åº”è¯¥æ˜¯ task_vm_info ç»“æ„ä½“ä¸­çš„ pyhs_footprint æˆå‘˜çš„å€¼ã€‚</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_VM_INFO            22</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_VM_INFO_PURGEABLE  23</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_vm_info</span> &#123;</span></span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  virtual_size;       <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line"><span class="keyword">integer_t</span>       region_count;       <span class="comment">/* number of memory regions */</span></span><br><span class="line"><span class="keyword">integer_t</span>       page_size;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  resident_size;      <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  resident_size_peak; <span class="comment">/* peak resident size (bytes) */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  device;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  device_peak;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  internal;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  internal_peak;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  external;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  external_peak;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  reusable;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  reusable_peak;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  purgeable_volatile_pmap;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  purgeable_volatile_resident;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  purgeable_volatile_virtual;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  compressed;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  compressed_peak;</span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  compressed_lifetime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* added for rev1 */</span></span><br><span class="line"><span class="keyword">mach_vm_size_t</span>  phys_footprint;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* added for rev2 */</span></span><br><span class="line"><span class="keyword">mach_vm_address_t</span>       min_address;</span><br><span class="line"><span class="keyword">mach_vm_address_t</span>       max_address;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œæ­£ç¡®çš„å†…å­˜ä½¿ç”¨æƒ…å†µçš„ä»£ç å®ç°åº”è¯¥å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ app å†…å­˜ä½¿ç”¨é‡</span></span><br><span class="line">+ (NSInteger)useMemoryForApp &#123;</span><br><span class="line">    <span class="keyword">task_vm_info_data_t</span> vmInfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count = TASK_VM_INFO_COUNT;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kernelReturn = task_info(mach_task_self(), TASK_VM_INFO, (<span class="keyword">task_info_t</span>) &amp;vmInfo, &amp;count);</span><br><span class="line">    <span class="keyword">if</span> (kernelReturn == KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> memoryUsageInByte = (<span class="keyword">int64_t</span>) vmInfo.phys_footprint;</span><br><span class="line">        <span class="keyword">return</span> memoryUsageInByte / <span class="number">1024</span> / <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°"><a href="#è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°" class="headerlink" title="è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°"></a>è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NSProcessInfo processInfo].physicalMemory</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡ä½¿ç”¨çš„å†…å­˜"><a href="#è®¾å¤‡ä½¿ç”¨çš„å†…å­˜" class="headerlink" title="è®¾å¤‡ä½¿ç”¨çš„å†…å­˜"></a>è®¾å¤‡ä½¿ç”¨çš„å†…å­˜</h3><p>è·å–å½“å‰è®¾å¤‡çš„ Memory ä½¿ç”¨æƒ…å†µ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">int64_t getUsedMemory()</span><br><span class="line">&#123;</span><br><span class="line">    size_t length = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mib[<span class="number">6</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> pagesize = <span class="number">0</span>;</span><br><span class="line">    mib[<span class="number">0</span>] = <span class="built_in">CTL_HW</span>;</span><br><span class="line">    mib[<span class="number">1</span>] = HW_PAGESIZE;</span><br><span class="line">    length = <span class="keyword">sizeof</span>(pagesize);</span><br><span class="line">    <span class="keyword">if</span> (sysctl(mib, <span class="number">2</span>, &amp;pagesize, &amp;length, <span class="literal">NULL</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mach_msg_type_number_t count = HOST_VM_INFO_COUNT;</span><br><span class="line">    </span><br><span class="line">    vm_statistics_data_t vmstat;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (host_statistics(mach_host_self(), HOST_VM_INFO, (host_info_t)&amp;vmstat, &amp;count) != KERN_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> wireMem = vmstat.wire_count * pagesize;</span><br><span class="line">    <span class="keyword">int</span> activeMem = vmstat.active_count * pagesize;</span><br><span class="line">    <span class="keyword">return</span> wireMem + activeMem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡å¯ç”¨çš„å†…å­˜"><a href="#è®¾å¤‡å¯ç”¨çš„å†…å­˜" class="headerlink" title="è®¾å¤‡å¯ç”¨çš„å†…å­˜"></a>è®¾å¤‡å¯ç”¨çš„å†…å­˜</h3><p>è·å–å½“å‰è®¾å¤‡å¯ç”¨çš„ Memory</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">uint64_t</span>)availableMemory &#123;</span><br><span class="line">    <span class="keyword">vm_statistics64_data_t</span> vmStats;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> infoCount = HOST_VM_INFO_COUNT;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kernReturn = host_statistics(mach_host_self(),</span><br><span class="line">                                               HOST_VM_INFO,</span><br><span class="line">                                               (<span class="keyword">host_info_t</span>)&amp;vmStats,</span><br><span class="line">                                               &amp;infoCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (kernReturn != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> NSNotFound;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> vm_page_size * (vmStats.free_count + vmStats.inactive_count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»è€…å¯èƒ½ä¼šçœ‹åˆ°æœ‰äº›ä»£ç ä¼šä½¿ç”¨ vm_statistics_data_t ç»“æ„ä½“ï¼Œä½†æ˜¯è¿™ä¸ªç»“æ„ä½“æ˜¯32ä½æœºå™¨çš„ï¼Œéšç€ Apple é€æ¸æ”¾å¼ƒå¯¹32ä½åº”ç”¨çš„æ”¯æŒï¼Œæ‰€ä»¥å»ºè®®è¯»è€…è¿˜æ˜¯ä½¿ç”¨ vm_statistics64_data_t 64ä½çš„ç»“æ„ä½“ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Memory&quot;&gt;&lt;a href=&quot;#Memory&quot; class=&quot;headerlink&quot; title=&quot;Memory&quot;&gt;&lt;/a&gt;Memory&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬å¯ä»¥è”æƒ³ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µæ˜¯å¦ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼CPUçš„æ–¹å¼è·å–åˆ°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚&lt;/p&gt;
&lt;h3 id=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;a href=&quot;#ç›¸å…³ç³»ç»ŸåŸç†&quot; class=&quot;headerlink&quot; title=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;/a&gt;ç›¸å…³ç³»ç»ŸåŸç†&lt;/h3&gt;&lt;p&gt;å†…å­˜æ˜¯æœ‰é™ä¸”ç³»ç»Ÿå…±äº«çš„èµ„æºï¼Œä¸€ä¸ªç¨‹åºå ç”¨è¶Šå¤šï¼Œç³»ç»Ÿå’Œå…¶ä»–ç¨‹åºæ‰€èƒ½ç”¨çš„å°±è¶Šå°‘ã€‚ç¨‹åºå¯åŠ¨å‰éƒ½éœ€è¦å…ˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„æ•°æ®æ“ä½œä¹Ÿä¼šå ç”¨ä¸€å®šçš„å†…å­˜èµ„æºã€‚å‡å°‘å†…å­˜å ç”¨ä¹Ÿèƒ½åŒæ—¶å‡å°‘å…¶å¯¹ CPU æ—¶é—´ç»´åº¦ä¸Šçš„æ¶ˆè€—ï¼Œä»è€Œä½¿ä¸ä»…ä½¿ App ä»¥åŠæ•´ä¸ªç³»ç»Ÿä¹Ÿéƒ½èƒ½è¡¨ç°çš„æ›´å¥½ã€‚&lt;/p&gt;
&lt;p&gt;MacOS å’Œ iOS éƒ½é‡‡ç”¨äº†è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ¥çªç ´ç‰©ç†å†…å­˜çš„å¤§å°é™åˆ¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€æ®µç”±å¤šä¸ªå¤§å°ç›¸åŒçš„é¡µï¼ˆPageï¼‰æ‰€æ„æˆçš„é€»è¾‘åœ°å€ç©ºé—´ã€‚å¤„ç†å™¨å’Œå†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼ŒMemory Management Unitï¼‰ç»´æŠ¤ç€ç”±é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„ é¡µé¢æ˜ å°„è¡¨ï¼ˆç®€ç§° é¡µè¡¨ï¼‰ï¼Œå½“ç¨‹åºè®¿é—®é€»è¾‘å†…å­˜åœ°å€æ—¶ï¼Œç”± MMU æ ¹æ®é¡µè¡¨å°†é€»è¾‘åœ°å€è½¬æ¢ä¸ºçœŸå®çš„ç‰©ç†åœ°å€ã€‚åœ¨æ—©æœŸçš„è‹¹æœè®¾å¤‡ä¸­ï¼Œæ¯ä¸ªé¡µçš„å¤§å°ä¸º 4KBï¼›åŸºäº A7 å’Œ A8 å¤„ç†å™¨çš„ç³»ç»Ÿä¸º 64 ä½ç¨‹åºæä¾›äº† 16KB çš„è™šæ‹Ÿå†…å­˜åˆ†é¡µå’Œ 4KB çš„ç‰©ç†å†…å­˜åˆ†é¡µï¼›åœ¨ A9 ä¹‹åï¼Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„åˆ†é¡µå¤§å°éƒ½è¾¾åˆ°äº† 16KBã€‚&lt;/p&gt;
&lt;p&gt;è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼ˆVirtual Pageï¼ŒVPï¼‰æœ‰ä¸¤ç§ç±»å‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Cleanï¼šæŒ‡èƒ½å¤Ÿè¢«ç³»ç»Ÿæ¸…ç†å‡ºå†…å­˜ä¸”åœ¨éœ€è¦æ—¶èƒ½é‡æ–°åŠ è½½çš„æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š&lt;ul&gt;
&lt;li&gt;å†…å­˜æ˜ å°„æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;Frameworks ä¸­çš„ __DATA_CONST éƒ¨åˆ†&lt;/li&gt;
&lt;li&gt;åº”ç”¨çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Dirtyï¼šæŒ‡ä¸èƒ½è¢«ç³»ç»Ÿå›æ”¶çš„å†…å­˜å ç”¨ï¼ŒåŒ…æ‹¬ï¼š&lt;ul&gt;
&lt;li&gt;æ‰€æœ‰å †ä¸Šçš„å¯¹è±¡&lt;/li&gt;
&lt;li&gt;å›¾ç‰‡è§£ç ç¼“å†²æ•°æ®&lt;/li&gt;
&lt;li&gt;Framework ä¸­çš„ DATA å’Œ DATA_DIRTY éƒ¨åˆ†&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="APM" scheme="https://developerdoc.com/categories/APM/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§1 Cpu å’Œ Memoryä¿¡æ¯</title>
    <link href="https://developerdoc.com/essay/APM/iOSAPM1/"/>
    <id>https://developerdoc.com/essay/APM/iOSAPM1/</id>
    <published>2020-10-09T01:30:44.000Z</published>
    <updated>2020-10-13T11:37:05.309Z</updated>
    
    <content type="html"><![CDATA[<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>CPU å ç”¨ç‡çš„é‡‡é›†åŸç†å…¶å®å¾ˆç®€å•ï¼šApp ä½œä¸ºè¿›ç¨‹è¿è¡Œæ—¶ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨ç‡ä¸åŒã€‚å„ä¸ªçº¿ç¨‹å¯¹ CPU ä½¿ç”¨ç‡çš„æ€»å’Œï¼Œå°±æ˜¯å½“å‰ App å¯¹ CPU çš„å ç”¨ç‡ã€‚</p><p>wikiä¸Šæ¯”è¾ƒå…¨çš„iPhone CPUä¿¡æ¯ : <a href="https://en.wikipedia.org/wiki/Apple-designed_processors" target="_blank" rel="noopener">Apple-designed_processors</a>)</p><h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p>iOS æ˜¯åŸºäº Apple Darwin å†…æ ¸ï¼Œç”± kernelã€XNU å’Œ Runtime ç»„æˆï¼ŒXNUï¼ˆX is not UNIXï¼‰ æ˜¯ Darwin çš„å†…æ ¸ï¼Œä¸€ä¸ªæ··åˆå†…æ ¸ï¼Œç”± Mach å¾®å†…æ ¸å’Œ BSD ç»„æˆã€‚Mach å†…æ ¸æ˜¯è½»é‡çº§çš„å¹³å°ï¼Œåªèƒ½å®Œæˆæ“ä½œç³»ç»Ÿæœ€åŸºæœ¬çš„èŒè´£ï¼Œå¦‚ï¼šè¿›ç¨‹å’Œçº¿ç¨‹ã€è™šæ‹Ÿå†…å­˜ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€è¿›ç¨‹é€šä¿¡å’Œæ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚å…¶ä»–çš„å·¥ä½œï¼Œå¦‚æ–‡ä»¶æ“ä½œå’Œè®¾å¤‡è®¿é—®ï¼Œéƒ½æ˜¯ç”± BSD å±‚å®ç°ã€‚</p><p>äº‹å®ä¸Šï¼ŒMach å¹¶ä¸èƒ½è¯†åˆ« UNIX ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§ç¨å¾®ä¸åŒçš„æ–¹å¼ï¼Œä½¿ç”¨äº†æ¯”è¿›ç¨‹æ›´è½»é‡çº§çš„æ¦‚å¿µï¼šä»»åŠ¡ï¼ˆTaskï¼‰ã€‚ç»å…¸çš„ UNIX é‡‡ç”¨äº†è‡ªä¸Šè€Œä¸‹çš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å¯¹è±¡æ˜¯è¿›ç¨‹ï¼Œç„¶åè¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼›Mach åˆ™é‡‡ç”¨äº†è‡ªåº•å‘ä¸Šçš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åŒ…å«åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­ã€‚</p><ul><li>çº¿ç¨‹<ul><li>çº¿ç¨‹å®šä¹‰äº† Mach ä¸­æœ€å°çš„æ‰§è¡Œå•å…ƒã€‚çº¿ç¨‹è¡¨ç¤ºçš„æ˜¯åº•å±‚çš„æœºå™¨å¯„å­˜å™¨çŠ¶æ€ä»¥åŠå„ç§è°ƒåº¦ç»Ÿè®¡æ•°æ®ï¼Œå…¶ä»è®¾è®¡ä¸Šæä¾›äº†è°ƒåº¦æ‰€éœ€è¦çš„å¤§é‡ä¿¡æ¯ã€‚</li></ul></li><li>ä»»åŠ¡<ul><li>ä»»åŠ¡æ˜¯ä¸€ç§å®¹å™¨å¯¹è±¡ï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´å’Œå…¶ä»–èµ„æºéƒ½æ˜¯é€šè¿‡è¿™ä¸ªå®¹å™¨å¯¹è±¡ç®¡ç†çš„ã€‚è¿™äº›èµ„æºåŒ…æ‹¬è®¾å¤‡å’Œå…¶ä»–å¥æŸ„ã€‚èµ„æºè¿›ä¸€æ­¥è¢«æŠ½è±¡ä¸ºç«¯å£ã€‚å› æ­¤ï¼Œèµ„æºçš„å…±äº«å®é™…ä¸Šç›¸å½“äºå…è®¸å¯¹å¯¹åº”ç«¯å£è¿›è¡Œè®¿é—®ã€‚</li></ul></li></ul><a id="more"></a><p>ä¸¥æ ¼æ¥è¯´ï¼ŒMach çš„ä»»åŠ¡å¹¶ä¸æ˜¯hiæ“ä½œç³»ç»Ÿä¸­æ‰€è°“çš„è¿›ç¨‹ï¼Œå› ä¸º Mach ä½œä¸ºä¸€ä¸ªå¾®å†…æ ¸çš„æ“ä½œç³»ç»Ÿï¼Œå¹¶æ²¡æœ‰æä¾›â€œè¿›ç¨‹â€çš„é€»è¾‘ï¼Œè€Œåªæä¾›äº†æœ€åŸºæœ¬çš„å®ç°ã€‚åœ¨ BSD æ¨¡å‹ä¸­ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæœ‰ä¸€å¯¹ä¸€çš„ç®€å•æ˜ å°„ï¼Œæ¯ä¸ª BSD è¿›ç¨‹ï¼ˆå³ OS X è¿›ç¨‹ï¼‰éƒ½åœ¨åº•å±‚å…³è”äº†ä¸€ä¸ª Mach ä»»åŠ¡å¯¹è±¡ã€‚å®ç°è¿™ç§æ˜ å°„çš„æ–¹æ³•æ˜¯æŒ‡å®šä¸€ä¸ªé€æ˜çš„æŒ‡é’ˆ bsd_infoï¼ŒMach å¯¹ bsd_info å®Œå…¨æ— çŸ¥ã€‚Mach å°†å†…æ ¸ä¹Ÿç”¨ä»»åŠ¡è¡¨ç¤ºï¼ˆå…¨å±€èŒƒå›´ç§°ä¸º kernel_taskï¼‰ï¼Œå°½ç®¡è¯¥ä»»åŠ¡æ²¡æœ‰å¯¹åº”çš„ PIDï¼Œä½†å¯ä»¥æƒ³è±¡ PID ä¸º 0ã€‚</p><p>ä¸‹å›¾æ‰€ç¤ºä¸ºæƒå¨è‘—ä½œã€ŠOS X Internal: A System Approachã€‹ä¸­æä¾›çš„ Mach OS X ä¸­è¿›ç¨‹å­ç³»ç»Ÿç»„æˆçš„æ¦‚å¿µå›¾ã€‚ä¸ Mac OS X ç±»ä¼¼ï¼ŒiOS çš„çº¿ç¨‹æŠ€æœ¯ä¹Ÿæ˜¯åŸºäº Mach çº¿ç¨‹æŠ€æœ¯å®ç°çš„ã€‚</p><p><img src="/res/apm/mach-task-thread-system.png" alt></p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ä¸Šè¿°æåˆ°çº¿ç¨‹è¡¨ç¤ºçš„æ˜¯åº•å±‚çš„æœºå™¨å¯„å­˜å™¨çŠ¶æ€ä»¥åŠå„ç§ç»™è°ƒåº¦ç»Ÿè®¡æ•°æ®ã€‚å†æ¥çœ‹ Mach å±‚ä¸­çš„ thread_basic_info ç»“æ„ä½“çš„å®šä¹‰ï¼Œå…¶æˆå‘˜ä¿¡æ¯ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ã€‚<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;      <span class="comment">// ç”¨æˆ·è¿è¡Œæ—¶é•¿</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;    <span class="comment">// ç³»ç»Ÿè¿è¡Œæ—¶é•¿</span></span><br><span class="line">        <span class="keyword">integer_t</span>       cpu_usage;      <span class="comment">// CPU ä½¿ç”¨ç‡</span></span><br><span class="line">        <span class="keyword">policy_t</span>        policy;         <span class="comment">// è°ƒåº¦ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">integer_t</span>       run_state;      <span class="comment">// è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">integer_t</span>       flags;          <span class="comment">// å„ç§æ ‡è®°</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;  <span class="comment">// æš‚åœçº¿ç¨‹çš„è®¡æ•°</span></span><br><span class="line">        <span class="keyword">integer_t</span>       sleep_time;     <span class="comment">// ä¼‘çœ æ—¶é—´</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è¿™ä¸ªç»“æ„ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®šæ—¶å»éå†æ¯ä¸ªçº¿ç¨‹ï¼Œç´¯åŠ æ¯ä¸ªçº¿ç¨‹çš„ cpu_usage å­—æ®µçš„å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°å½“å‰ App æ‰€åœ¨è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºä¸º CPU å ç”¨ç‡ çš„ä»£ç å®ç°ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– CPU ä½¿ç”¨ç‡</span></span><br><span class="line">+ (CGFloat)appCpuUsage &#123;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr;</span><br><span class="line">    <span class="keyword">task_info_data_t</span> tinfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> task_info_count;</span><br><span class="line">    </span><br><span class="line">    task_info_count = TASK_INFO_MAX;</span><br><span class="line">    kr = task_info(mach_task_self(), MACH_TASK_BASIC_INFO, (<span class="keyword">task_info_t</span>)tinfo, &amp;task_info_count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_array_t</span>         thread_list;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> thread_count;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_info_data_t</span>     thinfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> thread_info_count;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_basic_info_t</span> basic_info_th;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get threads in the task</span></span><br><span class="line">    kr = task_threads(mach_task_self(), &amp;thread_list, &amp;thread_count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> total_time     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> total_userTime = <span class="number">0</span>;</span><br><span class="line">    CGFloat total_cpu   = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for each thread</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; (<span class="keyword">int</span>)thread_count; j++) &#123;</span><br><span class="line">        thread_info_count = THREAD_INFO_MAX;</span><br><span class="line">        kr = thread_info(thread_list[j], THREAD_BASIC_INFO,</span><br><span class="line">                         (<span class="keyword">thread_info_t</span>)thinfo, &amp;thread_info_count);</span><br><span class="line">        <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        basic_info_th = (<span class="keyword">thread_basic_info_t</span>)thinfo;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!(basic_info_th-&gt;flags &amp; TH_FLAGS_IDLE)) &#123;</span><br><span class="line">            total_time     = total_time + basic_info_th-&gt;user_time.seconds + basic_info_th-&gt;system_time.seconds;</span><br><span class="line">            total_userTime = total_userTime + basic_info_th-&gt;user_time.microseconds + basic_info_th-&gt;system_time.microseconds;</span><br><span class="line">            total_cpu      = total_cpu + basic_info_th-&gt;cpu_usage / (<span class="keyword">float</span>)TH_USAGE_SCALE * kMaxPercent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kr = vm_deallocate(mach_task_self(), (<span class="keyword">vm_offset_t</span>)thread_list, thread_count * <span class="keyword">sizeof</span>(<span class="keyword">thread_t</span>));</span><br><span class="line">    assert(kr == KERN_SUCCESS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> total_cpu;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»£ç ä¸­ä½¿ç”¨ task_threads API è°ƒç”¨è·å–æŒ‡å®šçš„ task çš„çº¿ç¨‹åˆ—è¡¨ã€‚task_threads å°† target_task ä»»åŠ¡ä¸­çš„æ‰€æœ‰çº¿ç¨‹ä¿å­˜åœ¨ act_list æ•°ç»„ä¸­ï¼Œæ•°ç»„åŒ…å« act_listCnt ä¸ªæ¡ç›®ã€‚ä¸Šè¿°æºç ä¸­ï¼Œåœ¨è°ƒç”¨ task_threads API æ—¶ï¼Œtarget_task å‚æ•°ä¼ å…¥çš„æ˜¯ mach_task_self()ï¼Œè¡¨ç¤ºè·å–å½“å‰çš„ Mach taskã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span> task_threads</span><br><span class="line">(</span><br><span class="line"><span class="keyword">task_t</span> target_task,</span><br><span class="line"><span class="keyword">thread_act_array_t</span> *act_list,</span><br><span class="line"><span class="keyword">mach_msg_type_number_t</span> *act_listCnt</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>åœ¨è·å–åˆ°çº¿ç¨‹åˆ—è¡¨åï¼Œä»£ç ä¸­ä½¿ç”¨ thread_info API è°ƒç”¨è·å–æŒ‡å®šçº¿ç¨‹çš„çº¿ç¨‹ä¿¡æ¯ã€‚thread_info æŸ¥è¯¢ flavor æŒ‡å®šçš„çº¿ç¨‹ä¿¡æ¯ï¼Œå°†ä¿¡æ¯è¿”å›åˆ°é•¿åº¦ä¸º thread_info_outCnt å­—èŠ‚çš„ thread_info_out ç¼“å­˜åŒºä¸­ã€‚ä¸Šè¿°æºç ï¼Œåœ¨è°ƒç”¨ thread_info API æ—¶ï¼Œflavor å‚æ•°ä¼ å…¥çš„æ˜¯ THREAD_BASIC_INFOï¼Œä½¿ç”¨è¿™ä¸ªç±»å‹ä¼šè¿”å›çº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼Œå³ thread_basic_info_t ç»“æ„ä½“ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span> thread_info</span><br><span class="line">(</span><br><span class="line"><span class="keyword">thread_act_t</span> target_act,</span><br><span class="line"><span class="keyword">thread_flavor_t</span> flavor,</span><br><span class="line"><span class="keyword">thread_info_t</span> thread_info_out,</span><br><span class="line"><span class="keyword">mach_msg_type_number_t</span> *thread_info_outCnt</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æºç çš„æœ€åï¼Œä½¿ç”¨ vm_deallocate API ä»¥é˜²æ­¢å‡ºç°å†…å­˜æ³„éœ²ã€‚</p><h3 id="æ€»çš„-CPU-å ç”¨ç‡"><a href="#æ€»çš„-CPU-å ç”¨ç‡" class="headerlink" title="æ€»çš„ CPU å ç”¨ç‡"></a>æ€»çš„ CPU å ç”¨ç‡</h3><p>ä½¿ç”¨ <code>host_statistics</code> å‡½æ•°æ‹¿åˆ° host_cpu_load_info çš„å€¼ï¼Œè¿™ä¸ªç»“æ„ä½“çš„æˆå‘˜å˜é‡ cpu_ticks åŒ…å«äº† CPU è¿è¡Œçš„æ—¶é’Ÿè„‰å†²çš„æ•°é‡ï¼Œcpu_ticks æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢åˆ†åˆ«åŒ…å«äº† CPU_STATE_USER, CPU_STATE_SYSTEM, CPU_STATE_IDLE å’Œ CPU_STATE_NICE æ¨¡å¼ä¸‹çš„æ—¶é’Ÿè„‰å†²ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+ (CGFloat)cpuUsage &#123;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">host_cpu_load_info_data_t</span> previous_info = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">host_cpu_load_info_data_t</span> info;</span><br><span class="line">    </span><br><span class="line">    count = HOST_CPU_LOAD_INFO_COUNT;</span><br><span class="line">    </span><br><span class="line">    kr = host_statistics(mach_host_self(), HOST_CPU_LOAD_INFO, (<span class="keyword">host_info_t</span>)&amp;info, &amp;count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">natural_t</span> user   = info.cpu_ticks[CPU_STATE_USER] - previous_info.cpu_ticks[CPU_STATE_USER];</span><br><span class="line">    <span class="keyword">natural_t</span> nice   = info.cpu_ticks[CPU_STATE_NICE] - previous_info.cpu_ticks[CPU_STATE_NICE];</span><br><span class="line">    <span class="keyword">natural_t</span> system = info.cpu_ticks[CPU_STATE_SYSTEM] - previous_info.cpu_ticks[CPU_STATE_SYSTEM];</span><br><span class="line">    <span class="keyword">natural_t</span> idle   = info.cpu_ticks[CPU_STATE_IDLE] - previous_info.cpu_ticks[CPU_STATE_IDLE];</span><br><span class="line">    <span class="keyword">natural_t</span> total  = user + nice + system + idle;</span><br><span class="line">    previous_info    = info;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (user + nice + system) * <span class="number">100.0</span> / total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é€šè¿‡è®¡ç®— info å’Œ previous_info çš„å·®å€¼ï¼Œåˆ†åˆ«å¾—åˆ°åœ¨è¿™å‡ ä¸ªæ¨¡å¼ä¸‹çš„ cpu_ticksï¼Œé™¤ idle ä»¥å¤–éƒ½å±äº CPU è¢«å ç”¨çš„æƒ…å†µï¼Œæœ€åå°±èƒ½æ±‚å‡º CPU çš„å ç”¨ç‡ã€‚</p><h3 id="CPU-æ ¸æ•°"><a href="#CPU-æ ¸æ•°" class="headerlink" title="CPU æ ¸æ•°"></a>CPU æ ¸æ•°</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (NSUInteger)cpuNumber &#123;</span><br><span class="line">    <span class="keyword">return</span> [NSProcessInfo processInfo].activeProcessorCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CPU-é¢‘ç‡"><a href="#CPU-é¢‘ç‡" class="headerlink" title="CPU é¢‘ç‡"></a>CPU é¢‘ç‡</h3><p>CPU é¢‘ç‡ï¼Œå°±æ˜¯ CPU çš„æ—¶é’Ÿé¢‘ç‡ï¼Œ æ˜¯ CPU è¿ç®—æ—¶çš„å·¥ä½œçš„é¢‘ç‡ï¼ˆ1ç§’å†…å‘ç”Ÿçš„åŒæ­¥è„‰å†²æ•°ï¼‰çš„ç®€ç§°ã€‚å•ä½æ˜¯ Hzï¼Œå®ƒå†³å®šç§»åŠ¨è®¾å¤‡çš„è¿è¡Œé€Ÿåº¦ã€‚</p><p>ç”±äºå®‰å…¨æ€§è€ƒè™‘ï¼Œè‹¹æœå·²ç»ç¦æ­¢è®¿é—®å†…æ ¸å˜é‡æ¥è·å– CPU é¢‘ç‡ã€‚ç°å®ç°æ–¹æ³•æ˜¯é€šè¿‡ç¡¬ç¼–ç æ–¹å¼è·å– CPU é¢‘ç‡ï¼Œæ–°æœºå‘å¸ƒéœ€æ›´æ–°ã€‚</p><p>æˆ‘ä»¬é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼ï¼Œå»ºç«‹ä¸€å¼ æœºå‹å’Œ CPU ä¸»é¢‘çš„æ˜ å°„è¡¨ï¼Œç„¶åæ ¹æ®æœºå‹æ‰¾åˆ°å¯¹åº”çš„ CPU ä¸»é¢‘å³å¯ã€‚</p><p>å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°å¯¹åº”æœºå‹cpuçš„å¯¹åº” : <a href="https://en.wikipedia.org/wiki/Apple-designed_processors" target="_blank" rel="noopener">Apple-designed_processors</a></p><h3 id="CPU-ç±»å‹"><a href="#CPU-ç±»å‹" class="headerlink" title="CPU ç±»å‹"></a>CPU ç±»å‹</h3><p>æˆ‘ä»¬çŸ¥é“ iPhone ä½¿ç”¨çš„å¤„ç†å™¨æ¶æ„éƒ½æ˜¯ ARM çš„ï¼Œè€Œ ARM åˆåˆ†ä¸º ARMV7ã€ARMV7S å’Œ ARM64ç­‰ã€‚è€Œæƒ³è¦è·å–è®¾å¤‡å…·ä½“çš„å¤„ç†å™¨æ¶æ„åˆ™éœ€è¦ä½¿ç”¨ NXGetLocalArchInfo() å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ NXArchInfo ç»“æ„ä½“ç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">cpu_type_t</span> cputype;</span><br><span class="line">    <span class="keyword">cpu_subtype_t</span> cpusubtype;</span><br><span class="line">    <span class="keyword">enum</span> NXByteOrder byteorder;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *description;</span><br><span class="line">&#125; NXArchInfo;</span><br></pre></td></tr></table></figure><p>NXArchInfo ç»“æ„ä½“æˆå‘˜å˜é‡ä¸­å°±åŒ…å«æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼šcputype å’Œ cpusubtypeï¼Œè¿™ä¸¤ä¸ªå˜é‡ç±»å‹çš„å®šä¹‰åœ¨ mach/machine.h å¤´æ–‡ä»¶ä¸­ç»™å‡ºï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ int ç±»å‹ typedef å¾—åˆ°çš„ã€‚</p><p>æ ¹æ® mach/machine.h å¤´æ–‡ä»¶ç»™å‡ºçš„ CPU æ¶æ„ç±»å‹çš„å®šä¹‰ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å»ºç«‹èµ·å„ CPU æ¶æ„åˆ°å…¶å¯¹åº”æè¿°çš„æ˜ å°„å…³ç³»ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">+ (NSInteger)cpuType &#123;</span><br><span class="line">    <span class="keyword">return</span> (NSInteger)NXGetLocalArchInfo()-&gt;cputype;</span><br><span class="line">&#125;</span><br><span class="line">+ (NSInteger)cpuSubtype &#123;</span><br><span class="line">    <span class="keyword">return</span> (NSInteger)NXGetLocalArchInfo()-&gt;cpusubtype;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)p_stringFromCpuType:(NSInteger)cpuType &#123;</span><br><span class="line">    <span class="keyword">switch</span> (cpuType) &#123;</span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_VAX:          <span class="keyword">return</span> @<span class="string">"VAX"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC680x0:      <span class="keyword">return</span> @<span class="string">"MC680x0"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_X86:          <span class="keyword">return</span> @<span class="string">"X86"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_X86_64:       <span class="keyword">return</span> @<span class="string">"X86_64"</span>;       </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC98000:      <span class="keyword">return</span> @<span class="string">"MC98000"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_HPPA:         <span class="keyword">return</span> @<span class="string">"HPPA"</span>;         </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_ARM:          <span class="keyword">return</span> @<span class="string">"ARM"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_ARM64:        <span class="keyword">return</span> @<span class="string">"ARM64"</span>;        </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC88000:      <span class="keyword">return</span> @<span class="string">"MC88000"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_SPARC:        <span class="keyword">return</span> @<span class="string">"SPARC"</span>;        </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_I860:         <span class="keyword">return</span> @<span class="string">"I860"</span>;         </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_POWERPC:      <span class="keyword">return</span> @<span class="string">"POWERPC"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_POWERPC64:    <span class="keyword">return</span> @<span class="string">"POWERPC64"</span>;    </span><br><span class="line">        <span class="keyword">default</span>:                    <span class="keyword">return</span> @<span class="string">"Unknown"</span>;      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)cpuTypeString &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_cpuTypeString) &#123;</span><br><span class="line">        _cpuTypeString = [self p_stringFromCpuType:[[self class] cpuType]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _cpuTypeString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)cpuSubtypeString &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_cpuSubtypeString) &#123;</span><br><span class="line">        _cpuSubtypeString = [NSString stringWithUTF8String:NXGetLocalArchInfo()-&gt;description];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _cpuSubtypeString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç»æµ‹è¯•å‘ç° NXArchInfo ç»“æ„ä½“æˆå‘˜å˜é‡ description åŒ…å«çš„å°±æ˜¯ CPU æ¶æ„çš„è¯¦å°½ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å®ƒä½œä¸º cpuSubtypeStringï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å»ºç«‹ cpuSubtype çš„æ˜ å°„å…³ç³»ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;CPU&quot;&gt;&lt;a href=&quot;#CPU&quot; class=&quot;headerlink&quot; title=&quot;CPU&quot;&gt;&lt;/a&gt;CPU&lt;/h3&gt;&lt;p&gt;CPU å ç”¨ç‡çš„é‡‡é›†åŸç†å…¶å®å¾ˆç®€å•ï¼šApp ä½œä¸ºè¿›ç¨‹è¿è¡Œæ—¶ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨ç‡ä¸åŒã€‚å„ä¸ªçº¿ç¨‹å¯¹ CPU ä½¿ç”¨ç‡çš„æ€»å’Œï¼Œå°±æ˜¯å½“å‰ App å¯¹ CPU çš„å ç”¨ç‡ã€‚&lt;/p&gt;
&lt;p&gt;wikiä¸Šæ¯”è¾ƒå…¨çš„iPhone CPUä¿¡æ¯ : &lt;a href=&quot;https://en.wikipedia.org/wiki/Apple-designed_processors&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Apple-designed_processors&lt;/a&gt;)&lt;/p&gt;
&lt;h3 id=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;a href=&quot;#ç›¸å…³ç³»ç»ŸåŸç†&quot; class=&quot;headerlink&quot; title=&quot;ç›¸å…³ç³»ç»ŸåŸç†&quot;&gt;&lt;/a&gt;ç›¸å…³ç³»ç»ŸåŸç†&lt;/h3&gt;&lt;p&gt;iOS æ˜¯åŸºäº Apple Darwin å†…æ ¸ï¼Œç”± kernelã€XNU å’Œ Runtime ç»„æˆï¼ŒXNUï¼ˆX is not UNIXï¼‰ æ˜¯ Darwin çš„å†…æ ¸ï¼Œä¸€ä¸ªæ··åˆå†…æ ¸ï¼Œç”± Mach å¾®å†…æ ¸å’Œ BSD ç»„æˆã€‚Mach å†…æ ¸æ˜¯è½»é‡çº§çš„å¹³å°ï¼Œåªèƒ½å®Œæˆæ“ä½œç³»ç»Ÿæœ€åŸºæœ¬çš„èŒè´£ï¼Œå¦‚ï¼šè¿›ç¨‹å’Œçº¿ç¨‹ã€è™šæ‹Ÿå†…å­˜ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€è¿›ç¨‹é€šä¿¡å’Œæ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚å…¶ä»–çš„å·¥ä½œï¼Œå¦‚æ–‡ä»¶æ“ä½œå’Œè®¾å¤‡è®¿é—®ï¼Œéƒ½æ˜¯ç”± BSD å±‚å®ç°ã€‚&lt;/p&gt;
&lt;p&gt;äº‹å®ä¸Šï¼ŒMach å¹¶ä¸èƒ½è¯†åˆ« UNIX ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§ç¨å¾®ä¸åŒçš„æ–¹å¼ï¼Œä½¿ç”¨äº†æ¯”è¿›ç¨‹æ›´è½»é‡çº§çš„æ¦‚å¿µï¼šä»»åŠ¡ï¼ˆTaskï¼‰ã€‚ç»å…¸çš„ UNIX é‡‡ç”¨äº†è‡ªä¸Šè€Œä¸‹çš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å¯¹è±¡æ˜¯è¿›ç¨‹ï¼Œç„¶åè¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼›Mach åˆ™é‡‡ç”¨äº†è‡ªåº•å‘ä¸Šçš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åŒ…å«åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;çº¿ç¨‹&lt;ul&gt;
&lt;li&gt;çº¿ç¨‹å®šä¹‰äº† Mach ä¸­æœ€å°çš„æ‰§è¡Œå•å…ƒã€‚çº¿ç¨‹è¡¨ç¤ºçš„æ˜¯åº•å±‚çš„æœºå™¨å¯„å­˜å™¨çŠ¶æ€ä»¥åŠå„ç§è°ƒåº¦ç»Ÿè®¡æ•°æ®ï¼Œå…¶ä»è®¾è®¡ä¸Šæä¾›äº†è°ƒåº¦æ‰€éœ€è¦çš„å¤§é‡ä¿¡æ¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ä»»åŠ¡&lt;ul&gt;
&lt;li&gt;ä»»åŠ¡æ˜¯ä¸€ç§å®¹å™¨å¯¹è±¡ï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´å’Œå…¶ä»–èµ„æºéƒ½æ˜¯é€šè¿‡è¿™ä¸ªå®¹å™¨å¯¹è±¡ç®¡ç†çš„ã€‚è¿™äº›èµ„æºåŒ…æ‹¬è®¾å¤‡å’Œå…¶ä»–å¥æŸ„ã€‚èµ„æºè¿›ä¸€æ­¥è¢«æŠ½è±¡ä¸ºç«¯å£ã€‚å› æ­¤ï¼Œèµ„æºçš„å…±äº«å®é™…ä¸Šç›¸å½“äºå…è®¸å¯¹å¯¹åº”ç«¯å£è¿›è¡Œè®¿é—®ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="APM" scheme="https://developerdoc.com/categories/APM/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡-åƒç´ æ“ä½œ</title>
    <link href="https://developerdoc.com/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E5%83%8F%E7%B4%A0%E6%93%8D%E4%BD%9C/"/>
    <id>https://developerdoc.com/quick-start/å›¾ç‰‡/iOSå›¾ç‰‡-åƒç´ æ“ä½œ/</id>
    <published>2020-01-13T13:07:46.000Z</published>
    <updated>2020-01-20T08:52:42.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»‹ç»ä¸‹å¸¸è§çš„å‡ ç§å¯¹å›¾ç‰‡çš„åƒç´ çº§æ“ä½œ<br>1.ä¿®æ”¹é¢œè‰² 2. é¢œè‰²ç©ºé—´å˜åŒ– 3.lsb éšè—ä¿¡æ¯ 4. é¢œè‰²æ··åˆ  5. é©¬èµ›å…‹</p></blockquote><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>åœ¨ <a href="../iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç /">iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç </a> ä¸­ä»‹ç»äº†ä½å›¾ä¿¡æ¯ä¸­åƒç´  é¢œè‰²ç©ºé—´ç­‰æ¦‚å¿µã€‚è¿™æ¬¡æ¥å®è·µä¸€ä¸‹å¦‚ä½•å¯¹å›¾ç‰‡çš„åƒç´ è¿›è¡Œæ“ä½œã€‚ä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•å¯¹å›¾ç‰‡è¿›è¡Œåƒç´ çº§æ“ä½œäº†ã€‚</p><h2 id="å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²"><a href="#å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²" class="headerlink" title="å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²"></a>å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²</h2><p>ç”±äºåœ¨iOSå¼€å‘ä¸­ä½¿ç”¨çš„ä½å›¾å¤§éƒ¨åˆ†æ˜¯32ä½RGBAæ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè¯´ä¸‹è¿™ç§æ¨¡å¼çš„ç®€å•å›¾åƒå¤„ç†ã€‚<br>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯32ä½RGBAæ¨¡å¼çš„ä½å›¾ã€‚32ä½å°±è¡¨ç¤ºä¸€ä¸ªè¿™ç§æ¨¡å¼ä½å›¾çš„ä¸€ä¸ªåƒç´ æ‰€å å†…å­˜ä¸º32ä½ï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚Rã€Gã€Bã€Aåˆ†åˆ«ä»£è¡¨redï¼Œgreenï¼Œblueå’Œalphaï¼Œä¹Ÿå°±æ˜¯é¢œè‰²ç»„æˆçš„ä¸‰åŸè‰²ä¸é€æ˜åº¦å€¼ã€‚RGBAæ¯ä¸€ä¸ªå ç”¨ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚<br>çŸ¥é“äº†ä¸Šé¢è¿™äº›ï¼Œæˆ‘ä»¬å°±æœ‰äº†æ€è·¯ï¼šé€šè¿‡æ”¹å˜æ¯ä¸€ä¸ªåƒç´ ä¸­çš„RGBAå€¼æ¥è¿›è¡Œä¸€äº›ä½å›¾å›¾åƒçš„å¤„ç†äº†ã€‚</p> <a id="more"></a><p>ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p><p>å°†åŸå›¾ç‰‡ <img src="/res/iOSImg/Share.png" alt> è½¬æ¢ä¸ºè“è‰²å›¾ç‰‡<br><img src="/res/iOSImg/sample1ResultImg.png" alt></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹1 å°†ä¸€å¼ å›¾ç‰‡å˜ä¸ºè“è‰²</span></span><br><span class="line"><span class="built_in">UIImage</span>* sampleImg1 = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"share.png"</span>];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">UIImage</span>* sample1ResultImg = [<span class="keyword">self</span>.class sample1With:sampleImg1];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç¤ºä¾‹1 å°†ä¸€å¼ å›¾ç‰‡å˜ä¸ºè“è‰² END"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span>*)sample1With:(<span class="built_in">UIImage</span>*)originImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾ åƒç´ rgbaä¿¡æ¯</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"><span class="comment">//            NSLog(@"r %d,g %d,b %d,a %d",thisR,thisG,thisB,thisA);</span></span><br><span class="line">            <span class="keyword">if</span>(thisA)&#123;<span class="comment">//é€æ˜ä¸å¤„ç† å…¶ä»–å˜ä¸ºè“è‰²</span></span><br><span class="line">                thisR = <span class="number">0</span>;</span><br><span class="line">                thisG = <span class="number">0</span>;</span><br><span class="line">                thisB = <span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²"><a href="#åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²" class="headerlink" title="åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²"></a>åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²</h2><p>iOS æ”¯æŒçš„ç»„åˆä¸å¤š <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB" target="_blank" rel="noopener">Supported Pixel Formats</a></p><p>è¿™é‡Œå°è¯•å°†åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰² ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p><p>å°†åŸå›¾ç‰‡  <img src="/res/iOSImg/rgb_cs.png" style="width:80%"> è½¬æ¢ä¸ºç°è‰²é¢œè‰²ç©ºé—´å›¾ç‰‡ <img src="/res/iOSImg/grey_cs.png" style="width:80%"></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹2 åƒç´ æ ¼å¼ é¢œè‰²ç©ºé—´å˜ä¸ºç°è‰²</span></span><br><span class="line"><span class="built_in">UIImage</span>* sampleImg2 = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"channel.png"</span>];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">UIImage</span>* sample1ResultImg = [<span class="keyword">self</span>.class sample2With:sampleImg2];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç¤ºä¾‹2 é¢œè‰²ç©ºé—´å˜åŒ– END"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...å…¶ä»–åŒä¸Šä¾‹</span></span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceGray</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaOnly);</span><br><span class="line"><span class="comment">//å»æ‰åƒç´ å¤„ç†éƒ¨åˆ†</span></span><br></pre></td></tr></table></figure><h2 id="LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡"><a href="#LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡" class="headerlink" title="LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡"></a>LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡</h2><p><a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E4%BD%8E%E6%9C%89%E6%95%88%E4%BD%8D" target="_blank" rel="noopener">LSB</a>ï¼Œæœ€ä½æœ‰æ•ˆä½ï¼Œè‹±æ–‡æ˜¯Least Significant Bit ã€‚æˆ‘ä»¬çŸ¥é“å›¾åƒåƒç´ ä¸€èˆ¬æ˜¯ç”±RGBä¸‰åŸè‰²ï¼ˆå³çº¢ç»¿è“ï¼‰ç»„æˆçš„ï¼Œæ¯ä¸€ç§é¢œè‰²å ç”¨8ä½ï¼Œ0x00~0xFFï¼Œå³ä¸€å…±æœ‰256ç§é¢œè‰²ï¼Œä¸€å…±åŒ…å«äº†256çš„3æ¬¡æ–¹çš„é¢œè‰²ï¼Œé¢œè‰²å¤ªå¤šï¼Œè€Œäººçš„è‚‰çœ¼èƒ½åŒºåˆ†çš„åªæœ‰å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œè¿™å¯¼è‡´äº†å½“æˆ‘ä»¬ä¿®æ”¹RGBé¢œè‰²åˆ†é‡ä¸­æœ€ä½çš„äºŒè¿›åˆ¶ä½çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„è‚‰çœ¼æ˜¯åŒºåˆ†ä¸å‡ºæ¥çš„ã€‚</p><p>é‰´äºLSBæƒ³æ³•ï¼Œä¸€å¼ æ™®é€šçš„äºŒç»´ç å›¾ç‰‡åªæœ‰é»‘è‰²å’Œç™½è‰²ã€‚é‚£ä¹ˆå¯¹äºRGBAçš„å›¾ç‰‡ å¯ä»¥ä¿®æ”¹Rçš„æœ€ä½ä½ã€‚0è¡¨ç¤ºç™½è‰² 1è¡¨ç¤ºé»‘è‰²ï¼Œè¿™æ ·å¤„ç†åè‚‰çœ¼çœ‹ä¸å‡ºåŸå›¾ä¿®æ”¹çš„ç—•è¿¹ã€‚</p><p>ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p><p>å·¦å›¾æ˜¯åŸå›¾ å³å›¾æ˜¯ç»è¿‡LSBæ“ä½œçš„å›¾ï¼Œè‚‰çœ¼å®Œå…¨çœ‹ä¸å‡ºåŒºåˆ«</p><p><img src="/res/iOSImg/LSB.png" alt></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹3 åœ¨ä¸€å¼ å›¾ç‰‡ä¸­ä½¿ç”¨lsbæ–¹å¼éšè—äºŒç»´ç  ã€‚</span></span><br><span class="line"><span class="comment">//ä¾‹å­é‡Œç®€å•å¤„ç†äº† åŸå›¾å’ŒäºŒç»´ç å¤§å°ç›¸åŒ</span></span><br><span class="line"><span class="built_in">UIImage</span>* oriImg = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"channel.png"</span>];</span><br><span class="line"><span class="built_in">UIImage</span>* qrImg = [<span class="keyword">self</span>.class createQRForAlreadySpliceString:<span class="string">@"ä¸€äº›ä¿¡æ¯"</span> size:<span class="built_in">CGSizeMake</span>(<span class="number">300</span>, <span class="number">300</span>)];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="comment">//å°†äºŒç»´ç å›¾ç‰‡ä¿¡æ¯è—å…¥åŸå›¾ å¾—åˆ°result</span></span><br><span class="line">    <span class="built_in">UIImage</span>* result = [<span class="keyword">self</span> handleImage:oriImg hideQrImage:qrImg];</span><br><span class="line">    <span class="comment">//ä»resultä¸­è§£æå¾—åˆ°äºŒç»´ç </span></span><br><span class="line">    <span class="built_in">UIImage</span>* qrResult = [<span class="keyword">self</span> handleHideImage:result];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MARK: å›¾ç‰‡å¤„ç† éšè—äºŒç»´ç å›¾ç‰‡</span></span><br><span class="line">- (<span class="built_in">UIImage</span>*)handleImage:(<span class="built_in">UIImage</span>*)originImg hideQrImage:(<span class="built_in">UIImage</span>*)qrImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line">    <span class="built_in">UInt32</span> * inputQRPixels;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRef</span> inputQRCGImage = [qrImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRWidth = <span class="built_in">CGImageGetWidth</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRHeight = <span class="built_in">CGImageGetHeight</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRBytesPerRow = bytesPerPixel * inputQRWidth;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line">    inputQRPixels = (<span class="built_in">UInt32</span> *)calloc(inputQRHeight * inputQRWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGContextRef</span> qrcontext = <span class="built_in">CGBitmapContextCreate</span>(inputQRPixels, inputQRWidth, inputQRHeight,</span><br><span class="line">                                                 bitsPerComponent, inputQRBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(qrcontext, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputQRWidth, inputQRHeight), inputQRCGImage);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"><span class="comment">//            NSLog(@"r %d,g %d,b %d,a %d",thisR,thisG,thisB,thisA);</span></span><br><span class="line">            <span class="comment">//äºŒç»´ç </span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentQRPixel = inputQRPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> qrcolor = *currentQRPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> qrthisR,qrthisG,qrthisB,qrthisA;</span><br><span class="line">            qrthisR=R(qrcolor);</span><br><span class="line">            qrthisG=G(qrcolor);</span><br><span class="line">            qrthisB=B(qrcolor);</span><br><span class="line">            qrthisA=A(qrcolor);</span><br><span class="line">            <span class="comment">//é€æ˜åº¦0ä¿¡æ¯ä¼šä¸¢å¤±</span></span><br><span class="line">            <span class="keyword">if</span>(thisA == <span class="number">0</span>)&#123;</span><br><span class="line">                thisA = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åƒç´ æœ€ä½ä½å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span>(qrthisR &lt; <span class="number">128</span>)&#123;<span class="comment">//äºŒç»´ç ç™½è‰² è®¾ç½®æœ€ä½ä½ä¸º0</span></span><br><span class="line">                thisR ^= (thisR &amp; ( <span class="number">1</span> &lt;&lt; <span class="number">0</span>) ) ^ (<span class="number">0</span> &lt;&lt; <span class="number">0</span>) ;</span><br><span class="line"><span class="comment">//                thisA = 255;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="comment">//äºŒç»´ç é»‘è‰² è®¾ç½®æœ€ä½ä½ä¸º1</span></span><br><span class="line">                thisR ^= (thisR &amp; ( <span class="number">1</span> &lt;&lt; <span class="number">0</span>) ) ^ (<span class="number">1</span> &lt;&lt; <span class="number">0</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(qrcontext);</span><br><span class="line">    free(inputQRPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MARK: å›¾ç‰‡å¤„ç† è§£æäºŒç»´ç </span></span><br><span class="line">- (<span class="built_in">UIImage</span>*)handleHideImage:(<span class="built_in">UIImage</span>*)originImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//åƒç´ æœ€ä½ä½å¤„ç†</span></span><br><span class="line">            <span class="keyword">int</span> tag = (thisR &gt;&gt; <span class="number">0</span>) &amp; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(tag == <span class="number">0</span>)&#123;<span class="comment">//æœ€ä½ä½ä¸º0 ç™½è‰²</span></span><br><span class="line">                thisR=<span class="number">255</span>;</span><br><span class="line">                thisG=<span class="number">255</span>;</span><br><span class="line">                thisB=<span class="number">255</span>;</span><br><span class="line">                thisA=<span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="comment">//æœ€ä½ä½ä¸º1 é»‘è‰²</span></span><br><span class="line">                thisR=<span class="number">0</span>;</span><br><span class="line">                thisG=<span class="number">0</span>;</span><br><span class="line">                thisB=<span class="number">0</span>;</span><br><span class="line">                thisA=<span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶LSBçš„æ–¹å¼ä¹Ÿèƒ½éšè—æ–‡å­—ç­‰å…¶ä»–ä¿¡æ¯ã€‚ä¸ä¹‹ç±»ä¼¼çš„æƒ³æ³•è¿˜æœ‰ å¯ä»¥æ ¹æ®å®¹å·®è¿›è¡Œä¿¡æ¯çš„éšè—ã€‚</p><p>è‹¥æ˜¯æœ‰ä¸¤å¼ å›¾ç‰‡ï¼Œåˆ™å¯¹ä¸¤å¼ å›¾ç‰‡çš„æ¯ä¸€ä¸ªåƒç´ ç‚¹è¿›è¡Œå¯¹æ¯”ï¼Œè®¾ç½®ä¸€ä¸ªå®¹å·®çš„é˜ˆå€¼Î±ï¼Œè¶…å‡ºè¿™ä¸ªé˜ˆå€¼çš„åƒç´ ç‚¹RGBå€¼è®¾ç½®ä¸º(255,255,255),è‹¥æ˜¯æ²¡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è®¾ç½®è¯¥åƒç´ ç‚¹çš„RGBå€¼ä¸º(0,0,0)ã€‚å› æ­¤ï¼Œé€šè¿‡è°ƒæ•´ä¸åŒçš„Î±å€¼ï¼Œå¯ä»¥ä½¿å¯¹æ¯”ç”Ÿæˆçš„å›¾ç‰‡å‘ˆç°ä¸åŒçš„ç”»é¢ã€‚æ¯”å¦‚ä¸¤å¼ å›¾å®Œå…¨ä¸€æ ·ï¼Œè®¾ç½®é˜ˆå€¼Î±ä¸ºä»»ä½•å€¼ï¼Œæœ€åå¾—åˆ°çš„å¯¹æ¯”å›¾éƒ½åªä¼šæ˜¯å…¨é»‘ã€‚è‹¥ä¸¤å¼ å›¾æ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½ä¸åŒï¼Œé˜ˆå€¼Î±è®¾ç½®ä¸º1ï¼Œåˆ™å¯¹æ¯”å›¾å°†æ˜¯å…¨ç™½ã€‚å¦‚æœå°†éšè—ä¿¡æ¯é™„åŠ åˆ°æŸäº›åƒç´ ç‚¹ä¸Šï¼Œè¿™æ—¶è°ƒæ•´é˜ˆå€¼Î±å³å¯çœ‹åˆ°éšè—ä¿¡æ¯ã€‚</p><h3 id="JPEGå‹ç¼©"><a href="#JPEGå‹ç¼©" class="headerlink" title="JPEGå‹ç¼©"></a>JPEGå‹ç¼©</h3><p>ç›®å‰ä¾‹å­ä¸­æœ‰ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ï¼Œç»è¿‡LSBæ“ä½œåçš„å›¾ç‰‡æ˜¯éœ€è¦æ— æŸçš„æ‰èƒ½ è§£æå‡ºæ•°æ®æ¥ã€‚å‡è®¾å›¾ç‰‡ç»è¿‡JPEGå‹ç¼©å å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†äºŒç»´ç å›¾ç‰‡ä¿¡æ¯è—å…¥åŸå›¾ å¾—åˆ°result</span></span><br><span class="line"><span class="built_in">UIImage</span>* result = [<span class="keyword">self</span> handleImage:oriImg hideQrImage:qrImg];</span><br><span class="line"><span class="built_in">NSData</span>* resultData = <span class="built_in">UIImageJPEGRepresentation</span>(result, <span class="number">0.9</span>);</span><br><span class="line">result = [<span class="built_in">UIImage</span> imageWithData:resultData];</span><br><span class="line"><span class="comment">//ä»resultä¸­è§£æå¾—åˆ°äºŒç»´ç </span></span><br><span class="line"><span class="built_in">UIImage</span>* qrResult = [<span class="keyword">self</span> handleHideImage:result];</span><br></pre></td></tr></table></figure><p>åˆ™qrResultä¼šå¾—åˆ°å¦‚ä¸‹å›¾ï¼š</p><p><img src="/res/iOSImg/qrResult_1.png" alt></p><p>è¿™æ˜¯ç”±äºJPEGå›¾åƒæ ¼å¼ä½¿ç”¨ç¦»æ•£ä½™å¼¦å˜æ¢ï¼ˆDiscrete Cosine Transformï¼ŒDCTï¼‰å‡½æ•°æ¥å‹ç¼©å›¾åƒï¼Œè€Œè¿™ä¸ªå›¾åƒå‹ç¼©æ–¹æ³•çš„æ ¸å¿ƒæ˜¯ï¼šé€šè¿‡è¯†åˆ«æ¯ä¸ª8Ã—8åƒç´ å—ä¸­ç›¸é‚»åƒç´ ä¸­çš„é‡å¤åƒç´ æ¥å‡å°‘æ˜¾ç¤ºå›¾åƒæ‰€éœ€çš„ä½æ•°ï¼Œå¹¶ä½¿ç”¨è¿‘ä¼¼ä¼°ç®—æ³•é™ä½å…¶å†—ä½™åº¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠDCTçœ‹ä½œä¸€ä¸ªç”¨äºæ‰§è¡Œå‹ç¼©çš„è¿‘ä¼¼è®¡ç®—æ–¹æ³•ã€‚å› ä¸ºä¸¢å¤±äº†éƒ¨åˆ†æ•°æ®ï¼Œä¾‹å­ä¸­æœ€ä½ä½ä¿¡æ¯å…¶å®å·²ç»è¢«æ”¹å˜ã€‚</p><h2 id="æ··è‰²æ¨¡å¼"><a href="#æ··è‰²æ¨¡å¼" class="headerlink" title="æ··è‰²æ¨¡å¼"></a>æ··è‰²æ¨¡å¼</h2><p>åœ¨PS çš„æ··è‰²æ¨¡å¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯ä»¥é€‰é¡¹ï¼Œæ··åˆæ¨¡å¼çš„åŸºæœ¬åŸç†å°±æ˜¯å–Aå±‚ä»»æ„ä¸€ä¸ªåƒç´ a [R1, G1, B1]ï¼Œä¸Bå±‚å¯¹åº”ä½ç½®çš„åƒç´ b [R2, G2, B2] è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œå¾—åˆ°c [R3, G3, B3]ã€‚æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ <a href="https://zhuanlan.zhihu.com/p/23905865" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« å½»åº•ææ¸…PSæ··åˆæ¨¡å¼çš„åŸç†</a></p><p>åŸºäºè¿™ç§æƒ³æ³• æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸‹PSçš„æ··åˆæ¨¡å¼ï¼š</p><p><img src="/res/iOSImg/colorMix.png" alt></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">// åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">                <span class="built_in">UInt32</span> *currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">                <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">                <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">                <span class="comment">// è¿™é‡Œç›´æ¥ç§»ä½è·å¾—RBGAçš„å€¼,ä»¥åŠè¾“å‡ºå†™çš„éå¸¸å¥½ï¼</span></span><br><span class="line">                thisR = R(color);</span><br><span class="line">                thisG = G(color);</span><br><span class="line">                thisB = B(color);</span><br><span class="line">                thisA = A(color);</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">UInt32</span> newR,newG,newB;</span><br><span class="line">                newR = [<span class="keyword">self</span> SoftLight:thisR];</span><br><span class="line">                newG = [<span class="keyword">self</span> SoftLight:thisG];</span><br><span class="line">                newB = [<span class="keyword">self</span> SoftLight:thisB];</span><br><span class="line">                </span><br><span class="line">                *currentPixel = RGBAMake(newR,</span><br><span class="line">                                         newG,</span><br><span class="line">                                         newB,</span><br><span class="line">                                         thisA);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>Color Burn é¢œè‰²åŠ æ·±ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)ColorBurn:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//    C=A-(Aåç›¸Ã—Båç›¸)/B</span></span><br><span class="line"><span class="comment">//    å¦‚æœä¸Šå±‚è¶Šæš—ï¼Œåˆ™ä¸‹å±‚è·å–çš„å…‰è¶Šå°‘ï¼ŒåŠ æ·±æ•ˆæœè¶Šæ˜æ˜¾ã€‚</span></span><br><span class="line"><span class="comment">//    ã€å¦‚æœä¸Šå±‚ä¸ºå…¨é»‘è‰²ï¼Œåˆ™ä¸‹å±‚é¢œè‰²å€¼ä¸æ˜¯255çš„åƒç´ å…¨å˜æˆ0ã€‘ï¼Œ</span></span><br><span class="line"><span class="comment">//    å¦‚æœä¸Šå±‚ä¸ºå…¨ç™½è‰²ï¼Œåˆ™æ ¹æœ¬ä¸ä¼šå½±å“ä¸‹å±‚ã€‚</span></span><br><span class="line"><span class="comment">//    ç»“æœæœ€äº®çš„åœ°æ–¹ä¸ä¼šé«˜äºä¸‹å±‚çš„åƒç´ å€¼ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    resultValue = originValue - (<span class="number">255</span> - originValue) * (<span class="number">255</span> - bValue) / bValue;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Color Dodge é¢œè‰²å‡æ·¡ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)ColorDodge:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//C=A+(AÃ—B)/Båç›¸</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼å’Œä¸Šä¸€ä¸ªæ¨¡å¼åˆšå¥½ç›¸åã€‚</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼ä¸‹ï¼Œä¸Šå±‚çš„äº®åº¦å†³å®šäº†ä¸‹å±‚çš„æš´éœ²ç¨‹åº¦ã€‚</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šå±‚è¶Šäº®ï¼Œä¸‹å±‚è·å–çš„å…‰è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯è¶Šäº®ã€‚</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šå±‚æ˜¯çº¯é»‘è‰²ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰äº®åº¦ï¼Œåˆ™æ ¹æœ¬ä¸ä¼šå½±å“ä¸‹å±‚ï¼Œ</span></span><br><span class="line"><span class="comment">//ã€å¦‚æœä¸Šå±‚æ˜¯çº¯ç™½è‰²ï¼Œåˆ™ä¸‹å±‚é¢œè‰²å€¼ä¸æ˜¯0çš„åƒç´ å…¨å˜æˆ255ã€‘ã€‚</span></span><br><span class="line"><span class="comment">//ç»“æœæœ€é»‘çš„åœ°æ–¹ä¸ä¼šä½äºä¸‹å±‚çš„åƒç´ å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    resultValue = originValue + originValue * bValue / (<span class="number">255</span> - bValue);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hard Light å¼ºå…‰ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)HardLight:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//B&lt;=128åˆ™ C=(AÃ—B)/128</span></span><br><span class="line"><span class="comment">//B&gt;128åˆ™ C=255-(Aåç›¸Ã—Båç›¸)/128</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼å®Œå…¨ç›¸å¯¹åº”äºOverlayï¼ˆå åŠ ï¼‰æ¨¡å¼ä¸‹ï¼Œä¸¤ä¸ªå›¾å±‚è¿›è¡Œæ¬¡åºäº¤æ¢çš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">//å¦‚è¿‡ä¸Šå±‚çš„é¢œè‰²é«˜äº50%ç°ï¼Œåˆ™ä¸‹å±‚è¶Šäº®ï¼Œåä¹‹è¶Šæš—ã€‚</span></span><br><span class="line"><span class="comment">//ã€å¦‚æœå°†ä¸Šå±‚å›¾å±‚è®¾ä¸ºå åŠ ï¼Œä¸‹å±‚è®¾ä¸ºå¼ºå…‰ï¼Œåˆ™æ”¹å˜å›¾å±‚é¡ºåºä¸å½±å“ç»“æœã€‚ã€‘</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(bValue &lt;= <span class="number">128</span>)&#123;</span><br><span class="line">        resultValue =   originValue * bValue / <span class="number">128</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        resultValue = <span class="number">255</span> - (<span class="number">255</span> - originValue) * (<span class="number">255</span> - bValue) / <span class="number">128</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘ç°ä¸€ç¯‡æ–‡ç«  <a href="https://juejin.im/post/5cd17612f265da037a3d0183" target="_blank" rel="noopener">iOSâ€”â€”éšå½¢æ°´å°çš„å®ç°å’Œã€é¢œè‰²åŠ æ·±ã€ç®—æ³•</a> æ–‡ä¸­è¯´ç”¨ é¢œè‰²åŠ æ·±æ¥æ˜¾ç¤ºéšå½¢æ°´å°ï¼Œä½†æ˜¯æˆ‘æ¢äº†å‡ å¼ å›¾ç‰‡å®è·µäº†ä¸€ä¸‹ æ•ˆæœä¸ç†æƒ³ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å®è·µä¸‹ã€‚</p><h2 id="é©¬èµ›å…‹"><a href="#é©¬èµ›å…‹" class="headerlink" title="é©¬èµ›å…‹"></a>é©¬èµ›å…‹</h2><p>ç®€å•é©¬èµ›å…‹æ ¸å¿ƒç®—æ³•çš„å¤§æ¦‚åŸç†å°±æ˜¯æŠŠæŸä¸€ä¸ªç‚¹çš„é¢œè‰²èµ‹å€¼ç»™å®ƒå‘¨å›´çš„æŒ‡å®šåŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå¤§å°å¯ä»¥æˆ‘ä»¬è‡ªå·±æ¥å®šä¹‰ã€‚</p><p>æŒ‰ç…§è¿™ç§æƒ³æ³•å¯ä»¥åšåˆ°ï¼š</p><p><img src="/res/iOSImg/msk.png" alt></p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾ åƒç´ rgbaä¿¡æ¯</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">float</span> markP = <span class="number">10</span>;<span class="comment">//10x10åŒºåŸŸ</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> centerX = <span class="number">0</span> , centerY = <span class="number">0</span>;</span><br><span class="line">            centerX =  floor(i/markP)*markP + <span class="number">0.5</span>*markP;</span><br><span class="line">            centerX = centerX &gt;= (inputWidth<span class="number">-1</span>) ? (inputWidth<span class="number">-1</span>) : centerX;</span><br><span class="line">            centerY =  floor(j/markP)*markP + <span class="number">0.5</span>*markP;</span><br><span class="line">            centerY = centerY &gt;= (inputHeight<span class="number">-1</span>) ? (inputHeight<span class="number">-1</span>) : centerY;</span><br><span class="line">            <span class="built_in">UInt32</span> * centerPixel = inputPixels + (centerY * inputWidth) + centerX;</span><br><span class="line">            <span class="built_in">UInt32</span> centerColor = *centerPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> centerR,centerG,centerB,centerA;</span><br><span class="line">            centerR=R(centerColor);</span><br><span class="line">            centerG=G(centerColor);</span><br><span class="line">            centerB=B(centerColor);</span><br><span class="line">            centerA=A(centerColor);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            *currentPixel = RGBAMake(centerR, centerG, centerB, centerA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><h2 id="æå–ä¸»è‰²è°ƒ"><a href="#æå–ä¸»è‰²è°ƒ" class="headerlink" title="æå–ä¸»è‰²è°ƒ"></a>æå–ä¸»è‰²è°ƒ</h2><p>ref:<br><a href="https://github.com/tangdiforx/iOSPalette" target="_blank" rel="noopener">iOS-palette</a><br><a href="https://developer.android.com/reference/android/support/v7/palette/package-summary" target="_blank" rel="noopener">android-palette</a><br><a href="https://github.com/google/palette.js" target="_blank" rel="noopener">js-palette</a></p><p>éå†ä¸€éå›¾ç‰‡çš„æ‰€æœ‰åƒç´ ä¿¡æ¯ï¼Œç„¶åç»Ÿè®¡ä¸€ä¸‹å“ªä¸ªRGBå€¼æœ€å¤šï¼Œä¸å°±æ˜¯ä¸»è‰²è°ƒå˜›ï¼Ÿä½†æ˜¯äººçœ¼å’Œå†·å†°å†°çš„æ•°æ®è¿˜æ˜¯å­˜åœ¨å·®å¼‚çš„ã€‚ Paletteé€šè¿‡é¥±å’Œåº¦ç­›é€‰ é¢œè‰²åŒºåŸŸè§£å†³é¢œè‰²åˆ†æ•£æ¥é€‰å‡ºä¸»è‰²è°ƒã€‚å‚è€ƒ<a href="https://www.jianshu.com/p/01df6010dded" target="_blank" rel="noopener">iOSå›¾ç‰‡ç²¾ç¡®æå–ä¸»è‰²è°ƒç®—æ³•iOS-Palette</a></p><p><img src="https://upload-images.jianshu.io/upload_images/5806025-9188b291498651e7.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/720/format/webp" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»‹ç»ä¸‹å¸¸è§çš„å‡ ç§å¯¹å›¾ç‰‡çš„åƒç´ çº§æ“ä½œ&lt;br&gt;1.ä¿®æ”¹é¢œè‰² 2. é¢œè‰²ç©ºé—´å˜åŒ– 3.lsb éšè—ä¿¡æ¯ 4. é¢œè‰²æ··åˆ  5. é©¬èµ›å…‹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h2&gt;&lt;p&gt;åœ¨ &lt;a href=&quot;../iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç /&quot;&gt;iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç &lt;/a&gt; ä¸­ä»‹ç»äº†ä½å›¾ä¿¡æ¯ä¸­åƒç´  é¢œè‰²ç©ºé—´ç­‰æ¦‚å¿µã€‚è¿™æ¬¡æ¥å®è·µä¸€ä¸‹å¦‚ä½•å¯¹å›¾ç‰‡çš„åƒç´ è¿›è¡Œæ“ä½œã€‚ä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•å¯¹å›¾ç‰‡è¿›è¡Œåƒç´ çº§æ“ä½œäº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²&quot;&gt;&lt;a href=&quot;#å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²&quot; class=&quot;headerlink&quot; title=&quot;å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²&quot;&gt;&lt;/a&gt;å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²&lt;/h2&gt;&lt;p&gt;ç”±äºåœ¨iOSå¼€å‘ä¸­ä½¿ç”¨çš„ä½å›¾å¤§éƒ¨åˆ†æ˜¯32ä½RGBAæ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè¯´ä¸‹è¿™ç§æ¨¡å¼çš„ç®€å•å›¾åƒå¤„ç†ã€‚&lt;br&gt;é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯32ä½RGBAæ¨¡å¼çš„ä½å›¾ã€‚32ä½å°±è¡¨ç¤ºä¸€ä¸ªè¿™ç§æ¨¡å¼ä½å›¾çš„ä¸€ä¸ªåƒç´ æ‰€å å†…å­˜ä¸º32ä½ï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚Rã€Gã€Bã€Aåˆ†åˆ«ä»£è¡¨redï¼Œgreenï¼Œblueå’Œalphaï¼Œä¹Ÿå°±æ˜¯é¢œè‰²ç»„æˆçš„ä¸‰åŸè‰²ä¸é€æ˜åº¦å€¼ã€‚RGBAæ¯ä¸€ä¸ªå ç”¨ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚&lt;br&gt;çŸ¥é“äº†ä¸Šé¢è¿™äº›ï¼Œæˆ‘ä»¬å°±æœ‰äº†æ€è·¯ï¼šé€šè¿‡æ”¹å˜æ¯ä¸€ä¸ªåƒç´ ä¸­çš„RGBAå€¼æ¥è¿›è¡Œä¸€äº›ä½å›¾å›¾åƒçš„å¤„ç†äº†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSå›¾ç‰‡" scheme="https://developerdoc.com/categories/iOS%E5%9B%BE%E7%89%87/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="å›¾ç‰‡" scheme="https://developerdoc.com/tags/%E5%9B%BE%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç </title>
    <link href="https://developerdoc.com/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E4%BD%8D%E5%9B%BE%E4%BF%A1%E6%81%AF%E4%B8%8E%E5%9B%BE%E7%89%87%E8%A7%A3%E7%A0%81/"/>
    <id>https://developerdoc.com/quick-start/å›¾ç‰‡/iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç /</id>
    <published>2019-12-10T08:35:28.000Z</published>
    <updated>2020-01-15T09:30:15.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»‹ç»ä¸‹å‡ ç§iOSä¸­ä½å›¾ä¿¡æ¯ ä¸ç›¸å…³è§£å‹ç¼©<br>ref <a href="http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/" target="_blank" rel="noopener">è°ˆè°ˆ iOS ä¸­å›¾ç‰‡çš„è§£å‹ç¼©</a><br>ref <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007533-SW1" target="_blank" rel="noopener">Quartz 2D Programming Guide</a></p></blockquote><p>æˆ‘ä»¬ä»ç½‘ç»œä¸‹è½½æˆ–è€…ä»æœ¬åœ°ç£ç›˜åŠ è½½ä¸€å¼ å›¾ç‰‡åˆ°å±å¹•ä¸Šæ˜¾ç¤ºï¼Œè¦ç»è¿‡å›¾ç‰‡çš„è§£ç è¿‡ç¨‹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¸€èˆ¬çš„å›¾ç‰‡æ ¼å¼ä¾‹å¦‚ JPEGï¼ŒPNGéƒ½æ˜¯ç»è¿‡å‹ç¼©åçš„å›¾ç‰‡ï¼Œè€Œæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å›¾ç‰‡å«åšä½å›¾(bitmap)ï¼Œæ‰€è°“çš„è§£ç å°±æ˜¯æŠŠå‹ç¼©åçš„å›¾ç‰‡å˜æˆä½å›¾ã€‚</p><p>ä¸ºä»€ä¹ˆéè¦è§£ç æˆä½å›¾æ‰èƒ½æ˜¾ç¤ºå‘¢ï¼Ÿå› ä¸ºä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨å±å¹•ä¸Šæ¸²æŸ“æ•´å¼ å›¾ç‰‡äº†ã€‚</p><p>é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸åŒæ ¼å¼çš„å„ç§å›¾ç‰‡å‘¢ï¼Ÿç›´æ¥å…¨éƒ¨ç”¨ä½å›¾ä¸å°±å¥½äº†ï¼Ÿé‚£ä¸å°±ä¸éœ€è¦æ¯æ¬¡è§£ç äº†ï¼Ÿé‚£äº›JPEGä»¥åŠPNGç­‰å…¶å®éƒ½æ˜¯å›¾åƒçš„å‹ç¼©æ ¼å¼ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å‹ç¼©çš„æ„æ€å°±æ˜¯å‡å°ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œä½¿ç”¨è¿™äº›æ ¼å¼çš„åŸå› å°±æ˜¯ä½å›¾å®åœ¨å¤ªå¤§äº†ã€‚</p><h2 id="å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–"><a href="#å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–" class="headerlink" title="å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–"></a>å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–</h2><a id="more"></a><p>æˆ‘ä»¬æ¥ä½¿ç”¨è¿™å¼ å›¾ç‰‡å’Œä»¥ä¸‹ä»£ç åšä¾‹å­ï¼š</p><p><img src="/res/iOSImg/testImg2.png" style="background-color: rgba(0,0,300,.5)"><br>è¯¥å›¾ç‰‡çš„äºŒè¿›åˆ¶ä¿¡æ¯ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR</span><br><span class="line">00000010: 0000 0022 0000 0022 0803 0000 000d 99fb  ...&quot;...&quot;........</span><br><span class="line">00000020: f000 0000 5d50 4c54 4500 0000 ffff ffff  ....]PLTE.......</span><br><span class="line">00000030: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000040: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000050: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000060: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000070: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000080: ffff ffff ffff 512a fbe5 0000 001e 7452  ......Q*......tR</span><br><span class="line">00000090: 4e53 001c b890 7103 faa9 580d f7c8 09f0  NS....q...X.....</span><br><span class="line">000000a0: be42 1685 78e2 d4c5 b1a1 604d 492d 1e0f  .B..x.....`MI-..</span><br><span class="line">000000b0: 5dbe 24b2 0000 0084 4944 4154 38cb edcf  ].$.....IDAT8...</span><br><span class="line">000000c0: cb0a c240 1044 d1d2 38ad 8e19 4de2 fb55  ...@.D..8...M..U</span><br><span class="line">000000d0: ffff 99d2 4d70 971a 5097 de5d c381 a630  ....Mp..P..]...0</span><br><span class="line">000000e0: d113 952e 7b96 be55 a2a1 b76d b538 981b  ....&#123;..U...m.8..</span><br><span class="line">000000f0: 2516 d865 374a 6034 428c a611 228c 3127  %..e7J`4B...&quot;.1&apos;</span><br><span class="line">00000100: 21bc 23f9 d062 4596 a485 9143 552c d35f  !.#..bE....CU,._</span><br><span class="line">00000110: 7c27 faaa 4856 1358 939b f7d1 e510 9298  |&apos;..HV.X........</span><br><span class="line">00000120: 0b49 70bf 2548 127d 4aca 7cba d335 46cb  .Ip.%H.&#125;J.|..5F.</span><br><span class="line">00000130: 0a80 4193 73bc 9a89 3afc a817 5dd5 1a7c  ..A.s...:...]..|</span><br><span class="line">00000140: 84ac 48f9 0000 0000 4945 4e44 ae42 6082  ..H.....IEND.B`.</span><br></pre></td></tr></table></figure><p>è·å–å›¾ç‰‡è§£å‹ä¿¡æ¯çš„ä»£ç ä¸ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * path = [[<span class="built_in">NSBundle</span> mainBundle]pathForResource:<span class="string">@"testImg2"</span> ofType:<span class="string">@"png"</span>];</span><br><span class="line"><span class="built_in">NSURL</span> * url = [<span class="built_in">NSURL</span> fileURLWithPath:path];</span><br><span class="line"><span class="built_in">CGImageSourceRef</span> myImageSource = <span class="built_in">CGImageSourceCreateWithURL</span>((<span class="built_in">CFURLRef</span>)url, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">CGImageRef</span> myImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(myImageSource,<span class="number">0</span>,<span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">CFRelease</span>(myImageSource);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CFDataRef</span> rawData = <span class="built_in">CGDataProviderCopyData</span>(<span class="built_in">CGImageGetDataProvider</span>(myImage));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"rawData %@"</span>,rawData);</span><br></pre></td></tr></table></figure><p>è¿™å¼ å›¾ç‰‡åƒç´ å°ºå¯¸ä¸º34x34,æ–‡ä»¶å¤§å°ä¸º 336Byte ï¼›è€Œè·å–åˆ°å›¾ç‰‡åŸå§‹åƒç´ æ•°æ®rawDataï¼Œå¤§å°ä¸º4624byteã€‚ä»¥ä¸‹ä¸ºrawDataä¿¡æ¯ :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">00000000 ffffff90 ffffffff ffffffff ffffffff ffffff71 00000000 ffffff42 fffffff7 </span><br><span class="line">ffffffff ffffffff ffffffbe ffffff09 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 ffffff90 ffffffff </span><br><span class="line">ffffffff ffffffff ffffff71 00000000 00000000 00000000 ffffff42 fffffff7 ffffffff </span><br><span class="line">ffffffff ffffffbe ffffff09 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 ffffff90 ffffffff ffffffff ffffffff ffffff71 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 ffffff42 fffffff7 ffffffff ffffffff </span><br><span class="line">ffffff90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™å¼ PNG å›¾ç‰‡è§£å‹ç¼©åçš„å¤§å°æ˜¯ 4624byte ï¼Œæ˜¯åŸå§‹æ–‡ä»¶å¤§å°çš„ 4.27 å€ã€‚é‚£ä¹ˆè¿™ä¸ª4624byteæ˜¯æ€ä¹ˆå¾—æ¥çš„å‘¢ï¼Ÿä¸å›¾ç‰‡çš„æ–‡ä»¶å¤§å°æˆ–è€…åƒç´ æœ‰ä»€ä¹ˆå¿…ç„¶çš„è”ç³»å—ï¼Ÿäº‹å®ä¸Šï¼Œè§£å‹ç¼©åçš„å›¾ç‰‡å¤§å°ä¸åŸå§‹æ–‡ä»¶å¤§å°ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè€Œåªä¸å›¾ç‰‡çš„åƒç´ æœ‰å…³ï¼š</p><p><strong><em>è§£å‹ç¼©åçš„å›¾ç‰‡å¤§å° = å›¾ç‰‡çš„åƒç´ å®½ 34 </em> å›¾ç‰‡çš„åƒç´ é«˜ 34 <em> æ¯ä¸ªåƒç´ æ‰€å çš„å­—èŠ‚æ•° 4</em></strong></p><p>æˆ‘ä»¬å¸¸è§æ¥è§¦åˆ°çš„å›¾ç‰‡æ ¼å¼ï¼Œ JPEG è¿˜æ˜¯ PNG å›¾ç‰‡ï¼Œéƒ½æ˜¯ä¸€ç§å‹ç¼©çš„<a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html" target="_blank" rel="noopener">ä½å›¾å›¾å½¢æ ¼å¼</a>ã€‚åªä¸è¿‡ PNG å›¾ç‰‡æ˜¯æ— æŸå‹ç¼©ï¼Œå¹¶ä¸”æ”¯æŒ alpha é€šé“ï¼Œè€Œ JPEG å›¾ç‰‡åˆ™æ˜¯æœ‰æŸå‹ç¼©ï¼Œå¯ä»¥æŒ‡å®š 0-100% çš„å‹ç¼©æ¯”ã€‚åœ¨å°†ç£ç›˜ä¸­çš„å›¾ç‰‡æ¸²æŸ“åˆ°å±å¹•ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¦å¾—åˆ°å›¾ç‰‡çš„åŸå§‹åƒç´ æ•°æ®ï¼Œæ‰èƒ½æ‰§è¡Œåç»­çš„ç»˜åˆ¶æ“ä½œã€‚</p><h2 id="ä½å›¾ä¿¡æ¯"><a href="#ä½å›¾ä¿¡æ¯" class="headerlink" title="ä½å›¾ä¿¡æ¯"></a>ä½å›¾ä¿¡æ¯</h2><p>å…¶å®ï¼Œä½å›¾å°±æ˜¯ä¸€ä¸ªåƒç´ æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªåƒç´ å°±ä»£è¡¨ç€å›¾ç‰‡ä¸­çš„ä¸€ä¸ªç‚¹ã€‚<a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html" target="_blank" rel="noopener">Bitmap Images and Image Masks</a>ä¸­æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š</p><blockquote><p>A bitmap image (or sampled image) is an array of pixels (or samples). Each pixel represents a single point in the image. JPEG, TIFF, and PNG graphics files are examples of bitmap images.<br>Each sample in a bitmap contains one or more color components in a specified color space, plus one additional component that specifies the alpha value to indicate transparency. Each component can be from 1 to as many as 32 bits. In Mac OS X, Quartz also provides support for floating-point components. The supported formats in Mac OS X and iOS are described in â€œPixel formats supported for bitmap graphics contextsâ€. ColorSync provides color space support for bitmap images.</p></blockquote><p>Quartzåœ¨åˆ›å»ºä½å›¾å›¾åƒï¼ˆCGImageRefï¼‰æ—¶ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li><em>data source</em> ä½å›¾æ•°æ®æºï¼Œå¯ä»¥æ˜¯Quartzæ•°æ®æä¾›ç¨‹åºæˆ–Quartzå›¾åƒæºã€‚</li><li><em>Pixel Format</em> åƒç´ æ ¼å¼ï¼ŒåŒ…æ‹¬æ¯ä¸ªç»„ä»¶çš„ä½æ•°ï¼Œæ¯ä¸ªåƒç´ çš„ä½æ•°å’Œæ¯è¡Œçš„å­—èŠ‚æ•°ã€‚</li><li><em>Color Spaces and Bitmap Layout</em> å¯¹äºå›¾åƒï¼Œé¢œè‰²ç©ºé—´å’Œä½å›¾å¸ƒå±€ï¼ˆé¢œè‰²ç©ºé—´å’Œä½å›¾å¸ƒå±€ï¼‰ä¿¡æ¯ç”¨äºæè¿°alphaçš„ä½ç½®ä»¥åŠä½å›¾æ˜¯å¦ä½¿ç”¨æµ®ç‚¹å€¼ã€‚</li><li><em>Decode Array</em> å¯é€‰çš„è§£ç æ•°ç»„ã€‚</li><li>æ’å€¼è®¾ç½®ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå®ƒæŒ‡å®šåœ¨è°ƒæ•´å›¾åƒå¤§å°æ—¶ï¼ŒQuartzæ˜¯å¦åº”åº”ç”¨æ’å€¼ç®—æ³•ã€‚</li><li>ä¸€ä¸ªæ¸²æŸ“æ„å›¾ï¼ŒæŒ‡å®šå¦‚ä½•æ˜ å°„ä½äºå›¾å½¢ä¸Šä¸‹æ–‡çš„ç›®æ ‡é¢œè‰²ç©ºé—´å†…çš„é¢œè‰²ã€‚</li><li>å›¾åƒå°ºå¯¸ã€‚</li></ul><h3 id="è§£ç æ•°ç»„-Decode-Array"><a href="#è§£ç æ•°ç»„-Decode-Array" class="headerlink" title="è§£ç æ•°ç»„ Decode Array"></a>è§£ç æ•°ç»„ Decode Array</h3><p>è§£ç æ•°ç»„å°†å›¾åƒé¢œè‰²å€¼æ˜ å°„åˆ°å…¶ä»–é¢œè‰²å€¼ï¼Œè¿™å¯¹äºè¯¸å¦‚ä½¿å›¾åƒå»é¥±å’Œæˆ–åè½¬é¢œè‰²ä¹‹ç±»çš„ä»»åŠ¡å¾ˆæœ‰ç”¨ã€‚è¯¥æ•°ç»„åŒ…å«æ¯ä¸ªé¢œè‰²åˆ†é‡çš„ä¸€å¯¹æ•°å­—ã€‚Quartzæ¸²æŸ“å›¾åƒæ—¶ï¼Œå®ƒå°†åº”ç”¨çº¿æ€§å˜æ¢å°†åŸå§‹åˆ†é‡å€¼æ˜ å°„åˆ°é€‚åˆç›®æ ‡è‰²å½©ç©ºé—´çš„æŒ‡å®šèŒƒå›´å†…çš„ç›¸å¯¹æ•°å­—ã€‚ä¾‹å¦‚ï¼ŒRGBé¢œè‰²ç©ºé—´ä¸­å›¾åƒçš„è§£ç æ•°ç»„åŒ…å«å…­ä¸ªæ¡ç›®ï¼Œæ¯ä¸ªçº¢è‰²ï¼Œç»¿è‰²å’Œè“è‰²åˆ†é‡ä¸€å¯¹ã€‚</p><h3 id="åƒç´ æ ¼å¼Pixel-Format"><a href="#åƒç´ æ ¼å¼Pixel-Format" class="headerlink" title="åƒç´ æ ¼å¼Pixel Format"></a>åƒç´ æ ¼å¼Pixel Format</h3><p>åƒç´ æ ¼å¼åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p><ul><li><em>Bits per component</em>æ¯ä¸ªåˆ†é‡çš„ä½æ•°ï¼Œå³åƒç´ ä¸­æ¯ä¸ªå•ç‹¬é¢œè‰²åˆ†é‡çš„ä½æ•°ã€‚å¯¹äºå›¾åƒæ©æ¨¡ï¼Œæ­¤å€¼æ˜¯æºåƒç´ ä¸­æœ‰æ•ˆæ©æ¨¡ä½çš„æ•°é‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæºå›¾åƒæ˜¯8ä½æ©ç ï¼Œåˆ™æ¯ä¸ªç»„ä»¶æŒ‡å®š8ä½ã€‚</li><li><em>Bits per pixel</em>æ¯ä¸ªåƒç´ çš„ä½æ•°ï¼Œå³æºåƒç´ çš„ä½æ•°ã€‚è¯¥å€¼å¿…é¡»è‡³å°‘æ˜¯æ¯ä¸ªç»„ä»¶çš„ä½æ•°ä¹˜ä»¥æ¯ä¸ªåƒç´ çš„ç»„ä»¶æ•°ã€‚</li><li><em>Bytes per row</em>æ¯è¡Œå­—èŠ‚æ•°ã€‚å›¾åƒä¸­æ¯æ°´å¹³è¡Œçš„å­—èŠ‚æ•°ã€‚</li></ul><h3 id="é¢œè‰²ä¸é¢œè‰²ç©ºé—´-Color-and-Color-Spaces"><a href="#é¢œè‰²ä¸é¢œè‰²ç©ºé—´-Color-and-Color-Spaces" class="headerlink" title="é¢œè‰²ä¸é¢œè‰²ç©ºé—´ Color and Color Spaces"></a>é¢œè‰²ä¸é¢œè‰²ç©ºé—´ Color and Color Spaces</h3><p><a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101" target="_blank" rel="noopener">Color and Color Spaces</a>ä¸­è¯´æ˜äº†Quartzä¸­çš„é¢œè‰²ç”±ä¸€ç»„å€¼è¡¨ç¤ºã€‚å¦‚æœæ²¡æœ‰é¢œè‰²ç©ºé—´æŒ‡ç¤ºå¦‚ä½•è§£é‡Šé¢œè‰²ä¿¡æ¯ï¼Œåˆ™è¿™äº›å€¼å°†æ¯«æ— æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œè¡¨4-1ä¸­çš„å€¼å…¨éƒ¨ä»£è¡¨å…¨å¼ºåº¦çš„è“è‰²ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸çŸ¥é“é¢œè‰²ç©ºé—´æˆ–æ¯ç§é¢œè‰²ç©ºé—´çš„å…è®¸å€¼èŒƒå›´ï¼Œå°±æ— æ³•çŸ¥é“æ¯ç»„å€¼ä»£è¡¨å“ªç§é¢œè‰²ã€‚</p><p>è¡¨4-1   ä¸åŒé¢œè‰²ç©ºé—´ä¸­çš„é¢œè‰²å€¼</p><table><thead><tr><th style="text-align:left">values</th><th style="text-align:center">color space</th><th style="text-align:right">compoents</th></tr></thead><tbody><tr><td style="text-align:left">240 degrees, 100%, 100%</td><td style="text-align:center">HSB</td><td style="text-align:right">Hue, saturation, brightness</td></tr><tr><td style="text-align:left">0, 0, 1</td><td style="text-align:center">RGB</td><td style="text-align:right">Red, green, blue</td></tr><tr><td style="text-align:left">1, 1, 0, 0</td><td style="text-align:center">CMYK</td><td style="text-align:right">Cyan, magenta, yellow, black</td></tr><tr><td style="text-align:left">1, 0, 0</td><td style="text-align:center">BGR</td><td style="text-align:right">Blue, green, red</td></tr></tbody></table><p>å¦‚æœæä¾›é”™è¯¯çš„è‰²å½©ç©ºé—´ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°å¾ˆå¤§çš„å·®å¼‚ï¼Œå¦‚å›¾4-1æ‰€ç¤ºã€‚å°½ç®¡ç»¿è‰²åœ¨BGRå’ŒRGBé¢œè‰²ç©ºé—´ä¸­çš„è§£é‡Šç›¸åŒï¼Œä½†æ˜¯çº¢è‰²å’Œè“è‰²å€¼å´è¢«ç¿»è½¬äº†ã€‚</p><p><img src="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Art/color_profiles.gif" alt></p><h3 id="ä½å›¾å¸ƒå±€-Bitmap-Layout"><a href="#ä½å›¾å¸ƒå±€-Bitmap-Layout" class="headerlink" title="ä½å›¾å¸ƒå±€ Bitmap Layout"></a>ä½å›¾å¸ƒå±€ Bitmap Layout</h3><p>æƒ³ç¡®ä¿ Quartz èƒ½å¤Ÿæ­£ç¡®åœ°è§£æåƒç´ æ ¼å¼ä¸­å„ä¸ªbitæ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›ä½å›¾çš„å¸ƒå±€ä¿¡æ¯ <code>CGBitmapInfo</code> ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_OPTIONS</span>(uint32_t, <span class="built_in">CGBitmapInfo</span>) &#123;</span><br><span class="line">    kCGBitmapAlphaInfoMask = <span class="number">0x1F</span>,</span><br><span class="line"></span><br><span class="line">    kCGBitmapFloatInfoMask = <span class="number">0xF00</span>,</span><br><span class="line">    kCGBitmapFloatComponents = (<span class="number">1</span> &lt;&lt; <span class="number">8</span>),</span><br><span class="line"></span><br><span class="line">    kCGBitmapByteOrderMask     = kCGImageByteOrderMask,</span><br><span class="line">    kCGBitmapByteOrderDefault  = kCGImageByteOrderDefault,</span><br><span class="line">    kCGBitmapByteOrder16Little = kCGImageByteOrder16Little,</span><br><span class="line">    kCGBitmapByteOrder32Little = kCGImageByteOrder32Little,</span><br><span class="line">    kCGBitmapByteOrder16Big    = kCGImageByteOrder16Big,</span><br><span class="line">    kCGBitmapByteOrder32Big    = kCGImageByteOrder32Big</span><br><span class="line">&#125; <span class="built_in">CG_AVAILABLE_STARTING</span>(<span class="number">10.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure><p>å®ƒä¸»è¦æä¾›äº†ä¸‰ä¸ªæ–¹é¢çš„å¸ƒå±€ä¿¡æ¯ï¼š</p><ul><li>alpha çš„ä¿¡æ¯ CGImageAlphaInfoï¼›</li><li>é¢œè‰²åˆ†é‡æ˜¯å¦ä¸ºæµ®ç‚¹æ•°ï¼›</li><li>åƒç´ æ ¼å¼çš„å­—èŠ‚é¡ºåº Byte Orderingã€‚</li></ul><h4 id="é€æ˜ä¿¡æ¯-CGImageAlphaInfo"><a href="#é€æ˜ä¿¡æ¯-CGImageAlphaInfo" class="headerlink" title="é€æ˜ä¿¡æ¯ CGImageAlphaInfo"></a>é€æ˜ä¿¡æ¯ CGImageAlphaInfo</h4><p>å…¶ä¸­ï¼Œalpha çš„ä¿¡æ¯ç”±æšä¸¾å€¼ CGImageAlphaInfo æ¥è¡¨ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_ENUM</span>(uint32_t, <span class="built_in">CGImageAlphaInfo</span>) &#123;</span><br><span class="line">    kCGImageAlphaNone,               <span class="comment">/* For example, RGB. */</span></span><br><span class="line">    kCGImageAlphaPremultipliedLast,  <span class="comment">/* For example, premultiplied RGBA */</span></span><br><span class="line">    kCGImageAlphaPremultipliedFirst, <span class="comment">/* For example, premultiplied ARGB */</span></span><br><span class="line">    kCGImageAlphaLast,               <span class="comment">/* For example, non-premultiplied RGBA */</span></span><br><span class="line">    kCGImageAlphaFirst,              <span class="comment">/* For example, non-premultiplied ARGB */</span></span><br><span class="line">    kCGImageAlphaNoneSkipLast,       <span class="comment">/* For example, RBGX. */</span></span><br><span class="line">    kCGImageAlphaNoneSkipFirst,      <span class="comment">/* For example, XRGB. */</span></span><br><span class="line">    kCGImageAlphaOnly                <span class="comment">/* No color data, alpha data only */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ³¨é‡Šå…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œå®ƒåŒæ ·ä¹Ÿæä¾›äº†ä¸‰ä¸ªæ–¹é¢çš„ alpha ä¿¡æ¯ï¼š</p><ul><li>æ˜¯å¦åŒ…å« alpha ï¼›</li><li>å¦‚æœåŒ…å« alpha ï¼Œé‚£ä¹ˆ alpha ä¿¡æ¯æ‰€å¤„çš„ä½ç½®ï¼Œåœ¨åƒç´ çš„æœ€ä½æœ‰æ•ˆä½ï¼Œæ¯”å¦‚ RGBA ï¼Œè¿˜æ˜¯æœ€é«˜æœ‰æ•ˆä½ï¼Œæ¯”å¦‚ ARGB ï¼›</li><li>å¦‚æœåŒ…å« alpha ï¼Œé‚£ä¹ˆæ¯ä¸ªé¢œè‰²åˆ†é‡æ˜¯å¦å·²ç»ä¹˜ä»¥ alpha çš„å€¼ï¼Œè¿™ç§åšæ³•å¯ä»¥åŠ é€Ÿå›¾ç‰‡çš„æ¸²æŸ“æ—¶é—´ï¼Œå› ä¸ºå®ƒé¿å…äº†æ¸²æŸ“æ—¶çš„é¢å¤–ä¹˜æ³•è¿ç®—ã€‚æ¯”å¦‚ï¼Œå¯¹äº RGB é¢œè‰²ç©ºé—´ï¼Œç”¨å·²ç»ä¹˜ä»¥ alpha çš„æ•°æ®æ¥æ¸²æŸ“å›¾ç‰‡ï¼Œæ¯ä¸ªåƒç´ éƒ½å¯ä»¥é¿å… 3 æ¬¡ä¹˜æ³•è¿ç®—ï¼Œçº¢è‰²ä¹˜ä»¥ alpha ï¼Œç»¿è‰²ä¹˜ä»¥ alpha å’Œè“è‰²ä¹˜ä»¥ alpha ã€‚</li></ul><h4 id="å­—èŠ‚é¡ºåº-CGImageByteOrderInfo"><a href="#å­—èŠ‚é¡ºåº-CGImageByteOrderInfo" class="headerlink" title="å­—èŠ‚é¡ºåº CGImageByteOrderInfo"></a>å­—èŠ‚é¡ºåº CGImageByteOrderInfo</h4><p>å­—èŠ‚çš„æ’åˆ—æ–¹å¼æœ‰ä¸¤ä¸ªé€šç”¨è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤šä½çš„æ•´æ•°ï¼ŒæŒ‰ç…§å­˜å‚¨åœ°å€ä»ä½åˆ°é«˜æ’åºçš„å­—èŠ‚ä¸­ï¼Œå¦‚æœè¯¥æ•´æ•°çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚ï¼ˆç±»ä¼¼äºæœ€ä½æœ‰æ•ˆä½ï¼‰åœ¨æœ€é«˜æœ‰æ•ˆå­—èŠ‚çš„å‰é¢ï¼Œåˆ™ç§°å°ç«¯åºï¼›åä¹‹åˆ™ç§°å¤§ç«¯åºã€‚</p><p><a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFMemoryMgmt/Concepts/ByteOrdering.html#//apple_ref/doc/uid/20001150-CJBEJBHH" target="_blank" rel="noopener">å­—èŠ‚é¡ºåº</a>çš„ä¿¡æ¯ç”±æšä¸¾å€¼ CGImageByteOrderInfo æ¥è¡¨ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_ENUM</span>(uint32_t, <span class="built_in">CGImageByteOrderInfo</span>) &#123;</span><br><span class="line">    kCGImageByteOrderMask     = <span class="number">0x7000</span>,</span><br><span class="line">    kCGImageByteOrder16Little = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder32Little = (<span class="number">2</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder16Big    = (<span class="number">3</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder32Big    = (<span class="number">4</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line">&#125; <span class="built_in">CG_AVAILABLE_STARTING</span>(__MAC_10_12, __IPHONE_10_0);</span><br></pre></td></tr></table></figure><p>å®ƒä¸»è¦æä¾›äº†ä¸¤ä¸ªæ–¹é¢çš„å­—èŠ‚é¡ºåºä¿¡æ¯ï¼š</p><ul><li>å°ç«¯åºè¿˜æ˜¯å¤§ç«¯åºï¼›</li><li>æ•°æ®ä»¥ 16 ä½è¿˜æ˜¯ 32 ä½ä¸ºå•ä½ã€‚</li></ul><p>ä¸‹å›¾è¡¨ç¤ºäº† Quartz 2Dä¸­CMYKå’ŒRGBé¢œè‰²ç©ºé—´çš„32ä½å’Œ16ä½åƒç´ æ ¼å¼<br><img src="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Art/colorformatrgba32.gif" alt></p><h3 id="æ”¯æŒçš„åƒç´ æ ¼å¼"><a href="#æ”¯æŒçš„åƒç´ æ ¼å¼" class="headerlink" title="æ”¯æŒçš„åƒç´ æ ¼å¼"></a>æ”¯æŒçš„åƒç´ æ ¼å¼</h3><p>ä¸‹è¡¨è¡¨ç¤ºäº†ä½å›¾å›¾å½¢ä¸Šä¸‹æ–‡æ”¯æŒçš„åƒç´ æ ¼å¼ï¼Œå…³è”çš„è‰²å½©ç©ºé—´ <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB" target="_blank" rel="noopener">Supported Pixel Formats</a>ï¼š</p><table><thead><tr><th style="text-align:left">cs</th><th style="text-align:center">Pixel format and bitmap information constant</th><th style="text-align:right">Availability</th></tr></thead><tbody><tr><td style="text-align:left">Null</td><td style="text-align:center">8 bpp, 8 bpc, kCGImageAlphaOnly</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">Gray</td><td style="text-align:center">8 bpp, 8 bpc,kCGImageAlphaNone</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">Gray</td><td style="text-align:center">8 bpp, 8 bpc,kCGImageAlphaOnly</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">Gray</td><td style="text-align:center">16 bpp, 16 bpc, kCGImageAlphaNone</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">Gray</td><td style="text-align:center">32 bpp, 32 bpc, kCGImageAlphaNoneæˆ–kCGBitmapFloatComponents`</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">16 bpp, 5 bpc, kCGImageAlphaNoneSkipFirst</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNoneSkipFirst</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNoneSkipLast</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaPremultipliedFirst</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaPremultipliedLast</td><td style="text-align:right">Mac OS X, iOS</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaPremultipliedLast</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaNoneSkipLast</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaNoneSkipLast æˆ–kCGBitmapFloatComponents</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">RGB</td><td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaPremultipliedLast æˆ–kCGBitmapFloatComponents</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">CMYK</td><td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNone</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">CMYK</td><td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaNone</td><td style="text-align:right">Mac OS X</td></tr><tr><td style="text-align:left">CMYK</td><td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaNone æˆ–kCGBitmapFloatComponents</td><td style="text-align:right">Mac OS X</td></tr></tbody></table><p>å¯¹äº iOS æ¥è¯´ï¼Œåªæ”¯æŒ 8 ç§åƒç´ æ ¼å¼ã€‚å…¶ä¸­é¢œè‰²ç©ºé—´ä¸º Null çš„ 1 ç§ï¼ŒGray çš„ 2 ç§ï¼ŒRGB çš„ 5 ç§ï¼ŒCMYK çš„ 0 ç§ã€‚æ¢å¥è¯è¯´ï¼ŒiOS å¹¶ä¸æ”¯æŒ CMYK çš„é¢œè‰²ç©ºé—´</p><h2 id="CGBitmapContextCreate"><a href="#CGBitmapContextCreate" class="headerlink" title="CGBitmapContextCreate"></a>CGBitmapContextCreate</h2><p>ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šå‚æ•°ï¼Œé‚£ä¹ˆé‚£ä¸ªå‡½æ•°ä¼šç”¨åˆ°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>CGBitmapContextCreate</code> :</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Create a bitmap context. The context draws into a bitmap which is `width'</span></span><br><span class="line"><span class="comment">   pixels wide and `height' pixels high. The number of components for each</span></span><br><span class="line"><span class="comment">   pixel is specified by `space', which may also specify a destination color</span></span><br><span class="line"><span class="comment">   profile. The number of bits for each component of a pixel is specified by</span></span><br><span class="line"><span class="comment">   `bitsPerComponent'. The number of bytes per pixel is equal to</span></span><br><span class="line"><span class="comment">   `(bitsPerComponent * number of components + 7)/8'. Each row of the bitmap</span></span><br><span class="line"><span class="comment">   consists of `bytesPerRow' bytes, which must be at least `width * bytes</span></span><br><span class="line"><span class="comment">   per pixel' bytes; in addition, `bytesPerRow' must be an integer multiple</span></span><br><span class="line"><span class="comment">   of the number of bytes per pixel. `data', if non-NULL, points to a block</span></span><br><span class="line"><span class="comment">   of memory at least `bytesPerRow * height' bytes. If `data' is NULL, the</span></span><br><span class="line"><span class="comment">   data for context is allocated automatically and freed when the context is</span></span><br><span class="line"><span class="comment">   deallocated. `bitmapInfo' specifies whether the bitmap should contain an</span></span><br><span class="line"><span class="comment">   alpha channel and how it's to be generated, along with whether the</span></span><br><span class="line"><span class="comment">   components are floating-point or integer. */</span></span><br><span class="line"><span class="built_in">CG_EXTERN</span> <span class="built_in">CGContextRef</span> __<span class="keyword">nullable</span> <span class="built_in">CGBitmapContextCreate</span>(<span class="keyword">void</span> * __<span class="keyword">nullable</span> data,</span><br><span class="line">    size_t width, size_t height, size_t bitsPerComponent, size_t bytesPerRow,</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> cg_nullable space, uint32_t bitmapInfo)</span><br><span class="line">    <span class="built_in">CG_AVAILABLE_STARTING</span>(__MAC_10_0, __IPHONE_2_0);</span><br></pre></td></tr></table></figure><p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä½å›¾ä¸Šä¸‹æ–‡ï¼Œç”¨æ¥ç»˜åˆ¶ä¸€å¼ å®½ width åƒç´ ï¼Œé«˜ height åƒç´ çš„ä½å›¾ã€‚å„å‚æ•°ä½¿ç”¨å¦‚ä¸‹ï¼š</p><ul><li>data ï¼šå¦‚æœä¸ä¸º NULL ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æŒ‡å‘ä¸€å—å¤§å°è‡³å°‘ä¸º bytesPerRow * height å­—èŠ‚çš„å†…å­˜ï¼›å¦‚æœ ä¸º NULL ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾æ‰€éœ€çš„å†…å­˜ï¼Œæ‰€ä»¥ä¸€èˆ¬æŒ‡å®š NULL å³å¯ï¼›</li><li>width å’Œ height ï¼šä½å›¾çš„å®½åº¦å’Œé«˜åº¦ï¼Œåˆ†åˆ«èµ‹å€¼ä¸ºå›¾ç‰‡çš„åƒç´ å®½åº¦å’Œåƒç´ é«˜åº¦å³å¯ï¼›</li><li>bitsPerComponent ï¼šåƒç´ çš„æ¯ä¸ªé¢œè‰²åˆ†é‡ä½¿ç”¨çš„ bit æ•°ï¼Œåœ¨ RGB é¢œè‰²ç©ºé—´ä¸‹æŒ‡å®š 8 å³å¯ï¼›</li><li>bytesPerPixelï¼šè¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹æœ‰å¤šå°‘ä¸ªå­—èŠ‚ç»„æˆï¼Œä¸Šé¢çš„æ–¹æ³•æ³¨é‡Šä¸­æåˆ°äº†ä¸€ä¸ªå…¬å¼ <code>(bitsPerComponent * number of components + 7)/8</code>ï¼Œå³ä¸€ä¸ªåƒç´ ç‚¹çš„å­—èŠ‚æ•°é‡ä¸è¡¨ç¤ºå½“å‰å›¾åƒçš„é¢œè‰²çš„é¢œè‰²åˆ†é‡æ•°é‡å’Œæ¯ä¸ªåˆ†é‡çš„ä½æ•°æœ‰å…³</li><li>bytesPerRow ï¼šä½å›¾çš„æ¯ä¸€è¡Œä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¤§å°è‡³å°‘ä¸º width * bytes per pixel å­—èŠ‚ã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå½“æˆ‘ä»¬æŒ‡å®š 0 æ—¶ï¼Œç³»ç»Ÿä¸ä»…ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨è®¡ç®—ï¼Œè€Œä¸”è¿˜ä¼šè¿›è¡Œ cache line alignment çš„ä¼˜åŒ–</li><li>space ï¼šå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„é¢œè‰²ç©ºé—´ï¼Œä¸€èˆ¬ä½¿ç”¨ RGB å³å¯ï¼›</li><li>bitmapInfo ï¼šå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ä½å›¾çš„å¸ƒå±€ä¿¡æ¯ã€‚</li></ul><p>æ–‡ç« å¼€å¤´è¯´ <code>è§£å‹ç¼©åçš„å›¾ç‰‡å¤§å° = å›¾ç‰‡çš„åƒç´ å®½ 34 * å›¾ç‰‡çš„åƒç´ é«˜ 34 * æ¯ä¸ªåƒç´ æ‰€å çš„å­—èŠ‚æ•°4</code> ; æˆ‘ä»¬çš„æ‰‹æœºä¸€èˆ¬æ”¯æŒ RGB é¢œè‰²ç©ºé—´ï¼Œç°åœ¨å°±æ˜¯çŸ¥é“äº† RGB é¢œè‰²ç©ºé—´ä¸­ï¼Œå®é™…ä¸Šæ˜¯æœ‰ 4 ä¸ªåˆ†é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®—å‡º bytesPerPixel = (8 * 4 + 7)/8 = 4Bã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆæœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬è®¡ç®—ä½å›¾çš„å¤§å°çš„æ—¶å€™ï¼Œæ¯ä¸ªåƒç´ çš„å¤§å°æˆ‘ä»¬ä½¿ç”¨çš„å€¼æ˜¯ 4B äº†ã€‚äº‹å®ä¸Šä¸åŒçš„é¢œè‰²ç©ºé—´ä¸‹ï¼Œä¸Šé¢è¿™äº›å€¼éƒ½æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯ä¸€èˆ¬åœ¨æ‰‹æœºä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨ RGB é¢œè‰²ç©ºé—´ï¼Œæ‰€ä»¥å·®ä¸å¤šå°±æ˜¯ä¸Šé¢çš„å€¼ã€‚</p><h3 id="YYImageä¸­ä½¿ç”¨"><a href="#YYImageä¸­ä½¿ç”¨" class="headerlink" title="YYImageä¸­ä½¿ç”¨"></a>YYImageä¸­ä½¿ç”¨</h3><p>ç°åœ¨æ¥çœ‹ä¸‹YYImageä¸­çš„è§£ç ä»£ç  ï¼Œå…ˆä½¿ç”¨ <code>CGBitmapContextCreate</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªä½å›¾ä¸Šä¸‹æ–‡ï¼›å†ç”¨ <code>CGContextDrawImage</code> å‡½æ•°å°†åŸå§‹ä½å›¾ç»˜åˆ¶åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼›æœ€åä½¿ç”¨ <code>CGBitmapContextCreateImage</code> å‡½æ•°åˆ›å»ºä¸€å¼ æ–°çš„è§£å‹ç¼©åçš„ä½å›¾ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">CGImageRef</span> YYCGImageCreateDecodedCopy(<span class="built_in">CGImageRef</span> imageRef, <span class="built_in">BOOL</span> decodeForDisplay) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (decodeForDisplay) &#123; <span class="comment">//decode with redraw (may lose some precision)</span></span><br><span class="line">        <span class="built_in">CGImageAlphaInfo</span> alphaInfo = <span class="built_in">CGImageGetAlphaInfo</span>(imageRef) &amp; kCGBitmapAlphaInfoMask;</span><br><span class="line">        <span class="built_in">BOOL</span> hasAlpha = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">if</span> (alphaInfo == kCGImageAlphaPremultipliedLast ||</span><br><span class="line">            alphaInfo == kCGImageAlphaPremultipliedFirst ||</span><br><span class="line">            alphaInfo == kCGImageAlphaLast ||</span><br><span class="line">            alphaInfo == kCGImageAlphaFirst) &#123;</span><br><span class="line">            hasAlpha = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// BGRA8888 (premultiplied) or BGRX8888</span></span><br><span class="line">        <span class="comment">// same as UIGraphicsBeginImageContext() and -[UIView drawRect:]</span></span><br><span class="line">        <span class="built_in">CGBitmapInfo</span> bitmapInfo = kCGBitmapByteOrder32Host;</span><br><span class="line">        bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;</span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>, width, height, <span class="number">8</span>, <span class="number">0</span>, YYCGColorSpaceGetDeviceRGB(), bitmapInfo);</span><br><span class="line">        <span class="keyword">if</span> (!context) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), imageRef); <span class="comment">// decode</span></span><br><span class="line">        <span class="built_in">CGImageRef</span> newImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">        <span class="built_in">CFRelease</span>(context);</span><br><span class="line">        <span class="keyword">return</span> newImage;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SDWebImageä¸­ä½¿ç”¨"><a href="#SDWebImageä¸­ä½¿ç”¨" class="headerlink" title="SDWebImageä¸­ä½¿ç”¨"></a>SDWebImageä¸­ä½¿ç”¨</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)decodedImageWithImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="built_in">UIImage</span> shouldDecodeImage:image]) &#123;</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// autorelease the bitmap context and all vars to help system to free memory when there are memory warning.</span></span><br><span class="line">    <span class="comment">// on iOS7, do not forget to call [[SDImageCache sharedImageCache] clearMemory];</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGImageRef</span> imageRef = image.CGImage;</span><br><span class="line">        <span class="built_in">CGColorSpaceRef</span> colorspaceRef = [<span class="built_in">UIImage</span> colorSpaceForImageRef:imageRef];</span><br><span class="line">        </span><br><span class="line">        size_t width = <span class="built_in">CGImageGetWidth</span>(imageRef);</span><br><span class="line">        size_t height = <span class="built_in">CGImageGetHeight</span>(imageRef);</span><br><span class="line">        size_t bytesPerRow = kBytesPerPixel * width;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// kCGImageAlphaNone is not supported in CGBitmapContextCreate.</span></span><br><span class="line">        <span class="comment">// Since the original image here has no alpha info, use kCGImageAlphaNoneSkipLast</span></span><br><span class="line">        <span class="comment">// to create bitmap graphics contexts without alpha info.</span></span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>,</span><br><span class="line">                                                     width,</span><br><span class="line">                                                     height,</span><br><span class="line">                                                     kBitsPerComponent,</span><br><span class="line">                                                     bytesPerRow,</span><br><span class="line">                                                     colorspaceRef,</span><br><span class="line">                                                     kCGBitmapByteOrderDefault|kCGImageAlphaNoneSkipLast);</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> image;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Draw the image into the context and retrieve the new bitmap image without alpha</span></span><br><span class="line">        <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), imageRef);</span><br><span class="line">        <span class="built_in">CGImageRef</span> imageRefWithoutAlpha = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">        <span class="built_in">UIImage</span> *imageWithoutAlpha = [<span class="built_in">UIImage</span> imageWithCGImage:imageRefWithoutAlpha</span><br><span class="line">                                                         scale:image.scale</span><br><span class="line">                                                   orientation:image.imageOrientation];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">        <span class="built_in">CGImageRelease</span>(imageRefWithoutAlpha);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> imageWithoutAlpha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)shouldDecodeImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="comment">// Prevent "CGBitmapContextCreateImage: invalid context 0x0" error</span></span><br><span class="line">    <span class="keyword">if</span> (image == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do not decode animated images</span></span><br><span class="line">    <span class="keyword">if</span> (image.images != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRef</span> imageRef = image.CGImage;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageAlphaInfo</span> alpha = <span class="built_in">CGImageGetAlphaInfo</span>(imageRef);</span><br><span class="line">    <span class="built_in">BOOL</span> anyAlpha = (alpha == kCGImageAlphaFirst ||</span><br><span class="line">                     alpha == kCGImageAlphaLast ||</span><br><span class="line">                     alpha == kCGImageAlphaPremultipliedFirst ||</span><br><span class="line">                     alpha == kCGImageAlphaPremultipliedLast);</span><br><span class="line">    <span class="comment">// do not decode images with alpha</span></span><br><span class="line">    <span class="keyword">if</span> (anyAlpha) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SDWebImage ä¸­å’Œå…¶ä»–ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œå°±æ˜¯å¦‚æœä¸€å¼ å›¾ç‰‡æœ‰ alpha åˆ†é‡ï¼Œé‚£å°±ç›´æ¥è¿”å›åŸå§‹å›¾ç‰‡ï¼Œä¸å†è¿›è¡Œè§£ç æ“ä½œã€‚æˆ‘çŒœæµ‹ä½œè€…è¿™æ ·å†™ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºè§‰å¾—å¯¹äºæœ‰ alpha åˆ†é‡çš„å›¾ç‰‡ï¼Œå› ä¸ºä¸Šä¸‹æ–‡åˆ›å»ºä¸­é‚£äº›å‚æ•°çš„ç¼˜æ•…ï¼Œè§£ç ä¹‹åå¯èƒ½ä¼šä¸åŸå§‹å›¾åƒæœ‰åå·®ï¼Œå¹²è„†å°±ä¸è§£ç äº†ã€‚</p><p>SDWebImage åœ¨è§£ç æ“ä½œå¤–é¢åŒ…äº† autoreleasepoolï¼Œè¿™æ ·åœ¨å¤§é‡å›¾ç‰‡éœ€è¦è§£ç çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿å¾—å±€éƒ¨å˜é‡å°½æ—©é‡Šæ”¾æ‰ï¼Œä¸ä¼šé€ æˆå†…å­˜å³°å€¼è¿‡é«˜ã€‚å…¶ä»–åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œç„¶åè°ƒç”¨ CGContextDrawImageï¼Œå†è°ƒç”¨CGBitmapContextCreateImageè·å–åˆ›å»ºåçš„ä½å›¾ï¼Œå’Œ YYImage åŸºæœ¬ä¸€æ ·ï¼Œå°±æ˜¯ä¸ªåˆ«å‚æ•°è®¾ç½®ä¸åŒã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»‹ç»ä¸‹å‡ ç§iOSä¸­ä½å›¾ä¿¡æ¯ ä¸ç›¸å…³è§£å‹ç¼©&lt;br&gt;ref &lt;a href=&quot;http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;è°ˆè°ˆ iOS ä¸­å›¾ç‰‡çš„è§£å‹ç¼©&lt;/a&gt;&lt;br&gt;ref &lt;a href=&quot;https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007533-SW1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Quartz 2D Programming Guide&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æˆ‘ä»¬ä»ç½‘ç»œä¸‹è½½æˆ–è€…ä»æœ¬åœ°ç£ç›˜åŠ è½½ä¸€å¼ å›¾ç‰‡åˆ°å±å¹•ä¸Šæ˜¾ç¤ºï¼Œè¦ç»è¿‡å›¾ç‰‡çš„è§£ç è¿‡ç¨‹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¸€èˆ¬çš„å›¾ç‰‡æ ¼å¼ä¾‹å¦‚ JPEGï¼ŒPNGéƒ½æ˜¯ç»è¿‡å‹ç¼©åçš„å›¾ç‰‡ï¼Œè€Œæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å›¾ç‰‡å«åšä½å›¾(bitmap)ï¼Œæ‰€è°“çš„è§£ç å°±æ˜¯æŠŠå‹ç¼©åçš„å›¾ç‰‡å˜æˆä½å›¾ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºä»€ä¹ˆéè¦è§£ç æˆä½å›¾æ‰èƒ½æ˜¾ç¤ºå‘¢ï¼Ÿå› ä¸ºä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨å±å¹•ä¸Šæ¸²æŸ“æ•´å¼ å›¾ç‰‡äº†ã€‚&lt;/p&gt;
&lt;p&gt;é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸åŒæ ¼å¼çš„å„ç§å›¾ç‰‡å‘¢ï¼Ÿç›´æ¥å…¨éƒ¨ç”¨ä½å›¾ä¸å°±å¥½äº†ï¼Ÿé‚£ä¸å°±ä¸éœ€è¦æ¯æ¬¡è§£ç äº†ï¼Ÿé‚£äº›JPEGä»¥åŠPNGç­‰å…¶å®éƒ½æ˜¯å›¾åƒçš„å‹ç¼©æ ¼å¼ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å‹ç¼©çš„æ„æ€å°±æ˜¯å‡å°ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œä½¿ç”¨è¿™äº›æ ¼å¼çš„åŸå› å°±æ˜¯ä½å›¾å®åœ¨å¤ªå¤§äº†ã€‚&lt;/p&gt;
&lt;h2 id=&quot;å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–&quot;&gt;&lt;a href=&quot;#å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–&quot; class=&quot;headerlink&quot; title=&quot;å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–&quot;&gt;&lt;/a&gt;å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–&lt;/h2&gt;
    
    </summary>
    
      <category term="iOSå›¾ç‰‡" scheme="https://developerdoc.com/categories/iOS%E5%9B%BE%E7%89%87/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="å›¾ç‰‡" scheme="https://developerdoc.com/tags/%E5%9B%BE%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡-æœ€ä½³å®è·µ</title>
    <link href="https://developerdoc.com/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/"/>
    <id>https://developerdoc.com/quick-start/å›¾ç‰‡/iOSå›¾ç‰‡-æœ€ä½³å®è·µ/</id>
    <published>2019-12-09T08:00:37.000Z</published>
    <updated>2020-01-15T09:30:19.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»‹ç»ä¸‹ wwdc 2018 Image and Graphics Best Practices ä¸­å›¾ç‰‡å¤„ç†è§£å‹ç›¸å…³çŸ¥è¯†ç‚¹<br>ref: <a href="https://developer.apple.com/videos/play/wwdc2018/219" target="_blank" rel="noopener">Image and Graphics Best Practices</a></p></blockquote><h2 id="å›¾ç‰‡å¤„ç†è¿‡ç¨‹"><a href="#å›¾ç‰‡å¤„ç†è¿‡ç¨‹" class="headerlink" title="å›¾ç‰‡å¤„ç†è¿‡ç¨‹"></a>å›¾ç‰‡å¤„ç†è¿‡ç¨‹</h2><p>ä¸€å¼ å›¾ç‰‡ä»ç£ç›˜ä¸­æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼šä»ç£ç›˜åŠ è½½åŸå§‹å‹ç¼©çš„å›¾ç‰‡ä¿¡æ¯ã€è§£ç äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®ä¸ºä½å›¾ã€æ¸²æŸ“å›¾ç‰‡æœ€ç»ˆç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</p><!-- ![](/res/imgBestP/imgBestP1.png) --><p><img src="/res/imgBestP/imgBestP1.png" width="80%"></p><p>åœ¨å®é™…çš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼ŒUIImageè´Ÿè´£è§£å‹Data Bufferå†…å®¹å¹¶ç”³è¯·bufferï¼ˆImage Bufferï¼‰å­˜å‚¨è§£å‹åçš„å›¾ç‰‡ä¿¡æ¯ï¼Œç„¶åUIImageViewè´Ÿè´£å°†Image Buffer æ‹·è´è‡³ framebufferï¼Œç”¨äºç»™æ˜¾ç¤ºç¡¬ä»¶æä¾›é¢œè‰²ä¿¡æ¯ã€‚</p><p>è§£å‹è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¤§é‡å ç”¨CPUèµ„æºçš„å·¥ä½œï¼Œå› æ­¤UIImage ä¼šretainå­˜å‚¨è§£å‹åä¿¡æ¯çš„Image Bufferä»¥ä¾¿ç»™é‡å¤çš„æ¸²æŸ“å·¥ä½œæä¾›ä¿¡æ¯ï¼ŒImage Bufferä¸å›¾ç‰‡çš„å®é™…å°ºå¯¸æœ‰å…³ï¼ˆç†è®ºå€¼ä¸ºheight <em> width </em> 4 bytesï¼‰ï¼Œä¸å›¾ç‰‡æ–‡ä»¶å¤§å°æ— å…³ã€‚è‹¥æ˜¯åœ¨TableViewç­‰åˆ—è¡¨ä¸­è¿ç»­åŠ è½½å¤šå¼ å›¾ç‰‡ï¼Œä¾¿ä¼šå¼•å‘è¿ç»­çš„å¤§å—å†…å­˜åˆ†é…ï¼Œè¿™å°†å¯¹Memoryå’ŒCPUå¸¦æ¥æ²‰é‡çš„è´Ÿæ‹…ã€‚</p><a id="more"></a><h3 id="Data-Buffer-Image-Buffer-Frame-Buffer"><a href="#Data-Buffer-Image-Buffer-Frame-Buffer" class="headerlink" title="Data Buffer / Image Buffer / Frame Buffer"></a>Data Buffer / Image Buffer / Frame Buffer</h3><p>å›¾ç‰‡å¤„ç†è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸‰ç§buffer</p><h4 id="Data-Buffer"><a href="#Data-Buffer" class="headerlink" title="Data Buffer"></a>Data Buffer</h4><!-- ![](/res/imgBestP/imgBestP2.png) --><p><img src="/res/imgBestP/imgBestP2.png" width="80%"><br>Data Bufferå­˜å‚¨äº†å›¾ç‰‡çš„å…ƒæ•°æ®ï¼Œæˆ‘ä»¬å¸¸è§çš„å›¾ç‰‡æ ¼å¼ï¼Œjpegï¼Œpngç­‰éƒ½æ˜¯å‹ç¼©å›¾ç‰‡æ ¼å¼ã€‚Data Bufferçš„å†…å­˜å¤§å°å°±æ˜¯æºå›¾ç‰‡åœ¨ç£ç›˜ä¸­çš„å¤§å°ã€‚</p><h4 id="Image-Buffer"><a href="#Image-Buffer" class="headerlink" title="Image Buffer"></a>Image Buffer</h4><!-- ![](/res/imgBestP/imgBestP3.png) --><p><img src="/res/imgBestP/imgBestP3.png" width="80%"><br>Image Bufferå­˜å‚¨çš„å°±æ˜¯å›¾ç‰‡è§£ç åçš„åƒç´ æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä½å›¾ã€‚ Bufferä¸­æ¯ä¸€ä¸ªå…ƒç´ æè¿°çš„ä¸€ä¸ªåƒç´ çš„é¢œè‰²ä¿¡æ¯ï¼Œbufferçš„sizeå’Œå›¾ç‰‡çš„sizeæˆæ­£ç›¸å…³å…³ç³»ã€‚</p><h4 id="Frame-Buffer"><a href="#Frame-Buffer" class="headerlink" title="Frame Buffer"></a>Frame Buffer</h4><!-- ![](/res/imgBestP/imgBestP4.png) --><p><img src="/res/imgBestP/imgBestP3.png" width="80%"></p><p>Frame Buffer å­˜å‚¨äº†appæ¯å¸§çš„å®é™…è¾“å‡ºã€‚åœ¨åº”ç”¨ç¨‹åºæ›´æ–°å›¾å±‚æ—¶ï¼ŒUIKitå°†windowåŠå…¶subviewsæ¸²æŸ“è‡³framebufferï¼Œè¿™ä¸ªframebufferæä¾›æ¯ä¸ªåƒç´ çš„ä¿¡æ¯ä»¥ä¾›æ˜¾ç¤ºç¡¬ä»¶å®šæ—¶è¯»å–ï¼Œè¯»å–çš„é¢‘ç‡ä¸€èˆ¬ä¸º60Hzï¼Œä½†åœ¨ipadä¸Šå¯æå‡è‡³120Hzã€‚</p><h3 id="åŠ è½½å’Œè§£å‹"><a href="#åŠ è½½å’Œè§£å‹" class="headerlink" title="åŠ è½½å’Œè§£å‹"></a>åŠ è½½å’Œè§£å‹</h3><p><img src="/res/imgBestP/imgBestP5.png" alt></p><p>ä¸€èˆ¬ä½¿ç”¨imageNamed:æˆ–è€…imageWithData:ä»å†…å­˜ä¸­åŠ è½½å›¾ç‰‡ç”ŸæˆUIImageçš„å®ä¾‹ï¼Œæ­¤åˆ»å›¾ç‰‡å¹¶ä¸ä¼šè§£å‹ï¼Œå½“ RunLoop å‡†å¤‡å¤„ç†å›¾ç‰‡æ˜¾ç¤ºçš„äº‹åŠ¡ï¼ˆCATransactionï¼‰æ—¶ï¼Œæ‰è¿›è¡Œè§£å‹ï¼Œè€Œè¿™ä¸ªè§£å‹è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œè¿™æ˜¯å¯¼è‡´å¡é¡¿çš„é‡è¦å› ç´ ã€‚</p><p>è§£ç åçš„å›¾ç‰‡å†…å­˜å ç”¨ä¼šæ¯”åŸå›¾å¤§å°å¤§å¾ˆå¤šã€‚ImageBufferæŒ‰ç…§æ¯ä¸ªåƒç´ RGBAå››ä¸ªå­—èŠ‚å¤§å°ï¼Œä¸€å¼ 1080pçš„å›¾ç‰‡è§£ç åçš„ä½å›¾å¤§å°æ˜¯1920 <em> 1080 </em> 4 / 1024 / 1024ï¼Œçº¦7.9mbï¼Œè€ŒåŸå›¾å‡è®¾æ˜¯jpgï¼Œå‹ç¼©æ¯”1æ¯”20ï¼Œå¤§çº¦350kbï¼Œå¯è§è§£ç åçš„å†…å­˜å ç”¨æ˜¯ç›¸å½“å¤§çš„</p><h4 id="imageNamed-æ–¹æ³•"><a href="#imageNamed-æ–¹æ³•" class="headerlink" title="imageNamed: æ–¹æ³•"></a>imageNamed: æ–¹æ³•</h4><p>é€šè¿‡ imageNamed åˆ›å»º UIImage æ—¶ï¼Œç³»ç»Ÿå®é™…ä¸Šåªæ˜¯åœ¨ Bundle å†…æŸ¥æ‰¾åˆ°æ–‡ä»¶åï¼Œç„¶åæŠŠè¿™ä¸ªæ–‡ä»¶åæ”¾åˆ° UIImage é‡Œè¿”å›ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œå®é™…çš„æ–‡ä»¶è¯»å–å’Œè§£ç ã€‚å½“ UIImage ç¬¬ä¸€æ¬¡æ˜¾ç¤ºåˆ°å±å¹•ä¸Šæ—¶ï¼Œå…¶å†…éƒ¨çš„è§£ç æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼ŒåŒæ—¶è§£ç ç»“æœä¼šä¿å­˜åˆ°ä¸€ä¸ªå…¨å±€ç¼“å­˜å»ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›ç¼“å­˜éƒ½æ˜¯å…¨å±€çš„ï¼Œå¹¶ä¸ä¼šå› ä¸ºå½“å‰UIImageå®ä¾‹çš„é‡Šæ”¾è€Œæ¸…é™¤ï¼Œåœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… APP ç¬¬ä¸€æ¬¡è¿›å…¥åå°æ‰æœ‰å¯èƒ½ä¼šæ¸…é™¤ï¼Œè€Œè¿™ä¸ªæ¸…é™¤çš„æ—¶æœºå’Œå†…å®¹æ˜¯ç³»ç»Ÿå†³å®šçš„ï¼Œæˆ‘ä»¬æ— æ³•å¹²æ¶‰ã€‚</p><h4 id="imageWithData-æ–¹æ³•"><a href="#imageWithData-æ–¹æ³•" class="headerlink" title="imageWithData: æ–¹æ³•"></a>imageWithData: æ–¹æ³•</h4><p>é€šè¿‡æ•°æ®åˆ›å»º UIImage æ—¶ï¼ŒUIImage åº•å±‚æ˜¯è°ƒç”¨ ImageIO çš„ CGImageSourceCreateWithData() æ–¹æ³•ã€‚è¯¥æ–¹æ³•æœ‰ä¸ªå‚æ•°å« ShouldCacheï¼Œåœ¨ 64 ä½çš„è®¾å¤‡ä¸Šï¼Œè¿™ä¸ªå‚æ•°æ˜¯é»˜è®¤å¼€å¯çš„ã€‚è¿™ä¸ªå›¾ç‰‡ä¹Ÿæ˜¯åŒæ ·åœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºåˆ°å±å¹•æ—¶æ‰ä¼šè¢«è§£ç ï¼Œéšåè§£ç æ•°æ®è¢«ç¼“å­˜åˆ° CGImage å†…éƒ¨ã€‚ä¸ imageNamed åˆ›å»ºçš„å›¾ç‰‡ä¸åŒï¼Œå¦‚æœè¿™ä¸ªå›¾ç‰‡è¢«é‡Šæ”¾æ‰ï¼Œå…¶å†…éƒ¨çš„è§£ç æ•°æ®ä¹Ÿä¼šè¢«ç«‹åˆ»é‡Šæ”¾ã€‚</p><p><strong>ä¸¤ç§åŠ è½½æ–¹å¼çš„åŒºåˆ«</strong> ä»ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼ŒimageNamed:ä½¿ç”¨æ—¶ä¼šäº§ç”Ÿå…¨å±€çš„å†…å­˜å ç”¨ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡ä½¿ç”¨åŒä¸€å¼ å›¾ç‰‡æ—¶æ€§èƒ½å¾ˆå¥½ï¼›imageWithData:ä¸ä¼šæœ‰å…¨å±€çš„å†…å­˜å ç”¨ï¼Œä½†å¯¹äºåŒä¸€å¼ å›¾ç‰‡æ¯æ¬¡åŠ è½½å’Œè§£å‹éƒ½ä¼šâ€œä»å¤´å¼€å§‹â€ã€‚ç”±æ­¤å¯è§ï¼ŒimageNamed:é€‚åˆâ€œå°â€ä¸”â€œä½¿ç”¨é¢‘ç¹â€çš„å›¾ç‰‡ï¼ŒimageWithData:é€‚åˆâ€œå¤§â€ä¸”â€œä½é¢‘ä½¿ç”¨â€çš„å›¾ç‰‡ã€‚</p><h4 id="æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ"><a href="#æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ" class="headerlink" title="æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ"></a>æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ</h4><ol><li>æ‰‹åŠ¨è°ƒç”¨ CGImageSourceCreateWithData() æ¥åˆ›å»ºå›¾ç‰‡ï¼Œå¹¶æŠŠ ShouldCache å’Œ ShouldCacheImmediately å…³æ‰ã€‚è¿™ä¹ˆåšä¼šå¯¼è‡´æ¯æ¬¡å›¾ç‰‡æ˜¾ç¤ºåˆ°å±å¹•æ—¶ï¼Œè§£ç æ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨ï¼Œé€ æˆå¾ˆå¤§çš„ CPU å ç”¨ã€‚</li><li>æŠŠå›¾ç‰‡ç”¨ CGContextDrawImage() ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Šï¼Œç„¶åæŠŠç”»å¸ƒçš„æ•°æ®å–å‡ºæ¥å½“ä½œå›¾ç‰‡ã€‚è¿™ä¹Ÿæ˜¯å¸¸è§çš„ç½‘ç»œå›¾ç‰‡åº“çš„åšæ³•ã€‚</li></ol><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾"><a href="#å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾" class="headerlink" title="å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾"></a>å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾</h3><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯èƒ½ä¸šåŠ¡ä¸­éœ€è¦è½½å…¥ä¸€å¼ å¾ˆå¤§çš„å›¾ç‰‡ã€‚è¿™æ—¶ï¼Œè‹¥è¿˜ä½¿ç”¨å¸¸è§„çš„æ–¹å¼åŠ è½½ä¼šå ç”¨è¿‡å¤šçš„å†…å­˜ï¼›å†µä¸”ï¼Œè‹¥å›¾ç‰‡çš„åƒç´ è¿‡å¤§ï¼ˆç›®å‰ä¸»æµ iOS è®¾å¤‡æœ€é«˜æ”¯æŒ 4096 x 4096 çº¹ç†å°ºå¯¸ï¼‰ï¼Œåœ¨æ˜¾ç¤ºçš„æ—¶å€™ CPU å’Œ GPU éƒ½ä¼šæ¶ˆè€—é¢å¤–çš„èµ„æºæ¥å¤„ç†å›¾ç‰‡ã€‚å¯ä»¥é‡‡ç”¨imageIO apiæ¥ç”Ÿæˆç¼©ç•¥å›¾</p><p><img src="/res/imgBestP/imgBestP6.png" alt></p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼ŒæŒ‡å®šæ˜¾ç¤ºåŒºåŸŸå¤§å°</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func downsample(imageAt imageURL:URL,to pointSize:<span class="built_in">CGSize</span>,scale:<span class="built_in">CGFloat</span>)-&gt;<span class="built_in">UIImage</span>&#123;</span><br><span class="line"><span class="comment">//è®¾ç½®kCGImageSourceShouldCacheä¸ºfalseï¼Œé¿å…ç¼“å­˜è§£ç åçš„æ•°æ®ï¼Œ64ä½è®¾ç½®ä¸Šé»˜è®¤æ˜¯å¼€å¯ç¼“å­˜çš„</span></span><br><span class="line">    let imageSourceOptions = [kCGImageSourceShouldCache:<span class="literal">false</span>] as <span class="built_in">CFDictionary</span></span><br><span class="line">    let imageSouce = <span class="built_in">CGImageSourceCreateWithURL</span>(imageURL as <span class="built_in">CFURL</span>, imageSourceOptions)!</span><br><span class="line">    </span><br><span class="line">    let maxDimensionInPixels = max(pointSize.width,pointSize.height) * scale</span><br><span class="line"><span class="comment">//è®¾ç½®kCGImageSourceShouldCacheImmediatelyä¸ºtrueï¼Œé¿å…åœ¨éœ€è¦æ¸²æŸ“çš„æ—¶å€™æ‰åšè§£ç ï¼Œé»˜è®¤é€‰é¡¹æ˜¯false    </span></span><br><span class="line">    let downsampleOptions =</span><br><span class="line">     [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageAlways:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize:maxDimensionInPixels</span><br><span class="line">     ] as <span class="built_in">CFDictionary</span></span><br><span class="line">    </span><br><span class="line">    let downsampledImage = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSouce, <span class="number">0</span>, downsampleOptions)!</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: downsampledImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–ç¼©ç•¥æ–¹æ³•å¯ä»¥çœ‹<a href="../iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•">iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•</a></p><h3 id="å¤§å›¾ä½¿ç”¨CATiledLayer"><a href="#å¤§å›¾ä½¿ç”¨CATiledLayer" class="headerlink" title="å¤§å›¾ä½¿ç”¨CATiledLayer"></a>å¤§å›¾ä½¿ç”¨CATiledLayer</h3><p>æœ‰äº›æ—¶å€™ä½ å¯èƒ½éœ€è¦ç»˜åˆ¶ä¸€ä¸ªå¾ˆå¤§çš„å›¾ç‰‡ï¼Œå¸¸è§çš„ä¾‹å­å°±æ˜¯ä¸€ä¸ªé«˜åƒç´ çš„ç…§ç‰‡æˆ–è€…æ˜¯åœ°çƒè¡¨é¢çš„è¯¦ç»†åœ°å›¾ã€‚iOSåº”ç”¨é€šç•…è¿è¡Œåœ¨å†…å­˜å—é™çš„è®¾å¤‡ä¸Šï¼Œæ‰€ä»¥è¯»å–æ•´ä¸ªå›¾ç‰‡åˆ°å†…å­˜ä¸­æ˜¯ä¸æ˜æ™ºçš„ã€‚è½½å…¥å¤§å›¾å¯èƒ½ä¼šç›¸å½“åœ°æ…¢ï¼Œé‚£äº›å¯¹ä½ çœ‹ä¸Šå»æ¯”è¾ƒæ–¹ä¾¿çš„åšæ³•ï¼ˆåœ¨ä¸»çº¿ç¨‹è°ƒç”¨UIImageçš„-imageNamed:æ–¹æ³•æˆ–è€…-imageWithContentsOfFile:æ–¹æ³•ï¼‰å°†ä¼šé˜»å¡ä½ çš„ç”¨æˆ·ç•Œé¢ï¼Œè‡³å°‘ä¼šå¼•èµ·åŠ¨ç”»å¡é¡¿ç°è±¡ã€‚</p><p>èƒ½é«˜æ•ˆç»˜åˆ¶åœ¨iOSä¸Šçš„å›¾ç‰‡ä¹Ÿæœ‰ä¸€ä¸ªå¤§å°é™åˆ¶ã€‚æ‰€æœ‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å›¾ç‰‡æœ€ç»ˆéƒ½ä¼šè¢«è½¬åŒ–ä¸ºOpenGLçº¹ç†ï¼ŒåŒæ—¶OpenGLæœ‰ä¸€ä¸ªæœ€å¤§çš„çº¹ç†å°ºå¯¸ï¼ˆé€šå¸¸æ˜¯20482048ï¼Œæˆ–40964096ï¼Œè¿™ä¸ªå–å†³äºè®¾å¤‡å‹å·ï¼‰ã€‚å¦‚æœä½ æƒ³åœ¨å•ä¸ªçº¹ç†ä¸­æ˜¾ç¤ºä¸€ä¸ªæ¯”è¿™å¤§çš„å›¾ï¼Œå³ä¾¿å›¾ç‰‡å·²ç»å­˜åœ¨äºå†…å­˜ä¸­äº†ï¼Œä½ ä»ç„¶ä¼šé‡åˆ°å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºCore Animationå¼ºåˆ¶ç”¨CPUå¤„ç†å›¾ç‰‡è€Œä¸æ˜¯æ›´å¿«çš„GPUï¼ˆè§ç¬¬12ç« ã€é€Ÿåº¦çš„æ›²è°ƒã€ï¼Œå’Œç¬¬13ç« ã€é«˜æ•ˆç»˜å›¾ã€ï¼Œå®ƒæ›´åŠ è¯¦ç»†åœ°è§£é‡Šäº†è½¯ä»¶ç»˜åˆ¶å’Œç¡¬ä»¶ç»˜åˆ¶ï¼‰ã€‚</p><p>CATiledLayerä¸ºè½½å…¥å¤§å›¾é€ æˆçš„æ€§èƒ½é—®é¢˜æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šå°†å¤§å›¾åˆ†è§£æˆå°ç‰‡ç„¶åå°†ä»–ä»¬å•ç‹¬æŒ‰éœ€è½½å…¥ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIScrollView</span> *scrollView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">//add the tiled layer</span></span><br><span class="line">    <span class="built_in">CATiledLayer</span> *tileLayer = [<span class="built_in">CATiledLayer</span> layer];ï¿¼</span><br><span class="line">    tileLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2048</span>, <span class="number">2048</span>);</span><br><span class="line">    tileLayer.delegate = <span class="keyword">self</span>; [<span class="keyword">self</span>.scrollView.layer addSublayer:tileLayer];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//configure the scroll view</span></span><br><span class="line">    <span class="keyword">self</span>.scrollView.contentSize = tileLayer.frame.size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw layer</span></span><br><span class="line">    [tileLayer setNeedsDisplay];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLayer:(<span class="built_in">CATiledLayer</span> *)layer inContext:(<span class="built_in">CGContextRef</span>)ctx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//determine tile coordinate</span></span><br><span class="line">    <span class="built_in">CGRect</span> bounds = <span class="built_in">CGContextGetClipBoundingBox</span>(ctx);</span><br><span class="line">    <span class="built_in">NSInteger</span> x = floor(bounds.origin.x / layer.tileSize.width);</span><br><span class="line">    <span class="built_in">NSInteger</span> y = floor(bounds.origin.y / layer.tileSize.height);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//load tile image</span></span><br><span class="line">    <span class="built_in">NSString</span> *imageName = [<span class="built_in">NSString</span> stringWithFormat: <span class="string">@"Snowman_%02i_%02i"</span>, x, y];</span><br><span class="line">    <span class="built_in">NSString</span> *imagePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:imageName ofType:<span class="string">@"jpg"</span>];</span><br><span class="line">    <span class="built_in">UIImage</span> *tileImage = [<span class="built_in">UIImage</span> imageWithContentsOfFile:imagePath];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw tile</span></span><br><span class="line">    <span class="built_in">UIGraphicsPushContext</span>(ctx);</span><br><span class="line">    [tileImage drawInRect:bounds];</span><br><span class="line">    <span class="built_in">UIGraphicsPopContext</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="å¼‚æ­¥åŠ è½½è§£å‹"><a href="#å¼‚æ­¥åŠ è½½è§£å‹" class="headerlink" title="å¼‚æ­¥åŠ è½½è§£å‹"></a>å¼‚æ­¥åŠ è½½è§£å‹</h3><p>å¯¹äºåŠ è½½è¿‡ç¨‹ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§æˆ–åŠ è½½é¢‘ç¹å½±å“äº†å¸§ç‡ï¼ˆæ¯”å¦‚åˆ—è¡¨å±•ç¤ºå¤§å›¾ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥æ–¹å¼åŠ è½½å›¾ç‰‡ï¼Œå‡å°‘ä¸»çº¿ç¨‹çš„å‹åŠ›,è§£å‹æ˜¯è€—æ—¶çš„ï¼Œè€Œç³»ç»Ÿé»˜è®¤æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸šç•Œé€šå¸¸æœ‰ä¸€ç§åšæ³•æ˜¯ï¼Œå¼‚æ­¥å¼ºåˆ¶è§£å‹ï¼Œä¹Ÿå°±æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹ä¸»åŠ¨å°†äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®è§£å‹æˆä½å›¾æ•°æ®ï¼Œä½¿ç”¨CGBitmapContextCreate(â€¦)ç³»åˆ—æ–¹æ³•å°±èƒ½å®ç°ã€‚ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let serialQueue = DispatchQueue(label: &quot;Decode queue&quot;)</span><br><span class="line">func collectionView(_ collectionView:UICollectionView,prefetcgItemAt indexPaths:[IndexPath])&#123;</span><br><span class="line">    //å¼‚æ­¥è§£å‹ ç”Ÿæˆç¼©ç•¥å›¾</span><br><span class="line">    for indexPath in indexPaths&#123;</span><br><span class="line">        serialQueue.async &#123;</span><br><span class="line">            let downsampledImage = downsample(images[IndexPath])</span><br><span class="line">            DispatchQueue.main.async &#123;self.update(at:IndexPath.with:downsampledImage)&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åˆç†ä½¿ç”¨drawæ–¹æ³•"><a href="#åˆç†ä½¿ç”¨drawæ–¹æ³•" class="headerlink" title="åˆç†ä½¿ç”¨drawæ–¹æ³•"></a>åˆç†ä½¿ç”¨<code>draw</code>æ–¹æ³•</h3><p>é‡è½½<code>draw</code>æ–¹æ³•ä¼šå¯¼è‡´å†…å­˜çˆ†æ¶¨ã€‚åŸå› å¦‚ä¸‹ï¼š</p><p><img src="/res/imgBestP/imgBestP7.png" alt></p><p>ä¸€æ—¦ä½ å®ç°äº†<em>CALayerDelegate</em>åè®®ä¸­çš„<code>-drawLayer:inContext:</code>æ–¹æ³•æˆ–è€…UIViewä¸­çš„<code>-drawRect:</code>æ–¹æ³•ï¼ˆå…¶å®å°±æ˜¯å‰è€…çš„åŒ…è£…æ–¹æ³•ï¼‰ï¼ŒCALayeråˆ›å»ºäº†ä¸€ä¸ªåˆé€‚å°ºå¯¸çš„ç©ºå¯„å®¿å›¾ï¼ˆå°ºå¯¸ç”±boundså’ŒcontentsScaleå†³å®šï¼‰å’Œä¸€ä¸ªCore Graphicsçš„ç»˜åˆ¶ä¸Šä¸‹æ–‡ç¯å¢ƒ(Backing Store)ï¼Œä¸ºç»˜åˆ¶å¯„å®¿å›¾åšå‡†å¤‡ï¼Œå®ƒä½œä¸ºctxå‚æ•°ä¼ å…¥ã€‚å›¾å±‚å°±åˆ›å»ºäº†ä¸€ä¸ªç»˜åˆ¶ä¸Šä¸‹æ–‡(Backing Store)ï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡éœ€è¦çš„å†…å­˜å¯ä»è¿™ä¸ªå…¬å¼å¾—å‡ºï¼šå›¾å±‚å®½ <em> å›¾å±‚é«˜</em> 4 å­—èŠ‚ï¼Œå®½é«˜çš„å•ä½å‡ä¸ºåƒç´ ã€‚ä»¥iphone6ä¸ºä¾‹ï¼Œ750 <em> 1134 </em> 4 å­—èŠ‚ â‰ˆ 3.4 Mb ã€‚</p><p>æ€»ç»“ä¸‹è¿™ç§ä½¿ç”¨drawRectç»˜åˆ¶æ–¹æ¡ˆçš„é—®é¢˜</p><ol><li>Backing Storeçš„åˆ›å»ºé€ æˆäº†ä¸å¿…è¦çš„å†…å­˜å¼€é”€</li><li>UIImageå…ˆç»˜åˆ¶åˆ°Backing Storeï¼Œå†æ¸²æŸ“åˆ°frameBufferï¼Œä¸­é—´å¤šäº†ä¸€å±‚å†…å­˜æ‹·è´</li><li>èƒŒæ™¯é¢œè‰²ä¸éœ€è¦ç»˜åˆ¶åˆ°Backing Storeï¼Œç›´æ¥ä½¿ç”¨BackGroundColorç»˜åˆ¶åˆ°FrameBuffer</li></ol><p>æ‰€ä»¥ï¼Œæ­£ç¡®çš„å®ç°å§¿åŠ¿æ˜¯å°†è¿™ä¸ªå¤§çš„viewæ‹†åˆ†æˆå°çš„subviewé€ä¸ªå®ç°ã€‚</p><h3 id="æ¨èä½¿ç”¨Image-Assets"><a href="#æ¨èä½¿ç”¨Image-Assets" class="headerlink" title="æ¨èä½¿ç”¨Image Assets"></a>æ¨èä½¿ç”¨Image Assets</h3><p>åŸºäºåç§°å’Œç‰¹æ•ˆä¼˜åŒ–äº†æŸ¥æ‰¾æ•ˆç‡ï¼Œæ›´å¿«çš„æŸ¥æ‰¾å›¾ç‰‡<br>è¿è¡Œæ—¶ï¼Œå¯¹å†…å­˜çš„ç®¡ç†ä¹Ÿæœ‰ä¼˜åŒ–<br>App Slicingï¼Œappå®‰è£…åŒ…ç˜¦èº«ã€‚iOS 9 åä¼šä» Image Assets ä¸­ä¿ç•™è®¾å¤‡æ”¯æŒçš„å›¾ç‰‡ ï¼ˆ2x æˆ–è€… 3xï¼‰<br>iOS 11 åçš„ Preserve Vector Dataã€‚æ”¯æŒçŸ¢é‡å›¾çš„åŠŸèƒ½ï¼Œæ”¾å¤§ä¹Ÿä¸ä¼šå¤±çœŸ</p><h3 id="Advanced-Image-Effects"><a href="#Advanced-Image-Effects" class="headerlink" title="Advanced Image Effects"></a>Advanced Image Effects</h3><p>å¯¹äºå›¾ç‰‡çš„å®æ—¶å¤„ç†æ¨èä½¿ç”¨CoreImageæ¡†æ¶ã€‚<br>ä¾‹å¦‚å°†ä¸€å¼ å›¾ç‰‡çš„ç°åº¦å€¼è¿›è¡Œè°ƒæ•´è¿™æ ·çš„æ“ä½œï¼Œæœ‰æ»´å°ä¼™ä¼´å¯èƒ½ä½¿ç”¨CoreGraphicsè·å–å›¾åƒçš„æ¯ä¸ªåƒç´ ç‚¹æ•°æ®ï¼Œç„¶åæ”¹å˜ç°åº¦å€¼ï¼Œæœ€ç»ˆç”Ÿæˆç›®æ ‡å›¾æ ‡ï¼Œè¿™ç§åšæ³•å°†å¤§é‡gpuæ“…é•¿çš„å·¥ä½œæ”¾åœ¨äº†cpuä¸Šå¤„ç†ï¼Œåˆç†çš„åšæ³•æ˜¯: ä½¿ç”¨CoreImageçš„æ»¤é•œfilteræˆ–è€…metalï¼ŒOpenGLçš„shaderï¼Œè®©å›¾åƒå¤„ç†çš„å·¥ä½œäº¤ç»™GPUå»åšã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">let sharedContext = <span class="built_in">CIContext</span>(options: [.useSoftwareRenderer : <span class="literal">false</span>])</span><br><span class="line">func coreImage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    let scale = (Double)(size.width) / (Double)(oriImg.size.width)</span><br><span class="line">    let image = <span class="built_in">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    </span><br><span class="line">    let filter = <span class="built_in">CIFilter</span>(name: <span class="string">"CILanczosScaleTransform"</span>)</span><br><span class="line">    filter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">    filter?.setValue(<span class="built_in">NSNumber</span>(value:scale), forKey: kCIInputScaleKey)</span><br><span class="line">    filter?.setValue(<span class="number">1.0</span>, forKey:kCIInputAspectRatioKey)</span><br><span class="line">    </span><br><span class="line">    guard let outputCIImage = filter?.outputImage,</span><br><span class="line">        let outputCGImage = sharedContext.createCGImage(outputCIImage,</span><br><span class="line">                                                        from: outputCIImage.extent)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Drawing-Off-Screen"><a href="#Drawing-Off-Screen" class="headerlink" title="Drawing Off-Screen"></a>Drawing Off-Screen</h3><p>å¯¹äºéœ€è¦ç¦»å±æ¸²æŸ“çš„åœºæ™¯æ¨èä½¿ç”¨UIGraphicsImageRendereræ›¿ä»£UIGraphicsBeginImageContextï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¹¶ä¸”æ”¯æŒå¹¿è‰²åŸŸã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func uikit_resize(oriImg:<span class="built_in">UIImage</span>?,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    let hasAlpha = <span class="literal">false</span></span><br><span class="line">    let scale: <span class="built_in">CGFloat</span> = <span class="number">0.0</span> <span class="comment">// Automatically use scale factor of main screen</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, !hasAlpha, scale)</span><br><span class="line">    oriImg!.draw(<span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    let resizedImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>()</span><br><span class="line">    <span class="keyword">return</span> resizedImage!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//in iOS 10 UIGraphicsImageRenderer</span></span><br><span class="line"><span class="comment">//    let render  = UIGraphicsImageRenderer(size: size)</span></span><br><span class="line"><span class="comment">//    return render.image(actions: &#123; (context) in</span></span><br><span class="line"><span class="comment">//        oriImg?.draw(in: CGRect(origin: .zero, size: size))</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»‹ç»ä¸‹ wwdc 2018 Image and Graphics Best Practices ä¸­å›¾ç‰‡å¤„ç†è§£å‹ç›¸å…³çŸ¥è¯†ç‚¹&lt;br&gt;ref: &lt;a href=&quot;https://developer.apple.com/videos/play/wwdc2018/219&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Image and Graphics Best Practices&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;å›¾ç‰‡å¤„ç†è¿‡ç¨‹&quot;&gt;&lt;a href=&quot;#å›¾ç‰‡å¤„ç†è¿‡ç¨‹&quot; class=&quot;headerlink&quot; title=&quot;å›¾ç‰‡å¤„ç†è¿‡ç¨‹&quot;&gt;&lt;/a&gt;å›¾ç‰‡å¤„ç†è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;ä¸€å¼ å›¾ç‰‡ä»ç£ç›˜ä¸­æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼šä»ç£ç›˜åŠ è½½åŸå§‹å‹ç¼©çš„å›¾ç‰‡ä¿¡æ¯ã€è§£ç äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®ä¸ºä½å›¾ã€æ¸²æŸ“å›¾ç‰‡æœ€ç»ˆç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚&lt;/p&gt;
&lt;!-- ![](/res/imgBestP/imgBestP1.png) --&gt;
&lt;p&gt;&lt;img src=&quot;/res/imgBestP/imgBestP1.png&quot; width=&quot;80%&quot;&gt;&lt;/p&gt;
&lt;p&gt;åœ¨å®é™…çš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼ŒUIImageè´Ÿè´£è§£å‹Data Bufferå†…å®¹å¹¶ç”³è¯·bufferï¼ˆImage Bufferï¼‰å­˜å‚¨è§£å‹åçš„å›¾ç‰‡ä¿¡æ¯ï¼Œç„¶åUIImageViewè´Ÿè´£å°†Image Buffer æ‹·è´è‡³ framebufferï¼Œç”¨äºç»™æ˜¾ç¤ºç¡¬ä»¶æä¾›é¢œè‰²ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;p&gt;è§£å‹è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¤§é‡å ç”¨CPUèµ„æºçš„å·¥ä½œï¼Œå› æ­¤UIImage ä¼šretainå­˜å‚¨è§£å‹åä¿¡æ¯çš„Image Bufferä»¥ä¾¿ç»™é‡å¤çš„æ¸²æŸ“å·¥ä½œæä¾›ä¿¡æ¯ï¼ŒImage Bufferä¸å›¾ç‰‡çš„å®é™…å°ºå¯¸æœ‰å…³ï¼ˆç†è®ºå€¼ä¸ºheight &lt;em&gt; width &lt;/em&gt; 4 bytesï¼‰ï¼Œä¸å›¾ç‰‡æ–‡ä»¶å¤§å°æ— å…³ã€‚è‹¥æ˜¯åœ¨TableViewç­‰åˆ—è¡¨ä¸­è¿ç»­åŠ è½½å¤šå¼ å›¾ç‰‡ï¼Œä¾¿ä¼šå¼•å‘è¿ç»­çš„å¤§å—å†…å­˜åˆ†é…ï¼Œè¿™å°†å¯¹Memoryå’ŒCPUå¸¦æ¥æ²‰é‡çš„è´Ÿæ‹…ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSå›¾ç‰‡" scheme="https://developerdoc.com/categories/iOS%E5%9B%BE%E7%89%87/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="å›¾ç‰‡" scheme="https://developerdoc.com/tags/%E5%9B%BE%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡-ImageIOä»‹ç»</title>
    <link href="https://developerdoc.com/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-ImageIO%E4%BB%8B%E7%BB%8D/"/>
    <id>https://developerdoc.com/quick-start/å›¾ç‰‡/iOSå›¾ç‰‡-ImageIOä»‹ç»/</id>
    <published>2019-12-06T07:40:01.000Z</published>
    <updated>2020-01-15T09:30:23.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»‹ç»ä¸‹iOSä¸­ImageIOçš„æ¦‚è§ˆä¸åº”ç”¨<br><a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/ImageIOGuide/imageio_intro/ikpg_intro.html#//apple_ref/doc/uid/TP40005462-CH201-TPXREF101" target="_blank" rel="noopener">Image I/O Programming Guide</a></p></blockquote><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p> ImageIOæ¡†æ¶æä¾›äº†è¯»å–ä¸å†™å…¥å›¾ç‰‡æ•°æ®çš„åŸºæœ¬æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥ç›´æ¥è·å–åˆ°å›¾ç‰‡æ–‡ä»¶çš„å†…å®¹æ•°æ®ï¼ŒImageIOå…·æœ‰å¾ˆå¤šç‰¹æ€§ <code>Macå¹³å°ä¸Šæœ€å¿«çš„å›¾åƒè§£ç å™¨å’Œç¼–ç å™¨</code> <code>é€æ­¥åŠ è½½å›¾åƒçš„èƒ½åŠ›`</code>æ”¯æŒå›¾åƒå…ƒæ•°æ®<code></code>æœ‰æ•ˆç¼“å­˜` ImageIOæ¡†æ¶ä¸­åŒ…å«6ä¸ªå¤´æ–‡ä»¶:</p><ol><li>ImageIO.CGImageAnimation</li><li>ImageIO.CGImageDestination è´Ÿè´£å†™å…¥å›¾ç‰‡æ•°æ®ã€‚</li><li>ImageIO.CGImageMetadata å›¾ç‰‡æ–‡ä»¶å…ƒæ•°æ®ç±»</li><li>ImageIO.CGImageProperties å®šä¹‰äº†æ¡†æ¶ä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡å’Œå®ã€‚</li><li>ImageIO.CGImageSource è´Ÿè´£è¯»å–å›¾ç‰‡æ•°æ®ã€‚</li><li><p>ImageIO.ImageIOBase é¢„å¤„ç†é€»è¾‘</p><a id="more"></a></li></ol><h2 id="è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"><a href="#è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼" class="headerlink" title="è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"></a>è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼</h2><p>ImageIO æ¡†æ¶äº†è§£å¤§å¤šæ•°å¸¸è§çš„å›¾åƒæ–‡ä»¶æ ¼å¼ï¼Œä¾‹å¦‚JPEGï¼ŒJPEG2000ï¼ŒRAWï¼ŒTIFFï¼ŒBMPå’ŒPNGã€‚å¹¶éæ¯ä¸ªå¹³å°éƒ½æ”¯æŒæ‰€æœ‰æ ¼å¼<br>é€šè¿‡ CGImageSourceCopyTypeIdentifiers å’Œ CGImageDestinationCopyTypeIdentifiers å¯ä»¥çœ‹åˆ°æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›Image IO æ”¯æŒçš„ç»Ÿä¸€ç±»å‹æ ‡è¯†ç¬¦ï¼ˆUTIï¼‰æ•°ç»„ä½œä¸ºå›¾åƒæºã€‚</span></span><br><span class="line">let mySourceTypes = <span class="built_in">CGImageSourceCopyTypeIdentifiers</span>()</span><br><span class="line"><span class="comment">//è¿”å›Image IO æ”¯æŒçš„ç»Ÿä¸€ç±»å‹æ ‡è¯†ç¬¦ï¼ˆUTIï¼‰çš„æ•°ç»„ä½œä¸ºå›¾åƒç›®æ ‡ã€‚</span></span><br><span class="line">let myDestTypes = <span class="built_in">CGImageDestinationCopyTypeIdentifiers</span>()</span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬ä½¿ç”¨-è·å–å›¾ç‰‡-ç¼©ç•¥å›¾"><a href="#åŸºæœ¬ä½¿ç”¨-è·å–å›¾ç‰‡-ç¼©ç•¥å›¾" class="headerlink" title="åŸºæœ¬ä½¿ç”¨|è·å–å›¾ç‰‡ ç¼©ç•¥å›¾"></a>åŸºæœ¬ä½¿ç”¨|è·å–å›¾ç‰‡ ç¼©ç•¥å›¾</h2><p>åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨UIImageæ¥è¯»å–å›¾ç‰‡ï¼ŒUIImageæ”¯æŒçš„å›¾ç‰‡åŒ…æ‹¬pngä¸jpgç­‰ï¼Œä½†æ˜¯ç±»ä¼¼icoå›¾æ ‡ï¼ŒUIImageé»˜è®¤æ˜¯æ— æ³•æ˜¾ç¤ºçš„ï¼Œ<br>å¯ä»¥é€šè¿‡ImageIOæ¡†æ¶æ¥åœ¨iOSç³»ç»Ÿä¸­ä½¿ç”¨icoå›¾æ ‡ï¼Œç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func getImage() -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    guard let url = Bundle.main.url(forResource: <span class="string">"image.ico"</span>, withExtension: <span class="literal">nil</span>) <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//ä»URLåˆ›å»ºå›¾åƒæºã€‚</span></span><br><span class="line">    guard let imageSource = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//è·å–å›¾ç‰‡</span></span><br><span class="line">    guard let cgImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123; <span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//è·å–ç¼©ç•¥å›¾</span></span><br><span class="line">    let thumb = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: cgImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è·å–ç¼©ç•¥å›¾"><a href="#è·å–ç¼©ç•¥å›¾" class="headerlink" title="è·å–ç¼©ç•¥å›¾"></a>è·å–ç¼©ç•¥å›¾</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func downsample(imageAt imageURL:URL,to pointSize:<span class="built_in">CGSize</span>,scale:<span class="built_in">CGFloat</span>)-&gt;<span class="built_in">UIImage</span>&#123;</span><br><span class="line">    let imageSourceOptions = [kCGImageSourceShouldCache:<span class="literal">false</span>] as <span class="built_in">CFDictionary</span></span><br><span class="line">    let imageSouce = <span class="built_in">CGImageSourceCreateWithURL</span>(imageURL as <span class="built_in">CFURL</span>, imageSourceOptions)!</span><br><span class="line">    </span><br><span class="line">    let maxDimensionInPixels = max(pointSize.width,pointSize.height) * scale</span><br><span class="line">    let downsampleOptions =</span><br><span class="line">     [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageAlways:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize:maxDimensionInPixels</span><br><span class="line">     ] as <span class="built_in">CFDictionary</span></span><br><span class="line">    </span><br><span class="line">    let downsampledImage = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSouce, <span class="number">0</span>, downsampleOptions)!</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: downsampledImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸è¿›æ¸²æŸ“å¤§å›¾"><a href="#æ¸è¿›æ¸²æŸ“å¤§å›¾" class="headerlink" title="æ¸è¿›æ¸²æŸ“å¤§å›¾"></a>æ¸è¿›æ¸²æŸ“å¤§å›¾</h2><p>æ¸è¿›å¼è§£ç ï¼ˆProgressive Decodingï¼‰ï¼Œå³ä¸éœ€è¦å®Œæ•´çš„å›¾åƒæµæ•°æ®ï¼Œå…è®¸è§£ç éƒ¨åˆ†å¸§ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¼šæ˜¯å›¾åƒçš„éƒ¨åˆ†åŒºåŸŸï¼‰ï¼Œå¯¹éƒ¨åˆ†ä½¿ç”¨äº†æ¸è¿›å¼ç¼–ç çš„æ ¼å¼ï¼ˆå‚è€ƒï¼š<a href="https://en.wikipedia.org/wiki/Interlacing_(bitmaps" target="_blank" rel="noopener">æ¸è¿›å¼ç¼–ç </a>)ï¼‰ï¼Œåˆ™æ›´å¯ä»¥è§£ç å‡ºç›¸å¯¹æ¨¡ç³Šä½†å®Œæ•´çš„å›¾åƒã€‚æ¯”å¦‚è¯´ï¼ŒJPEGæ”¯æŒä¸‰ç§æ–¹å¼çš„æ¸è¿›å¼ç¼–ç ï¼ŒåŒ…æ‹¬Baselineï¼Œinterlacedï¼Œä»¥åŠprogressive</p><p>ä½¿ç”¨ImageIOæ¡†æ¶å¯ä»¥å®ç°å¤§å›¾æ¸è¿›æ¸²æŸ“çš„æ•ˆæœï¼Œä¸€èˆ¬åœ¨å¯¹å¤§å›¾ç‰‡è¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶ï¼Œå¯ä»¥è·å–ä¸€éƒ¨åˆ†æ•°æ®å°±åŠ è½½ä¸€éƒ¨åˆ†æ•°æ®<br>åˆ›å»ºä¸€ä¸ªç©ºçš„CGImageSourceï¼Œç„¶ååœ¨æ¯æ¬¡æ”¶åˆ°æ•°æ®çš„æ—¶å€™è°ƒç”¨CGImageSourceUpdateDataæ›´æ–°imageSourceçš„æ•°æ®ï¼Œæ¥ç€è°ƒç”¨CGImageSourceCreateImageAtIndexè·å–æœ€æ–°çš„å›¾ç‰‡å³å¯</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//demoä½¿ç”¨è®¡æ—¶å™¨æ¨¡æ‹Ÿ</span></span><br><span class="line"><span class="keyword">class</span> ProgressiveLoadViewController : <span class="built_in">UIViewController</span>&#123;</span><br><span class="line">    </span><br><span class="line">    deinit &#123;</span><br><span class="line">        incrementTimer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private var data = Data()</span><br><span class="line">    private var progress: Int = <span class="number">0</span></span><br><span class="line">    private var incrementTimer: Timer? &#123;</span><br><span class="line">        didSet &#123;</span><br><span class="line">            oldValue?.invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private var cgImageSource = <span class="built_in">CGImageSourceCreateIncremental</span>(<span class="literal">nil</span>)</span><br><span class="line">    </span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        guard let data = try? Data(contentsOf: URL(string: <span class="string">"some url"</span>)!) <span class="keyword">else</span> &#123;</span><br><span class="line">            print(<span class="string">"failed to load image source"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.data = data</span><br><span class="line">        <span class="keyword">self</span>.progress = <span class="number">0</span></span><br><span class="line">        <span class="comment">//è¦æ¸è¿›æ˜¾ç¤ºçš„å›¾ç‰‡</span></span><br><span class="line">        guard let cgImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(<span class="keyword">self</span>.cgImageSource, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        let uiImage = <span class="built_in">UIImage</span>(cgImage: cgImage)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func viewWillAppear(_ animated: Bool) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.incrementTimer = Timer.scheduledTimer(timeInterval: <span class="number">0.25</span>, target: <span class="keyword">self</span>,</span><br><span class="line">                                                   selector: <span class="meta">#selector(self.incrementImage), userInfo: nil, repeats: true)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @objc func incrementImage()&#123;</span><br><span class="line">        <span class="keyword">self</span>.progress += <span class="number">500</span></span><br><span class="line">        let chunk = <span class="keyword">self</span>.data.prefix(<span class="keyword">self</span>.progress)</span><br><span class="line">        <span class="keyword">if</span> chunk.count == <span class="keyword">self</span>.data.count &#123;</span><br><span class="line">            <span class="keyword">self</span>.incrementTimer = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGImageSourceUpdateData</span>(<span class="keyword">self</span>.cgImageSource, Data(chunk) as <span class="built_in">CFData</span>, chunk.count == <span class="keyword">self</span>.data.count)</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®"><a href="#è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®" class="headerlink" title="è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®"></a>è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®</h2><p>åˆ›å»ºå¥½CGImageSourceä¹‹åï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç«‹å³è§£ç ã€‚ä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€äº›ç›¸å…³çš„å›¾åƒä¿¡æ¯ï¼ŒåŒ…æ‹¬å›¾åƒçš„æ ¼å¼ï¼Œå›¾åƒæ•°é‡ï¼ŒEXIFå…ƒæ•°æ®ç­‰ã€‚åœ¨çœŸæ­£è§£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™äº›æ•°æ®ï¼Œè¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¹‹åå†å¼€å§‹è§£ç è¿‡ç¨‹ã€‚</p><p>å…¶ä¸­ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ç›´æ¥åœ¨CGImageSourceä¸Šè·å–ï¼š</p><ul><li>å›¾åƒæ ¼å¼ï¼šCGImageSourceGetType</li><li>å›¾åƒæ•°é‡ï¼ˆåŠ¨å›¾ï¼‰ï¼šCGImageSourceGetCount</li></ul><p>å…¶ä»–çš„ï¼Œéœ€è¦é€šè¿‡è·å–å±æ€§åˆ—è¡¨æ¥æŸ¥è¯¢ã€‚å¯¹äºå›¾åƒå®¹å™¨çš„å±æ€§ï¼ˆEXIFç­‰ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨CGImageSourceCopyPropertieså³å¯ï¼Œç„¶åæ ¹æ®ä¸åŒçš„Keyå»è·å–å¯¹åº”çš„ä¿¡æ¯ã€‚</p><p>å…¶å®è‹¹æœè¿˜æœ‰ä¸€å¥—CGImageSourceCopyMetadataAtIndexï¼Œå¯¹åº”çš„æ•°æ®ä¸æ˜¯å­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ªCGImageMetadataï¼Œå†é€šè¿‡å…¶ä»–æ–¹æ³•å»å–ã€‚è¿™å¥—APIä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¯»å–æ•°æ®å’Œå‰è€…æ˜¯å®Œå…¨å…¼å®¹ä¸€è‡´çš„ï¼Œä¼˜ç‚¹æ˜¯èƒ½å¤Ÿè¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼ˆæ¯”å¦‚è¯´ä½ æœ‰éæ ‡å‡†çš„å›¾åƒä¿¡æ¯æƒ³è‡ªå·±æ·»åŠ å’Œåˆ é™¤ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ä½¿ç”¨å‰è€…å°±è¶³å¤Ÿäº†ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CGImageSourceCopyPropertiesAtIndex</span>æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸ä¸­å¯èƒ½åŒ…å«å¦‚ä¸‹æœ‰æ„ä¹‰çš„é”®ï¼š</span><br><span class="line"></span><br><span class="line"><span class="comment">//TIFFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyTIFFDictionary;</span><br><span class="line">/GIFä¿¡æ¯å­—å…¸</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyGIFDictionary;</span><br><span class="line"><span class="comment">//JFIFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyJFIFDictionary;</span><br><span class="line"><span class="comment">//EXifä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyExifDictionary;</span><br><span class="line"><span class="comment">//PNGä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyPNGDictionary;</span><br><span class="line"><span class="comment">//IPTCä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyIPTCDictionary;</span><br><span class="line"><span class="comment">//GPSä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyGPSDictionary;</span><br><span class="line"><span class="comment">//åŸå§‹ä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyRawDictionary;</span><br><span class="line"><span class="comment">//CIFFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyCIFFDictionary;</span><br><span class="line"><span class="comment">//ä½³èƒ½ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerCanonDictionary;</span><br><span class="line"><span class="comment">//å°¼åº·ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerNikonDictionary;</span><br><span class="line"><span class="comment">//æŸ¯å°¼å¡ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerMinoltaDictionary;</span><br><span class="line"><span class="comment">//å¯Œå£«ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerFujiDictionary;</span><br><span class="line"><span class="comment">//å¥¥æ—å·´æ–¯ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerOlympusDictionary;</span><br><span class="line"><span class="comment">//å®¾å¾—ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerPentaxDictionary;</span><br><span class="line"><span class="comment">//å¯¹åº”Photoshopç›¸ç‰‡çš„ä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImageProperty8BIMDictionary;</span><br><span class="line"><span class="comment">//NDGä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyDNGDictionary ;</span><br><span class="line"><span class="comment">//ExifAuxä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyExifAuxDictionary;</span><br><span class="line"><span class="comment">//OpenEXRä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyOpenEXRDictionary;</span><br><span class="line"><span class="comment">//Appleç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerAppleDictionary ;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure><h2 id="æ˜¾ç¤ºGIF"><a href="#æ˜¾ç¤ºGIF" class="headerlink" title="æ˜¾ç¤ºGIF"></a>æ˜¾ç¤ºGIF</h2><ol><li>é¦–å…ˆä½¿ç”¨ImageIOåº“ä¸­çš„CGImageSourceåŠ è½½Gifæ–‡ä»¶ã€‚</li><li>é€šè¿‡CGImageSourceè·å–åˆ°Gifæ–‡ä»¶ä¸­çš„æ€»çš„å¸§æ•°ï¼Œä»¥åŠæ¯ä¸€å¸§çš„æ˜¾ç¤ºæ—¶é—´ã€‚</li><li>é€šè¿‡CAKeyframeAnimationæ¥å®ŒæˆGifåŠ¨ç”»çš„æ’­æ”¾ã€‚</li></ol><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func getGif(url:URL)&#123;</span><br><span class="line">    guard let source = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>) <span class="keyword">else</span> &#123;<span class="keyword">return</span>;&#125;;</span><br><span class="line">    <span class="comment">//è·å–gifä¸­å›¾ç‰‡çš„ä¸ªæ•°</span></span><br><span class="line">    let count = <span class="built_in">CGImageSourceGetCount</span>(source)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0.</span>..count &#123;</span><br><span class="line">        let image = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(source, index, <span class="literal">nil</span>)</span><br><span class="line">        <span class="comment">//è·å–å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">        let info = <span class="built_in">CGImageSourceCopyProperties</span>(source, <span class="literal">nil</span>) as! <span class="built_in">NSDictionary</span></span><br><span class="line">        let width = info[kCGImagePropertyWidth]</span><br><span class="line">        let height = info[kCGImagePropertyHeight]</span><br><span class="line">        let timeDic = info[kCGImagePropertyGIFDictionary]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºåŠ¨ç”»å›¾ç‰‡"><a href="#åˆ›å»ºåŠ¨ç”»å›¾ç‰‡" class="headerlink" title="åˆ›å»ºåŠ¨ç”»å›¾ç‰‡"></a>åˆ›å»ºåŠ¨ç”»å›¾ç‰‡</h2><ol><li>é¦–å…ˆï¼Œå®ƒåˆ›å»ºä¸€å¯¹å­—å…¸æ¥ä¿å­˜åŠ¨ç”»å±æ€§ã€‚ç¬¬ä¸€ä¸ªå­—å…¸æŒ‡å®šåŠ¨ç”»PNGåœ¨åœæ­¢åˆ°æœ€åä¸€å¸§ä¹‹å‰åº”é‡å¤å…¶åŠ¨ç”»çš„æ—¶é—´ã€‚ç¬¬äºŒä¸ªå­—å…¸æŒ‡å®šåºåˆ—ä¸­æ¯ä¸ªå¸§ä½¿ç”¨çš„å¸§å»¶è¿Ÿã€‚</li><li>åˆ›å»ºå›¾åƒç›®æ ‡ä¹‹åï¼Œä»£ç å°†è®¾ç½®ç›®æ ‡å›¾åƒçš„æ–‡ä»¶å±æ€§ï¼Œç„¶åä¸€æ¬¡æ·»åŠ ä¸€ä¸ªå¸§ã€‚</li><li>æœ€åï¼ŒCGImageDestinationFinalizeè°ƒç”¨è¯¥æ–¹æ³•ä»¥å®ŒæˆåŠ¨ç”»PNGã€‚</li></ol><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">func createAnimatePng(fileURL:<span class="built_in">CFURL</span>,kUTTypePNG:<span class="built_in">CFString</span>,imageForFrame)&#123;</span><br><span class="line">    let loopCount = <span class="number">1</span></span><br><span class="line">    let frameCount = <span class="number">60</span></span><br><span class="line">     </span><br><span class="line">    var fileProperties = <span class="built_in">NSMutableDictionary</span>()</span><br><span class="line">    fileProperties.setObject(kCGImagePropertyPNGDictionary, forKey: <span class="built_in">NSDictionary</span>(dictionary: [kCGImagePropertyAPNGLoopCount: frameCount]))</span><br><span class="line">     </span><br><span class="line">    var frameProperties = <span class="built_in">NSMutableDictionary</span>()</span><br><span class="line">    frameProperties.setObject(kCGImagePropertyPNGDictionary, forKey: <span class="built_in">NSDictionary</span>(dictionary: [kCGImagePropertyAPNGDelayTime: <span class="number">1.0</span> / Double(frameCount)]))</span><br><span class="line">     </span><br><span class="line">    guard let destination = <span class="built_in">CGImageDestinationCreateWithURL</span>(fileURL, kUTTypePNG, frameCount, <span class="literal">nil</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Provide error handling here.</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="built_in">CGImageDestinationSetProperties</span>(destination, fileProperties.copy() as? <span class="built_in">NSDictionary</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0.</span>.&lt;frameCount &#123;</span><br><span class="line">        autoreleasepool &#123;</span><br><span class="line">            let radians = M_PI * <span class="number">2.0</span> * Double(i) / Double(frameCount)</span><br><span class="line">            guard let image = imageForFrame(size: <span class="built_in">CGSize</span>(width: <span class="number">300</span>, height: <span class="number">300</span>)) <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGImageDestinationAddImage</span>(destination, image, frameProperties)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> !<span class="built_in">CGImageDestinationFinalize</span>(destination) &#123;</span><br><span class="line">        <span class="comment">// Provide error handling here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å›¾ç‰‡ç¼–ç -CGImageDestination"><a href="#å›¾ç‰‡ç¼–ç -CGImageDestination" class="headerlink" title="å›¾ç‰‡ç¼–ç  | CGImageDestination"></a>å›¾ç‰‡ç¼–ç  | CGImageDestination</h2><p>imageIOä¸­ä½¿ç”¨CGImageDestinationå¯¹é™æ€å›¾çš„ç¼–ç ï¼ŒåŸºæœ¬å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š</p><ul><li>åˆ›å»ºCGImageDestination</li><li>æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage</li><li>ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†</li></ul><h3 id="1-åˆ›å»ºCGImageDestination"><a href="#1-åˆ›å»ºCGImageDestination" class="headerlink" title="1. åˆ›å»ºCGImageDestination"></a>1. åˆ›å»ºCGImageDestination</h3><p>CGImageDestinationçš„åˆ›å»ºä¹Ÿæœ‰ä¸‰ä¸ªæ¥å£ï¼Œä½ éœ€è¦æä¾›ä¸€ä¸ªè¾“å‡ºçš„ç›®æ ‡æ¥è¾“å‡ºè§£ç åçš„æ•°æ®ã€‚åŒæ—¶ï¼Œç”±äºç¼–ç éœ€è¦æä¾›æ–‡ä»¶æ ¼å¼ï¼Œä½ éœ€è¦æŒ‡æ˜å¯¹åº”ç¼–ç çš„æ–‡ä»¶æ ¼å¼ï¼Œç”¨çš„æ˜¯UTI Typeã€‚å¯¹äºé™æ€å›¾æ¥è¯´ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°çš„æ•°é‡éƒ½å†™1å³å¯ã€‚</p><ul><li>CGImageDestinationCreateWithDataï¼šæŒ‡å®šä¸€ä¸ªå¯å˜äºŒè¿›åˆ¶æ•°æ®ä½œä¸ºè¾“å‡º</li><li>CGImageDestinationCreateWithURLï¼šæŒ‡å®šä¸€ä¸ªæ–‡ä»¶è·¯å¾„ä½œä¸ºè¾“å‡º</li><li>CGImageDestinationCreateWithDataConsumerï¼šæŒ‡å®šä¸€ä¸ªDataConsumerä½œä¸ºè¾“å‡º</li></ul><h3 id="2-æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage"><a href="#2-æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage" class="headerlink" title="2. æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage"></a>2. æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage</h3><p>æ¥ä¸‹æ¥å°±æ˜¯æ·»åŠ å›¾åƒäº†ï¼Œç”±äºCGImageåªæ˜¯åŒ…å«åŸºæœ¬çš„å›¾åƒä¿¡æ¯ï¼Œå¾ˆå¤šé¢å¤–ä¿¡æ¯æ¯”å¦‚è¯´EXIFéƒ½å·²ç»ä¸¢å¤±äº†ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œå¯ä»¥æ·»åŠ å¯¹åº”çš„å…ƒä¿¡æ¯ã€‚ä¸åƒè§£ç é‚£æ ·æä¾›äº†ä¸¤ä¸ªAPIåˆ†åˆ«è·å–å…ƒä¿¡æ¯å’Œå›¾åƒã€‚ä½¿ç”¨çš„æ¥å£æ˜¯CGImageDestinationAddImageã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœæœ‰è‡ªå®šä¹‰çš„å…ƒä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å¦å¤–çš„CGImageDestinationAddImageAndMetadataæ¥æ·»åŠ CGImageMetadataï¼Œè¿™ä¸ªä¸Šé¢è§£ç ä¹Ÿè¯´åˆ°è¿‡ï¼Œè¿™é‡Œå°±ä¸è§£é‡Šäº†ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªImageIOæœ€å¼ºå¤§çš„åŠŸèƒ½ï¼Œå«åšCGImageDestinationAddImageFromSourceï¼ˆè¿™ä¸ªä¸œè¥¿å¯ä»¥åª²ç¾vImageConvert_AnyToAnyï¼Œåç»­æ•™ç¨‹ä¼šè°ˆåˆ°ï¼‰ï¼Œè¿™ä¸ªèƒ½å¤Ÿä»ä¸€ä¸ªä»»æ„çš„CGImageSourceï¼Œæ·»åŠ ä¸€ä¸ªå›¾åƒå¸§åˆ°ä»»æ„ä¸€ä¸ªCGImageDestinationã€‚è¿™ä¸ªä¸€èˆ¬çš„ç”¨é€”ï¼Œå°±æ˜¯ä¸“é—¨ç»™å›¾åƒè½¬æ¢å™¨ç”¨çš„ï¼Œæ¯”å¦‚è¯´ä»å›¾åƒæ ¼å¼Aï¼Œè½¬æ¢åˆ°å›¾åƒæ ¼å¼Bã€‚æˆ‘ä»¬ä¸éœ€è¦å…ˆè§£ç åˆ°Açš„UIImageï¼Œå†é€šè¿‡ç¼–ç åˆ°Bçš„NSDataï¼Œç›´æ¥åœ¨ä¸­é—´å°±è¿›è¡Œäº†è½¬æ¢ã€‚èƒ½å¤Ÿæå¤§åœ°æå‡è½¬æ¢æ•ˆç‡ï¼ˆImage/IOåº•å±‚å°±æ˜¯é€šè¿‡vImageï¼Œä¼ çš„æ˜¯Bitmapçš„å¼•ç”¨ï¼Œæ²¡æœ‰é¢å¤–çš„æ¶ˆè€—ï¼‰ã€‚ä¸è¿‡è¿™ç¯‡æ•™ç¨‹ä¾§é‡äºImage/IOçš„ç¼–ç å’Œè§£ç ï¼Œè½¬æ¢å¯ä»¥è‡ªè¡Œå‚è€ƒå¤„ç†ï¼Œä¸å†è¯¦ç»†è¯´æ˜äº†ã€‚</p><h3 id="3-ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†"><a href="#3-ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†" class="headerlink" title="3. ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†"></a>3. ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†</h3><p>å½“æ·»åŠ å®Œæˆæ‰€æœ‰éœ€è¦ç¼–ç çš„CGImageä¹‹åï¼Œæœ€åä¸€æ­¥ï¼Œå°±æ˜¯è¿›è¡Œç¼–ç ï¼Œå¾—åˆ°å›¾åƒæ ¼å¼çš„æ•°æ®ã€‚è¿™é‡Œç›´æ¥ç”¨ä¸€ä¸ªæ–¹æ³•CGImageDestinationFinalizeå³å¯ï¼Œç¼–ç å¾—åˆ°çš„æ•°æ®ï¼Œä¼šå†™å…¥æœ€æ—©åˆå§‹åŒ–æ—¶æä¾›çš„Dataæˆ–è€…DataConsumerã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»‹ç»ä¸‹iOSä¸­ImageIOçš„æ¦‚è§ˆä¸åº”ç”¨&lt;br&gt;&lt;a href=&quot;https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/ImageIOGuide/imageio_intro/ikpg_intro.html#//apple_ref/doc/uid/TP40005462-CH201-TPXREF101&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Image I/O Programming Guide&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;ä»‹ç»&quot;&gt;&lt;a href=&quot;#ä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;ä»‹ç»&quot;&gt;&lt;/a&gt;ä»‹ç»&lt;/h2&gt;&lt;p&gt; ImageIOæ¡†æ¶æä¾›äº†è¯»å–ä¸å†™å…¥å›¾ç‰‡æ•°æ®çš„åŸºæœ¬æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥ç›´æ¥è·å–åˆ°å›¾ç‰‡æ–‡ä»¶çš„å†…å®¹æ•°æ®ï¼ŒImageIOå…·æœ‰å¾ˆå¤šç‰¹æ€§ &lt;code&gt;Macå¹³å°ä¸Šæœ€å¿«çš„å›¾åƒè§£ç å™¨å’Œç¼–ç å™¨&lt;/code&gt; &lt;code&gt;é€æ­¥åŠ è½½å›¾åƒçš„èƒ½åŠ›`&lt;/code&gt;æ”¯æŒå›¾åƒå…ƒæ•°æ®&lt;code&gt;&lt;/code&gt;æœ‰æ•ˆç¼“å­˜` ImageIOæ¡†æ¶ä¸­åŒ…å«6ä¸ªå¤´æ–‡ä»¶:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ImageIO.CGImageAnimation&lt;/li&gt;
&lt;li&gt;ImageIO.CGImageDestination è´Ÿè´£å†™å…¥å›¾ç‰‡æ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;ImageIO.CGImageMetadata å›¾ç‰‡æ–‡ä»¶å…ƒæ•°æ®ç±»&lt;/li&gt;
&lt;li&gt;ImageIO.CGImageProperties å®šä¹‰äº†æ¡†æ¶ä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡å’Œå®ã€‚&lt;/li&gt;
&lt;li&gt;ImageIO.CGImageSource è´Ÿè´£è¯»å–å›¾ç‰‡æ•°æ®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ImageIO.ImageIOBase é¢„å¤„ç†é€»è¾‘&lt;/p&gt;
    
    </summary>
    
      <category term="iOSå›¾ç‰‡" scheme="https://developerdoc.com/categories/iOS%E5%9B%BE%E7%89%87/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="å›¾ç‰‡" scheme="https://developerdoc.com/tags/%E5%9B%BE%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•</title>
    <link href="https://developerdoc.com/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E5%9B%BE%E7%89%87%E7%BC%A9%E7%95%A5%E6%96%B9%E6%B3%95/"/>
    <id>https://developerdoc.com/quick-start/å›¾ç‰‡/iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•/</id>
    <published>2019-12-04T13:14:37.000Z</published>
    <updated>2020-01-15T09:30:11.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>ä»‹ç»ä¸‹åœ¨iOSä¸­çš„å¤šç§å›¾ç‰‡ç¼©ç•¥æ–¹å¼<br>ref <a href="https://nshipster.com/image-resizing/" target="_blank" rel="noopener">https://nshipster.com/image-resizing/</a></p></blockquote><p>åœ¨<code>UIKit CoreGraphics ImageIO CoreImage vImage</code>å¤šç§ç¼©ç•¥æ–¹æ³•ä¸­ Core Imageè¡¨ç°æœ€å·®ã€‚Core Graphics å’Œ Image I/Oæœ€å¥½ã€‚</p><p>å®é™…ä¸Šï¼Œåœ¨è‹¹æœå®˜æ–¹åœ¨ <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_performance/ci_performance.html#//apple_ref/doc/uid/TP30001185-CH10-SW1" target="_blank" rel="noopener">Performance Best Practices section of the Core Image Programming Guide</a> éƒ¨åˆ†ä¸­ç‰¹åˆ«æ¨èä½¿ç”¨Core Graphicsæˆ–Image I / OåŠŸèƒ½é¢„å…ˆè£å‰ªæˆ–ç¼©å°å›¾åƒã€‚</p><a id="more"></a><h3 id="UIKit"><a href="#UIKit" class="headerlink" title="UIKit"></a>UIKit</h3><p>UIGraphicsBeginImageContextWithOptions &amp; UIImage -drawInRect:</p><p>ç”¨äºå›¾åƒå¤§å°è°ƒæ•´çš„æœ€é«˜çº§APIå¯ä»¥åœ¨UIKitæ¡†æ¶ä¸­æ‰¾åˆ°ã€‚ç»™å®šä¸€ä¸ªUIImageï¼Œå¯ä»¥ä½¿ç”¨ä¸´æ—¶å›¾å½¢ä¸Šä¸‹æ–‡æ¥æ¸²æŸ“ç¼©æ”¾ç‰ˆæœ¬ã€‚è¿™ç§æ–¹å¼æœ€ç®€</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func uikit_resize(oriImg:<span class="built_in">UIImage</span>?,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    let hasAlpha = <span class="literal">false</span></span><br><span class="line">    let scale: <span class="built_in">CGFloat</span> = <span class="number">0.0</span> <span class="comment">// Automatically use scale factor of main screen</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     åˆ›å»ºä¸€ä¸ªå›¾ç‰‡ç±»å‹çš„ä¸Šä¸‹æ–‡ã€‚è°ƒç”¨UIGraphicsBeginImageContextWithOptionså‡½æ•°å°±å¯è·å¾—ç”¨æ¥å¤„ç†å›¾ç‰‡çš„å›¾å½¢ä¸Šä¸‹æ–‡ã€‚åˆ©ç”¨è¯¥ä¸Šä¸‹æ–‡ï¼Œä½ å°±å¯ä»¥åœ¨å…¶ä¸Šè¿›è¡Œç»˜å›¾ï¼Œå¹¶ç”Ÿæˆå›¾ç‰‡</span></span><br><span class="line"><span class="comment">     sizeï¼šè¡¨ç¤ºæ‰€è¦åˆ›å»ºçš„å›¾ç‰‡çš„å°ºå¯¸</span></span><br><span class="line"><span class="comment">     opaqueï¼šè¡¨ç¤ºè¿™ä¸ªå›¾å±‚æ˜¯å¦å®Œå…¨é€æ˜ï¼Œå¦‚æœå›¾å½¢å®Œå…¨ä¸ç”¨é€æ˜æœ€å¥½è®¾ç½®ä¸ºYESä»¥ä¼˜åŒ–ä½å›¾çš„å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥è®©å›¾å±‚åœ¨æ¸²æŸ“çš„æ—¶å€™æ•ˆç‡æ›´é«˜</span></span><br><span class="line"><span class="comment">     scaleï¼šæŒ‡å®šç”Ÿæˆå›¾ç‰‡çš„ç¼©æ”¾å› å­ï¼Œè¿™ä¸ªç¼©æ”¾å› å­ä¸UIImageçš„scaleå±æ€§æ‰€æŒ‡çš„å«ä¹‰æ˜¯ä¸€è‡´çš„ã€‚ä¼ å…¥0åˆ™è¡¨ç¤ºè®©å›¾ç‰‡çš„ç¼©æ”¾å› å­æ ¹æ®å±å¹•çš„åˆ†è¾¨ç‡è€Œå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„å›¾ç‰‡ä¸ç®¡æ˜¯åœ¨å•åˆ†è¾¨ç‡è¿˜æ˜¯è§†ç½‘è†œå±ä¸Šçœ‹èµ·æ¥éƒ½ä¼šå¾ˆå¥½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, !hasAlpha, scale)</span><br><span class="line">    oriImg!.draw(<span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    let resizedImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>()</span><br><span class="line">    <span class="keyword">return</span> resizedImage!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//in iOS 10 UIGraphicsImageRenderer</span></span><br><span class="line"><span class="comment">//    let render  = UIGraphicsImageRenderer(size: size)</span></span><br><span class="line"><span class="comment">//    return render.image(actions: &#123; (context) in</span></span><br><span class="line"><span class="comment">//        oriImg?.draw(in: CGRect(origin: .zero, size: size))</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CoreGraphics"><a href="#CoreGraphics" class="headerlink" title="CoreGraphics"></a>CoreGraphics</h3><p> CGBitmapContextCreate &amp; CGContextDrawImage</p><p> CoreGraphics / Quartz 2Dæä¾›äº†ä¸€å¥—è¾ƒä½çº§åˆ«çš„APIï¼Œå…è®¸è¿›è¡Œæ›´é«˜çº§çš„é…ç½®ã€‚ ç»™å®šä¸€ä¸ªCGImageï¼Œä½¿ç”¨ä¸´æ—¶ä½å›¾ä¸Šä¸‹æ–‡æ¥æ¸²æŸ“ç¼©æ”¾åçš„å›¾åƒã€‚<br> ä½¿ç”¨CoreGraphicså›¾åƒçš„è´¨é‡ä¸UIKitå›¾åƒç›¸åŒã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">func coreGraphics_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>)-&gt;<span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    let bitsPerComponent = cgImage.bitsPerComponent</span><br><span class="line">    let bytesPerRow = cgImage.bytesPerRow</span><br><span class="line">    let colorSpace = cgImage.colorSpace</span><br><span class="line">    let bitmapInfo = cgImage.bitmapInfo</span><br><span class="line">    </span><br><span class="line">    let context = <span class="built_in">CGContext</span>(data: <span class="literal">nil</span>,</span><br><span class="line">                                  width: Int(size.width),</span><br><span class="line">                                  height: Int(size.height),</span><br><span class="line">                                  bitsPerComponent: bitsPerComponent,</span><br><span class="line">                                  bytesPerRow: bytesPerRow,</span><br><span class="line">                                  space: colorSpace!,</span><br><span class="line">                                  bitmapInfo: bitmapInfo.rawValue)</span><br><span class="line">    </span><br><span class="line">    context?.interpolationQuality = .high</span><br><span class="line">    </span><br><span class="line">    context?.draw(cgImage, <span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    guard let resizedImage = context?.makeImage() <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: resizedImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ImageIO"><a href="#ImageIO" class="headerlink" title="ImageIO"></a>ImageIO</h3><p> CGImageSourceCreateThumbnailAtIndex</p><p> Image I / Oæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä½†é²œä¸ºäººçŸ¥çš„ç”¨äºå¤„ç†å›¾åƒçš„æ¡†æ¶ã€‚ ç‹¬ç«‹äºCore Graphicsï¼Œå®ƒå¯ä»¥åœ¨è®¸å¤šä¸åŒæ ¼å¼ä¹‹é—´è¯»å–å’Œå†™å…¥ï¼Œè®¿é—®ç…§ç‰‡å…ƒæ•°æ®ä»¥åŠæ‰§è¡Œå¸¸è§çš„å›¾åƒå¤„ç†æ“ä½œã€‚ è¿™ä¸ªåº“æä¾›äº†è¯¥å¹³å°ä¸Šæœ€å¿«çš„å›¾åƒç¼–ç å™¨å’Œè§£ç å™¨ï¼Œå…·æœ‰å…ˆè¿›çš„ç¼“å­˜æœºåˆ¶ï¼Œç”šè‡³å¯ä»¥é€æ­¥åŠ è½½å›¾åƒ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">func imageIO_resize(url:URL,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    let options: [<span class="built_in">CFString</span>: Any] = [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageIfAbsent: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize: max(size.width, size.height)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    guard let imageSource = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>),</span><br><span class="line">        let image = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSource, <span class="number">0</span>, options as <span class="built_in">CFDictionary</span>)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: image)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CoreImage"><a href="#CoreImage" class="headerlink" title="CoreImage"></a>CoreImage</h3><p> é‡Œé¢æä¾›äº†å¼ºå¤§é«˜æ•ˆçš„å›¾åƒå¤„ç†åŠŸèƒ½ï¼Œç”¨æ¥å¯¹åŸºäºåƒç´ çš„å›¾åƒè¿›è¡Œæ“ä½œä¸åˆ†æã€‚IOSæä¾›äº†å¾ˆå¤šå¼ºå¤§çš„æ»¤é•œ(Filter)ï¼Œè¿™äº›Filteræä¾›äº†å„ç§å„æ ·çš„æ•ˆæœï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡æ»¤é•œé“¾å°†å„ç§æ•ˆæœçš„Filterå åŠ èµ·æ¥ï¼Œå½¢æˆå¼ºå¤§çš„è‡ªå®šä¹‰æ•ˆæœï¼Œå¦‚æœä½ å¯¹è¯¥æ•ˆæœä¸æ»¡æ„ï¼Œè¿˜å¯ä»¥å­ç±»åŒ–æ»¤é•œã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">let sharedContext = <span class="built_in">CIContext</span>(options: [.useSoftwareRenderer : <span class="literal">false</span>])</span><br><span class="line">func coreImage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    let scale = (Double)(size.width) / (Double)(oriImg.size.width)</span><br><span class="line">    </span><br><span class="line">    let image = <span class="built_in">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    </span><br><span class="line">    let filter = <span class="built_in">CIFilter</span>(name: <span class="string">"CILanczosScaleTransform"</span>)</span><br><span class="line">    filter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">    filter?.setValue(<span class="built_in">NSNumber</span>(value:scale), forKey: kCIInputScaleKey)</span><br><span class="line">    filter?.setValue(<span class="number">1.0</span>, forKey:kCIInputAspectRatioKey)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    guard let outputCIImage = filter?.outputImage,</span><br><span class="line">        let outputCGImage = sharedContext.createCGImage(outputCIImage,</span><br><span class="line">                                                        from: outputCIImage.extent)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="vImage"><a href="#vImage" class="headerlink" title="vImage"></a>vImage</h3><p> ä½¿ç”¨CPUçš„çŸ¢é‡å¤„ç†å™¨å¤„ç†å¤§å›¾åƒã€‚ å¼ºå¤§çš„å›¾åƒå¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬Core Graphicså’ŒCore Videoäº’æ“ä½œï¼Œæ ¼å¼è½¬æ¢å’Œå›¾åƒå¤„ç†ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">func vimage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    var format = vImage_CGImageFormat(bitsPerComponent: <span class="number">8</span>, bitsPerPixel: <span class="number">32</span>, colorSpace: <span class="literal">nil</span>,</span><br><span class="line">                                      bitmapInfo: <span class="built_in">CGBitmapInfo</span>(rawValue: <span class="built_in">CGImageAlphaInfo</span>.first.rawValue),</span><br><span class="line">                                      version: <span class="number">0</span>, decode: <span class="literal">nil</span>, renderingIntent: .defaultIntent)</span><br><span class="line">    </span><br><span class="line">    var sourceBuffer = vImage_Buffer()</span><br><span class="line">    defer &#123;</span><br><span class="line">        free(sourceBuffer.data)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var error = vImageBuffer_InitWithCGImage(&amp;sourceBuffer, &amp;format, <span class="literal">nil</span>, cgImage, numericCast(kvImageNoFlags))</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a destination buffer</span></span><br><span class="line">    let scale = oriImg.scale</span><br><span class="line">    let destWidth = Int(size.width)</span><br><span class="line">    let destHeight = Int(size.height)</span><br><span class="line">    let bytesPerPixel = cgImage.bitsPerPixel / <span class="number">8</span></span><br><span class="line">    let destBytesPerRow = destWidth * bytesPerPixel</span><br><span class="line">    </span><br><span class="line">    let destData = UnsafeMutablePointer&lt;<span class="built_in">UInt8</span>&gt;.allocate(capacity: destHeight * destBytesPerRow)</span><br><span class="line">    defer &#123;        </span><br><span class="line">        destData.deallocate()</span><br><span class="line">    &#125;</span><br><span class="line">    var destBuffer = vImage_Buffer(data: destData, height: vImagePixelCount(destHeight), width: vImagePixelCount(destWidth), rowBytes: destBytesPerRow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// scale the image</span></span><br><span class="line">    error = vImageScale_ARGB8888(&amp;sourceBuffer, &amp;destBuffer, <span class="literal">nil</span>, numericCast(kvImageHighQualityResampling))</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a CGImage from vImage_Buffer</span></span><br><span class="line">    var destCGImage = vImageCreateCGImageFromBuffer(&amp;destBuffer, &amp;format, <span class="literal">nil</span>, <span class="literal">nil</span>, numericCast(kvImageNoFlags), &amp;error)?.takeRetainedValue()</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a UIImage</span></span><br><span class="line">    let resizedImage = destCGImage.flatMap &#123;</span><br><span class="line">        <span class="built_in">UIImage</span>(cgImage: $<span class="number">0</span>, scale: <span class="number">0.0</span>, orientation: oriImg.imageOrientation)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    destCGImage = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">return</span> resizedImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ä»‹ç»ä¸‹åœ¨iOSä¸­çš„å¤šç§å›¾ç‰‡ç¼©ç•¥æ–¹å¼&lt;br&gt;ref &lt;a href=&quot;https://nshipster.com/image-resizing/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://nshipster.com/image-resizing/&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨&lt;code&gt;UIKit CoreGraphics ImageIO CoreImage vImage&lt;/code&gt;å¤šç§ç¼©ç•¥æ–¹æ³•ä¸­ Core Imageè¡¨ç°æœ€å·®ã€‚Core Graphics å’Œ Image I/Oæœ€å¥½ã€‚&lt;/p&gt;
&lt;p&gt;å®é™…ä¸Šï¼Œåœ¨è‹¹æœå®˜æ–¹åœ¨ &lt;a href=&quot;https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_performance/ci_performance.html#//apple_ref/doc/uid/TP30001185-CH10-SW1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Performance Best Practices section of the Core Image Programming Guide&lt;/a&gt; éƒ¨åˆ†ä¸­ç‰¹åˆ«æ¨èä½¿ç”¨Core Graphicsæˆ–Image I / OåŠŸèƒ½é¢„å…ˆè£å‰ªæˆ–ç¼©å°å›¾åƒã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOSå›¾ç‰‡" scheme="https://developerdoc.com/categories/iOS%E5%9B%BE%E7%89%87/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="å›¾ç‰‡" scheme="https://developerdoc.com/tags/%E5%9B%BE%E7%89%87/"/>
    
  </entry>
  
  <entry>
    <title>iOSå®‰è£…åŒ…ç˜¦èº«</title>
    <link href="https://developerdoc.com/essay/ipa_size/"/>
    <id>https://developerdoc.com/essay/ipa_size/</id>
    <published>2019-05-08T08:53:25.000Z</published>
    <updated>2019-05-08T12:17:08.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>refs <em> <a href="http://blog.cnbang.net/tech/2544/" target="_blank" rel="noopener">iOSå¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº«æ–¹æ³•</a><br>refs </em> <a href="http://blog.lessfun.com/blog/2015/09/02/find-unused-resources-in-xcode-project/" target="_blank" rel="noopener">æŸ¥æ‰¾XCodeå·¥ç¨‹ä¸­æ²¡è¢«ä½¿ç”¨çš„å›¾ç‰‡èµ„æº</a></p></blockquote><p>Appleå¯¹å®‰è£…åŒ…å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œç¼©å‡iOSå®‰è£…åŒ…å¤§å°æ˜¯å¾ˆå¤šä¸­å¤§å‹APPéƒ½è¦åšçš„äº‹ï¼Œä¸€èˆ¬é¦–å…ˆä¼šå¯¹èµ„æºæ–‡ä»¶ä¸‹æ‰‹ï¼Œå‹ç¼©å›¾ç‰‡/éŸ³é¢‘ï¼Œå»é™¤ä¸å¿…è¦çš„èµ„æºã€‚è¿™äº›èµ„æºä¼˜åŒ–åšå®Œåï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç˜¦èº«ï¼Œé¡¹ç›®è¶Šå¤§ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å ç”¨çš„ä½“ç§¯è¶Šå¤§ï¼Œåˆå› ä¸ºAppStoreä¼šå¯¹å¯æ‰§è¡Œæ–‡ä»¶åŠ å¯†ï¼Œå¯¼è‡´å¯æ‰§è¡Œæ–‡ä»¶çš„å‹ç¼©ç‡ä½ï¼Œå‹ç¼©åå¯æ‰§è¡Œæ–‡ä»¶å æ•´ä¸ªAPPå®‰è£…åŒ…çš„ä½“ç§¯æ¯”ä¾‹å¤§çº¦æœ‰80%~90%ï¼Œè¿˜æ˜¯æŒºå€¼å¾—ä¼˜åŒ–çš„ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹åœ¨ç ”ç©¶å¯æ‰§è¡Œæ–‡ä»¶è¿‡ç¨‹ä¸­å‘ç°çš„å¯ä»¥ä¼˜åŒ–çš„ç‚¹ã€‚</p><a id="more"></a><h2 id="èµ„æºä¼˜åŒ–"><a href="#èµ„æºä¼˜åŒ–" class="headerlink" title="èµ„æºä¼˜åŒ–"></a>èµ„æºä¼˜åŒ–</h2><p><strong>1.åˆ é™¤æ— ç”¨èµ„æº</strong></p><p>è§£å‹ipaæ–‡ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ— ç”¨èµ„æºå­˜åœ¨ã€‚</p><p>ç°åœ¨åº”è¯¥æ²¡æœ‰APPéœ€è¦æ”¯æŒiPhone4ä»¥ä¸‹çš„æœºå‹äº†ï¼Œæ‰€ä»¥1Xçš„å›¾ç‰‡å¯ä»¥å…¨éƒ¨åˆ æ‰ã€‚3Xçš„å›¾ç‰‡æ˜¯ä¿ç•™è¿˜æ˜¯åˆ æ‰çœ‹å…·ä½“æƒ…å†µã€‚</p><p>é‡å¤çš„å›¾ç‰‡åˆ†ä¸¤ç§ï¼Œä¸€ç§æ˜¯åå­—ä¸€æ ·çš„å›¾ç‰‡ï¼Œå¦‚æœä½ ä½¿ç”¨.xcassetsæ¥ç®¡ç†å›¾ç‰‡ï¼Œé‚£ä¹ˆXcodeçš„å·¦è¾¹æ ä¼šæœ‰è­¦å‘Šæç¤ºå›¾ç‰‡åå­—é‡å¤ï¼Œç›´æ¥æŒ‰æç¤ºä¸€ä¸€å¤„ç†å³å¯</p><p><strong>2.èµ„æºå‹ç¼©</strong></p><p>é¦–å…ˆæ˜¯<em>å›¾ç‰‡å‹ç¼©</em>ï¼ŒImageOptim/TinyPNG/ImageAlapha å·¥å…·å¯ä»¥å®ç°æ— æŸå‹ç¼©ã€‚</p><p>å…¶å®åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›å›¾ç‰‡çš„æ—¶å€™,æˆ‘ä»¬å…¶å®æ˜¯ç”¨çš„ä¸€äº›å›¾ç‰‡,ä½†æ˜¯åƒå›¾ç‰‡çš„åˆ›å»ºæ—¥æœŸ,åˆ›å»ºäººä¹‹ç±»çš„ä¿¡æ¯å…¶å®åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­æ˜¯æ²¡æœ‰ç”¨åˆ°çš„.è¿™äº›ä¿¡æ¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·è¿›è¡Œåˆ é™¤,è¿™é‡Œç»™å¤§å®¶æ¨èæ¬¾å·¥å…·ImageOptim.å¦å¤–å…³äºå›¾ç‰‡ï¼Œå»ºè®®ä½¿ç”¨Appleæ¨èçš„.xcassetsæ¥ç®¡ç†ï¼Œå®ƒä¼šæŠŠé‡Œè¾¹çš„æ‰€æœ‰pngæ ¼å¼çš„å›¾ç‰‡å‹ç¼©æˆä¸€ä¸ªAssets.caræ–‡ä»¶ï¼Œå‹ç¼©æ¯”ç‡æ¯”å…¶ä»–æ–¹å¼ç®¡ç†å›¾ç‰‡è¦é«˜ã€‚ä¸è¿‡æµ‹è¯•å‘ç°jpgå›¾ç‰‡ä¸ä¼šåœ¨Assets.caræ–‡ä»¶é‡Œã€‚</p><p>å°½é‡ä½¿ç”¨<em>8-bitå›¾ç‰‡</em></p><p>ä½¿ç”¨8-bitçš„PNGå›¾ç‰‡ï¼Œæ¯”32-bitçš„å›¾ç‰‡èƒ½å‡å°‘4å€çš„å‹ç¼©ç‡ã€‚ç”±äº8-bitçš„å›¾ç‰‡æ”¯æŒæœ€å¤š256ç§ä¸åŒçš„é¢œè‰²ï¼Œæ‰€ä»¥8-bitçš„å›¾ç‰‡ä¸€èˆ¬åªåº”è¯¥ç”¨äºä¸€å°éƒ¨åˆ†çš„é¢œseå›¾ç‰‡ã€‚ä¾‹å¦‚ç°åº¦å›¾ç‰‡æœ€å¥½ä½¿ç”¨8-bitã€‚</p><p><em>éŸ³é¢‘çš„å‹ç¼©</em></p><p>å‚è€ƒWWDCä¸­çš„<a href="https://developer.apple.com/videos/play/wwdc2011/404/" target="_blank" rel="noopener">Audio Development for Games</a>ï¼Œé‡Œé¢ä»‹ç»äº†å¦‚ä½•æœ‰æ•ˆçš„å¤„ç†éŸ³é¢‘ã€‚å¸¸è§„æ¥è¯´ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨AACæˆ–MP3æ¥å‹ç¼©éŸ³é¢‘ï¼Œå¹¶ä¸”å¯ä»¥å°è¯•é™ä½ä¸€ä¸‹éŸ³é¢‘çš„æ¯”ç‰¹ç‡ã€‚æœ‰æ—¶å€™44.1khzçš„é‡‡æ ·æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œç¨å¾®ä½ä¸€ç‚¹çš„æ¯”ç‰¹ç‡ä¹Ÿä¸ä¼šé™ä½éŸ³é¢‘çš„è´¨é‡ã€‚</p><h2 id="ç¼–è¯‘é€‰é¡¹"><a href="#ç¼–è¯‘é€‰é¡¹" class="headerlink" title="ç¼–è¯‘é€‰é¡¹"></a>ç¼–è¯‘é€‰é¡¹</h2><p><strong>1.ç¼–è¯‘å™¨ä¼˜åŒ–çº§åˆ«</strong></p><p>Build Settings-&gt;Optimization Levelæœ‰å‡ ä¸ªç¼–è¯‘ä¼˜åŒ–é€‰é¡¹ï¼Œreleaseç‰ˆåº”è¯¥é€‰æ‹©Fastest, Smalllestï¼Œè¿™ä¸ªé€‰é¡¹ä¼šå¼€å¯é‚£äº›ä¸å¢åŠ ä»£ç å¤§å°çš„å…¨éƒ¨ä¼˜åŒ–ï¼Œå¹¶è®©å¯æ‰§è¡Œæ–‡ä»¶å°½å¯èƒ½å°ã€‚</p><p><strong>2.å»é™¤ç¬¦å·ä¿¡æ¯</strong></p><p>Strip Linked Product / Deployment Postprocessing / Symbols Hidden by Default åœ¨releaseç‰ˆæœ¬åº”è¯¥è®¾ä¸ºyesï¼Œå¯ä»¥å»é™¤ä¸å¿…è¦çš„è°ƒè¯•ç¬¦å·ã€‚Symbols Hidden by Defaultä¼šæŠŠæ‰€æœ‰ç¬¦å·éƒ½å®šä¹‰æˆâ€private externâ€ï¼Œè¯¦ç»†ä¿¡æ¯è§å®˜æ–¹æ–‡æ¡£ã€‚</p><p>è¿™äº›é€‰é¡¹ç›®å‰éƒ½æ˜¯XCodeé‡Œreleaseçš„é»˜è®¤é€‰é¡¹ï¼Œä½†æ—§ç‰ˆXCodeç”Ÿæˆçš„é¡¹ç›®å¯èƒ½ä¸æ˜¯ï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸‹ã€‚å…¶ä»–ä¼˜åŒ–è¿˜å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£â€”<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/CodeFootprint.html" target="_blank" rel="noopener">Introduction to Code Size Performance Guidelines</a></p><h2 id="å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–"><a href="#å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–" class="headerlink" title="å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–"></a>å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–</h2><p><strong>1.é™æ€åº“ç»Ÿè®¡</strong></p><p>é¡¹ç›®é‡Œä¼šå¼•å…¥å¾ˆå¤šç¬¬ä¸‰æ–¹é™æ€åº“ï¼Œå¦‚æœèƒ½çŸ¥é“è¿™äº›ç¬¬ä¸‰æ–¹åº“åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œå ç”¨çš„å¤§å°ï¼Œå°±å¯ä»¥è¯„ä¼°æ˜¯å¦å€¼å¾—å»æ‰¾æ›¿ä»£æ–¹æ¡ˆå»æ‰è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ã€‚æˆ‘ä»¬å¯ä»¥ä»linkmapä¸­ç»Ÿè®¡å‡ºè¿™ä¸ªä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡linkmapç»Ÿè®¡æ¯ä¸ª.oç›®æ ‡æ–‡ä»¶å ç”¨çš„ä½“ç§¯å’Œæ¯ä¸ª.aé™æ€åº“å ç”¨çš„ä½“ç§¯</p><p><strong>2.ARCè½¬MRC</strong></p><p>æœ‰äººæå‡ºç”¨ARCå†™çš„ä»£ç ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ä¼šæ¯”ç”¨MRCå¤§çš„ï¼ŒåŸå› å¤§è‡´æ˜¯ARCä»£ç ä¼šåœ¨æŸäº›æƒ…å†µå¤šå‡ºä¸€äº›retainå’Œreleaseçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›çš„å¯¹è±¡ä¼šè¢«retainï¼Œé€€å‡ºä½œç”¨åŸŸåä¼šè¢«releaseï¼ŒMRCå°±ä¸éœ€è¦ï¼Œæ±‡ç¼–æŒ‡ä»¤å˜å¤šï¼Œæœºå™¨ç å˜å¤šï¼Œå¯æ‰§è¡Œæ–‡ä»¶å°±å˜å¤§äº†ã€‚è¿˜æœ‰å…¶ä»–ç»†èŠ‚å®ç°çš„åŒºåˆ«ï¼Œå…ˆä¸çº ç»“äº†ã€‚</p><p>é‚£ç”¨ARCç©¶ç«Ÿä¼šå¢å¤§å¤šå°‘ä½“ç§¯ï¼Ÿæˆ‘è§‰å¾—ä»æ±‡ç¼–æŒ‡ä»¤çš„å¢å¤šå‡å°‘å»ç®—æ˜¯å¾ˆéš¾ç®—å‡†ç¡®çš„ï¼Œè¿™ä¸œè¥¿æ¶‰åŠç»†èŠ‚å¤ªå¤šï¼Œè¿˜æ˜¯å¾—ä»ç»Ÿè®¡çš„è§’åº¦è®¡ç®—ã€‚åšäº†å‡ ä¸ªå¯¹æ¯”è¯•éªŒï¼Œç»Ÿè®¡äº†å‡ ä¸ªåŒæ—¶æ”¯æŒARC/MRCçš„å¼€æºé¡¹ç›®åœ¨å¼€å¯/å…³é—­ARCçš„æƒ…å†µä¸‹<strong>TEXTä»£ç æ®µçš„å¤§å°å¯¹æ¯”ã€‚åªå¯¹æ¯”</strong>TEXTä»£ç æ®µæ˜¯å› ä¸ºï¼š</p><p>ARCå¯¹å¯æ‰§è¡Œæ–‡ä»¶å¤§å°çš„å½±å“å‡ ä¹éƒ½æ˜¯åœ¨ä»£ç æ®µARCå¤§æ¦‚ä¼šä½¿ä»£ç æ®µå¢åŠ 10%çš„sizeï¼Œè€ƒè™‘ä»£ç æ®µå å¯æ‰§è¡Œæ–‡ä»¶å¤§çº¦æœ‰80%ï¼Œä¼°è®¡å¯¹æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å½±å“ä¼šæ˜¯8%ã€‚</p><p>å¯ä»¥è¯„ä¼°ä¸€ä¸‹8%çš„ä½“ç§¯ä¸‹é™æ˜¯ä¸æ˜¯å€¼å¾—æŠŠé¡¹ç›®é‡ŒæŸäº›æ¨¡å—æ”¹æˆMRCï¼Œè¿™æ ·ç¨‹åºçš„ç»´æŠ¤æˆæœ¬ä¸Šå‡äº†ï¼Œä¸€èˆ¬ä¸åˆ°ç‰¹æ®Šæƒ…å†µä¸å»ºè®®è¿™ä¹ˆåšã€‚</p><p><strong>3.æ— ç”¨ä»£ç </strong></p><p>åœ¨é¡¹ç›®é‡Œæ–°å»ºä¸€ä¸ªç±»ï¼Œç»™å®ƒæ·»åŠ å‡ ä¸ªæ–¹æ³•ï¼Œä½†ä¸è¦åœ¨ä»»ä½•åœ°æ–¹importå®ƒï¼Œbuildå®Œé¡¹ç›®åè§‚å¯Ÿlinkmapï¼Œä½ ä¼šå‘ç°è¿™ä¸ªç±»è¿˜æ˜¯è¢«ç¼–è¯‘è¿›å¯æ‰§è¡Œæ–‡ä»¶äº†ã€‚</p><p>å› ä¸ºobject-cçš„åŠ¨æ€ç‰¹æ€§ï¼Œå®ƒå¯ä»¥é€šè¿‡ç±»å’Œæ–¹æ³•ååå°„è·å¾—è¿™ä¸ªç±»å’Œæ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œæ‰€ä»¥å°±ç®—åœ¨ä»£ç é‡ŒæŸä¸ªç±»æ²¡è¢«ä½¿ç”¨åˆ°ï¼Œç¼–è¯‘å™¨ä¹Ÿæ²¡æ³•ä¿è¯è¿™ä¸ªç±»ä¸ä¼šåœ¨è¿è¡Œæ—¶é€šè¿‡åå°„å»è°ƒç”¨ï¼Œæ‰€ä»¥åªè¦æ˜¯åœ¨é¡¹ç›®é‡Œçš„æ–‡ä»¶ï¼Œæ— è®ºæ˜¯å¦åˆè¢«ä½¿ç”¨åˆ°éƒ½ä¼šè¢«ç¼–è¯‘è¿›å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è„šæœ¬ï¼Œéå†æ•´ä¸ªé¡¹ç›®çš„æ–‡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰æ²¡æœ‰è¢«å¼•ç”¨çš„ç±»æ–‡ä»¶å’Œæ²¡æœ‰è¢«è°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨ä¿è¯æ²¡æœ‰å…¶ä»–åœ°æ–¹åŠ¨æ€è°ƒç”¨çš„æƒ…å†µä¸‹æŠŠå®ƒä»¬å»æ‰ã€‚å¦‚æœæ•´ä¸ªé¡¹ç›®å†æ—¶å¾ˆé•¿ï¼Œå†æ—¶ä»£ç é—ç•™è¾ƒå¤šï¼Œè¿™ä¸ªæ¸…ç†å¯¹å¯æ‰§è¡Œæ–‡ä»¶çœå‡ºçš„ç©ºé—´è¿˜æ˜¯æŒºå¯è§‚çš„ã€‚</p><p><strong>4.ç±»/æ–¹æ³•åé•¿åº¦</strong></p><p>è§‚å¯Ÿlinkmapå¯ä»¥å‘ç°æ¯ä¸ªç±»å’Œæ–¹æ³•åéƒ½åœ¨__cstringæ®µé‡Œéƒ½å­˜äº†ç›¸åº”çš„å­—ç¬¦ä¸²å€¼ï¼Œæ‰€ä»¥ç±»å’Œæ–¹æ³•åçš„é•¿çŸ­ä¹Ÿæ˜¯å¯¹å¯æ‰§è¡Œæ–‡ä»¶å¤§å°æ˜¯æœ‰å½±å“çš„ï¼ŒåŸå› è¿˜æ˜¯object-cçš„åŠ¨æ€ç‰¹æ€§ï¼Œå› ä¸ºéœ€è¦é€šè¿‡ç±»/æ–¹æ³•ååå°„æ‰¾åˆ°è¿™ä¸ªç±»/æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œobject-cå¯¹è±¡æ¨¡å‹ä¼šæŠŠç±»/æ–¹æ³•åå­—ç¬¦ä¸²éƒ½ä¿å­˜ä¸‹æ¥ã€‚</p><p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨ç¼–è¯‘å‰æŠŠæ‰€æœ‰ç±»å’Œæ–¹æ³•åè¿›è¡Œæ··æ·†ï¼Œè·Ÿå‹ç¼©jsä¸€æ ·ï¼ŒæŠŠé•¿åå­—æ›¿æ¢æˆçŸ­åå­—ï¼Œè¿™æ ·åšçš„å¥½å¤„é™¤äº†ç¼©å°ä½“ç§¯å¤–ï¼Œè¿˜å¯¹å®‰å…¨æ€§æœ‰å¾ˆå¤§æå‡ï¼Œåˆ«äººæ‹¿åˆ°å¯æ‰§è¡Œæ–‡ä»¶å¯¹å®ƒclass-dumpå‡ºæ¥çš„ç»“æœéƒ½æ˜¯æ··æ·†åçš„ç±»å’Œæ–¹æ³•åï¼Œå°±æ— æ³•ä»ç±»å’Œæ–¹æ³•åä¸­çŒœå‡ºæŸä¸ªæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Œå°±éš¾ä»¥æŒ‚é’©å­è¿›è¡Œhackã€‚ä¸è¿‡è¿™æ ·åšæœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯crashå †æ ˆåè§£å‡ºæ¥çš„å †æ ˆæ–¹æ³•åä¼šæ˜¯æ··æ·†åçš„ï¼Œéœ€è¦å†åŠ ä¸€å±‚æ··æ·†-&gt;åŸåçš„è½¬æ¢ï¼Œå®ç°å’Œä½¿ç”¨æˆæœ¬æœ‰ç‚¹é«˜ã€‚</p><p>å®é™…ä¸Šè¿™éƒ¨åˆ†å ç”¨çš„é•¿åº¦æ¯”è¾ƒå°ï¼Œä¸­å‹é¡¹ç›®ä¹Ÿå°±å‡ ç™¾Kï¼Œå¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„æƒ…å†µå¯ä»¥è¯•è¯•ã€‚</p><p><strong>5.å†—ä½™å­—ç¬¦ä¸²</strong></p><p>ä»£ç ä¸Šå®šä¹‰çš„æ‰€æœ‰é™æ€å­—ç¬¦ä¸²éƒ½ä¼šè®°å½•åœ¨åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„__cstringæ®µï¼Œå¦‚æœé¡¹ç›®é‡ŒLogéå¸¸å¤šï¼Œè¿™ä¸ªç©ºé—´å ç”¨ä¹Ÿæ˜¯å¯è§‚çš„ï¼Œä¹Ÿæœ‰å‡ ç™¾Kçš„å¤§å°ï¼Œå¯ä»¥è€ƒè™‘æ¸…ç†æ‰€æœ‰å†—ä½™çš„å­—ç¬¦ä¸²ã€‚å¦å¤–å¦‚æœæœ‰ç‰¹åˆ«é•¿çš„å­—ç¬¦ä¸²ï¼Œå»ºè®®æŠ½ç¦»ä¿å­˜æˆé™æ€æ–‡ä»¶ï¼Œå› ä¸ºAppStoreå¯¹å¯æ‰§è¡Œæ–‡ä»¶åŠ å¯†å¯¼è‡´å‹ç¼©ç‡ä½ï¼Œç‰¹åˆ«é•¿çš„å­—ç¬¦ä¸²æŠ½ç¦»æˆé™æ€èµ„æºæ–‡ä»¶åå‹ç¼©ç‡ä¼šæ¯”åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œé«˜å¾ˆå¤šã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;refs &lt;em&gt; &lt;a href=&quot;http://blog.cnbang.net/tech/2544/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;iOSå¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº«æ–¹æ³•&lt;/a&gt;&lt;br&gt;refs &lt;/em&gt; &lt;a href=&quot;http://blog.lessfun.com/blog/2015/09/02/find-unused-resources-in-xcode-project/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;æŸ¥æ‰¾XCodeå·¥ç¨‹ä¸­æ²¡è¢«ä½¿ç”¨çš„å›¾ç‰‡èµ„æº&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Appleå¯¹å®‰è£…åŒ…å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œç¼©å‡iOSå®‰è£…åŒ…å¤§å°æ˜¯å¾ˆå¤šä¸­å¤§å‹APPéƒ½è¦åšçš„äº‹ï¼Œä¸€èˆ¬é¦–å…ˆä¼šå¯¹èµ„æºæ–‡ä»¶ä¸‹æ‰‹ï¼Œå‹ç¼©å›¾ç‰‡/éŸ³é¢‘ï¼Œå»é™¤ä¸å¿…è¦çš„èµ„æºã€‚è¿™äº›èµ„æºä¼˜åŒ–åšå®Œåï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°è¯•å¯¹å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç˜¦èº«ï¼Œé¡¹ç›®è¶Šå¤§ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å ç”¨çš„ä½“ç§¯è¶Šå¤§ï¼Œåˆå› ä¸ºAppStoreä¼šå¯¹å¯æ‰§è¡Œæ–‡ä»¶åŠ å¯†ï¼Œå¯¼è‡´å¯æ‰§è¡Œæ–‡ä»¶çš„å‹ç¼©ç‡ä½ï¼Œå‹ç¼©åå¯æ‰§è¡Œæ–‡ä»¶å æ•´ä¸ªAPPå®‰è£…åŒ…çš„ä½“ç§¯æ¯”ä¾‹å¤§çº¦æœ‰80%~90%ï¼Œè¿˜æ˜¯æŒºå€¼å¾—ä¼˜åŒ–çš„ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹åœ¨ç ”ç©¶å¯æ‰§è¡Œæ–‡ä»¶è¿‡ç¨‹ä¸­å‘ç°çš„å¯ä»¥ä¼˜åŒ–çš„ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>fishhookæºç å­¦ä¹ </title>
    <link href="https://developerdoc.com/essay/LLDB/fishhook_code_analyze/"/>
    <id>https://developerdoc.com/essay/LLDB/fishhook_code_analyze/</id>
    <published>2019-05-08T02:29:22.000Z</published>
    <updated>2019-05-08T02:44:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡ <a href="/essay/LLDB/Mach-O_fishhook/">Mach-Oåº”ç”¨ fishhookåŠ¨æ€ä¿®æ”¹Cå‡½æ•°</a> äº†è§£äº†fishhookçš„åŸç†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ›¿æ¢åŸæœ‰å‡½æ•°å®ç°çš„ã€‚</p><a id="more"></a><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹rebind_symbolsè¿™ä¸ªå¯¹å¤–çš„æ¥å£ï¼Œå…¶ä¸­åº”ç”¨åˆ°çš„Cå‡½æ•°ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li><code>_dyld_image_count(void)</code> å½“å‰dyldè£…è½½çš„imageæ•°é‡</li><li><code>_dyld_get_image_header(unit32_t image_index)</code> è¿”å›imageå¯¹åº”çš„Mach Headeråœ°å€</li><li><code>_dyld_get_image_vmaddr_slide(unit32_t image_index)</code> è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€åç§»é‡</li></ul><p>å¯¹å®ç°çš„åˆ†æä¼š rebind_symbols å‡½æ•°ä¸ºå…¥å£ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨æ ˆï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br><span class="line">â””â”€â”€ <span class="keyword">extern</span> <span class="keyword">void</span> _dyld_register_func_for_add_image(<span class="keyword">void</span> (*func)(<span class="keyword">const</span> struct mach_header* mh, <span class="keyword">intptr_t</span> vmaddr_slide));</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span><br><span class="line">â””â”€â”€ <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span></span></span><br><span class="line">â””â”€â”€ static void perform_rebinding_with_section(struct rebindings_entry *rebindings, section_t *section, intptr_t slide, nlist_t *symtab, char *strtab, uint32_t *indirect_symtab)</span><br></pre></td></tr></table></figure><p>å…¶å®å‡½æ•°è°ƒç”¨æ ˆéå¸¸ç®€å•ï¼Œå› ä¸ºæ•´ä¸ªåº“ä¸­ä¹Ÿæ²¡æœ‰å‡ ä¸ªå‡½æ•°ï¼Œrebind_symbols ä½œä¸ºæ¥å£ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯æ³¨å†Œä¸€ä¸ªå‡½æ•°å¹¶åœ¨é•œåƒåŠ è½½æ—¶å›è°ƒï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>) <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">_dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">uint32_t</span> c = _dyld_image_count();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; c; i++) &#123;</span><br><span class="line">_rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ rebind_symbols æœ€å¼€å§‹æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆè°ƒç”¨ä¸€ä¸ª prepend_rebindings çš„å‡½æ•°ï¼Œå°†æ•´ä¸ª rebindings æ•°ç»„æ·»åŠ åˆ° _rebindings_head è¿™ä¸ªç§æœ‰æ•°æ®ç»“æ„çš„å¤´éƒ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">prepend_rebindings</span><span class="params">(struct rebindings_entry **rebindings_head,</span></span></span><br><span class="line"><span class="function"><span class="params">  struct rebinding rebindings[],</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">size_t</span> nel)</span> </span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">new_entry</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">rebindings_entry</span>));</span></span><br><span class="line"><span class="keyword">if</span> (!new_entry) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">new_entry-&gt;rebindings = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct rebinding) * nel);</span><br><span class="line"><span class="keyword">if</span> (!new_entry-&gt;rebindings) &#123;</span><br><span class="line"><span class="built_in">free</span>(new_entry);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(new_entry-&gt;rebindings, rebindings, <span class="keyword">sizeof</span>(struct rebinding) * nel);</span><br><span class="line">new_entry-&gt;rebindings_nel = nel;</span><br><span class="line">new_entry-&gt;next = *rebindings_head;</span><br><span class="line">*rebindings_head = new_entry;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨çš„ rebind_symbols æ–¹æ³•ä¼ å…¥çš„ rebindings æ•°ç»„ä»¥åŠæ•°ç»„çš„é•¿åº¦éƒ½ä¼šä»¥ rebindings_entry çš„å½¢å¼æ·»åŠ åˆ° _rebindings_head è¿™ä¸ªç§æœ‰é“¾è¡¨çš„é¦–éƒ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> *<span class="title">rebindings</span>;</span></span><br><span class="line"><span class="keyword">size_t</span> rebindings_nel;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *_<span class="title">rebindings_head</span>;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯ä»¥é€šè¿‡åˆ¤æ–­ _rebindings_head-&gt;next çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œç„¶åä½¿ç”¨ _dyld_register_func_for_add_image å°† _rebind_symbols_for_image æ³¨å†Œä¸ºå›è°ƒæˆ–è€…ä¸ºæ‰€æœ‰å­˜åœ¨çš„é•œåƒå•ç‹¬è°ƒç”¨ _rebind_symbols_for_imageï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide) &#123;</span><br><span class="line">rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_rebind_symbols_for_image åªæ˜¯å¯¹å¦ä¸€ä¸ªåå­—éå¸¸ç›¸ä¼¼çš„å‡½æ•° rebind_symbols_for_image çš„å°è£…ï¼Œä»è¿™ä¸ªå‡½æ•°å¼€å§‹ï¼Œå°±åˆ°äº†é‡ç»‘å®šç¬¦å·çš„è¿‡ç¨‹ï¼›ä¸è¿‡ç”±äºè¿™ä¸ªæ–¹æ³•çš„å®ç°æ¯”è¾ƒé•¿ï¼Œå…·ä½“åˆ†æä¼šåˆ†æˆä¸‰ä¸ªéƒ¨åˆ†å¹¶çœç•¥ä¸€äº›ä¸å½±å“ç†è§£çš„ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">const</span> struct mach_header *header,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">intptr_t</span> slide)</span> </span>&#123;</span><br><span class="line"><span class="keyword">segment_command_t</span> *cur_seg_cmd;</span><br><span class="line"><span class="keyword">segment_command_t</span> *linkedit_segment = <span class="literal">NULL</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span>* <span class="title">symtab_cmd</span> = <span class="title">NULL</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span>* <span class="title">dysymtab_cmd</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uintptr_t</span> cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>);</span><br><span class="line"><span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line"><span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">linkedit_segment = cur_seg_cmd;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">symtab_cmd = (struct symtab_command*)cur_seg_cmd;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">dysymtab_cmd = (struct dysymtab_command*)cur_seg_cmd;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™éƒ¨åˆ†çš„ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ä»é•œåƒä¸­æŸ¥æ‰¾ linkedit_segment symtab_command å’Œ dysymtab_commandï¼›åœ¨å¼€å§‹æŸ¥æ‰¾ä¹‹å‰ï¼Œè¦å…ˆè·³è¿‡ mach_header_t é•¿åº¦çš„ä½ç½®ï¼Œç„¶åå°†å½“å‰æŒ‡é’ˆå¼ºè½¬æˆ segment_command_tï¼Œé€šè¿‡å¯¹æ¯” cmd çš„å€¼ï¼Œæ¥æ‰¾åˆ°éœ€è¦çš„ segment_command_tã€‚</p><p>åœ¨æŸ¥æ‰¾äº†å‡ ä¸ªå…³é”®çš„ segment ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å‡ ä¸ª segment è·å–å¯¹åº”è¡¨çš„å†…å­˜åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">uintptr_t</span> linkedit_base = (<span class="keyword">uintptr_t</span>)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line"><span class="keyword">nlist_t</span> *symtab = (<span class="keyword">nlist_t</span> *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line"><span class="keyword">char</span> *strtab = (<span class="keyword">char</span> *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> *indirect_symtab = (<span class="keyword">uint32_t</span> *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ linkedit_segment ç»“æ„ä½“ä¸­è·å¾—å…¶è™šæ‹Ÿåœ°å€ä»¥åŠæ–‡ä»¶åç§»é‡ï¼Œç„¶åé€šè¿‡ä¸€ä¸‹å…¬å¼æ¥è®¡ç®—å½“å‰ __LINKEDIT æ®µçš„ä½ç½®ï¼š</p><p><code>slide + vmaffr - fileoff</code></p><p>ç±»ä¼¼åœ°ï¼Œåœ¨ symtab_command ä¸­è·å–ç¬¦å·è¡¨åç§»é‡å’Œå­—ç¬¦ä¸²è¡¨åç§»é‡ï¼Œä» dysymtab_command ä¸­è·å–é—´æ¥ç¬¦å·è¡¨ï¼ˆindirect symbol tableï¼‰åç§»é‡ï¼Œå°±èƒ½å¤Ÿè·å¾—<em>ç¬¦å·è¡¨</em>ã€<em>å­—ç¬¦ä¸²è¡¨</em>ä»¥åŠ<em>é—´æ¥ç¬¦å·è¡¨</em>çš„å¼•ç”¨äº†ã€‚</p><ul><li>é—´æ¥ç¬¦å·è¡¨ä¸­çš„å…ƒç´ éƒ½æ˜¯ uint32_t *ï¼ŒæŒ‡é’ˆçš„å€¼æ˜¯å¯¹åº”æ¡ç›® n_list åœ¨ç¬¦å·è¡¨ä¸­çš„ä½ç½®</li><li><p>ç¬¦å·è¡¨ä¸­çš„å…ƒç´ éƒ½æ˜¯ nlist_t ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº†å½“å‰ç¬¦å·åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„ä¸‹æ ‡</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlist_64</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span>  n_strx; <span class="comment">/* index into the string table */</span></span><br><span class="line">&#125; n_un;</span><br><span class="line"><span class="keyword">uint8_t</span> n_type;        <span class="comment">/* type flag, see below */</span></span><br><span class="line"><span class="keyword">uint8_t</span> n_sect;        <span class="comment">/* section number or NO_SECT */</span></span><br><span class="line"><span class="keyword">uint16_t</span> n_desc;       <span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line"><span class="keyword">uint64_t</span> n_value;      <span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>å­—ç¬¦ä¸²è¡¨ä¸­çš„å…ƒç´ æ˜¯ char å­—ç¬¦</p></li></ul><p>è¯¥å‡½æ•°çš„æœ€åä¸€éƒ¨åˆ†å°±å¼€å¯äº†éå†æ¨¡å¼ï¼ŒæŸ¥æ‰¾æ•´ä¸ªé•œåƒä¸­çš„ SECTION_TYPE ä¸º S_LAZY_SYMBOL_POINTERS æˆ–è€… S_NON_LAZY_SYMBOL_POINTERS çš„ sectionï¼Œç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•° perform_rebinding_with_section æ¥å¯¹ section ä¸­çš„ç¬¦å·è¿›è¡Œå¤„ç†ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">perform_rebinding_with_section</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">section_t</span> *section, <span class="keyword">intptr_t</span> slide, <span class="keyword">nlist_t</span> *symtab, <span class="keyword">char</span> *strtab, <span class="keyword">uint32_t</span> *indirect_symtab)</span> </span>&#123;</span><br><span class="line"><span class="keyword">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line"><span class="keyword">void</span> **indirect_symbol_bindings = (<span class="keyword">void</span> **)((<span class="keyword">uintptr_t</span>)slide + section-&gt;addr);</span><br><span class="line"><span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *); i++) &#123;</span><br><span class="line"><span class="keyword">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line"><span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line"><span class="keyword">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">cur</span> = <span class="title">rebindings</span>;</span></span><br><span class="line"><span class="keyword">while</span> (cur) &#123;</span><br><span class="line"><span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">&#125;</span><br><span class="line">indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line"><span class="keyword">goto</span> symbol_loop;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cur = cur-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line">symbol_loop:;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„å®ç°çš„æ ¸å¿ƒå†…å®¹å°±æ˜¯å°†ç¬¦å·è¡¨ä¸­çš„ symbol_name ä¸ rebinding ä¸­çš„åå­— name è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‡ºç°äº†åŒ¹é…ï¼Œå°±ä¼šå°†åŸå‡½æ•°çš„å®ç°ä¼ å…¥ origian_open å‡½æ•°æŒ‡é’ˆçš„åœ°å€ï¼Œå¹¶ä½¿ç”¨æ–°çš„å‡½æ•°å®ç° new_open ä»£æ›¿åŸå®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i]; <span class="comment">// å°†åŸå‡½æ•°çš„å®ç°ä¼ å…¥ original_open å‡½æ•°æŒ‡é’ˆçš„åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement; // ä½¿ç”¨æ–°çš„å‡½æ•°å®ç° new_open æ›¿æ¢åŸå®ç°<br>å¦‚æœä½ ç†è§£äº†ä¸Šé¢çš„å®ç°ä»£ç ï¼Œè¯¥å‡½æ•°çš„å…¶å®ƒä»£ç å°±å¾ˆå¥½ç†è§£äº†ï¼š</p><ol><li>é€šè¿‡ indirect_symtab + section-&gt;reserved1 è·å– indirect_symbol_indices *ï¼Œä¹Ÿå°±æ˜¯ç¬¦å·è¡¨çš„æ•°ç»„</li><li>é€šè¿‡ (void **)((uintptr_t)slide + section-&gt;addr) è·å–å‡½æ•°æŒ‡é’ˆåˆ—è¡¨ indirect_symbol_bindings</li><li>éå†ç¬¦å·è¡¨æ•°ç»„ indirect_symbol_indices * ä¸­çš„æ‰€æœ‰ç¬¦å·è¡¨ä¸­ï¼Œè·å–å…¶ä¸­çš„ç¬¦å·è¡¨ç´¢å¼• symtab_index</li><li>é€šè¿‡ç¬¦å·è¡¨ç´¢å¼• symtab_index è·å–ç¬¦å·è¡¨ä¸­æŸä¸€ä¸ª n_list ç»“æ„ä½“ï¼Œå¾—åˆ°å­—ç¬¦ä¸²è¡¨ä¸­çš„ç´¢å¼• symtab[symtab_index].n_un.n_strx</li><li>æœ€ååœ¨å­—ç¬¦ä¸²è¡¨ä¸­è·å¾—ç¬¦å·çš„åå­— char *symbol_name</li></ol><p>åˆ°è¿™é‡Œæ¯”è¾ƒå‰çš„å‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ï¼Œå‰©ä¸‹çš„ä»£ç ä¼šéå†æ•´ä¸ª rebindings_entry æ•°ç»„ï¼Œåœ¨å…¶ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç¬¦å·ï¼Œå®Œæˆå‡½æ•°å®ç°çš„æ›¿æ¢ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (cur) &#123;</span><br><span class="line"><span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">&#125;</span><br><span class="line">indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line"><span class="keyword">goto</span> symbol_loop;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cur = cur-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹åå¯¹æŸä¸€å‡½æ•°çš„è°ƒç”¨ï¼ˆä¾‹å¦‚ openï¼‰ï¼Œå½“æŸ¥æ‰¾å…¶å‡½æ•°å®ç°æ—¶ï¼Œéƒ½ä¼šæŸ¥æ‰¾åˆ° new_open çš„å‡½æ•°æŒ‡é’ˆï¼›åœ¨ new_open è°ƒç”¨ origianl_open æ—¶ï¼ŒåŒæ ·ä¹Ÿä¼šæ‰§è¡ŒåŸæœ‰çš„å‡½æ•°å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i] å°†åŸå‡½æ•°å®ç°ç»‘å®šåˆ°äº†æ–°çš„å‡½æ•°æŒ‡é’ˆä¸Šã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸Šä¸€ç¯‡ &lt;a href=&quot;/essay/LLDB/Mach-O_fishhook/&quot;&gt;Mach-Oåº”ç”¨ fishhookåŠ¨æ€ä¿®æ”¹Cå‡½æ•°&lt;/a&gt; äº†è§£äº†fishhookçš„åŸç†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ›¿æ¢åŸæœ‰å‡½æ•°å®ç°çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="fishhook" scheme="https://developerdoc.com/tags/fishhook/"/>
    
  </entry>
  
  <entry>
    <title>Mach-Oåº”ç”¨ fishhookåŠ¨æ€ä¿®æ”¹Cå‡½æ•°</title>
    <link href="https://developerdoc.com/essay/LLDB/Mach-O_fishhook/"/>
    <id>https://developerdoc.com/essay/LLDB/Mach-O_fishhook/</id>
    <published>2019-04-29T12:10:20.000Z</published>
    <updated>2019-05-08T02:29:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="fishhookç®€ä»‹"><a href="#fishhookç®€ä»‹" class="headerlink" title="fishhookç®€ä»‹"></a>fishhookç®€ä»‹</h2><p>C è¯­è¨€å¾€å¾€ä¼šç»™æˆ‘ä»¬ç•™ä¸‹ä¸å¯ä¿®æ”¹çš„è¿™ä¸€å°è±¡,è€Œ <a href="https://github.com/facebook/fishhook" target="_blank" rel="noopener">fishhook</a> æ˜¯ä¸€ä¸ªç”± facebook å¼€æºçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯<strong>åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°å®ç°</strong>ã€‚</p><p>è¿™ä¸ªæ¡†æ¶çš„ä»£ç å…¶å®éå¸¸çš„ç®€å•ï¼ŒåªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼šfishhook.c ä»¥åŠ fishhook.hï¼›ä¸¤ä¸ªæ–‡ä»¶æ‰€æœ‰çš„ä»£ç åŠ èµ·æ¥ä¹Ÿä¸è¶…è¿‡ 300 è¡Œã€‚ä¸è¿‡å®ƒçš„å®ç°åŸç†æ˜¯éå¸¸æœ‰æ„æ€å¹¶ä¸”ç²¾å¦™çš„</p><p>fishhook æä¾›éå¸¸ç®€å•çš„ä¸¤ä¸ªæ¥å£ä»¥åŠä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> &#123;</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"><span class="keyword">void</span> *replacement;</span><br><span class="line"><span class="keyword">void</span> **replaced;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols_image</span><span class="params">(<span class="keyword">void</span> *header,<span class="keyword">intptr_t</span> slide,</span></span></span><br><span class="line"><span class="function"><span class="params">struct rebinding rebindings[],</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä» fishhook æä¾›çš„demoä¸­ä¸Šæ‰‹å®è·µä¸€ä¸‹,è¿™é‡Œçš„demoå¯¹ <code>close</code> è¿›è¡Œä¿®æ”¹:</p><a id="more"></a><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"dlfcn.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"fishhook.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜ä¸€ä¸ªä¸åŸå‡½æ•°ç­¾åç›¸åŒçš„å‡½æ•°æŒ‡é’ˆ,ç”¨ä¿å­˜åŸå§‹çš„å‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*orig_close)(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°çš„close</span></span><br><span class="line"><span class="keyword">int</span> my_close(<span class="keyword">int</span> fd) &#123;</span><br><span class="line">    printf(<span class="string">"åšä¸€äº›é¢å¤–æ“ä½œ\n"</span>);</span><br><span class="line">    printf(<span class="string">"è°ƒç”¨åŸ close(%d)\n"</span>, fd);</span><br><span class="line">    <span class="comment">//è°ƒç”¨çš„ orig_close å…¶å®ç›¸å½“äºæ‰§è¡ŒåŸ close</span></span><br><span class="line">    <span class="keyword">return</span> orig_close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> rebinding closeBind;</span><br><span class="line">        <span class="comment">//å‡½æ•°çš„åç§°</span></span><br><span class="line">        closeBind.name = <span class="string">"close"</span>;</span><br><span class="line">        <span class="comment">//æ–°çš„å‡½æ•°åœ°å€</span></span><br><span class="line">        closeBind.replacement = my_close;</span><br><span class="line">        <span class="comment">//ä¿å­˜åŸå§‹å‡½æ•°åœ°å€çš„å˜é‡çš„æŒ‡é’ˆ</span></span><br><span class="line">        closeBind.replaced = (<span class="keyword">void</span> *)&amp;orig_close;</span><br><span class="line">        <span class="comment">//å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="keyword">struct</span> rebinding rebs[] = &#123;closeBind&#125;;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å¯¹ç¬¦å·è¿›è¡Œé‡ç»‘å®š arg1 : å­˜æ”¾rebindingç»“æ„ä½“çš„æ•°ç»„ arg2 : æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rebind_symbols(rebs, <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¼€å§‹æµ‹è¯•:</span></span><br><span class="line">        <span class="keyword">int</span> fd = open(argv[<span class="number">0</span>], O_RDONLY);</span><br><span class="line">        uint32_t magic_number = <span class="number">0</span>;</span><br><span class="line">        read(fd, &amp;magic_number, <span class="number">4</span>);</span><br><span class="line">        printf(<span class="string">"Mach-O Magic Number: %x \n"</span>, magic_number);</span><br><span class="line">        close(fd);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæŸ¥çœ‹è¾“å‡ºçš„ä¿¡æ¯å¯ä»¥çœ‹åˆ° åœ¨å¯¹ç¬¦å·è¿›è¡Œé‡ç»‘å®šä¹‹åï¼Œæ‰€æœ‰è°ƒç”¨ <code>close</code> å‡½æ•°çš„åœ°æ–¹å®é™…ä¸Šéƒ½ä¼šæ‰§è¡Œ <code>my_close</code> çš„å®ç°ï¼Œä¹Ÿå°±å®Œæˆäº†å¯¹ <code>close</code> çš„ä¿®æ”¹ã€‚</p><p>é‚£ä¹ˆ fishhook æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><h2 id="fishhook-åŸç†"><a href="#fishhook-åŸç†" class="headerlink" title="fishhook åŸç†"></a>fishhook åŸç†</h2><p>fishhook æ˜¯ FaceBook å¼€æºçš„å¯ä»¥åŠ¨æ€ä¿®æ”¹ MachO ç¬¦å·è¡¨çš„å·¥å…·ã€‚fishhook çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒå¯ä»¥ HOOK ç³»ç»Ÿçš„é™æ€ C å‡½æ•°ã€‚</p><p>å¤§å®¶éƒ½çŸ¥é“ OC çš„æ–¹æ³•ä¹‹æ‰€ä»¥å¯ä»¥ HOOK æ˜¯å› ä¸ºå®ƒçš„è¿è¡Œæ—¶ç‰¹æ€§ï¼ŒOC çš„æ–¹æ³•è°ƒç”¨åœ¨åº•å±‚éƒ½æ˜¯ msg_sendï¼ˆid,SELï¼‰çš„å½¢å¼ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†äº¤æ¢æ–¹æ³•å®ç°ï¼ˆIMPï¼‰çš„æœºä¼šï¼Œä½† C å‡½æ•°åœ¨ç¼–è¯‘é“¾æ¥æ—¶å°±ç¡®å®šäº†å‡½æ•°æŒ‡é’ˆçš„åœ°å€åç§»é‡ï¼ˆOffsetï¼‰ï¼Œè¿™ä¸ªåç§»é‡åœ¨ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯å›ºå®šçš„ã€‚æ—¢ç„¶ C å‡½æ•°çš„æŒ‡é’ˆåœ°å€æ˜¯ç›¸å¯¹å›ºå®šä¸”ä¸å¯ä¿®æ”¹çš„ï¼Œé‚£ä¹ˆ fishhook åˆæ˜¯æ€ä¹ˆå®ç° å¯¹ C å‡½æ•°çš„ HOOK å‘¢ï¼Ÿ<strong>å…¶å®å†…éƒ¨/è‡ªå®šä¹‰çš„ C å‡½æ•° fishhook ä¹Ÿ HOOK ä¸äº†ï¼Œå®ƒåªèƒ½HOOK Mach-O å¤–éƒ¨ï¼ˆå…±äº«ç¼“å­˜åº“ä¸­ï¼‰çš„å‡½æ•°</strong>ã€‚</p><p>ç°åœ¨å…ˆæ¥çœ‹ä¸€ä¸‹ä»¥ä¸‹è¿™å‡ ä¸ªçŸ¥è¯†ç‚¹:</p><h3 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h3><p>åŠ¨æ€é“¾æ¥å°±æ˜¯è´Ÿè´£å°†å„ç§å„æ ·ç¨‹åºéœ€è¦çš„é•œåƒåŠ è½½åˆ°ç¨‹åºè¿è¡Œçš„å†…å­˜ç©ºé—´ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿçš„æ—¶é—´éå¸¸æ—©ï¼š <em>åœ¨ objc è¿è¡Œæ—¶åˆå§‹åŒ–ä¹‹å‰</em> ã€‚</p><p>å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„demoä¸ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// helloFishhook.m</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Hello, World!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Hello, World!\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æˆ‘ä»¬åœ¨ <a href="/essay/LLDB/iOS_Compiler/">iOSç¼–è¯‘è¿‡ç¨‹</a> ä¸­å®è·µçš„ä¸€æ · ï¼Œå…ˆç”¨clangç¼–è¯‘ä¸€ä¸‹ï¼Œå†ç”¨<code>nm</code>å‘½ä»¤æŸ¥çœ‹ç¬¦å·:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clang helloFishhook.m</span></span><br><span class="line"><span class="comment">#nm -nm a.out </span></span><br><span class="line">                 (undefined) external _printf (from libSystem)</span><br><span class="line">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class="line">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class="line">0000000100000f30 (__TEXT,__text) external _hello_world</span><br><span class="line">0000000100000f50 (__TEXT,__text) external _main</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è‡ªå·±å†™çš„æ–¹æ³• <code>_hello_world</code> ,å®ƒåŒ…å«ä¸€ä¸ªå†…å­˜åœ°å€ä»¥åŠ __TEXT æ®µã€‚ä¹Ÿå°±æ˜¯è¯´æ‰‹å†™çš„ä¸€äº›å‡½æ•°ï¼Œåœ¨ç¼–è¯‘ä¹‹åï¼Œå…¶åœ°å€å¹¶ä¸æ˜¯æœªå®šä¹‰çš„</p><p>ä¸ä¹‹å¯¹æ¯”çš„æ˜¯çœ‹åˆ° <code>_printf</code> è¿™ä¸ªç¬¦å·æ˜¯æœªå®šä¹‰çš„(undefined),<code>dyld_stub_binder</code> ä¼šåœ¨ç›®æ ‡ç¬¦å·ï¼ˆä¾‹å¦‚ printfï¼‰è¢«è°ƒç”¨æ—¶ï¼Œå°†å…¶é“¾æ¥åˆ°æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“ libSystemï¼Œå†æ‰§è¡Œ printf çš„å®ç°</p><p>æ¯ä¸€ä¸ªé•œåƒä¸­çš„ <strong>DATA ç«¯éƒ½åŒ…å«ä¸¤ä¸ªä¸åŠ¨æ€é“¾æ¥æœ‰å…³çš„è¡¨ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ </strong>nl_symbol_ptrï¼Œå¦ä¸€ä¸ªæ˜¯ <code>__la_symbol_ptr</code>ï¼š</p><ul><li><code>__nl_symbol_ptr</code> ä¸­çš„ non-lazy ç¬¦å·æ˜¯åœ¨åŠ¨æ€é“¾æ¥åº“ç»‘å®šçš„æ—¶å€™è¿›è¡ŒåŠ è½½çš„</li><li><code>__la_symbol_ptr</code> ä¸­çš„ç¬¦å·ä¼šåœ¨è¯¥ç¬¦å·è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œé€šè¿‡ dyld ä¸­çš„ dyld_stub_binder è¿‡ç¨‹æ¥è¿›è¡ŒåŠ è½½</li></ul><p>äº†è§£è¿™ä¸¤ç‚¹çš„åŒºåˆ«ï¼Œä½ ä¹Ÿå¤§æ¦‚å¯ä»¥çŒœå‡º fishhook ä¸ºä»€ä¹ˆèƒ½æ›¿æ¢åŸCå‡½æ•°äº†ã€‚</p><h3 id="PICï¼ˆPosition-independent-code"><a href="#PICï¼ˆPosition-independent-code" class="headerlink" title="PICï¼ˆPosition-independent code)"></a>PICï¼ˆPosition-independent code)</h3><p>ä¸ºä»€ä¹ˆ printf æ˜¯æœªå®šä¹‰çš„ï¼Ÿ</p><p>ASLRæŠ€æœ¯ï¼šæ˜¯ä¸€ç§é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºçš„å®‰å…¨ä¿æŠ¤æŠ€æœ¯ï¼Œé€šè¿‡å¯¹å †ã€æ ˆã€å…±äº«åº“æ˜ å°„ç­‰çº¿æ€§åŒºå¸ƒå±€çš„éšæœºåŒ–ï¼Œé€šè¿‡å¢åŠ æ”»å‡»è€…é¢„æµ‹ç›®çš„åœ°å€çš„éš¾åº¦ã€‚å¯¹äºæˆ‘ä»¬APPè€Œè¨€ï¼Œå®ƒä¿è¯æ¯æ¬¡MachOæ–‡ä»¶åŠ è½½çš„æ—¶å€™æ˜¯éšæœºåœ°å€  <strong>è¿™ä¸ªæˆ‘ä»¬å¯ä»¥é€šè¿‡LLDBæŒ‡ä»¤çš„image listå»æŸ¥çœ‹</strong></p><p>è‹¹æœé‡‡ç”¨äº†PICï¼ˆPosition-independent codeï¼‰æŠ€æœ¯æˆåŠŸè®© C çš„åº•å±‚ä¹Ÿèƒ½æœ‰åŠ¨æ€çš„è¡¨ç°ï¼š</p><ul><li>ç¼–è¯‘æ—¶åœ¨ Mach-O æ–‡ä»¶ _DATA æ®µçš„ç¬¦å·è¡¨ä¸­ä¸ºæ¯ä¸€ä¸ªè¢«å¼•ç”¨çš„ç³»ç»Ÿ C å‡½æ•°å»ºç«‹ä¸€ä¸ªæŒ‡é’ˆï¼ˆ8å­—èŠ‚çš„æ•°æ®ï¼Œæ”¾çš„å…¨æ˜¯0ï¼‰ï¼Œè¿™ä¸ªæŒ‡é’ˆç”¨äºåŠ¨æ€ç»‘å®šæ—¶é‡å®šä½åˆ°å…±äº«åº“ä¸­çš„å‡½æ•°å®ç°ã€‚</li><li>åœ¨è¿è¡Œæ—¶å½“ç³»ç»Ÿ C å‡½æ•°è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šåŠ¨æ€ç»‘å®šä¸€æ¬¡ï¼Œç„¶åå°† Mach-O ä¸­çš„ _DATA æ®µç¬¦å·è¡¨ä¸­å¯¹åº”çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å¤–éƒ¨å‡½æ•°ï¼ˆå…¶åœ¨å…±äº«åº“ä¸­çš„å®é™…å†…å­˜åœ°å€ï¼‰ã€‚</li></ul><p>fishhook æ­£æ˜¯åˆ©ç”¨äº† PIC æŠ€æœ¯åšäº†è¿™ä¹ˆä¸¤ä¸ªæ“ä½œï¼š</p><ul><li>å°†æŒ‡å‘ç³»ç»Ÿæ–¹æ³•ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰çš„æŒ‡é’ˆé‡æ–°è¿›è¡Œç»‘å®šæŒ‡å‘å†…éƒ¨å‡½æ•°/è‡ªå®šä¹‰ C å‡½æ•°ã€‚</li><li>å°†å†…éƒ¨å‡½æ•°çš„æŒ‡é’ˆåœ¨åŠ¨æ€é“¾æ¥æ—¶æŒ‡å‘ç³»ç»Ÿæ–¹æ³•çš„åœ°å€ã€‚</li></ul><p>è¿™æ ·å°±æŠŠç³»ç»Ÿæ–¹æ³•ä¸è‡ªå·±å®šä¹‰çš„æ–¹æ³•è¿›è¡Œäº†äº¤æ¢ï¼Œè¾¾åˆ° HOOK ç³»ç»Ÿ C å‡½æ•°ï¼ˆå…±äº«åº“ä¸­çš„ï¼‰çš„ç›®çš„ã€‚</p><h3 id="dyld-åŠ è½½å›è°ƒ"><a href="#dyld-åŠ è½½å›è°ƒ" class="headerlink" title="dyld åŠ è½½å›è°ƒ"></a>dyld åŠ è½½å›è°ƒ</h3><p>åœ¨ dyld åŠ è½½é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°; å¯¹äºæ¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é•œåƒï¼Œå½“å®ƒè¢«åŠ¨æ€é“¾æ¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒ </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> (*func)(<span class="keyword">const</span> struct mach_header* mh, <span class="keyword">intptr_t</span> vmaddr_slide)</span><br></pre></td></tr></table></figure><p>ä¼ å…¥æ–‡ä»¶çš„ <code>mach_header</code> ä»¥åŠä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ <code>intptr_t</code>ã€‚</p><p>dyld é€šè¿‡æ›´æ–° Mach-O äºŒè¿›åˆ¶æ–‡ä»¶ __DATA æ®µä¸­çš„ä¸€äº›æŒ‡é’ˆæ¥ç»‘å®š lazy å’Œ non-lazy çš„ç¬¦å·ï¼›</p><p>è€Œ fishhook å…ˆç¡®å®šæŸä¸€ä¸ªç¬¦å·åœ¨ __DATA æ®µä¸­çš„ä½ç½®ï¼Œ<strong>ç„¶åä¿å­˜åŸç¬¦å·å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨æ–°çš„å‡½æ•°æŒ‡é’ˆè¦†ç›–åŸæœ‰ç¬¦å·çš„å‡½æ•°æŒ‡é’ˆï¼Œå®ç°é‡ç»‘å®šã€‚</strong></p><h2 id="fishhook-æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„"><a href="#fishhook-æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„" class="headerlink" title="fishhook æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„"></a>fishhook æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„</h2><p>ç›´æ¥ä¸Šfishhook çš„ README ä¸­çš„æµç¨‹å›¾ï¼š</p><p><img src="/res/MachO/fishhook1.png" width="60%"></p><p>è¿™å¼ å›¾åˆçœ‹å¾ˆå¤æ‚ï¼Œä¸è¿‡å®ƒæ¼”ç¤ºçš„æ˜¯å¯»æ‰¾ç¬¦å·çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ ¹æ®è¿™å¼ å›¾æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>ä» __DATA æ®µä¸­çš„ lazy ç¬¦å·æŒ‡é’ˆè¡¨ä¸­æŸ¥æ‰¾æŸä¸ªç¬¦å·ï¼Œè·å¾—è¿™ä¸ªç¬¦å·çš„åç§»é‡ 1061ï¼Œç„¶ååœ¨æ¯ä¸€ä¸ª section_64 ä¸­æŸ¥æ‰¾ reserved1ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå€¼æ‰¾åˆ° Indirect Symbol Table ä¸­ç¬¦å·å¯¹åº”çš„æ¡ç›®</li><li>åœ¨ Indirect Symbol Table æ‰¾åˆ°ç¬¦å·è¡¨æŒ‡é’ˆä»¥åŠå¯¹åº”çš„ç´¢å¼• 16343 ä¹‹åï¼Œå°±éœ€è¦è®¿é—®ç¬¦å·è¡¨</li><li>ç„¶åé€šè¿‡ç¬¦å·è¡¨ä¸­çš„åç§»é‡ï¼Œè·å–å­—ç¬¦ä¸²è¡¨ä¸­çš„ç¬¦å· <code>_close</code></li></ol><p>å›¾ç¤ºä¸­ï¼Œ1061 æ˜¯é—´æ¥ç¬¦å·è¡¨çš„åç§»é‡ï¼Œ*ï¼ˆåç§»é‡+é—´æ¥ç¬¦å·åœ°å€ï¼‰=16343ï¼Œå³ç¬¦å·è¡¨åç§»é‡ã€‚ç¬¦å·è¡¨ä¸­æ¯ä¸€ä¸ªç»“æ„éƒ½æ˜¯ä¸€ä¸ª nlist ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦è¡¨åç§»é‡ã€‚é€šè¿‡å­—ç¬¦è¡¨åç§»é‡æœ€ç»ˆç¡®å®šå‡½æ•°æŒ‡é’ˆã€‚</p><p>fishhook å°±æ˜¯å¯¹é—´æ¥ç¬¦å·è¡¨çš„åç§»é‡åŠ¨çš„æ‰‹è„šï¼Œæä¾›ä¸€ä¸ªå‡çš„ nlist ç»“æ„ä½“ï¼Œä»è€Œè¾¾åˆ° hook çš„ç›®çš„ã€‚</p><p>ä¸Šé¢çš„æµç¨‹å›¾å…¶å®å·²ç»æ˜¾ç¤ºçš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œæˆ‘ä»¬é‡æ–°æ¥èµ°ä¸€éï¼Œä¸€æ­¥æ­¥æ‰¾åˆ°å…¶åœ¨ MachO æ–‡ä»¶é‡Œå¯¹åº”æŒ‡é’ˆçš„åç§»å€¼ï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š</p><p><strong>1.åœ¨ String Table ä¸­æ‰¾åˆ°è¯¥å­—ç¬¦ä¸²åœ¨ Symbols Table -&gt; Symbols ä¸­çš„ä½ç½®ï¼š</strong></p><p><img src="/res/MachO/fishhook2.png" alt></p><p>ç”¨ 0x9832 - 0x9780 = 0xB2</p><p><strong>2.åœ¨ Symbols Table -&gt; Symbols ä¸­æ‰¾åˆ°Data = 0xB2 çš„ç¬¦å·ï¼Œå…¶å¯¹åº”çš„ offset å€¼ 0x16F å°±æ˜¯è¯¥ç¬¦å·åœ¨ Dynamic Symbols Table -&gt; Indirect Symbols è¡¨ä¸­çš„ Data å€¼</strong></p><p><img src="/res/MachO/fishhook3.png" alt></p><p><strong>3.åœ¨ Dynamic Symbols Table -&gt; Indirect Symbols è¡¨ä¸­æ‰¾åˆ° Data å€¼ä¸º 0x16F çš„ç¬¦å·ï¼Œå…¶ä½äºè¯¥è¡¨ä¸­çš„ä½ç½®ï¼ˆç¬¬ä¸€ä¸ªï¼‰å°±æ˜¯å®ƒåœ¨æ‡’åŠ è½½è¡¨ä¸­å¯¹åº”çš„ä½ç½®ã€‚</strong></p><p><img src="/res/MachO/fishhook4.png" alt></p><p><strong>4.æ‡’åŠ è½½è¡¨ä¸­å¯¹åº”ä½ç½®çš„ Offset å€¼å°±æ˜¯è¯¥æŒ‡é’ˆæœ€ç»ˆçš„åç§»é‡ï¼š</strong></p><p><img src="/res/MachO/fishhook5.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;fishhookç®€ä»‹&quot;&gt;&lt;a href=&quot;#fishhookç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;fishhookç®€ä»‹&quot;&gt;&lt;/a&gt;fishhookç®€ä»‹&lt;/h2&gt;&lt;p&gt;C è¯­è¨€å¾€å¾€ä¼šç»™æˆ‘ä»¬ç•™ä¸‹ä¸å¯ä¿®æ”¹çš„è¿™ä¸€å°è±¡,è€Œ &lt;a href=&quot;https://github.com/facebook/fishhook&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;fishhook&lt;/a&gt; æ˜¯ä¸€ä¸ªç”± facebook å¼€æºçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯&lt;strong&gt;åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°å®ç°&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªæ¡†æ¶çš„ä»£ç å…¶å®éå¸¸çš„ç®€å•ï¼ŒåªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼šfishhook.c ä»¥åŠ fishhook.hï¼›ä¸¤ä¸ªæ–‡ä»¶æ‰€æœ‰çš„ä»£ç åŠ èµ·æ¥ä¹Ÿä¸è¶…è¿‡ 300 è¡Œã€‚ä¸è¿‡å®ƒçš„å®ç°åŸç†æ˜¯éå¸¸æœ‰æ„æ€å¹¶ä¸”ç²¾å¦™çš„&lt;/p&gt;
&lt;p&gt;fishhook æä¾›éå¸¸ç®€å•çš„ä¸¤ä¸ªæ¥å£ä»¥åŠä¸€ä¸ªç»“æ„ä½“ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;rebinding&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;char&lt;/span&gt; *name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *replacement;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; **replaced;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;rebind_symbols&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(struct rebinding rebindings[], &lt;span class=&quot;keyword&quot;&gt;size_t&lt;/span&gt; rebindings_nel)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;rebind_symbols_image&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; *header,&lt;span class=&quot;keyword&quot;&gt;intptr_t&lt;/span&gt; slide,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;struct rebinding rebindings[],&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;size_t&lt;/span&gt; rebindings_nel)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä» fishhook æä¾›çš„demoä¸­ä¸Šæ‰‹å®è·µä¸€ä¸‹,è¿™é‡Œçš„demoå¯¹ &lt;code&gt;close&lt;/code&gt; è¿›è¡Œä¿®æ”¹:&lt;/p&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="fishhook" scheme="https://developerdoc.com/tags/fishhook/"/>
    
  </entry>
  
  <entry>
    <title>Mach-Oæ–‡ä»¶æ ¼å¼å­—æ®µç®€ä»‹</title>
    <link href="https://developerdoc.com/essay/LLDB/Mach-O_file/"/>
    <id>https://developerdoc.com/essay/LLDB/Mach-O_file/</id>
    <published>2019-04-18T06:36:20.000Z</published>
    <updated>2020-02-07T08:45:35.455Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>æœ¬æ¬¡æ¥å­¦ä¹ ä¸‹Mach-Oæ–‡ä»¶çš„æ ¼å¼,Mach-Oï¼ˆMach Object File Formatï¼‰ æ˜¯é’ˆå¯¹ä¸åŒè¿è¡Œæ—¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ã€‚</p><p>æ–‡ä»¶ç±»å‹ï¼š</p><p>Executableï¼š åº”ç”¨çš„ä¸»è¦äºŒè¿›åˆ¶<br>Dylibï¼š åŠ¨æ€é“¾æ¥åº“ï¼ˆåˆç§° DSO æˆ– DLLï¼‰<br>Bundleï¼š ä¸èƒ½è¢«é“¾æ¥çš„ Dylibï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨ dlopen() åŠ è½½ï¼Œå¯å½“åš macOS çš„æ’ä»¶ã€‚</p><p>Mach-O æ–‡ä»¶æ ¼å¼å¦‚ä¸‹:</p><p><img src="/res/MachO/macho_struct.png" width="70%"><br><a id="more"></a></p><p><strong>å¦‚ä½•æŸ¥çœ‹æ–‡ä»¶æ ¼å¼:</strong></p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡fileæŒ‡ä»¤æŸ¥çœ‹æ–‡ä»¶çš„å…·ä½“æ ¼å¼:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file asdasd</span><br><span class="line">asdasd: Mach-O 64-bit executable x86_64</span><br></pre></td></tr></table></figure><p>ç›®å‰å·²çŸ¥çš„æ¶æ„åˆ†ä¸ºarmv7,armv7s,arm64,i386,x86_64ç­‰ç­‰ï¼ŒMachOä¸­å…¶å®ä¹Ÿæ˜¯è¿™äº›æ¶æ„çš„é›†åˆã€‚MachOå¯ä»¥æ˜¯å¤šæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç§°ä¹‹ä¸ºã€Œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€</p><p><strong>æ‹†åˆ†ã€é‡ç»„MachO</strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨lipo -info å¯ä»¥æŸ¥çœ‹MachOæ–‡ä»¶åŒ…å«çš„æ¶æ„</span></span><br><span class="line">$ lipo -info MachOæ–‡ä»¶</span><br><span class="line"><span class="comment">#  ä½¿ç”¨lipo â€“thin æ‹†åˆ†æŸç§æ¶æ„</span></span><br><span class="line">$ lipo MachOæ–‡ä»¶ â€“thin æ¶æ„ â€“output è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br><span class="line"><span class="comment">#  ä½¿ç”¨lipo -create Â åˆå¹¶å¤šç§æ¶æ„</span></span><br><span class="line">$ lipo -create MachO1 Â MachO2 Â -output è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br></pre></td></tr></table></figure><h2 id="Mach-Oæ–‡ä»¶æ ¼å¼"><a href="#Mach-Oæ–‡ä»¶æ ¼å¼" class="headerlink" title="Mach-Oæ–‡ä»¶æ ¼å¼"></a>Mach-Oæ–‡ä»¶æ ¼å¼</h2><p>æ–°å»ºä¸€ä¸ªå•é¡µé¢å·¥ç¨‹ ä½¿ç”¨ <a href="https://sourceforge.net/projects/machoview/" target="_blank" rel="noopener">MachOView</a> æ¥æŸ¥çœ‹.appåŒ…å†…çš„mach-oæ–‡ä»¶:</p><p><img src="/res/MachO/macho1.png" alt></p><p>ç»“åˆå¯çŸ¥ Mach-O æ–‡ä»¶åŒ…å«äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼š</p><ul><li>Headerï¼ˆå¤´éƒ¨ï¼‰ï¼ŒæŒ‡æ˜äº† cpu æ¶æ„ã€å¤§å°ç«¯åºã€æ–‡ä»¶ç±»å‹ã€Load Commands ä¸ªæ•°ç­‰ä¸€äº›åŸºæœ¬ä¿¡æ¯</li><li>Load Commandsï¼ˆåŠ è½½å‘½ä»¤)ï¼Œæ­£å¦‚å®˜æ–¹çš„å›¾æ‰€ç¤ºï¼Œæè¿°äº†æ€æ ·åŠ è½½æ¯ä¸ª Segment çš„ä¿¡æ¯ã€‚åœ¨ Mach-O æ–‡ä»¶ä¸­å¯ä»¥æœ‰å¤šä¸ª Segmentï¼Œæ¯ä¸ª Segment å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Sectionã€‚</li><li>Dataï¼ˆæ•°æ®åŒºï¼‰ï¼ŒSegment çš„å…·ä½“æ•°æ®ï¼ŒåŒ…å«äº†ä»£ç å’Œæ•°æ®ç­‰ã€‚</li></ul><p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ä»…ä»…æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯Macho-Oï¼Œç›®æ ‡æ–‡ä»¶(.o)ä»¥åŠåŠ¨æ€åº“ï¼Œé™æ€åº“éƒ½æ˜¯Mach-Oæ ¼å¼ã€‚</em></p><h3 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h3><p>Mach-O æ–‡ä»¶çš„å¤´éƒ¨å®šä¹‰å¦‚ä¸‹ <a href="https://opensource.apple.com/source/xnu/xnu-1456.1.26/EXTERNAL_HEADERS/mach-o/loader.h.auto.html" target="_blank" rel="noopener">loader.h</a>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line"><span class="keyword">uint32_t</span>magic;<span class="comment">/* æ ‡å¿—ç¬¦ 0xfeedface æ˜¯ 32 ä½ï¼Œ 0xfeedfacf æ˜¯ 64 ä½ã€‚*/</span></span><br><span class="line"><span class="keyword">cpu_type_t</span>cputype;<span class="comment">/* cpu ç±»å‹ã€å¹³å° */</span></span><br><span class="line"><span class="keyword">cpu_subtype_t</span>cpusubtype;<span class="comment">/* cpu ç±»å‹ã€å¹³å° */</span></span><br><span class="line"><span class="keyword">uint32_t</span>filetype;<span class="comment">/* æ–‡ä»¶ç±»å‹ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ã€ç¬¦å·æ–‡ä»¶ï¼ˆDSYMï¼‰ã€å†…æ ¸æ‰©å±•ç­‰ */</span></span><br><span class="line"><span class="keyword">uint32_t</span>ncmds;<span class="comment">/* åŠ è½½ Load Commands çš„æ•°é‡ */</span></span><br><span class="line"><span class="keyword">uint32_t</span>sizeofcmds;<span class="comment">/* åŠ è½½ Load Commands çš„å¤§å° */</span></span><br><span class="line"><span class="keyword">uint32_t</span>flags;<span class="comment">/* dyld åŠ¨æ€é“¾æ¥å™¨ åŠ è½½çš„æ ‡å¿—*/</span></span><br><span class="line"><span class="keyword">uint32_t</span>reserved;<span class="comment">/* 64 ä½çš„ä¿ç•™å­—æ®µ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šå›¾ä¸­çœ‹å‡º<code>asdasd</code>è¿™ä¸ªæ–‡ä»¶headerå¯¹åº”çš„æ˜¯ <code>MH_MAGIC_64</code> ã€<code>CPU_TYPE_X86_64_ALL</code> ã€<code>MH_EXECUTE</code>â€¦ç­‰</p><p>filetypeçš„å®šä¹‰æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_OBJECT    0x1        <span class="comment">/* Target æ–‡ä»¶ï¼šç¼–è¯‘å™¨å¯¹æºç ç¼–è¯‘åå¾—åˆ°çš„ä¸­é—´ç»“æœ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_EXECUTE    0x2        <span class="comment">/* å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_FVMLIB    0x3        <span class="comment">/* VM å…±äº«åº“æ–‡ä»¶ï¼ˆè¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_CORE        0x4        <span class="comment">/* Core æ–‡ä»¶ï¼Œä¸€èˆ¬åœ¨ App Crash äº§ç”Ÿ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_PRELOAD    0x5        <span class="comment">/* preloaded executable file */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLIB    0x6        <span class="comment">/* åŠ¨æ€åº“ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLINKER    0x7        <span class="comment">/* åŠ¨æ€è¿æ¥å™¨ /usr/lib/dyld */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_BUNDLE    0x8        <span class="comment">/* éç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¾€å¾€é€šè¿‡ gcc-bundle ç”Ÿæˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLIB_STUB    0x9        <span class="comment">/* é™æ€é“¾æ¥æ–‡ä»¶ï¼ˆè¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DSYM        0xa        <span class="comment">/* ç¬¦å·æ–‡ä»¶ä»¥åŠè°ƒè¯•ä¿¡æ¯ï¼Œåœ¨è§£æå †æ ˆç¬¦å·ä¸­å¸¸ç”¨ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_KEXT_BUNDLE    0xb        <span class="comment">/* x86_64 å†…æ ¸æ‰©å±• */</span></span></span><br></pre></td></tr></table></figure><p>å’Œéƒ¨åˆ†flagså®šä¹‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_NOUNDEFS    0x1        <span class="comment">/* Target æ–‡ä»¶ä¸­æ²¡æœ‰å¸¦æœªå®šä¹‰çš„ç¬¦å·ï¼Œå¸¸ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_SPLIT_SEGS    0x20  <span class="comment">/* Target æ–‡ä»¶ä¸­çš„åªè¯» Segment å’Œå¯è¯»å†™ Segment åˆ†å¼€  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_TWOLEVEL    0x80        <span class="comment">/* è¯¥ Image ä½¿ç”¨äºŒçº§å‘½åç©ºé—´(two name space binding)ç»‘å®šæ–¹æ¡ˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_FORCE_FLAT    0x100 <span class="comment">/* ä½¿ç”¨æ‰å¹³å‘½åç©ºé—´(flat name space binding)ç»‘å®šï¼ˆä¸ MH_TWOLEVEL äº’æ–¥ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_WEAK_DEFINES    0x8000 <span class="comment">/* äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨äº†å¼±ç¬¦å· */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_BINDS_TO_WEAK 0x10000 <span class="comment">/* äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥äº†å¼±ç¬¦å· */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_ALLOW_STACK_EXECUTION 0x20000<span class="comment">/* å…è®¸ Stack å¯æ‰§è¡Œ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_PIE 0x200000  <span class="comment">/* å¯¹å¯æ‰§è¡Œçš„æ–‡ä»¶ç±»å‹å¯ç”¨åœ°å€ç©ºé—´ layout éšæœºåŒ– */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NO_HEAP_EXECUTION 0x1000000 <span class="comment">/* å°† Heap æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œï¼Œå¯é˜²æ­¢ heap spray æ”»å‡» */</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Mach-O æ–‡ä»¶å¤´ä¸»è¦ç›®çš„æ˜¯ä¸ºåŠ è½½å‘½ä»¤æä¾›ä¿¡æ¯ã€‚åŠ è½½å‘½ä»¤è¿‡ç¨‹ç´§è·Ÿåœ¨å¤´ä¹‹åï¼Œå¹¶ä¸” ncmds å’Œ sizeofcmds æ¥èƒ½ä¸ªå­—æ®µå°†ä¼šç”¨åœ¨åŠ è½½å‘½ä»¤çš„è¿‡ç¨‹ä¸­ã€‚</p><h3 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h3><p>Headersä¹‹åå°±æ˜¯Load Commands,å…¶å ç”¨çš„å†…å­˜å’ŒåŠ è½½å‘½ä»¤æ€»æ•°å·²ç»åœ¨Headerä¸­ ncmds/sizeofcmds ä¸­æŒ‡å‡ºã€‚</p><p><img src="/res/MachO/loadcommand1.png" alt></p><p>load commandsçš„å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line"><span class="keyword">uint32_t</span> cmd;<span class="comment">/*  load command ç±»å‹*/</span></span><br><span class="line"><span class="keyword">uint32_t</span> cmdsize;<span class="comment">/* commandå¤§å° ç”¨äºè®¡ç®—å‡ºåˆ°ä¸‹ä¸€ä¸ª command çš„åç§»é‡*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>cmd å­—æ®µæŒ‡å‡ºäº† command ç±»å‹,ä¸»è¦æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line">LC_SEGMENTã€LC_SEGMENT_64 å°† segment æ˜ å°„åˆ°è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œ</span><br><span class="line">LC_UUID äºŒè¿›åˆ¶æ–‡ä»¶ idï¼Œä¸ç¬¦å·è¡¨ uuid å¯¹åº”ï¼Œå¯ç”¨ä½œç¬¦å·è¡¨åŒ¹é…ï¼Œ</span><br><span class="line">LC_LOAD_DYLINKER å¯åŠ¨åŠ¨æ€åŠ è½½å™¨ï¼Œ</span><br><span class="line">LC_SYMTAB æè¿°åœ¨ __LINKEDIT æ®µçš„å“ªæ‰¾å­—ç¬¦ä¸²è¡¨ã€ç¬¦å·è¡¨ï¼Œ</span><br><span class="line">LC_CODE_SIGNATURE ä»£ç ç­¾åç­‰</span><br></pre></td></tr></table></figure><p>LC_SEGMENT_64å’ŒLC_SEGMENTæ˜¯åŠ è½½çš„ä¸»è¦å‘½ä»¤ï¼Œå®ƒè´Ÿè´£æŒ‡å¯¼å†…æ ¸æ¥è®¾ç½®è¿›ç¨‹çš„å†…å­˜ç©ºé—´ã€‚ä¸€èˆ¬Mach-Oæ–‡ä»¶æœ‰å¤šä¸ªæ®µ(Segement)ï¼Œæ®µæ¯ä¸ªæ®µæœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œä¸€èˆ¬åŒ…æ‹¬ï¼š</p><ol><li>__PAGEZERO: ç©ºæŒ‡é’ˆé™·é˜±æ®µï¼Œæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç¬¬ä¸€é¡µï¼Œç”¨äºæ•æ‰å¯¹NULLæŒ‡é’ˆçš„å¼•ç”¨ï¼›</li><li>__TEXT: åŒ…å«äº†æ‰§è¡Œä»£ç ä»¥åŠå…¶ä»–åªè¯»æ•°æ®ã€‚è¯¥æ®µæ•°æ®çš„ä¿æŠ¤çº§åˆ«ä¸ºï¼šVM_PROT_READï¼ˆè¯»ï¼‰ã€VM_PROT_EXECUTE(æ‰§è¡Œ)ï¼Œé˜²æ­¢åœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹ï¼›</li><li>__DATA: åŒ…å«äº†ç¨‹åºæ•°æ®ï¼Œè¯¥æ®µå¯å†™ï¼›</li><li>__LINKEDIT: é“¾æ¥å™¨ä½¿ç”¨çš„ç¬¦å·ä»¥åŠå…¶ä»–è¡¨</li></ol><h3 id="Segment-amp-Section"><a href="#Segment-amp-Section" class="headerlink" title="Segment &amp; Section"></a>Segment &amp; Section</h3><p>Segmentå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> &#123;</span> </span><br><span class="line">    <span class="keyword">uint32_t</span>    cmd;        <span class="comment">/* LC_SEGMENT_64 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    cmdsize;    <span class="comment">/* section_64 ç»“æ„ä½“æ‰€éœ€è¦çš„ç©ºé—´ */</span></span><br><span class="line">    <span class="keyword">char</span>        segname[<span class="number">16</span>];    <span class="comment">/* segment åå­—ï¼Œä¸Šè¿°å®ä¸­çš„å®šä¹‰ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    vmaddr;        <span class="comment">/* æ‰€æè¿°æ®µçš„è™šæ‹Ÿå†…å­˜åœ°å€ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    vmsize;        <span class="comment">/* ä¸ºå½“å‰æ®µåˆ†é…çš„è™šæ‹Ÿå†…å­˜å¤§å° */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    fileoff;    <span class="comment">/* å½“å‰æ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    filesize;    <span class="comment">/* å½“å‰æ®µåœ¨æ–‡ä»¶ä¸­å ç”¨çš„å­—èŠ‚ */</span></span><br><span class="line">    <span class="keyword">vm_prot_t</span>    maxprot;    <span class="comment">/* æ®µæ‰€åœ¨é¡µæ‰€éœ€è¦çš„æœ€é«˜å†…å­˜ä¿æŠ¤ï¼Œç”¨å…«è¿›åˆ¶è¡¨ç¤º */</span></span><br><span class="line">    <span class="keyword">vm_prot_t</span>    initprot;    <span class="comment">/* æ®µæ‰€åœ¨é¡µåŸå§‹å†…å­˜ä¿æŠ¤ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    nsects;        <span class="comment">/* æ®µä¸­ Section æ•°é‡ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    flags;        <span class="comment">/* æ ‡è¯†ç¬¦ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ segname åœ¨æºç ä¸­å®šä¹‰çš„å®ï¼Œæœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_PAGEZERO    <span class="meta-string">"__PAGEZERO"</span> <span class="comment">/* å½“æ—¶ MH_EXECUTE æ–‡ä»¶æ—¶ï¼Œæ•è·åˆ°ç©ºæŒ‡é’ˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_TEXT    <span class="meta-string">"__TEXT"</span> <span class="comment">/* ä»£ç /åªè¯»æ•°æ®æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_DATA    <span class="meta-string">"__DATA"</span> <span class="comment">/* æ•°æ®æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_OBJC    <span class="meta-string">"__OBJC"</span> <span class="comment">/* Objective-C runtime æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_LINKEDIT    <span class="meta-string">"__LINKEDIT"</span> <span class="comment">/* åŒ…å«éœ€è¦è¢«åŠ¨æ€é“¾æ¥å™¨ä½¿ç”¨çš„ç¬¦å·å’Œå…¶ä»–è¡¨ï¼ŒåŒ…æ‹¬ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ç­‰ */</span></span></span><br></pre></td></tr></table></figure><p>éƒ¨åˆ†çš„ Segment ï¼ˆä¸»è¦æŒ‡çš„ <code>__TEXT</code> å’Œ <code>__DATA</code>ï¼‰å¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸º Sectionã€‚ä¹‹æ‰€ä»¥æŒ‰ç…§ Segment -&gt; Section çš„ç»“æ„ç»„ç»‡æ–¹å¼ï¼Œæ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ª Segment ä¸‹çš„ Sectionï¼Œå¯ä»¥æ§åˆ¶ç›¸åŒçš„æƒé™ï¼Œä¹Ÿå¯ä»¥ä¸å®Œå…¨æŒ‰ç…§ Page çš„å¤§å°è¿›è¡Œå†…å­˜å¯¹å…¶ï¼ŒèŠ‚çœå†…å­˜çš„ç©ºé—´ã€‚è€Œ Segment å¯¹å¤–æ•´ä½“æš´éœ²ï¼Œåœ¨ç¨‹åºè½½å…¥é˜¶æ®µæ˜ å°„æˆä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿå†…å­˜ï¼Œæ›´å¥½çš„åšåˆ°å†…å­˜å¯¹é½ï¼ˆå¯ä»¥ç»§ç»­å‚è€ƒ OS X &amp; iOS Kernel Programming ä¸€ä¹¦çš„ç¬¬ä¸€ç« å†…å®¹)</p><p>Sectionå®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> &#123;</span> </span><br><span class="line">    <span class="keyword">char</span>        sectname[<span class="number">16</span>];    <span class="comment">/* Section åå­— */</span></span><br><span class="line">    <span class="keyword">char</span>        segname[<span class="number">16</span>];    <span class="comment">/* Section æ‰€åœ¨çš„ Segment åç§° */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    addr;        <span class="comment">/* Section æ‰€åœ¨çš„å†…å­˜åœ°å€ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    size;        <span class="comment">/* Section çš„å¤§å° */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    offset;        <span class="comment">/* Section æ‰€åœ¨çš„æ–‡ä»¶åç§» */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    align;        <span class="comment">/* Section çš„å†…å­˜å¯¹é½è¾¹ç•Œ (2 çš„æ¬¡å¹‚) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reloff;        <span class="comment">/* é‡å®šä½ä¿¡æ¯çš„æ–‡ä»¶åç§» */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    nreloc;        <span class="comment">/* é‡å®šä½æ¡ç›®çš„æ•°ç›® */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    flags;        <span class="comment">/* æ ‡å¿—å±æ€§ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved1;    <span class="comment">/* ä¿ç•™å­—æ®µ1 (for offset or index) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved2;    <span class="comment">/* ä¿ç•™å­—æ®µ2 (for count or sizeof) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved3;    <span class="comment">/* ä¿ç•™å­—æ®µ3 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸è§çš„ Sectionã€‚</p><table><thead><tr><th style="text-align:left">Section</th><th style="text-align:center">ç”¨é€”</th></tr></thead><tbody><tr><td style="text-align:left"><code>__TEXT.__text</code></td><td style="text-align:center">ä¸»ç¨‹åºä»£ç </td></tr><tr><td style="text-align:left"><code>__TEXT.__cstring</code></td><td style="text-align:center">C è¯­è¨€å­—ç¬¦ä¸²</td></tr><tr><td style="text-align:left"><code>__TEXT.__const</code></td><td style="text-align:center">const å…³é”®å­—ä¿®é¥°çš„å¸¸é‡</td></tr><tr><td style="text-align:left"><code>__TEXT.__stubs</code></td><td style="text-align:center">ç”¨äº Stub çš„å ä½ä»£ç ï¼Œå¾ˆå¤šåœ°æ–¹ç§°ä¹‹ä¸ºæ¡©ä»£ç ã€‚</td></tr><tr><td style="text-align:left"><code>__TEXT.__stubs_helper</code></td><td style="text-align:center">å½“ Stub æ— æ³•æ‰¾åˆ°çœŸæ­£çš„ç¬¦å·åœ°å€åçš„æœ€ç»ˆæŒ‡å‘</td></tr><tr><td style="text-align:left"><code>__TEXT.__objc_methname</code></td><td style="text-align:center">Objective-C æ–¹æ³•åç§°</td></tr><tr><td style="text-align:left"><code>__TEXT.__objc_methtype</code></td><td style="text-align:center">Objective-C æ–¹æ³•ç±»å‹</td></tr><tr><td style="text-align:left"><code>__TEXT.__objc_classname</code></td><td style="text-align:center">Objective-C ç±»åç§°</td></tr><tr><td style="text-align:left"><code>__DATA.__data</code></td><td style="text-align:center">åˆå§‹åŒ–è¿‡çš„å¯å˜æ•°æ®</td></tr><tr><td style="text-align:left"><code>__DATA.__la_symbol_ptr</code></td><td style="text-align:center">lazy binding çš„æŒ‡é’ˆè¡¨ï¼Œè¡¨ä¸­çš„æŒ‡é’ˆä¸€å¼€å§‹éƒ½æŒ‡å‘ __stub_helper</td></tr><tr><td style="text-align:left"><code>__DATA.__nl_symbol_ptr</code></td><td style="text-align:center">é lazy binding çš„æŒ‡é’ˆè¡¨ï¼Œæ¯ä¸ªè¡¨é¡¹ä¸­çš„æŒ‡é’ˆéƒ½æŒ‡å‘ä¸€ä¸ªåœ¨è£…è½½è¿‡ç¨‹ä¸­ï¼Œè¢«åŠ¨æ€é“¾æœºå™¨æœç´¢å®Œæˆçš„ç¬¦å·</td></tr><tr><td style="text-align:left"><code>__DATA.__const</code></td><td style="text-align:center">æ²¡æœ‰åˆå§‹åŒ–è¿‡çš„å¸¸é‡</td></tr><tr><td style="text-align:left"><code>__DATA.__cfstring</code></td><td style="text-align:center">ç¨‹åºä¸­ä½¿ç”¨çš„ Core Foundation å­—ç¬¦ä¸²ï¼ˆCFStringRefsï¼‰</td></tr><tr><td style="text-align:left"><code>__DATA.__bss</code></td><td style="text-align:center">BSSï¼Œå­˜æ”¾ä¸ºåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå³å¸¸è¯´çš„é™æ€å†…å­˜åˆ†é…</td></tr><tr><td style="text-align:left"><code>__DATA.__common</code></td><td style="text-align:center">æ²¡æœ‰åˆå§‹åŒ–è¿‡çš„ç¬¦å·å£°æ˜</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_classlist</code></td><td style="text-align:center">Objective-C ç±»åˆ—è¡¨</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_protolist</code></td><td style="text-align:center">Objective-C åŸå‹</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_imginfo</code></td><td style="text-align:center">Objective-C é•œåƒä¿¡æ¯</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_selfrefs</code></td><td style="text-align:center">Objective-C self å¼•ç”¨</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_protorefs</code></td><td style="text-align:center">Objective-C åŸå‹å¼•ç”¨</td></tr><tr><td style="text-align:left"><code>__DATA.__objc_superrefs</code></td><td style="text-align:center">Objective-C è¶…ç±»å¼•ç”¨</td></tr></tbody></table><p><code>__TEXT.__text</code> è¿™é‡Œå­˜æ”¾çš„æ˜¯æ±‡ç¼–åçš„ä»£ç ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç¼–è¯‘æ—¶ï¼Œæ¯ä¸ª.mæ–‡ä»¶ä¼šç»è¿‡é¢„ç¼–è¯‘-&gt;ç¼–è¯‘-&gt;æ±‡ç¼–å½¢æˆ.oæ–‡ä»¶ï¼Œç§°ä¹‹ä¸ºç›®æ ‡æ–‡ä»¶ã€‚æ±‡ç¼–åï¼Œæ‰€æœ‰çš„ä»£ç ä¼šå½¢æˆæ±‡ç¼–æŒ‡ä»¤å­˜å‚¨åœ¨.oæ–‡ä»¶çš„(<strong>TEXT,</strong>text)åŒºï¼ˆï¼ˆ<strong>DATA,</strong>dataï¼‰ä¹Ÿæ˜¯ç±»ä¼¼ï¼‰ã€‚é“¾æ¥åï¼Œæ‰€æœ‰çš„.oæ–‡ä»¶ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰.oæ–‡ä»¶çš„(<strong>TEXT,</strong>text)æ•°æ®éƒ½ä¼šæŒ‰é“¾æ¥é¡ºåºå­˜æ”¾åˆ°åº”ç”¨æ–‡ä»¶çš„(<strong>TEXT,</strong>text)ä¸­ã€‚</p><p><code>__DATA.__data</code> å­˜å‚¨æ•°æ®çš„sectionï¼Œstaticåœ¨è¿›è¡Œéé›¶èµ‹å€¼åä¼šå­˜å‚¨åœ¨è¿™é‡Œï¼Œå¦‚æœstatic å˜é‡æ²¡æœ‰èµ‹å€¼æˆ–è€…èµ‹å€¼ä¸º0ï¼Œé‚£ä¹ˆå®ƒä¼šå­˜å‚¨åœ¨<code>__DATA.__bss</code>ä¸­ã€‚</p><p>å¦å¤–è¿˜æœ‰ <code>Symbol Table</code>ç¬¦å·è¡¨ï¼Œè¿™ä¸ªæ˜¯é‡ç‚¹ä¸­çš„é‡ç‚¹ï¼Œç¬¦å·è¡¨æ˜¯å°†åœ°å€å’Œç¬¦å·è”ç³»èµ·æ¥çš„æ¡¥æ¢ã€‚ç¬¦å·è¡¨å¹¶ä¸èƒ½ç›´æ¥å­˜å‚¨ç¬¦å·ï¼Œè€Œæ˜¯å­˜å‚¨ç¬¦å·ä½äºå­—ç¬¦ä¸²è¡¨çš„ä½ç½®ã€‚</p><p><code>String Table</code>å­—ç¬¦ä¸²è¡¨æ‰€æœ‰çš„å˜é‡åã€å‡½æ•°åç­‰ï¼Œéƒ½ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åœ¨å­—ç¬¦ä¸²è¡¨ä¸­ã€‚</p><h3 id="å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å"><a href="#å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å" class="headerlink" title="å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å"></a>å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å</h3><p>ä¸Šé¢è¯´äº†ä¸€å¤§å †å®šä¹‰ï¼Œæ¥æŸ¥çœ‹ä½¿ç”¨Mach-Oæ–‡ä»¶å‘¢ã€‚è¿™é‡Œæ¥çœ‹ä¸€ä¸‹å¦‚ä½•ç”¨ MachO æ–‡ä»¶å…³è”ç±»çš„æ–¹æ³•åã€‚</p><p>å…ˆæ¥çœ‹çœ‹ <code>Load Commands</code>é‡Œçš„è¡¨ç¤ºç±»åçš„ <code>__objc_classname</code> :</p><p><img src="/res/MachO/macho-find.png" alt></p><p>æ ¹æ® offsetå­—æ®µ <code>0000425F</code> å€¼å¯ä»¥æ‰¾åˆ° sectionä¸­å¯¹åº”çš„ <code>__TEXT,__objc_classname</code> ä¿¡æ¯:</p><p><img src="/res/MachO/macho-find2.png" alt></p><p>åŒç†å¯ä»¥æ‰¾åˆ°å¯¹åº”æ–¹æ³•åçš„ <code>__objc_methname</code> å’Œ è¡¨ç¤ºç±»è™šæ‹Ÿåœ°å€çš„ <code>__objc_classlist</code> :</p><p><img src="/res/MachO/macho-find3.png" alt></p><p>å…¶ä¸­æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ç±»çš„æ–¹æ³•åä¿¡æ¯å°±åœ¨<code>__objc_classlist</code>ä¸­ï¼Œæ ¹æ®ä¸Šå›¾ä¸­ <code>_OBJC_CLASS_$_ViewController</code> å¯¹åº”çš„data : <code>00000001000060E8</code>,å¯ä»¥åœ¨<code>__DATA,__objc_data</code>ä¸­æ‰¾åˆ°ç±»ç»“æ„ä¿¡æ¯ï¼š</p><p><img src="/res/MachO/macho-find4.png" alt></p><p>å…¶ä¸­data æ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„ï¼Œå®ƒæŒ‡å‘ class_ro_tï¼Œ class_ro_t å­˜å‚¨äº†ç±»åœ¨ç¼–è¯‘å™¨å°±ç¡®å®šçš„å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰ã€‚æ ¹æ®dataçš„å€¼ <code>0x100005370</code>å°±æ‰¾åˆ°äº†<code>__DATA,__objc_const</code>ä¸­ï¼š</p><p><img src="/res/MachO/macho-find5.png" alt></p><p>å…¶ä¸­baseMethods <code>0x100005350</code> æŒ‡å‘äº†ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬å°±å°±æ‰¾åˆ°äº†ç±»çš„æ–¹æ³•åã€‚</p><h2 id="ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯"><a href="#ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯" class="headerlink" title="ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯"></a>ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯</h2><p>ä¸Šæ–‡æ˜¯å€ŸåŠ© MachOView è¿™ä¸ªå·¥å…· å’Œ <code>loader.h</code> æ¥äº†è§£Mach-Oæ–‡ä»¶çš„å¤§æ¦‚å®šä¹‰ï¼Œç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨<code>size</code>å’Œ<code>otool</code> æŸ¥çœ‹ä¸€ä¸‹Mach-Oæ–‡ä»¶ã€‚</p><p>å¦‚ä¸‹è¿™æ ·ä¸€ä¸ª hello.cæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello world\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨clangç”ŸæˆMach-Oæ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”Ÿæˆ hello.out çš„ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">xcrun clang hello.c -o hello.out</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ <code>file</code> å‘½ä»¤æ¥æŸ¥çœ‹ç®€è¦çš„æ¶æ„ä¿¡æ¯:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file hello.out </span><br><span class="line"><span class="comment">#è¾“å‡ºï¼š</span></span><br><span class="line">hello.out: Mach-O 64-bit executable x86_64</span><br></pre></td></tr></table></figure><h3 id="ä¸€ã€-Section"><a href="#ä¸€ã€-Section" class="headerlink" title="ä¸€ã€ Section"></a>ä¸€ã€ Section</h3><p>å°±åƒæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸€æ ·ï¼Œè¿™é‡Œæœ‰äº›ä¸œè¥¿å«åš sectionã€‚ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åŒ…å«å¤šä¸ªæ®µï¼Œä¹Ÿå°±æ˜¯å¤šä¸ª sectionã€‚å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒçš„éƒ¨åˆ†å°†åŠ è½½è¿›ä¸åŒçš„ sectionï¼Œå¹¶ä¸”æ¯ä¸ª section ä¼šè½¬æ¢è¿›æŸä¸ª segment é‡Œã€‚è¿™ä¸ªæ¦‚å¿µå¯¹äºæ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½æ˜¯æˆç«‹çš„ã€‚</p><p>æˆ‘ä»¬æ¥çœ‹çœ‹ hello.out äºŒè¿›åˆ¶ä¸­çš„ sectionã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ size å·¥å…·æ¥è§‚å¯Ÿ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">size -x -l -m hello.out </span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">Segment __PAGEZERO: 0x100000000 (vmaddr 0x0 fileoff 0)</span><br><span class="line">Segment __TEXT: 0x1000 (vmaddr 0x100000000 fileoff 0)</span><br><span class="line">Section __text: 0x2a (addr 0x100000f60 offset 3936)</span><br><span class="line">Section __stubs: 0x6 (addr 0x100000f8a offset 3978)</span><br><span class="line">Section __stub_helper: 0x1a (addr 0x100000f90 offset 3984)</span><br><span class="line">Section __cstring: 0xd (addr 0x100000faa offset 4010)</span><br><span class="line">Section __unwind_info: 0x48 (addr 0x100000fb8 offset 4024)</span><br><span class="line">total 0x9f</span><br><span class="line">Segment __DATA: 0x1000 (vmaddr 0x100001000 fileoff 4096)</span><br><span class="line">Section __nl_symbol_ptr: 0x10 (addr 0x100001000 offset 4096)</span><br><span class="line">Section __la_symbol_ptr: 0x8 (addr 0x100001010 offset 4112)</span><br><span class="line">total 0x18</span><br><span class="line">Segment __LINKEDIT: 0x1000 (vmaddr 0x100002000 fileoff 8192)</span><br><span class="line">total 0x100003000</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„ <code>hello.out</code> æ–‡ä»¶æœ‰ 4 ä¸ª segmentã€‚æœ‰äº› segment ä¸­æœ‰å¤šä¸ª sectionã€‚</p><p>å½“è¿è¡Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œè™šæ‹Ÿå†…å­˜ (VM - virtual memory) ç³»ç»Ÿå°† segment æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸Šã€‚æ˜ å°„å®Œå…¨ä¸åŒäºæˆ‘ä»¬ä¸€èˆ¬çš„è®¤è¯†ï¼Œå¦‚æœä½ å¯¹è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥ç®€å•çš„æƒ³è±¡è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå°†æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åŠ è½½è¿›å†…å­˜ â€“ è™½ç„¶åœ¨å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚VM ä½¿ç”¨äº†ä¸€äº›æŠ€å·§æ¥é¿å…å…¨éƒ¨åŠ è½½ã€‚</p><p>å½“è™šæ‹Ÿå†…å­˜ç³»ç»Ÿè¿›è¡Œæ˜ å°„æ—¶ï¼Œsegment å’Œ section ä¼šä»¥ä¸åŒçš„å‚æ•°å’Œæƒé™è¢«æ˜ å°„ã€‚</p><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ__TEXT segment åŒ…å«äº†è¢«æ‰§è¡Œçš„ä»£ç ã€‚å®ƒè¢«ä»¥åªè¯»å’Œå¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚è¿›ç¨‹è¢«å…è®¸æ‰§è¡Œè¿™äº›ä»£ç ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹ã€‚è¿™äº›ä»£ç ä¹Ÿä¸èƒ½å¯¹è‡ªå·±åšå‡ºä¿®æ”¹ï¼Œå› æ­¤è¿™äº›è¢«æ˜ å°„çš„é¡µä»æ¥ä¸ä¼šè¢«æ”¹å˜ã€‚</p><p>__DATA segment ä»¥å¯è¯»å†™å’Œä¸å¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚å®ƒåŒ…å«äº†å°†ä¼šè¢«æ›´æ”¹çš„æ•°æ®ã€‚</p><p>ç¬¬ä¸€ä¸ª segment æ˜¯ __PAGEZEROã€‚å®ƒçš„å¤§å°ä¸º 4GBã€‚è¿™ 4GB å¹¶ä¸æ˜¯æ–‡ä»¶çš„çœŸå®å¤§å°ï¼Œä½†æ˜¯è§„å®šäº†è¿›ç¨‹åœ°å€ç©ºé—´çš„å‰ 4GB è¢«æ˜ å°„ä¸º ä¸å¯æ‰§è¡Œã€ä¸å¯å†™å’Œä¸å¯è¯»ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“è¯»å†™ä¸€ä¸ª NULL æŒ‡é’ˆæˆ–æ›´å°çš„å€¼æ—¶ä¼šå¾—åˆ°ä¸€ä¸ª EXC_BAD_ACCESS é”™è¯¯ã€‚è¿™æ˜¯æ“ä½œç³»ç»Ÿåœ¨å°è¯•é˜²æ­¢å¼•èµ·ç³»ç»Ÿå´©æºƒã€‚</p><p>åœ¨ segmentä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰å¤šä¸ª sectionã€‚å®ƒä»¬åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ã€‚åœ¨ <strong>TEXT segment ä¸­ï¼Œ</strong>text section åŒ…å«äº†ç¼–è¯‘æ‰€å¾—åˆ°çš„æœºå™¨ç ã€‚<strong>stubs å’Œ </strong>stub_helper æ˜¯ç»™åŠ¨æ€é“¾æ¥å™¨ (dyld) ä½¿ç”¨çš„ã€‚é€šè¿‡è¿™ä¸¤ä¸ª sectionï¼Œåœ¨åŠ¨æ€é“¾æ¥ä»£ç ä¸­ï¼Œå¯ä»¥å…è®¸å»¶è¿Ÿé“¾æ¥ã€‚<strong>const (åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ²¡æœ‰) æ˜¯å¸¸é‡ï¼Œä¸å¯å˜çš„ï¼Œå°±åƒ </strong>cstring (åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡ â€“ åœ¨æºç ä¸­è¢«åŒå¼•å·åŒ…å«çš„å­—ç¬¦ä¸²) å¸¸é‡ä¸€æ ·ã€‚</p><p><strong>DATA segment ä¸­åŒ…å«äº†å¯è¯»å†™æ•°æ®ã€‚åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­åªæœ‰ </strong>nl_symbol_ptr å’Œ __la_symbol_ptrï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ non-lazy å’Œ lazy ç¬¦å·æŒ‡é’ˆã€‚å»¶è¿Ÿç¬¦å·æŒ‡é’ˆç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ä¸­è°ƒç”¨æœªå®šä¹‰çš„å‡½æ•°ï¼Œä¾‹å¦‚ä¸åŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å‡½æ•°ï¼Œå®ƒä»¬å°†ä¼šå»¶è¿ŸåŠ è½½ã€‚è€Œé’ˆå¯¹éå»¶è¿Ÿç¬¦å·æŒ‡é’ˆï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½åŒæ—¶ï¼Œä¹Ÿä¼šè¢«åŠ è½½ã€‚</p><p>åœ¨ _DATA segment ä¸­çš„å…¶å®ƒå¸¸è§ section åŒ…æ‹¬ <strong>constï¼Œåœ¨è¿™é‡Œé¢ä¼šåŒ…å«ä¸€äº›éœ€è¦é‡å®šå‘çš„å¸¸é‡æ•°æ®ã€‚ä¾‹å¦‚ char * const p = â€œfooâ€; â€“ p æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ˜¯å¯å˜çš„ã€‚</strong>bss section æ²¡æœ‰è¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä¾‹å¦‚ static int a; â€“ ANSI C æ ‡å‡†è§„å®šé™æ€å˜é‡å¿…é¡»è®¾ç½®ä¸º 0ã€‚å¹¶ä¸”åœ¨è¿è¡Œæ—¶é™æ€å˜é‡çš„å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚<strong>common section åŒ…å«æœªåˆå§‹åŒ–çš„å¤–éƒ¨å…¨å±€å˜é‡ï¼Œè·Ÿ static å˜é‡ç±»ä¼¼ã€‚ä¾‹å¦‚åœ¨å‡½æ•°å¤–é¢å®šä¹‰çš„ int a;ã€‚æœ€åï¼Œ</strong>dyld æ˜¯ä¸€ä¸ª section å ä½ç¬¦ï¼Œè¢«ç”¨äºåŠ¨æ€é“¾æ¥å™¨ã€‚</p><h3 id="äºŒã€Section-ä¸­çš„å†…å®¹"><a href="#äºŒã€Section-ä¸­çš„å†…å®¹" class="headerlink" title="äºŒã€Section ä¸­çš„å†…å®¹"></a>äºŒã€Section ä¸­çš„å†…å®¹</h3><p>å¯ä»¥é€šè¿‡ <code>otool</code> æ¥äº†è§£sectionä¸­çš„å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">otool -s  __TEXT __text  hello.out </span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">hello.out:</span><br><span class="line">Contents of (__TEXT,__text) section</span><br><span class="line">0000000100000f6055 48 89 e5 48 83 ec 10 c7 45 <span class="built_in">fc</span> 00 00 00 00 48 </span><br><span class="line">0000000100000f708d 3d 34 00 00 00 b0 00 e8 0d 00 00 00 31 c9 89 </span><br><span class="line">0000000100000f8045 f8 89 c8 48 83 c4 10 5d c3</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ·»åŠ  -v æ¥æŸ¥çœ‹åæ±‡ç¼–ä»£ç  , ç”±äº -s <strong>TEXT </strong>text å¾ˆå¸¸è§ï¼Œotool å¯¹å…¶è®¾ç½®äº†ä¸€ä¸ªç¼©å†™ -t ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">otool -v -t  hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º </span></span><br><span class="line">hello.out:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line">_main:</span><br><span class="line">0000000100000f60pushq%rbp</span><br><span class="line">0000000100000f61movq%rsp, %rbp</span><br><span class="line">0000000100000f64subq<span class="variable">$0x10</span>, %rsp</span><br><span class="line">0000000100000f68movl<span class="variable">$0x0</span>, -0x4(%rbp)</span><br><span class="line">0000000100000f6fleaq0x34(%rip), %rdi</span><br><span class="line">0000000100000f76movb<span class="variable">$0x0</span>, %al</span><br><span class="line">0000000100000f78callq0x100000f8a</span><br><span class="line">0000000100000f7dxorl%ecx, %ecx</span><br><span class="line">0000000100000f7fmovl%eax, -0x8(%rbp)</span><br><span class="line">0000000100000f82movl%ecx, %eax</span><br><span class="line">0000000100000f84addq<span class="variable">$0x10</span>, %rsp</span><br><span class="line">0000000100000f88popq%rbp</span><br><span class="line">0000000100000f89retq</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä»¥åæ±‡ç¼–å½¢å¼æ˜¾ç¤ºå‡ºæ¥ã€‚ä½ åº”è¯¥æ„Ÿè§‰å¾ˆç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢ç¼–è¯‘æ—¶å€™çš„ä»£ç ã€‚å”¯ä¸€çš„ä¸åŒå°±æ˜¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½•çš„æ±‡ç¼–æŒ‡ä»¤åœ¨é‡Œé¢ã€‚è¿™æ˜¯çº¯ç²¹çš„äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ã€‚</p><!-- ## åº”ç”¨äº†è§£Mach-Oæ–‡ä»¶çš„ä¸»è¦åº”ç”¨ä¹‹ä¸€æ˜¯ä»£ç å¤§å°æ€§èƒ½ä¼˜åŒ–ã€‚### å¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº«__objc_classlist å’Œ __objc_classrefs### è·å–è°ƒç”¨å †æ ˆ -->]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ¦‚è§ˆ&quot;&gt;&lt;a href=&quot;#æ¦‚è§ˆ&quot; class=&quot;headerlink&quot; title=&quot;æ¦‚è§ˆ&quot;&gt;&lt;/a&gt;æ¦‚è§ˆ&lt;/h2&gt;&lt;p&gt;æœ¬æ¬¡æ¥å­¦ä¹ ä¸‹Mach-Oæ–‡ä»¶çš„æ ¼å¼,Mach-Oï¼ˆMach Object File Formatï¼‰ æ˜¯é’ˆå¯¹ä¸åŒè¿è¡Œæ—¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ã€‚&lt;/p&gt;
&lt;p&gt;æ–‡ä»¶ç±»å‹ï¼š&lt;/p&gt;
&lt;p&gt;Executableï¼š åº”ç”¨çš„ä¸»è¦äºŒè¿›åˆ¶&lt;br&gt;Dylibï¼š åŠ¨æ€é“¾æ¥åº“ï¼ˆåˆç§° DSO æˆ– DLLï¼‰&lt;br&gt;Bundleï¼š ä¸èƒ½è¢«é“¾æ¥çš„ Dylibï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨ dlopen() åŠ è½½ï¼Œå¯å½“åš macOS çš„æ’ä»¶ã€‚&lt;/p&gt;
&lt;p&gt;Mach-O æ–‡ä»¶æ ¼å¼å¦‚ä¸‹:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/res/MachO/macho_struct.png&quot; width=&quot;70%&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="Mach-O" scheme="https://developerdoc.com/tags/Mach-O/"/>
    
  </entry>
  
  <entry>
    <title>iOSç¼–è¯‘è¿‡ç¨‹</title>
    <link href="https://developerdoc.com/essay/LLDB/iOS_Compiler/"/>
    <id>https://developerdoc.com/essay/LLDB/iOS_Compiler/</id>
    <published>2019-04-10T02:54:52.000Z</published>
    <updated>2019-04-23T02:17:39.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¼–è¯‘å™¨"><a href="#ç¼–è¯‘å™¨" class="headerlink" title="ç¼–è¯‘å™¨"></a>ç¼–è¯‘å™¨</h2><blockquote><p>æŠŠä¸€ç§ç¼–ç¨‹è¯­è¨€(åŸå§‹è¯­è¨€)è½¬æ¢ä¸ºå¦ä¸€ç§ç¼–ç¨‹è¯­è¨€(ç›®æ ‡è¯­è¨€)çš„ç¨‹åºå«åšç¼–è¯‘å™¨</p></blockquote><p>å¤§å¤šæ•°ç¼–è¯‘å™¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå‰ç«¯å’Œåç«¯ã€‚</p><ul><li>å‰ç«¯è´Ÿè´£è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ï¼›</li><li>åç«¯ä»¥ä¸­é—´ä»£ç ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œè¡Œæ¶æ„æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ¥ç€é’ˆå¯¹ä¸åŒæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚</li></ul><p>Objective C/C/C++ä½¿ç”¨çš„ç¼–è¯‘å™¨å‰ç«¯æ˜¯clangï¼Œswiftæ˜¯swiftï¼Œåç«¯éƒ½æ˜¯LLVMã€‚</p><h3 id="llvmä»‹ç»"><a href="#llvmä»‹ç»" class="headerlink" title="llvmä»‹ç»"></a>llvmä»‹ç»</h3><p>LLVMæ˜¯ä»€ä¹ˆï¼Œæ˜¯low level virtual machineçš„ç®€ç§°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ¡†æ¶ã€‚LLVM çš„ä¼˜ç‚¹ä¸»è¦å¾—ç›Šäºå®ƒçš„ä¸‰å±‚å¼æ¶æ„ â€“ ç¬¬ä¸€å±‚æ”¯æŒå¤šç§è¯­è¨€ä½œä¸ºè¾“å…¥(ä¾‹å¦‚ C, ObjectiveC, C++ å’Œ Haskell)ï¼Œç¬¬äºŒå±‚æ˜¯ä¸€ä¸ªå…±äº«å¼çš„ä¼˜åŒ–å™¨(å¯¹ LLVM IR åšä¼˜åŒ–å¤„ç†)ï¼Œç¬¬ä¸‰å±‚æ˜¯è®¸å¤šä¸åŒçš„ç›®æ ‡å¹³å°(ä¾‹å¦‚ Intel, ARM å’Œ PowerPC)ã€‚ç¼–è¯‘å™¨å‰ç«¯ä¸»è¦è¿›è¡Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ã€‚ç¼–è¯‘å™¨åç«¯ä¼šè¿›è¡Œæœºå™¨æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ ¹æ®ä¸åŒçš„ç³»ç»Ÿæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚</p><p><img src="/res/LLVM/LLVMCompiler1.png" alt></p><p>ç°åœ¨ï¼ŒXcode çš„é»˜è®¤ç¼–è¯‘å™¨æ˜¯ clangã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬æåˆ°çš„ç¼–è¯‘å™¨éƒ½è¡¨ç¤º clangã€‚clang çš„åŠŸèƒ½æ˜¯é¦–å…ˆå¯¹ Objective-C ä»£ç åšåˆ†ææ£€æŸ¥ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºä½çº§çš„ç±»æ±‡ç¼–ä»£ç ï¼šLLVM Intermediate Representation(LLVM ä¸­é—´è¡¨è¾¾ç )ã€‚æ¥ç€ LLVM ä¼šæ‰§è¡Œç›¸å…³æŒ‡ä»¤å°† LLVM IR ç¼–è¯‘æˆç›®æ ‡å¹³å°ä¸Šçš„æœ¬åœ°å­—èŠ‚ç ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å®Œæˆæ–¹å¼å¯ä»¥æ˜¯å³æ—¶ç¼–è¯‘ (Just-in-time)ï¼Œæˆ–åœ¨ç¼–è¯‘çš„æ—¶å€™å®Œæˆã€‚è€ŒClang æ˜¯ä¸€ä¸ªCã€C++ã€Objective-Cå’ŒObjective-C++ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚å®ƒé‡‡ç”¨äº†åº•å±‚è™šæ‹Ÿæœºï¼ˆLLVMï¼‰ä½œä¸ºå…¶åç«¯ã€‚å®ƒçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªGNUç¼–è¯‘å™¨å¥—è£…ï¼ˆGCCï¼‰çš„æ›¿ä»£å“ã€‚Clangé¡¹ç›®åŒ…æ‹¬Clangå‰ç«¯å’ŒClangé™æ€åˆ†æå™¨ç­‰ã€‚</p><p>ä¸‹å›¾æ˜¯iOSç¼–è¯‘è¿‡ç¨‹ï¼š<br><img src="/res/LLVM/iOSCompiler.png" alt></p><a id="more"></a><h2 id="ä½¿ç”¨llvmå‘½ä»¤"><a href="#ä½¿ç”¨llvmå‘½ä»¤" class="headerlink" title="ä½¿ç”¨llvmå‘½ä»¤"></a>ä½¿ç”¨llvmå‘½ä»¤</h2><p><strong><em>ä¸€ã€ä½¿ç”¨xcodeè‡ªå¸¦</em></strong></p><p>ä½¿ç”¨xcrunæ¥è°ƒç”¨ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xcrun clang -v</span><br><span class="line"><span class="comment">#Apple LLVM version 10.0.0 (clang-1000.11.45.5)</span></span><br><span class="line"><span class="comment">#Target: x86_64-apple-darwin17.7.0</span></span><br><span class="line"><span class="comment">#Thread model: posix</span></span><br><span class="line"><span class="comment">#InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</span></span><br></pre></td></tr></table></figure><p><strong><em>äºŒã€ä½¿ç”¨HomeBrewå®‰è£…</em></strong></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…llvm</span></span><br><span class="line">brew install --with-toolchain llvm</span><br><span class="line"><span class="comment"># è‹¥å®‰è£…é‡åˆ°é—®é¢˜ å¯ä»¥å…ˆå‡çº§brewè¯•è¯•</span></span><br><span class="line"><span class="comment">#   brew update è¿™ä¼šæ›´æ–° Homebrew è‡ªå·±</span></span><br><span class="line"><span class="comment">#   brew upgrade å‡çº§æ‰€æœ‰å¯ä»¥å‡çº§çš„è½¯ä»¶ä»¬</span></span><br></pre></td></tr></table></figure><p>å®‰è£…åå¯ä»¥ä½¿ç”¨ <code>brew info llvm</code> æ£€æŸ¥ä¿¡æ¯ã€‚brewå®‰è£…llvmåï¼Œä¸ä¼šç›´æ¥æ·»åŠ å‘½ä»¤çš„å¿«æ·å¼•ç”¨ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨æ¥å®Œæˆã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹llvmçš„å®‰è£…è·¯å¾„</span></span><br><span class="line">brew --prefix llvm</span><br><span class="line"><span class="comment"># æ·»åŠ å¼•ç”¨ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/llvm/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure><!-- https://embeddedartistry.com/blog/2017/2/20/installing-clangllvm-on-osx --><p>è¿™æ ·ä¹‹åå°±å¯ä»¥ç›´æ¥è°ƒç”¨è‡ªå·±å®‰è£…çš„llvmäº†ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">clang -v</span><br><span class="line"><span class="comment">#clang version 8.0.0 (tags/RELEASE_800/final)</span></span><br><span class="line"><span class="comment">#Target: x86_64-apple-darwin17.7.0</span></span><br><span class="line"><span class="comment">#Thread model: posix</span></span><br><span class="line"><span class="comment">#InstalledDir: /usr/local/opt/llvm/bin</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹"><a href="#ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹"></a>ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹</h2><p>åœ¨ç¼–è¯‘ä¸€ä¸ªæºæ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨çš„å¤„ç†è¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µã€‚è¦æƒ³æŸ¥çœ‹ç¼–è¯‘ hello.m æºæ–‡ä»¶éœ€è¦å‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œä¸Šæ–‡ä¸­å®‰è£…llvmåï¼Œæˆ‘ä»¬å¯ä»¥è®©é€šè¿‡ clang å‘½ä»¤è§‚å¯Ÿï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sunTongShengdeMacBook-Pro:asdasd suntongsheng$ clang -ccc-print-phases ViewController.m</span><br><span class="line">0: input, &quot;ViewController.m&quot;, objective-c</span><br><span class="line">1: preprocessor, &#123;0&#125;, objective-c-cpp-output</span><br><span class="line">2: compiler, &#123;1&#125;, ir</span><br><span class="line">3: backend, &#123;2&#125;, assembler</span><br><span class="line">4: assembler, &#123;3&#125;, object</span><br><span class="line">5: linker, &#123;4&#125;, image</span><br><span class="line">6: bind-arch, &quot;x86_64&quot;, &#123;5&#125;, image</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°clangå°†å…¶åˆ†ä¸º inputã€preprocessor ã€compilerã€backendã€assemblerã€linkerã€bind-archå‡ ä¸ªé˜¶æ®µã€‚</p><ul><li>é¢„å¤„ç†é˜¶æ®µï¼šç¬¦å·åŒ–ã€å®å®šä¹‰å±•å¼€å¤´æ–‡ä»¶å±•å¼€</li><li>è¯­æ³•å’Œè¯­ä¹‰åˆ†æé˜¶æ®µï¼šå°†ç¬¦å·åŒ–åçš„å†…å®¹è½¬åŒ–ä¸ºä¸€æ£µè§£ææ ‘ã€è§£ææ ‘åšè¯­ä¹‰åˆ†æ è¾“å‡ºä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘</li><li>ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µï¼šå°† AST è½¬æ¢ä¸ºæ›´ä½çº§çš„ä¸­é—´ç  (LLVM IR)ã€å¯¹ç”Ÿæˆçš„ä¸­é—´ç åšä¼˜åŒ–ã€ç”Ÿæˆç‰¹å®šç›®æ ‡ä»£ç ã€è¾“å‡ºæ±‡ç¼–ä»£ç </li><li>æ±‡ç¼–å™¨é˜¶æ®µï¼šå°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºç›®æ ‡å¯¹è±¡æ–‡ä»¶ã€‚</li><li>é“¾æ¥å™¨ï¼šå°†å¤šä¸ªç›®æ ‡å¯¹è±¡æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ (æˆ–è€…ä¸€ä¸ªåŠ¨æ€åº“)</li></ul><h3 id="preprocessor-é¢„å¤„ç†"><a href="#preprocessor-é¢„å¤„ç†" class="headerlink" title="preprocessor é¢„å¤„ç†"></a>preprocessor é¢„å¤„ç†</h3><p>æ¯å½“ç¼–æºè¯‘æ–‡ä»¶çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨é¦–å…ˆåšçš„æ˜¯ä¸€äº›é¢„å¤„ç†å·¥ä½œã€‚å…·ä½“è¡¨ç°ä¸ºimportå¤´æ–‡ä»¶æ›¿æ¢ã€macroå®å±•å¼€ã€å…¶ä»–é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œ`#è¿™ä¸ªç¬¦å·æ˜¯ç¼–è¯‘å™¨é¢„å¤„ç†çš„æ ‡å¿—ã€‚</p><p><strong><em>ä¸€. å¯¹å¤´æ–‡ä»¶çš„å¤„ç†ï¼š</em></strong></p><p>ä¾‹å¦‚ï¼Œå¦‚æœåœ¨æºæ–‡ä»¶ä¸­å‡ºç°ä¸‹è¿°ä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br></pre></td></tr></table></figure><p>é¢„å¤„ç†å™¨å¯¹è¿™è¡Œä»£ç çš„å¤„ç†æ˜¯ç”¨ Foundation.h æ–‡ä»¶ä¸­çš„å†…å®¹å»æ›¿æ¢è¿™è¡Œä»£ç ï¼Œå¦‚æœ Foundation.h ä¸­ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„å®å¼•å…¥ï¼Œåˆ™ä¼šæŒ‰ç…§åŒæ ·çš„å¤„ç†æ–¹å¼ç”¨å„ä¸ªå®å¯¹åº”çš„çœŸæ­£ä»£ç è¿›è¡Œé€çº§æ›¿ä»£ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆäººä»¬ä¸»å¼ å¤´æ–‡ä»¶æœ€å¥½å°½é‡å°‘çš„å»å¼•å…¥å…¶ä»–çš„ç±»æˆ–åº“ï¼Œå› ä¸ºå¼•å…¥çš„ä¸œè¥¿è¶Šå¤šï¼Œç¼–è¯‘å™¨éœ€è¦åšçš„å¤„ç†å°±è¶Šå¤š</p><p><strong>ç¤ºä¾‹</strong>ï¼šå‡è®¾æˆ‘ä»¬å†™äº†ä¸€ä¸ªç®€å•çš„ C ç¨‹åº hello.c:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello llvm\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åç»™ä¸Šé¢çš„ä»£ç æ‰§è¡Œä»¥ä¸‹é¢„å¤„ç†å‘½ä»¤</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  -E  Only run the preprocessor</span></span><br><span class="line">clang -E hello.c &gt;&gt; hello.o</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ hello.o ï¼Œå‘ç°æœ‰542è¡Œã€‚ä½†æ˜¯å¦‚æœåœ¨ä¸Šè¿°ä»£ç ä¸ŠåŠ ä¸Š <code>#import &lt;Foundation/Foundation.h&gt;</code> ï¼Œhello.o çš„è¡Œæ•°æš´å¢åˆ°9ä¸‡å¤šè¡Œã€‚ï¼ˆå½“ç„¶å¯¹äºè¿™ç§æƒ…å†µå¼•å…¥äº†<a href="http://clang.llvm.org/docs/Modules.html" target="_blank" rel="noopener">æ¨¡å— - modules</a>åŠŸèƒ½ï¼‰</p><p>æ‰“å¼€æ¨¡å—åŠŸèƒ½å†è¯•è¯•ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-fmodules å…è®¸modulesçš„è¯­è¨€ç‰¹æ€§</span></span><br><span class="line">clang  -fmodules -E  hello.c &gt;&gt; hello.1o</span><br><span class="line"></span><br><span class="line"><span class="comment">#hello.1oçš„å†…å®¹ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 "hello.c"</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 1</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 3</span></span><br><span class="line"><span class="comment"># 361 "&lt;built-in&gt;" 3</span></span><br><span class="line"><span class="comment"># 1 "&lt;command line&gt;" 1</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 2</span></span><br><span class="line"><span class="comment"># 1 "hello.c" 2</span></span><br><span class="line"><span class="comment">#pragma clang module import Darwin.C.stdio /* clang -E: implicit import for #include &lt;stdio.h&gt; */</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello llvm\n"</span>);</span><br><span class="line">  <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><em>äºŒã€å¯¹äºå®çš„å¤„ç†</em></strong></p><p>å‡è®¾ä¸€æ®µè¿™æ ·çš„ä»£ç :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(a,b) a &gt; b ? a : b</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">200</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"largest: %d\n"</span>, MAX(i++,<span class="number">100</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"i: %d\n"</span>, i);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ <code>clang -E hello.c</code> è¿›è¡Œå®å±•å¼€çš„é¢„å¤„ç†ç»“æœæ˜¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">200</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"largest: %d\n"</span>, i++ &gt; <span class="number">100</span> ? i++ : <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"i: %d\n"</span>, i);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>i++</code>è¢«æ›¿æ¢åˆ°äº†<code>a</code>ä¸­ï¼Œè€Œä¸æ˜¯é¢„æƒ³çš„ i++çš„å€¼ã€‚</p><h3 id="compiler-è¯æ³•åˆ†æè§£ææ ‡è®°"><a href="#compiler-è¯æ³•åˆ†æè§£ææ ‡è®°" class="headerlink" title="compiler è¯æ³•åˆ†æè§£ææ ‡è®°"></a>compiler è¯æ³•åˆ†æè§£ææ ‡è®°</h3><h4 id="ä¸€ã€è¯æ³•åˆ†æ-Lexical-Analysis"><a href="#ä¸€ã€è¯æ³•åˆ†æ-Lexical-Analysis" class="headerlink" title="ä¸€ã€è¯æ³•åˆ†æ-Lexical Analysis"></a>ä¸€ã€è¯æ³•åˆ†æ-Lexical Analysis</h4><p>åœ¨compileré˜¶æ®µï¼Œé¦–å…ˆä»£ç æ–‡æœ¬éƒ½ä¼šä» string è½¬åŒ–æˆç‰¹æ®Šçš„æ ‡è®°æµã€‚å°†ä»£ç åˆ‡æˆä¸€ä¸ªä¸ª tokenï¼Œæ¯”å¦‚å¤§å°æ‹¬å·ï¼Œç­‰äºå·è¿˜æœ‰å­—ç¬¦ä¸²ç­‰ã€‚æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­å°†å­—ç¬¦åºåˆ—è½¬æ¢ä¸ºæ ‡è®°åºåˆ—çš„è¿‡ç¨‹ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢è¿™æ®µç¨‹åºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="keyword">int</span> main() &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"hello, %@"</span>, <span class="string">@"world"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ clang å‘½ä»¤ clang -Xclang -dump-tokens hello.m æ¥å°†ä¸Šé¢ä»£ç çš„æ ‡è®°æµå¯¼å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#clang -Xclang -dump-tokens hello.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ§åˆ¶å°è¾“å‡ºï¼š</span></span><br><span class="line">int <span class="string">'int'</span> [StartOfLine]Loc=&lt;hello.c:1:1&gt;</span><br><span class="line">identifier <span class="string">'main'</span> [LeadingSpace]Loc=&lt;hello.c:1:5&gt;</span><br><span class="line">l_paren <span class="string">'('</span>Loc=&lt;hello.c:1:9&gt;</span><br><span class="line">r_paren <span class="string">')'</span>Loc=&lt;hello.c:1:10&gt;</span><br><span class="line">l_brace <span class="string">'&#123;'</span> [LeadingSpace]Loc=&lt;hello.c:1:12&gt;</span><br><span class="line">identifier <span class="string">'NSLog'</span> [StartOfLine] [LeadingSpace]Loc=&lt;hello.c:2:3&gt;</span><br><span class="line">l_paren <span class="string">'('</span>Loc=&lt;hello.c:2:8&gt;</span><br><span class="line">unknown <span class="string">'@'</span>Loc=&lt;hello.c:2:9&gt;</span><br><span class="line">string_literal <span class="string">'"hello, %@"'</span>Loc=&lt;hello.c:2:10&gt;</span><br><span class="line">comma <span class="string">','</span>Loc=&lt;hello.c:2:21&gt;</span><br><span class="line">unknown <span class="string">'@'</span> [LeadingSpace]Loc=&lt;hello.c:2:23&gt;</span><br><span class="line">string_literal <span class="string">'"world"'</span>Loc=&lt;hello.c:2:24&gt;</span><br><span class="line">r_paren <span class="string">')'</span>Loc=&lt;hello.c:2:31&gt;</span><br><span class="line">semi <span class="string">';'</span>Loc=&lt;hello.c:2:32&gt;</span><br><span class="line"><span class="built_in">return</span> <span class="string">'return'</span> [StartOfLine] [LeadingSpace]Loc=&lt;hello.c:3:3&gt;</span><br><span class="line">numeric_constant <span class="string">'0'</span> [LeadingSpace]Loc=&lt;hello.c:3:10&gt;</span><br><span class="line">semi <span class="string">';'</span>Loc=&lt;hello.c:3:11&gt;</span><br><span class="line">r_brace <span class="string">'&#125;'</span> [StartOfLine]Loc=&lt;hello.c:4:1&gt;</span><br><span class="line">eof <span class="string">''</span>Loc=&lt;hello.c:4:2&gt;</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ªæ ‡è®°éƒ½åŒ…å«äº†å¯¹åº”çš„æºç å†…å®¹å’Œå…¶åœ¨æºç ä¸­çš„ä½ç½®,å¦‚æœç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œclang èƒ½å¤Ÿåœ¨æºç ä¸­æŒ‡å‡ºå‡ºé”™çš„å…·ä½“ä½ç½®ã€‚</p><h4 id="äºŒã€è¯­æ³•åˆ†æ-Semantic-Analysis"><a href="#äºŒã€è¯­æ³•åˆ†æ-Semantic-Analysis" class="headerlink" title="äºŒã€è¯­æ³•åˆ†æ - Semantic Analysis"></a>äºŒã€è¯­æ³•åˆ†æ - Semantic Analysis</h4><p>ä¹‹åä¸Šé¢çš„æ ‡è®°æµä¼šè§£æç”Ÿæˆ<a href="http://clang.llvm.org/docs/IntroductionToTheClangAST.html" target="_blank" rel="noopener">æŠ½è±¡è¯­æ³•æ ‘</a>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>clang -Xclang -ast-dump -fsyntax-only hello.c</code> æ¥å±•ç°è§£æè¿™ä¸ªè¿‡ç¨‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clang -Xclang -ast-dump -fsyntax-only hello.c </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ§åˆ¶å°è¾“å‡ºï¼š</span></span><br><span class="line">hello.c:2:3: warning: implicit declaration of <span class="keyword">function</span> <span class="string">'NSLog'</span> is invalid <span class="keyword">in</span> C99 [-Wimplicit-function-declaration]</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">  ^</span><br><span class="line">hello.c:2:9: error: expected expression</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">        ^</span><br><span class="line">hello.c:2:23: error: expected expression</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">                      ^</span><br><span class="line">TranslationUnitDecl 0x7fe1d2816c08 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt;</span><br><span class="line">|-TypedefDecl 0x7fe1d28174a0 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __int128_t <span class="string">'__int128'</span></span><br><span class="line">| `-BuiltinType 0x7fe1d28171a0 <span class="string">'__int128'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817508 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __uint128_t <span class="string">'unsigned __int128'</span></span><br><span class="line">| `-BuiltinType 0x7fe1d28171c0 <span class="string">'unsigned __int128'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d28177b8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __NSConstantString <span class="string">'struct __NSConstantString_tag'</span></span><br><span class="line">| `-RecordType 0x7fe1d28175d0 <span class="string">'struct __NSConstantString_tag'</span></span><br><span class="line">|   `-Record 0x7fe1d2817558 <span class="string">'__NSConstantString_tag'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817850 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_ms_va_list <span class="string">'char *'</span></span><br><span class="line">| `-PointerType 0x7fe1d2817810 <span class="string">'char *'</span></span><br><span class="line">|   `-BuiltinType 0x7fe1d2816ca0 <span class="string">'char'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817af8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_va_list <span class="string">'struct __va_list_tag [1]'</span></span><br><span class="line">| `-ConstantArrayType 0x7fe1d2817aa0 <span class="string">'struct __va_list_tag [1]'</span> 1 </span><br><span class="line">|   `-RecordType 0x7fe1d2817920 <span class="string">'struct __va_list_tag'</span></span><br><span class="line">|     `-Record 0x7fe1d28178a0 <span class="string">'__va_list_tag'</span></span><br><span class="line">`-FunctionDecl 0x7fe1d285d000 &lt;hello.c:1:1, line:4:1&gt; line:1:5 main <span class="string">'int ()'</span></span><br><span class="line">  `-CompoundStmt 0x7fe1d285d1f8 &lt;col:12, line:4:1&gt;</span><br><span class="line">    `-ReturnStmt 0x7fe1d285d1e8 &lt;line:3:3, col:10&gt;</span><br><span class="line">      `-IntegerLiteral 0x7fe1d285d1c8 &lt;col:10&gt; <span class="string">'int'</span> 0</span><br></pre></td></tr></table></figure><p>åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ ‡æ³¨äº†å…¶å¯¹åº”æºç ä¸­çš„ä½ç½®ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœäº§ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ï¼Œclang å¯ä»¥å®šä½åˆ°é—®é¢˜æ‰€åœ¨å¤„çš„æºç ä½ç½®ã€‚</p><h4 id="ä¸‰ã€é™æ€åˆ†æ-Static-Analyzer"><a href="#ä¸‰ã€é™æ€åˆ†æ-Static-Analyzer" class="headerlink" title="ä¸‰ã€é™æ€åˆ†æ - Static Analyzer"></a>ä¸‰ã€é™æ€åˆ†æ - Static Analyzer</h4><p>ä¸€æ—¦ç¼–è¯‘å™¨æŠŠæºç ç”Ÿæˆäº†æŠ½è±¡è¯­æ³•æ ‘ï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹è¿™æ£µæ ‘åšåˆ†æå¤„ç†ï¼Œä»¥æ‰¾å‡ºä»£ç ä¸­çš„é”™è¯¯ï¼Œæ¯”å¦‚ç±»å‹æ£€æŸ¥ï¼šå³æ£€æŸ¥ç¨‹åºä¸­æ˜¯å¦æœ‰ç±»å‹é”™è¯¯ã€‚ä¾‹å¦‚ï¼šå¦‚æœä»£ç ä¸­ç»™æŸä¸ªå¯¹è±¡å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥è¿™ä¸ªå¯¹è±¡æ˜¯å¦å®ç°äº†è¿™ä¸ªæ¶ˆæ¯ï¼ˆå‡½æ•°ã€æ–¹æ³•ï¼‰ã€‚æ­¤å¤–ï¼Œclang å¯¹æ•´ä¸ªç¨‹åºè¿˜åšäº†å…¶å®ƒæ›´é«˜çº§çš„ä¸€äº›åˆ†æï¼Œä»¥ç¡®ä¿ç¨‹åºæ²¡æœ‰é”™è¯¯ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å‘½ä»¤è¡Œæ‰§è¡Œ é€šè¿‡clang -cc1 -analyzer-checker-helpå¯ä»¥åˆ—å‡ºèƒ½è°ƒç”¨çš„ checkerï¼Œä½†è¿™äº›checkerå¹¶ä¸æ˜¯æ‰€æœ‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„</span></span><br><span class="line">clang -cc1 -analyzer-checker-help</span><br><span class="line">OVERVIEW: Clang Static Analyzer Checkers List</span><br><span class="line"></span><br><span class="line">USAGE: -analyzer-checker &lt;CHECKER or PACKAGE,...&gt;</span><br><span class="line"></span><br><span class="line">CHECKERS:</span><br><span class="line">  alpha.clone.CloneChecker        Reports similar pieces of code.</span><br><span class="line">  alpha.core.BoolAssignment       Warn about assigning non-&#123;0,1&#125; values to Boolean variables</span><br><span class="line">  alpha.core.CallAndMessageUnInitRefArg</span><br><span class="line">                                  Check <span class="keyword">for</span> logical errors <span class="keyword">for</span> <span class="keyword">function</span> calls and Objective-C message expressions (e.g., uninitialized arguments, null <span class="keyword">function</span> pointers, and pointer to undefined variables)</span><br><span class="line">  alpha.core.CastSize             Check when castin</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<a href="http://clang-analyzer.llvm.org.cn/scan-build.html" target="_blank" rel="noopener">scan-build</a>å¯ä»¥ä»å‘½ä»¤è¡Œè¿è¡Œåˆ†æå™¨,ç±»ä¼¼å¦‚ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">scan-build xcodebuild -project asdasd.xcodeproj</span><br><span class="line">scan-build: Using <span class="string">'/usr/local/Cellar/llvm/8.0.0/bin/clang-8'</span> <span class="keyword">for</span> static analysis</span><br><span class="line">Build settings from <span class="built_in">command</span> line:</span><br><span class="line">    CLANG_ANALYZER_EXEC = /usr/<span class="built_in">local</span>/Cellar/llvm/8.0.0/bin/clang-8</span><br><span class="line">    CLANG_ANALYZER_OTHER_FLAGS = </span><br><span class="line">    CLANG_ANALYZER_OUTPUT = plist-html</span><br><span class="line">    CLANG_ANALYZER_OUTPUT_DIR = /var/folders/s6/5jq8fd4x12v9blzt68qbv18m0000gn/T/scan-build-2019-04-18-141047-45509-1</span><br><span class="line">    RUN_CLANG_STATIC_ANALYZER = YES</span><br><span class="line"></span><br><span class="line">note: Using new build system</span><br><span class="line">note: Planning build</span><br><span class="line">note: Constructing build description</span><br><span class="line">Build system information</span><br><span class="line">error: Signing <span class="keyword">for</span> <span class="string">"asdasd"</span> requires a development team. Select a development team <span class="keyword">in</span> the project editor. (<span class="keyword">in</span> target <span class="string">'asdasd'</span>)</span><br><span class="line"></span><br><span class="line">** BUILD FAILED **</span><br><span class="line"></span><br><span class="line">scan-build: Removing directory <span class="string">'/var/folders/s6/5jq8fd4x12v9blzt68qbv18m0000gn/T/scan-build-2019-04-18-141047-45509-1'</span> because it contains no reports.</span><br><span class="line">scan-build: No bugs found.</span><br></pre></td></tr></table></figure><p>å…³äºé™æ€åˆ†ææ›´å¤šå¯ä»¥æŸ¥çœ‹ ï¼š<a href="http://clang-analyzer.llvm.org.cn/" target="_blank" rel="noopener">Clang é™æ€åˆ†æå™¨</a></p><!-- https://juejin.im/post/5a30ea0ff265da43094526f9 --><h3 id="ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ"><a href="#ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ" class="headerlink" title="ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ"></a>ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ</h3><p><strong><em>ä¸€ã€ç”Ÿæˆ LLVM ä»£ç </em></strong></p><p>clang å®Œæˆä»£ç çš„æ ‡è®°ï¼Œè§£æå’Œåˆ†æåï¼Œæ¥ç€å°±ä¼šç”Ÿæˆ LLVM ä»£ç ã€‚ä¸‹é¢ç»§ç»­çœ‹çœ‹hello.cï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello world\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æŠŠè¿™æ®µä»£ç ç¼–è¯‘æˆ LLVM å­—èŠ‚ç ï¼ˆç»å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯äºŒè¿›åˆ¶ç æ ¼å¼ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><p><code>clang  -emit-llvm hello.c -c -o hello.bc</code></p><p>æ¥ç€ç”¨å¦ä¸€ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹åˆšåˆšç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p><p><code>llvm-dis &lt; hello.bc | less</code></p><p>éƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = '&lt;stdin&gt;'</span><br><span class="line">source_filename = <span class="string">"hello.c"</span></span><br><span class="line">target datalayout = <span class="string">"e-m:o-i64:64-f80:128-n8:16:32:64-S128"</span></span><br><span class="line">target triple = <span class="string">"x86_64-apple-macosx10.13.0"</span></span><br><span class="line"></span><br><span class="line">@.str = <span class="keyword">private</span> unnamed_addr constant [<span class="number">13</span> x i8] c<span class="string">"hello world\0A\00"</span>, align <span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone ssp uwtable</span><br><span class="line">define i32 @main() #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* %<span class="number">1</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">2</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">13</span> x i8], [<span class="number">13</span> x i8]* @.str, i32 <span class="number">0</span>, i32 <span class="number">0</span>))</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare i32 @<span class="built_in">printf</span>(i8*, ...) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><strong><em>äºŒã€ä¼˜åŒ– LLVM ä»£ç </em></strong></p><p>LLVM ä¼šå»åšäº›ä¼˜åŒ–å·¥ä½œï¼Œåœ¨ Xcode çš„ç¼–è¯‘è®¾ç½®é‡Œä¹Ÿå¯ä»¥è®¾ç½®ä¼˜åŒ–çº§åˆ«-01ï¼Œ-03ï¼Œ-0sï¼Œè¿˜å¯ä»¥å†™äº›è‡ªå·±çš„ Passï¼ŒPasså°±æ˜¯LLVMç³»ç»Ÿè½¬åŒ–å’Œä¼˜åŒ–çš„å·¥ä½œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åšä¸€äº›å·¥ä½œï¼Œè¿™äº›å·¥ä½œåŠ èµ·æ¥å°±æ„æˆäº†LLVMæ•´ä¸ªç³»ç»Ÿçš„ä¼˜åŒ–å’Œè½¬åŒ–ã€‚å®˜æ–¹æœ‰æ¯”è¾ƒå®Œæ•´çš„ Pass æ•™ç¨‹ï¼š <a href="https://releases.llvm.org/5.0.2/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener">Writing an LLVM Pass â€” LLVM 5 documentation</a> ã€‚å¦‚æœå¼€å¯äº† bitcode è‹¹æœä¼šåšè¿›ä¸€æ­¥çš„ä¼˜åŒ–</p><p><img src="/res/LLVM/xcode-optimize.png" alt></p><p><strong><em>ä¸‰ã€è¾“å‡ºæ±‡ç¼–ä»£ç </em></strong></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è®©clangè¾“å‡ºæ±‡ç¼–ä»£ç ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¾“å…¥</span></span><br><span class="line"> clang -S -o - hello.c</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">.section__TEXT,__text,regular,pure_instructions <span class="comment"># .section æŒ‡ä»¤æŒ‡å®šæ¥ä¸‹æ¥ä¼šæ‰§è¡Œå“ªä¸€ä¸ªæ®µ</span></span><br><span class="line">.macosx_version_min 10, 13</span><br><span class="line">.globl_main           <span class="comment"># .globl æŒ‡ä»¤è¯´æ˜ _main æ˜¯ä¸€ä¸ªå¤–éƒ¨ç¬¦å·</span></span><br><span class="line">.p2align4, 0x90     <span class="comment"># .align æŒ‡ä»¤æŒ‡å‡ºäº†åé¢ä»£ç çš„å¯¹é½æ–¹å¼ å¦‚æœéœ€è¦çš„è¯ï¼Œç”¨ 0x90 è¡¥é½</span></span><br><span class="line">_main:                                  <span class="comment">## æ¥ä¸‹æ¥æ˜¯ main å‡½æ•°çš„å¤´éƒ¨ï¼š</span></span><br><span class="line">.cfi_startproc          <span class="comment"># .cfi_startproc æŒ‡ä»¤é€šå¸¸ç”¨äºå‡½æ•°çš„å¼€å§‹å¤„</span></span><br><span class="line"><span class="comment">## %bb.0:</span></span><br><span class="line">pushq%rbp    <span class="comment"># rbp å¯„å­˜å™¨ (åŸºç¡€æŒ‡é’ˆå¯„å­˜å™¨ base pointer register)</span></span><br><span class="line">.cfi_def_cfa_offset 16</span><br><span class="line">.cfi_offset %rbp, -16</span><br><span class="line">movq%rsp, %rbp</span><br><span class="line">.cfi_def_cfa_register %rbp</span><br><span class="line">subq<span class="variable">$16</span>, %rsp</span><br><span class="line">movl<span class="variable">$0</span>, -4(%rbp)</span><br><span class="line">leaqL_.str(%rip), %rdi</span><br><span class="line">movb<span class="variable">$0</span>, %al</span><br><span class="line">callq_printf <span class="comment">#è°ƒç”¨äº† printf</span></span><br><span class="line">xorl%ecx, %ecx</span><br><span class="line">movl%eax, -8(%rbp)          <span class="comment">## 4-byte Spill</span></span><br><span class="line">movl%ecx, %eax</span><br><span class="line">addq<span class="variable">$16</span>, %rsp</span><br><span class="line">popq%rbp <span class="comment"># ä¸pushqå¯¹åº”</span></span><br><span class="line">retq</span><br><span class="line">.cfi_endproc <span class="comment"># ä¸ .cfi_startproc ç›¸åŒ¹é…ï¼Œä»¥æ­¤æ ‡è®°å‡º main() å‡½æ•°ç»“æŸ</span></span><br><span class="line">                                        <span class="comment">## -- End function</span></span><br><span class="line">.section__TEXT,__cstring,cstring_literals <span class="comment"># __TEXT __cstring å¼€å¯äº†ä¸€ä¸ªæ–°çš„æ®µã€‚</span></span><br><span class="line">L_.str:       <span class="comment">#L_.str æ ‡è®°è¿è¡Œåœ¨å®é™…çš„ä»£ç ä¸­è·å–åˆ°å­—ç¬¦ä¸²çš„ä¸€ä¸ªæŒ‡é’ˆ                          ## @.str</span></span><br><span class="line">.asciz<span class="string">"hello world\n"</span> <span class="comment">#.asciz æŒ‡ä»¤å‘Šè¯‰ç¼–è¯‘å™¨è¾“å‡ºä¸€ä¸ªä»¥ â€˜\0â€™ (null) ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.subsections_via_symbolsv <span class="comment"># .subsections_via_symbols æŒ‡ä»¤æ˜¯é™æ€é“¾æ¥ç¼–è¾‘å™¨ä½¿ç”¨çš„ã€‚</span></span><br></pre></td></tr></table></figure><p>å…·ä½“çš„ä»£ç è§£è¯»ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åˆ°<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html" target="_blank" rel="noopener">è‹¹æœçš„ OS X Assembler Reference </a> äº†è§£è¯¦ç»†ã€‚</p><!-- https://objccn.io/issue-6-3/ --><h3 id="æ±‡ç¼–å™¨"><a href="#æ±‡ç¼–å™¨" class="headerlink" title="æ±‡ç¼–å™¨"></a>æ±‡ç¼–å™¨</h3><p>æ±‡ç¼–å™¨å°†å¯è¯»çš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨ä»£ç ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ªç›®æ ‡å¯¹è±¡æ–‡ä»¶ï¼Œä¸€èˆ¬ç®€ç§°ä¸º å¯¹è±¡æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ä»¥ .o ç»“å°¾ã€‚å¦‚æœç”¨ Xcode æ„å»ºåº”ç”¨ç¨‹åºï¼Œå¯ä»¥åœ¨å·¥ç¨‹çš„ derived data ç›®å½•ä¸­ï¼ŒObjects-normal æ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°è¿™äº›æ–‡ä»¶ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¾‹å¦‚ ç”Ÿæˆ main.oæ–‡ä»¶</span></span><br><span class="line">clang -fmodules -c main.c -o main.o</span><br></pre></td></tr></table></figure><h3 id="é“¾æ¥å™¨"><a href="#é“¾æ¥å™¨" class="headerlink" title="é“¾æ¥å™¨"></a>é“¾æ¥å™¨</h3><p>é“¾æ¥å™¨è§£å†³äº†ç›®æ ‡æ–‡ä»¶å’Œåº“ä¹‹é—´çš„é“¾æ¥ã€‚ä¾‹å¦‚ä¸Šé¢æ±‡ç¼–ä»£ç ä¸­ <code>callq   _printf</code>ï¼Œ <code>printf()</code> æ˜¯ libc åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚æ— è®ºæ€æ ·ï¼Œæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦èƒ½éœ€è¦çŸ¥é“ printf() åœ¨å†…å­˜ä¸­çš„å…·ä½“ä½ç½®ï¼šä¾‹å¦‚ï¼Œ_printf çš„åœ°å€ç¬¦å·æ˜¯ä»€ä¹ˆã€‚é“¾æ¥å™¨ä¼šè¯»å–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ (æ­¤å¤„åªæœ‰ä¸€ä¸ª) å’Œåº“ (æ­¤å¤„æ˜¯ libc)ï¼Œå¹¶è§£å†³æ‰€æœ‰æœªçŸ¥ç¬¦å· (æ­¤å¤„æ˜¯ _printf) çš„é—®é¢˜ã€‚ç„¶åå°†å®ƒä»¬ç¼–ç è¿›æœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ ï¼ˆå¯ä»¥åœ¨ libc ä¸­æ‰¾åˆ°ç¬¦å· _printfï¼‰ï¼Œæ¥ç€é“¾æ¥å™¨ä¼šè¾“å‡ºå¯ä»¥è¿è¡Œçš„æ‰§è¡Œæ–‡ä»¶ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç”Ÿæˆ hello.out çš„ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">clang hello.c -o hello.out</span><br></pre></td></tr></table></figure><p>å…³äº<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" target="_blank" rel="noopener">Mach-Oæ–‡ä»¶æ ¼å¼</a>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥é€šè¿‡appleæ–‡æ¡£æ¥äº†è§£ã€‚</p><p>è¿™é‡Œè¯´ hello.out æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡<code>file</code>æ¥åˆ¤æ–­:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">file hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">hello.out: Mach-O 64-bit executable x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œhello.out</span></span><br><span class="line">./hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º </span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><h2 id="ç¼–è¯‘å¤šä¸ªæ–‡ä»¶"><a href="#ç¼–è¯‘å¤šä¸ªæ–‡ä»¶" class="headerlink" title="ç¼–è¯‘å¤šä¸ªæ–‡ä»¶"></a>ç¼–è¯‘å¤šä¸ªæ–‡ä»¶</h2><p>ä¹‹å‰ä¸Šé¢æˆ‘ä»¬çš„å®éªŒéƒ½æ˜¯ä½¿ç”¨å•ä¸ªhello.cæ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬é€šè¿‡å¤šä¸ªæ–‡ä»¶æƒ…å†µ äº†è§£ä¸‹æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ ,å¦‚ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//File1.h:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Foo</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//File1.m:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"File1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Foo</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSFullUserName</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//File2.m:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"File1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Foo *foo = [[Foo alloc] init];</span><br><span class="line">        [foo run];</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œéœ€è¦æˆ‘ä»¬ç¼–è¯‘å¤šä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦è®©clangå¯¹è¾“å…¥æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clang  -c Only run preprocess, compile, and assemble steps</span></span><br><span class="line"></span><br><span class="line">clang -c File1.m <span class="comment">#ç”Ÿæˆ File1.o</span></span><br><span class="line">clang -c File2.m <span class="comment">#ç”Ÿæˆ File2.o</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åŠ äº†<code>-c</code> å¹¶æ²¡æœ‰ç¼–è¯‘å¤´æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬æ¥å®Œæˆ<code>é“¾æ¥å™¨</code>è¿™ä¸€æ­¥,å°†ä¸¤ä¸ª .o æ–‡ä»¶ä¸Foundationåº“é“¾æ¥èµ·æ¥ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  -Wl,&lt;arg&gt;               Pass the comma separated arguments in &lt;arg&gt; to the linker</span></span><br><span class="line">clang File1.o File2.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation</span><br><span class="line"><span class="comment"># è¾“å‡º a.out</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œ <code>a.out</code> äº†ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./a.out </span><br><span class="line">2019-04-16 20:49:35.070 a.out[71207:10299638] sunTongSheng</span><br></pre></td></tr></table></figure><h3 id="ç¬¦å·è¡¨å’Œé“¾æ¥"><a href="#ç¬¦å·è¡¨å’Œé“¾æ¥" class="headerlink" title="ç¬¦å·è¡¨å’Œé“¾æ¥"></a>ç¬¦å·è¡¨å’Œé“¾æ¥</h3><p>File1 å’Œ File2 éƒ½ä½¿ç”¨äº† Foundation frameworkã€‚ File2.o ç›®æ ‡æ–‡ä»¶ä½¿ç”¨äº†å®ƒçš„ autorelease poolï¼Œå¹¶é—´æ¥çš„ä½¿ç”¨äº† libobjc.dylib ä¸­çš„ Objective-C è¿è¡Œæ—¶ã€‚å®ƒéœ€è¦è¿è¡Œæ—¶å‡½æ•°æ¥è¿›è¡Œæ¶ˆæ¯çš„è°ƒç”¨ã€‚æ‰€æœ‰çš„è¿™äº›å…³è”çš„ä¸œè¥¿éƒ½è¢«å½¢è±¡çš„ç§°ä¹‹ä¸ºç¬¦å·ã€‚</p><p>æ¯ä¸ªå‡½æ•°ã€å…¨å±€å˜é‡å’Œç±»ç­‰éƒ½æ˜¯é€šè¿‡ç¬¦å·çš„å½¢å¼æ¥å®šä¹‰å’Œä½¿ç”¨çš„ã€‚å½“æˆ‘ä»¬å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥å™¨åœ¨ç›®æ ‡æ–‡ä»¶å’ŒåŠ¨æ€åº“ä¹‹é—´å¯¹ç¬¦å·åšäº†è§£æå¤„ç†ã€‚</p><p>å¯æ‰§è¡Œæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼Œè¿™ä¸ªç¬¦å·è¡¨è§„å®šäº†å®ƒä»¬çš„ç¬¦å·ã€‚å¦‚æœæˆ‘ä»¬ç”¨ nm å·¥å…·è§‚å¯Ÿä¸€ä¸‹ File2.o ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nm : llvm symbol table dumper</span></span><br><span class="line">nm -nm File2.o</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br><span class="line">                 (undefined) external _objc_alloc</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPop</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPush</span><br><span class="line">                 (undefined) external _objc_msgSend</span><br><span class="line">0000000000000000 (__TEXT,__text) external _main</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯é‚£ä¸ªç›®æ ‡æ–‡ä»¶çš„æ‰€æœ‰ç¬¦å·ã€‚_OBJC_CLASS_$_Foo æ˜¯ Foo Objective-C ç±»çš„ç¬¦å·ã€‚è¯¥ç¬¦å·æ˜¯ undefined, external ã€‚External çš„æ„æ€æ˜¯æŒ‡å¯¹äºè¿™ä¸ªç›®æ ‡æ–‡ä»¶è¯¥ç±»å¹¶ä¸æ˜¯ç§æœ‰çš„ï¼Œç›¸åï¼Œnon-external çš„ç¬¦å·åˆ™è¡¨ç¤ºå¯¹äºç›®æ ‡æ–‡ä»¶æ˜¯ç§æœ‰çš„ã€‚æˆ‘ä»¬çš„ File2.o ç›®æ ‡æ–‡ä»¶å¼•ç”¨äº†ç±» Fooï¼Œä¸è¿‡è¿™å¹¶æ²¡æœ‰å®ç°å®ƒã€‚å› æ­¤ç¬¦å·è¡¨ä¸­å°†å…¶æ ‡ç¤ºä¸º undefinedã€‚æ¥ç€æ˜¯ 4 ä¸ª Objective-C è¿è¡Œæ—¶å‡½æ•°ã€‚å®ƒä»¬åŒæ ·æ˜¯ undefinedçš„ï¼Œéœ€è¦é“¾æ¥å™¨è¿›è¡Œç¬¦å·è§£æã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ _main ç¬¦å·ï¼Œå®ƒæ˜¯è¡¨ç¤º main() å‡½æ•°ï¼ŒåŒæ ·ä¸º externalï¼Œè¿™æ˜¯å› ä¸ºè¯¥å‡½æ•°éœ€è¦è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥ä¸ºå¯è§çš„ã€‚ç”±äºåœ¨ helloworld.o æ–‡ä»¶ä¸­å®ç°äº† è¿™ä¸ª main å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ°å€ä½äº 0å¤„ï¼Œå¹¶ä¸”éœ€è¦è½¬å…¥åˆ° <strong>TEXT,</strong>text sectionã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>File1.o</code>,çœ‹çœ‹æœ‰ä»€ä¹ˆè¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nm -nm File1.o</span><br><span class="line">                 (undefined) external _NSFullUserName</span><br><span class="line">                 (undefined) external _NSLog</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_NSObject</span></span><br><span class="line">                 (undefined) external _OBJC_METACLASS_<span class="variable">$_NSObject</span></span><br><span class="line">                 (undefined) external ___CFConstantStringClassReference</span><br><span class="line">                 (undefined) external __objc_empty_cache</span><br><span class="line">0000000000000000 (__TEXT,__text) non-external -[Foo run]</span><br><span class="line">0000000000000060 (__DATA,__objc_const) non-external l_OBJC_METACLASS_RO_<span class="variable">$_Foo</span></span><br><span class="line">00000000000000a8 (__DATA,__objc_const) non-external l_OBJC_<span class="variable">$_INSTANCE_METHODS_Foo</span></span><br><span class="line">00000000000000c8 (__DATA,__objc_const) non-external l_OBJC_CLASS_RO_<span class="variable">$_Foo</span></span><br><span class="line">0000000000000110 (__DATA,__objc_data) external _OBJC_METACLASS_<span class="variable">$_Foo</span></span><br><span class="line">0000000000000138 (__DATA,__objc_data) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br></pre></td></tr></table></figure><p>File1.o åŒæ ·æœ‰ undefined çš„ç¬¦å·ã€‚é¦–å…ˆæ˜¯ä½¿ç”¨äº†ç¬¦å· <code>NSFullUserName()</code>ï¼Œ<code>NSLog()</code>å’Œ <code>NSObject</code>ã€‚æ¥ç€æ˜¾ç¤ºäº† <code>_OBJC_CLASS_$_Foo</code> å·²ç»å®šä¹‰äº†ï¼Œå¹¶ä¸”å¯¹äº File1.o æ˜¯ä¸€ä¸ªå¤–éƒ¨ç¬¦å· , <code>File1.o</code> åŒ…å«äº†è¿™ä¸ªç±»çš„å®ç°ã€‚</p><p>æœ€åå…ˆæ¥åŒæ ·çœ‹ä¸‹ a.out çš„è¾“å‡ºï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nm -nm a.out </span><br><span class="line">                 (undefined) external _NSFullUserName (from Foundation)</span><br><span class="line">                 (undefined) external _NSLog (from Foundation)</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_NSObject</span> (from CoreFoundation)</span><br><span class="line">                 (undefined) external _OBJC_METACLASS_<span class="variable">$_NSObject</span> (from CoreFoundation)</span><br><span class="line">                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)</span><br><span class="line">                 (undefined) external __objc_empty_cache (from libobjc)</span><br><span class="line">                 (undefined) external _objc_alloc (from libobjc)</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPop (from libobjc)</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPush (from libobjc)</span><br><span class="line">                 (undefined) external _objc_msgSend (from libobjc)</span><br><span class="line">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class="line">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class="line">0000000100000e90 (__TEXT,__text) non-external -[Foo run]</span><br><span class="line">0000000100000ec0 (__TEXT,__text) external _main</span><br><span class="line">0000000100001138 (__DATA,__objc_data) external _OBJC_METACLASS_<span class="variable">$_Foo</span></span><br><span class="line">0000000100001160 (__DATA,__objc_data) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>a.out</code>çš„ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿé“¾æ¥å™¨æ˜¯å¦‚ä½•è§£ææ‰€æœ‰ç¬¦å·è¡¨çš„ã€‚å½“æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶å’Œ Foundation framework (æ˜¯ä¸€ä¸ªåŠ¨æ€åº“) è¿›è¡Œé“¾æ¥å¤„ç†æ—¶ï¼Œé“¾æ¥å™¨ä¼šå°è¯•è§£ææ‰€æœ‰çš„ undefined ç¬¦å·ã€‚å®ƒå¯ä»¥è§£æ _OBJC_CLASS_$_Fooã€‚å¦å¤–ï¼Œå®ƒå°†ä½¿ç”¨ Foundation frameworkã€‚å½“é“¾æ¥å™¨é€šè¿‡åŠ¨æ€åº“ (æ­¤å¤„æ˜¯ Foundation framework) è§£ææˆåŠŸä¸€ä¸ªç¬¦å·æ—¶ï¼Œå®ƒä¼šåœ¨æœ€ç»ˆçš„é“¾æ¥å›¾ä¸­è®°å½•è¿™ä¸ªç¬¦å·æ˜¯é€šè¿‡åŠ¨æ€åº“è¿›è¡Œè§£æçš„ã€‚é“¾æ¥å™¨ä¼šè®°å½•è¾“å‡ºæ–‡ä»¶æ˜¯ä¾èµ–äºå“ªä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå¹¶è¿åŒå…¶è·¯å¾„ä¸€èµ·è¿›è¡Œè®°å½•ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ_NSFullUserNameï¼Œ_NSLogï¼Œ_OBJC_CLASS_$_NSObjectï¼Œ_objc_autoreleasePoolPop ç­‰ç¬¦å·éƒ½æ˜¯éµå¾ªè¿™ä¸ªè¿‡ç¨‹ã€‚</p><p>è™½ç„¶æ‰€æœ‰çš„ Foundation å’Œ Objective-C è¿è¡Œæ—¶ç¬¦å·ä¾æ—§æ˜¯ undefinedï¼Œä¸è¿‡ç°åœ¨çš„ç¬¦å·è¡¨ä¸­å·²ç»å¤šäº†å¦‚ä½•è§£æå®ƒä»¬çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨å“ªä¸ªåŠ¨æ€åº“ä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·ã€‚</p><p>å¯æ‰§è¡Œæ–‡ä»¶åŒæ ·çŸ¥é“å»å“ªé‡Œæ‰¾åˆ°æ‰€éœ€åº“ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">otool -L a.out </span><br><span class="line">a.out:</span><br><span class="line">/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 1560.12.0)</span><br><span class="line">/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.50.4)</span><br><span class="line">/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1454.90.0)</span><br><span class="line">/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)</span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€é“¾æ¥å™¨"><a href="#åŠ¨æ€é“¾æ¥å™¨" class="headerlink" title="åŠ¨æ€é“¾æ¥å™¨"></a>åŠ¨æ€é“¾æ¥å™¨</h3><p>åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨dyldå¯ä»¥è§£æè¿™äº› <code>undefined</code> ç¬¦å·ï¼Œdyldå°†ä¼šç¡®å®šå¥½ <code>_NSFullUserName</code> ç­‰ç¬¦å·ï¼Œå¹¶æŒ‡å‘å®ƒä»¬åœ¨ <code>Foundation</code> ä¸­çš„å®ç°ç­‰ã€‚<br>ä¸Šé¢æåˆ°æ–‡ä»¶ç¬¦å·è¡¨æŒ‡å‘äº†éœ€è¦çš„åº“ï¼Œæ·»åŠ <code>DYLD_PRINT_LIBRARIES</code>ç¯å¢ƒå˜é‡å¯ä»¥æ‰“å°å‡ºä»€ä¹ˆåº“è¢«åŠ è½½äº†ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">export</span> DYLD_PRINT_LIBRARIES=; ./a.out )</span><br><span class="line">dyld: loaded: /Users/suntongsheng/Desktop/tmp/asdasd/Test/./a.out</span><br><span class="line">dyld: loaded: /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation</span><br><span class="line">dyld: loaded: /usr/lib/libSystem.B.dylib</span><br><span class="line">dyld: loaded: /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚å¯ä»¥é’ˆå¯¹ Foundation è¿è¡Œ <code>nm</code>ï¼Œå¹¶æ£€æŸ¥è¿™äº›ç¬¦å·çš„å®šä¹‰æƒ…å†µï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nm -nm /System/Library/Frameworks/Foundation.framework/Foundation | grep NSFullUserName</span><br><span class="line">00000000000bb1be (__TEXT,__text) external _NSFullUserName</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°†ä¼šæ˜¾ç¤ºå‡ºåœ¨åŠ è½½ Foundation æ—¶ï¼ŒåŒæ—¶ä¼šåŠ è½½çš„ 70 ä¸ªåŠ¨æ€åº“ã€‚è¿™æ˜¯ç”±äº Foundation ä¾èµ–äºå¦å¤–ä¸€äº›åŠ¨æ€åº“ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun otool -L /System/Library/Frameworks/Foundation.framework/Foundation</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Foundation å…³è”çš„åº“ã€‚</p><p><strong><em>åŠ¨æ€é“¾æ¥å™¨dyld çš„å…±äº«ç¼“å­˜</em></strong></p><p>å½“ä½ æ„å»ºä¸€ä¸ªçœŸæ­£çš„ç¨‹åºæ—¶ï¼Œå°†ä¼šé“¾æ¥å„ç§å„æ ·çš„åº“ã€‚å®ƒä»¬åˆä¼šä¾èµ–å…¶ä»–ä¸€äº› framework å’Œ åŠ¨æ€åº“ã€‚éœ€è¦åŠ è½½çš„åŠ¨æ€åº“ä¼šéå¸¸å¤šã€‚è€Œå¯¹äºç›¸äº’ä¾èµ–çš„ç¬¦å·å°±æ›´å¤šäº†ã€‚å¯èƒ½å°†ä¼šæœ‰ä¸Šåƒä¸ªç¬¦å·éœ€è¦è§£æå¤„ç†ï¼Œè¿™å°†èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ï¼šä¸€èˆ¬æ˜¯å¥½å‡ ç§’é’Ÿã€‚</p><p>ä¸ºäº†ç¼©çŸ­è¿™ä¸ªå¤„ç†è¿‡ç¨‹æ‰€èŠ±è´¹æ—¶é—´ï¼Œåœ¨ OS X å’Œ iOS ä¸Šçš„åŠ¨æ€é“¾æ¥å™¨ä½¿ç”¨äº†å…±äº«ç¼“å­˜ï¼Œå…±äº«ç¼“å­˜å­˜äº /var/db/dyld/ã€‚å¯¹äºæ¯ä¸€ç§æ¶æ„ï¼Œæ“ä½œç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­åŒ…å«äº†ç»å¤§å¤šæ•°çš„åŠ¨æ€åº“ï¼Œè¿™äº›åº“éƒ½å·²ç»é“¾æ¥ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å·²ç»å¤„ç†å¥½äº†å®ƒä»¬ä¹‹é—´çš„ç¬¦å·å…³ç³»ã€‚å½“åŠ è½½ä¸€ä¸ª Mach-O æ–‡ä»¶ (ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…ä¸€ä¸ªåº“) æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨é¦–å…ˆä¼šæ£€æŸ¥ å…±äº«ç¼“å­˜ çœ‹çœ‹æ˜¯å¦å­˜åœ¨å…¶ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä»å…±äº«ç¼“å­˜ä¸­æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æŠŠè¿™ä¸ªå…±äº«ç¼“å­˜æ˜ å°„åˆ°äº†è‡ªå·±çš„åœ°å€ç©ºé—´ä¸­ã€‚è¿™ä¸ªæ–¹æ³•å¤§å¤§ä¼˜åŒ–äº† OS X å’Œ iOS ä¸Šç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€‚</p><h2 id="æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š"><a href="#æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š" class="headerlink" title="æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š"></a>æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š</h2><p><img src="/res/LLVM/llvm1.png" alt></p><h2 id="Xcode-ç¼–è¯‘"><a href="#Xcode-ç¼–è¯‘" class="headerlink" title="Xcode ç¼–è¯‘"></a>Xcode ç¼–è¯‘</h2><p>ä»¥ä¸Šè¯´çš„æ˜¯Clangå¦‚ä½•ç¼–è¯‘Cè¯­è¨€æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆåœ¨Xcodeé‡Œä¼šç»è¿‡å“ªäº›è¿‡ç¨‹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥ç®€å•æ–°å»ºä¸€ä¸ªå•é¡µé¢å·¥ç¨‹ï¼ŒBuildååœ¨Report Navigationè§†å›¾ä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š</p><p><img src="/res/LLVM/xcode.png" alt></p><p>è¯¦ç»†çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºæ–‡ä»¶å¤¹</li><li>æŠŠEntitlements.plistå†™å…¥åˆ°DerivedDataé‡Œï¼Œå¤„ç†æ‰“åŒ…çš„æ—¶å€™éœ€è¦çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚application-identifierï¼‰ã€‚</li><li>åˆ›å»ºä¸€äº›è¾…åŠ©æ–‡ä»¶ï¼Œæ¯”å¦‚å„ç§.hmap (headermapæ˜¯å¸®åŠ©ç¼–è¯‘å™¨æ‰¾åˆ°å¤´æ–‡ä»¶çš„è¾…åŠ©æ–‡ä»¶ï¼šå­˜å‚¨è¿™å¤´æ–‡ä»¶åˆ°å…¶ç‰©ç†è·¯å¾„çš„æ˜ å°„å…³ç³»)</li><li>ç¼–è¯‘.mæ–‡ä»¶ï¼Œç”Ÿæˆ.oæ–‡ä»¶ã€‚</li><li>é“¾æ¥åŠ¨æ€åº“ï¼Œoæ–‡ä»¶ï¼Œç”Ÿæˆä¸€ä¸ªmach oæ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li>ç¼–è¯‘assetsï¼Œç¼–è¯‘storyboardï¼Œé“¾æ¥storyboard</li><li>å¯¹Appç­¾å</li><li>ç”Ÿæˆ .app</li></ol><p>åœ¨ build å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½ä¼šå‡ºç°ç±»ä¼¼ä¸Šé¢çš„è¿™äº› log ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¸Šé¢çš„ log ä¿¡æ¯è¿›ä¸€æ­¥äº†è§£è¯¦æƒ…ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç¼–è¯‘å™¨&quot;&gt;&lt;a href=&quot;#ç¼–è¯‘å™¨&quot; class=&quot;headerlink&quot; title=&quot;ç¼–è¯‘å™¨&quot;&gt;&lt;/a&gt;ç¼–è¯‘å™¨&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;æŠŠä¸€ç§ç¼–ç¨‹è¯­è¨€(åŸå§‹è¯­è¨€)è½¬æ¢ä¸ºå¦ä¸€ç§ç¼–ç¨‹è¯­è¨€(ç›®æ ‡è¯­è¨€)çš„ç¨‹åºå«åšç¼–è¯‘å™¨&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;å¤§å¤šæ•°ç¼–è¯‘å™¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå‰ç«¯å’Œåç«¯ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‰ç«¯è´Ÿè´£è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ï¼›&lt;/li&gt;
&lt;li&gt;åç«¯ä»¥ä¸­é—´ä»£ç ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œè¡Œæ¶æ„æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ¥ç€é’ˆå¯¹ä¸åŒæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Objective C/C/C++ä½¿ç”¨çš„ç¼–è¯‘å™¨å‰ç«¯æ˜¯clangï¼Œswiftæ˜¯swiftï¼Œåç«¯éƒ½æ˜¯LLVMã€‚&lt;/p&gt;
&lt;h3 id=&quot;llvmä»‹ç»&quot;&gt;&lt;a href=&quot;#llvmä»‹ç»&quot; class=&quot;headerlink&quot; title=&quot;llvmä»‹ç»&quot;&gt;&lt;/a&gt;llvmä»‹ç»&lt;/h3&gt;&lt;p&gt;LLVMæ˜¯ä»€ä¹ˆï¼Œæ˜¯low level virtual machineçš„ç®€ç§°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ¡†æ¶ã€‚LLVM çš„ä¼˜ç‚¹ä¸»è¦å¾—ç›Šäºå®ƒçš„ä¸‰å±‚å¼æ¶æ„ â€“ ç¬¬ä¸€å±‚æ”¯æŒå¤šç§è¯­è¨€ä½œä¸ºè¾“å…¥(ä¾‹å¦‚ C, ObjectiveC, C++ å’Œ Haskell)ï¼Œç¬¬äºŒå±‚æ˜¯ä¸€ä¸ªå…±äº«å¼çš„ä¼˜åŒ–å™¨(å¯¹ LLVM IR åšä¼˜åŒ–å¤„ç†)ï¼Œç¬¬ä¸‰å±‚æ˜¯è®¸å¤šä¸åŒçš„ç›®æ ‡å¹³å°(ä¾‹å¦‚ Intel, ARM å’Œ PowerPC)ã€‚ç¼–è¯‘å™¨å‰ç«¯ä¸»è¦è¿›è¡Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ã€‚ç¼–è¯‘å™¨åç«¯ä¼šè¿›è¡Œæœºå™¨æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ ¹æ®ä¸åŒçš„ç³»ç»Ÿæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/res/LLVM/LLVMCompiler1.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;ç°åœ¨ï¼ŒXcode çš„é»˜è®¤ç¼–è¯‘å™¨æ˜¯ clangã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬æåˆ°çš„ç¼–è¯‘å™¨éƒ½è¡¨ç¤º clangã€‚clang çš„åŠŸèƒ½æ˜¯é¦–å…ˆå¯¹ Objective-C ä»£ç åšåˆ†ææ£€æŸ¥ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºä½çº§çš„ç±»æ±‡ç¼–ä»£ç ï¼šLLVM Intermediate Representation(LLVM ä¸­é—´è¡¨è¾¾ç )ã€‚æ¥ç€ LLVM ä¼šæ‰§è¡Œç›¸å…³æŒ‡ä»¤å°† LLVM IR ç¼–è¯‘æˆç›®æ ‡å¹³å°ä¸Šçš„æœ¬åœ°å­—èŠ‚ç ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å®Œæˆæ–¹å¼å¯ä»¥æ˜¯å³æ—¶ç¼–è¯‘ (Just-in-time)ï¼Œæˆ–åœ¨ç¼–è¯‘çš„æ—¶å€™å®Œæˆã€‚è€ŒClang æ˜¯ä¸€ä¸ªCã€C++ã€Objective-Cå’ŒObjective-C++ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚å®ƒé‡‡ç”¨äº†åº•å±‚è™šæ‹Ÿæœºï¼ˆLLVMï¼‰ä½œä¸ºå…¶åç«¯ã€‚å®ƒçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªGNUç¼–è¯‘å™¨å¥—è£…ï¼ˆGCCï¼‰çš„æ›¿ä»£å“ã€‚Clangé¡¹ç›®åŒ…æ‹¬Clangå‰ç«¯å’ŒClangé™æ€åˆ†æå™¨ç­‰ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹å›¾æ˜¯iOSç¼–è¯‘è¿‡ç¨‹ï¼š&lt;br&gt;&lt;img src=&quot;/res/LLVM/iOSCompiler.png&quot; alt&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="LLVM" scheme="https://developerdoc.com/tags/LLVM/"/>
    
  </entry>
  
  <entry>
    <title>LLDBæ•™ç¨‹-å‘½ä»¤ç¯‡</title>
    <link href="https://developerdoc.com/essay/LLDB/LLDB_tutorial/"/>
    <id>https://developerdoc.com/essay/LLDB/LLDB_tutorial/</id>
    <published>2019-03-14T12:53:17.000Z</published>
    <updated>2019-04-23T02:18:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä½ æ˜¯å¦æ›¾ç»è‹¦æ¼äºç†è§£é¡¹ç›®çš„ä»£ç ï¼Œè€Œå»å°è¯•æ‰“å°ä¸€ä¸ªå˜é‡çš„å€¼ï¼Ÿç„¶åä½¿ç”¨NSLog å¹¶ä¸”æ¯æ¬¡å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œä»å¤´å¼€å§‹ï¼Ÿä½†æ˜¯ä¸ä¸€å®šè¦è¿™ä¹ˆåšã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒè¯•å™¨ã€‚è€Œä¸”å³ä½¿ä½ å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨è°ƒè¯•å™¨æ£€æŸ¥å˜é‡ï¼Œå®ƒå¯ä»¥åšçš„è¿˜æœ‰å¾ˆå¤šã€‚</p><h2 id="LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="LLDB æ˜¯ä»€ä¹ˆï¼Ÿ"></a>LLDB æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><a href="http://lldb.llvm.org/" target="_blank" rel="noopener">LLDB</a>æ˜¯Mac OS Xä¸ŠXcodeçš„é»˜è®¤è°ƒè¯•å™¨ï¼Œæ”¯æŒå†æ¡Œé¢å’ŒiOSè®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨ä¸Šè°ƒè¯•C ï¼ŒObjective-Cå’ŒC++ã€‚å®ƒæ˜¯æ–°ä¸€ä»£é«˜æ€§èƒ½è°ƒè¯•å™¨ï¼Œå®ƒå¯ä»¥é«˜æ•ˆåˆ©ç”¨LLVMé¡¹ç›®ä¸­çš„ç°æœ‰åº“ï¼Œä¾‹å¦‚Clangè¡¨è¾¾å¼è§£æå™¨å’ŒLLVMåæ±‡ç¼–ç¨‹åºã€‚</p><p>éšç€Xcode 5çš„å‘å¸ƒï¼ŒLLDBè°ƒè¯•å™¨å·²ç»å–ä»£äº†GDBï¼Œæˆä¸ºäº†Xcodeå·¥ç¨‹ä¸­é»˜è®¤çš„è°ƒè¯•å™¨ã€‚å®ƒä¸LLVMç¼–è¯‘å™¨ä¸€èµ·ï¼Œå¸¦ç»™æˆ‘ä»¬æ›´ä¸°å¯Œçš„æµç¨‹æ§åˆ¶å’Œæ•°æ®æ£€æµ‹çš„è°ƒè¯•åŠŸèƒ½ã€‚LLDBä¸ºXcodeæä¾›äº†åº•å±‚è°ƒè¯•ç¯å¢ƒï¼Œå…¶ä¸­åŒ…æ‹¬å†…åµŒåœ¨Xcode IDEä¸­çš„ä½äºè°ƒè¯•åŒºåŸŸçš„æ§åˆ¶é¢æ¿ã€‚</p><p><a href="https://github.com/facebook/chisel" target="_blank" rel="noopener">Chisel</a> æ˜¯facebookä¸‹ä¸€ä¸ªå¼€æºLLDBå‘½ä»¤é›†åˆã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œè®©æˆ‘ä»¬ä»¥åœ¨è°ƒè¯•å™¨ä¸­æ‰“å°å˜é‡æ¥å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹å§ã€‚</p><a id="more"></a><h2 id="åŸºç¡€å‘½ä»¤"><a href="#åŸºç¡€å‘½ä»¤" class="headerlink" title="åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h2><p><img src="/res/LLDB/1.png" alt></p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•åŠ äº†æ–­ç‚¹çš„ç¨‹åºï¼Œç¨‹åºä¼šåœ¨è¿™ä¸€è¡Œåœæ­¢è¿è¡Œï¼Œå¹¶ä¸”æ§åˆ¶å°ä¼šè¢«æ‰“å¼€ï¼Œå…è®¸æˆ‘ä»¬å’Œè°ƒè¯•å™¨äº¤äº’ã€‚è¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥æ‰“äº›ä»€ä¹ˆå‘½ä»¤å‘¢ï¼Ÿ</p><p><strong><em>å¸®åŠ© help</em></strong></p><p>æœ€ç®€å•å‘½ä»¤æ˜¯ <code>help</code>ï¼Œå®ƒä¼šåˆ—ä¸¾å‡ºæ‰€æœ‰çš„å‘½ä»¤ã€‚å¦‚æœä½ å¿˜è®°äº†ä¸€ä¸ªå‘½ä»¤æ˜¯åšä»€ä¹ˆçš„ï¼Œæˆ–è€…æƒ³çŸ¥é“æ›´å¤šçš„è¯ï¼Œä½ å¯ä»¥é€šè¿‡ <code>help &lt;command-name&gt;</code> æ¥äº†è§£æ›´å¤šç»†èŠ‚ï¼Œä¾‹å¦‚ <code>help print</code> æˆ–è€… <code>help thread</code>ã€‚åªéœ€è¦åœ¨æ§åˆ¶å° ä¸Šå›¾lldbå­—æ ·çš„åœ°æ–¹é”®å…¥ helpå³å¯ã€‚</p><p><img src="/res/LLDB/2.png" alt></p><p><strong><em>æ‰“å°å¯¹è±¡ print</em></strong><br>æ‰“å°å€¼å¾ˆç®€å•ï¼›åªè¦è¯•è¯• print å‘½ä»¤:</p><p><img src="/res/LLDB/3.png" alt></p><p>LLDB å®é™…ä¸Šä¼šä½œå‰ç¼€åŒ¹é…ã€‚æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ prinï¼Œpriï¼Œæˆ–è€… pã€‚ä½†ä½ ä¸èƒ½ä½¿ç”¨ prï¼Œå› ä¸º LLDB ä¸èƒ½æ¶ˆé™¤å’Œ process çš„æ­§ä¹‰ (å¹¸è¿çš„æ˜¯ p å¹¶æ²¡æœ‰æ­§ä¹‰)ã€‚è€Œprint åˆ™æ˜¯<code>expression --</code>çš„ç®€å†™æ–¹å¼ã€‚</p><p>ä½ å¯èƒ½è¿˜æ³¨æ„åˆ°äº†ï¼Œç»“æœä¸­æœ‰ä¸ª $0ã€‚å®é™…ä¸Šä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å‘è¿™ä¸ªç»“æœã€‚è¯•è¯• print $0 + 7ï¼Œä½ ä¼šçœ‹åˆ° 130ã€‚ä»»ä½•ä»¥$ç¬¦å¼€å¤´çš„ä¸œè¥¿éƒ½æ˜¯å­˜åœ¨äº LLDB çš„å‘½åç©ºé—´çš„ï¼Œå®ƒä»¬æ˜¯ä¸ºäº†å¸®åŠ©ä½ è¿›è¡Œè°ƒè¯•è€Œå­˜åœ¨çš„ã€‚</p><p>æ‰“å°å¤æ‚å¯¹è±¡æ—¶ï¼Œprintå¯èƒ½æ˜¾å¾—åŠ›ä¸ä»å¿ƒ ï¼Œæˆ‘ä»¬æƒ³çœ‹çš„æ˜¯å¯¹è±¡çš„ description æ–¹æ³•çš„ç»“æœï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ <code>po</code> ï¼Œpo å…¶å®æ˜¯ <code>e -o --</code>çš„åˆ«åã€‚</p><p>ç”šè‡³å¯ä»¥ç»™print æŒ‡å®šä¸åŒçš„æ‰“å°æ ¼å¼ã€‚å®ƒä»¬éƒ½æ˜¯ä»¥ <code>print/&lt;fmt&gt;</code> æˆ–è€…ç®€åŒ–çš„ <code>p/&lt;fmt&gt;</code> æ ¼å¼ä¹¦å†™ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤çš„æ ¼å¼</span></span><br><span class="line">(lldb) p <span class="number">16</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="comment">//åå…­è¿›åˆ¶:</span></span><br><span class="line">(lldb) p/x <span class="number">16</span></span><br><span class="line"><span class="number">0x10</span></span><br><span class="line"><span class="comment">//äºŒè¿›åˆ¶ (t ä»£è¡¨ two)ï¼š</span></span><br><span class="line">(lldb) p/t <span class="number">16</span></span><br><span class="line"><span class="number">0</span>b00000000000000000000000000010000</span><br><span class="line">(lldb) p/t (<span class="keyword">char</span>)<span class="number">16</span></span><br><span class="line"><span class="number">0</span>b00010000</span><br></pre></td></tr></table></figure><p><a href="https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html" target="_blank" rel="noopener">è¿™é‡Œæ˜¯æ ¼å¼çš„å®Œæ•´æ¸…å•</a></p><p><strong><em>ä¿®æ”¹å¯¹è±¡ expression</em></strong></p><p>å¦‚æœæƒ³æ”¹å˜ä¸€ä¸ªå€¼æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯ <code>expression</code> è¿™ä¸ªæ–¹ä¾¿çš„å‘½ä»¤ã€‚</p><p><img src="/res/LLDB/4.png" alt></p><p>ä¸Šå›¾ä¸­ä¿®æ”¹äº†numçš„å€¼ï¼Œæ–­ç‚¹æ­¥è¿›åå¯ä»¥çœ‹åˆ°NSLogçš„å¯¹åº”å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚</p><h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>ç°åœ¨ä½ å·²ç»å¯ä»¥æ‰“å°å¯¹è±¡å’Œç®€å•ç±»å‹ï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•ä½¿ç”¨ expression å‘½ä»¤åœ¨è°ƒè¯•å™¨ä¸­ä¿®æ”¹å®ƒä»¬äº†ã€‚ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ä¸€äº›å˜é‡æ¥å‡å°‘è¾“å…¥é‡ã€‚å°±åƒä½ å¯ä»¥åœ¨ C è¯­è¨€ä¸­ç”¨ int a = 0 æ¥å£°æ˜ä¸€ä¸ªå˜é‡ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ LLDB ä¸­åšåŒæ ·çš„äº‹æƒ…ã€‚ä¸è¿‡ä¸ºäº†èƒ½ä½¿ç”¨å£°æ˜çš„å˜é‡ï¼Œå˜é‡å¿…é¡»ä»¥$ç¬¦å¼€å¤´ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(lldb) e <span class="keyword">int</span> $a = <span class="number">2</span></span><br><span class="line">(lldb) p $a * <span class="number">19</span></span><br><span class="line"><span class="number">38</span></span><br><span class="line">(lldb) e <span class="built_in">NSArray</span> *$array = @[ <span class="string">@"Saturday"</span>, <span class="string">@"Sunday"</span>, <span class="string">@"Monday"</span> ]</span><br><span class="line">(lldb) p [$array count]</span><br><span class="line"><span class="number">2</span></span><br><span class="line">(lldb) po [[$array objectAtIndex:<span class="number">0</span>] uppercaseString]</span><br><span class="line">SATURDAY</span><br><span class="line">(lldb) p (<span class="keyword">char</span>)[[$array objectAtIndex:$a] characterAtIndex:<span class="number">0</span>]</span><br><span class="line"><span class="string">'M'</span></span><br><span class="line">(lldb) p/d (<span class="keyword">char</span>)[[$array objectAtIndex:$a] characterAtIndex:<span class="number">0</span>]</span><br><span class="line"><span class="number">77</span></span><br></pre></td></tr></table></figure><h3 id="UIè°ƒè¯•"><a href="#UIè°ƒè¯•" class="headerlink" title="UIè°ƒè¯•"></a>UIè°ƒè¯•</h3><p>å› ä¸ºå…¨å±€å˜é‡æ˜¯å¯è®¿é—®çš„,å¯ä»¥åƒè¿™æ ·æ‰“å°æ•´ä¸ªè§†å›¾å±‚çº§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [[[UIApplication sharedApplication] keyWindow] recursiveDescription]</span><br><span class="line">&lt;UIWindow: 0x7fe5ac70c6a0; frame = (0 0; 375 812); gestureRecognizers = &lt;NSArray: 0x6000034cb780&gt;; layer = &lt;UIWindowLayer: 0x600003a84680&gt;&gt;</span><br><span class="line">   | &lt;UIView: 0x7fe5ac5069b0; frame = (0 0; 375 812); autoresize = W+H; layer = &lt;CALayer: 0x600003ad3620&gt;&gt;</span><br></pre></td></tr></table></figure><p><strong><em>1ã€æ›´æ–°UI</em></strong></p><p>å°±åƒä¸Šæ–‡å˜é‡ä¸­æåˆ°é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™ä¸ªview:</p><p><code>(lldb) expression id $myView = (id)0x7fe5ac5069b0</code></p><p>å°è¯•åšä¸€äº›ä¿®æ”¹ï¼š</p><p><code>(lldb) expression (void)[$myView setBackgroundColor:[UIColor redColor]]</code></p><p>ä½†æ˜¯åªæœ‰ç¨‹åºç»§ç»­è¿è¡Œä¹‹åæ‰ä¼šçœ‹åˆ°ç•Œé¢çš„å˜åŒ–ã€‚å› ä¸ºæ”¹å˜çš„å†…å®¹å¿…é¡»è¢«å‘é€åˆ°æ¸²æŸ“æœåŠ¡ä¸­ï¼Œç„¶åæ˜¾ç¤ºæ‰ä¼šè¢«æ›´æ–°ã€‚</p><p>æ¸²æŸ“æœåŠ¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¦å¤–çš„è¿›ç¨‹ (è¢«ç§°ä½œ backboardd)ã€‚è¿™å°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬æ­£åœ¨è°ƒè¯•çš„å†…å®¹æ‰€åœ¨çš„è¿›ç¨‹è¢«æ‰“æ–­äº†ï¼Œbackboardd ä¹Ÿè¿˜æ˜¯ç»§ç»­è¿è¡Œç€çš„ã€‚</p><p>è¿™æ„å‘³ç€ä½ å¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè€Œä¸ç”¨ç»§ç»­è¿è¡Œç¨‹åºï¼š</p><p><code>(lldb) expression (void)[CATransaction flush]</code></p><p>è¿™ä¸ªæ—¶å€™å°±èƒ½çœ‹åˆ°èƒŒæ™¯é¢œè‰²çš„æ”¹å˜äº†ã€‚</p><h2 id="æµç¨‹æ§åˆ¶"><a href="#æµç¨‹æ§åˆ¶" class="headerlink" title="æµç¨‹æ§åˆ¶"></a>æµç¨‹æ§åˆ¶</h2><p>é€šè¿‡xcodeåŠ æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œè°ƒè¯•æ¡ä¸Šå›å‡ºç°å››ä¸ªå¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹çš„æŒ‰é’®ï¼š<br><img src="/res/LLDB/5.png" alt></p><p>ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ continue program execution ã€ step over ã€ step into å’Œ step outã€‚</p><p><strong><em>1ã€ continue program execution</em></strong> æŒ‰é’®ï¼Œä¼šå–æ¶ˆç¨‹åºçš„æš‚åœï¼Œå…è®¸ç¨‹åºæ­£å¸¸æ‰§è¡Œ (è¦ä¹ˆä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œè¦ä¹ˆåˆ°è¾¾ä¸‹ä¸€ä¸ªæ–­ç‚¹)ã€‚<br>åœ¨ LLDB ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>process continue</code> æˆ–è€… <code>thread continue</code> å‘½ä»¤æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p><p><strong><em>2ã€ step over</em></strong> æŒ‰é’®ï¼Œä¼šä»¥é»‘ç›’çš„æ–¹å¼æ‰§è¡Œä¸€è¡Œä»£ç ã€‚å¦‚æœæ‰€åœ¨è¿™è¡Œä»£ç æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè·³è¿›è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œç„¶åç»§ç»­ã€‚<br>LLDB åˆ™å¯ä»¥ä½¿ç”¨ <code>thread step-over</code>ï¼Œ<code>next</code>ï¼Œæˆ–è€… <code>n</code> å‘½ä»¤ã€‚</p><p><strong><em>3ã€ step in</em></strong>æŒ‰é’®ï¼Œå¯ä»¥è·³è¿›ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥è°ƒè¯•æˆ–è€…æ£€æŸ¥ç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚<br>åœ¨LLDBä¸­ä½¿ç”¨ <code>thread step-in</code>ï¼Œ<code>step</code>ï¼Œæˆ–è€… s å‘½ä»¤ã€‚æ³¨æ„ï¼Œå½“å‰è¡Œä¸æ˜¯å‡½æ•°è°ƒç”¨æ—¶ï¼Œnext å’Œ step æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><p><strong><em>4ã€step out</em></strong>æŒ‰é’® ï¼Œå¦‚æœä½ æ›¾ç»ä¸å°å¿ƒè·³è¿›ä¸€ä¸ªå‡½æ•°ï¼Œä½†å®é™…ä¸Šä½ æƒ³è·³è¿‡å®ƒï¼Œå¸¸è§çš„ååº”æ˜¯é‡å¤çš„è¿è¡Œ n ç›´åˆ°å‡½æ•°è¿”å›ã€‚å…¶å®è¿™ç§æƒ…å†µï¼Œstep out æŒ‰é’®æ˜¯ä½ çš„æ•‘ä¸–ä¸»ã€‚å®ƒä¼šç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿”å›è¯­å¥ (ç›´åˆ°ä¸€ä¸ªå †æ ˆå¸§ç»“æŸ) ç„¶åå†æ¬¡åœæ­¢ã€‚<br>åœ¨LLDBä¸­ä½¿ç”¨ <code>thread step-out</code>ï¼Œ</p><p><strong><em>thread return</em></strong> ä½¿ç”¨<code>help thread</code>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¯”è¾ƒå®ç”¨çš„å‡½æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œåœ¨æ‰§è¡Œæ—¶å®ƒä¼šæŠŠå¯é€‰å‚æ•°åŠ è½½è¿›è¿”å›å¯„å­˜å™¨é‡Œï¼Œç„¶åç«‹åˆ»æ‰§è¡Œè¿”å›å‘½ä»¤ï¼Œè·³å‡ºå½“å‰æ ˆå¸§ã€‚è¿™æ„å‘³è¿™å‡½æ•°å‰©ä½™çš„éƒ¨åˆ†ä¸ä¼šè¢«æ‰§è¡Œã€‚è¿™ä¼šç»™ ARC çš„å¼•ç”¨è®¡æ•°é€ æˆä¸€äº›é—®é¢˜ï¼Œæˆ–è€…ä¼šä½¿å‡½æ•°å†…çš„æ¸…ç†éƒ¨åˆ†å¤±æ•ˆã€‚ä½†æ˜¯åœ¨å‡½æ•°çš„å¼€å¤´æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œæ˜¯ä¸ªéå¸¸å¥½çš„éš”ç¦»è¿™ä¸ªå‡½æ•°ï¼Œä¼ªé€ è¿”å›å€¼çš„æ–¹å¼ ã€‚</p><h2 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h2><p>Xcodeåœ¨æ–­ç‚¹å¯¼èˆªä¸­æä¾›äº†ä¸€ç³»åˆ—å·¥å…·åˆ›å»ºå’Œç®¡ç†æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹LLDBä¸­ç­‰ä»·çš„å‘½ä»¤,ä¸»è¦æ˜¯<code>breakpoint</code>å‘½ä»¤ã€‚</p><p><strong><em>1ã€æŸ¥çœ‹ å¯ç”¨/ç¦ç”¨</em></strong></p><p><img src="/res/LLDB/6.png" alt></p><p>ä¸Šå›¾æ˜¯xcodeæŸ¥çœ‹æ–­ç‚¹çš„åœ°æ–¹ï¼Œç‚¹å‡»æ–­ç‚¹ä¼šå¼€å¯æˆ–å…³é—­æ–­ç‚¹ã€‚å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æŸ¥çœ‹æ–­ç‚¹ å‘½ä»¤è¾“å‡ºåˆ—è¡¨æ˜¾ç¤ºæ¯ä¸ªé€»è¾‘æ–­ç‚¹éƒ½æœ‰ä¸€ä¸ªæ•´æ•°æ ‡è¯†</span></span><br><span class="line"><span class="comment">//è¾“å‡ºåˆ—è¡¨ä¸­å¦ä¸€ä¸ªä¿¡æ¯æ˜¯æ–­ç‚¹ä½ç½®æ˜¯å¦æ˜¯å·²è§£æçš„(resolved)ã€‚è¿™ä¸ªæ ‡è¯†è¡¨ç¤ºå½“ä¸ä¹‹ç›¸å…³çš„æ–‡ä»¶åœ°å€è¢«åŠ è½½åˆ°ç¨‹åºè¿›è¡Œè°ƒè¯•æ—¶ï¼Œå…¶ä½ç½®æ˜¯å·²è§£æçš„ã€‚</span></span><br><span class="line">  <span class="comment">//ä¾‹å¦‚ï¼Œå¦‚æœåœ¨å…±äº«åº“ä¸­è®¾ç½®çš„æ–­ç‚¹ä¹‹åè¢«å¸è½½äº†ï¼Œåˆ™æ–­ç‚¹çš„ä½ç½®è¿˜ä¼šä¿ç•™ï¼Œä½†å…¶ä¸èƒ½å†è¢«è§£æã€‚</span></span><br><span class="line">(lldb) breakpoint list</span><br><span class="line">Current breakpoints:</span><br><span class="line">1: file = '/Users/suntongsheng/Desktop/tmp/asdasd/asdasd/main.m', line = 23, exact_match = 0, locations = 1, resolved = 1, hit count = 1</span><br><span class="line"></span><br><span class="line">  <span class="number">1.1</span>: where = asdasd`main + <span class="number">51</span> at main.m:<span class="number">23</span>, address = <span class="number">0x00000001070195d3</span>, resolved, hit count = <span class="number">1</span> </span><br><span class="line"><span class="comment">//ç¦ç”¨æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint disable <span class="number">1</span></span><br><span class="line"><span class="number">1</span> breakpoints disabled.</span><br><span class="line"><span class="comment">//å¯ç”¨æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint enable <span class="number">1</span></span><br><span class="line"><span class="number">1</span> breakpoints enabled.</span><br></pre></td></tr></table></figure><p><strong><em>2ã€ åˆ›å»º/åˆ é™¤</em></strong></p><p>åœ¨Xcodeåˆ›å»ºæ–­ç‚¹çš„æ–¹å¼ä¸€ç§æ˜¯ ç›´æ¥åœ¨ä»£ç å·¦è¾¹çš„è¡Œæ•°å‡ºç‚¹å‡» å³å¯åˆ›å»ºæ–­ç‚¹ã€‚å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨main.mçš„ç¬¬24è¡Œåˆ›å»ºæ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint set -f main.m -l <span class="number">24</span></span><br><span class="line">Breakpoint <span class="number">3</span>: where = asdasd`main + <span class="number">59</span> at main.m:<span class="number">24</span>, address = <span class="number">0x00000001070195db</span></span><br><span class="line"><span class="comment">//åˆ é™¤åˆšæ‰çš„æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint delete <span class="number">3</span></span><br><span class="line"><span class="number">1</span> breakpoints deleted; <span class="number">0</span> breakpoint locations disabled.</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç§æ˜¯åœ¨æ–­ç‚¹å¯¼èˆªï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„åŠ å·æŒ‰é’®ï¼Œé€‰æ‹©Symbolic BreakPointä¼šå‡ºç°ï¼š</p><p><img src="/res/LLDB/7.png" alt></p><p>å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨ä¸€ä¸ªç¬¦å· (C è¯­è¨€å‡½æ•°) ä¸Šåˆ›å»ºæ–­ç‚¹ï¼Œè€Œå®Œå…¨ä¸ç”¨æŒ‡å®šå“ªä¸€è¡Œ</span></span><br><span class="line">(lldb) breakpoint set  -F isEven</span><br><span class="line">Breakpoint <span class="number">6</span>: where = asdasd`isEven + <span class="number">16</span> at main.m:<span class="number">13</span>, address = <span class="number">0x0000000107019750</span></span><br><span class="line"><span class="comment">//Objective-C çš„æ–¹æ³•ä¹Ÿå®Œå…¨å¯ä»¥</span></span><br><span class="line">(lldb) breakpoint set -F <span class="string">"-[NSArray objectAtIndex:]"</span></span><br><span class="line">Breakpoint <span class="number">5</span>: where = CoreFoundation`-[<span class="built_in">NSArray</span> objectAtIndex:], address = <span class="number">0x000000010ac7a950</span></span><br></pre></td></tr></table></figure><p>åœ¨ <code>[NSArray objectAtIndex:]</code>è¿™ä¸ªæ–­ç‚¹ä¸Šï¼Œæˆ‘ä»¬æ€ä¹ˆèƒ½çŸ¥é“è®¾ç½®äº†ä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç”¨$arg1ã€$arg2ç­‰å‘½ä»¤æ¥æ‰“å°å‡ºæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚<br>åœ¨è¿™é‡Œ$arg1æ˜¯æŒ‡å¯¹è±¡æœ¬èº«ï¼Œ$arg2æ˜¯å¯¹è±¡è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œpoå‘½ä»¤æ— æ³•ç›´æ¥è¾“å‡ºå‡½æ•°åï¼Œéœ€è¦åŠ ä¸Š(SEL)ï¼Œ$arg3æ˜¯è¢«èµ‹ç»™å‡½æ•°çš„å‚æ•°ã€‚</p><p><strong><em>3ã€ æ–­ç‚¹è¡Œä¸º</em></strong></p><p>åœ¨Xcodeä¸­é‚®ä»¶æ–­ç‚¹å¯ä»¥ç¼–è¾‘æ·»åŠ actionä¿¡æ¯ï¼Œä½ å¯ä»¥æ·»åŠ å¤šä¸ªè¡Œä¸ºï¼š</p><p><img src="/res/LLDB/8.png" alt></p><p>å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint set -f main.m -l <span class="number">31</span></span><br><span class="line">Breakpoint <span class="number">2</span>: where = asdasd`main + <span class="number">205</span> at main.m:<span class="number">31</span>, address = <span class="number">0x000000010ab2166d</span></span><br><span class="line"><span class="comment">//æ·»åŠ æ¡ä»¶</span></span><br><span class="line">(lldb) breakpoint modify -c 'i == 80' 2</span><br><span class="line"><span class="comment">//æ·»åŠ è¡Œä¸º</span></span><br><span class="line">(lldb) breakpoint command add <span class="number">2</span></span><br><span class="line">Enter your debugger command(s).  Type 'DONE' to end.</span><br><span class="line">&gt; po i</span><br><span class="line">&gt; DONE</span><br><span class="line"><span class="comment">//æ˜¾ç¤ºåˆšæ‰çš„æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint list <span class="number">2</span></span><br><span class="line">2: file = 'main.m', line = 31, exact_match = 0, locations = 1, resolved = 1, hit count = 0</span><br><span class="line">    Breakpoint commands:</span><br><span class="line">      po i</span><br><span class="line"></span><br><span class="line">Condition: i == <span class="number">80</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2.1</span>: where = asdasd`main + <span class="number">205</span> at main.m:<span class="number">31</span>, address = <span class="number">0x000000010ab2166d</span>, resolved, hit count = <span class="number">0</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œæ–­ç‚¹åè‡ªåŠ¨ç»§ç»­è¿è¡Œï¼Œå…è®¸ä½ å®Œå…¨é€šè¿‡æ–­ç‚¹æ¥ä¿®æ”¹ç¨‹åºï¼ä½ å¯ä»¥åœ¨æŸä¸€è¡Œåœæ­¢ï¼Œè¿è¡Œä¸€ä¸ª expression å‘½ä»¤æ¥æ”¹å˜å˜é‡ï¼Œç„¶åç»§ç»­è¿è¡Œã€‚</p><h2 id="æŸ¥çœ‹-çº¿ç¨‹-è°ƒç”¨æ ˆ-çŠ¶æ€"><a href="#æŸ¥çœ‹-çº¿ç¨‹-è°ƒç”¨æ ˆ-çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹ çº¿ç¨‹/è°ƒç”¨æ ˆ çŠ¶æ€"></a>æŸ¥çœ‹ çº¿ç¨‹/è°ƒç”¨æ ˆ çŠ¶æ€</h2><p>åœ¨è¿›ç¨‹åœæ­¢åï¼ŒLLDBä¼šé€‰æ‹©ä¸€ä¸ªå½“å‰çº¿ç¨‹å’Œçº¿ç¨‹ä¸­å½“å‰å¸§(frame)ã€‚å¾ˆå¤šæ£€æµ‹çŠ¶æ€çš„å‘½ä»¤å¯ä»¥ç”¨äºè¿™ä¸ªçº¿ç¨‹æˆ–å¸§ã€‚</p><p>ä¸ºäº†æ£€æµ‹è¿›ç¨‹çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‘½ä»¤<code>thread list</code>å¼€å§‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) thread list</span><br><span class="line">Process <span class="number">48541</span> stopped</span><br><span class="line">* thread <span class="meta">#1: tid = 0x3bd1d2, 0x000000010eae0b66 libsystem_kernel.dylib`__pthread_kill + 10, queue = 'com.apple.main-thread', stop reason = signal SIGABRT</span></span><br><span class="line">  thread <span class="meta">#2: tid = 0x3bd24c, 0x000000010eae128a libsystem_kernel.dylib`__workq_kernreturn + 10</span></span><br></pre></td></tr></table></figure><p>æ˜Ÿå·(*)è¡¨ç¤ºthread #1ä¸ºå½“å‰çº¿ç¨‹ã€‚ä¸ºäº†è·å–çº¿ç¨‹çš„è·Ÿè¸ªæ ˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤<code>thread backtrace</code>ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤ä¸ºå½“å‰çº¿ç¨‹ ä¹Ÿå¯ä»¥æŒ‡å®šçº¿ç¨‹ : thread backtrace 2</span></span><br><span class="line">(lldb) thread backtrace</span><br><span class="line">thread <span class="meta">#1: tid = 0x2c03, stop reason = breakpoint 1.1, queue = com.apple.main-thread</span></span><br><span class="line"> frame <span class="meta">#0: 0x0000000100010d5b, where = Sketch`-[SKTGraphicView alignLeftEdges:] + 33 at /Projects/Sketch/SKTGraphicView.m:1405</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š<code>(lldb) thread backtrace all</code></p><p>æ£€æŸ¥å¸§å‚æ•°å’Œæœ¬åœ°å˜é‡çš„æœ€ç®€ä¾¿çš„æ–¹å¼æ˜¯ä½¿ç”¨<code>frame variable</code>å‘½ä»¤ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">int</span>) argc = <span class="number">1</span></span><br><span class="line">(<span class="keyword">char</span> **) argv = <span class="number">0x00007ffee4150ff0</span></span><br><span class="line">(<span class="built_in">NSUInteger</span>) num = <span class="number">123</span></span><br><span class="line">(__NSCFConstantString *) str = <span class="number">0x000000010bab00d8</span> <span class="string">@"learning LLDB"</span></span><br><span class="line">(__NSArrayI *) arr = <span class="number">0x0000600002982fa0</span> <span class="string">@"2 elements"</span></span><br><span class="line">(<span class="keyword">int</span>) i = <span class="number">80</span></span><br><span class="line">(<span class="built_in">BOOL</span>) result0 = <span class="literal">YES</span></span><br><span class="line">(<span class="built_in">BOOL</span>) result1 = <span class="literal">NO</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰æŒ‡å®šä»»ä½•å˜é‡åï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰å‚æ•°å’Œæœ¬åœ°å˜é‡ã€‚å¦‚æœæŒ‡å®šå‚æ•°åæˆ–å˜é‡åï¼Œåˆ™åªæ‰“å°æŒ‡å®šçš„å€¼ã€‚å¦‚ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) frame variable <span class="keyword">self</span></span><br><span class="line">(<span class="built_in">SKTGraphicView</span> *) <span class="keyword">self</span> = <span class="number">0x0000000100208b40</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³æŸ¥çœ‹å¦å¤–ä¸€å¸§ï¼Œå¯ä»¥ä½¿ç”¨<code>frame select</code>å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) frame select <span class="number">2</span></span><br><span class="line">frame <span class="meta">#2: 0x000000010e88dc45 libsystem_c.dylib`abort + 127</span></span><br></pre></td></tr></table></figure><h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><p>imageæŒ‡ä»¤æ˜¯target moduleæŒ‡ä»¤çš„ç¼©å†™ï¼Œå€ŸåŠ©å®ƒæˆ‘ä»¬èƒ½å¤ŸæŸ¥çœ‹å½“å‰çš„Binary Imagesç›¸å…³çš„ä¿¡æ¯ã€‚æ—¥å¸¸å¼€å‘æˆ‘ä»¬ä¸»è¦åˆ©ç”¨å®ƒå¯»å€ã€‚<code>image</code>å‘½ä»¤çš„ç”¨æ³•ä¹ŸæŒºå¤šï¼Œé¦–å…ˆå¯ä»¥ç”¨å®ƒæ¥æŸ¥çœ‹å·¥ç¨‹ä¸­ä½¿ç”¨çš„åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list</span><br><span class="line">[  <span class="number">0</span>] <span class="number">9E11</span>F0C7<span class="number">-9</span>AB1<span class="number">-36</span>A8<span class="number">-8</span>FE4<span class="number">-8821</span>DBA05A2F <span class="number">0x000000010baad000</span> /Users/suntongsheng/Library/Developer/Xcode/DerivedData/asdasd-dufvhftdhjomdkcnrilgxlwykarv/Build/Products/Debug-iphonesimulator/asdasd.app/asdasd </span><br><span class="line">[  <span class="number">1</span>] <span class="number">8</span>A72DE9C-A136<span class="number">-3506</span>-AA02<span class="number">-4</span>BA2B82DCAF3 <span class="number">0x0000000115aa8000</span> /usr/lib/dyld</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“çš„åŸå§‹åœ°å€ï¼Œè¿™ä¸€ç‚¹è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå½“æˆ‘ä»¬çš„ç¨‹åºå´©æºƒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æ¥æŸ¥æ‰¾å´©æºƒæ‰€åœ¨çš„å…·ä½“ä½ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *array = @[@<span class="number">1</span>, @<span class="number">2</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"array 3: %@"</span>, array[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">//è¿™æ®µä»£ç ä¼šæŠ›å‡º</span></span><br><span class="line">2019-03-19 16:10:32.841204+0800 asdasd[49351:4010863] *** Terminating app due to uncaught exception 'NSRangeException', reason: '*** -[__NSArrayI objectAtIndexedSubscript:]: index 2 beyond bounds [0 .. 1]'</span><br><span class="line">*** First throw call stack:</span><br><span class="line">(</span><br><span class="line"><span class="number">0</span>   CoreFoundation                      <span class="number">0x0000000102c7f1bb</span> __exceptionPreprocess + <span class="number">331</span></span><br><span class="line"><span class="number">1</span>   libobjc.A.dylib                     <span class="number">0x000000010221d735</span> objc_exception_throw + <span class="number">48</span></span><br><span class="line"><span class="number">2</span>   CoreFoundation                      <span class="number">0x0000000102bcb4ec</span> _CFThrowFormattedException + <span class="number">194</span></span><br><span class="line"><span class="number">3</span>   CoreFoundation                      <span class="number">0x0000000102d01b00</span> +[__NSArrayI allocWithZone:] + <span class="number">0</span></span><br><span class="line"><span class="number">4</span>   asdasd                              <span class="number">0x00000001019004ff</span> -[ViewController viewDidLoad] + <span class="number">287</span></span><br></pre></td></tr></table></figure><p>æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å´©æºƒä½ç½®æ˜¯åœ¨ViewControllerä¸­ï¼Œè¦æƒ³çŸ¥é“å…·ä½“åœ¨å“ªä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤<code>image lookup --address</code>ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup --address <span class="number">0x00000001019004ff</span></span><br><span class="line">      Address: asdasd[<span class="number">0x00000001000014ff</span>] (asdasd.__TEXT.__text + <span class="number">287</span>)</span><br><span class="line">      Summary: asdasd`-[ViewController viewDidLoad] + <span class="number">287</span> at ViewController.m:<span class="number">23</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åå®šä½åˆ°äº†ViewController.m:23è¡Œï¼Œæ­£æ˜¯æˆ‘ä»¬ä»£ç æ‰€åœ¨çš„ä½ç½®ã€‚</p><p>imageæ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒï¼š <a href="https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/lldb-command-examples.html#//apple_ref/doc/uid/TP40012917-CH3-SW5" target="_blank" rel="noopener">Executable and Shared Library Query Commandsã€‚</a></p><!-- http://southpeak.github.io/2015/01/25/tool-lldb/ --><!-- https://juejin.im/post/5b1cd870e51d4506dc0ac76c --><!-- https://www.jianshu.com/p/67f08a4d8cf2 -->]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä½ æ˜¯å¦æ›¾ç»è‹¦æ¼äºç†è§£é¡¹ç›®çš„ä»£ç ï¼Œè€Œå»å°è¯•æ‰“å°ä¸€ä¸ªå˜é‡çš„å€¼ï¼Ÿç„¶åä½¿ç”¨NSLog å¹¶ä¸”æ¯æ¬¡å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œä»å¤´å¼€å§‹ï¼Ÿä½†æ˜¯ä¸ä¸€å®šè¦è¿™ä¹ˆåšã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒè¯•å™¨ã€‚è€Œä¸”å³ä½¿ä½ å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨è°ƒè¯•å™¨æ£€æŸ¥å˜é‡ï¼Œå®ƒå¯ä»¥åšçš„è¿˜æœ‰å¾ˆå¤šã€‚&lt;/p&gt;
&lt;h2 id=&quot;LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;a href=&quot;#LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;LLDB æ˜¯ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;/a&gt;LLDB æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;http://lldb.llvm.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;LLDB&lt;/a&gt;æ˜¯Mac OS Xä¸ŠXcodeçš„é»˜è®¤è°ƒè¯•å™¨ï¼Œæ”¯æŒå†æ¡Œé¢å’ŒiOSè®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨ä¸Šè°ƒè¯•C ï¼ŒObjective-Cå’ŒC++ã€‚å®ƒæ˜¯æ–°ä¸€ä»£é«˜æ€§èƒ½è°ƒè¯•å™¨ï¼Œå®ƒå¯ä»¥é«˜æ•ˆåˆ©ç”¨LLVMé¡¹ç›®ä¸­çš„ç°æœ‰åº“ï¼Œä¾‹å¦‚Clangè¡¨è¾¾å¼è§£æå™¨å’ŒLLVMåæ±‡ç¼–ç¨‹åºã€‚&lt;/p&gt;
&lt;p&gt;éšç€Xcode 5çš„å‘å¸ƒï¼ŒLLDBè°ƒè¯•å™¨å·²ç»å–ä»£äº†GDBï¼Œæˆä¸ºäº†Xcodeå·¥ç¨‹ä¸­é»˜è®¤çš„è°ƒè¯•å™¨ã€‚å®ƒä¸LLVMç¼–è¯‘å™¨ä¸€èµ·ï¼Œå¸¦ç»™æˆ‘ä»¬æ›´ä¸°å¯Œçš„æµç¨‹æ§åˆ¶å’Œæ•°æ®æ£€æµ‹çš„è°ƒè¯•åŠŸèƒ½ã€‚LLDBä¸ºXcodeæä¾›äº†åº•å±‚è°ƒè¯•ç¯å¢ƒï¼Œå…¶ä¸­åŒ…æ‹¬å†…åµŒåœ¨Xcode IDEä¸­çš„ä½äºè°ƒè¯•åŒºåŸŸçš„æ§åˆ¶é¢æ¿ã€‚&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/facebook/chisel&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Chisel&lt;/a&gt; æ˜¯facebookä¸‹ä¸€ä¸ªå¼€æºLLDBå‘½ä»¤é›†åˆã€‚&lt;/p&gt;
&lt;p&gt;ä¸æ­¤åŒæ—¶ï¼Œè®©æˆ‘ä»¬ä»¥åœ¨è°ƒè¯•å™¨ä¸­æ‰“å°å˜é‡æ¥å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹å§ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
      <category term="LLDB" scheme="https://developerdoc.com/tags/LLDB/"/>
    
  </entry>
  
  <entry>
    <title>iOSç›´æ’­æ•™ç¨‹</title>
    <link href="https://developerdoc.com/quick-start/iOS%E7%9B%B4%E6%92%AD%E6%95%99%E7%A8%8B/"/>
    <id>https://developerdoc.com/quick-start/iOSç›´æ’­æ•™ç¨‹/</id>
    <published>2019-03-07T07:09:58.000Z</published>
    <updated>2019-03-07T08:06:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç›´æ’­åŸç†"><a href="#ç›´æ’­åŸç†" class="headerlink" title="ç›´æ’­åŸç†"></a>ç›´æ’­åŸç†</h2><p>ä¸€ä¸ªç®€å•çš„ç›´æ’­æµç¨‹æ˜¯: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app        -&gt; è§†é¢‘é‡‡é›†   -&gt;  ç¼–ç     -&gt; æ¨æµ     -&gt; æœåŠ¡å™¨</span><br><span class="line">æœåŠ¡å™¨      -&gt; æ‹‰æµ      -&gt;  è§£ç     -&gt; æ’­æ”¾     -&gt; app</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹æ¯”è¾ƒå¤š:</p><p><img src="/res/live/ç›´æ’­æŠ€æœ¯ç‚¹.png" alt></p><a id="more"></a><h3 id="æµåª’ä½“ä¼ è¾“åè®®"><a href="#æµåª’ä½“ä¼ è¾“åè®®" class="headerlink" title="æµåª’ä½“ä¼ è¾“åè®®"></a>æµåª’ä½“ä¼ è¾“åè®®</h3><h4 id="RTMP"><a href="#RTMP" class="headerlink" title="RTMP"></a>RTMP</h4><ul><li>RTMP:å®æ—¶æ¶ˆæ¯ä¼ è¾“åè®®,Adobe Systemså…¬å¸ä¸ºFlashæ’­æ”¾å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´éŸ³é¢‘ã€è§†é¢‘å’Œæ•°æ®ä¼ è¾“å¼€å‘çš„å¼€æ”¾åè®®ï¼Œå› ä¸ºæ˜¯å¼€æ”¾åè®®æ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨äº†ã€‚<ul><li>RTMPåè®®ç”¨äºå¯¹è±¡ã€è§†é¢‘ã€éŸ³é¢‘çš„ä¼ è¾“ã€‚<ul><li>è¿™ä¸ªåè®®å»ºç«‹åœ¨TCPåè®®æˆ–è€…è½®è¯¢HTTPåè®®ä¹‹ä¸Šã€‚</li><li>RTMPåè®®å°±åƒä¸€ä¸ªç”¨æ¥è£…æ•°æ®åŒ…çš„å®¹å™¨ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯FLVä¸­çš„è§†éŸ³é¢‘æ•°æ®ã€‚ä¸€ä¸ªå•ä¸€çš„è¿æ¥å¯ä»¥é€šè¿‡ä¸åŒçš„é€šé“ä¼ è¾“å¤šè·¯ç½‘ç»œæµï¼Œè¿™äº›é€šé“ä¸­çš„åŒ…éƒ½æ˜¯æŒ‰ç…§å›ºå®šå¤§å°çš„åŒ…ä¼ è¾“çš„</li></ul></li></ul></li></ul><h4 id="HLS-HTTP-Live-Streaming"><a href="#HLS-HTTP-Live-Streaming" class="headerlink" title="HLS (HTTP Live Streaming)"></a>HLS (HTTP Live Streaming)</h4><p>HTTP Live Streamingï¼ˆHLSï¼‰æ˜¯è‹¹æœå…¬å¸(Apple Inc.)å®ç°çš„åŸºäºHTTPçš„æµåª’ä½“ä¼ è¾“åè®®ï¼Œå¯å®ç°æµåª’ä½“çš„ç›´æ’­å’Œç‚¹æ’­ï¼Œä¸»è¦åº”ç”¨åœ¨iOSç³»ç»Ÿï¼Œä¸ºiOSè®¾å¤‡ï¼ˆå¦‚iPhoneã€iPadï¼‰æä¾›éŸ³è§†é¢‘ç›´æ’­å’Œç‚¹æ’­æ–¹æ¡ˆã€‚HLSç‚¹æ’­ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å¸¸è§çš„åˆ†æ®µHTTPç‚¹æ’­ï¼Œä¸åŒåœ¨äºï¼Œå®ƒçš„åˆ†æ®µéå¸¸å°ã€‚</p><p>ç›¸å¯¹äºå¸¸è§çš„æµåª’ä½“ç›´æ’­åè®®ï¼Œä¾‹å¦‚RTMPåè®®ç­‰ï¼ŒHLSç›´æ’­æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œç›´æ’­å®¢æˆ·ç«¯è·å–åˆ°çš„ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®æµã€‚HLSåè®®åœ¨æœåŠ¡å™¨ç«¯å°†ç›´æ’­æ•°æ®æµå­˜å‚¨ä¸ºè¿ç»­çš„ã€å¾ˆçŸ­æ—¶é•¿çš„åª’ä½“æ–‡ä»¶ï¼ˆMPEG-TSæ ¼å¼ï¼‰ï¼Œè€Œå®¢æˆ·ç«¯åˆ™ä¸æ–­çš„ä¸‹è½½å¹¶æ’­æ”¾è¿™äº›å°æ–‡ä»¶ï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯æ€»æ˜¯ä¼šå°†æœ€æ–°çš„ç›´æ’­æ•°æ®ç”Ÿæˆæ–°çš„å°æ–‡ä»¶ï¼Œè¿™æ ·å®¢æˆ·ç«¯åªè¦ä¸åœçš„æŒ‰é¡ºåºæ’­æ”¾ä»æœåŠ¡å™¨è·å–åˆ°çš„æ–‡ä»¶ï¼Œå°±å®ç°äº†ç›´æ’­ã€‚ç”±æ­¤å¯è§ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºï¼ŒHLSæ˜¯ä»¥ç‚¹æ’­çš„æŠ€æœ¯æ–¹å¼æ¥å®ç°ç›´æ’­ã€‚ç”±äºæ•°æ®é€šè¿‡HTTPåè®®ä¼ è¾“ï¼Œæ‰€ä»¥å®Œå…¨ä¸ç”¨è€ƒè™‘é˜²ç«å¢™æˆ–è€…ä»£ç†çš„é—®é¢˜ï¼Œè€Œä¸”åˆ†æ®µæ–‡ä»¶çš„æ—¶é•¿å¾ˆçŸ­ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¾ˆå¿«çš„é€‰æ‹©å’Œåˆ‡æ¢ç ç‡ï¼Œä»¥é€‚åº”ä¸åŒå¸¦å®½æ¡ä»¶ä¸‹çš„æ’­æ”¾ã€‚ä¸è¿‡HLSçš„è¿™ç§æŠ€æœ¯ç‰¹ç‚¹ï¼Œå†³å®šäº†å®ƒçš„å»¶è¿Ÿä¸€èˆ¬æ€»æ˜¯ä¼šé«˜äºæ™®é€šçš„æµåª’ä½“ç›´æ’­åè®®ã€‚</p><p>m3u8ï¼Œæ˜¯HTTP Live Streamingç›´æ’­çš„ç´¢å¼•æ–‡ä»¶ã€‚</p><ul><li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StreamingMediaGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008332-CH1-SW1" target="_blank" rel="noopener">Apple: HTTP Live Streaming Overview </a></li><li><a href="https://developer.apple.com/streaming/" target="_blank" rel="noopener">Apple: HTTP Live Streaming(HLS) Overview</a></li></ul><h2 id="ç›´æ’­iOSå®æˆ˜"><a href="#ç›´æ’­iOSå®æˆ˜" class="headerlink" title="ç›´æ’­iOSå®æˆ˜"></a>ç›´æ’­iOSå®æˆ˜</h2><h3 id="æœåŠ¡ç«¯é…ç½®"><a href="#æœåŠ¡ç«¯é…ç½®" class="headerlink" title="æœåŠ¡ç«¯é…ç½®"></a>æœåŠ¡ç«¯é…ç½®</h3><h4 id="å®‰è£…-nginx"><a href="#å®‰è£…-nginx" class="headerlink" title="å®‰è£… nginx"></a>å®‰è£… nginx</h4><blockquote><p>ä½¿ç”¨HomeBrew å®‰è£… nginx<br>æ²¡å®‰è£…è¿‡HomwBrewçš„ çœ‹ä¸€ä¸‹ <a href="https://brew.sh/" target="_blank" rel="noopener">HomeBrewä¸»é¡µ</a> å®‰è£…ä¸€ä¸‹</p></blockquote><p><strong>ä¸€ï¼š</strong> <em>å¢åŠ home-brewå¯¹nginxçš„æ‰©å±•</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap homebrew/nginx</span><br></pre></td></tr></table></figure><p><strong>äºŒï¼š</strong> <em>å®‰è£…NginxæœåŠ¡å™¨å’Œrtmpæ¨¡å—</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install nginx-full --with-rtmp-module</span><br></pre></td></tr></table></figure><p><strong>ä¸‰ï¼š</strong> <em>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew info nginx-full</span><br></pre></td></tr></table></figure><p><img src="/res/live/brewInfoNginx.png" alt>    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/etc/nginx/nginx.conf ï¼ˆé…ç½®æ–‡ä»¶è·¯å¾„ï¼‰</span><br><span class="line">/usr/local/var/www ï¼ˆæœåŠ¡å™¨é»˜è®¤è·¯å¾„ï¼‰</span><br><span class="line">/usr/local/Cellar/ ï¼ˆå®‰è£…è·¯å¾„ï¼‰</span><br><span class="line">open -t /usr/local/etc/nginx/nginx.conf å¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€é…ç½®æ–‡ä»¶</span><br><span class="line">nginx -s reload é‡æ–°åŠ è½½é…ç½®</span><br><span class="line">nginx -s reopen é‡æ–°æ‰“å¼€log</span><br><span class="line">nginx -s stop åœæ­¢nginx</span><br><span class="line">nginx -s quit é€€å‡ºnginx</span><br></pre></td></tr></table></figure><p><strong>å››ï¼š</strong> <em>å¯åŠ¨nginx</em></p><p>è¾“å…¥ å¼€å¯æœåŠ¡å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨ä¸­ è¾“å…¥ <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a><br>å¦‚æœå‡ºç°ä¸‹å›¾, åˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸ:</p><p><img src="/res/live/welcomeNginx.png" alt></p><h4 id="é…ç½®-nginx"><a href="#é…ç½®-nginx" class="headerlink" title="é…ç½® nginx"></a>é…ç½® nginx</h4><p><strong>ä¸€ï¼š</strong> <em>é…ç½®Nginxï¼Œæ”¯æŒhttpåè®®æ‹‰æµ</em></p><p>åœ¨ç»ˆç«¯è¾“å…¥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open -t  /usr/local/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><p>æ‰“å¼€nginxé…ç½®æ–‡ä»¶,åœ¨httpå±æ€§ä¸‹æ‰¾åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸‹é¢æ·»åŠ ï¼Œæˆä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">root   html;</span><br><span class="line">index  index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /hls &#123; </span><br><span class="line">#æ”¯æŒhttpåè®®æ‹‰æµ</span><br><span class="line">types &#123; </span><br><span class="line">application/vnd.apple.mpegurl m3u8; </span><br><span class="line">video/mp2t ts; </span><br><span class="line">&#125; </span><br><span class="line">root /usr/local/var/www; </span><br><span class="line">add_header Cache-Control no-cache; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>äºŒï¼š</strong> <em>é…ç½®Nginxï¼Œæ”¯æŒrtmpåè®®æ¨æµ</em></p><p>åœ¨ç»ˆç«¯è¾“å…¥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open -t  /usr/local/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure></p><p>æ‰“å¼€nginxé…ç½®æ–‡ä»¶, æ–‡ä»¶çš„æœ«å°¾(æœ€åä¸€ä¸ª â€œ}â€ ä¸‹ä¸€è¡Œ )æ·»åŠ ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1990;</span><br><span class="line">        </span><br><span class="line">        application hls&#123;</span><br><span class="line"></span><br><span class="line">          live on;</span><br><span class="line">          record off;</span><br><span class="line">          hls on;</span><br><span class="line">          hls_path /usr/local/var/www/hls;</span><br><span class="line">          hls_fragment 1s;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä¸‰ï¼š</strong> åº”ç”¨é…ç½®</p><p>é‡å¯ä¸‹nginxå°±è¡Œ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure><h4 id="ä½¿ç”¨-ffmepg-æµ‹è¯•æ¨æµ"><a href="#ä½¿ç”¨-ffmepg-æµ‹è¯•æ¨æµ" class="headerlink" title="ä½¿ç”¨ ffmepg æµ‹è¯•æ¨æµ"></a>ä½¿ç”¨ ffmepg æµ‹è¯•æ¨æµ</h4><h3 id="åœ¨iOSç«¯ä½¿ç”¨-LFLiveKit-æ¨æµ"><a href="#åœ¨iOSç«¯ä½¿ç”¨-LFLiveKit-æ¨æµ" class="headerlink" title="åœ¨iOSç«¯ä½¿ç”¨ LFLiveKit æ¨æµ"></a>åœ¨iOSç«¯ä½¿ç”¨ LFLiveKit æ¨æµ</h3><blockquote><p>LFLiveKitå®ƒå·²ç»å¸®æˆ‘ä»¬å®ç°äº†è§†é¢‘é‡‡é›†ã€åå°å½•åˆ¶ã€ç¾é¢œåŠŸèƒ½ã€æ”¯æŒh264ã€AACç¼–ç ï¼ŒåŠ¨æ€æ”¹å˜é€Ÿç‡ï¼ŒRTMPä¼ è¾“ç­‰<br><a href="https://github.com/LaiFengiOS/LFLiveKit" target="_blank" rel="noopener">LFLiveKitä¸»é¡µ</a></p></blockquote><h4 id="ä½¿ç”¨LFLiveKit-demo-æ¨æµ"><a href="#ä½¿ç”¨LFLiveKit-demo-æ¨æµ" class="headerlink" title="ä½¿ç”¨LFLiveKit demo æ¨æµ"></a>ä½¿ç”¨LFLiveKit demo æ¨æµ</h4><p>ä¸‹è½½æºä»£ç åï¼Œè¿›å…¥sample/LFLiveKitDemo ç›®å½•ï¼Œè¿è¡Œä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod install</span><br></pre></td></tr></table></figure></p><p>æ‰“å¼€LFLiveKitDemo.xcworkspace å·¥ç¨‹</p><p>å°†<strong>LFLivePreview.m</strong>æ–‡ä»¶çš„362è¡Œæ”¹ä¸ºï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stream.url = <span class="string">@"rtmp://10.45.33.96:1990/hls/abc"</span>;</span><br></pre></td></tr></table></figure><p>urlå¯¹åº”çš„æ˜¯ rtmp://[nginxæœåŠ¡å™¨åœ°å€] : [ç«¯å£] / [é…ç½®çš„åº”ç”¨] / éšä¾¿å†™</p><p>ç„¶åçœŸæœºè¿è¡Œæ•ˆæœå¦‚ä¸‹:</p><p><img src="/res/live/LFLiveKitPreview.png" width="50%"></p><h4 id="æµ‹è¯•LFLiveKit-demo-æ¨æµ"><a href="#æµ‹è¯•LFLiveKit-demo-æ¨æµ" class="headerlink" title="æµ‹è¯•LFLiveKit demo æ¨æµ"></a>æµ‹è¯•LFLiveKit demo æ¨æµ</h4><blockquote><p>ä¿è¯nginxæœåŠ¡å™¨æ˜¯å¼€å¯çŠ¶æ€<br>ç‚¹å‡»ä¸Šé¢demoä¸­çš„å¼€å§‹ç›´æ’­åï¼š</p></blockquote><p>åœ¨mac <strong>Safari</strong> æµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://localhost:8080/hls/abc.m3u8" target="_blank" rel="noopener">http://localhost:8080/hls/abc.m3u8</a> æŸ¥çœ‹æ•ˆæœï¼š</p><p><img src="/res/live/LFLiveKitTest.png" width="80%"></p><p>ç›¸å¯¹åº”çš„ï¼Œç›´æ¥ä½¿ç”¨iOSè‡ªå¸¦çš„AVPlayerå°±å¯ä»¥æ’­æ”¾è¯¥é“¾æ¥ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ç›´æ’­åŸç†&quot;&gt;&lt;a href=&quot;#ç›´æ’­åŸç†&quot; class=&quot;headerlink&quot; title=&quot;ç›´æ’­åŸç†&quot;&gt;&lt;/a&gt;ç›´æ’­åŸç†&lt;/h2&gt;&lt;p&gt;ä¸€ä¸ªç®€å•çš„ç›´æ’­æµç¨‹æ˜¯: &lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;app        -&amp;gt; è§†é¢‘é‡‡é›†   -&amp;gt;  ç¼–ç     -&amp;gt; æ¨æµ     -&amp;gt; æœåŠ¡å™¨&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;æœåŠ¡å™¨      -&amp;gt; æ‹‰æµ      -&amp;gt;  è§£ç     -&amp;gt; æ’­æ”¾     -&amp;gt; app&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;å…¶ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹æ¯”è¾ƒå¤š:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/res/live/ç›´æ’­æŠ€æœ¯ç‚¹.png&quot; alt&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="quick-start" scheme="https://developerdoc.com/categories/quick-start/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>GitHubç²¾é€‰åˆ†äº«ç¬¬å››æœŸ</title>
    <link href="https://developerdoc.com/weekly-share/GitHub%E7%B2%BE%E9%80%89%E5%88%86%E4%BA%AB%E7%AC%AC%E5%9B%9B%E6%9C%9F/"/>
    <id>https://developerdoc.com/weekly-share/GitHubç²¾é€‰åˆ†äº«ç¬¬å››æœŸ/</id>
    <published>2019-03-07T02:14:42.000Z</published>
    <updated>2019-03-07T04:35:56.000Z</updated>
    
    <content type="html"><![CDATA[<p>è®°å½•è¿™å‘¨çœ‹åˆ°å€¼å¾—åˆ†äº«çš„äº‹ï¼Œæœ¬æœŸå°±åˆ†äº«ç‚¹å›¾ç‰‡å‹ç¼©å·¥å…·ç±»å§~</p><p><img src="/res/weeklyshare/image-tool-stack.png" alt="image-tool-stack"></p><p>ä¸Šå›¾æ˜¯æˆ‘çš„å›¾ç‰‡å¤„ç†å·¥å…·æ ˆï¼ŒçŸ¢é‡åŸå‹ Sketchï¼Œä½å›¾ç¼–è¾‘ Pixelmatorï¼Œæœé›†ç®¡ç† Inboardï¼Œå‹ç¼©ä¼˜åŒ– JPEGminiã€ImageAlphaã€ImageOptimã€‚å‰å››ä¸ªæ˜¯ä»˜è´¹ Appï¼Œåä¸¤ä¸ªè‡ªç”±å¼€æºã€‚</p><p>æœ¬æ¬¡ä¸»è¦åˆ†äº«<strong>ImageOptim</strong> <strong>ImageAlpha</strong> <strong>ImageOptim-CLI</strong> å’Œ <strong>Squoosh</strong><br><a id="more"></a></p><h3 id="ImageOptim-JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨"><a href="#ImageOptim-JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨" class="headerlink" title="ImageOptim JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨"></a><a href="https://github.com/ImageOptim/ImageOptim" target="_blank" rel="noopener">ImageOptim JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨</a></h3><blockquote class="blockquote-center"><p><a href="https://imageoptim.com/mac" target="_blank" rel="noopener">ImageOptimä¸‹è½½é“¾æ¥</a><br>å¦‚æœä½ æ˜¯Mac OS Xç”µè„‘çš„ä½¿ç”¨è€…ï¼Œä¹Ÿå¯è¯•è¯•çœ‹å¦å¤–è¿™ä¸€å¥—å›¾ç‰‡å‡è‚¥ã€æœ€ä½³åŒ–å·¥å…·ImageOptimï¼Œå®ƒå¯ä»¥æ”¯æŒPNGï¼ŒJPEGè·ŸGIFç­‰æ ¼å¼çš„å›¾æ¡£ï¼Œé€šè¿‡å†…ç½®çš„PNGOUTã€AdvPNGã€Pngcrushã€OptiPNGã€JpegOptimã€jpegrescanã€jpegtranä¸Gifsicleç­‰å›¾ç‰‡æœ€ä½³åŒ–å·¥å…·ï¼Œå¸®æˆ‘ä»¬å…¨è‡ªåŠ¨å‹ç¼©ã€ç¼©å‡å›¾ç‰‡çš„å¤§å°ã€‚</p><p>ImageOptimçš„ä½¿ç”¨æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠå›¾ç‰‡æ‹‰åˆ°ImageOptimçª—å£ä¸­ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡Œæœ€ä½³åŒ–ï¼Œç„¶åå°±æ²¡äº†ã€‚</p></blockquote><h3 id="ImageAlpha-PNGå›¾ç‰‡æœ‰æŸå‹ç¼©"><a href="#ImageAlpha-PNGå›¾ç‰‡æœ‰æŸå‹ç¼©" class="headerlink" title="ImageAlpha PNGå›¾ç‰‡æœ‰æŸå‹ç¼©"></a><a href="https://pngmini.com/" target="_blank" rel="noopener">ImageAlpha PNGå›¾ç‰‡æœ‰æŸå‹ç¼©</a></h3><blockquote class="blockquote-center"><p><a href="https://pngmini.com/" target="_blank" rel="noopener">ImageAlpha ä¸‹è½½é“¾æ¥</a><br>é€šè¿‡åº”ç”¨æœ‰æŸå‹ç¼©å’Œè½¬æ¢ä¸ºæ›´é«˜æ•ˆçš„PNG8 + alphaæ ¼å¼ï¼ŒmageAlphaå¤§å¤§å‡å°‘äº†24ä½PNGæ–‡ä»¶çš„æ–‡ä»¶å¤§å°ï¼ˆåŒ…æ‹¬alphaé€æ˜åº¦ï¼‰ã€‚è¿™äº›å›¾åƒä¸iOSï¼Œæ‰€æœ‰æµè§ˆå™¨å…¼å®¹ï¼Œç”šè‡³åœ¨IE6ä¸­é™çº§ã€‚</p><p>é€šè¿‡ä½¿ç”¨æœ€æ–°çš„pngquantå’Œpngnq-s9ä»¥åŠAlphaé€šé“æ„ŸçŸ¥åå¤„ç†å™¨ï¼ŒImageAlphaå¯ä»¥åœ¨MacromediaAdobe Fireworksä¸­è·å¾—æ¯”ç±»ä¼¼åŠŸèƒ½æ›´å¥½çš„è´¨é‡ã€‚</p></blockquote><h3 id="ImageOptim-CLI-å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨"><a href="#ImageOptim-CLI-å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨" class="headerlink" title="ImageOptim-CLI å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨"></a><a href="https://github.com/JamieMason/ImageOptim-CLI" target="_blank" rel="noopener">ImageOptim-CLI å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨</a></h3><p>ä»Šå¤©å¤„ç†çš„å›¾ç‰‡è¾ƒå¤šï¼Œæƒ³èƒ½ä¸èƒ½æœ‰ä¸ªè‡ªåŠ¨å·¥ä½œæµæ¥è§£æ”¾åŒæ‰‹ã€‚ä¸€æœï¼Œæ°å·§æ‰¾åˆ°äº† <a href="https://github.com/JamieMason/ImageOptim-CLI" target="_blank" rel="noopener">JamieMason/ImageOptim-CLI</a> è¿™ä¸ª macOS é¡¹ç›®ã€‚ä¸€å¥è¯æè¿°å°±æ˜¯ï¼Œå®ƒä¼šæ ¹æ®ä½ çš„æŒ‡å®šï¼Œé€‰æ‹©æ€§è°ƒç”¨ JPEGminiã€ImageAlphaã€ImageOptim ç­‰å·¥å…·ï¼Œæ¥å¤„ç†å›¾ç‰‡å‹ç¼©é—®é¢˜ã€‚å¼€å§‹æ•²ä¸€è¡Œå‘½ä»¤ï¼Œä¸­é—´è¿‡ç¨‹å…¨è‡ªåŠ¨ã€‚</p><p>79% TypeScript + 21% AppleScriptï¼Œåˆ†å‘ä¸ºå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰€ä»¥ä¸ä¾èµ– Node.jsï¼Œå¹¶ä¸”æ”¯æŒ Homebrew å®‰è£…ã€‚</p><p>ä½¿ç”¨ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œç»ˆç«¯è¾“å…¥ imageoptim â€“help å³å¯å¾—åˆ°è¯´æ˜ï¼Œåªéœ€æ³¨æ„ä¸‰ä¸ªäº‹é¡¹ï¼šç¬¬ä¸€ã€ç»ˆç«¯è¦å–å¾— Accessibility æƒé™ï¼›ç¬¬äºŒã€è°ƒç”¨çš„ App è¦è‡ªå·±å¦å¤–ä¸‹è½½å®‰è£…ï¼›ç¬¬ä¸‰ã€é¡¾åæ€ä¹‰ï¼Œå®ƒé»˜è®¤è°ƒç”¨ ImageOptimï¼Œå¦‚æœä¸ç”¨ï¼Œå¯é€šè¿‡ â€“no-imageoptim å‚æ•° disable å®ƒã€‚</p><p>æ”¯æŒçš„è°ƒç”¨çš„ 3 ä¸ª App å¦‚ä¸‹ï¼ŒJPEGmini Lite å…è´¹ï¼Œæ ‡å‡†å’Œ Pro å‡éœ€ä»˜è´¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Supported Apps:</span><br><span class="line"></span><br><span class="line">  ImageAlpha: https://pngmini.com</span><br><span class="line">  ImageOptim: https://imageoptim.com</span><br><span class="line">  JPEGmini Lite: https://itunes.apple.com/us/app/jpegmini-lite/id525742250</span><br><span class="line">  JPEGmini Pro: https://itunes.apple.com/us/app/jpegmini-pro/id887163276</span><br><span class="line">  JPEGmini: https://itunes.apple.com/us/app/jpegmini/id498944723</span><br></pre></td></tr></table></figure><p>å¦‚éœ€ç»„åˆå…¶ä»–å·¥å…·ï¼Œæ·»åŠ å¯¹åº”å‚æ•°å³å¯ï¼Œæ¯”å¦‚æ·»åŠ  â€“jpegmini å‚æ•°è°ƒç”¨ JPEGminiï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Examples:</span><br><span class="line"></span><br><span class="line">  # Run ImageOptim.app over every image in current directory</span><br><span class="line">  imageoptim</span><br><span class="line"></span><br><span class="line">  # Run ImageAlpha.app and ImageOptim.app over every PNG in current directory</span><br><span class="line">  imageoptim --imagealpha &apos;**/*.png&apos;</span><br><span class="line"></span><br><span class="line">  # Run JPEGmini.app and ImageOptim.app over every JPG in current directory</span><br><span class="line">  imageoptim --jpegmini &apos;**/*.jpg&apos; &apos;**/*.jpeg&apos;</span><br><span class="line"></span><br><span class="line">  # Run JPEGmini.app over every JPG in current directory</span><br><span class="line">  imageoptim --jpegmini --no-imageoptim &apos;**/*.jpg&apos; &apos;**/*.jpeg&apos;</span><br><span class="line"></span><br><span class="line">  # Run ImageOptim.app over every image in a specific directory</span><br><span class="line">  imageoptim &apos;~/Desktop&apos;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œè¿™å‡ ä¸ªå·¥å…·æ˜¯å•å¹²è¿˜æ˜¯ç»„åˆå¥½å‘¢ï¼Œå“ªä¸ªæ­é…å‹ç¼©å’Œè´¨é‡æœ€åˆç†å‘¢ï¼Ÿé’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒImageOptim-CLI è´´å¿ƒåœ°ç»™å‡ºäº† GIFã€JPEGã€PNG å„ä¸ªæ ¼å¼å„ä¸ªå·¥å…·åŠç»„åˆçš„<a href="https://jamiemason.github.io/ImageOptim-CLI/comparison/all/photoshop/desc/" target="_blank" rel="noopener">å‹ç¼©æ•ˆæœå¯¹æ¯”</a></p><p><img src="/res/weeklyshare/imageoptim-cli-comparison.png" alt="imageoptim-cli-comparison"></p><p>å…ˆçœ‹ JPEG é¡¹ç›®ï¼Œæœä¸å…¶ç„¶ï¼ŒJPEGmini &amp; ImageOptim ç»„åˆå‡ æ— æ•Œæ‰‹ï¼Œåªåœ¨è“å¤©ç™½äº‘å’Œ bril äººåƒä¸Šè¾“ç»™äº† Krakenï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæˆç»©ä¸»è¦æ˜¯ JPEGmini çš„åŠŸåŠ³ã€‚</p><p>å†çœ‹ PNG é¡¹ç›®ï¼Œæ‚¬å¿µåªåœ¨ ImageOptim å•å¹²ä»¥åŠä¸ ImageOptim æ­é…ä¸¤ä¸ªæ–¹æ¡ˆä¹‹é—´ã€‚è€ƒè™‘åˆ° 24 ä½è‰²çš„å¤©é™…çº¿ã€é›€æ–‘è„¸ã€è“å¤©ç™½äº‘ç­‰å›¾ç‰‡ä¸Šï¼ŒImageOptim å•å¹²å¼±åŠ¿æ˜æ˜¾ï¼Œè¿˜æ˜¯å»ºè®®äºŒè€…æ— è„‘æ­é…ã€‚ImageAlphaåˆ™åˆæ˜¯æ˜æ˜¾ã€‚</p><p>ç»¼åˆä»¥ä¸Šä¸¤ä¸ªé¡¹ç›®æ¥çœ‹ï¼Œå¦‚æœèƒ½æ¥å—è¾ƒé«˜çš„å›¾ç‰‡è´¨é‡æŸè€—ï¼ˆæ³¨æ„è¡¨æ ¼ä¸­æ— åº•è‰²çš„çº¢å­—ï¼‰ï¼ŒKraken ä¹Ÿæ˜¯éå¸¸æœ‰ç«äº‰åŠ›çš„å•ä¸€ä¼˜åŒ–å·¥å…·ã€‚</p><h3 id="Squoosh-æ˜¯-Google-æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·"><a href="#Squoosh-æ˜¯-Google-æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·" class="headerlink" title="Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·"></a><a href="https://github.com/GoogleChromeLabs/squoosh" target="_blank" rel="noopener">Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·</a></h3><blockquote class="blockquote-center"><p><a href="https://squoosh.app/" target="_blank" rel="noopener">Squooshåœ¨çº¿é“¾æ¥</a><br>Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·ï¼Œæ”¯æŒ JPGã€PNG å’Œ WebP æ ¼å¼ï¼Œå¯è®©æ‚¨æ·±å…¥äº†è§£å„ç§å›¾åƒå‹ç¼©å™¨æä¾›çš„é«˜çº§é€‰é¡¹</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®°å½•è¿™å‘¨çœ‹åˆ°å€¼å¾—åˆ†äº«çš„äº‹ï¼Œæœ¬æœŸå°±åˆ†äº«ç‚¹å›¾ç‰‡å‹ç¼©å·¥å…·ç±»å§~&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/res/weeklyshare/image-tool-stack.png&quot; alt=&quot;image-tool-stack&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸Šå›¾æ˜¯æˆ‘çš„å›¾ç‰‡å¤„ç†å·¥å…·æ ˆï¼ŒçŸ¢é‡åŸå‹ Sketchï¼Œä½å›¾ç¼–è¾‘ Pixelmatorï¼Œæœé›†ç®¡ç† Inboardï¼Œå‹ç¼©ä¼˜åŒ– JPEGminiã€ImageAlphaã€ImageOptimã€‚å‰å››ä¸ªæ˜¯ä»˜è´¹ Appï¼Œåä¸¤ä¸ªè‡ªç”±å¼€æºã€‚&lt;/p&gt;
&lt;p&gt;æœ¬æ¬¡ä¸»è¦åˆ†äº«&lt;strong&gt;ImageOptim&lt;/strong&gt; &lt;strong&gt;ImageAlpha&lt;/strong&gt; &lt;strong&gt;ImageOptim-CLI&lt;/strong&gt; å’Œ &lt;strong&gt;Squoosh&lt;/strong&gt;&lt;br&gt;
    
    </summary>
    
      <category term="æ¯å‘¨åˆ†äº«" scheme="https://developerdoc.com/categories/%E6%AF%8F%E5%91%A8%E5%88%86%E4%BA%AB/"/>
    
    
  </entry>
  
  <entry>
    <title>Instrumentså®è·µ-è§£å†³å¡é¡¿ ä½¿ä½ çš„ç•Œé¢ä¿æŒæµç•…</title>
    <link href="https://developerdoc.com/essay/Instruments/Instruments3/"/>
    <id>https://developerdoc.com/essay/Instruments/Instruments3/</id>
    <published>2019-03-06T03:36:24.000Z</published>
    <updated>2019-03-07T08:25:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç»“åˆInstrument CoreAnimationåˆ†æå½±å“æ€§èƒ½çš„å› ç´ ï¼š <strong>å›¾å±‚æ··åˆ</strong>,<strong>å…‰æ …åŒ–</strong>,<strong>é¢œè‰²æ ¼å¼</strong>,<strong>å›¾ç‰‡å¤§å°</strong>,<strong>ç¦»å±æ¸²æŸ“</strong></p><p>åœ¨ä½¿ç”¨UIKitçš„è¿‡ç¨‹ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯æ°¸æ’çš„è¯é¢˜ã€‚å¾ˆå¤šäººéƒ½çœ‹è¿‡åˆ†æä¼˜åŒ–æ»‘åŠ¨æ€§èƒ½çš„æ–‡ç« ï¼Œä½†å…¶ä¸­ä¸å°‘æ–‡ç« åªä»‹ç»äº†ä¼˜åŒ–æ–¹æ³•å´å¯¹èƒŒåçš„åŸç†é¿è€Œä¸è°ˆï¼Œæˆ–è€…æ˜¯æ™¦æ¶©éš¾æ‡‚è€Œä¸”è¯»è€…ç¼ºä¹å®è·µä½“éªŒçš„æœºä¼šã€‚ä¸å¦¨æ€è€ƒä¸€ä¸‹ä¸‹é¢çš„é—®é¢˜è‡ªå·±æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼š</p><ol><li>ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜çš„ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆcellä¸­çš„å›¾ç‰‡ï¼Œå°½å¯èƒ½è¦ä½¿ç”¨æ­£ç¡®çš„å¤§å°ã€æ ¼å¼ï¼Œå¦‚æœé”™è¯¯ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆè®¾ç½®é˜´å½±å’Œåœ†è§’æœ‰å¯èƒ½å½±å“æ»‘åŠ¨æ—¶æµç•…åº¦ï¼Ÿ</li><li>shouldRasterizeå’Œç¦»å±æ¸²æŸ“çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶åº”è¯¥ä½¿ç”¨ï¼Ÿ</li></ol><a id="more"></a><p><img src="/res/Instrument/9.png" width="80%"></p><p>æ‰“å¼€CoreAnimationå¯ä»¥çœ‹åˆ°ä¸»ä½“çš„PFSæ•°æ®å’Œå³è¾¹çš„Debug Optionsã€‚</p><p>æˆ‘ä»¬çŸ¥é“ä»»ä½•å±å¹•æ€»æ˜¯æœ‰ä¸€ä¸ªåˆ·æ–°ç‡ï¼Œæ¯”å¦‚iphoneæ¨èçš„åˆ·æ–°ç‡æ˜¯60Hzï¼Œä¹Ÿå°±æ˜¯è¯´GPUæ¯ç§’é’Ÿåˆ·æ–°å±å¹•60æ¬¡ï¼Œå› æ­¤ä¸¤æ¬¡åˆ·æ–°ä¹‹é—´çš„é—´éš”ä¸º16.67msã€‚è¿™æ®µæ—¶é—´å†…å±å¹•å†…å®¹ä¿æŒä¸å˜ï¼Œç§°ä¸ºä¸€å¸§(frame)ï¼Œfpsè¡¨ç¤ºframes per secondï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿæ˜¾ç¤ºå¤šå°‘å¸§ç”»é¢ã€‚å¯¹äºé™æ­¢ä¸å˜çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å®ƒçš„åˆ·æ–°ç‡ï¼Œä½†åœ¨æ‰§è¡ŒåŠ¨ç”»æˆ–æ»‘åŠ¨æ—¶ï¼Œfpsçš„å€¼ç›´æ¥åæ˜ å‡ºæ»‘åŠ¨çš„æµç•…ç¨‹åº¦ã€‚</p><h2 id="å›¾å±‚æ··åˆ"><a href="#å›¾å±‚æ··åˆ" class="headerlink" title="å›¾å±‚æ··åˆ"></a>å›¾å±‚æ··åˆ</h2><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½åƒç´ çš„æ¦‚å¿µï¼Œå±å¹•ä¸Šæ¯ä¸€ä¸ªç‚¹éƒ½æ˜¯ä¸€ä¸ªåƒç´ ï¼Œåƒç´ æœ‰Rã€Gã€Bä¸‰ç§é¢œè‰²æ„æˆ(æœ‰æ—¶å€™è¿˜å¸¦æœ‰alphaå€¼)ã€‚å¦‚æœæŸä¸€å—åŒºåŸŸä¸Šè¦†ç›–äº†å¤šä¸ªlayer,æœ€åçš„æ˜¾ç¤ºæ•ˆæœå—åˆ°è¿™äº›layerçš„å…±åŒå½±å“ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šå±‚æ˜¯è“è‰²(RGB=0,0,1),é€æ˜åº¦ä¸º50%ï¼Œä¸‹å±‚æ˜¯çº¢è‰²(RGB=1,0,0)ã€‚é‚£ä¹ˆæœ€ç»ˆçš„æ˜¾ç¤ºæ•ˆæœæ˜¯ç´«è‰²(RGB=0.5,0,0.5)ã€‚è¿™ç§é¢œè‰²çš„æ··åˆ(blending)éœ€è¦æ¶ˆè€—ä¸€å®šçš„GPUèµ„æºï¼Œå› ä¸ºå®é™…ä¸Šå¯èƒ½ä¸æ­¢åªæœ‰ä¸¤å±‚ã€‚å¦‚æœåªæƒ³æ˜¾ç¤ºæœ€ä¸Šå±‚çš„è“è‰²ï¼Œå¯ä»¥æŠŠå®ƒçš„é€æ˜åº¦è®¾ç½®ä¸º100%ï¼Œè¿™æ ·GPUä¼šå¿½ç•¥ä¸‹é¢æ‰€æœ‰çš„layerï¼Œä»è€ŒèŠ‚çº¦äº†å¾ˆå¤šä¸å¿…è¦çš„è¿ç®—ã€‚</p><p>ç¬¬ä¸€ä¸ªè°ƒè¯•é€‰é¡¹â€Color Blended Layersâ€æ­£æ˜¯ç”¨äºæ£€æµ‹å“ªé‡Œå‘ç”Ÿäº†å›¾å±‚æ··åˆï¼Œå¹¶ç”¨çº¢è‰²æ ‡è®°å‡ºæ¥ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°½å¯èƒ½å‡å°‘çœ‹åˆ°çš„çº¢è‰²åŒºåŸŸã€‚ä¸€æ—¦å‘ç°åº”è¯¥æƒ³æ³•è®¾æ³•æ¶ˆé™¤å®ƒã€‚</p><p><img src="/res/Instrument/15.png" width="40%"></p><p>è§£å†³åŠæ³•å¦‚ä¸‹ï¼š</p><ol><li>é€æ˜åº¦è®¾ç½®ä¸º100%<ul><li>å¦‚æœæŸä¸€å—åŒºåŸŸä¸Šè¦†ç›–äº†å¤šä¸ªlayer,æœ€åçš„æ˜¾ç¤ºæ•ˆæœå—åˆ°è¿™äº›layerçš„å…±åŒå½±å“ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šå±‚æ˜¯è“è‰²(RGB=0,0,1),é€æ˜åº¦ä¸º50%ï¼Œä¸‹å±‚æ˜¯çº¢è‰²(RGB=1,0,0)ã€‚é‚£ä¹ˆæœ€ç»ˆçš„æ˜¾ç¤ºæ•ˆæœæ˜¯ç´«è‰²(RGB=0.5,0,0.5)ã€‚è¿™ç§é¢œè‰²çš„æ··åˆ(blending)éœ€è¦æ¶ˆè€—ä¸€å®šçš„GPUèµ„æºï¼Œå› ä¸ºå®é™…ä¸Šå¯èƒ½ä¸æ­¢åªæœ‰ä¸¤å±‚ã€‚å¦‚æœåªæƒ³æ˜¾ç¤ºæœ€ä¸Šå±‚çš„è“è‰²ï¼Œå¯ä»¥æŠŠå®ƒçš„é€æ˜åº¦è®¾ç½®ä¸º100%ï¼Œè¿™æ ·GPUä¼šå¿½ç•¥ä¸‹é¢æ‰€æœ‰çš„layerï¼Œä»è€ŒèŠ‚çº¦äº†å¾ˆå¤šä¸å¿…è¦çš„è¿ç®—ã€‚</li></ul></li><li>UIImageViewçš„å›¾ç‰‡ä¹Ÿä¸èƒ½å«æœ‰alphaé€šé“<ul><li>å›¾åƒè‡ªèº«çš„æ€§è´¨å¯èƒ½ä¼šå¯¹ç»“æœæœ‰å½±å“</li></ul></li><li>è®¾ç½® backgroundColor å±æ€§ï¼ˆå¦‚æœä¸è®¾ç½®èƒŒæ™¯é¢œè‰²ï¼Œæ§ä»¶ä¾ç„¶ä¼šè¢«è®¤ä¸ºæ˜¯é€æ˜çš„ï¼‰<ul><li>è™½ç„¶åœ¨ç™½è‰²èƒŒæ™¯ä¸‹ï¼Œæ— æ³•è‚‰çœ¼çœ‹åˆ°æ•ˆæœï¼Œä½†é‡æ–°è°ƒè¯•åæˆ‘ä»¬å¯ä»¥å‘ç°labelçš„çº¢è‰²æ¶ˆå¤±äº†ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºå¯¹èƒŒæ™¯é¢œè‰²çš„ä¸é‡è§†ï¼Œå®ƒæˆäº†å½±å“æ»‘åŠ¨æ€§èƒ½çš„ç¬¬ä¸€ä¸ªæ€æ‰‹ã€‚</li></ul></li><li>å¦‚æœlabelæ–‡å­—æœ‰ä¸­æ–‡ï¼Œä¾ç„¶ä¼šå‡ºç°å›¾å±‚æ··åˆï¼Œè¿™æ˜¯å› ä¸ºæ­¤æ—¶labelå¤šäº†ä¸€ä¸ªsublayer</li></ol><h2 id="å…‰æ …åŒ–"><a href="#å…‰æ …åŒ–" class="headerlink" title="å…‰æ …åŒ–"></a>å…‰æ …åŒ–</h2><p>ç¬¬äºŒä¸ªè°ƒè¯•é€‰é¡¹æ˜¯<strong>â€œColor Hits Green and Misses Red</strong>â€ï¼Œå®ƒè¡¨ç¤ºå¦‚æœå‘½ä¸­ç¼“å­˜åˆ™æ˜¾ç¤ºä¸ºç»¿è‰²ï¼Œå¦åˆ™æ˜¾ç¤ºä¸ºçº¢è‰²ï¼Œæ˜¾ç„¶ç»¿è‰²è¶Šå¤šè¶Šå¥½ï¼Œçº¢è‰²è¶Šå°‘è¶Šå¥½ã€‚å‹¾é€‰è¿™ä¸ªé€‰é¡¹åæˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹çš„åœºæ™¯ï¼š</p><p><img src="/res/Instrument/16.png" width="40%"></p><p>å…‰æ …åŒ–æ˜¯å°†ä¸€ä¸ªlayeré¢„å…ˆæ¸²æŸ“æˆä½å›¾(bitmap)ï¼Œç„¶ååŠ å…¥ç¼“å­˜ä¸­ã€‚å¦‚æœå¯¹äºé˜´å½±æ•ˆæœè¿™æ ·æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„é™æ€å†…å®¹è¿›è¡Œç¼“å­˜ï¼Œå¯ä»¥å¾—åˆ°ä¸€å®šå¹…åº¦çš„æ€§èƒ½æå‡</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸€è¡Œä»£ç è¡¨ç¤ºå°†labelçš„layerå…‰æ …åŒ–ï¼š</span></span><br><span class="line">label.layer.shouldRasterize = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>å› ä¸ºlayerè¿›è¡Œå…‰æ …åŒ–åæ¸²æŸ“æˆä½å›¾æ”¾åœ¨ç¼“å­˜ä¸­ã€‚ç¼“å­˜ä¸­çš„å¯¹è±¡æœ‰æ•ˆæœŸåªæœ‰100msï¼Œå³å¦‚æœåœ¨0.1så†…æ²¡æœ‰è¢«ä½¿ç”¨å°±ä¼šè‡ªåŠ¨ä»ç¼“å­˜ä¸­æ¸…ç†å‡ºå»ã€‚å…‰æ …åŒ–çš„ç¼“å­˜æœºåˆ¶æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå…ˆå†™å…¥ç¼“å­˜å†è¯»å–æœ‰å¯èƒ½æ¶ˆè€—è¾ƒå¤šçš„æ—¶é—´ã€‚å› æ­¤å…‰æ …åŒ–ä»…é€‚ç”¨äºè¾ƒå¤æ‚çš„ã€é™æ€çš„æ•ˆæœã€‚ å…‰æ …åŒ–ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“</p><p>æ‰€ä»¥æˆ‘ä»¬åšçš„ç¬¬äºŒä¸ªä¼˜åŒ–æ˜¯æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    label.layer.shouldRasterize = true</span></span><br></pre></td></tr></table></figure><h2 id="é¢œè‰²æ ¼å¼"><a href="#é¢œè‰²æ ¼å¼" class="headerlink" title="é¢œè‰²æ ¼å¼"></a>é¢œè‰²æ ¼å¼</h2><p>åƒç´ åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å’Œå®ƒåœ¨ç£ç›˜ä¸­çš„å­˜å‚¨æ–¹å¼å¹¶ä¸ç›¸åŒã€‚è€ƒè™‘ä¸€ç§ç®€å•çš„æƒ…å†µï¼šæ¯ä¸ªåƒç´ æœ‰Rã€Gã€Bå’Œalphaå››ä¸ªå€¼ï¼Œæ¯ä¸ªå€¼å ç”¨1å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸ªåƒç´ å ç”¨4å­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚ä¸€å¼ 1920*1080çš„ç…§ç‰‡(iPhone6 Plusçš„åˆ†è¾¨ç‡)ä¸€å…±æœ‰2,073,600ä¸ªåƒç´ ï¼Œå› æ­¤å ç”¨äº†è¶…è¿‡8Mbçš„å†…å­˜ã€‚ä½†æ˜¯ä¸€å¼ åŒæ ·åˆ†è¾¨ç‡çš„PNGæ ¼å¼æˆ–JPEGæ ¼å¼çš„å›¾ç‰‡ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæœ‰è¿™ä¹ˆå¤§ã€‚è¿™æ˜¯å› ä¸ºJPEGå°†åƒç´ æ•°æ®è¿›è¡Œäº†ä¸€ç§éå¸¸å¤æ‚ä¸”å¯é€†çš„è½¬åŒ–ã€‚</p><p>å½“æˆ‘ä»¬æ‰“å¼€JPEGæ ¼å¼çš„å›¾ç‰‡æ—¶ï¼ŒCPUä¼šè¿›è¡Œä¸€ç³»åˆ—è¿ç®—ï¼Œå°†JPEGå›¾ç‰‡è§£å‹æˆåƒç´ æ•°æ®ã€‚æ˜¾ç„¶è¿™ä¸ªå·¥ä½œä¼šæ¶ˆè€—ä¸å°‘æ—¶é—´ï¼Œæ‰€ä»¥ä¸åº”è¯¥åœ¨æ»‘åŠ¨æ—¶è¿›è¡Œï¼Œæˆ‘ä»¬åº”è¯¥é¢„å…ˆå¤„ç†å¥½å›¾ç‰‡ã€‚å€Ÿç”¨WWDCä¸Šçš„ä¸€é¡µPPTæ¥è¯´æ˜ï¼š</p><p><img src="/res/Instrument/t_UIKitæ€§èƒ½ä¼˜åŒ–22.png" alt></p><p>Commit Transactionå’ŒDecodeåœ¨åŒä¸€å¸§å†…è¿›è¡Œï¼Œå¦‚æœè¿™ä¸¤ä¸ªæ“ä½œçš„è€—æ—¶è¶…è¿‡16.67sï¼ŒDraw Callså°±ä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§ï¼Œä»è€Œå¯¼è‡´fpså€¼çš„é™ä½ã€‚ä¸‹é¢æ˜¯Commit Transactionçš„è¯¦ç»†æµç¨‹ï¼š</p><p><img src="/res/Instrument/t_UIKitæ€§èƒ½ä¼˜åŒ–23.png" alt></p><p>åœ¨ç¬¬ä¸‰æ­¥çš„Prepareä¸­ï¼ŒCPUä¸»è¦å¤„ç†ä¸¤ä»¶äº‹ï¼š</p><ol><li>æŠŠå›¾ç‰‡ä»PNGæˆ–JPEGç­‰æ ¼å¼ä¸­è§£å‹å‡ºæ¥ï¼Œå¾—åˆ°åƒç´ æ•°æ®</li><li>å¦‚æœGPUä¸æ”¯æŒè¿™ç§é¢œè‰²å„å¼ï¼ŒCPUéœ€è¦è¿›è¡Œæ ¼å¼è½¬æ¢</li></ol><p>ä½¿ç”¨core animation çš„ <strong>Color Copied Images</strong>æ£€æµ‹å›¾ç‰‡æ ¼å¼,ç¡®ä¿å›¾ç‰‡é¢œè‰²æ ¼å¼èƒ½è¢«GPUæ”¯æŒ</p><h2 id="å›¾ç‰‡å¤§å°"><a href="#å›¾ç‰‡å¤§å°" class="headerlink" title="å›¾ç‰‡å¤§å°"></a>å›¾ç‰‡å¤§å°</h2><p>ä½¿ç”¨core animation çš„ç¬¬äº”ä¸ªé€‰é¡¹â€œ<strong>Color Misaligned Imagesâ€</strong>ã€‚å®ƒè¡¨ç¤ºå¦‚æœå›¾ç‰‡éœ€è¦ç¼©æ”¾åˆ™æ ‡è®°ä¸ºé»„è‰²ï¼Œå¦‚æœæ²¡æœ‰åƒç´ å¯¹é½åˆ™æ ‡è®°ä¸ºç´«è‰²ã€‚å‹¾é€‰ä¸Šè¿™ä¸ªé€‰é¡¹å¹¶è¿›è¡Œè°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹åœºæ™¯ï¼š</p><p><img src="/res/Instrument/17.png" width="40%"></p><p>å›¾ç‰‡å¦‚æœéœ€è¦ç¼©æ”¾ä¼šå ç”¨ä¸€å®šæ—¶é—´ï¼Œç¡®ä¿å›¾ç‰‡å¤§å°ä¸frameä¸€è‡´ï¼Œä¸è¦åœ¨æ»‘åŠ¨çš„æ—¶å€™ç¼©æ”¾å›¾ç‰‡</p><h2 id="ç¦»å±æ¸²æŸ“"><a href="#ç¦»å±æ¸²æŸ“" class="headerlink" title="ç¦»å±æ¸²æŸ“"></a>ç¦»å±æ¸²æŸ“</h2><p>å¼€å§‹è°ƒè¯•å¹¶å‹¾é€‰â€œ<strong>Color Offscreen-Rendered Yellowâ€</strong>ï¼Œä¼šçœ‹åˆ°è¿™æ ·çš„åœºæ™¯ï¼š</p><p><img src="/res/Instrument/20.png" width="40%"></p><p>è¿™è¡¨ç¤ºäº§ç”Ÿäº†ç¦»å±æ¸²æŸ“ã€‚ç¦»å±æ¸²æŸ“è¡¨ç¤ºæ¸²æŸ“å‘ç”Ÿåœ¨å±å¹•ä¹‹å¤–ï¼Œä½ å¯èƒ½è®¤ä¸ºè¿™æ˜¯ä¸€å¥åºŸè¯ã€‚ä¸ºäº†çœŸæ­£è§£é‡Šæ¸…æ¥šä»€ä¹ˆæ˜¯ç¦»å±æ¸²æŸ“ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ­£å¸¸çš„æ¸²æŸ“é€šé“(Render-Pass)ï¼š</p><p><img src="/res/Instrument/18.png"> </p><p>é¦–å…ˆï¼ŒOpenGLæäº¤ä¸€ä¸ªå‘½ä»¤åˆ°Command Bufferï¼ŒéšåGPUå¼€å§‹æ¸²æŸ“ï¼Œæ¸²æŸ“ç»“æœæ”¾åˆ°Render Bufferä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„æ¸²æŸ“æµç¨‹ã€‚ä½†æ˜¯æœ‰ä¸€äº›å¤æ‚çš„æ•ˆæœæ— æ³•ç›´æ¥æ¸²æŸ“å‡ºç»“æœï¼Œå®ƒéœ€è¦åˆ†æ­¥æ¸²æŸ“æœ€åå†ç»„åˆèµ·æ¥ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ªè’™ç‰ˆ(mask)ï¼š</p><p><img src="/res/Instrument/19.png"> </p><p>åœ¨å‰ä¸¤ä¸ªæ¸²æŸ“é€šé“ä¸­ï¼ŒGPUåˆ†åˆ«å¾—åˆ°äº†çº¹ç†(textureï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ªç›¸æœºå›¾æ ‡)å’Œlayer(è“è‰²çš„è’™ç‰ˆ)çš„æ¸²æŸ“ç»“æœã€‚ä½†è¿™ä¸¤ä¸ªæ¸²æŸ“ç»“æœæ²¡æœ‰ç›´æ¥æ”¾å…¥Render Bufferä¸­ï¼Œä¹Ÿå°±è¡¨ç¤ºè¿™æ˜¯ç¦»å±æ¸²æŸ“ã€‚ç›´åˆ°ç¬¬ä¸‰ä¸ªæ¸²æŸ“é€šé“ï¼Œæ‰æŠŠä¸¤è€…ç»„åˆèµ·æ¥æ”¾å…¥Render Bufferä¸­ã€‚ç¦»å±æ¸²æŸ“æ„å‘³ç€æŠŠæ¸²æŸ“ç»“æœä¸´æ—¶ä¿å­˜ï¼Œç­‰ç”¨åˆ°æ—¶å†å–å‡ºï¼Œå› æ­¤ç›¸å¯¹äºæ™®é€šæ¸²æŸ“æ›´å ç”¨èµ„æºã€‚</p><p>ä»¥ä¸‹æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´è§¦å‘ç¦»å±æ¸²æŸ“ï¼š</p><ol><li>é‡å†™drawRectæ–¹æ³•</li><li>æœ‰maskæˆ–è€…æ˜¯é˜´å½±(layer.masksToBounds, layer.shadow*)ï¼Œæ¨¡ç³Šæ•ˆæœä¹Ÿæ˜¯ä¸€ç§mask</li><li>layer.shouldRasterize = true</li></ol><h2 id="å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ"><a href="#å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ"></a>å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ</h2><p>CPU å’Œ GPU ä¸è®ºå“ªä¸ªé˜»ç¢äº†æ˜¾ç¤ºæµç¨‹ï¼Œéƒ½ä¼šé€ æˆæ‰å¸§ç°è±¡ã€‚æ‰€ä»¥å¼€å‘æ—¶ï¼Œä¹Ÿéœ€è¦åˆ†åˆ«å¯¹ CPU å’Œ GPU å‹åŠ›è¿›è¡Œè¯„ä¼°å’Œä¼˜åŒ–ã€‚</p><h3 id="CPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"><a href="#CPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="CPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"></a>CPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ</h3><p><strong>1. å¯¹è±¡åˆ›å»ºï¼š</strong></p><p>å¯¹è±¡çš„åˆ›å»ºä¼šåˆ†é…å†…å­˜ã€è°ƒæ•´å±æ€§ã€ç”šè‡³è¿˜æœ‰è¯»å–æ–‡ä»¶ç­‰æ“ä½œï¼Œæ¯”è¾ƒæ¶ˆè€— CPU èµ„æºã€‚å°½é‡ç”¨è½»é‡çš„å¯¹è±¡ä»£æ›¿é‡é‡çš„å¯¹è±¡ï¼Œå¯ä»¥å¯¹æ€§èƒ½æœ‰æ‰€ä¼˜åŒ–ã€‚æ¯”å¦‚ CALayer æ¯” UIView è¦è½»é‡è®¸å¤šï¼Œé‚£ä¹ˆä¸éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶çš„æ§ä»¶ï¼Œç”¨ CALayer æ˜¾ç¤ºä¼šæ›´åŠ åˆé€‚ã€‚å¦‚æœå¯¹è±¡ä¸æ¶‰åŠ UI æ“ä½œï¼Œåˆ™å°½é‡æ”¾åˆ°åå°çº¿ç¨‹å»åˆ›å»ºï¼Œä½†å¯æƒœçš„æ˜¯åŒ…å«æœ‰ CALayer çš„æ§ä»¶ï¼Œéƒ½åªèƒ½åœ¨ä¸»çº¿ç¨‹åˆ›å»ºå’Œæ“ä½œã€‚é€šè¿‡ Storyboard åˆ›å»ºè§†å›¾å¯¹è±¡æ—¶ï¼Œå…¶èµ„æºæ¶ˆè€—ä¼šæ¯”ç›´æ¥é€šè¿‡ä»£ç åˆ›å»ºå¯¹è±¡è¦å¤§éå¸¸å¤šï¼Œåœ¨æ€§èƒ½æ•æ„Ÿçš„ç•Œé¢é‡Œï¼ŒStoryboard å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ€æœ¯é€‰æ‹©ã€‚</p><p>å°½é‡æ¨è¿Ÿå¯¹è±¡åˆ›å»ºçš„æ—¶é—´ï¼Œå¹¶æŠŠå¯¹è±¡çš„åˆ›å»ºåˆ†æ•£åˆ°å¤šä¸ªä»»åŠ¡ä¸­å»ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”å¸¦æ¥çš„ä¼˜åŠ¿å¹¶ä¸å¤šï¼Œä½†å¦‚æœæœ‰èƒ½åŠ›åšï¼Œè¿˜æ˜¯è¦å°½é‡å°è¯•ä¸€ä¸‹ã€‚å¦‚æœå¯¹è±¡å¯ä»¥å¤ç”¨ï¼Œå¹¶ä¸”å¤ç”¨çš„ä»£ä»·æ¯”é‡Šæ”¾ã€åˆ›å»ºæ–°å¯¹è±¡è¦å°ï¼Œé‚£ä¹ˆè¿™ç±»å¯¹è±¡åº”å½“å°½é‡æ”¾åˆ°ä¸€ä¸ªç¼“å­˜æ± é‡Œå¤ç”¨ã€‚</p><p><strong>2. å¯¹è±¡è°ƒæ•´: </strong></p><p>å¯¹è±¡çš„è°ƒæ•´ä¹Ÿç»å¸¸æ˜¯æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚è¿™é‡Œç‰¹åˆ«è¯´ä¸€ä¸‹ CALayerï¼šCALayer å†…éƒ¨å¹¶æ²¡æœ‰å±æ€§ï¼Œå½“è°ƒç”¨å±æ€§æ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨æ˜¯é€šè¿‡è¿è¡Œæ—¶ resolveInstanceMethod ä¸ºå¯¹è±¡ä¸´æ—¶æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æŠŠå¯¹åº”å±æ€§å€¼ä¿å­˜åˆ°å†…éƒ¨çš„ä¸€ä¸ª Dictionary é‡Œï¼ŒåŒæ—¶è¿˜ä¼šé€šçŸ¥ delegateã€åˆ›å»ºåŠ¨ç”»ç­‰ç­‰ï¼Œéå¸¸æ¶ˆè€—èµ„æºã€‚UIView çš„å…³äºæ˜¾ç¤ºç›¸å…³çš„å±æ€§ï¼ˆæ¯”å¦‚ frame/bounds/transformï¼‰ç­‰å®é™…ä¸Šéƒ½æ˜¯ CALayer å±æ€§æ˜ å°„æ¥çš„ï¼Œæ‰€ä»¥å¯¹ UIView çš„è¿™äº›å±æ€§è¿›è¡Œè°ƒæ•´æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºè¦è¿œå¤§äºä¸€èˆ¬çš„å±æ€§ã€‚å¯¹æ­¤ä½ åœ¨åº”ç”¨ä¸­ï¼Œåº”è¯¥å°½é‡å‡å°‘ä¸å¿…è¦çš„å±æ€§ä¿®æ”¹ã€‚</p><p>å½“è§†å›¾å±‚æ¬¡è°ƒæ•´æ—¶ï¼ŒUIViewã€CALayer ä¹‹é—´ä¼šå‡ºç°å¾ˆå¤šæ–¹æ³•è°ƒç”¨ä¸é€šçŸ¥ï¼Œæ‰€ä»¥åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œåº”è¯¥å°½é‡é¿å…è°ƒæ•´è§†å›¾å±‚æ¬¡ã€æ·»åŠ å’Œç§»é™¤è§†å›¾ã€‚</p><p><strong>3. å¯¹è±¡é”€æ¯: </strong></p><p>å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚è¿™é‡Œæœ‰ä¸ªå° Tipï¼šæŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œå°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *tmp = <span class="keyword">self</span>.array;</span><br><span class="line"><span class="keyword">self</span>.array = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    [tmp <span class="keyword">class</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>4. å¸ƒå±€è®¡ç®—: </strong></p><p>è§†å›¾å¸ƒå±€çš„è®¡ç®—æ˜¯ App ä¸­æœ€ä¸ºå¸¸è§çš„æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚å¦‚æœèƒ½åœ¨åå°çº¿ç¨‹æå‰è®¡ç®—å¥½è§†å›¾å¸ƒå±€ã€å¹¶ä¸”å¯¹è§†å›¾å¸ƒå±€è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹åŸºæœ¬å°±ä¸ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜äº†ã€‚</p><p>ä¸è®ºé€šè¿‡ä½•ç§æŠ€æœ¯å¯¹è§†å›¾è¿›è¡Œå¸ƒå±€ï¼Œå…¶æœ€ç»ˆéƒ½ä¼šè½åˆ°å¯¹ UIView.frame/bounds/center ç­‰å±æ€§çš„è°ƒæ•´ä¸Šã€‚ä¸Šé¢ä¹Ÿè¯´è¿‡ï¼Œå¯¹è¿™äº›å±æ€§çš„è°ƒæ•´éå¸¸æ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥å°½é‡æå‰è®¡ç®—å¥½å¸ƒå±€ï¼Œåœ¨éœ€è¦æ—¶ä¸€æ¬¡æ€§è°ƒæ•´å¥½å¯¹åº”å±æ€§ï¼Œè€Œä¸è¦å¤šæ¬¡ã€é¢‘ç¹çš„è®¡ç®—å’Œè°ƒæ•´è¿™äº›å±æ€§ã€‚</p><p><strong>5. Autolayout: </strong></p><p>Autolayout æ˜¯è‹¹æœæœ¬èº«æå€¡çš„æŠ€æœ¯ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¹Ÿèƒ½å¾ˆå¥½çš„æå‡å¼€å‘æ•ˆç‡ï¼Œä½†æ˜¯ Autolayout å¯¹äºå¤æ‚è§†å›¾æ¥è¯´å¸¸å¸¸ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚éšç€è§†å›¾æ•°é‡çš„å¢é•¿ï¼ŒAutolayout å¸¦æ¥çš„ CPU æ¶ˆè€—ä¼šå‘ˆæŒ‡æ•°çº§ä¸Šå‡ã€‚å…·ä½“æ•°æ®å¯ä»¥çœ‹è¿™ä¸ªæ–‡ç« ï¼š<a href="http://pilky.me/36/" target="_blank" rel="noopener">http://pilky.me/36/</a>ã€‚ å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨è°ƒæ•´ frame ç­‰å±æ€§ï¼Œä½ å¯ä»¥ç”¨ä¸€äº›å·¥å…·æ–¹æ³•æ›¿ä»£ï¼ˆæ¯”å¦‚å¸¸è§çš„ left/right/top/bottom/width/height å¿«æ·å±æ€§ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ ComponentKitã€AsyncDisplayKit ç­‰æ¡†æ¶ã€‚</p><p><strong>6. æ–‡æœ¬è®¡ç®—: </strong></p><p>å¦‚æœä¸€ä¸ªç•Œé¢ä¸­åŒ…å«å¤§é‡æ–‡æœ¬ï¼ˆæ¯”å¦‚å¾®åšå¾®ä¿¡æœ‹å‹åœˆç­‰ï¼‰ï¼Œæ–‡æœ¬çš„å®½é«˜è®¡ç®—ä¼šå ç”¨å¾ˆå¤§ä¸€éƒ¨åˆ†èµ„æºï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœä½ å¯¹æ–‡æœ¬æ˜¾ç¤ºæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå¯ä»¥å‚è€ƒä¸‹ UILabel å†…éƒ¨çš„å®ç°æ–¹å¼ï¼šç”¨ [NSAttributedString boundingRectWithSize:options:context:] æ¥è®¡ç®—æ–‡æœ¬å®½é«˜ï¼Œç”¨ -[NSAttributedString drawWithRect:options:context:] æ¥ç»˜åˆ¶æ–‡æœ¬ã€‚å°½ç®¡è¿™ä¸¤ä¸ªæ–¹æ³•æ€§èƒ½ä¸é”™ï¼Œä½†ä»æ—§éœ€è¦æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</p><p>å¦‚æœä½ ç”¨ CoreText ç»˜åˆ¶æ–‡æœ¬ï¼Œé‚£å°±å¯ä»¥å…ˆç”Ÿæˆ CoreText æ’ç‰ˆå¯¹è±¡ï¼Œç„¶åè‡ªå·±è®¡ç®—äº†ï¼Œå¹¶ä¸” CoreText å¯¹è±¡è¿˜èƒ½ä¿ç•™ä»¥ä¾›ç¨åç»˜åˆ¶ä½¿ç”¨ã€‚</p><p><strong>7. æ–‡æœ¬æ¸²æŸ“:</strong></p><p>å±å¹•ä¸Šèƒ½çœ‹åˆ°çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹æ§ä»¶ï¼ŒåŒ…æ‹¬ UIWebViewï¼Œåœ¨åº•å±‚éƒ½æ˜¯é€šè¿‡ CoreText æ’ç‰ˆã€ç»˜åˆ¶ä¸º Bitmap æ˜¾ç¤ºçš„ã€‚å¸¸è§çš„æ–‡æœ¬æ§ä»¶ ï¼ˆUILabelã€UITextView ç­‰ï¼‰ï¼Œå…¶æ’ç‰ˆå’Œç»˜åˆ¶éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå½“æ˜¾ç¤ºå¤§é‡æ–‡æœ¬æ—¶ï¼ŒCPU çš„å‹åŠ›ä¼šéå¸¸å¤§ã€‚å¯¹æ­¤è§£å†³æ–¹æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰æ–‡æœ¬æ§ä»¶ï¼Œç”¨ TextKit æˆ–æœ€åº•å±‚çš„ CoreText å¯¹æ–‡æœ¬å¼‚æ­¥ç»˜åˆ¶ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥éå¸¸éº»çƒ¦ï¼Œä½†å…¶å¸¦æ¥çš„ä¼˜åŠ¿ä¹Ÿéå¸¸å¤§ï¼ŒCoreText å¯¹è±¡åˆ›å»ºå¥½åï¼Œèƒ½ç›´æ¥è·å–æ–‡æœ¬çš„å®½é«˜ç­‰ä¿¡æ¯ï¼Œé¿å…äº†å¤šæ¬¡è®¡ç®—ï¼ˆè°ƒæ•´ UILabel å¤§å°æ—¶ç®—ä¸€éã€UILabel ç»˜åˆ¶æ—¶å†…éƒ¨å†ç®—ä¸€éï¼‰ï¼›CoreText å¯¹è±¡å ç”¨å†…å­˜è¾ƒå°‘ï¼Œå¯ä»¥ç¼“å­˜ä¸‹æ¥ä»¥å¤‡ç¨åå¤šæ¬¡æ¸²æŸ“ã€‚</p><p><strong>8. å›¾ç‰‡çš„è§£ç :</strong></p><p>å½“ä½ ç”¨ UIImage æˆ– CGImageSource çš„é‚£å‡ ä¸ªæ–¹æ³•åˆ›å»ºå›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡æ•°æ®å¹¶ä¸ä¼šç«‹åˆ»è§£ç ã€‚å›¾ç‰‡è®¾ç½®åˆ° UIImageView æˆ–è€… CALayer.contents ä¸­å»ï¼Œå¹¶ä¸” CALayer è¢«æäº¤åˆ° GPU å‰ï¼ŒCGImage ä¸­çš„æ•°æ®æ‰ä¼šå¾—åˆ°è§£ç ã€‚è¿™ä¸€æ­¥æ˜¯å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœæƒ³è¦ç»•å¼€è¿™ä¸ªæœºåˆ¶ï¼Œå¸¸è§çš„åšæ³•æ˜¯åœ¨åå°çº¿ç¨‹å…ˆæŠŠå›¾ç‰‡ç»˜åˆ¶åˆ° CGBitmapContext ä¸­ï¼Œç„¶åä» Bitmap ç›´æ¥åˆ›å»ºå›¾ç‰‡ã€‚ç›®å‰å¸¸è§çš„ç½‘ç»œå›¾ç‰‡åº“éƒ½è‡ªå¸¦è¿™ä¸ªåŠŸèƒ½ã€‚</p><p><strong>9. å›¾åƒçš„ç»˜åˆ¶:</strong></p><p>å›¾åƒçš„ç»˜åˆ¶é€šå¸¸æ˜¯æŒ‡ç”¨é‚£äº›ä»¥ CG å¼€å¤´çš„æ–¹æ³•æŠŠå›¾åƒç»˜åˆ¶åˆ°ç”»å¸ƒä¸­ï¼Œç„¶åä»ç”»å¸ƒåˆ›å»ºå›¾ç‰‡å¹¶æ˜¾ç¤ºè¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚è¿™ä¸ªæœ€å¸¸è§çš„åœ°æ–¹å°±æ˜¯ [UIView drawRect:] é‡Œé¢äº†ã€‚ç”±äº CoreGraphic æ–¹æ³•é€šå¸¸éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å›¾åƒçš„ç»˜åˆ¶å¯ä»¥å¾ˆå®¹æ˜“çš„æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œã€‚ä¸€ä¸ªç®€å•å¼‚æ­¥ç»˜åˆ¶çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼ˆå®é™…æƒ…å†µä¼šæ¯”è¿™ä¸ªå¤æ‚å¾—å¤šï¼Œä½†åŸç†åŸºæœ¬ä¸€è‡´ï¼‰ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)display &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(backgroundQueue, ^&#123;</span><br><span class="line">        <span class="built_in">CGContextRef</span> ctx = <span class="built_in">CGBitmapContextCreate</span>(...);</span><br><span class="line">        <span class="comment">// draw in context...</span></span><br><span class="line">        <span class="built_in">CGImageRef</span> img = <span class="built_in">CGBitmapContextCreateImage</span>(ctx);</span><br><span class="line">        <span class="built_in">CFRelease</span>(ctx);</span><br><span class="line">        <span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</span><br><span class="line">            layer.contents = img;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"><a href="#GPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="GPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"></a>GPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ</h3><p>ç›¸å¯¹äº CPU æ¥è¯´ï¼ŒGPU èƒ½å¹²çš„äº‹æƒ…æ¯”è¾ƒå•ä¸€ï¼šæ¥æ”¶æäº¤çš„çº¹ç†ï¼ˆTextureï¼‰å’Œé¡¶ç‚¹æè¿°ï¼ˆä¸‰è§’å½¢ï¼‰ï¼Œåº”ç”¨å˜æ¢ï¼ˆtransformï¼‰ã€æ··åˆå¹¶æ¸²æŸ“ï¼Œç„¶åè¾“å‡ºåˆ°å±å¹•ä¸Šã€‚é€šå¸¸ä½ æ‰€èƒ½çœ‹åˆ°çš„å†…å®¹ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯çº¹ç†ï¼ˆå›¾ç‰‡ï¼‰å’Œå½¢çŠ¶ï¼ˆä¸‰è§’æ¨¡æ‹Ÿçš„çŸ¢é‡å›¾å½¢ï¼‰ä¸¤ç±»ã€‚</p><p><strong>1. çº¹ç†çš„æ¸²æŸ“</strong></p><p>æ‰€æœ‰çš„ Bitmapï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€æ–‡æœ¬ã€æ …æ ¼åŒ–çš„å†…å®¹ï¼Œæœ€ç»ˆéƒ½è¦ç”±å†…å­˜æäº¤åˆ°æ˜¾å­˜ï¼Œç»‘å®šä¸º GPU Textureã€‚ä¸è®ºæ˜¯æäº¤åˆ°æ˜¾å­˜çš„è¿‡ç¨‹ï¼Œè¿˜æ˜¯ GPU è°ƒæ•´å’Œæ¸²æŸ“ Texture çš„è¿‡ç¨‹ï¼Œéƒ½è¦æ¶ˆè€—ä¸å°‘ GPU èµ„æºã€‚å½“åœ¨è¾ƒçŸ­æ—¶é—´æ˜¾ç¤ºå¤§é‡å›¾ç‰‡æ—¶ï¼ˆæ¯”å¦‚ TableView å­˜åœ¨éå¸¸å¤šçš„å›¾ç‰‡å¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼‰ï¼ŒCPU å ç”¨ç‡å¾ˆä½ï¼ŒGPU å ç”¨éå¸¸é«˜ï¼Œç•Œé¢ä»ç„¶ä¼šæ‰å¸§ã€‚é¿å…è¿™ç§æƒ…å†µçš„æ–¹æ³•åªèƒ½æ˜¯å°½é‡å‡å°‘åœ¨çŸ­æ—¶é—´å†…å¤§é‡å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå°½å¯èƒ½å°†å¤šå¼ å›¾ç‰‡åˆæˆä¸ºä¸€å¼ è¿›è¡Œæ˜¾ç¤ºã€‚</p><p>å½“å›¾ç‰‡è¿‡å¤§ï¼Œè¶…è¿‡ GPU çš„æœ€å¤§çº¹ç†å°ºå¯¸æ—¶ï¼Œå›¾ç‰‡éœ€è¦å…ˆç”± CPU è¿›è¡Œé¢„å¤„ç†ï¼Œè¿™å¯¹ CPU å’Œ GPU éƒ½ä¼šå¸¦æ¥é¢å¤–çš„èµ„æºæ¶ˆè€—ã€‚ç›®å‰æ¥è¯´ï¼ŒiPhone 4S ä»¥ä¸Šæœºå‹ï¼Œçº¹ç†å°ºå¯¸ä¸Šé™éƒ½æ˜¯ 4096Ã—4096ï¼Œæ›´è¯¦ç»†çš„èµ„æ–™å¯ä»¥çœ‹è¿™é‡Œï¼šiosres.comã€‚æ‰€ä»¥ï¼Œå°½é‡ä¸è¦è®©å›¾ç‰‡å’Œè§†å›¾çš„å¤§å°è¶…è¿‡è¿™ä¸ªå€¼ã€‚</p><p><strong>2. è§†å›¾çš„æ··åˆ (Composing)</strong></p><p>å½“å¤šä¸ªè§†å›¾ï¼ˆæˆ–è€…è¯´ CALayerï¼‰é‡å åœ¨ä¸€èµ·æ˜¾ç¤ºæ—¶ï¼ŒGPU ä¼šé¦–å…ˆæŠŠä»–ä»¬æ··åˆåˆ°ä¸€èµ·ã€‚å¦‚æœè§†å›¾ç»“æ„è¿‡äºå¤æ‚ï¼Œæ··åˆçš„è¿‡ç¨‹ä¹Ÿä¼šæ¶ˆè€—å¾ˆå¤š GPU èµ„æºã€‚ä¸ºäº†å‡è½»è¿™ç§æƒ…å†µçš„ GPU æ¶ˆè€—ï¼Œåº”ç”¨åº”å½“å°½é‡å‡å°‘è§†å›¾æ•°é‡å’Œå±‚æ¬¡ï¼Œå¹¶åœ¨ä¸é€æ˜çš„è§†å›¾é‡Œæ ‡æ˜ opaque å±æ€§ä»¥é¿å…æ— ç”¨çš„ Alpha é€šé“åˆæˆã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•ï¼ŒæŠŠå¤šä¸ªè§†å›¾é¢„å…ˆæ¸²æŸ“ä¸ºä¸€å¼ å›¾ç‰‡æ¥æ˜¾ç¤ºã€‚</p><p><strong>3. å›¾å½¢çš„ç”Ÿæˆ</strong></p><p>CALayer çš„ borderã€åœ†è§’ã€é˜´å½±ã€é®ç½©ï¼ˆmaskï¼‰ï¼ŒCASharpLayer çš„çŸ¢é‡å›¾å½¢æ˜¾ç¤ºï¼Œé€šå¸¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼ˆoffscreen renderingï¼‰ï¼Œè€Œç¦»å±æ¸²æŸ“é€šå¸¸å‘ç”Ÿåœ¨ GPU ä¸­ã€‚å½“ä¸€ä¸ªåˆ—è¡¨è§†å›¾ä¸­å‡ºç°å¤§é‡åœ†è§’çš„ CALayerï¼Œå¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œå¯ä»¥è§‚å¯Ÿåˆ° GPU èµ„æºå·²ç»å æ»¡ï¼Œè€Œ CPU èµ„æºæ¶ˆè€—å¾ˆå°‘ã€‚è¿™æ—¶ç•Œé¢ä»ç„¶èƒ½æ­£å¸¸æ»‘åŠ¨ï¼Œä½†å¹³å‡å¸§æ•°ä¼šé™åˆ°å¾ˆä½ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å°è¯•å¼€å¯ CALayer.shouldRasterize å±æ€§ï¼Œä½†è¿™ä¼šæŠŠåŸæœ¬ç¦»å±æ¸²æŸ“çš„æ“ä½œè½¬å«åˆ° CPU ä¸Šå»ã€‚å¯¹äºåªéœ€è¦åœ†è§’çš„æŸäº›åœºåˆï¼Œä¹Ÿå¯ä»¥ç”¨ä¸€å¼ å·²ç»ç»˜åˆ¶å¥½çš„åœ†è§’å›¾ç‰‡è¦†ç›–åˆ°åŸæœ¬è§†å›¾ä¸Šé¢æ¥æ¨¡æ‹Ÿç›¸åŒçš„è§†è§‰æ•ˆæœã€‚æœ€å½»åº•çš„è§£å†³åŠæ³•ï¼Œå°±æ˜¯æŠŠéœ€è¦æ˜¾ç¤ºçš„å›¾å½¢åœ¨åå°çº¿ç¨‹ç»˜åˆ¶ä¸ºå›¾ç‰‡ï¼Œé¿å…ä½¿ç”¨åœ†è§’ã€é˜´å½±ã€é®ç½©ç­‰å±æ€§ã€‚</p><!--iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/ --><!--å†…å­˜æ¶é¬¼drawRect https://bihongbo.com/2016/01/03/memoryGhostdrawRect/ --><!-- UIKitæ€§èƒ½è°ƒè¯• https://bestswifter.com/uikitxing-neng-diao-you-shi-zhan-jiang-jie/-->]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç»“åˆInstrument CoreAnimationåˆ†æå½±å“æ€§èƒ½çš„å› ç´ ï¼š &lt;strong&gt;å›¾å±‚æ··åˆ&lt;/strong&gt;,&lt;strong&gt;å…‰æ …åŒ–&lt;/strong&gt;,&lt;strong&gt;é¢œè‰²æ ¼å¼&lt;/strong&gt;,&lt;strong&gt;å›¾ç‰‡å¤§å°&lt;/strong&gt;,&lt;strong&gt;ç¦»å±æ¸²æŸ“&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ä½¿ç”¨UIKitçš„è¿‡ç¨‹ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯æ°¸æ’çš„è¯é¢˜ã€‚å¾ˆå¤šäººéƒ½çœ‹è¿‡åˆ†æä¼˜åŒ–æ»‘åŠ¨æ€§èƒ½çš„æ–‡ç« ï¼Œä½†å…¶ä¸­ä¸å°‘æ–‡ç« åªä»‹ç»äº†ä¼˜åŒ–æ–¹æ³•å´å¯¹èƒŒåçš„åŸç†é¿è€Œä¸è°ˆï¼Œæˆ–è€…æ˜¯æ™¦æ¶©éš¾æ‡‚è€Œä¸”è¯»è€…ç¼ºä¹å®è·µä½“éªŒçš„æœºä¼šã€‚ä¸å¦¨æ€è€ƒä¸€ä¸‹ä¸‹é¢çš„é—®é¢˜è‡ªå·±æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜çš„ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¸ºä»€ä¹ˆcellä¸­çš„å›¾ç‰‡ï¼Œå°½å¯èƒ½è¦ä½¿ç”¨æ­£ç¡®çš„å¤§å°ã€æ ¼å¼ï¼Œå¦‚æœé”™è¯¯ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä¸ºä»€ä¹ˆè®¾ç½®é˜´å½±å’Œåœ†è§’æœ‰å¯èƒ½å½±å“æ»‘åŠ¨æ—¶æµç•…åº¦ï¼Ÿ&lt;/li&gt;
&lt;li&gt;shouldRasterizeå’Œç¦»å±æ¸²æŸ“çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶åº”è¯¥ä½¿ç”¨ï¼Ÿ&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="é‡å­¦iOS" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/"/>
    
      <category term="Instruments" scheme="https://developerdoc.com/categories/%E9%87%8D%E5%AD%A6iOS/Instruments/"/>
    
    
      <category term="iOS" scheme="https://developerdoc.com/tags/iOS/"/>
    
  </entry>
  
</feed>
