<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"developerdoc.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文是关于 redux（3.7.2）源代码的一些浅读  在redux源码目录中 ，可以看到以下文件目录： 12345678|-- utils&#x2F;    |-- warning.js              &#x2F;&#x2F;打印error|-- 1. applyMiddleware.js          &#x2F;&#x2F; |-- 2. bindActionCreators.js       &#x2F;&#x2F;|-- 3. combi">
<meta property="og:type" content="article">
<meta property="og:title" content="Redux源码浅读">
<meta property="og:url" content="https://developerdoc.com/essay/Redux%E6%BA%90%E7%A0%81%E6%B5%85%E8%AF%BB/index.html">
<meta property="og:site_name" content="孙同生的博客">
<meta property="og:description" content="本文是关于 redux（3.7.2）源代码的一些浅读  在redux源码目录中 ，可以看到以下文件目录： 12345678|-- utils&#x2F;    |-- warning.js              &#x2F;&#x2F;打印error|-- 1. applyMiddleware.js          &#x2F;&#x2F; |-- 2. bindActionCreators.js       &#x2F;&#x2F;|-- 3. combi">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-01-29T08:15:53.000Z">
<meta property="article:modified_time" content="2018-11-28T14:28:12.000Z">
<meta property="article:author" content="SunTongSheng">
<meta property="article:tag" content="前端工程化">
<meta property="article:tag" content="Redux">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://developerdoc.com/essay/Redux%E6%BA%90%E7%A0%81%E6%B5%85%E8%AF%BB/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://developerdoc.com/essay/Redux%E6%BA%90%E7%A0%81%E6%B5%85%E8%AF%BB/","path":"essay/Redux源码浅读/","title":"Redux源码浅读"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redux源码浅读 | 孙同生的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="孙同生的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">孙同生的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">为美好的世界献上祝福</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-compose"><span class="nav-number">1.</span> <span class="nav-text">1. compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-applyMiddleware-%E4%B8%8E-%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%93%BE"><span class="nav-number">2.</span> <span class="nav-text">2. applyMiddleware 与 中间件链</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8F%8Areact-thunk"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 中间件及react-thunk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-applyMiddleware%E6%BA%90%E7%A0%81"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 applyMiddleware源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%93%BE%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 中间件链的执行顺序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-bindActionCreators"><span class="nav-number">3.</span> <span class="nav-text">3. bindActionCreators</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-combineReducers"><span class="nav-number">4.</span> <span class="nav-text">4. combineReducers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-createStore"><span class="nav-number">5.</span> <span class="nav-text">5. createStore</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SunTongSheng</p>
  <div class="site-description" itemprop="description">移动端 前端 跨平台</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">80</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://developerdoc.com/essay/Redux%E6%BA%90%E7%A0%81%E6%B5%85%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SunTongSheng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="孙同生的博客">
      <meta itemprop="description" content="移动端 前端 跨平台">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redux源码浅读 | 孙同生的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redux源码浅读
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2018-01-29 16:15:53" itemprop="dateCreated datePublished" datetime="2018-01-29T16:15:53+08:00">2018-01-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2018-11-28 22:28:12" itemprop="dateModified" datetime="2018-11-28T22:28:12+08:00">2018-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/essay/" itemprop="url" rel="index"><span itemprop="name">essay</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/essay/Redux/" itemprop="url" rel="index"><span itemprop="name">Redux</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>本文是关于 redux（3.7.2）源代码的一些浅读</p>
</blockquote>
<p>在<a href="https://github.com/reactjs/redux/tree/master/src">redux源码目录</a>中 ，可以看到以下文件目录：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|-- utils/</span><br><span class="line">    |-- warning.<span class="property">js</span>              <span class="comment">//打印error</span></span><br><span class="line">|-- <span class="number">1.</span> applyMiddleware.<span class="property">js</span>          <span class="comment">// </span></span><br><span class="line">|-- <span class="number">2.</span> bindActionCreators.<span class="property">js</span>       <span class="comment">//</span></span><br><span class="line">|-- <span class="number">3.</span> combineReducers.<span class="property">js</span>          <span class="comment">//</span></span><br><span class="line">|-- <span class="number">4.</span> compose.<span class="property">js</span>                  <span class="comment">//</span></span><br><span class="line">|-- <span class="number">5.</span> createStore.<span class="property">js</span>              <span class="comment">//</span></span><br><span class="line">|-- index.<span class="property">js</span>                    <span class="comment">//入口文件</span></span><br></pre></td></tr></table></figure>

<p>与文件对应的，主要也是介绍 createStore compose combineReducers bindActionCreators applyMiddleware这几个函数。</p>
<span id="more"></span>

<h3 id="1-compose"><a href="#1-compose" class="headerlink" title="1. compose"></a>1. compose</h3><p>先来看看compose函数，这个比较简单。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//funcs保存着所有参数函数的数组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _len = <span class="variable language_">arguments</span>.<span class="property">length</span>, funcs = <span class="title class_">Array</span>(_len), _key = <span class="number">0</span>; _key &lt; _len; _key++) &#123;</span><br><span class="line">    funcs[_key] = <span class="variable language_">arguments</span>[_key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//省略一些逻辑判断……</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//reduce方法使用指定的函数将数组元素进行组合，生成单个值</span></span><br><span class="line">  <span class="keyword">return</span> funcs.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">a</span>(b.<span class="title function_">apply</span>(<span class="literal">undefined</span>, <span class="variable language_">arguments</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中主要就是对 reduce 的理解了。reduce()方法使用指定的函数将数组元素进行组合（从左到右），生成单个值。具体可以查看<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce">Array.prototype.reduce() | MDN</a></p>
<p>compose的功能为从右到左,组合参数(函数)。传递给compose方法的参数是函数类型的，</p>
<p><strong>compose(f, g, h) 相当于 (…args) &#x3D;&gt; f(g(h(…args)))</strong></p>
<h3 id="2-applyMiddleware-与-中间件链"><a href="#2-applyMiddleware-与-中间件链" class="headerlink" title="2. applyMiddleware 与 中间件链"></a>2. applyMiddleware 与 中间件链</h3><p>故名思义这个函数就是应用中间件，一般使用方式为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//thunk代表react-thunk中间件</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(rootReducer, initialState, <span class="title function_">applyMiddleware</span>(thunk));</span><br></pre></td></tr></table></figure>
<h4 id="2-1-中间件及react-thunk"><a href="#2-1-中间件及react-thunk" class="headerlink" title="2.1 中间件及react-thunk"></a>2.1 中间件及react-thunk</h4><p>在看applyMiddleware函数前，先来简单看一下中间件，redux中间件在发起action到达reducer之间扩展了一些功能。一般用于记录日志（reudx-logger）和增加异步调用（redux-thunk , redux-saga）等。这些中间件一般按照一定的格式书写，比如react-thunk2.2.0的源码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//react-thunk2.2.0的代码，很简单 只有十几行……</span></span><br><span class="line"><span class="comment">//外层函数可以传入多余的参数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createThunkMiddleware</span>(<span class="params">extraArgument</span>) &#123;</span><br><span class="line">  <span class="comment">//获取dispatch getState（是由applyMiddleware传入）</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">_ref</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> dispatch = _ref.<span class="property">dispatch</span>,</span><br><span class="line">        getState = _ref.<span class="property">getState</span>;</span><br><span class="line">    <span class="comment">//1. 如果这个中间件是调用链最内环的，next指原store.dispatch    </span></span><br><span class="line">    <span class="comment">//2. 其他next一般指上一个中间件的返回值 action =&gt; &#123;&#125;</span></span><br><span class="line">    <span class="comment">//对于这个next的赋值不清楚的话可以结合之后的applyMiddleware函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">next</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">action</span>) &#123;</span><br><span class="line">        <span class="comment">//1. 原action只是个普通的对象，thunk使action可以传入函数类型，并传入了dispatch, getState, extraArgument</span></span><br><span class="line">        <span class="comment">//2. 如果action是个异步函数，thunk会调用该函数</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">action</span>(dispatch, getState, extraArgument);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. 函数调用结束后，获取必要的数据再次触发dispatch由此实现异步效果。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(action);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到react-thunk中间件是一个多层的高阶函数，格式大致为： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&#123;dispatch,getState&#125;) =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;<span class="keyword">return</span> <span class="title function_">next</span>(action)&#125;</span><br></pre></td></tr></table></figure>
<p>中间件的格式都要遵循这样相似的格式，这是由applyMiddleware函数决定的。接下来看下applyMiddleware的源码：</p>
<h4 id="2-2-applyMiddleware源码"><a href="#2-2-applyMiddleware源码" class="headerlink" title="2.2 applyMiddleware源码"></a>2.2 applyMiddleware源码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//applyMiddleware源码</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">applyMiddleware</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//middlewares保存传进来的中间件</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _len = <span class="variable language_">arguments</span>.<span class="property">length</span>, middlewares = <span class="title class_">Array</span>(_len), _key = <span class="number">0</span>; _key &lt; _len; _key++) &#123;</span><br><span class="line">    middlewares[_key] = <span class="variable language_">arguments</span>[_key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//createStore是创建createStore的函数，会在下文解读，这里先不管</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">createStore</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">      <span class="comment">//创建store 并获取了其dispatch方法</span></span><br><span class="line">      <span class="keyword">var</span> store = <span class="title function_">createStore</span>(reducer, preloadedState, enhancer);</span><br><span class="line">      <span class="keyword">var</span> _dispatch = store.<span class="property">dispatch</span>;</span><br><span class="line">      <span class="keyword">var</span> chain = [];</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//用于传递给中间件第一层函数的参数，上文在thunk中有看到</span></span><br><span class="line">      <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">        <span class="attr">getState</span>: store.<span class="property">getState</span>,</span><br><span class="line">        <span class="attr">dispatch</span>: <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">_dispatch</span>(action);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">//middlewares保存的是中间件，chain对应保存的就是中间件第二层函数组成的数组</span></span><br><span class="line">      <span class="comment">//形象点就是上文中间件格式去掉第一层：next =&gt; action =&gt; &#123;&#125;</span></span><br><span class="line">      chain = middlewares.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">middleware</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">middleware</span>(middlewareAPI);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//1. componse的功能在上文说到，假设chain为[F1,F2,F3],compose之后变成了F1(F2(F3))</span></span><br><span class="line">      <span class="comment">//2. 与上文thunk中说到中间件格式对应，F3是中间件链的最内环 所以F3的next参数为store.dispatch</span></span><br><span class="line">      <span class="comment">//3. F2的next参数就是F3返回的 action =&gt; &#123;&#125;</span></span><br><span class="line">      <span class="comment">//4. 同样的F1的next参数就是F2返回的 action =&gt; &#123;&#125;      </span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//_dispatch就相当于F1(F2(F3(store.dispatch)))</span></span><br><span class="line">      <span class="comment">//这样多个中间件就组合到了一起，形成了中间件链</span></span><br><span class="line">      _dispatch = compose.<span class="title function_">apply</span>(<span class="literal">undefined</span>, chain)(store.<span class="property">dispatch</span>);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//新的dispatch会覆盖原dispatch，之后调用dispatch同时会调用中间件链</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">_extends</span>(&#123;&#125;, store, &#123;</span><br><span class="line">        <span class="attr">dispatch</span>: _dispatch</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>_dispatch = compose.apply(undefined, chain)(store.dispatch);</code>组合后，中间件的next就是store.dispatch一路经过上一个中间件封装后的变种dispatch。</p>
<h4 id="2-3-中间件链的执行顺序"><a href="#2-3-中间件链的执行顺序" class="headerlink" title="2.3 中间件链的执行顺序"></a>2.3 中间件链的执行顺序</h4><p>光看代码可能对于中间件链的执行顺序的理解还是优点蒙，这里来做个实践加深一下理解。</p>
<blockquote>
<p><strong>一、</strong> 先按上文说的中间件格式<code>(&#123;dispatch,getState&#125;) =&gt; next =&gt; action =&gt; &#123;return next(action)&#125;</code> 写三个中间件：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">middleware1</span>(<span class="params">&#123;dispatch,getState&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware1 next层 next:&#x27;</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">action</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware1 action层 开始&#x27;</span>)</span><br><span class="line">            <span class="title function_">next</span>(action)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware1 action层 结束&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">middleware2</span>(<span class="params">&#123;dispatch,getState&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware2 next层 next:&#x27;</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">action</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware2 action层 开始&#x27;</span>)</span><br><span class="line">            <span class="title function_">next</span>(action)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware2 action层 结束&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">middleware3</span>(<span class="params">&#123;dispatch,getState&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware3 next层 next:&#x27;</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">action</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware3 action层 开始&#x27;</span>)</span><br><span class="line">            <span class="title function_">next</span>(action)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware3 action层 结束&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>二、</strong> 将它们和redux-thunk 和 redux-logger一起加入中间件链：</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> middlewares = [</span><br><span class="line">    middleware1,</span><br><span class="line">    thunkMiddleWare,</span><br><span class="line">    middleware2,</span><br><span class="line">    middleware3,</span><br><span class="line">    loggerMiddleWare,<span class="comment">//redux-logger需要放在最后面</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(rootReducer, initialState, <span class="title function_">applyMiddleware</span>(...middlewares));</span><br></pre></td></tr></table></figure>

<p>运行你的代码后在chrome控制台看到如下信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">middleware3 next层 <span class="attr">next</span>: ƒ (l)&#123;<span class="keyword">if</span>(<span class="string">&quot;function&quot;</span>==<span class="keyword">typeof</span> …</span><br><span class="line"> </span><br><span class="line">middleware2 next层 <span class="attr">next</span>: ƒ (action)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware3 action层 开始&#x27;</span>);</span><br><span class="line"><span class="title function_">next</span>(action);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;middleware3 action层 结束&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">middleware1 next层 <span class="attr">next</span>: ƒ (action) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">action</span>(dispatch, getState, extraArgument);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(action);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>这也验证了上文对 <code>_dispatch = compose.apply(undefined, chain)(store.dispatch);</code>的理解。</p>
<p>这里的中间件链是由 <code>[m1,thunk,m2,m3,logger]</code>组成，在<code>compose </code>之后变成了 <code>m1(thunk(m2(m3(logger))))</code>,<br>所以</p>
<ul>
<li>m3的<em>next</em>参数是<strong>logger</strong>的action层函数（参数为action那层函数）</li>
<li>m2的<em>next</em>参数是<strong>m3</strong>的action层函数</li>
<li>m1的<em>next</em>参数是<strong>thunk</strong>的action层函数</li>
</ul>
<blockquote>
<p><strong>三、</strong> 执行一下 dispatch(action) :</p>
</blockquote>
<p>这时候分两种情况：</p>
<p>1、当action类型为对象时,在chrome控制台看到如下信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">发起 <span class="title function_">dispatch</span>(action) action类型为对象</span><br><span class="line"></span><br><span class="line">middleware1 action层 开始</span><br><span class="line">middleware2 action层 开始</span><br><span class="line">middleware3 action层 开始</span><br><span class="line">action <span class="variable constant_">SOME_OBJ_ACTION</span>       redux-logger.<span class="property">js</span>:<span class="number">1</span></span><br><span class="line">middleware3 action层 结束</span><br><span class="line">middleware2 action层 结束</span><br><span class="line">middleware1 action层 结束</span><br></pre></td></tr></table></figure>

<p>粗粗一看好像顺序不对啊，不该先执行middleware3的逻辑嘛？其实内层（位置靠后的中间件）只是返回了一个function，并没有执行其中的逻辑，不断由外层的中间件包裹形成了一个‘<strong>洋葱模型</strong>’。由外向内穿心而过，再由内向外完成流程。</p>
<p>这样子就很明确了，<strong>中间件的action层执行顺序为先加入中间件链的先执行！</strong>，更准确的说中间件中先执行从外层向内层中 <code>next(action)</code>之前的逻辑，然后执行从内层向外层中 <code>next(action)</code>之后的逻辑。</p>
<p>2、当action类型为函数时,在chrome控制台看到如下信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">发起  <span class="title function_">dispatch</span>(action) action类型为函数</span><br><span class="line"></span><br><span class="line">middleware1 action层 开始</span><br><span class="line">middleware1 action层 结束</span><br></pre></td></tr></table></figure>

<p>可以看到只执行了 middleware1 和 thunk 两个中间件！<strong>这是因为thunk没有执行 <code>next(action)</code> 中断了中间件链！</strong> 当中间件没有执行next(action)时会导致中间件链中断，这是因为dispatch没有传递下去，所以中间件还可以捣乱咯～</p>
<h3 id="3-bindActionCreators"><a href="#3-bindActionCreators" class="headerlink" title="3. bindActionCreators"></a>3. bindActionCreators</h3><p>bindActionCreators的功能是为action creaters包装上dispatch，使其调用action时自动dispatch对应的action。</p>
<p>在bindActionCreators.js中只有两个函数 <code>bindActionCreator</code> 和 <code>bindActionCreators</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这个函数的主要作用就是返回一个函数，当我们调用返回的这个函数的时候，就会自动的dispatch对应的action</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatch</span>(actionCreator.<span class="title function_">apply</span>(<span class="literal">undefined</span>, <span class="variable language_">arguments</span>));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//省略一些逻辑判断</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取所有action creater函数的名字</span></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(actionCreators);</span><br><span class="line">  <span class="comment">// 保存dispatch和action creater函数进行绑定之后的集合</span></span><br><span class="line">  <span class="keyword">var</span> boundActionCreators = &#123;&#125;;</span><br><span class="line">  <span class="comment">//为每个actionCreators 包装上 dispatch</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = keys[i];</span><br><span class="line">    <span class="keyword">var</span> actionCreator = actionCreators[key];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = <span class="title function_">bindActionCreator</span>(actionCreator, dispatch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-combineReducers"><a href="#4-combineReducers" class="headerlink" title="4. combineReducers"></a>4. combineReducers</h3><p>Reducer只是一些纯函数，它接收之前的state和action，并返回新的state。当应用变大，我们可以拆分多个小的reducers，分别独立的操作state tree的不同部分。而combineReducers就是将多个不同的reducer合并成一个最终的reducer，用于赋值给createStore函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//combineReducers的代码比较简单，在省略一些错误判断的代码后：</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">combineReducers</span>(<span class="params">reducers</span>) &#123;  </span><br><span class="line">  <span class="keyword">var</span> reducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(reducers);</span><br><span class="line">  <span class="keyword">var</span> finalReducers = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reducerKeys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = reducerKeys[i];</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> finalReducerKeys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(finalReducers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//从上面到这里都是为了保存finalReducerKeys 和 finalReducers</span></span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//返回的combination函数就相当于结合所有reducers之后新的reducer</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">combination</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="variable language_">arguments</span>.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable language_">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span> ? <span class="variable language_">arguments</span>[<span class="number">0</span>] : &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> action = <span class="variable language_">arguments</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> hasChanged = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> nextState = &#123;&#125;;</span><br><span class="line">    <span class="comment">//这里遍历了所有之前自定义的reducers，并记录下是否state有改变，并记录下改变的state</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; finalReducerKeys.<span class="property">length</span>; _i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> _key = finalReducerKeys[_i];</span><br><span class="line">      <span class="keyword">var</span> reducer = finalReducers[_key];</span><br><span class="line">      <span class="keyword">var</span> previousStateForKey = state[_key];</span><br><span class="line">      <span class="comment">//遍历所有的reducer，若previousStateForKey匹配到则返回新的state</span></span><br><span class="line">      <span class="comment">//若匹配不到就在reducer中dufault中返回原state</span></span><br><span class="line">      <span class="keyword">var</span> nextStateForKey = <span class="title function_">reducer</span>(previousStateForKey, action);</span><br><span class="line">      ......</span><br><span class="line">      nextState[_key] = nextStateForKey;</span><br><span class="line">      <span class="comment">//这里有点意思，并没有因为找到不同的state就直接返回</span></span><br><span class="line">      <span class="comment">//这意味着，多个子reducers可以对同个action返回自己的state</span></span><br><span class="line">      <span class="comment">//并且返回的state是依据靠后的reducer的返回值决定的</span></span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-createStore"><a href="#5-createStore" class="headerlink" title="5. createStore"></a>5. createStore</h3><p>现在来看下最重要的createStore函数：</p>
<!--preloadedState-->

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* redux有且仅有一个store，createStore函数就是用于创建一个store用来存放所有的state。</span></span><br><span class="line"><span class="comment">* @param &#123;Function&#125;  reducer</span></span><br><span class="line"><span class="comment">* @param &#123;any&#125; [preloadedState] 初始化state</span></span><br><span class="line"><span class="comment">* @param &#123;Function&#125; [enhancer] store的增强器，有applyMiddleware、时间旅行（time travel）、持久化（persistence）等。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>上面是createStore的参数，其中enhancer指的是store的增强器（对store API进行改造）。</p>
<ul>
<li>applyMiddleware在前面我们已经见过了，applyMiddleware是对store的dispatch函数的修改。</li>
<li><strong>时间旅行</strong>则是指redux可以回到任意以前的状态。<ul>
<li>这是因为Redux使用简单的对象来表示state状态，并使用纯函数计算下一个状态。这意味着如果给定一个特定state状态和一个特定action操作，那么下一个状态将始终完全相同。这种特性可以让我们将所有修改过的状态保存在一个状态历史对象中，通过指定恢复到状态历史对象中从前的状态，来完成时间旅行。</li>
<li>比较容易可以想到的应用就是一些撤销&#x2F;重做操作。</li>
</ul>
</li>
<li><strong>持久化</strong>持久化这个概念肯定大家都熟悉，也有人做出了实现：<a href="https://github.com/rt2zz/redux-persist">redux-persist</a></li>
</ul>
<p>介绍完enhancer，来接着看代码逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> _ref2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    enhancer = preloadedState;</span><br><span class="line">    preloadedState = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the enhancer to be a function.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">enhancer</span>(createStore)(reducer, preloadedState);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> currentReducer = reducer;      	<span class="comment">//</span></span><br><span class="line">  <span class="keyword">var</span> currentState = preloadedState; 	<span class="comment">//当前的state</span></span><br><span class="line">  <span class="keyword">var</span> currentListeners = [];           <span class="comment">//订阅函数</span></span><br><span class="line">  <span class="keyword">var</span> nextListeners = currentListeners;<span class="comment">//订阅函数备份，</span></span><br><span class="line">  <span class="comment">//用于解决listeners数组执行过程（for循环）中，取消订阅listener产生的listeners数组index错误。</span></span><br><span class="line">  <span class="comment">//这样保证在某个dispatch后，会保证在这个dispatch之前的所有事件监听器全部执行</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> isDispatching = <span class="literal">false</span>; 			  <span class="comment">//dispatch方法同步标志</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">ensureCanMutateNextListeners</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.<span class="title function_">slice</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">any</span>&#125; 当前state</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> currentState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 将一个订阅函数放到 listeners 队列里，当 dispatch 的时候，逐一调用 listeners 中的回调方法。    </span></span><br><span class="line"><span class="comment">  * @param &#123;Function&#125; listener函数</span></span><br><span class="line"><span class="comment">  * @return &#123;Function&#125; 解除绑定的方法</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">subscribe</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected listener to be a function.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isSubscribed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">ensureCanMutateNextListeners</span>();</span><br><span class="line">    nextListeners.<span class="title function_">push</span>(listener);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//解除订阅的方法，</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">unsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">ensureCanMutateNextListeners</span>();</span><br><span class="line">      <span class="keyword">var</span> index = nextListeners.<span class="title function_">indexOf</span>(listener);</span><br><span class="line">      nextListeners.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * dispatch方法,调用reducer</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; action </span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> &#123;<span class="type">Object</span>&#125; 一般会返回action,</span></span><br><span class="line"><span class="comment">   * 如果使用了中间件，可能返回promise 或者function之类的（）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">//dispatch是同步的，用isDispatching标志来判断</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Reducers may not dispatch actions.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//调用reducer</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">//更新state树</span></span><br><span class="line">      currentState = <span class="title function_">currentReducer</span>(currentState, action);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//调用nextListeners中的监听方法</span></span><br><span class="line">    <span class="keyword">var</span> listeners = currentListeners = nextListeners;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> listener = listeners[i];</span><br><span class="line">      <span class="title function_">listener</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 替换reducer</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">replaceReducer</span>(<span class="params">nextReducer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the nextReducer to be a function.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer;</span><br><span class="line">    <span class="comment">//触发生成新的state树</span></span><br><span class="line">    <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *略</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">observable</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成初始state树</span></span><br><span class="line">  <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="title class_">ActionTypes</span>.<span class="property">INIT</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _ref2 = &#123;</span><br><span class="line">    <span class="attr">dispatch</span>: dispatch,</span><br><span class="line">    <span class="attr">subscribe</span>: subscribe,</span><br><span class="line">    <span class="attr">getState</span>: getState,</span><br><span class="line">    <span class="attr">replaceReducer</span>: replaceReducer</span><br><span class="line">  &#125;, _ref2[$$observable] = observable, _ref2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><em>以上就是我个人的简单见解，如果有什么错误之处，敬请指导讨论</em></p>
<hr>
<p>参考资料：</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html">Redux 入门教程（一）：基本用法 | 阮一峰</a></li>
<li><a href="http://cn.redux.js.org/">Redux 中文文档</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag"># 前端工程化</a>
              <a href="/tags/Redux/" rel="tag"># Redux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/essay/RN%E4%B8%AD%E5%B8%83%E5%B1%80%E6%A0%B7%E5%BC%8F%E7%9A%84%E5%86%99%E6%B3%95/" rel="prev" title="RN中布局样式的写法">
                  <i class="fa fa-angle-left"></i> RN中布局样式的写法
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/quick-start/Electron%E6%95%99%E7%A8%8B/Electron%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/" rel="next" title="Electron入门教程">
                  Electron入门教程 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">SunTongSheng</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">499k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:34</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":100,"height":200,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body>
</html>
