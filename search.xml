<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Autoreleaseç›¸å…³.md</title>
    <url>/essay/Autorelease%E7%9B%B8%E5%85%B3/</url>
    <content><![CDATA[<h2 id="Autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ"><a href="#Autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ" class="headerlink" title="Autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ"></a>Autoreleaseå¯¹è±¡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ</h2><p>åœ¨æ²¡æœ‰æ‰‹åŠ Autorelease Poolçš„æƒ…å†µä¸‹ï¼ŒAutoreleaseå¯¹è±¡æ˜¯åœ¨å½“å‰çš„runloopè¿­ä»£ç»“æŸæ—¶é‡Šæ”¾çš„ï¼Œ</p>
<p>è€Œå®ƒèƒ½å¤Ÿé‡Šæ”¾çš„åŸå› æ˜¯ç³»ç»Ÿåœ¨æ¯ä¸ªrunloopè¿­ä»£ä¸­éƒ½åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± Pushå’ŒPop</p>
<a id="more"></a>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ·»åŠ <code>@autoreleasepool</code>å¹²é¢„Autoreleaseå¯¹è±¡çš„é‡Šæ”¾æ—¶æœºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *str = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"sunnyxx"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, str); <span class="comment">// Console: (null)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä»€ä¹ˆæ—¶å€™ç”¨-autoreleasepool"><a href="#ä»€ä¹ˆæ—¶å€™ç”¨-autoreleasepool" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ç”¨@autoreleasepool"></a>ä»€ä¹ˆæ—¶å€™ç”¨@autoreleasepool</h2><p>æ ¹æ®<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html" target="_blank" rel="noopener">Appleçš„æ–‡æ¡£</a>ï¼Œä½¿ç”¨åœºæ™¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>å†™åŸºäºå‘½ä»¤è¡Œçš„çš„ç¨‹åºæ—¶ï¼Œå°±æ˜¯æ²¡æœ‰UIæ¡†æ¶ï¼Œå¦‚AppKitç­‰Cocoaæ¡†æ¶æ—¶ã€‚</li>
<li>å†™å¾ªç¯ï¼Œå¾ªç¯é‡Œé¢åŒ…å«äº†å¤§é‡ä¸´æ—¶åˆ›å»ºçš„å¯¹è±¡ã€‚ï¼ˆæœ¬æ–‡çš„ä¾‹å­ï¼‰</li>
<li>åˆ›å»ºäº†æ–°çš„çº¿ç¨‹ã€‚ï¼ˆéCocoaç¨‹åºåˆ›å»ºçº¿ç¨‹æ—¶æ‰éœ€è¦ï¼‰</li>
<li>é•¿æ—¶é—´åœ¨åå°è¿è¡Œçš„ä»»åŠ¡ã€‚</li>
</ul>
<h3 id="åˆ©ç”¨-autoreleasepoolä¼˜åŒ–å¾ªç¯"><a href="#åˆ©ç”¨-autoreleasepoolä¼˜åŒ–å¾ªç¯" class="headerlink" title="åˆ©ç”¨@autoreleasepoolä¼˜åŒ–å¾ªç¯"></a>åˆ©ç”¨@autoreleasepoolä¼˜åŒ–å¾ªç¯</h3><p>åˆ©ç”¨@autoreleasepoolä¼˜åŒ–å¾ªç¯çš„å†…å­˜å ç”¨ï¼Œæˆ‘è§‰å¾—æœ€æœ‰ç”¨çš„ä¸€ç‚¹ï¼Œä¸‹é¢å°±è¯´è¯´è¿™ä¸ªç‚¹ã€‚<br>å¦‚ä¸‹é¢çš„å¾ªç¯ï¼Œæ¬¡æ•°éå¸¸å¤šï¼Œè€Œä¸”å¾ªç¯ä½“é‡Œé¢çš„å¯¹è±¡éƒ½æ˜¯ä¸´æ—¶åˆ›å»ºä½¿ç”¨çš„ï¼Œå°±å¯ä»¥ç”¨@autoreleasepoolåŒ…èµ·æ¥ï¼Œè®©æ¯æ¬¡å¾ªç¯ç»“æŸæ—¶ï¼Œå¯ä»¥åŠæ—¶çš„é‡Šæ”¾ä¸´æ—¶å¯¹è±¡çš„å†…å­˜ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ¥è‡ªAppleæ–‡æ¡£ï¼Œè§å‚è€ƒ</span></span><br><span class="line"><span class="built_in">NSArray</span> *urls = &lt;<span class="meta"># An array of file URLs #&gt;;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSURL</span> *url <span class="keyword">in</span> urls) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSError</span> *error;</span><br><span class="line">        <span class="built_in">NSString</span> *fileContents = [<span class="built_in">NSString</span> stringWithContentsOfURL:url</span><br><span class="line">                                        encoding:<span class="built_in">NSUTF8StringEncoding</span> error:&amp;error];</span><br><span class="line">        <span class="comment">/* Process the string, creating and autoreleasing more objects. */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>ä½¿ç”¨å®¹å™¨çš„blockç‰ˆæœ¬çš„æšä¸¾å™¨æ—¶ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨æ·»åŠ ä¸€ä¸ªAutoreleasePoolï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[array enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œè¢«ä¸€ä¸ªå±€éƒ¨@autoreleasepoolåŒ…å›´ç€</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œåœ¨æ™®é€šforå¾ªç¯å’Œfor inå¾ªç¯ä¸­æ²¡æœ‰ï¼Œæ‰€ä»¥ï¼Œè¿˜æ˜¯æ–°ç‰ˆçš„blockç‰ˆæœ¬æšä¸¾å™¨æ›´åŠ æ–¹ä¾¿ã€‚forå¾ªç¯ä¸­éå†äº§ç”Ÿå¤§é‡autoreleaseå˜é‡æ—¶ï¼Œå°±éœ€è¦æ‰‹åŠ å±€éƒ¨AutoreleasePool</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>(è¯‘)Reactæ˜¯å¦‚ä½•åŒºåˆ†Classå’ŒFunctionï¼Ÿ</title>
    <url>/essay/(%E8%AF%91)how-does-react-tell-a-class-from-a-function/</url>
    <content><![CDATA[<blockquote>
<p>åŸæ–‡åœ°å€: <a href="https://overreacted.io/how-does-react-tell-a-class-from-a-function/" target="_blank" rel="noopener">how-does-react-tell-a-class-from-a-function</a><br>æœ¬æ–‡åœ°å€ï¼š <a href="https://developerdoc.com/essay/(è¯‘)how-does-react-tell-a-class-from-a-function/">Reactæ˜¯å¦‚ä½•åŒºåˆ†Classå’ŒFunctionï¼Ÿ</a><br>è¾¹çœ‹è¾¹ç¿»è¯‘ èŠ±äº†2h+â€¦ å¦‚æœä½ è§‰å¾—è¯»èµ·æ¥è¿˜ç®—é€šé¡ºä¸è´¹äº‹ é‚£ä¹Ÿç®—æˆ‘ä¸ºå¤§å®¶åšäº†ä¸€ç‚¹å°è´¡çŒ®å§</p>
</blockquote>
<a id="more"></a>
<h2 id="Reactè°ƒç”¨ä¸¤è€…çš„ä¸åŒä¹‹å¤„"><a href="#Reactè°ƒç”¨ä¸¤è€…çš„ä¸åŒä¹‹å¤„" class="headerlink" title="Reactè°ƒç”¨ä¸¤è€…çš„ä¸åŒä¹‹å¤„"></a>Reactè°ƒç”¨ä¸¤è€…çš„ä¸åŒä¹‹å¤„</h2><p>ä¸€èµ·æ¥çœ‹ä¸‹è¿™ä¸ª function ç±»å‹çš„ <code>Greeting</code>ç»„ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Greeting</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>React åŒæ ·æ”¯æŒå°†å®ƒå®šä¹‰ä¸º class ç±»å‹:<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(ç›´åˆ°<a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener">æœ€è¿‘ hooks-intro</a>ï¼Œè¿™æ˜¯ä½¿ç”¨stateç­‰ç‰¹æ€§çš„å”¯ä¸€æ–¹æ³•ã€‚)</p>
<p>å½“ä½ æƒ³æ¸²æŸ“<code>&lt;Greeting /&gt;</code>ç»„ä»¶æ—¶ï¼Œä½ ä¸å¿…å…³å¿ƒå®ƒæ˜¯å¦‚ä½•å®šä¹‰çš„ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç±»æˆ–è€…å‡½æ•°ï¼Œéƒ½å¯ä»¥</span></span><br><span class="line">&lt;Greeting /&gt;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œä½œä¸º <em>Reactæœ¬èº«</em> æ˜¯ä¼šè®¤ä¸ºè¿™ä¸¤ä¸ªæ˜¯æœ‰ä¸åŒä¹‹å¤„çš„ã€‚</p>
<p>å¦‚æœ<code>Greeting</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ŒReact åªéœ€è¦ç›´æ¥è°ƒç”¨å®ƒ:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½ çš„ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Greeting</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reactå†…</span></span><br><span class="line"><span class="keyword">const</span> result = Greeting(props); <span class="comment">// &lt;p&gt;Hello&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å¦‚æœ<code>Greeting</code>æ˜¯ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆ React å°±éœ€è¦ä½¿ç”¨<code>new</code>æ¥å®ä¾‹åŒ–å®ƒï¼Œç„¶ååœ¨å®ä¾‹ä¸Šè°ƒç”¨<code>render</code>æ–¹æ³•ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½ çš„ä»£ç </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reactå†…</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">new</span> Greeting(props); <span class="comment">// Greeting &#123;&#125;</span></span><br><span class="line"><span class="keyword">const</span> result = instance.render(); <span class="comment">// &lt;p&gt;Hello&lt;/p&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œ<code>React</code>çš„ç›®æ ‡æ˜¯è·å–æ¸²æŸ“èŠ‚ç‚¹ï¼ˆæœ¬ä¾‹ä¸­ï¼Œæ˜¯<code>&lt;p&gt; Hello &lt;/ p&gt;</code>ï¼‰ï¼Œä½†ç¡®åˆ‡çš„æ­¥éª¤å–å†³äº<code>Greeting</code>çš„ç±»å‹ã€‚</p>
<p><strong>é‚£ä¹ˆReactå¦‚ä½•çŸ¥é“æŸä¸ªä¸œè¥¿æ˜¯classç±»å‹è¿˜æ˜¯functionç±»å‹å‘¢ï¼Ÿ</strong></p>
<p>äº‹å®ä¸Šï¼Œè¿™ç¯‡æ–‡ç« æ›´å¤šçš„æ˜¯å…³äºJavaScriptè€Œä¸æ˜¯å…³äºReactã€‚<br>å¦‚ä½•ä½ å¥½å¥‡Reactä¸ºä½•ä»¥æŸç§æ–¹å¼è¿ä½œï¼Œè®©æˆ‘ä»¬ä¸€èµ·æŒ–æ˜å…¶ä¸­çš„åŸç†ã€‚</p>
<p><strong>è¿™æ˜¯ä¸€æ®µæ¼«é•¿çš„æ¢æ±‚ä¹‹æ—…ã€‚è¿™ç¯‡æ–‡ç« æ²¡æœ‰å¤ªå¤šå…³äºReactæœ¬èº«çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°†è®¨è®º<code>new</code>ï¼Œ<code>this</code>ï¼Œ<code>class</code>ï¼Œ<code>arrow function</code>ï¼Œ<code>prototype</code>ï¼Œ<code>__ proto__</code>ï¼Œ<code>instanceof</code>è¿™äº›æ¦‚å¿µï¼Œä»¥åŠè¿™äº›ä¸œè¥¿å¦‚ä½•åœ¨JavaScriptä¸­è¿ä½œçš„æœºåˆ¶ã€‚å¹¸è¿çš„æ˜¯ï¼Œå½“ä½ ä»…ä»…æ˜¯ä½¿ç”¨Reactæ—¶ï¼Œä½ ä¸éœ€è¦è€ƒè™‘è¿™ä¹ˆå¤šã€‚ä½†ä½ å¦‚æœè¦æ·±ç©¶Reactâ€¦â€¦</strong></p>
<p>(å¦‚æœä½ çœŸçš„åªæƒ³çŸ¥é“ç­”æ¡ˆï¼Œè¯·æ‹‰åŠ¨åˆ°æ–‡ç« æœ€åã€‚)</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ç”¨ä¸åŒçš„è°ƒç”¨æ–¹å¼ï¼Ÿ</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä»¥ä¸åŒæ–¹å¼å¤„ç†classå’Œfunctionçš„é‡è¦æ€§ã€‚æ³¨æ„æˆ‘ä»¬åœ¨è°ƒç”¨ç±»æ—¶å¦‚ä½•ä½¿ç”¨newè¿ç®—ç¬¦ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// If Greeting is a function</span></span><br><span class="line"><span class="keyword">const</span> result = Greeting(props); <span class="comment">// &lt;p&gt;Hello&lt;/p&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// If Greeting is a class</span></span><br><span class="line"><span class="keyword">const</span> instance = <span class="keyword">new</span> Greeting(props); <span class="comment">// Greeting &#123;&#125;</span></span><br><span class="line"><span class="keyword">const</span> result = instance.render(); <span class="comment">// &lt;p&gt;Hello&lt;/p&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>è®©æˆ‘ä»¬å¤§è‡´çš„äº†è§£ä¸‹<code>new</code>åœ¨Javascriptä¸­åšäº†ä»€ä¹ˆï¼š</p>
<hr>
<p>åœ¨ES6ä¹‹å‰ï¼ŒJavascriptæ²¡æœ‰classè¿™ä¸ªæ¦‚å¿µã€‚ä½†æ˜¯ï¼Œå¯ä»¥ä½¿ç”¨çº¯å‡½æ•°è¡¨ç°å‡ºå’Œclassç›¸ä¼¼çš„æ¨¡å¼ã€‚ <strong>å…·ä½“æ¥è¯´ï¼Œä½ å¯ä»¥ä½¿ç”¨newæ¥è°ƒç”¨ç±»ä¼¼ç±»æ„é€ æ–¹æ³•çš„å‡½æ•°ï¼Œæ¥è¡¨ç°å‡ºå’Œclassç›¸ä¼¼çš„æ¨¡å¼</strong><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åªæ˜¯ä¸€ä¸ªfunction</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>); <span class="comment">// âœ… Person &#123;name: 'Fred'&#125;</span></span><br><span class="line"><span class="keyword">var</span> george = Person(<span class="string">'George'</span>); <span class="comment">// ğŸ”´ ä¸ä¼šå¦‚æœŸå·¥ä½œ</span></span><br><span class="line"><span class="comment">//ä½ ä»Šå¤©ä»ç„¶å¯ä»¥å†™è¿™æ ·çš„ä»£ç ï¼åœ¨ `DevTools` ä¸­å°è¯•ä¸€ä¸‹ã€‚</span></span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœä¸ç”¨<code>new</code>ä¿®é¥°<code>Person(&#39;Fred&#39;)</code>,Personå†…éƒ¨çš„<code>this</code>åœ¨é‡Œé¢ä¼šæŒ‡å‘ <code>window</code> æˆ–è€… <code>undefined</code> ã€‚ç»“æœå°±æ˜¯ä»£ç ä¼šå´©æºƒæˆ–è€…åƒç»™<code>window.name</code>èµ‹å€¼ä¸€æ ·æ„šè ¢ã€‚</p>
<p>åœ¨è°ƒç”¨ä¹‹å‰æ·»åŠ <code>new</code>ï¼Œç­‰äºè¯´ï¼šâ€œå˜¿ JavaScriptï¼Œæˆ‘çŸ¥é“<code>Person</code>åªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†è®©æˆ‘ä»¬å‡è£…å®ƒæ˜¯ä¸ªç±»æ„é€ å‡½æ•°ã€‚ <strong>åˆ›å»ºä¸€ä¸ª{}å¯¹è±¡ å¹¶åœ¨<code>Person</code>å‡½æ•°å†…å°†<code>this</code>æŒ‡å‘è¯¥å¯¹è±¡ï¼Œ è¿™æ ·æˆ‘å°±å¯ä»¥èµ‹å€¼åƒ<code>this.name</code>è¿™æ ·çš„ä¸œè¥¿ã€‚ç„¶åæŠŠé‚£ä¸ªå¯¹è±¡è¿”å›ç»™æˆ‘ã€‚â€</strong></p>
<p>ä¸Šé¢è¿™äº›å°±æ˜¯<code>new</code>æ“ä½œç¬¦åšçš„äº‹æƒ…ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>); <span class="comment">// `Person`å†…ï¼Œç›¸åŒçš„å¯¹è±¡ä½œä¸º`this`</span></span><br></pre></td></tr></table></figure>
<p>åŒæ—¶<code>new</code>æ“ä½œç¬¦ä½¿ä¸Šé¢çš„<code>fred</code>å¯¹è±¡å¯ä»¥ä½¿ç”¨<code>Person.prototype</code>ä¸Šçš„ä»»ä½•å†…å®¹ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">Person.prototype.sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">'Hi, I am '</span> + <span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>);</span><br><span class="line">fred.sayHi();</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¹‹å‰äººä»¬åœ¨JavaScriptæ¨¡æ‹Ÿç±»çš„æ–¹å¼ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯åœ¨JavaScriptæ—©å·²æœ‰<code>new</code>ã€‚ä½†æ˜¯ï¼Œ<code>class</code>å´æ˜¯åæ¥åŠ å…¥çš„ç‰¹æ€§ã€‚ä¸ºäº†æ›´æ˜ç¡®æˆ‘ä»¬çš„æ„å›¾ï¼Œé‡å†™ä¸€ä¸‹ä»£ç ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name) &#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  sayHi() &#123;</span><br><span class="line">    alert(<span class="string">'Hi, I am '</span> + <span class="keyword">this</span>.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>);</span><br><span class="line">fred.sayHi();</span><br></pre></td></tr></table></figure></p>
<p><em>åœ¨è¯­è¨€å’ŒAPIè®¾è®¡ä¸­æŠŠæ¡å¼€å‘äººå‘˜çš„æ„å›¾éå¸¸é‡è¦ã€‚</em></p>
<p>å¦‚æœä½ ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼ŒJavaScriptå°±æ— æ³•çŒœæµ‹ä½ çš„æ„æ€æ˜¯åƒ<code>alert()</code>ä¸€æ ·è¢«ç›´æ¥è°ƒç”¨ï¼Œè¿˜æ˜¯åƒ<code>new Person()</code>é‚£æ ·å……å½“æ„é€ å‡½æ•°ã€‚å¿˜è®°æ·»åŠ <code>new</code>ä¼šå¯¼è‡´ä»¤äººå›°æƒ‘çš„æ‰§è¡Œç»“æœã€‚</p>
<p><strong>classè¯­æ³•è®©æˆ‘ä»¬æ˜ç¡®çš„å‘Šè¯‰Javascriptï¼šâ€œè¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå‡½æ•° - å®ƒæ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°â€ã€‚</strong> å¦‚æœåœ¨è°ƒç”¨classæ—¶å¿˜è®°ä½¿ç”¨<code>new</code>ï¼ŒJavaScriptæŠ›å‡ºå¼‚å¸¸ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>);</span><br><span class="line"><span class="comment">// âœ…  If Person is a function: works fine</span></span><br><span class="line"><span class="comment">// âœ…  If Person is a class: works fine too</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> george = Person(<span class="string">'George'</span>); <span class="comment">// We forgot `new`</span></span><br><span class="line"><span class="comment">// ğŸ˜³ If Person is a constructor-like function: confusing behavior</span></span><br><span class="line"><span class="comment">// ğŸ”´ If Person is a class: fails immediately</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™æœ‰åŠ©äºæˆ‘ä»¬å°½æ—©å‘ç°é”™è¯¯ï¼Œè€Œä¸æ˜¯å‡ºç°ä¸€äº›ä¸ç¬¦åˆé¢„æœŸçš„ç»“æœ æ¯”å¦‚<code>this.name</code>è¢«è§†ä¸º<code>window.name</code>è€Œä¸æ˜¯<code>george.name</code>ã€‚</p>
<p>ä½†æ˜¯ï¼Œè¿™æ„å‘³ç€<code>React</code>éœ€è¦åœ¨è°ƒç”¨ä»»ä½•classä¹‹å‰ä½¿ç”¨<code>new</code>ã€‚å®ƒä¸èƒ½åªæ˜¯å°†å…¶ä½œä¸ºæ™®é€šå‡½æ•°ç›´æ¥è°ƒç”¨ï¼Œå› ä¸ºJavaScriptä¼šå°†å…¶è§†ä¸ºé”™è¯¯ï¼<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ”´ React can't just do this:</span></span><br><span class="line"><span class="keyword">const</span> instance = Counter(props);</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ„å‘³ç€éº»çƒ¦(éº»çƒ¦å°±æ˜¯åœ¨äºReactéœ€è¦åŒºåˆ†Classå’ŒFunctionâ€¦â€¦)ã€‚</p>
<h2 id="æ¢ç©¶Reactå¼å¦‚ä½•è§£å†³çš„"><a href="#æ¢ç©¶Reactå¼å¦‚ä½•è§£å†³çš„" class="headerlink" title="æ¢ç©¶Reactå¼å¦‚ä½•è§£å†³çš„"></a>æ¢ç©¶Reactå¼å¦‚ä½•è§£å†³çš„</h2><blockquote>
<p>babelä¹‹ç±»ç¼–è¯‘å·¥å…·ç»™è§£å†³é—®é¢˜å¸¦æ¥çš„éº»çƒ¦</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬æ¢ç©¶Reactå¼å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜æ—¶ï¼Œéœ€è¦è€ƒè™‘åˆ°å¤§å¤šæ•°äººéƒ½ä½¿ç”¨Babelä¹‹ç±»çš„ç¼–è¯‘å™¨æ¥å…¼å®¹æµè§ˆå™¨ï¼ˆä¾‹å¦‚è½¬ä¹‰classç­‰ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è®¾è®¡ä¸­è€ƒè™‘ç¼–è¯‘å™¨è¿™ç§æƒ…å†µã€‚</p>
<p>åœ¨Babelçš„æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨æ²¡æœ‰<code>new</code>çš„æƒ…å†µä¸‹è°ƒç”¨ç±»ã€‚ä½†æ˜¯é€šè¿‡ç”Ÿæˆä¸€äº›é¢å¤–çš„ä»£ç ï¼Œè¿™ä¸ªæƒ…å†µå·²ç»è¢«ä¿®å¤äº†ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// A bit simplified from Babel output:</span></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Person)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"Cannot call a class as a function"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Our code:</span></span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Person(<span class="string">'Fred'</span>); <span class="comment">// âœ… Okay</span></span><br><span class="line">Person(<span class="string">'George'</span>);   <span class="comment">// ğŸ”´ Canâ€™t call class as a function</span></span><br></pre></td></tr></table></figure>
<p>ä½ æˆ–è®¸åœ¨æ‰“åŒ…æ–‡ä»¶ä¸­çœ‹åˆ°ç±»ä¼¼çš„ä»£ç ï¼Œè¿™å°±æ˜¯<code>_classCallCheck</code>å‡½æ•°æ‰€åšçš„åŠŸèƒ½ã€‚ ï¼ˆæ‚¨å¯ä»¥é€šè¿‡è®¾ç½®â€œloose modeâ€ä¸è¿›è¡Œæ£€æŸ¥æ¥å‡å°æ†ç»‘åŒ…å¤§å°ï¼Œä½†è¿™å¯èƒ½ä¼šä½¿ä»£ç æœ€ç»ˆè½¬æ¢ä¸ºçœŸæ­£çš„åŸç”Ÿç±»å˜å¾—å¤æ‚ã€‚ï¼‰</p>
<p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œä½ åº”è¯¥å¤§è‡´äº†è§£ä½¿ç”¨<code>new</code>ä¸ä¸ä½¿ç”¨<code>new</code>æ¥è°ƒç”¨æŸäº›å†…å®¹ä¹‹é—´çš„åŒºåˆ«ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th><code>new Person()</code></th>
<th><code>Person()</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>class</code></td>
<td>âœ… <code>this</code> is a <code>Person</code> instance</td>
<td>ğŸ”´ <code>TypeError</code></td>
</tr>
<tr>
<td><code>function</code></td>
<td>âœ… <code>this</code> is a <code>Person</code> instance</td>
<td>ğŸ˜³ <code>this</code> is <code>window</code> or <code>undefined</code></td>
</tr>
</tbody>
</table>
<p>è¿™ä¹‹ä¸­çš„åŒºåˆ«å°±æ˜¯Reactä¸ºä»€ä¹ˆéœ€è¦æ­£ç¡®è°ƒç”¨ç»„ä»¶çš„é‡è¦åŸå› ã€‚ <strong>å¦‚æœæ‚¨çš„ç»„ä»¶è¢«å®šä¹‰ä¸ºç±»ï¼ŒReactåœ¨è°ƒç”¨å®ƒæ—¶éœ€è¦ä½¿ç”¨<code>new</code>ã€‚</strong></p>
<p><strong>é‚£ä¹ˆé—®é¢˜æ¥äº† Reactæ˜¯å¦å¯ä»¥åˆ¤æ–­æŸä¸ªä¸œè¥¿æ˜¯ä¸æ˜¯ä¸€ä¸ªclassï¼Ÿ</strong></p>
<p>æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼å³ä½¿æˆ‘ä»¬å¯ä»¥<a href="https://stackoverflow.com/questions/29093396/how-do-you-check-the-difference-between-an-ecmascript-6-class-and-function" target="_blank" rel="noopener">åœ¨JavaScript es6 ä¸­åŒºåˆ«class å’Œ function</a>ï¼Œè¿™ä»ç„¶ä¸é€‚ç”¨äºåƒBabelè¿™æ ·çš„å·¥å…·å¤„ç†ä¹‹åçš„classã€‚å› ä¸ºå¯¹äºæµè§ˆå™¨æ¥è¯´ï¼Œå®ƒä»¬åªæ˜¯å•çº¯çš„functionè€Œå·²ï¼ˆclassè¢«babelå¤„ç†åï¼‰ã€‚ </p>
<hr>
<p>Okayï¼Œä¹Ÿè®¸Reactå¯ä»¥åœ¨æ¯æ¬¡è°ƒç”¨æ—¶ä½¿ç”¨<code>new</code>ï¼Ÿä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¹Ÿå¹¶ä¸æ€»æ˜¯å¥æ•ˆã€‚</p>
<h3 id="å¼‚å¸¸æƒ…å†µä¸€ï¼š"><a href="#å¼‚å¸¸æƒ…å†µä¸€ï¼š" class="headerlink" title="å¼‚å¸¸æƒ…å†µä¸€ï¼š"></a>å¼‚å¸¸æƒ…å†µä¸€ï¼š</h3><p>ä½œä¸ºä¸€èˆ¬functionï¼Œä½¿ç”¨<code>new</code>è°ƒç”¨å®ƒä»¬ä¼šä¸ºå®ƒä»¬æä¾›ä¸€ä¸ªå¯¹è±¡å®ä¾‹ä½œä¸º<code>this</code>ã€‚å¯¹äºä½œä¸ºæ„é€ å‡½æ•°ç¼–å†™çš„å‡½æ•°ï¼ˆå¦‚ä¸Šé¢çš„<code>Person</code>ï¼‰ï¼Œå®ƒæ˜¯ç†æƒ³çš„ï¼Œä½†å®ƒä¼šç»™å‡½æ•°ç»„ä»¶å¸¦æ¥æ··ä¹±ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Greeting</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// æˆ‘ä»¬ä¸å¸Œæœ›â€œthisâ€åœ¨è¿™é‡Œæˆä¸ºä»»ä½•ä¸€ç§æƒ…å†µä¸‹çš„å®ä¾‹</span></span><br><span class="line">  <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è™½ç„¶è¿™ç§æƒ…å†µä¹Ÿæ˜¯å¯ä»¥å®¹å¿çš„ï¼Œä½†è¿˜æœ‰å¦å¤–ä¸¤ä¸ªåŸå› å¯ä»¥æ‰¼æ€ä¸€ç›´ä½¿ç”¨<code>new</code>çš„æƒ³æ³•ã€‚</p>
<h3 id="å¼‚å¸¸æƒ…å†µäºŒï¼š"><a href="#å¼‚å¸¸æƒ…å†µäºŒï¼š" class="headerlink" title="å¼‚å¸¸æƒ…å†µäºŒï¼š"></a>å¼‚å¸¸æƒ…å†µäºŒï¼š</h3><p>ç¬¬ä¸€ä¸ªæ˜¯ç®­å¤´å‡½æ•°ï¼ˆæœªè¢«babelç¼–è¯‘æ—¶ï¼‰ä¼šä½¿<code>new</code>è°ƒç”¨å¤±æ•ˆï¼Œä½¿ç”¨<code>new</code>è°ƒç”¨ç®­å¤´å‡½æ•°ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Greeting = <span class="function"><span class="params">()</span> =&gt;</span> &lt;p&gt;Hello&lt;<span class="regexp">/p&gt;;</span></span><br><span class="line"><span class="regexp">new Greeting(); /</span><span class="regexp">/ ğŸ”´ Greeting is not a constructor</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™ç§æƒ…å†µæ—¶æ˜¯æœ‰æ„çš„ï¼Œå¹¶ä¸”éµå¾ªç®­å¤´å‡½æ•°çš„è®¾è®¡ã€‚ç®­å¤´å‡½æ•°çš„ä¸»è¦ä¼˜ç‚¹ä¹‹ä¸€æ˜¯å®ƒä»¬æ²¡æœ‰è‡ªå·±çš„<code>this</code>ç»‘å®š - å–è€Œä»£ä¹‹çš„æ˜¯ <code>this</code>è¢«ç»‘å®šåˆ°æœ€è¿‘çš„å‡½æ•°ä½“ä¸­ã€‚<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Friends</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> friends = <span class="keyword">this</span>.props.friends;</span><br><span class="line">    <span class="keyword">return</span> friends.map(<span class="function"><span class="params">friend</span> =&gt;</span></span><br><span class="line">      &lt;Friend</span><br><span class="line">        <span class="comment">// `this` is resolved from the `render` method</span></span><br><span class="line">        size=&#123;<span class="keyword">this</span>.props.size&#125;</span><br><span class="line">        name=&#123;friend.name&#125;</span><br><span class="line">        key=&#123;friend.id&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Okayï¼Œæ‰€ä»¥<strong>ç®­å¤´åŠŸèƒ½æ²¡æœ‰è‡ªå·±çš„<code>this</code>ã€‚</strong> è¿™æ„å‘³ç€ç®­å¤´å‡½æ•°æ— æ³•æˆä¸ºæ„é€ è€…ï¼</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Person = <span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// ğŸ”´ This wouldnâ€™t make sense!</span></span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼ŒJavaScriptä¸å…è®¸ä½¿ç”¨<code>new</code>è°ƒç”¨ç®­å¤´å‡½æ•°ã€‚å¦‚æœä½ è¿™æ ·åšï¼Œåªä¼šäº§ç”Ÿé”™è¯¯ã€‚è¿™ç±»ä¼¼äºJavaScriptä¸å…è®¸åœ¨æ²¡æœ‰<code>new</code>çš„æƒ…å†µä¸‹è°ƒç”¨ç±»çš„æ–¹å¼ã€‚</p>
<p>è¿™å¾ˆä¸é”™ï¼Œä½†å®ƒä¹Ÿä½¿æˆ‘ä»¬åœ¨å…¨éƒ¨å‡½æ•°è°ƒç”¨å‰æ·»åŠ newçš„è®¡åˆ’å¤±è´¥ã€‚ Reactä¸å¯ä»¥åœ¨æ‰€æœ‰æƒ…å†µä¸‹è°ƒç”¨newï¼Œå› ä¸ºå®ƒä¼šç ´åç®­å¤´å‡½æ•°ï¼æˆ‘ä»¬å¯ä»¥å°è¯•é€šè¿‡ç¼ºå°‘<code>prototype</code>æ¥åˆ¤æ–­å‡ºç®­å¤´å‡½æ•°ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;).prototype <span class="comment">// undefined</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;).prototype <span class="comment">// &#123;constructor: f&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯è¿™ä¸ª<a href="https://github.com/facebook/react/issues/4599#issuecomment-136562930" target="_blank" rel="noopener">ä¸é€‚ç”¨</a>äºä½¿ç”¨<code>babel</code>ç¼–è¯‘çš„å‡½æ•°ã€‚è¿™å¯èƒ½ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†è¿˜æœ‰å¦ä¸€ä¸ªåŸå› è®©è¿™ç§æ–¹æ³•å¤±è´¥ã€‚</p>
<h3 id="å¼‚å¸¸æƒ…å†µä¸‰ï¼š"><a href="#å¼‚å¸¸æƒ…å†µä¸‰ï¼š" class="headerlink" title="å¼‚å¸¸æƒ…å†µä¸‰ï¼š"></a>å¼‚å¸¸æƒ…å†µä¸‰ï¼š</h3><p>æˆ‘ä»¬ä¸èƒ½æ€»æ˜¯ä½¿ç”¨<code>new</code>çš„å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œè¿™æ ·åšä¸æ”¯æŒè¿”å›å­—ç¬¦ä¸²æˆ–å…¶ä»–åŸå§‹ç±»å‹ã€‚<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Greeting</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'Hello'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Greeting(); <span class="comment">// âœ… 'Hello'</span></span><br><span class="line"><span class="keyword">new</span> Greeting(); <span class="comment">// ğŸ˜³ Greeting &#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™å†æ¬¡ä¸<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/new" target="_blank" rel="noopener"><code>new</code>çš„è®¾è®¡</a>å¥‡æ€ªè¡¨ç°æœ‰å…³ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„é‚£æ ·ï¼Œ<code>new</code>å‘Šè¯‰JavaScriptå¼•æ“åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨å‡½æ•°å†…éƒ¨åˆ›å»ºè¯¥å¯¹è±¡ï¼Œç„¶åå°†è¯¥å¯¹è±¡ä½œä¸º<code>new</code>çš„ç»“æœã€‚<br>ä½†æ˜¯ï¼ŒJavaScriptè¿˜å…è®¸ä½¿ç”¨<code>new</code>è°ƒç”¨çš„å‡½æ•°é€šè¿‡è¿”å›ä¸€äº›å…¶ä»–å¯¹è±¡æ¥è¦†ç›–<code>new</code>çš„è¿”å›å€¼ã€‚è¿™å¯èƒ½å¯¹ç±»ä¼¼å¯¹è±¡æ± è¿™æ ·çš„æ¨¡å¼å¾ˆæœ‰ç”¨ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Created lazily</span></span><br><span class="line"><span class="keyword">var</span> zeroVector = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vector</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (x === <span class="number">0</span> &amp;&amp; y === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (zeroVector !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Reuse the same instance</span></span><br><span class="line">      <span class="keyword">return</span> zeroVector;</span><br><span class="line">    &#125;</span><br><span class="line">    zeroVector = <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.x = x;</span><br><span class="line">  <span class="keyword">this</span>.y = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="keyword">new</span> Vector(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> Vector(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> Vector(<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// ğŸ˜² b === c</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œå¦‚æœå‡½æ•°çš„è¿”å›å€¼ä¸æ˜¯å¯¹è±¡ï¼Œ<code>new</code>ä¼šå®Œå…¨å¿½ç•¥å‡½æ•°çš„è¿”å›å€¼ã€‚å¦‚æœä½ è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–ä¸€ä¸ªæ•°å­—ï¼Œå°±å¥½åƒæ²¡æœ‰è¿”å›ä¸€æ ·ã€‚<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Answer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Answer(); <span class="comment">// âœ… 42</span></span><br><span class="line"><span class="keyword">new</span> Answer(); <span class="comment">// ğŸ˜³ Answer &#123;&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>å½“ä½¿ç”¨<code>new</code>è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ— æ³•ä»å‡½æ•°ä¸­è¯»å–åŸå§‹è¿”å›å€¼ï¼ˆå¦‚æ•°å­—æˆ–å­—ç¬¦ä¸²ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœReactæ€»æ˜¯ä½¿ç”¨newï¼Œå®ƒå°†æ— æ³•æ”¯æŒè¿”å›å­—ç¬¦ä¸²ç±»å‹çš„å‡½æ•°ï¼ˆç»„ä»¶ï¼‰</p>
<p>è¿™æ˜¯ä¸å¯æ¥å—çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—å¦å¯»ä»–æ³•ã€‚</p>
<h3 id="è§£å†³æ–¹å¼"><a href="#è§£å†³æ–¹å¼" class="headerlink" title="è§£å†³æ–¹å¼"></a>è§£å†³æ–¹å¼</h3><p><strong>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬äº†è§£åˆ°äº†ä»€ä¹ˆï¼Ÿ</strong>  Reactéœ€è¦ç”¨<code>new</code>è°ƒç”¨ç±»ï¼ˆå…¼å®¹<code>Babel</code>æƒ…å†µï¼‰ï¼Œä½†å®ƒéœ€è¦è°ƒç”¨å¸¸è§„å‡½æ•°æˆ–ç®­å¤´å‡½æ•°ï¼ˆå…¼å®¹Babelï¼‰æ—¶ä¸èƒ½ä½¿ç”¨<code>new</code>ã€‚åŒæ—¶å¹¶æ²¡æœ‰å¯é çš„æ–¹æ³•æ¥åŒºåˆ†å®ƒä»¬ã€‚<br><strong>å¦‚æœæˆ‘ä»¬æ— æ³•è§£å†³ä¸€ä¸ªæ™®éé—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½è§£å†³ä¸€ä¸ªæ›´å…·ä½“çš„é—®é¢˜å—ï¼Ÿ</strong></p>
<p>å°†Componentå®šä¹‰ä¸ºclassæ—¶ï¼Œä½ å¯èƒ½å¸Œæœ›ç»§æ‰¿<code>React.Component</code>ä½¿ç”¨å…¶å†…ç½®æ–¹æ³•ï¼ˆæ¯”å¦‚<code>this.setState()</code>ï¼‰ã€‚<strong>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åªæ£€æµ‹React.Componentå­ç±»ï¼Œè€Œä¸æ˜¯å°è¯•æ£€æµ‹æ‰€æœ‰classå—ï¼Ÿ</strong></p>
<p><em>å‰§é€ï¼šè¿™æ­£æ˜¯Reactæ‰€åšçš„ã€‚</em></p>
<h4 id="prototype-ä¸-proto"><a href="#prototype-ä¸-proto" class="headerlink" title="prototype ä¸ __proto__"></a><code>prototype</code> ä¸ <code>__proto__</code></h4><p>ä¹Ÿè®¸ï¼Œåˆ¤æ–­<code>Greeting</code>æ˜¯å¦æ˜¯React component classçš„ä¸€èˆ¬æ–¹æ³•æ˜¯æµ‹è¯•<code>Greeting.prototype instanceof React.Component</code>ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(B.prototype <span class="keyword">instanceof</span> A); <span class="comment">// true</span></span><br></pre></td></tr></table></figure></p>
<p>æˆ‘çŸ¥é“ä½ åœ¨æƒ³ä»€ä¹ˆã€‚åˆšåˆšå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£JavaScriptåŸå‹ã€‚</p>
<p>ä½ å¯èƒ½ç†Ÿæ‚‰åŸå‹é“¾ã€‚JavaScriptä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½å¯èƒ½æœ‰ä¸€ä¸ªâ€œåŸå‹â€ã€‚å½“æˆ‘ä»¬ç¼–å†™<code>fred.sayHiï¼ˆï¼‰</code>ä½†<code>fred</code>å¯¹è±¡æ²¡æœ‰<code>sayHi</code>å±æ€§æ—¶ï¼Œæˆ‘ä»¬åœ¨<code>fred</code>çš„åŸå‹ä¸ŠæŸ¥æ‰¾<code>sayHi</code>å±æ€§ã€‚å¦‚æœæˆ‘ä»¬åœ¨é‚£é‡Œæ‰¾ä¸åˆ°å®ƒï¼Œæˆ‘ä»¬ä¼šçœ‹çœ‹é“¾ä¸­çš„ä¸‹ä¸€ä¸ªåŸå‹â€“<code>fred</code>çš„åŸå‹çš„åŸå‹ã€‚å¹¶ä»¥æ­¤ç±»æ¨ã€‚</p>
<p><strong>ä»¤äººå›°æƒ‘çš„æ˜¯ï¼Œç±»æˆ–å‡½æ•°çš„prototypeå±æ€§å¹¶ä¸æŒ‡å‘è¯¥å€¼çš„åŸå‹ã€‚</strong> æˆ‘ä¸æ˜¯åœ¨å¼€ç©ç¬‘ã€‚<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Person.prototype); <span class="comment">// ğŸ¤ª Not Person's prototype</span></span><br><span class="line"><span class="built_in">console</span>.log(Person.__proto__); <span class="comment">// ğŸ˜³ Person's prototype</span></span><br></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥â€œåŸå‹é“¾â€æ›´åƒæ˜¯<code>__proto __.__ proto __.__ proto__</code>è€Œä¸æ˜¯<code>prototype.prototype.prototype</code>ã€‚æˆ‘èŠ±äº†è®¸å¤šå¹´æ‰äº†è§£åˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p><strong>æ‰€æœ‰å¯¹è±¡çš„ <code>__proto__</code> éƒ½æŒ‡å‘å…¶æ„é€ å™¨çš„prototype</strong> å‡½æ•°æˆ–ç±»çš„<code>prototype</code>å±æ€§å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¸œè¥¿<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line">Person.prototype.sayHi = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">'Hi, I am '</span> + <span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fred = <span class="keyword">new</span> Person(<span class="string">'Fred'</span>); <span class="comment">// Sets `fred.__proto__` to `Person.prototype`</span></span><br></pre></td></tr></table></figure></p>
<p>è€Œ<code>__proto__</code>é“¾æ˜¯JavaScriptæŸ¥æ‰¾å±æ€§çš„æ–¹å¼ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">fred.sayHi();</span><br><span class="line"><span class="comment">// 1. Does fred have a sayHi property? No.</span></span><br><span class="line"><span class="comment">// 2. Does fred.__proto__ have a sayHi property? Yes. Call it!</span></span><br><span class="line"></span><br><span class="line">fred.toString();</span><br><span class="line"><span class="comment">// 1. Does fred have a toString property? No.</span></span><br><span class="line"><span class="comment">// 2. Does fred.__proto__ have a toString property? No.</span></span><br><span class="line"><span class="comment">// 3. Does fred.__proto__.__proto__ have a toString property? Yes. Call it!</span></span><br></pre></td></tr></table></figure></p>
<p>äº‹å®ä¸Šï¼Œé™¤éæ‚¨æ­£åœ¨è°ƒè¯•ä¸åŸå‹é“¾ç›¸å…³çš„å†…å®¹ï¼Œå¦åˆ™æ‚¨å‡ ä¹ä¸éœ€è¦ç›´æ¥åœ¨ä»£ç ä¸­ä¿®æ”¹<code>__proto__</code>ã€‚å¦‚æœä½ æƒ³åœ¨<code>fred .__ proto__</code>ä¸Šæ·»åŠ ä¸œè¥¿ï¼Œä½ åº”è¯¥æŠŠå®ƒæ”¾åœ¨<code>Person.prototype</code>ä¸Šã€‚å®ƒæœ€åˆå°±æ˜¯è¿™ä¹ˆè®¾è®¡çš„ã€‚</p>
<p>ç”šè‡³æµè§ˆå™¨éƒ½ä¸åº”è¯¥æš´éœ²<code>__proto__</code>å±æ€§ï¼Œå› ä¸ºåŸå‹é“¾è¢«è®¾è®¡ä¸ºä¸€ä¸ªå†…éƒ¨æ¦‚å¿µã€‚ä½†æ˜¯æœ‰äº›æµè§ˆå™¨æ·»åŠ äº†<code>__proto__</code>ï¼Œæœ€ç»ˆå®ƒè¢«å‹‰å¼ºæ ‡å‡†åŒ–ã€‚</p>
<p>è‡³ä»Šæˆ‘ä»ç„¶è§‰å¾—â€œ<code>prototype</code>çš„å±æ€§æ²¡æœ‰ç»™ä½ ä¸€ä¸ªå€¼çš„åŸå‹â€œéå¸¸ä»¤äººå›°æƒ‘ï¼ˆä¾‹å¦‚ï¼Œ<code>fred.prototype</code>æœªå®šä¹‰ï¼Œå› ä¸º<code>fred</code>ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼‰ã€‚å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯å¯¼è‡´ç»éªŒä¸°å¯Œçš„å¼€å‘äººå‘˜ä¹Ÿä¼šè¯¯è§£JavaScriptåŸå‹çš„æœ€å¤§åŸå› ã€‚</p>
<h4 id="extends-ä¸-åŸå‹é“¾"><a href="#extends-ä¸-åŸå‹é“¾" class="headerlink" title="extends ä¸ åŸå‹é“¾"></a>extends ä¸ åŸå‹é“¾</h4><p>è¿™å¸–å­æœ‰ç‚¹é•¿ ä¸æ˜¯å—ï¼Ÿåˆ«æ”¾å¼ƒï¼ç°åœ¨å·²ç»è®²äº†80%çš„å†…å®¹äº†ï¼Œè®©æˆ‘ä»¬ç»§ç»­å§</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“è¯´è°ƒç”¨<code>obj.foo</code>æ—¶ï¼ŒJavaScriptå®é™…ä¸Šåœ¨<code>obj</code>ï¼Œ<code>obj .__ proto__</code>ï¼Œ<code>obj .__ proto __.__ proto__</code>ä¸­å¯»æ‰¾<code>foo</code>ï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>å¯¹äºç±»æ¥è¯´åŸå‹é“¾æœºåˆ¶ä¼šæ›´åŠ å¤æ‚ï¼Œä½†<code>extends</code>ä¼šä½¿ç±»å®Œç¾é€‚ç”¨åŸå‹é“¾æœºåˆ¶ã€‚è¿™ä¹Ÿæ˜¯Reactç±»çš„å®ä¾‹è®¿é—®<code>setState</code>ä¹‹ç±»çš„æ–¹æ³•çš„åŸç†ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;p&gt;Hello&lt;/p&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> c = <span class="keyword">new</span> Greeting();</span><br><span class="line"><span class="built_in">console</span>.log(c.__proto__); <span class="comment">// Greeting.prototype</span></span><br><span class="line"><span class="built_in">console</span>.log(c.__proto__.__proto__); <span class="comment">// React.Component.prototype</span></span><br><span class="line"><span class="built_in">console</span>.log(c.__proto__.__proto__.__proto__); <span class="comment">// Object.prototype</span></span><br><span class="line"></span><br><span class="line">c.render();      <span class="comment">// Found on c.__proto__ (Greeting.prototype)</span></span><br><span class="line">c.setState();    <span class="comment">// Found on c.__proto__.__proto__ (React.Component.prototype)</span></span><br><span class="line">c.toString();    <span class="comment">// Found on c.__proto__.__proto__.__proto__ (Object.prototype)</span></span><br></pre></td></tr></table></figure></p>
<p>æ¢å¥è¯è¯´ï¼Œç±»å®ä¾‹çš„<code>__protp__</code>é“¾ä¼šé•œåƒæ‹·è´ç±»çš„ç»§æ‰¿å…³ç³»ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// `extends` chain</span></span><br><span class="line">Greeting</span><br><span class="line">  â†’ React.Component</span><br><span class="line">    â†’ <span class="built_in">Object</span> (implicitly)</span><br><span class="line"></span><br><span class="line"><span class="comment">// `__proto__` chain</span></span><br><span class="line"><span class="keyword">new</span> Greeting()</span><br><span class="line">  â†’ Greeting.prototype</span><br><span class="line">    â†’ React.Component.prototype</span><br><span class="line">      â†’ <span class="built_in">Object</span>.prototype</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æ­¤ä¸¤ä¸ªé“¾ï¼ˆç»§æ‰¿é“¾ åŸå‹é“¾ï¼‰</p>
<h4 id="instanceof-åˆ¤æ–­æ–¹å¼"><a href="#instanceof-åˆ¤æ–­æ–¹å¼" class="headerlink" title="instanceof åˆ¤æ–­æ–¹å¼"></a>instanceof åˆ¤æ–­æ–¹å¼</h4><p>ç”±äº<code>__proto__</code>é“¾é•œåƒæ‹·è´ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>Greeting</code>çš„åŸå‹é“¾æ¥åˆ¤æ–­<code>Greeting</code>æ˜¯å¦ç»§æ‰¿äº†<code>React.Component</code>ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// `__proto__` chain</span></span><br><span class="line"><span class="keyword">new</span> Greeting()</span><br><span class="line">  â†’ Greeting.prototype <span class="comment">// ğŸ•µï¸ We start here</span></span><br><span class="line">    â†’ React.Component.prototype <span class="comment">// âœ… Found it!</span></span><br><span class="line">      â†’ <span class="built_in">Object</span>.prototype</span><br></pre></td></tr></table></figure></p>
<p>æ–¹ä¾¿çš„æ˜¯ï¼Œ<code>x instanceof Y</code>å°±æ˜¯ç›¸åŒçš„æœç´¢åŸç†ã€‚å®ƒåœ¨<code>x .__ proto__</code>é“¾ä¸­å¯»æ‰¾æ˜¯å¦æœ‰<code>Y.prototype</code>å­˜åœ¨ã€‚</p>
<p>é€šå¸¸ï¼Œå®ƒç”¨äºç¡®å®šæŸäº›ä¸œè¥¿æ˜¯å¦æ˜¯ç±»çš„å®ä¾‹ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> greeting = <span class="keyword">new</span> Greeting();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(greeting <span class="keyword">instanceof</span> Greeting); <span class="comment">// true</span></span><br><span class="line"><span class="comment">// greeting (ğŸ•µï¸â€ We start here)</span></span><br><span class="line"><span class="comment">//   .__proto__ â†’ Greeting.prototype (âœ… Found it!)</span></span><br><span class="line"><span class="comment">//     .__proto__ â†’ React.Component.prototype </span></span><br><span class="line"><span class="comment">//       .__proto__ â†’ Object.prototype</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(greeting <span class="keyword">instanceof</span> React.Component); <span class="comment">// true</span></span><br><span class="line"><span class="comment">// greeting (ğŸ•µï¸â€ We start here)</span></span><br><span class="line"><span class="comment">//   .__proto__ â†’ Greeting.prototype</span></span><br><span class="line"><span class="comment">//     .__proto__ â†’ React.Component.prototype (âœ… Found it!)</span></span><br><span class="line"><span class="comment">//       .__proto__ â†’ Object.prototype</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(greeting <span class="keyword">instanceof</span> <span class="built_in">Object</span>); <span class="comment">// true</span></span><br><span class="line"><span class="comment">// greeting (ğŸ•µï¸â€ We start here)</span></span><br><span class="line"><span class="comment">//   .__proto__ â†’ Greeting.prototype</span></span><br><span class="line"><span class="comment">//     .__proto__ â†’ React.Component.prototype</span></span><br><span class="line"><span class="comment">//       .__proto__ â†’ Object.prototype (âœ… Found it!)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(greeting <span class="keyword">instanceof</span> Banana); <span class="comment">// false</span></span><br><span class="line"><span class="comment">// greeting (ğŸ•µï¸â€ We start here)</span></span><br><span class="line"><span class="comment">//   .__proto__ â†’ Greeting.prototype</span></span><br><span class="line"><span class="comment">//     .__proto__ â†’ React.Component.prototype </span></span><br><span class="line"><span class="comment">//       .__proto__ â†’ Object.prototype (ğŸ™…â€ Did not find it!)</span></span><br></pre></td></tr></table></figure></p>
<p>ä½†å®ƒä¹Ÿå¯ä»¥ç”¨äºç¡®å®šä¸€ä¸ªç±»æ˜¯å¦ç»§æ‰¿å¦ä¸€ä¸ªç±»ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(Greeting.prototype <span class="keyword">instanceof</span> React.Component);</span><br><span class="line"><span class="comment">// greeting</span></span><br><span class="line"><span class="comment">//   .__proto__ â†’ Greeting.prototype (ğŸ•µï¸â€ We start here)</span></span><br><span class="line"><span class="comment">//     .__proto__ â†’ React.Component.prototype (âœ… Found it!)</span></span><br><span class="line"><span class="comment">//       .__proto__ â†’ Object.prototype</span></span><br></pre></td></tr></table></figure></p>
<p>è¿™ç§åˆ¤æ–­æ–¹å¼å°±æ˜¯æ˜¯æˆ‘ä»¬å¦‚ä½•ç¡®å®šæŸäº›ä¸œè¥¿æ˜¯Reactç»„ä»¶ç±»è¿˜æ˜¯ä¸€èˆ¬å‡½æ•°ã€‚</p>
<h4 id="React-åˆ¤æ–­æ–¹å¼"><a href="#React-åˆ¤æ–­æ–¹å¼" class="headerlink" title="React åˆ¤æ–­æ–¹å¼"></a>React åˆ¤æ–­æ–¹å¼</h4><p>ä½†è¿™å¹¶ä¸æ˜¯Reactæ‰€åšçš„ã€‚ ğŸ˜³</p>
<p><code>instanceof</code>è§£å†³æ–¹æ¡ˆçš„ä¸€ä¸ªéšæ‚£æ˜¯ï¼šå½“é¡µé¢ä¸Šæœ‰å¤šä¸ªReactå‰¯æœ¬æ—¶ï¼Œæˆ‘ä»¬æ­£åœ¨æ£€æŸ¥çš„ç»„ä»¶å¯èƒ½ç»§æ‰¿è‡ªå¦ä¸€ä¸ªReactå‰¯æœ¬çš„React.Componentï¼Œè¿™ç§instanceofæ–¹å¼å°±ä¼šå¤±æ•ˆã€‚<br>åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­æ··åˆä½¿ç”¨Reactçš„å¤šä¸ªå‰¯æœ¬æ˜¯ä¸å¥½çš„æ–¹å¼ï¼Œä½†æˆ‘ä»¬åº”è¯¥å°½å¯èƒ½é¿å…å‡ºç°ç”±äºå†å²é—ç•™æ‰€äº§ç”Ÿçš„è¿™ç§é—®é¢˜ã€‚ ï¼ˆä½¿ç”¨Hooksï¼Œæˆ‘ä»¬<a href="https://github.com/facebook/react/issues/13991" target="_blank" rel="noopener">å¯èƒ½éœ€è¦</a>å¼ºåˆ¶åˆ é™¤é‡å¤æ•°æ®ã€‚ï¼‰</p>
<p>å¦ä¸€ç§å¯èƒ½çš„éªšæ“ä½œæ˜¯æ£€æŸ¥åŸå‹ä¸Šæ˜¯å¦å­˜åœ¨<code>render</code>æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œå½“æ—¶è¿˜<a href="https://github.com/facebook/react/issues/4599#issuecomment-129714112" target="_blank" rel="noopener">ä¸æ¸…æ¥š</a>ç»„ä»¶APIå°†å¦‚ä½•å˜æ¢ã€‚æ¯ä¸ªåˆ¤æ–­æ“ä½œéƒ½æœ‰æˆæœ¬æˆ‘ä»¬ä¸æƒ³æ·»åŠ å¤šäºä¸€æ¬¡çš„æ“ä½œã€‚å¦‚æœå°†renderå®šä¹‰ä¸ºå®ä¾‹æ–¹æ³•ï¼ˆä¾‹å¦‚ä½¿ç”¨ç±»å±æ€§è¯­æ³•ï¼‰ï¼Œè¿™ä¹Ÿä¸èµ·ä½œç”¨ã€‚</p>
<p>å› æ­¤ï¼ŒReactä¸ºåŸºæœ¬ç»„ä»¶<a href="https://github.com/facebook/react/pull/4663" target="_blank" rel="noopener">æ·»åŠ </a>äº†ä¸€ä¸ªç‰¹æ®Šæ ‡å¿—ã€‚Reacté€šè¿‡æ£€æŸ¥æ˜¯è¯¥æ ‡å¿—æ¥åˆ¤æ–­ä¸€ä¸ªä¸œè¥¿æ˜¯å¦æ˜¯Reactç»„ä»¶ç±»ã€‚</p>
<p>æœ€åˆè¯¥æ ‡å¿—åœ¨React.ComponentåŸºç¡€ç±»æœ¬èº«ä¸Šï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Inside React</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line">Component.isReactClass = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We can check it like this</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Greeting.isReactClass); <span class="comment">// âœ… Yes</span></span><br></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬æƒ³è¦åˆ¤æ–­çš„ä¸€äº›ç±»å®ç°æ²¡æœ‰<a href="https://github.com/scala-js/scala-js/issues/1900" target="_blank" rel="noopener">å¤åˆ¶</a>é™æ€å±æ€§ï¼ˆæˆ–è®¾ç½®<code>__proto__</code>ï¼‰ï¼Œå› æ­¤æ ‡å¿—ä¸¢å¤±äº†ã€‚</p>
<p>è¿™å°±æ˜¯Reactå°†æ­¤æ ‡å¿—ç§»åŠ¨åˆ°<code>React.Component.prototype</code>çš„åŸå› ï¼š<br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Inside React</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line">Component.prototype.isReactComponent = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We can check it like this</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Greeting.prototype.isReactComponent); <span class="comment">// âœ… Yes</span></span><br></pre></td></tr></table></figure></p>
<p><strong>è¿™å°±æ˜¯Reactå¦‚ä½•åˆ¤æ–­classçš„å…¨éƒ¨å†…å®¹ã€‚</strong></p>
<hr>
<p>å¦‚ä»Šåœ¨Reactä¸­ä½¿ç”¨å°±æ˜¯<code>isReactComponent</code>æ ‡å¿—æ£€æŸ¥ã€‚</p>
<p>å¦‚æœä¸æ‰©å±•React.Componentï¼ŒReactå°†ä¸ä¼šåœ¨åŸå‹ä¸Šæ‰¾åˆ°<code>isReactComponent</code>ï¼Œä¹Ÿä¸ä¼šå°†ç»„ä»¶è§†ä¸ºç±»ã€‚ç°åœ¨ä½ çŸ¥é“ä¸ºä»€ä¹ˆ<code>Cannot call a class as a function</code>é—®é¢˜<a href="https://stackoverflow.com/questions/38481857/getting-cannot-call-a-class-as-a-function-in-my-react-project/42680526#42680526" target="_blank" rel="noopener">æœ€å—æ¬¢è¿çš„å›ç­”</a>æ˜¯æ·»åŠ <code>extends React.Component</code>ã€‚æœ€åï¼Œæ·»åŠ äº†ä¸€ä¸ª<code>prototype.render</code>å­˜åœ¨æ—¶ï¼Œä½†<code>prototype.isReactComponent</code>ä¸å­˜åœ¨çš„<a href="https://github.com/facebook/react/pull/11168" target="_blank" rel="noopener">è­¦å‘Š</a>ã€‚</p>
<p><strong>å®é™…çš„è§£å†³æ–¹æ¡ˆéå¸¸ç®€å•ï¼Œä½†æˆ‘ç”¨å¤§é‡çš„æ—¶é—´è§£é‡Šäº†ä¸ºä»€ä¹ˆReactæœ€ç»ˆé‡‡å–è¿™ä¸ªè§£å†³æ–¹æ¡ˆï¼Œä»¥åŠæ›¿ä»£æ–¹æ¡ˆæ˜¯ä»€ä¹ˆã€‚</strong> ä½ å¯èƒ½è§‰å¾—åšæ–‡è¿™ä¸ªè§£é‡Šè¿‡ç¨‹æœ‰ç‚¹å•°å—¦ï¼Œ</p>
<p>æ ¹æ®æˆ‘çš„ç»éªŒï¼Œå¼€å‘åº“APIç»å¸¸ä¼šé‡åˆ°è¿™ç§æƒ…å†µã€‚ä¸ºäº†ä½¿APIæ˜“äºä½¿ç”¨ï¼Œå¼€å‘è€…éœ€è¦è€ƒè™‘è¯­è¨€è¯­ä¹‰ï¼ˆå¯èƒ½ï¼Œå¯¹äºå¤šç§è¯­è¨€ï¼ŒåŒ…æ‹¬æœªæ¥çš„æ–¹å‘ï¼‰ã€è¿è¡Œæ—¶æ€§èƒ½ã€æ˜¯å¦ç¼–è¯‘æƒ…å†µçš„å…¼å®¹ã€å®Œæ•´ä½“ç³»å’Œæ‰“åŒ…è§£å†³æ–¹æ¡ˆçš„çŠ¶æ€ã€ æ—©æœŸé¢„è­¦å’Œè®¸å¤šå…¶ä»–äº‹æƒ…ã€‚ æœ€ç»ˆç»“æœå¯èƒ½å¹¶ä¸ä¼˜é›…ï¼Œä½†å¿…é¡»å®ç”¨ã€‚</p>
<p><strong>å¦‚æœæœ€ç»ˆAPIæ˜¯æˆåŠŸçš„ï¼Œåˆ™ç”¨æˆ·æ°¸è¿œä¸å¿…è€ƒè™‘æ­¤è¿‡ç¨‹ã€‚</strong> å–è€Œä»£ä¹‹çš„æ˜¯ä»–ä»¬åªéœ€è¦ä¸“æ³¨äºåˆ›å»ºåº”ç”¨ç¨‹åºã€‚</p>
<p>ä½†å¦‚æœä½ ä¹Ÿå¥½å¥‡â€¦â€¦å»æ¢ç©¶å…¶ä¸­çš„åŸå› è¿˜æ˜¯ååˆ†æœ‰è¶£çš„ã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>è¯‘æ–‡</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
      </tags>
  </entry>
  <entry>
    <title>CoreLocation æ•™ç¨‹</title>
    <url>/essay/CoreLocation/</url>
    <content><![CDATA[<h1 id="CoreLocation-iOSå®šä½"><a href="#CoreLocation-iOSå®šä½" class="headerlink" title="CoreLocation - iOSå®šä½"></a>CoreLocation - iOSå®šä½</h1><p>ä½¿ç”¨ <a href="https://developer.apple.com/documentation/corelocation" target="_blank" rel="noopener">CoreLocation</a> æ¡†æ¶å®šä½ï¼ŒåŸºæœ¬åˆ†ä¸ºæƒé™è·å–,ä½ç½®æ›´æ–°ï¼ŒåŒºåŸŸæ£€æµ‹ï¼ŒiBeacon,æ–¹å‘æ£€æµ‹ï¼Œåœ°ç†ç¼–ç å‡ æ–¹é¢ã€‚</p>
<p>demoé“¾æ¥ï¼š <a href="https://github.com/sunyanyan/BlogDemos/tree/master/Location_Demo" target="_blank" rel="noopener">Location_Demo</a></p>
<h2 id="iOSçš„å®šä½æ”¯æŒ"><a href="#iOSçš„å®šä½æ”¯æŒ" class="headerlink" title="iOSçš„å®šä½æ”¯æŒ"></a>iOSçš„å®šä½æ”¯æŒ</h2><blockquote>
<p>GPSå«æ˜Ÿå®šä½</p>
</blockquote>
<p>å…¶åŸç†å°±æ˜¯:åˆ©ç”¨å¤©ä¸Šçš„å«æ˜Ÿ(24é¢—å·¥ä½œå«æ˜Ÿå’Œæ•°é¢—å¤‡ä»½æ˜Ÿ)ä¸æ–­åœ°å¹¿æ’­ä¿¡å·, åœ°é¢çš„GPSæ¥æ”¶è®¾å¤‡æ”¶åˆ°ä¿¡å·å, é€šè¿‡åˆ†æå¤šä¸ªå«æ˜Ÿä¿¡å·ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºåœ°çƒåæ ‡, GPSä¿è¯å…¨çƒä»»ä½•ä¸€ä¸ªåœ°æ–¹(98%)éƒ½å¯ä»¥åŒæ—¶æ”¶åˆ°è‡³å°‘4ä¸ªå«æ˜Ÿçš„ä¿¡å·, ä»è€Œå¯ä»¥å‡†ç¡®ç¡®å®šæ‚¨çš„ç»çº¬åº¦ä»¥åŠæµ·æ‹”ä½ç½®ï¼ˆä¸‰é¢—æ˜Ÿåªèƒ½è·å¾—ç»çº¬åº¦ï¼Œå››é¢—æ˜Ÿè¿˜å¯ä»¥è·å¾—æµ·æ‹”é«˜åº¦ï¼‰ã€‚GPSå®šä½ç²¾åº¦å¯è¾¾10ç±³ä»¥å†…<br><a id="more"></a><br>iOSçš„GPSå®šä½äºå•çº¯çš„GPSå®šä½ä¸åŒï¼Œå®ƒæ˜¯A-GPSï¼ˆæ‰€è°“è¾…åŠ©GPSï¼‰ï¼Œé¦–å…ˆé€šè¿‡åŸºç«™å®šä½æˆ–WiFiå®šä½è·å¾—è¯¥è®¾å¤‡çš„å¤§æ¦‚ä½ç½®ï¼Œç„¶åé€šè¿‡å°†è®¾å¤‡çš„å¤§è‡´ä½ç½®å‘å‘å“¦è¿œç¨‹æœåŠ¡å™¨ï¼Œç”±æœåŠ¡å™¨è´Ÿè´£è¿›è¡ŒæŸ¥è¯¢å’Œè®¡ç®—ï¼Œä»è€Œè·å–å½“å‰ä½ç½®çš„å«æ˜Ÿä¿¡æ¯ï¼Œå¹¶é€šè¿‡ç½‘ç»œå°†è¿™äº›å«æ˜Ÿä¿¡æ¯åé¦ˆç»™iOSè®¾å¤‡ï¼Œé¿å…äº†iOSè®¾å¤‡ç›´æ¥é€šè¿‡GPSæ‰«é¢ã€åˆ†æå¤©ä¸Šçš„å«æ˜Ÿä¿¡æ¯ã€‚A-GPSä¼˜ç‚¹æ˜¯å®šä½å¿«ï¼Œç¼ºç‚¹æ˜¯éœ€è¦ç½‘ç»œï¼Œä½†ä¹Ÿåªæ˜¯åœ¨åˆæ¬¡å®šä½æ—¶éœ€è¦ç½‘ç»œï¼Œå› ä¸ºä¸€æ—¦å«æ˜Ÿä¿¡æ¯è¿”å›ï¼Œåœ¨æœ‰é™æ—¶é—´å’ŒèŒƒå›´å†…ï¼Œè¿™äº›ä¿¡æ¯æ— é¡»æ”¹å˜ï¼Œä¹‹åçš„GPSå®šä½å°±ä¸å†éœ€è¦è”ç½‘ï¼Œéƒ½æ˜¯ç›´æ¥ç”¨è¿™äº›å«æ˜Ÿå‚æ•°æ¥å—ä¿¡æ¯äº†ã€‚</p>
<p>ä¸åŸºç«™ã€WIFIå®šä½ç›¸æ¯”ï¼ŒGPSå®šä½è€—ç”µé‡æœ€å¤§ï¼Œé€Ÿåº¦æœ€æ…¢ï¼Œä½†æ˜¯ç²¾åº¦æœ€é«˜ã€‚</p>
<blockquote>
<p>åŸºç«™å®šä½</p>
</blockquote>
<p>æ¯ä¸ªæ‰‹æœºåŸºç«™éƒ½æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼ŒiOSè®¾å¤‡å¯ä»¥æœé›†å‘¨å›´æ‰€æœ‰æ”¶åˆ°ä¿¡å·çš„åŸºç«™å’Œå®ƒä»¬çš„æ ‡è¯†ç¬¦ï¼Œé€šè¿‡è”ç½‘å‘é€åˆ°è‹¹æœäº‘ç«¯æœåŠ¡å™¨ï¼Œå†ç”±æœåŠ¡å™¨æ ¹æ®è¿™äº›åŸºç«™çš„ä½ç½®ä¿¡æ¯æŸ¥è¯¢å¹¶è®¡ç®—å‡ºå½“å‰ä½ç½®ï¼Œç„¶åæŠŠè¯¥å®šä½ä¿¡æ¯è¿”å›ç»™æ‰‹æœºã€‚</p>
<blockquote>
<p>WiFiå®šä½</p>
</blockquote>
<p>iOSè®¾å¤‡é€šè¿‡æ— çº¿ç½‘å¡æœé›†å‘¨å›´æ‰€æœ‰çš„WiFiçƒ­ç‚¹ï¼Œè·å¾—å®ƒä»¬çš„MACåœ°å€ï¼Œç„¶åé€šè¿‡Appleçš„äº‘ç«¯æœåŠ¡å™¨æŸ¥è¯¢è¯¥WiFiçƒ­ç‚¹æ˜¯å¦å·²ç»ç™»è®°ï¼Œå¦‚æœå·²ç»ç™»è®°ï¼Œå³å¯è·å–è¯¥WiFiçƒ­ç‚¹çš„ä½ç½®ï¼Œæœ€åé€šè¿‡å¯¹å¤šä¸ªWiFiçƒ­ç‚¹æŠ˜ä¸­è®¡ç®—å¾—åˆ°å½“å‰ä½ç½®å¹¶è¿”å›ç»™iOSè®¾å¤‡ã€‚ç²¾ç¡®åº¦å¤§æ¦‚åœ¨å‡ åç±³èŒƒå›´å†…ã€‚</p>
<h2 id="å®šä½ç›¸å…³API"><a href="#å®šä½ç›¸å…³API" class="headerlink" title="å®šä½ç›¸å…³API"></a>å®šä½ç›¸å…³API</h2><p>é¦–å…ˆéœ€è¦è·å–åœ°ç†ä¿¡æ¯æƒé™ã€‚å®šä½æƒé™åˆ†ä¸º <strong>ä»…åœ¨ä½¿ç”¨åº”ç”¨æœŸé—´</strong> å’Œ <strong>å§‹ç»ˆå…è®¸</strong> ; è·å–åˆ°æƒé™åï¼Œä½¿ç”¨ CLLocationManager ç±»å¯ä»¥å¼€å§‹åœ¨å…¶ä»£ç†æ–¹æ³• <em>didUpdateLocations</em> ä¸­è·å¾—CLLocationä½ç½®ä¿¡æ¯ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//CLLocationManagerçš„å¸¸ç”¨æ“ä½œ</span></span><br><span class="line"><span class="comment">//å¼€å§‹ç”¨æˆ·å®šä½</span></span><br><span class="line">- (<span class="keyword">void</span>)startUpdatingLocation;</span><br><span class="line"><span class="comment">//åœæ­¢ç”¨æˆ·å®šä½</span></span><br><span class="line">- (<span class="keyword">void</span>) stopUpdatingLocation;</span><br><span class="line"><span class="comment">//å½“è°ƒç”¨äº†startUpdatingLocationæ–¹æ³•åï¼Œå°±å¼€å§‹ä¸æ–­åœ°å®šä½ç”¨æˆ·çš„ä½ç½®ï¼Œä¸­é€”ä¼šé¢‘ç¹åœ°è°ƒç”¨ä»£ç†çš„ä¸‹é¢æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)locationManager:(<span class="built_in">CLLocationManager</span> *)manager didUpdateLocations:(<span class="built_in">NSArray</span> *)locations;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å®šä½è®¾ç½®ï¼š</span></span><br><span class="line"><span class="comment">//åªæœ‰å½“æœ€æ–°çš„ä½ç½®ä¸ä¸Šä¸€æ¬¡è·å–çš„ä½ç½®ä¹‹é—´çš„è·ç¦», å¤§äºè¿™ä¸ªå€¼æ—¶, æ‰ä¼šé€šè¿‡ä»£ç†å‘Šè¯‰å¤–ç•Œ.</span></span><br><span class="line"><span class="keyword">self</span>.locationM.distanceFilter = <span class="number">100</span>;</span><br><span class="line">	 </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å®šä½ç²¾ç¡®åº¦</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyBestForNavigation    æœ€é€‚åˆå¯¼èˆª</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyBest    ç²¾åº¦æœ€å¥½çš„</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyNearestTenMeters    é™„è¿‘10ç±³</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyHundredMeters    é™„è¿‘100ç±³</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyKilometer    é™„è¿‘1000ç±³</span></span><br><span class="line"><span class="comment">kCLLocationAccuracyThreeKilometers    é™„è¿‘3000ç±³</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">self</span>.locationM.desiredAccuracy = kCLLocationAccuracyBest;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥è·å¾—çš„ CLLocation ä½ç½®ä¿¡æ¯åŒ…æ‹¬äº†ï¼šç»çº¬åº¦ã€ä½ç½®çš„ç²¾åº¦ã€æµ·æ‹”é«˜åº¦ã€æµ·æ‹”é«˜åº¦çš„ç²¾åº¦ã€é€Ÿåº¦ç­‰ä¿¡æ¯ã€‚</p>
<p>ç›¸åº”çš„é€šè¿‡CLLocation å¯ä»¥è®¡ç®—ä¸¤åœ°ä¹‹é—´çš„ç›´çº¿è·ç¦»:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åŒ—äº¬:39.6 116.39</span></span><br><span class="line"><span class="comment">// å¹¿å·:23.08 113.15</span></span><br><span class="line"><span class="built_in">CLLocation</span> *BeiJing = [[<span class="built_in">CLLocation</span> alloc] initWithLatitude:<span class="number">39.6</span> longitude:<span class="number">116.39</span>];</span><br><span class="line"><span class="built_in">CLLocation</span> *GuangZhou = [[<span class="built_in">CLLocation</span> alloc] initWithLatitude:<span class="number">23.08</span> longitude:<span class="number">113.15</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¾—åˆ°ä¸¤åœ°ä¹‹é—´çš„è·ç¦»</span></span><br><span class="line"><span class="built_in">CLLocationDistance</span> distance = [BeiJing distanceFromLocation:GuangZhou];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%.2f"</span>, distance);</span><br></pre></td></tr></table></figure>
<h2 id="åå°å®šä½"><a href="#åå°å®šä½" class="headerlink" title="åå°å®šä½"></a>åå°å®šä½</h2><blockquote>
<p>åå°çŸ­æ—¶é—´æŒç»­å®šä½</p>
</blockquote>
<p>å¯ä»¥åœ¨ Background Modes ä¸­å¼€å¯Location Updatesé€‰é¡¹ã€‚è¿™æ ·å°±å¯ä»¥å®ç°åå°å®šä½ï¼Œä½†æ˜¯è¯¥æ–¹æ³•åªèƒ½å®ç°åå°å®šä½20-30åˆ†é’Ÿçš„æ—¶é—´ã€‚</p>
<blockquote>
<p>åå°æ°¸ä¹…æŒç»­å®šä½</p>
</blockquote>
<p>è®¾ç½®ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//allowsBackgroundLocationUpdates è¿™ä¸ªå±æ€§æ˜¯ iOS 9.0 æ–°å¢çš„å±æ€§ï¼Œ</span></span><br><span class="line"><span class="comment">//é»˜è®¤ä¸º NO ï¼Œè®¾ç½®ä¸º YES</span></span><br><span class="line"><span class="comment">//éœ€è¦ä¿è¯ Target -&gt; Capabilities -&gt; Background Modes çš„å¼€å…³æ‰“å¼€ï¼Œå¹¶å‹¾é€‰ Location updates ï¼Œå¦åˆ™ä¼šå¯¼è‡´ crashã€‚</span></span><br><span class="line"><span class="keyword">if</span> (@available(iOS <span class="number">9.0</span>, *)) &#123;</span><br><span class="line">	<span class="keyword">self</span>.locationManager.allowsBackgroundLocationUpdates = <span class="literal">YES</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Fallback on earlier versions</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç³»ç»Ÿæ˜¯å¦å¯ä»¥è‡ªè¡Œä¸­æ–­ç¨‹åºçš„å®šä½åŠŸèƒ½    </span></span><br><span class="line"><span class="keyword">self</span>.locationManager.pausesLocationUpdatesAutomatically = <span class="literal">NO</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ–¹æ³•è®©ç³»ç»Ÿä¸èƒ½å¤Ÿè‡ªè¡Œå…³é—­ç¨‹åºçš„å®šä½åŠŸèƒ½ï¼Œä¿è¯ç¨‹åºä¸€ç›´å¤„äºåå°å®šä½ä¸­ï¼Œ </p>
<p><strong>å®šä½æƒé™ä¸ºåº”ç”¨ä½¿ç”¨æœŸé—´çš„æ—¶å€™ï¼Œç¨‹åºåœ¨åå°è¿è¡Œæ—¶ä¼šåœ¨é¡¶éƒ¨æœ‰ä¸€æ¡è“è‰²çš„ä¿¡æ¯æ¡†<br>å®šä½æƒé™ä¸ºå§‹ç»ˆçš„æ—¶å€™ï¼Œå°±ä¸ä¼šæœ‰è“è‰²æ¡†äº†ã€‚</strong></p>
<blockquote>
<p>å…³äº pausesLocationUpdatesAutomatically å±æ€§</p>
</blockquote>
<p>CLLocationManager.pausesLocationUpdatesAutomatically è®¾ç½®æ˜¯å¦å…è®¸è‡ªåŠ¨æš‚åœå®šä½æœåŠ¡ï¼Œç›®å‰Appleçš„å®˜æ–¹æ–‡æ¡£æè¿°çš„å¾ˆæ¨¡ç³Šï¼Œå¯¼è‡´Stackoverflowä¸Šæœ‰å¾ˆå¤šçš„è®¨è®ºï¼š</p>
<p>è¯¥é€‰é¡¹ä¸»è¦ç”¨æ¥èŠ‚çœç”µé‡æ¶ˆè€—ï¼Œé˜²æ­¢appåœ¨è¿›å…¥åå°åæ²¡æœ‰åŠæ—¶åœæ­¢å®šä½æ¶ˆè€—ç”µé‡ï¼Œè®¾ç½®ä¸ºYESåï¼Œå½“iOSåˆ¤å®šè®¾å¤‡ä¸å¤ªå¯èƒ½å‘ç”Ÿç§»åŠ¨çš„æ—¶å€™(è¿™å¥è¯æ˜¯Appleæ–‡æ¡£ç›´è¯‘ï¼Œç„¶è€Œå¹¶ä¸çŸ¥é“å…·ä½“æ€ä¹ˆåˆ¤å®š)ï¼Œä¼šè‡ªåŠ¨æš‚åœæ‰å®šä½æœåŠ¡ä»¥åŠç›¸å…³ç¡¬ä»¶è®¾å¤‡<br>appåœ¨åå°å®šä½æ—¶ï¼Œä¸€æ—¦ç¬¦åˆäº†Appleçš„åˆ¤å®šï¼Œå®šä½æœåŠ¡ä»¥åŠç›¸å…³ç¡¬ä»¶è®¾å¤‡è¢«æš‚åœäº†ï¼Œé™¤éappå›åˆ°å‰å°ï¼Œå¦åˆ™ä¸ä¼šæ¢å¤å®šä½æœåŠ¡(ç¡¬ä»¶æš‚åœä½¿å¾—iOSæ— æ³•åˆ¤å®šè®¾å¤‡ç§»åŠ¨)</p>
<h2 id="åŒºåŸŸç›‘å¬"><a href="#åŒºåŸŸç›‘å¬" class="headerlink" title="åŒºåŸŸç›‘å¬"></a>åŒºåŸŸç›‘å¬</h2><p>åŒºåŸŸç›‘å¬æ˜¯æŒ‡,æˆ‘ä»¬é€šè¿‡CLCircularRegionæŒ‡å®šä¸€ä¸ªåŒºåŸŸ, ç„¶åå½“ç”¨æˆ·æŒæ¡è®¾å¤‡è¿›å…¥æˆ–è€…ç¦»å¼€æŒ‡å®šåŒºåŸŸ, æˆ‘ä»¬éƒ½èƒ½ç›‘å¬åˆ°.</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–CLLocationManagerç­‰â€¦â€¦</span></span><br><span class="line"> <span class="comment">// 1. åˆ¤æ–­åŒºåŸŸç›‘å¬æœåŠ¡æ˜¯å¦å¯ç”¨ </span></span><br><span class="line"> <span class="keyword">if</span> ([<span class="built_in">CLLocationManager</span> isMonitoringAvailableForClass:[<span class="built_in">CLCircularRegion</span> <span class="keyword">class</span>]]) </span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// åˆ›å»ºåŒºåŸŸä¸­å¿ƒ</span></span><br><span class="line">     <span class="built_in">CLLocationCoordinate2D</span> center = <span class="built_in">CLLocationCoordinate2DMake</span>(<span class="number">29.12345</span>, <span class="number">131.23456</span>);</span><br><span class="line">     <span class="comment">// åˆ›å»ºåŒºåŸŸï¼ˆæŒ‡å®šåŒºåŸŸä¸­å¿ƒï¼Œå’ŒåŒºåŸŸåŠå¾„ï¼‰</span></span><br><span class="line">     <span class="built_in">CLLocationDistance</span> radius = <span class="number">1000</span>;</span><br><span class="line">     <span class="comment">// åˆ¤æ–­åŒºåŸŸåŠå¾„æ˜¯å¦å¤§äºæœ€å¤§ç›‘å¬åŒºåŸŸåŠå¾„,å¦‚æœå¤§äº, å°±æ²¡æ³•ç›‘å¬</span></span><br><span class="line">     <span class="keyword">if</span> (radius &gt; <span class="keyword">self</span>.locationM.maximumRegionMonitoringDistance) &#123;</span><br><span class="line">         radius = <span class="keyword">self</span>.locationM.maximumRegionMonitoringDistance;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="built_in">CLCircularRegion</span> *region = [[<span class="built_in">CLCircularRegion</span> alloc] initWithCenter:center radius:radius identifier:<span class="string">@"ä¸€ä¸ªidentifier"</span>];</span><br><span class="line"></span><br><span class="line">     <span class="comment">// å¼€å§‹ç›‘å¬æŒ‡å®šåŒºåŸŸ</span></span><br><span class="line">     [<span class="keyword">self</span>.locationM startMonitoringForRegion:region];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span>&#123;<span class="built_in">NSLog</span>(<span class="string">@"åŒºåŸŸç›‘å¬ä¸å¯ç”¨"</span>);&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¿›å»ç›‘å¬åŒºåŸŸåè°ƒç”¨ </span></span><br><span class="line">-(<span class="keyword">void</span>)locationManager:(<span class="keyword">nonnull</span> <span class="built_in">CLLocationManager</span> *)manager didEnterRegion:(<span class="keyword">nonnull</span> <span class="built_in">CLRegion</span> *)region</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"è¿›å…¥åŒºåŸŸ---%@"</span>, region.identifier);</span><br><span class="line">    [manager stopMonitoringForRegion:region];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¦»å¼€ç›‘å¬åŒºåŸŸåè°ƒç”¨ </span></span><br><span class="line">-(<span class="keyword">void</span>)locationManager:(<span class="keyword">nonnull</span> <span class="built_in">CLLocationManager</span> *)manager didExitRegion:(<span class="keyword">nonnull</span> <span class="built_in">CLRegion</span> *)region</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç¦»å¼€åŒºåŸŸ---%@"</span>, region.identifier);</span><br><span class="line">    [manager stopMonitoringForRegion:region];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç›‘å¬æŸä¸ªåŒºåŸŸæ—¶, åªæœ‰è¿›å…¥æˆ–è€…ç¦»å¼€è¿™ä¸ªåŒºåŸŸæ—¶, æ‰èƒ½å›è°ƒå¯¹åº”çš„æ–¹æ³•, æ˜¯ä¸€ä¸ªè¿›å…¥æˆ–è€…ç¦»å¼€çš„åŠ¨ä½œ </span></span><br><span class="line"><span class="comment">//å¦‚æœæƒ³çŸ¥é“æŸä¸€ä¸ªåŒºåŸŸçš„å½“å‰çŠ¶æ€(è¯†åˆ«ç”¨æˆ·æ˜¯åœ¨åŒºåŸŸå†…éƒ¨, è¿˜æ˜¯åŒºåŸŸå¤–éƒ¨), åˆ™éœ€è¦ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.locationM requestStateForRegion:region];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯·æ±‚æŸä¸ªåŒºåŸŸçŠ¶æ€æ—¶, å›è°ƒçš„ä»£ç†æ–¹æ³•</span></span><br><span class="line">-(<span class="keyword">void</span>)locationManager:(<span class="built_in">CLLocationManager</span> *)manager didDetermineState:(<span class="built_in">CLRegionState</span>)state forRegion:(<span class="built_in">CLRegion</span> *)region</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">CLRegionStateUnknown</span>:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æœªçŸ¥çŠ¶æ€"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">CLRegionStateInside</span>:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"åœ¨åŒºåŸŸå†…éƒ¨"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">CLRegionStateOutside</span>:</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"åœ¨åŒºåŸŸå¤–éƒ¨"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ibeacon"><a href="#ibeacon" class="headerlink" title="ibeacon"></a>ibeacon</h2><p>iBeacon æ˜¯è‹¹æœå…¬å¸2013å¹´9æœˆå‘å¸ƒçš„ç§»åŠ¨è®¾å¤‡ç”¨OSï¼ˆiOS7ï¼‰ä¸Šé…å¤‡çš„æ–°åŠŸèƒ½ã€‚å…¶å·¥ä½œæ–¹å¼æ˜¯ï¼Œé…å¤‡æœ‰ä½åŠŸè€—è“ç‰™ï¼ˆBLEï¼‰é€šä¿¡åŠŸèƒ½çš„è®¾å¤‡ä½¿ç”¨BLEæŠ€æœ¯å‘å‘¨å›´å‘é€è‡ªå·±ç‰¹æœ‰çš„ IDï¼Œæ¥æ”¶åˆ°è¯¥ ID çš„åº”ç”¨è½¯ä»¶ä¼šæ ¹æ®è¯¥ ID é‡‡å–ä¸€äº›è¡ŒåŠ¨ã€‚</p>
<p>iOS ä¸­ iBeacon æ˜¯åŸºäºåœ°ç†ä½ç½®çš„å¾®å®šä½æŠ€æœ¯ï¼Œè™½ç„¶å€ŸåŠ©æ‰‹æœºè“ç‰™è¿›è¡Œæ¥æ”¶Majroã€Minorï¼Œä½†æ˜¯ä»–ä»¬åœ¨å¼€å‘å·¥ç¨‹ä¸­æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚<br>iBeaconä½¿ç”¨è‹¹æœæä¾›CoreLocationåº“ï¼Œç„¶è€Œåœ¨ BLE åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä½¿ç”¨CoreBluetoothåº“ã€‚ä»ä¸Šé¢æä¾›çš„åº“æ¥çœ‹å°±å¾ˆæ¸…æ¥šäº†ï¼Œç‰¹åˆ«æ˜¯åœ¨ iOS8.0 ä¹‹åçš„æ—¶å€™å¦‚æœæƒ³ä½¿ç”¨iBeaconï¼Œå¿…é¡»è®©ç”¨æˆ·ç‚¹å‡»æ˜¯å¦å…è®¸XXappä½¿ç”¨åœ°ç†ä½ç½®ã€‚å¦‚æœåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ iOS App æ‰«æiBeaconçš„æ—¶å€™æ²¡æœ‰æç¤ºè¿™å¥è¯ï¼Œæ˜¯ä¸å¯èƒ½æ¥æ”¶åˆ°iBeaconçš„ä¿¡å·ï¼ˆé™¤éiOS 8.0ä¹‹ä¸‹ï¼‰ã€‚å¦‚æœæ˜¯ BLE åˆ™çš„å¼€å‘è¿‡ç¨‹ä¸­ä¹‹éœ€è¦æç¤ºç”¨æˆ·æ‰“å¼€è“ç‰™ï¼Œå¹¶ä¸è¦æ±‚å…¶ä»–çš„åœ°ç†ä½ç½®ä»»ä½•ä¿¡æ¯ã€‚</p>
<p><em>å°±ä¸å†™ä»£ç äº†â€¦â€¦</em></p>
<h2 id="åœ°ç†ç¼–ç ä¸ååœ°ç†ç¼–ç "><a href="#åœ°ç†ç¼–ç ä¸ååœ°ç†ç¼–ç " class="headerlink" title="åœ°ç†ç¼–ç ä¸ååœ°ç†ç¼–ç "></a>åœ°ç†ç¼–ç ä¸ååœ°ç†ç¼–ç </h2><p>éœ€è¦è·å¾—ç½‘ç»œæƒé™</p>
<blockquote>
<p>åœ°ç†ç¼–ç ï¼šæ ¹æ®ç»™å®šçš„åœ°åï¼Œè·å¾—å…·ä½“çš„ä½ç½®ä¿¡æ¯ï¼ˆæ¯”å¦‚ç»çº¬åº¦ã€åœ°å€çš„å…¨ç§°ç­‰)ã€‚</p>
</blockquote>
<p>è¾“å…¥ä¸Šæµ·å¸‚é—µè¡ŒåŒºå—åè¡—25å·çš„ç»“æœï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CLGeocoder</span> *geocoder = [[<span class="built_in">CLGeocoder</span> alloc] init];</span><br><span class="line">[geocoder geocodeAddressString:address </span><br><span class="line">completionHandler:^(<span class="built_in">NSArray</span>&lt;<span class="built_in">CLPlacemark</span> *&gt; * _Nullable placemarks, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="comment">//è·å–ç»“æœ        </span></span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
<p><img src="/res/CoreLocation/1.jpeg" alt></p>
<blockquote>
<p>ååœ°ç†ç¼–ç ï¼šæ ¹æ®ç»™å®šçš„ç»çº¬åº¦ï¼Œè·å¾—å…·ä½“çš„ä½ç½®ä¿¡æ¯,çœå¸‚åŒºè¡—é“ç­‰ä¿¡æ¯;</p>
</blockquote>
<p>è§£æå®šä½å½“å‰çš„ä½ç½®çš„ç»“æœï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CLGeocoder</span> *geocoder = [[<span class="built_in">CLGeocoder</span> alloc] init];</span><br><span class="line">[geocoder reverseGeocodeLocation:location </span><br><span class="line">completionHandler:^(<span class="built_in">NSArray</span>&lt;<span class="built_in">CLPlacemark</span> *&gt; * _Nullable placemarks, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line"><span class="comment">//è·å–ç»“æœ</span></span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
<p><img src="/res/CoreLocation/2.png" alt></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CLPlacemark åœ°æ ‡å¯¹è±¡è¯¦è§£</span><br><span class="line">    location            : CLLocation ç±»å‹, ä½ç½®å¯¹è±¡ä¿¡æ¯, é‡Œé¢åŒ…å«ç»çº¬åº¦, æµ·æ‹”ç­‰ç­‰</span><br><span class="line">    region              : CLRegion ç±»å‹, åœ°æ ‡å¯¹è±¡å¯¹åº”çš„åŒºåŸŸ</span><br><span class="line">    addressDictionary  : NSDictionary ç±»å‹, å­˜æ”¾è¡—é“,çœå¸‚ç­‰ä¿¡æ¯</span><br><span class="line">    name                : NSString ç±»å‹, åœ°å€å…¨ç§°</span><br><span class="line">    thoroughfare        : NSString ç±»å‹, è¡—é“åç§°</span><br><span class="line">    locality            : NSString ç±»å‹, åŸå¸‚åç§°</span><br><span class="line">    administrativeArea : NSString ç±»å‹, çœåç§°</span><br><span class="line">    country             : NSString ç±»å‹, å›½å®¶åç§°</span><br></pre></td></tr></table></figure>
<h2 id="æ–¹å‘ç›‘æµ‹-æŒ‡å—é’ˆ"><a href="#æ–¹å‘ç›‘æµ‹-æŒ‡å—é’ˆ" class="headerlink" title="æ–¹å‘ç›‘æµ‹ / æŒ‡å—é’ˆ"></a>æ–¹å‘ç›‘æµ‹ / æŒ‡å—é’ˆ</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è·å–æŒ‡å—é’ˆä¿¡æ¯</span></span><br><span class="line"><span class="comment">//â‘ ã€CLLocationDegrees headingFilterï¼šè®¾ç½®åªæœ‰å½“è®¾ç½®æ–¹å‘çš„æ”¹å˜å€¼è¶…è¿‡è¯¥å±æ€§å€¼æ—¶æ‰æ¿€å‘delegateæ–¹æ³•ï¼›</span></span><br><span class="line"><span class="comment">//â‘¡ã€CLDeviceOrientation headingOrientationï¼šè®¾ç½®è®¾å¤‡å½“å‰æ–¹å‘ï¼›</span></span><br><span class="line">[<span class="keyword">self</span>.locationManager startUpdatingHeading];</span><br><span class="line"><span class="comment">//å½“è®¾å¤‡çš„æ–¹å‘æ”¹å˜æ—¶ï¼ŒiOSç³»ç»Ÿå°†ä¼šè‡ªåŠ¨æ¿€å‘CLLocationManagerçš„delegateå¯¹è±¡çš„</span></span><br><span class="line">- (<span class="keyword">void</span>)locationManager:(<span class="built_in">CLLocationManager</span> *)manager didUpdateHeading:(<span class="built_in">CLHeading</span> *)newHeading &#123;</span><br><span class="line"> <span class="comment">//CLHeadingæ–¹æ³•çš„ä¸»è¦å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">//ä¸ç£åŒ—æ–¹å‘çš„åè§’@property(readonly, nonatomic) CLLocationDirection magneticHeading; </span></span><br><span class="line"><span class="comment">//ä¸æ­£åŒ—æ–¹å‘çš„åè§’@property(readonly, nonatomic) CLLocationDirection trueHeading;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ–¹å‘è¡¥å……ï¼š</p>
</blockquote>
<p>Core Locationæ”¯æŒä¸¤ç§ä¸åŒçš„è·å–æ–¹å‘ç›¸å…³ä¿¡æ¯çš„æ–¹å¼ï¼š</p>
<p>å½“è®¾å¤‡å¤„äºæŸä¸ªç‚¹æ—¶(CLHeading)ï¼Œå¸¦æœ‰ç£åŠ›è®¡çš„è®¾å¤‡èƒ½èƒ½å¤ŸæŠ¥å‘Šå…¶ä½ç½®ä¿¡æ¯ï¼›æ­¤ç±»è¢«ç§°ä¸ºè®¾å¤‡çš„æœå‘ã€‚<br>å½“è®¾å¤‡å¤„äºç§»åŠ¨è¿‡ç¨‹ä¸­æ—¶(CLLocation.course)ï¼Œé€šè¿‡å¸¦æœ‰GPSç¡¬ä»¶çš„æŠ¥å‘Šçš„ä½ç½®ä½ç½®ä¿¡æ¯ï¼›æ­¤ç±»è¢«ç§°ä¸ºè®¾å¤‡çš„è¡ŒåŠ¨æ–¹å‘ã€‚</p>
<p>æœå‘å’Œè¡ŒåŠ¨æ–¹å‘è¡¨ç°å‡ºè®¾å¤‡ä¸åŒçš„ä¿¡æ¯ã€‚è®¾å¤‡çš„æœå‘çœŸå®çš„åæ˜ å‡ºäº†è®¾å¤‡åœ¨ä¸€ä¸ªç‚¹æ—¶ç›¸å¯¹äºç£åŒ—æˆ–è€…çœŸåŒ—çš„æœå‘ã€‚è€Œè®¾å¤‡çš„è¡ŒåŠ¨æ–¹å‘åˆ™è¡¨ç°äº†è®¾å¤‡åœ¨è¿åŠ¨è¿‡ç¨‹ä¸­çš„è¿åŠ¨æ–¹å‘å…¶å¹¶æ²¡æœ‰è€ƒè™‘è®¾å¤‡çš„æ–¹å‘ã€‚ä½ ä½¿ç”¨ä¸€ç§è¿˜æ˜¯è¿™ä¸¤ç§ç›¸ç»“åˆï¼Œå®Œå…¨å–å†³äºä½ çš„APPï¼›ä¾‹å¦‚ï¼šä¸€ä¸ªå¯¼èˆªAPPæ˜¯å¦è¦åœ¨ä¸¤è€…ä¹‹é—´åˆ‡æ¢å®Œå…¨å–å†³äºç”¨æˆ·çš„é€Ÿåº¦ï¼Œåœ¨æ­¥è¡Œé€Ÿåº¦æ—¶ï¼Œè®¾å¤‡çš„æœå‘å¯¹äºåœ¨å½“å‰ç¯å¢ƒä¸‹çš„ç¡®è®¤ç”¨æˆ·æ–¹å‘æ˜¯ç”¨æˆ·æœ€ä¸ºå…³å¿ƒçš„äº‹æƒ…ï¼›è€Œåœ¨ä¸€è¾†è½¦é‡Œè¿åŠ¨æ—¶ï¼Œè¡ŒåŠ¨æ–¹å‘åˆ™å˜å¾—å°¤ä¸ºé‡è¦ã€‚</p>
<hr>
<blockquote>
<p>åå°å®šä½è¡¥å……ï¼š</p>
</blockquote>
<p><em>å…³äº pausesLocationUpdatesAutomatically å±æ€§</em>:</p>
<p>CLLocationManager.pausesLocationUpdatesAutomatically è®¾ç½®æ˜¯å¦å…è®¸è‡ªåŠ¨æš‚åœå®šä½æœåŠ¡ï¼Œç›®å‰Appleçš„å®˜æ–¹æ–‡æ¡£æè¿°çš„å¾ˆæ¨¡ç³Šï¼Œå¯¼è‡´<a href="https://stackoverflow.com/questions/17484352/iphone-gps-in-background-never-resumes-after-pause" target="_blank" rel="noopener">Stackoverflowä¸Šæœ‰å¾ˆå¤šçš„è®¨è®º</a>ï¼š</p>
<p>è¯¥é€‰é¡¹ä¸»è¦ç”¨æ¥èŠ‚çœç”µé‡æ¶ˆè€—ï¼Œé˜²æ­¢appåœ¨è¿›å…¥åå°åæ²¡æœ‰åŠæ—¶åœæ­¢å®šä½æ¶ˆè€—ç”µé‡ï¼Œè®¾ç½®ä¸ºYESåï¼Œå½“iOSåˆ¤å®š  <strong>è®¾å¤‡ä¸å¤ªå¯èƒ½å‘ç”Ÿç§»åŠ¨çš„æ—¶å€™</strong>  (è¿™å¥è¯æ˜¯Appleæ–‡æ¡£ç›´è¯‘ï¼Œç„¶è€Œå¹¶ä¸çŸ¥é“å…·ä½“æ€ä¹ˆåˆ¤å®š)ï¼Œä¼šè‡ªåŠ¨æš‚åœæ‰å®šä½æœåŠ¡ä»¥åŠç›¸å…³ç¡¬ä»¶è®¾å¤‡</p>
<p><em>å”¤é†’</em>:</p>
<p>é¦–å…ˆè¿™ä¸ªæ–¹æ³•éœ€è¦ å§‹ç»ˆ æƒé™ï¼Œç„¶ååœ¨å¼€å¯å®šä½è°ƒç”¨ startUpdatingLocation çš„åŒæ—¶è°ƒç”¨ startMonitoringSignificantLocationChanges æ–¹æ³•ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[_locationManager startUpdatingLocation];</span><br><span class="line"><span class="comment">// å¼€å¯ä½ç½®æ˜æ˜¾å˜åŒ–ç›‘æ§</span></span><br><span class="line">[_locationManager startMonitoringSignificantLocationChanges];</span><br></pre></td></tr></table></figure>
<p>å¼€å¯äº†è¿™ä¸ªæ–¹æ³•ä¹‹åï¼Œå½“ä½ç½®å‘ç”Ÿè¾ƒæ˜æ˜¾çš„å˜åŒ–æ—¶åŒæ ·ä¼šè§¦å‘ä¸€ä¸ªä½ç½®æ›´æ–°äº‹ä»¶ï¼Œè¿™ä¸ªå˜åŒ–è·ç¦»ä¸ä¾æ® distanceFilter å±æ€§å€¼å˜åŒ–ï¼Œè€Œæ˜¯å›ºå®šçš„ 500 ç±³ï¼ˆæŒ‡ä¸ä¸Šä¸€æ¬¡è§¦å‘æ­¤äº‹ä»¶æ—¶çš„è·ç¦»ï¼‰ï¼Œä¸”æ¯ 5 åˆ†é’Ÿæœ€å¤šè§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘çš„æ—¶å€™å¦‚æœ APP è¢«æ€æ­»äº†ï¼Œè¿™ä¸ªäº‹ä»¶è¿˜ä¼šå”¤é†’ APP ï¼ŒAPP ä¼šåœ¨ç”¨æˆ·æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹é‡æ–°èµ°æ­£å¸¸çš„å¯åŠ¨æµç¨‹ï¼Œåªæ˜¯ç•Œé¢ä¸Šæ²¡æœ‰ä»»ä½•æ˜¾ç¤ºï¼Œæ­¤æ—¶ä¼šåœ¨ application:didFinishLaunchingWithOptions: æ–¹æ³•ä¸­æºå¸¦ UIApplicationLaunchOptionsLocationKey è¿™ä¸ª key æ¥è¡¨æ˜å½“å‰å¯åŠ¨æ˜¯è¢«ä½ç½®äº‹ä»¶å”¤é†’çš„ï¼Œè¯·æ³¨æ„åˆ¤æ–­è¿™ä¸ª key æ¥ç»•è¿‡ä¸€äº›ä¸éœ€è¦åœ¨åå°å¯åŠ¨æ—¶æ‰§è¡Œçš„é€»è¾‘ï¼Œæˆ–è€…æ‰§è¡Œä¸€äº›ä½ æƒ³è¦åœ¨åå°å¯åŠ¨åæ‰§è¡Œçš„é€»è¾‘ï¼Œæ¯”å¦‚å¯åŠ¨ä½ç½®ä¸ŠæŠ¥æœåŠ¡ã€‚åœ¨ APP é‡æ–°å¯åŠ¨ä¹‹åéœ€è¦é‡æ–°è°ƒç”¨ startMonitoringSignificantLocationChanges ä»¥ä¿è¯ APP å†æ¬¡è¢«æ€ä¹‹åèƒ½è¢«é‡æ–°å”¤é†’ã€‚</p>
<p>ç”±æ­¤æ–¹æ³•è§¦å‘çš„ä½ç½®æ›´æ–°äº‹ä»¶åŒæ ·ä¼šè°ƒç”¨æ­£å¸¸ä½ç½®æ›´æ–°æœåŠ¡ startUpdatingLocation çš„locationManager:didUpdateLocations: å›è°ƒæ–¹æ³•ï¼Œè¿™ä¸ªæ›´æ–°äº‹ä»¶å¯èƒ½æ˜¯ä¸€ä¸ªæœ€è¿‘ç¼“å­˜çš„ä½ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯æœ€æ–°ä½ç½®ï¼Œè€Œæ›´ç²¾ç¡®çš„ä½ç½®ä¼šåœ¨å‡ ç§’é’Ÿä¹‹åå†æ¬¡å›è°ƒï¼Œæ‰€ä»¥å¦‚æœå¯¹ç»†å¾®ä½ç½®å·®åˆ«æ¯”è¾ƒæ•æ„Ÿçš„è¯ï¼Œå¯ä»¥é€šè¿‡å›è°ƒçš„ CLLocation å¯¹è±¡ä¸­çš„æ—¶é—´æˆ³æ¥è¿‡æ»¤ã€‚</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>CoreTextä»‹ç».md</title>
    <url>/essay/CoreText%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»CoreTextçš„ä¸€äº›æ¦‚å¿µ</p>
</blockquote>
<a id="more"></a>
<h3 id="Core-TextåŸºç¡€"><a href="#Core-TextåŸºç¡€" class="headerlink" title="Core TextåŸºç¡€"></a>Core TextåŸºç¡€</h3><p><img src="/res/CoreText/coretext_framework_arch.png" alt></p>
<p>CoreText æ˜¯ç”¨äºå¤„ç†æ–‡å­—å’Œå­—ä½“çš„åº•å±‚æŠ€æœ¯ã€‚å®ƒç›´æ¥å’Œ Core Graphicsï¼ˆåˆè¢«ç§°ä¸º Quartzï¼‰æ‰“äº¤é“ã€‚</p>
<p> UIWebView ä¹Ÿæ˜¯å¤„ç†å¤æ‚çš„æ–‡å­—æ’ç‰ˆçš„å¤‡é€‰æ–¹æ¡ˆã€‚å¯¹äºæ’ç‰ˆï¼ŒåŸºäº CoreText å’ŒåŸºäº UIWebView ç›¸æ¯”ï¼Œå‰è€…æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<pre><code>CoreText å ç”¨çš„å†…å­˜æ›´å°‘ï¼Œæ¸²æŸ“é€Ÿåº¦å¿«ï¼ŒUIWebView å ç”¨çš„å†…å­˜æ›´å¤šï¼Œæ¸²æŸ“é€Ÿåº¦æ…¢ã€‚
CoreText åœ¨æ¸²æŸ“ç•Œé¢å‰å°±å¯ä»¥ç²¾ç¡®åœ°è·å¾—æ˜¾ç¤ºå†…å®¹çš„é«˜åº¦ï¼ˆåªè¦æœ‰äº† CTFrame å³å¯ï¼‰ï¼Œè€Œ UIWebView åªæœ‰æ¸²æŸ“å‡ºå†…å®¹åï¼Œæ‰èƒ½è·å¾—å†…å®¹çš„é«˜åº¦ï¼ˆè€Œä¸”è¿˜éœ€è¦ç”¨ javascript ä»£ç æ¥è·å–ï¼‰
CoreText çš„ CTFrame å¯ä»¥åœ¨åå°çº¿ç¨‹æ¸²æŸ“ï¼ŒUIWebView çš„å†…å®¹åªèƒ½åœ¨ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰æ¸²æŸ“ã€‚
åŸºäº CoreText å¯ä»¥åšæ›´å¥½çš„åŸç”Ÿäº¤äº’æ•ˆæœï¼Œäº¤äº’æ•ˆæœå¯ä»¥æ›´ç»†è…»ã€‚è€Œ UIWebView çš„äº¤äº’æ•ˆæœéƒ½æ˜¯ç”¨ javascript æ¥å®ç°çš„ï¼Œåœ¨äº¤äº’æ•ˆæœä¸Šä¼šæœ‰ä¸€äº›å¡é¡¿å­˜åœ¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ UIWebView ä¸‹ï¼Œä¸€ä¸ªç®€å•çš„æŒ‰é’®æŒ‰ä¸‹æ•ˆæœï¼Œéƒ½æ— æ³•åšåˆ°åŸç”ŸæŒ‰é’®çš„å³æ—¶å’Œç»†è…»çš„æŒ‰ä¸‹æ•ˆæœã€‚
</code></pre><p>å½“ç„¶ï¼ŒåŸºäº CoreText çš„æ’ç‰ˆæ–¹æ¡ˆä¹Ÿæœ‰ä¸€äº›åŠ£åŠ¿ï¼š</p>
<pre><code>CoreText æ¸²æŸ“å‡ºæ¥çš„å†…å®¹ä¸èƒ½åƒ UIWebView é‚£æ ·æ–¹ä¾¿åœ°æ”¯æŒå†…å®¹çš„å¤åˆ¶ã€‚
åŸºäº CoreText æ¥æ’ç‰ˆéœ€è¦è‡ªå·±å¤„ç†å¾ˆå¤šå¤æ‚é€»è¾‘ï¼Œä¾‹å¦‚éœ€è¦è‡ªå·±å¤„ç†å›¾ç‰‡ä¸æ–‡å­—æ··æ’ç›¸å…³çš„é€»è¾‘ï¼Œä¹Ÿéœ€è¦è‡ªå·±å®ç°é“¾æ¥ç‚¹å‡»æ“ä½œçš„æ”¯æŒã€‚
</code></pre><p>ä»¥ä¸‹æ˜¯Core Textçš„æ„æˆï¼š</p>
<p><img src="/res/CoreText/core_text_arch.png" alt></p>
<ul>
<li>CTFrameå¯ä»¥æƒ³è±¡æˆç”»å¸ƒ, ç”»å¸ƒçš„å¤§å°èŒƒå›´ç”±CGPathå†³å®š</li>
<li>CTFrameç”±å¾ˆå¤šCTLineç»„æˆ, CTLineè¡¨ç¤ºä¸ºä¸€è¡Œ</li>
<li>CTLineç”±å¤šä¸ªCTRunç»„æˆ, CTRunç›¸å½“äºä¸€è¡Œä¸­çš„å¤šä¸ªå—, ä½†æ˜¯CTRunä¸éœ€è¦ä½ è‡ªå·±åˆ›å»º, ç”±NSAttributedStringçš„å±æ€§å†³å®š, ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆã€‚æ¯ä¸ªCTRunå¯¹åº”ä¸åŒå±æ€§</li>
<li>CTFramesetteræ˜¯ä¸€ä¸ªå·¥å‚, åˆ›å»ºCTFrame, ä¸€ä¸ªç•Œé¢ä¸Šå¯ä»¥æœ‰å¤šä¸ªCTFrame</li>
</ul>
<h3 id="å­—ä½“"><a href="#å­—ä½“" class="headerlink" title="å­—ä½“"></a>å­—ä½“</h3><p><img src="/res/CoreText/coretext_text_handing.png" alt></p>
<ul>
<li>å­—ä½“(Font):æ˜¯ä¸€ç³»åˆ—å­—å·ã€æ ·å¼å’Œç£…å€¼ç›¸åŒçš„å­—ç¬¦(ä¾‹å¦‚:10ç£…é»‘ä½“Palatino)ã€‚ç°å¤šè¢«è§†ä¸ºå­—æ ·çš„åŒä¹‰è¯</li>
<li>å­—é¢(Face):æ˜¯æ‰€æœ‰å­—å·çš„ç£…å€¼å’Œæ ¼å¼çš„ç»¼åˆ</li>
<li>å­—ä½“é›†(Font family):æ˜¯ä¸€ç»„ç›¸å…³å­—ä½“(ä¾‹å¦‚:Franklin familyåŒ…æ‹¬Franklin Gothicã€Fran-klinHeavyå’ŒFranklin Compressed)</li>
<li>ç£…å€¼(Weight):ç”¨äºæè¿°å­—ä½“ç²—åº¦ã€‚å…¸å‹çš„ç£…å€¼,ä»æœ€ç²—åˆ°æœ€ç»†,æœ‰æç»†ã€ç»†ã€bookã€ä¸­ç­‰ã€åŠç²—ã€ç²—ã€è¾ƒç²—ã€æç²—</li>
<li>æ ·å¼(Style):å­—å½¢æœ‰ä¸‰ç§å½¢å¼:Roman typeæ˜¯ç›´ä½“;oblique typeæ˜¯æ–œä½“;utakuc typeæ˜¯æ–œä½“å…¼æ›²çº¿(æ¯”Roman typeæ›´åƒä¹¦æ³•ä½“)ã€‚</li>
<li>xé«˜åº¦(X height):æŒ‡å°å†™å­—æ¯çš„å¹³å‡é«˜åº¦(ä»¥xä¸ºåŸºå‡†)ã€‚ç£…å€¼ç›¸åŒçš„ä¸¤å­—æ¯,xé«˜åº¦è¶Šå¤§çš„å­—æ¯çœ‹èµ·æ¥æ¯”xé«˜åº¦å°çš„å­—æ¯è¦å¤§</li>
<li>Capé«˜åº¦(Cap height):ä¸xé«˜åº¦ç›¸ä¼¼ã€‚æŒ‡å¤§å†™å­—æ¯çš„å¹³å‡é«˜åº¦(ä»¥Cä¸ºåŸºå‡†)</li>
<li>ä¸‹è¡Œå­—æ¯(Descender):ä¾‹å¦‚åœ¨å­—æ¯qä¸­,åŸºçº¿ä»¥ä¸‹çš„å­—æ¯éƒ¨åˆ†å«ä¸‹ä¼¸éƒ¨åˆ†</li>
<li>ä¸Šè¡Œå­—æ¯(Ascender):xé«˜åº¦ä»¥ä¸Šçš„éƒ¨åˆ†(æ¯”å¦‚å­—æ¯b)å«åšä¸Šä¼¸éƒ¨åˆ†</li>
<li>åŸºçº¿(Baseline):é€šå¸¸åœ¨xã€vã€bã€mä¸‹çš„é‚£æ¡çº¿ æè¾¹(Stroke):ç»„æˆå­—ç¬¦çš„çº¿æˆ–æ›²çº¿ã€‚å¯ä»¥åŠ ç²—æˆ–æ”¹å˜å­—ç¬¦å½¢çŠ¶</li>
</ul>
<h3 id="CoreTextå®šä¹‰çš„å­—ä½“-æ ·å¼"><a href="#CoreTextå®šä¹‰çš„å­—ä½“-æ ·å¼" class="headerlink" title="CoreTextå®šä¹‰çš„å­—ä½“ æ ·å¼"></a>CoreTextå®šä¹‰çš„å­—ä½“ æ ·å¼</h3><blockquote>
<p>å¯ä»¥åœ¨ CTStringAttributes.h ä¸­æ‰¾åˆ°</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTCharacterShapeAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“å½¢çŠ¶å±æ€§  å¿…é¡»æ˜¯CFNumberRefå¯¹è±¡é»˜è®¤ä¸º0ï¼Œé0åˆ™å¯¹åº”ç›¸åº”çš„å­—ç¬¦å½¢çŠ¶å®šä¹‰ï¼Œå¦‚1è¡¨ç¤ºä¼ ç»Ÿå­—ç¬¦å½¢çŠ¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTFontAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“å±æ€§   å¿…é¡»æ˜¯CTFontå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTKernAttributeName;</span><br><span class="line"><span class="comment">//å­—ç¬¦é—´éš”å±æ€§ å¿…é¡»æ˜¯CFNumberRefå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTLigatureAttributeName;</span><br><span class="line"><span class="comment">//è®¾ç½®æ˜¯å¦ä½¿ç”¨è¿å­—å±æ€§ï¼Œè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä¸ä½¿ç”¨è¿å­—å±æ€§ã€‚æ ‡å‡†çš„è‹±æ–‡è¿å­—æœ‰FI,FL.é»˜è®¤å€¼ä¸º1ï¼Œæ—¢æ˜¯ä½¿ç”¨æ ‡å‡†è¿å­—ã€‚ä¹Ÿå°±æ˜¯å½“æœç´¢åˆ°fæ—¶å€™ï¼Œä¼šæŠŠflå½“æˆä¸€ä¸ªæ–‡å­—ã€‚å¿…é¡»æ˜¯CFNumberRef é»˜è®¤ä¸º1,å¯å–0,1,2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTForegroundColorAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“é¢œè‰²å±æ€§  å¿…é¡»æ˜¯CGColorå¯¹è±¡ï¼Œé»˜è®¤ä¸ºblack</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTForegroundColorFromContextAttributeName;</span><br><span class="line"> <span class="comment">//ä¸Šä¸‹æ–‡çš„å­—ä½“é¢œè‰²å±æ€§ å¿…é¡»ä¸ºCFBooleanRef é»˜è®¤ä¸ºFalse</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTParagraphStyleAttributeName;</span><br><span class="line"><span class="comment">//æ®µè½æ ·å¼å±æ€§ å¿…é¡»æ˜¯CTParagraphStyleå¯¹è±¡ é»˜è®¤ä¸ºNIL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTStrokeWidthAttributeName;</span><br><span class="line"><span class="comment">//ç¬”ç”»çº¿æ¡å®½åº¦ å¿…é¡»æ˜¯CFNumberRefå¯¹è±¡ï¼Œé»˜ä¸º0.0fï¼Œæ ‡å‡†ä¸º3.0f</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTStrokeColorAttributeName;</span><br><span class="line"><span class="comment">//ç¬”ç”»çš„é¢œè‰²å±æ€§ å¿…é¡»æ˜¯CGColorRef å¯¹è±¡ï¼Œé»˜è®¤ä¸ºå‰æ™¯è‰²</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTSuperscriptAttributeName;</span><br><span class="line"><span class="comment">//è®¾ç½®å­—ä½“çš„ä¸Šä¸‹æ ‡å±æ€§ å¿…é¡»æ˜¯CFNumberRefå¯¹è±¡ é»˜è®¤ä¸º0,å¯ä¸º-1ä¸ºä¸‹æ ‡,1ä¸ºä¸Šæ ‡ï¼Œéœ€è¦å­—ä½“æ”¯æŒæ‰è¡Œã€‚å¦‚æ’åˆ—ç»„åˆçš„æ ·å¼Cn1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTUnderlineColorAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“ä¸‹åˆ’çº¿é¢œè‰²å±æ€§ å¿…é¡»æ˜¯CGColorRefå¯¹è±¡ï¼Œé»˜è®¤ä¸ºå‰æ™¯è‰²</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTUnderlineStyleAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“ä¸‹åˆ’çº¿æ ·å¼å±æ€§ å¿…é¡»æ˜¯CFNumberRefå¯¹è±¡,é»˜ä¸ºkCTUnderlineStyleNone å¯ä»¥é€šè¿‡CTUnderlineStypleModifiers è¿›è¡Œä¿®æ”¹ä¸‹åˆ’çº¿é£æ ¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTVerticalFormsAttributeName;</span><br><span class="line"><span class="comment">//æ–‡å­—çš„å­—å½¢æ–¹å‘å±æ€§ å¿…é¡»æ˜¯CFBooleanRef é»˜è®¤ä¸ºfalseï¼Œfalseè¡¨ç¤ºæ°´å¹³æ–¹å‘ï¼Œtrueè¡¨ç¤ºç«–ç›´æ–¹å‘</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTGlyphInfoAttributeName;</span><br><span class="line"><span class="comment">//å­—ä½“ä¿¡æ¯å±æ€§ å¿…é¡»æ˜¯CTGlyphInfoå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCTRunDelegateAttributeName</span><br><span class="line"><span class="comment">//CTRun å§”æ‰˜å±æ€§ å¿…é¡»æ˜¯CTRunDelegateå¯¹è±¡</span></span><br></pre></td></tr></table></figure>
<h3 id="CoreTextåæ ‡ç³»"><a href="#CoreTextåæ ‡ç³»" class="headerlink" title="CoreTextåæ ‡ç³»"></a>CoreTextåæ ‡ç³»</h3><p><img src="/res/CoreText/coreText_zuobiao.png" alt></p>
<p>ä»å›¾ä¸­å¯çœ‹å‡ºCoreTextåæ ‡ç³»æ˜¯ä»¥å·¦ä¸‹è§’ä¸ºåæ ‡åŸç‚¹ï¼Œè€Œæˆ‘ä»¬å¸¸ä½¿ç”¨çš„UIKitæ˜¯ä»¥å·¦ä¸Šè§’ä¸ºåæ ‡åŸç‚¹ï¼Œå› æ­¤åœ¨CoreTextä¸­çš„å¸ƒå±€å®Œæˆåéœ€è¦å¯¹å…¶åæ ‡ç³»è¿›è¡Œè½¬æ¢ï¼Œå¦åˆ™ç›´æ¥ç»˜åˆ¶å‡ºç°ä½ç½®åè½¬çš„é•œåƒæƒ…å†µã€‚</p>
<h3 id="CoreText-å›¾æ–‡æ··æ’"><a href="#CoreText-å›¾æ–‡æ··æ’" class="headerlink" title="CoreText å›¾æ–‡æ··æ’"></a>CoreText å›¾æ–‡æ··æ’</h3><p>CoreTextå®é™…ä¸Šå¹¶æ²¡æœ‰ç›¸åº”APIç›´æ¥å°†ä¸€ä¸ªå›¾ç‰‡è½¬æ¢ä¸ºCTRunå¹¶è¿›è¡Œç»˜åˆ¶ï¼Œå®ƒæ‰€èƒ½åšçš„åªæ˜¯ä¸ºå›¾ç‰‡é¢„ç•™ç›¸åº”çš„ç©ºç™½åŒºåŸŸï¼Œè€ŒçœŸæ­£çš„ç»˜åˆ¶åˆ™æ˜¯äº¤ç”±CoreGraphicså®Œæˆã€‚(åƒOSXå°±æ–¹ä¾¿å¾ˆå¤šï¼Œç›´æ¥å°†å›¾ç‰‡æ‰“åŒ…è¿›NSTextAttachmentå³å¯ï¼Œæ ¹æœ¬æ— é¡»æ“å¿ƒç»˜åˆ¶çš„äº‹æƒ…ï¼Œæ‰€ä»¥åŸºäºè¿™ä¸ªæƒ³æ³•ï¼ŒM80AttributedLabelçš„æ¥å£å’Œå®ç°ä¹Ÿæ˜¯ä½¿ç”¨äº†attachmentè¿™ä¹ˆä¸ªæ¦‚å¿µï¼Œå›¾ç‰‡æˆ–è€…UIViewéƒ½æ˜¯è¢«å½“ä½œæ–‡å­—æ®µä¸­çš„attachmentã€‚)</p>
<p>åœ¨CoreTextä¸­æä¾›äº†CTRunDelegateè¿™ä¹ˆä¸ªCore Foundationç±»ï¼Œé¡¾åæ€ä¹‰å®ƒå¯ä»¥å¯¹CTRunè¿›è¡Œæ‹“å±•ï¼šAttributedStringæŸä¸ªæ®µè®¾ç½®kCTRunDelegateAttributeNameå±æ€§ä¹‹åï¼ŒCoreTextä½¿ç”¨å®ƒç”ŸæˆCTRunæ˜¯é€šè¿‡å½“å‰Delegateçš„å›è°ƒæ¥è·å–è‡ªå·±çš„ascentï¼Œdescentå’Œwidthï¼Œè€Œä¸æ˜¯æ ¹æ®å­—ä½“ä¿¡æ¯ã€‚è¿™æ ·å°±ç»™æˆ‘ä»¬ç•™ä¸‹äº†å¯æ“ä½œçš„ç©ºé—´ï¼šç”¨ä¸€ä¸ªç©ºç™½å­—ç¬¦ä½œä¸ºå›¾ç‰‡çš„å ä½ç¬¦ï¼Œè®¾å¥½Delegateï¼Œå å¥½ä½ç½®ï¼Œç„¶åç”¨CoreGraphicsè¿›è¡Œå›¾ç‰‡çš„ç»˜åˆ¶ã€‚</p>
<h3 id="åŸºæœ¬ä½¿ç”¨æ­¥éª¤"><a href="#åŸºæœ¬ä½¿ç”¨æ­¥éª¤" class="headerlink" title="åŸºæœ¬ä½¿ç”¨æ­¥éª¤"></a>åŸºæœ¬ä½¿ç”¨æ­¥éª¤</h3><blockquote>
<p>æ–°å»ºä¸€ä¸ªUIViewç±»ï¼Œåœ¨å…¶drawRectæ–¹æ³•ä¸­</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect&#123;</span><br><span class="line">    [<span class="keyword">super</span> drawRect:rect];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.è·å–ä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="comment">// 2.è½¬æ¢åæ ‡ç³»</span></span><br><span class="line">    <span class="built_in">CGContextSetTextMatrix</span>(context, <span class="built_in">CGAffineTransformIdentity</span>);</span><br><span class="line">    <span class="built_in">CGContextTranslateCTM</span>(context , <span class="number">0</span>, <span class="keyword">self</span>.bounds.size.height);</span><br><span class="line">    <span class="built_in">CGContextScaleCTM</span>(context, <span class="number">1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">    <span class="comment">// 3.åˆå§‹åŒ–è·¯å¾„ (ç»˜åˆ¶çš„åŒºåŸŸ)</span></span><br><span class="line">    <span class="built_in">CGMutablePathRef</span> path = <span class="built_in">CGPathCreateMutable</span>();</span><br><span class="line">    <span class="built_in">CGPathAddRect</span>(path , <span class="literal">NULL</span> , <span class="keyword">self</span>.bounds);</span><br><span class="line">    <span class="comment">// 4.åˆå§‹åŒ–å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="built_in">NSAttributedString</span>* attString = [[<span class="built_in">NSAttributedString</span> alloc]initWithString:<span class="string">@"Hello CoreText"</span>];</span><br><span class="line">    <span class="comment">// 5.åˆå§‹åŒ–framesetter</span></span><br><span class="line">    <span class="built_in">CTFramesetterRef</span> framesetter = <span class="built_in">CTFramesetterCreateWithAttributedString</span>((<span class="built_in">CFAttributedStringRef</span>)attString);</span><br><span class="line">    <span class="comment">// 6. ç»˜åˆ¶frame</span></span><br><span class="line">    <span class="built_in">CTFrameRef</span> frame = <span class="built_in">CTFramesetterCreateFrame</span>(framesetter, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, [attString length]), path , <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 7. ç»˜åˆ¶å¯Œæ–‡æœ¬</span></span><br><span class="line">    <span class="built_in">CTFrameDraw</span>(frame, context);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 8. é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(frame);</span><br><span class="line">    <span class="built_in">CFRelease</span>(path);</span><br><span class="line">    <span class="built_in">CFRelease</span>(framesetter);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Hello CoreText</code>å°±ä¼šæ˜¾ç¤ºåœ¨è¯¥Viewä¸Šäº†ï¼Œè¿™æ˜¯CoreTextçš„åŸºæœ¬ä½¿ç”¨æ­¥éª¤ã€‚</p>
<h3 id="ç®€å•çš„å¯Œæ–‡æœ¬"><a href="#ç®€å•çš„å¯Œæ–‡æœ¬" class="headerlink" title="ç®€å•çš„å¯Œæ–‡æœ¬"></a>ç®€å•çš„å¯Œæ–‡æœ¬</h3><blockquote>
<p>åœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œä¸ºNSAttributeStringæ·»åŠ ç›¸å…³çš„å­—ä½“ä¿¡æ¯</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSMutableAttributedString</span>* mAttStr = [[<span class="built_in">NSMutableAttributedString</span> alloc]initWithString:<span class="string">@"Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;Hello CoreText ;"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å­—ä½“å±æ€§</span></span><br><span class="line"><span class="built_in">CTFontRef</span> font = <span class="built_in">CTFontCreateWithName</span>(<span class="built_in">CFSTR</span>(<span class="string">"Georgia"</span>), <span class="number">40</span>, <span class="literal">NULL</span>);</span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTFontAttributeName value:(__bridge <span class="keyword">id</span> _Nonnull)(font)  range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®æ–œä½“å­—</span></span><br><span class="line"><span class="built_in">CTFontRef</span> font2 = <span class="built_in">CTFontCreateWithName</span>((<span class="built_in">CFStringRef</span>)[<span class="built_in">UIFont</span> italicSystemFontOfSize:<span class="number">20</span>].fontName, <span class="number">14</span>, <span class="literal">NULL</span>);</span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTFontAttributeName value:(__bridge <span class="keyword">id</span> _Nonnull)(font2)  range:<span class="built_in">NSMakeRange</span>(<span class="number">6</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹åˆ’çº¿</span></span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTUnderlineStyleAttributeName value:(<span class="keyword">id</span>)[<span class="built_in">NSNumber</span> numberWithInt:kCTUnderlineStyleDouble] range:<span class="built_in">NSMakeRange</span>(<span class="number">18</span>, <span class="number">4</span>)];</span><br><span class="line"><span class="comment">//ä¸‹åˆ’çº¿é¢œè‰²</span></span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTUnderlineStyleAttributeName value:(<span class="keyword">id</span>)[<span class="built_in">NSNumber</span> numberWithInt:kCTUnderlineStyleSingle] range:<span class="built_in">NSMakeRange</span>(<span class="number">25</span>, <span class="number">4</span>)];</span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTUnderlineColorAttributeName value:(<span class="keyword">id</span>)[<span class="built_in">UIColor</span> redColor].CGColor range:<span class="built_in">NSMakeRange</span>(<span class="number">25</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å­—ä½“é—´éš”</span></span><br><span class="line"><span class="keyword">long</span> number = <span class="number">10</span>;</span><br><span class="line"><span class="built_in">CFNumberRef</span> num = <span class="built_in">CFNumberCreate</span>(kCFAllocatorDefault,kCFNumberSInt8Type,&amp;number);</span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTKernAttributeName value:(__bridge <span class="keyword">id</span>)num range:<span class="built_in">NSMakeRange</span>(<span class="number">36</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®å­—ä½“é¢œè‰²</span></span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTForegroundColorAttributeName value:(<span class="keyword">id</span>)[<span class="built_in">UIColor</span> redColor].CGColor range:<span class="built_in">NSMakeRange</span>(<span class="number">43</span>, <span class="number">4</span>)];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®ç©ºå¿ƒå­—</span></span><br><span class="line"><span class="keyword">long</span> number2 = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">CFNumberRef</span> num2 = <span class="built_in">CFNumberCreate</span>(kCFAllocatorDefault,kCFNumberSInt8Type,&amp;number2);</span><br><span class="line">[mAttStr addAttribute:(<span class="keyword">id</span>)kCTStrokeWidthAttributeName value:(__bridge <span class="keyword">id</span>)num2 range:<span class="built_in">NSMakeRange</span>(<span class="number">54</span>, <span class="number">4</span>)];</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå›¾:<br><img src="/res/CoreText/CoreText.png" alt></p>
<h3 id="æ›´å¤šçš„æ ·å¼"><a href="#æ›´å¤šçš„æ ·å¼" class="headerlink" title="æ›´å¤šçš„æ ·å¼"></a>æ›´å¤šçš„æ ·å¼</h3><blockquote>
<p>åœ¨ä»‹ç»å¦‚ä½•ç»˜åˆ¶æ›´å¤šæ ·å¼ä¹‹å‰ï¼Œéœ€è¦ä»‹ç» æŒ‰Lineç»˜åˆ¶ <code>CTLineDraw</code> å’ŒæŒ‰Runç»˜åˆ¶ <code>CTRunDraw</code></p>
</blockquote>
<h4 id="CTLineDraw-æŒ‰è¡Œç»˜åˆ¶"><a href="#CTLineDraw-æŒ‰è¡Œç»˜åˆ¶" class="headerlink" title="CTLineDraw æŒ‰è¡Œç»˜åˆ¶"></a>CTLineDraw æŒ‰è¡Œç»˜åˆ¶</h4><p>å°†ä¸Šé¢çš„</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CTFrameDraw</span>(frame, context);</span><br></pre></td></tr></table></figure>
<p>æ›¿æ¢æˆï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//7.2ä½¿ç”¨CTLineç»˜åˆ¶</span></span><br><span class="line"><span class="built_in">CFArrayRef</span> lines = <span class="built_in">CTFrameGetLines</span>(frame);</span><br><span class="line"><span class="built_in">CFIndex</span> numOfLines =  <span class="built_in">CFArrayGetCount</span>(lines);</span><br><span class="line"><span class="comment">//è·å–æ¯ä¸€è¡Œçš„origin,CoreTextçš„originæ˜¯åœ¨å­—å½¢çš„baseLineå¤„</span></span><br><span class="line"><span class="built_in">CGPoint</span> lineOrigins[<span class="built_in">CFArrayGetCount</span>(lines)];</span><br><span class="line"><span class="built_in">CTFrameGetLineOrigins</span>(frame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), lineOrigins);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numOfLines; i++) &#123;</span><br><span class="line">    <span class="built_in">CTLineRef</span> line = <span class="built_in">CFArrayGetValueAtIndex</span>(lines, i);</span><br><span class="line">    <span class="comment">//è®¾ç½®æ¯ä¸€è¡Œçš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">CGContextSetTextPosition</span>(context, lineOrigins[i].x, lineOrigins[i].y);</span><br><span class="line">    <span class="comment">//å¼€å§‹ä¸€è¡Œçš„ç»˜åˆ¶</span></span><br><span class="line">    <span class="built_in">CTLineDraw</span>(line , context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="CTRunDraw-æŒ‰Runç»˜åˆ¶"><a href="#CTRunDraw-æŒ‰Runç»˜åˆ¶" class="headerlink" title="CTRunDraw æŒ‰Runç»˜åˆ¶"></a>CTRunDraw æŒ‰Runç»˜åˆ¶</h4><p>å°†ä¸Šé¢çš„</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CTFrameDraw</span>(frame, context);</span><br></pre></td></tr></table></figure>
<p>æ›¿æ¢æˆï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//7.3 ä½¿ç”¨CTRunç»˜åˆ¶</span></span><br><span class="line"><span class="built_in">CFArrayRef</span> lines = <span class="built_in">CTFrameGetLines</span>(frame);</span><br><span class="line"><span class="built_in">CFIndex</span> numOfLines =  <span class="built_in">CFArrayGetCount</span>(lines);</span><br><span class="line">    <span class="comment">//è·å–æ¯ä¸€è¡Œçš„origin,CoreTextçš„originæ˜¯åœ¨å­—å½¢çš„baseLineå¤„</span></span><br><span class="line"><span class="built_in">CGPoint</span> lineOrigins[<span class="built_in">CFArrayGetCount</span>(lines)];</span><br><span class="line"><span class="built_in">CTFrameGetLineOrigins</span>(frame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), lineOrigins);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numOfLines; i++) &#123;</span><br><span class="line">    <span class="built_in">CTLineRef</span> line = <span class="built_in">CFArrayGetValueAtIndex</span>(lines, i);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ¯ä¸€è¡Œçš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">CGContextSetTextPosition</span>(context, lineOrigins[i].x, lineOrigins[i].y);</span><br><span class="line">        <span class="comment">//å¼€å§‹æ¯ä¸ªrunçš„ç»˜åˆ¶</span></span><br><span class="line">    <span class="built_in">CFArrayRef</span> runs = <span class="built_in">CTLineGetGlyphRuns</span>(line);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">CFArrayGetCount</span>(runs); j++) &#123;</span><br><span class="line">        <span class="built_in">CTRunRef</span> run = <span class="built_in">CFArrayGetValueAtIndex</span>(runs, j);</span><br><span class="line">        <span class="built_in">CTRunDraw</span>(run, context, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆ CTRunDraw CTLineDraw å’Œ CTFrameDrawçš„ç»˜åˆ¶ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<h4 id="å®ç°åˆ é™¤çº¿æ•ˆæœ"><a href="#å®ç°åˆ é™¤çº¿æ•ˆæœ" class="headerlink" title="å®ç°åˆ é™¤çº¿æ•ˆæœ"></a>å®ç°åˆ é™¤çº¿æ•ˆæœ</h4><blockquote>
<p>æ—¢ç„¶æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ä¸€å°å—CTRunçš„æ–¹å¼ç»˜åˆ¶ï¼Œå°±å¯ä»¥å¯¹ä¸€äº›CTRunåšä¸€äº›è‡ªå®šä¹‰ç»˜åˆ¶</p>
<p>æ¯”å¦‚åœ¨ &lt; CoreText/CTStringArrtibutes.h &gt;ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°åˆ é™¤çº¿çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å»å®ç°å®ƒã€‚</p>
</blockquote>
<p><strong>ä¸€ã€</strong>åœ¨NSAttributedStringä¸­æ·»åŠ åˆ é™¤çº¿å±æ€§ï¼ˆ<code>NSStrikethroughStyleAttributeName</code>å­—æ®µå®šä¹‰åœ¨NSAttributedString.hä¸­ï¼ŒcoreTextæ²¡æœ‰å¯¹åº”çš„å®ç°ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é¢å¤–çš„åˆ é™¤çº¿</span></span><br><span class="line">[mAttStr addAttribute:<span class="built_in">NSStrikethroughStyleAttributeName</span> value:[<span class="built_in">NSNumber</span> numberWithInt:<span class="built_in">NSUnderlineStyleSingle</span>] range:<span class="built_in">NSMakeRange</span>(<span class="number">72</span>,<span class="number">18</span>)];</span><br></pre></td></tr></table></figure>
<p><strong>äºŒã€</strong>åœ¨ä¸Šé¢æŒ‰runç»˜åˆ¶çš„åŸºç¡€ä¸Šåˆ¤æ–­ä¸€ä¸‹æœ‰æ— åˆ é™¤çº¿å±æ€§ï¼Œæœ‰å°±ç»˜åˆ¶ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//7.3 ä½¿ç”¨CTRunç»˜åˆ¶</span></span><br><span class="line"><span class="built_in">CFArrayRef</span> lines = <span class="built_in">CTFrameGetLines</span>(frame);</span><br><span class="line"><span class="built_in">CFIndex</span> numOfLines =  <span class="built_in">CFArrayGetCount</span>(lines);</span><br><span class="line">    <span class="comment">//è·å–æ¯ä¸€è¡Œçš„origin,CoreTextçš„originæ˜¯åœ¨å­—å½¢çš„baseLineå¤„</span></span><br><span class="line"><span class="built_in">CGPoint</span> lineOrigins[<span class="built_in">CFArrayGetCount</span>(lines)];</span><br><span class="line"><span class="built_in">CTFrameGetLineOrigins</span>(frame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), lineOrigins);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numOfLines; i++) &#123;</span><br><span class="line">    <span class="built_in">CTLineRef</span> line = <span class="built_in">CFArrayGetValueAtIndex</span>(lines, i);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ¯ä¸€è¡Œçš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">CGContextSetTextPosition</span>(context, lineOrigins[i].x, lineOrigins[i].y);</span><br><span class="line">        <span class="comment">//å¼€å§‹æ¯ä¸ªrunçš„ç»˜åˆ¶</span></span><br><span class="line">    <span class="built_in">CFArrayRef</span> runs = <span class="built_in">CTLineGetGlyphRuns</span>(line);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">CFArrayGetCount</span>(runs); j++) &#123;</span><br><span class="line">        <span class="built_in">CTRunRef</span> run = <span class="built_in">CFArrayGetValueAtIndex</span>(runs, j);</span><br><span class="line">        <span class="built_in">CTRunDraw</span>(run, context, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è·å–runçš„æ ·å¼</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *runAttributes = (<span class="built_in">NSDictionary</span> *)<span class="built_in">CTRunGetAttributes</span>(run);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šçš„æ ·å¼</span></span><br><span class="line">        <span class="keyword">if</span>(runAttributes[<span class="built_in">NSStrikethroughStyleAttributeName</span>] != <span class="literal">nil</span>)&#123;</span><br><span class="line">            <span class="comment">//ç»˜åˆ¶æ ·å¼</span></span><br><span class="line">            [<span class="keyword">self</span> drawStrikethroughStyleInRun:run attributes:runAttributes context:context];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¸‰ã€</strong> å®ç°æ–¹æ³• <code>-drawStrikethroughStyleInRun: attributes : context :</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç”»åˆ é™¤çº¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)drawStrikethroughStyleInRun:(<span class="built_in">CTRunRef</span>)run attributes: (<span class="built_in">NSDictionary</span>*)attributes context:(<span class="built_in">CGContextRef</span>)context &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CFNumberRef</span> styleRef = (__bridge <span class="built_in">CFNumberRef</span>)(attributes[<span class="built_in">NSStrikethroughStyleAttributeName</span>]);</span><br><span class="line">    <span class="built_in">NSUnderlineStyle</span> style = <span class="built_in">NSUnderlineStyleNone</span>;</span><br><span class="line">    <span class="built_in">CFNumberGetValue</span>(styleRef, kCFNumberSInt64Type, &amp;style);</span><br><span class="line">    <span class="keyword">if</span> (style == <span class="built_in">NSUnderlineStyleNone</span>) <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 2.è·å¾—ç”»çº¿çš„å®½åº¦</span></span><br><span class="line">    <span class="built_in">CGFloat</span> lineWidth = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>((style &amp; <span class="built_in">NSUnderlineStyleThick</span>) == <span class="built_in">NSUnderlineStyleThick</span>)&#123;</span><br><span class="line">        lineWidth = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CGContextSetLineWidth</span>(context, lineWidth);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3.è·å–ç”»çº¿çš„èµ·ç‚¹</span></span><br><span class="line">    <span class="built_in">CGPoint</span> firstP = <span class="built_in">CGPointZero</span>;</span><br><span class="line">    size_t length = <span class="built_in">CTRunGetGlyphCount</span>(run);</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">CGPoint</span> *firstGP = <span class="built_in">CTRunGetPositionsPtr</span>(run);</span><br><span class="line">    <span class="keyword">if</span> (!firstGP) &#123;</span><br><span class="line">        <span class="built_in">NSMutableData</span> *tempBuffer = [[<span class="built_in">NSMutableData</span> alloc] initWithLength:<span class="keyword">sizeof</span>(<span class="built_in">CGPoint</span>) * length];</span><br><span class="line">        <span class="built_in">CTRunGetPositions</span>(run, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, length), (<span class="built_in">CGPoint</span> *)tempBuffer.mutableBytes);</span><br><span class="line">        firstGP = tempBuffer.mutableBytes;</span><br><span class="line">    &#125;</span><br><span class="line">    firstP = *firstGP ;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4.å¼€å§‹ç”»çº¿</span></span><br><span class="line">    <span class="built_in">CGContextBeginPath</span>(context);</span><br><span class="line">    <span class="comment">//4.1 åˆ’çº¿çš„é¢œè‰²</span></span><br><span class="line">    <span class="built_in">CGColorRef</span> lineColor = (__bridge <span class="built_in">CGColorRef</span>)attributes[<span class="built_in">NSStrikethroughColorAttributeName</span>];</span><br><span class="line">    <span class="keyword">if</span>(lineColor == <span class="literal">nil</span>)&#123;</span><br><span class="line">        <span class="built_in">CGContextSetStrokeColorWithColor</span>(context, <span class="built_in">UIColor</span>.blueColor.CGColor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">CGContextSetStrokeColorWithColor</span>(context, lineColor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.2é«˜åº¦</span></span><br><span class="line">    <span class="built_in">UIFont</span>* font = attributes[<span class="built_in">NSFontAttributeName</span>];</span><br><span class="line">    <span class="keyword">if</span>(font == <span class="literal">nil</span>)&#123;</span><br><span class="line">        font = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="built_in">UIFont</span>.systemFontSize];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CGFloat</span> lineHeight = font.xHeight / <span class="number">2.0</span> + firstP.y;</span><br><span class="line">    <span class="comment">//4.3å¤šè¡Œå¤„ç†</span></span><br><span class="line">    <span class="built_in">CGPoint</span> pt =  <span class="built_in">CGContextGetTextPosition</span>(context);</span><br><span class="line">    lineHeight += pt.y;</span><br><span class="line">    <span class="comment">//4.5 åˆ é™¤çº¿çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">float</span> w = <span class="built_in">CTRunGetTypographicBounds</span>(run, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="literal">nil</span> , <span class="literal">nil</span>, <span class="literal">nil</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5. ç”»çº¿</span></span><br><span class="line">    <span class="built_in">CGContextMoveToPoint</span>(context, pt.x + firstP.x, lineHeight);</span><br><span class="line">    <span class="built_in">CGContextAddLineToPoint</span>(context, pt.x + firstP.x + w, lineHeight);</span><br><span class="line">    <span class="built_in">CGContextStrokePath</span>(context);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°æ•ˆæœï¼š</p>
<p><img src="/res/CoreText/CoreTextäºŒ.png" alt></p>
<h4 id="å®ç°è‡ªå®šä¹‰æ ·å¼-çŸ©å½¢æ¡†æ ‡æ³¨"><a href="#å®ç°è‡ªå®šä¹‰æ ·å¼-çŸ©å½¢æ¡†æ ‡æ³¨" class="headerlink" title="å®ç°è‡ªå®šä¹‰æ ·å¼-çŸ©å½¢æ¡†æ ‡æ³¨"></a>å®ç°è‡ªå®šä¹‰æ ·å¼-çŸ©å½¢æ¡†æ ‡æ³¨</h4><blockquote>
<p>è‡ªå®šä¹‰ä¸€ä¸ª<strong>TSRectColor</strong> ä¸€ä¸ªåŒ…ä½æ–‡å­—çš„çŸ©å½¢æ¡†ï¼Œå°è¯•å»å®ç°å®ƒã€‚</p>
</blockquote>
<p><strong>ä¸€ã€</strong> åœ¨ NSAttributedString ä¸­æ·»åŠ è‡ªå®šä¹‰å±æ€§ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è‡ªå®šä¹‰çš„çŸ©å½¢æ¡†</span></span><br><span class="line">[mAttStr addAttribute:<span class="string">@"TSRectColor"</span> value:[<span class="built_in">UIColor</span> yellowColor] range:<span class="built_in">NSMakeRange</span>(<span class="number">90</span>, <span class="number">18</span>)];</span><br></pre></td></tr></table></figure>
<p><strong>äºŒã€</strong> ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„å®ç°åˆ é™¤çº¿çš„ä»£ç ï¼Œæ·»åŠ å®ç°çŸ©å½¢æ¡†ã€‚ä¸å®ç°åˆ é™¤çº¿ä¸ä¸€æ ·çš„æ˜¯ï¼Œå®ç°çŸ©å½¢æ¡†éœ€è¦åœ¨<code>CTRunDraw</code>ä¹‹å‰ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//7.3 ä½¿ç”¨CTRunç»˜åˆ¶</span></span><br><span class="line"><span class="built_in">CFArrayRef</span> lines = <span class="built_in">CTFrameGetLines</span>(frame);</span><br><span class="line"><span class="built_in">CFIndex</span> numOfLines =  <span class="built_in">CFArrayGetCount</span>(lines);</span><br><span class="line">    <span class="comment">//è·å–æ¯ä¸€è¡Œçš„origin,CoreTextçš„originæ˜¯åœ¨å­—å½¢çš„baseLineå¤„</span></span><br><span class="line"><span class="built_in">CGPoint</span> lineOrigins[<span class="built_in">CFArrayGetCount</span>(lines)];</span><br><span class="line"><span class="built_in">CTFrameGetLineOrigins</span>(frame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), lineOrigins);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; numOfLines; i++) &#123;</span><br><span class="line">    <span class="built_in">CTLineRef</span> line = <span class="built_in">CFArrayGetValueAtIndex</span>(lines, i);</span><br><span class="line">        <span class="comment">//è®¾ç½®æ¯ä¸€è¡Œçš„ä½ç½®</span></span><br><span class="line">    <span class="built_in">CGContextSetTextPosition</span>(context, lineOrigins[i].x, lineOrigins[i].y);</span><br><span class="line">        <span class="comment">//å¼€å§‹æ¯ä¸ªrunçš„ç»˜åˆ¶</span></span><br><span class="line">    <span class="built_in">CFArrayRef</span> runs = <span class="built_in">CTLineGetGlyphRuns</span>(line);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">CFArrayGetCount</span>(runs); j++) &#123;</span><br><span class="line">        <span class="built_in">CTRunRef</span> run = <span class="built_in">CFArrayGetValueAtIndex</span>(runs, j);</span><br><span class="line">        <span class="comment">//è·å–runçš„æ ·å¼</span></span><br><span class="line">        <span class="built_in">NSDictionary</span> *runAttributes = (<span class="built_in">NSDictionary</span> *)<span class="built_in">CTRunGetAttributes</span>(run);</span><br><span class="line">        <span class="keyword">if</span>(runAttributes[<span class="string">@"TSRectColor"</span>])&#123;</span><br><span class="line">            <span class="comment">//ç»˜åˆ¶è‡ªå®šä¹‰çŸ©å½¢æ¡† (éœ€è¦æ”¾åœ¨CTRunDrawä¹‹å‰ å¦åˆ™ç»˜åˆ¶çš„é¢œè‰²ä¼šæŒ¡ä½æ–‡å­—)</span></span><br><span class="line">            [<span class="keyword">self</span> drawRectColorInRun:run  attributes:runAttributes context:context];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CTRunDraw</span>(run, context, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šçš„æ ·å¼</span></span><br><span class="line">        <span class="keyword">if</span>(runAttributes[<span class="built_in">NSStrikethroughStyleAttributeName</span>] != <span class="literal">nil</span>)&#123;</span><br><span class="line">            <span class="comment">//ç»˜åˆ¶åˆ é™¤çº¿</span></span><br><span class="line">            [<span class="keyword">self</span> drawStrikethroughStyleInRun:run attributes:runAttributes context:context];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¸‰ã€</strong> å®ç° <code>-drawRectColorInRun: attributes: context:</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç»˜åˆ¶çŸ©å½¢æ¡†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)drawRectColorInRun:(<span class="built_in">CTRunRef</span>)run attributes: (<span class="built_in">NSDictionary</span>*)attributes context:(<span class="built_in">CGContextRef</span>)context &#123;</span><br><span class="line">    <span class="comment">//1.åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨å•Š</span></span><br><span class="line">    <span class="built_in">UIColor</span>* color = attributes[<span class="string">@"TSRectColor"</span>];</span><br><span class="line">    <span class="keyword">if</span>(!color)<span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//2.ç”»çº¿çš„èµ·ç‚¹</span></span><br><span class="line">    <span class="built_in">CGPoint</span> firstPoint = [<span class="keyword">self</span> firstPointInRun:run];</span><br><span class="line">    <span class="comment">//3.è·å–runçš„å®½åº¦ ascent descent</span></span><br><span class="line">    <span class="built_in">CGFloat</span> ascent,descent;</span><br><span class="line">    <span class="keyword">double</span> typographicBounds = <span class="built_in">CTRunGetTypographicBounds</span>(run , <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), &amp;ascent, &amp;descent, <span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPoint</span> textP = <span class="built_in">CGContextGetTextPosition</span>(context);</span><br><span class="line">    <span class="comment">//4. éœ€è¦å¡«å……çš„åŒºåŸŸ</span></span><br><span class="line">    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectMake</span>(firstPoint.x + textP.x, textP.y + firstPoint.y - descent, typographicBounds, ascent + descent);</span><br><span class="line">    <span class="comment">//5. å¼€å§‹å¡«å……é¢œè‰²</span></span><br><span class="line">    <span class="built_in">CGContextSetStrokeColorWithColor</span>(context , color.CGColor);</span><br><span class="line">    <span class="built_in">CGContextAddRect</span>(context, rect);</span><br><span class="line">    <span class="built_in">CGContextStrokePath</span>(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°æ•ˆæœï¼š</p>
<p><img src="/res/CoreText/coreTextä¸‰.png" alt></p>
<h3 id="æ·»åŠ è¶…é“¾æ¥"><a href="#æ·»åŠ è¶…é“¾æ¥" class="headerlink" title="æ·»åŠ è¶…é“¾æ¥"></a>æ·»åŠ è¶…é“¾æ¥</h3><blockquote>
<p>å¦‚ä½•è¯†åˆ«æ–‡å­—ä¸­çš„è¶…é“¾æ¥ ä¸åŒåœºæ™¯æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œè¿™é‡Œå°±ä¸å¤„ç†äº†ã€‚</p>
</blockquote>
<blockquote>
<p>æ·»åŠ è¶…é“¾æ¥ ç®€å•æ¥è®²å°±æ˜¯é‡å†™touchesBeganæ–¹æ³• è·å–ç‚¹å‡»çš„ç‚¹ï¼Œå†åˆ°<code>CTFrameRef</code>ä¸­æ¯”è¾ƒ</p>
</blockquote>
<p>é‡å†™touchesBeganæ–¹æ³• æ ¹æ®touchäº‹ä»¶è·å–ç‚¹point</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</span><br><span class="line">    <span class="built_in">UITouch</span>* touch = [touches anyObject];</span><br><span class="line">    <span class="built_in">CGPoint</span> point = [touch locationInView:<span class="keyword">self</span>];</span><br><span class="line">    <span class="keyword">bool</span> ifClicked = [<span class="keyword">self</span> ifClickLink:point];</span><br><span class="line">    <span class="keyword">if</span> (ifClicked) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"ç‚¹å‡»äº†è¿æ¥"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ¤æ–­touchç‚¹</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">bool</span>)ifClickLink:(<span class="built_in">CGPoint</span>)point&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">CGRectContainsPoint</span>(<span class="keyword">self</span>.bounds, point)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//textFrame é€šè¿‡CTFrameGetLineOriginsè·å–æ‰€æœ‰lineçš„åŸç‚¹</span></span><br><span class="line">    <span class="built_in">CFArrayRef</span> lines = <span class="built_in">CTFrameGetLines</span>(<span class="keyword">self</span>.textFrame);</span><br><span class="line">    <span class="keyword">if</span>(!lines) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">CFIndex</span> count = <span class="built_in">CFArrayGetCount</span>(lines);</span><br><span class="line">    <span class="built_in">CGPoint</span> origins[count];</span><br><span class="line">    <span class="built_in">CTFrameGetLineOrigins</span>(<span class="keyword">self</span>.textFrame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), origins);</span><br><span class="line">    <span class="comment">//CoreTextåæ ‡ç³»ä¸åŒç¿»è½¬ä¸€ä¸‹</span></span><br><span class="line">    <span class="built_in">CGAffineTransform</span> transform = <span class="built_in">CGAffineTransformScale</span>(<span class="built_in">CGAffineTransformMakeTranslation</span>(<span class="number">0</span>, <span class="keyword">self</span>.bounds.size.height), <span class="number">1.</span>f, <span class="number">-1.</span>f);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="built_in">CGPoint</span> linePoint = origins[i];</span><br><span class="line">        <span class="built_in">CTLineRef</span> line = <span class="built_in">CFArrayGetValueAtIndex</span>(lines , i);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è·å–CTLineçš„åŒºåŸŸ</span></span><br><span class="line">        <span class="built_in">CGFloat</span> ascent = <span class="number">0.0</span>f;</span><br><span class="line">        <span class="built_in">CGFloat</span> descent = <span class="number">0.0</span>f;</span><br><span class="line">        <span class="built_in">CGFloat</span> leading = <span class="number">0.0</span>f;</span><br><span class="line">        <span class="built_in">CGFloat</span> width = (<span class="built_in">CGFloat</span>)<span class="built_in">CTLineGetTypographicBounds</span>(line, &amp;ascent, &amp;descent, &amp;leading);</span><br><span class="line">        <span class="built_in">CGFloat</span> height = ascent + descent;</span><br><span class="line">        <span class="built_in">CGRect</span> flippedLineRect = <span class="built_in">CGRectMake</span>(linePoint.x, linePoint.y - descent, width, height);</span><br><span class="line">        <span class="built_in">CGRect</span> lineRect = <span class="built_in">CGRectApplyAffineTransform</span>(flippedLineRect, transform);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//æ¯”è¾ƒpointå’Œline è·å–ç‚¹å‡»å¤„äºå“ªä¸ªline</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">CGRectContainsPoint</span>(lineRect, point)) &#123;</span><br><span class="line">            <span class="comment">//lineã€point é€šè¿‡CTLineGetStringIndexForPositionè·å–åˆ°ç‚¹å‡»å­—ç¬¦åœ¨æ•´æ®µæ–‡å­—ä¸­çš„ index</span></span><br><span class="line">            <span class="built_in">CFIndex</span> idx = <span class="built_in">CTLineGetStringIndexForPosition</span>(line, point);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%ld"</span>,idx);</span><br><span class="line">            <span class="comment">//åˆ¤æ–­ç‚¹å‡»çš„æ–‡å­—æ˜¯å¦åœ¨é“¾æ¥æ–‡å­—åŒºåŸŸ</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> ifClickRangeContainIndex:idx];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±ç›‘æµ‹åˆ°äº†ç‚¹å‡»äº‹ä»¶ï¼Œå¹¶ä¸”çŸ¥é“ç‚¹å‡»äº†å“ªä¸ªå­—ç¬¦ã€‚å†åšç›¸å…³è¶…é“¾æ¥çš„ç‚¹å‡»é€»è¾‘ï¼Œå°±æ·»åŠ è¶…é“¾æ¥åŠŸèƒ½æˆåŠŸäº†ã€‚</p>
<blockquote>
<p>ä»¥ä¸Šä»£ç éƒ½åœ¨ <a href="https://github.com/sunyanyan/TSCode/blob/master/CoreText/CoreText/TestView.m" target="_blank" rel="noopener">https://github.com/sunyanyan/TSCode/blob/master/CoreText/CoreText/TestView.m</a> </p>
</blockquote>
<h3 id="å›¾æ–‡æ··æ’"><a href="#å›¾æ–‡æ··æ’" class="headerlink" title="å›¾æ–‡æ··æ’"></a>å›¾æ–‡æ··æ’</h3><blockquote>
<p>CoreTextæ˜¯ä¸ç›´æ¥æ”¯æŒç»˜åˆ¶å›¾ç‰‡çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å…ˆåœ¨éœ€è¦æ˜¾ç¤ºå›¾ç‰‡çš„åœ°æ–¹ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ç©ºç™½å ä½ç¬¦ä»£æ›¿ï¼ŒåŒæ—¶è®¾ç½®è¯¥å­—ä½“çš„CTRunDelegateä¿¡æ¯ä¸ºè¦æ˜¾ç¤ºçš„å›¾ç‰‡çš„å®½åº¦å’Œé«˜åº¦ï¼Œè¿™æ ·ç»˜åˆ¶æ–‡å­—çš„æ—¶å€™å°±ä¼šå…ˆæŠŠå›¾ç‰‡çš„ä½ç½®ç•™å‡ºæ¥ï¼Œå†åœ¨drawRectæ–¹æ³•é‡Œé¢ç”¨CGContextDrawImageç»˜åˆ¶å›¾ç‰‡ã€‚</p>
</blockquote>
<p>åœ¨NSMutableStringä¸­æ·»åŠ ç©ºç™½å­—ç¬¦ä¸ºå›¾ç‰‡å ä½</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)addImageAttStr&#123;</span><br><span class="line">    <span class="comment">//å›¾æ–‡æ··æ’éƒ¨åˆ†</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CTRunDelegateCallbacksï¼šä¸€ä¸ªç”¨äºä¿å­˜æŒ‡é’ˆçš„ç»“æ„ä½“ï¼Œç”±CTRun delegateè¿›è¡Œå›è°ƒ</span></span><br><span class="line">    <span class="built_in">CTRunDelegateCallbacks</span> callbacks;</span><br><span class="line">    memset(&amp;callbacks, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">CTRunDelegateCallbacks</span>));</span><br><span class="line">    callbacks.version = kCTRunDelegateVersion1;</span><br><span class="line">    callbacks.getAscent = ascentCallback;</span><br><span class="line">    callbacks.getDescent = descentCallback;</span><br><span class="line">    callbacks.getWidth = widthCallback;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å›¾ç‰‡ä¿¡æ¯å­—å…¸</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *imgInfoDic = @&#123;<span class="string">@"width"</span>:@<span class="number">100</span>,<span class="string">@"height"</span>:@<span class="number">30</span>&#125;;</span><br><span class="line">    <span class="comment">// è®¾ç½®CTRunçš„ä»£ç†</span></span><br><span class="line">    <span class="built_in">CTRunDelegateRef</span> delegate = <span class="built_in">CTRunDelegateCreate</span>(&amp;callbacks, (__bridge <span class="keyword">void</span> *)imgInfoDic);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨0xFFFCä½œä¸ºç©ºç™½çš„å ä½ç¬¦</span></span><br><span class="line">    <span class="keyword">unichar</span> objectReplacementChar = <span class="number">0xFFFC</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *content = [<span class="built_in">NSString</span> stringWithCharacters:&amp;objectReplacementChar length:<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">NSMutableAttributedString</span> *space = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:content];</span><br><span class="line">    <span class="built_in">CFAttributedStringSetAttribute</span>((<span class="built_in">CFMutableAttributedStringRef</span>)space, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">1</span>), kCTRunDelegateAttributeName, delegate);</span><br><span class="line">    <span class="built_in">CFRelease</span>(delegate);</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.sampleAttStr insertAttributedString:space atIndex:<span class="number">50</span>];</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ç”¨åˆ°çš„CTRun delegateå›è°ƒ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> ascentCallback(<span class="keyword">void</span> *ref) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [(<span class="built_in">NSNumber</span> *)[(__bridge <span class="built_in">NSDictionary</span> *)ref objectForKey:<span class="string">@"height"</span>] floatValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> descentCallback(<span class="keyword">void</span> *ref) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">CGFloat</span> widthCallback(<span class="keyword">void</span> *ref) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [(<span class="built_in">NSNumber</span> *)[(__bridge <span class="built_in">NSDictionary</span> *)ref objectForKey:<span class="string">@"width"</span>] floatValue];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨CTFrameDrawä¹‹åç”¨CGContextDrawImageç»˜åˆ¶å›¾ç‰‡</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//8. ç»˜åˆ¶å›¾ç‰‡</span></span><br><span class="line"><span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"one.png"</span>];</span><br><span class="line"><span class="built_in">CGContextDrawImage</span>(context, [<span class="keyword">self</span> calculateImagePositionInCTFrame:frame], image.CGImage);</span><br></pre></td></tr></table></figure>
<p>ç”¨åˆ°çš„calculateImagePositionInCTFrameæ–¹æ³•:<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">CGRect</span>)calculateImagePositionInCTFrame:(<span class="built_in">CTFrameRef</span>)ctFrame &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// è·å¾—CTLineæ•°ç»„</span></span><br><span class="line">    <span class="built_in">NSArray</span> *lines = (<span class="built_in">NSArray</span> *)<span class="built_in">CTFrameGetLines</span>(ctFrame);</span><br><span class="line">    <span class="built_in">NSInteger</span> lineCount = [lines count];</span><br><span class="line">    <span class="built_in">CGPoint</span> lineOrigins[lineCount];</span><br><span class="line">    <span class="built_in">CTFrameGetLineOrigins</span>(ctFrame, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), lineOrigins);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// éå†æ¯ä¸ªCTLine</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span> ; i &lt; lineCount; i++) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CTLineRef</span> line = (__bridge <span class="built_in">CTLineRef</span>)lines[i];</span><br><span class="line">        <span class="built_in">NSArray</span> *runObjArray = (<span class="built_in">NSArray</span> *)<span class="built_in">CTLineGetGlyphRuns</span>(line);</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// éå†æ¯ä¸ªCTLineä¸­çš„CTRun</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> runObj <span class="keyword">in</span> runObjArray) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CTRunRef</span> run = (__bridge <span class="built_in">CTRunRef</span>)runObj;</span><br><span class="line">            <span class="built_in">NSDictionary</span> *runAttributes = (<span class="built_in">NSDictionary</span> *)<span class="built_in">CTRunGetAttributes</span>(run);</span><br><span class="line">            <span class="built_in">CTRunDelegateRef</span> delegate = (__bridge <span class="built_in">CTRunDelegateRef</span>)[runAttributes valueForKey:(<span class="keyword">id</span>)kCTRunDelegateAttributeName];</span><br><span class="line">            <span class="keyword">if</span> (delegate == <span class="literal">nil</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">NSDictionary</span> *metaDic = <span class="built_in">CTRunDelegateGetRefCon</span>(delegate);</span><br><span class="line">            <span class="keyword">if</span> (![metaDic isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGRect</span> runBounds;</span><br><span class="line">            <span class="built_in">CGFloat</span> ascent;</span><br><span class="line">            <span class="built_in">CGFloat</span> descent;</span><br><span class="line">            </span><br><span class="line">            runBounds.size.width = <span class="built_in">CTRunGetTypographicBounds</span>(run, <span class="built_in">CFRangeMake</span>(<span class="number">0</span>, <span class="number">0</span>), &amp;ascent, &amp;descent, <span class="literal">NULL</span>);</span><br><span class="line">            runBounds.size.height = ascent + descent;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGFloat</span> xOffset = <span class="built_in">CTLineGetOffsetForStringIndex</span>(line, <span class="built_in">CTRunGetStringRange</span>(run).location, <span class="literal">NULL</span>);</span><br><span class="line">            runBounds.origin.x = lineOrigins[i].x + xOffset;</span><br><span class="line">            runBounds.origin.y = lineOrigins[i].y;</span><br><span class="line">            runBounds.origin.y -= descent;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGPathRef</span> pathRef = <span class="built_in">CTFrameGetPath</span>(ctFrame);</span><br><span class="line">            <span class="built_in">CGRect</span> colRect = <span class="built_in">CGPathGetBoundingBox</span>(pathRef);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGRect</span> delegateBounds = <span class="built_in">CGRectOffset</span>(runBounds, colRect.origin.x, colRect.origin.y);</span><br><span class="line">            <span class="keyword">return</span> delegateBounds;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CGRectZero</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¦‚å›¾:</p>
<p><img src="/res/CoreText/coreTextImage.png" alt></p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>GCDç›¸å…³.md</title>
    <url>/essay/GCD/</url>
    <content><![CDATA[<blockquote>
<p>OS X 10.8æˆ–iOS 6ä»¥åŠä¹‹åç‰ˆæœ¬ä¸­ä½¿ç”¨ï¼ŒDispatch Queueå°†ä¼šç”±ARCè‡ªåŠ¨ç®¡ç†,ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾</p>
</blockquote>
<h2 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h2><blockquote>
<p>åˆ†ä¸ºä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶å‘é˜Ÿåˆ—<br><a id="more"></a></p>
</blockquote>
<ul>
<li>å°†å¤šä¸ªä»»åŠ¡æäº¤ç»™ä¸²è¡Œé˜Ÿåˆ—ï¼Œå¤šä¸ªä»»åŠ¡åªèƒ½æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œï¼Œæ‰èƒ½å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡</li>
<li>å°†å¤šä¸ªä»»åŠ¡äº¤ç»™å¹¶å‘é˜Ÿåˆ—ï¼Œå¹¶å‘é˜Ÿåˆ—å¯ä»¥æŒ‰FIFOçš„é¡ºåºå¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆé¡ºåºæŒ‰ä»»åŠ¡å’Œç³»ç»Ÿå†³å®š</li>
</ul>
<blockquote>
<p>è·å–é˜Ÿåˆ—ï¼š</p>
</blockquote>
<ul>
<li>dispatch_get_main_queue() <ul>
<li>è·å–ä¸»çº¿ç¨‹å…³è”ä¸²è¡Œé˜Ÿåˆ—</li>
</ul>
</li>
<li>dispatch_get_current_queue()<ul>
<li>è·å–å½“å‰æ‰§è¡Œä»£ç æ‰€åœ¨é˜Ÿåˆ—</li>
</ul>
</li>
<li>dispatch_get_global_queue(long identifier, unsigned long flags)<ul>
<li>è·å–ç³»ç»Ÿçš„å…¨å±€å¹¶å‘é˜Ÿåˆ—</li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æ¥å—ä¸€ä¸‹å››ä¸ªä¼˜å…ˆçº§<ul>
<li>DISPATCH_QUEUE_PRIORITY_HIGH:         </li>
<li>DISPATCH_QUEUE_PRIORITY_DEFAULT:       </li>
<li>DISPATCH_QUEUE_PRIORITY_LOW:           </li>
<li>DISPATCH_QUEUE_PRIORITY_BACKGROUND: </li>
</ul>
</li>
<li>ç¬¬äºŒä¸ªå‚æ•°ä¸€èˆ¬ä¼ å…¥0</li>
</ul>
</li>
</ul>
<blockquote>
<p>åˆ›å»ºé˜Ÿåˆ—ï¼š</p>
</blockquote>
<ul>
<li>dispatch_queue_create(const char *label, dispatch_queue_attr_t attr)<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºé˜Ÿåˆ—å¯¹åº”å­—ç¬¦ä¸²æ ‡ç­¾</li>
<li>ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šé˜Ÿåˆ—ç±»å‹ï¼Œåˆ†ä¸ºï¼š<ul>
<li>DISPATCH_QUEUE_SERIAL  ä¸²è¡Œ</li>
<li>DISPATCH_QUEUE_CONCURRENT å¹¶å‘    </li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>è·å–é˜Ÿåˆ—ç›¸å…³ä¿¡æ¯</p>
</blockquote>
<ul>
<li>dispatch_queue_get_label(dispatch_queue_t queue);<ul>
<li>è·å–é˜Ÿåˆ—å¯¹åº”çš„æ ‡ç­¾ </li>
</ul>
</li>
</ul>
<h3 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a>æäº¤ä»»åŠ¡</h3><ul>
<li>dispatch_async(dispatch_queue_t queue, dispatch_block_t block);<ul>
<li>å°†ä»£ç å—ä»¥å¼‚æ­¥æ–¹å¼æäº¤ç»™æŒ‡å®šé˜Ÿåˆ—</li>
</ul>
</li>
<li>dispatch_sync(dispatch_queue_t queue, dispatch_block_t block);<ul>
<li>å°†ä»£ç å—ä»¥åŒæ­¥æ–¹å¼æäº¤ç»™æŒ‡å®šé˜Ÿåˆ—</li>
<li><strong>å…ˆåæäº¤çš„ä¸¤ä¸ªä»£ç å—ï¼ˆå³ä½¿æäº¤ç»™å¹¶å‘é˜Ÿåˆ—ï¼‰ï¼Œå‰ä¸€ä¸ªæ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ª</strong></li>
</ul>
</li>
<li>dispatch_after(dispatch_time_t when, dispatch_queue_t queue, dispatch_block_t block);<ul>
<li>å°†ä»£ç å—ä»¥å¼‚æ­¥æ–¹å¼æäº¤ç»™æŒ‡å®šé˜Ÿåˆ—,å¹¶åœ¨dispatch_timeæŒ‡å®šçš„æ—¶é—´å¼€å§‹æ‰§è¡Œ</li>
</ul>
</li>
<li>dispatch_apply(size_t iterations, dispatch_queue_t queue, void (^block)(size_t));<ul>
<li>å°†ä»£ç å—ä»¥å¼‚æ­¥æ–¹å¼æäº¤ç»™æŒ‡å®šé˜Ÿåˆ—,é‡å¤æ‰§è¡Œä»£ç </li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šé‡å¤å‡ æ¬¡</li>
<li>ç¬¬ä¸‰ä¸ªå‚æ•° blockä»£ç å—çš„ size_tè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œç¬¬å‡ æ¬¡</li>
</ul>
</li>
<li>dispatch_once(dispatch_once_t *predicate, dispatch_block_t block);<ul>
<li>åœ¨ä»»åŠ¡æäº¤ç»™é˜Ÿåˆ—ï¼Œåœ¨åº”ç”¨çš„æŸä¸ªç”Ÿå‘½å‘¨æœŸå†…åªæ‰§è¡Œä¸€æ¬¡</li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºä»£ç å—æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡</li>
</ul>
</li>
</ul>
<h3 id="å–æ¶ˆä»»åŠ¡"><a href="#å–æ¶ˆä»»åŠ¡" class="headerlink" title="å–æ¶ˆä»»åŠ¡"></a>å–æ¶ˆä»»åŠ¡</h3><p><code>dispatch_block_cancel</code>ã€‚ iOS8ä¹‹åå¯ä»¥è°ƒç”¨dispatch_block_cancelæ¥å–æ¶ˆï¼ˆéœ€è¦æ³¨æ„å¿…é¡»ç”¨dispatch_block_createåˆ›å»ºdispatch_block_tï¼‰<br>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)gcdBlockCancel&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.gcdtest.www"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block1 = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block1 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block2 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block3 = dispatch_block_create(<span class="number">0</span>, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block3 %@"</span>,[<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, block1);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, block2);</span><br><span class="line">    dispatch_block_cancel(block3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dispatch-group"><a href="#dispatch-group" class="headerlink" title="dispatch_group"></a>dispatch_group</h2><ul>
<li><p>void dispatch_group_notify(dispatch_group_t group,<br>  dispatch_queue_t queue,<br>  dispatch_block_t block); </p>
<ul>
<li>groupä¸­æ‰€æœ‰ä»£ç å—æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œ    </li>
</ul>
</li>
<li><p>long dispatch_group_wait(dispatch_group_t group, dispatch_time_t timeout);</p>
<ul>
<li>è¿”å›å€¼è¡¨ç¤ºç»è¿‡æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ï¼Œå±äºè¿™ä¸ªgroupçš„ä»»åŠ¡æ˜¯å¦å·²ç»å…¨éƒ¨æ‰§è¡Œå®Œï¼Œå¦‚æœæ˜¯åˆ™è¿”å›0ï¼Œå¦åˆ™è¿”å›é0ã€‚ </li>
<li>ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºç­‰å¾…çš„group </li>
<li>ç¬¬äºŒä¸ªå‚æ•°åˆ™è¡¨ç¤ºç­‰å¾…æ—¶é—´ï¼Œæœ‰ä¸¤ä¸ªç‰¹æ®Šå€¼<ul>
<li>DISPATCH_TIME_NOW è¡¨ç¤ºç«‹åˆ»æ£€æŸ¥å±äºè¿™ä¸ªgroupçš„ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆ</li>
<li>DISPATCH_TIME_FOREVER è¡¨ç¤ºä¸€ç›´ç­‰åˆ°å±äºè¿™ä¸ªgroupçš„ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">let globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)</span><br><span class="line">let group = dispatch_group_create()</span><br><span class="line"></span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"1"</span>)</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"2"</span>)</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"3"</span>)</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_notify(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"completed"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„é¡ºåºä¸æ·»åŠ è¿›é˜Ÿåˆ—çš„é¡ºåºæ— å…³ï¼Œå› ä¸ºé˜Ÿåˆ—æ˜¯Concurrent Dispatch Queueï¼Œä½†â€œcompletedâ€çš„è¾“å‡ºä¸€å®šæ˜¯åœ¨æœ€åçš„    </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">let globalQueue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>)</span><br><span class="line">let group = dispatch_group_create()</span><br><span class="line"></span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"1"</span>)</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"2"</span>)</span><br><span class="line">&#125;</span><br><span class="line">dispatch_group_async(group, globalQueue) &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   println(<span class="string">"3"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä½¿ç”¨dispatch_group_waitå‡½æ•°</span></span><br><span class="line">dispatch_group_wait(group, DISPATCH_TIME_FOREVER)</span><br><span class="line">println(<span class="string">"completed"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="æš‚åœå’Œæ¢å¤"><a href="#æš‚åœå’Œæ¢å¤" class="headerlink" title="æš‚åœå’Œæ¢å¤"></a>æš‚åœå’Œæ¢å¤</h3><blockquote>
<p>è¿™äº›å‡½æ•°ä¸ä¼šå½±å“åˆ°é˜Ÿåˆ—ä¸­å·²ç»æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé˜Ÿåˆ—æš‚åœåï¼Œå·²ç»æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ä½†è¿˜æ²¡æœ‰æ‰§è¡Œçš„ä»»åŠ¡ä¸ä¼šæ‰§è¡Œï¼Œç›´åˆ°é˜Ÿåˆ—è¢«æ¢å¤</p>
</blockquote>
<ul>
<li>dispatch_suspend(queue) //æš‚åœæŸä¸ªé˜Ÿåˆ—  </li>
<li>dispatch_resume(queue)  //æ¢å¤æŸä¸ªé˜Ÿåˆ—    </li>
</ul>
<h2 id="dispatch-barrier-async"><a href="#dispatch-barrier-async" class="headerlink" title="dispatch barrier async"></a>dispatch barrier async</h2><p>æˆ‘ä»¬çŸ¥é“æ•°æ®åœ¨å†™å…¥æ—¶ï¼Œä¸èƒ½åœ¨å…¶ä»–çº¿ç¨‹è¯»å–æˆ–å†™å…¥ã€‚ä½†æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–æ•°æ®æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¯»å–ä»»åŠ¡æ”¾å…¥å¹¶è¡Œé˜Ÿåˆ—ï¼ŒæŠŠå†™å…¥ä»»åŠ¡æ”¾å…¥ä¸²è¡Œé˜Ÿåˆ—ï¼Œå¹¶ä¸”ä¿è¯å†™å…¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰è¯»å–ä»»åŠ¡å¯ä»¥æ‰§è¡Œã€‚</p>
<p>è¿™æ ·çš„éœ€æ±‚æ¯”è¾ƒå¸¸è§ï¼ŒGCDæä¾›äº†ä¸€ä¸ªéå¸¸ç®€å•çš„è§£å†³åŠæ³•â€”â€”dispatch_barrier_async</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰å››ä¸ªè¯»å–ä»»åŠ¡ï¼Œåœ¨ç¬¬äºŒä¸‰ä¸ªä»»åŠ¡ä¹‹é—´æœ‰ä¸€ä¸ªå†™å…¥ä»»åŠ¡ï¼Œä»£ç å¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">let queue = dispatch_queue_create(<span class="string">"com.gcd.kt"</span>, DISPATCH_QUEUE_CONCURRENT)</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block1_for_reading)  </span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block2_for_reading)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   	è¿™é‡Œæ’å…¥å†™å…¥ä»»åŠ¡ï¼Œæ¯”å¦‚ï¼š</span></span><br><span class="line"><span class="comment">   	dispatch_async(queue, block_for_writing)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block3_for_reading)  </span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block4_for_reading)</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä»£ç è¿™æ ·å†™ï¼Œç”±äºè¿™å‡ ä¸ªblockæ˜¯å¹¶å‘æ‰§è¡Œï¼Œå°±æœ‰å¯èƒ½åœ¨å‰ä¸¤ä¸ªblockä¸­è¯»å–åˆ°å·²ç»ä¿®æ”¹äº†çš„æ•°æ®ã€‚å¦‚æœæ˜¯æœ‰å¤šå†™å…¥ä»»åŠ¡ï¼Œé‚£é—®é¢˜æ›´ä¸¥é‡ï¼Œå¯èƒ½ä¼šæœ‰æ•°æ®ç«äº‰ã€‚</p>
<p>å¦‚æœä½¿ç”¨dispatch_barrier_asyncå‡½æ•°ï¼Œä»£ç å°±å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(queue, block1_for_reading)  </span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block2_for_reading)</span><br><span class="line"></span><br><span class="line">dispatch_barrier_async(queue, block_for_writing)</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block3_for_reading)  </span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block4_for_reading)</span><br></pre></td></tr></table></figure>
<p>dispatch_barrier_asyncä¼šæŠŠå¹¶è¡Œé˜Ÿåˆ—çš„è¿è¡Œå‘¨æœŸåˆ†ä¸ºè¿™ä¸‰ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆç­‰ç›®å‰è¿½åŠ åˆ°å¹¶è¡Œé˜Ÿåˆ—ä¸­æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆ</li>
<li>å¼€å§‹æ‰§è¡Œdispatch_barrier_asyncä¸­çš„ä»»åŠ¡ï¼Œè¿™æ—¶å€™å³ä½¿å‘å¹¶è¡Œé˜Ÿåˆ—æäº¤ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œ</li>
<li>dispatch_barrier_asyncä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå¹¶è¡Œé˜Ÿåˆ—æ¢å¤æ­£å¸¸ã€‚</li>
</ol>
<p>æ€»çš„æ¥è¯´ï¼Œdispatch_barrier_asyncèµ·åˆ°äº†â€œæ‰¿ä¸Šå¯ä¸‹â€çš„ä½œç”¨ã€‚å®ƒä¿è¯æ­¤å‰çš„ä»»åŠ¡éƒ½å…ˆäºè‡ªå·±æ‰§è¡Œï¼Œæ­¤åçš„ä»»åŠ¡ä¹Ÿè¿Ÿäºè‡ªå·±æ‰§è¡Œã€‚æ­£å¦‚barrierçš„å«ä¹‰ä¸€æ ·ï¼Œå®ƒèµ·åˆ°äº†ä¸€ä¸ªæ …æ ã€æˆ–æ˜¯åˆ†æ°´å²­çš„ä½œç”¨ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œä½¿ç”¨å¹¶è¡Œé˜Ÿåˆ—å’Œdispatc_barrier_asyncæ–¹æ³•ï¼Œå°±å¯ä»¥é«˜æ•ˆçš„è¿›è¡Œæ•°æ®å’Œæ–‡ä»¶è¯»å†™äº†ã€‚</p>
<h2 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h2><p><strong>dispatch_semaphore</strong></p>
<p>é¦–å…ˆä»‹ç»ä¸€ä¸‹ä¿¡å·é‡(semaphore)çš„æ¦‚å¿µã€‚ä¿¡å·é‡æ˜¯æŒæœ‰è®¡æ•°çš„ä¿¡å·ï¼Œä¸è¿‡è¿™ä¹ˆè§£é‡Šç­‰äºæ²¡è§£é‡Šã€‚æˆ‘ä»¬ä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥çœ‹çœ‹ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªæˆ¿å­ï¼Œå®ƒå¯¹åº”è¿›ç¨‹çš„æ¦‚å¿µï¼Œæˆ¿å­é‡Œçš„äººå°±å¯¹åº”ç€çº¿ç¨‹ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…æ‹¬å¤šä¸ªçº¿ç¨‹ã€‚è¿™ä¸ªæˆ¿å­(è¿›ç¨‹)æœ‰å¾ˆå¤šèµ„æºï¼Œæ¯”å¦‚èŠ±å›­ã€å®¢å…ç­‰ï¼Œæ˜¯æ‰€æœ‰äºº(çº¿ç¨‹)å…±äº«çš„ã€‚</p>
<p>ä½†æ˜¯æœ‰äº›åœ°æ–¹ï¼Œæ¯”å¦‚å§å®¤ï¼Œæœ€å¤šåªæœ‰ä¸¤ä¸ªäººèƒ½è¿›å»ç¡è§‰ã€‚æ€ä¹ˆåŠå‘¢ï¼Œåœ¨å§å®¤é—¨å£æŒ‚ä¸Šä¸¤æŠŠé’¥åŒ™ã€‚è¿›å»çš„äºº(çº¿ç¨‹)æ‹¿ç€é’¥åŒ™è¿›å»ï¼Œæ²¡æœ‰é’¥åŒ™å°±ä¸èƒ½è¿›å»ï¼Œå‡ºæ¥çš„æ—¶å€™æŠŠé’¥åŒ™æ”¾å›é—¨å£ã€‚</p>
<p>è¿™æ—¶å€™ï¼Œé—¨å£çš„é’¥åŒ™æ•°é‡å°±ç§°ä¸ºä¿¡å·é‡(Semaphore)ã€‚å¾ˆæ˜æ˜¾ï¼Œä¿¡å·é‡ä¸º0æ—¶éœ€è¦ç­‰å¾…ï¼Œä¿¡å·é‡ä¸ä¸ºé›¶æ—¶ï¼Œå‡å»1è€Œä¸”ä¸ç­‰å¾…ã€‚</p>
<p>dispatch_semaphore ä¸ä»–ç›¸å…³çš„å…±æœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li>dispatch_semaphore_createï¼Œ</li>
<li>dispatch_semaphore_signalï¼Œ</li>
<li>dispatch_semaphore_waitã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬é€ä¸€ä»‹ç»ä¸‰ä¸ªå‡½æ•°ï¼š</p>
<blockquote>
<p>dispatch_semaphore_createçš„å£°æ˜ä¸ºï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ã€€ã€€dispatch_semaphore_t  dispatch_semaphore_create(<span class="keyword">long</span> value);</span><br></pre></td></tr></table></figure>
<p>ä¼ å…¥çš„å‚æ•°ä¸ºlongï¼Œè¾“å‡ºä¸€ä¸ªdispatch_semaphore_tç±»å‹ä¸”å€¼ä¸ºvalueçš„ä¿¡å·é‡ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ä¼ å…¥çš„å‚æ•°valueå¿…é¡»å¤§äºæˆ–ç­‰äº0ï¼Œå¦åˆ™dispatch_semaphore_createä¼šè¿”å›NULLã€‚</p>
<blockquote>
<p>dispatch_semaphore_signalçš„å£°æ˜ä¸ºï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ã€€ã€€<span class="keyword">long</span> dispatch_semaphore_signal(dispatch_semaphore_t dsema)</span><br></pre></td></tr></table></figure>
<p>  è¿™ä¸ªå‡½æ•°ä¼šä½¿ä¼ å…¥çš„ä¿¡å·é‡dsemaçš„å€¼åŠ 1ï¼› </p>
<blockquote>
<p>dispatch_semaphore_waitçš„å£°æ˜ä¸ºï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ã€€ã€€<span class="keyword">long</span> dispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout)ï¼›</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°ä¼šä½¿ä¼ å…¥çš„ä¿¡å·é‡dsemaçš„å€¼å‡1ï¼›è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è¿™æ ·çš„ï¼Œå¦‚æœdsemaä¿¡å·é‡çš„å€¼å¤§äº0ï¼Œè¯¥å‡½æ•°æ‰€å¤„çº¿ç¨‹å°±ç»§ç»­æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œå¹¶ä¸”å°†ä¿¡å·é‡çš„å€¼å‡1ï¼›</p>
<p>å¦‚æœdesemaçš„å€¼ä¸º0ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±é˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…timeoutï¼ˆæ³¨æ„timeoutçš„ç±»å‹ä¸ºdispatch_time_tï¼Œä¸èƒ½ç›´æ¥ä¼ å…¥æ•´å½¢æˆ–floatå‹æ•°ï¼‰ï¼Œå¦‚æœç­‰å¾…çš„æœŸé—´desemaçš„å€¼è¢«dispatch_semaphore_signalå‡½æ•°åŠ 1äº†ï¼Œä¸”è¯¥å‡½æ•°ï¼ˆå³dispatch_semaphore_waitï¼‰æ‰€å¤„çº¿ç¨‹è·å¾—äº†ä¿¡å·é‡ï¼Œé‚£ä¹ˆå°±ç»§ç»­å‘ä¸‹æ‰§è¡Œå¹¶å°†ä¿¡å·é‡å‡1ã€‚</p>
<p>å¦‚æœç­‰å¾…æœŸé—´æ²¡æœ‰è·å–åˆ°ä¿¡å·é‡æˆ–è€…ä¿¡å·é‡çš„å€¼ä¸€ç›´ä¸º0ï¼Œé‚£ä¹ˆç­‰åˆ°timeoutæ—¶ï¼Œå…¶æ‰€å¤„çº¿ç¨‹è‡ªåŠ¨æ‰§è¡Œå…¶åè¯­å¥ã€‚</p>
<p>ã€€ã€€</p>
<blockquote>
<p>è¿”å›å€¼</p>
</blockquote>
<p>dispatch_semaphore_signalçš„è¿”å›å€¼ä¸ºlongç±»å‹ï¼Œå½“è¿”å›å€¼ä¸º0æ—¶è¡¨ç¤ºå½“å‰å¹¶æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å…¶å¤„ç†çš„ä¿¡å·é‡ï¼Œå…¶å¤„ç†çš„ä¿¡å·é‡çš„å€¼åŠ 1å³å¯ã€‚å½“è¿”å›å€¼ä¸ä¸º0æ—¶ï¼Œè¡¨ç¤ºå…¶å½“å‰æœ‰ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰çº¿ç¨‹ç­‰å¾…å…¶å¤„ç†çš„ä¿¡å·é‡ï¼Œå¹¶ä¸”è¯¥å‡½æ•°å”¤é†’äº†ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ï¼ˆå½“çº¿ç¨‹æœ‰ä¼˜å…ˆçº§æ—¶ï¼Œå”¤é†’ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹ï¼›å¦åˆ™éšæœºå”¤é†’ï¼‰ã€‚</p>
<p>dispatch_semaphore_waitçš„è¿”å›å€¼ä¹Ÿä¸ºlongå‹ã€‚å½“å…¶è¿”å›0æ—¶è¡¨ç¤ºåœ¨timeoutä¹‹å‰ï¼Œè¯¥å‡½æ•°æ‰€å¤„çš„çº¿ç¨‹è¢«æˆåŠŸå”¤é†’ã€‚å½“å…¶è¿”å›ä¸ä¸º0æ—¶ï¼Œè¡¨ç¤ºtimeoutå‘ç”Ÿã€‚</p>
<blockquote>
<p>è®¾ç½®timeoutæ—¶ï¼Œ</p>
</blockquote>
<p>æ¯”è¾ƒæœ‰ç”¨çš„ä¸¤ä¸ªå®ï¼š</p>
<ul>
<li>DISPATCH_TIME_NOWã€€ã€€è¡¨ç¤ºå½“å‰ï¼›</li>
<li>DISPATCH_TIME_FOREVERã€€ã€€è¡¨ç¤ºé¥è¿œçš„æœªæ¥ï¼›</li>
</ul>
<p>ä¸€èˆ¬å¯ä»¥ç›´æ¥è®¾ç½®timeoutä¸ºè¿™ä¸¤ä¸ªå®å…¶ä¸­çš„ä¸€ä¸ªï¼Œæˆ–è€…è‡ªå·±åˆ›å»ºä¸€ä¸ªdispatch_time_tç±»å‹çš„å˜é‡ã€‚</p>
<blockquote>
<p>dispatch_timeçš„å£°æ˜å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ã€€ã€€dispatch_time_t dispatch_time(dispatch_time_t when, int64_t delta)ï¼›</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºdispatch_time_tç±»å‹çš„å˜é‡æœ‰ä¸¤ç§æ–¹æ³•ï¼Œdispatch_timeå’Œdispatch_walltimeã€‚å…¶å‚æ•°whenéœ€ä¼ å…¥ä¸€ä¸ªdispatch_time_tç±»å‹çš„å˜é‡ï¼Œå’Œä¸€ä¸ªdeltaå€¼ã€‚è¡¨ç¤ºwhenåŠ deltaæ—¶é—´å°±æ˜¯timeoutçš„æ—¶é—´ã€‚</p>
<p>ä¾‹å¦‚ï¼šdispatch_time_t  t = dispatch_time(DISPATCH_TIME_NOW, 1<em>1000</em>1000*1000);è¡¨ç¤ºå½“å‰æ—¶é—´å‘åå»¶æ—¶ä¸€ç§’ä¸ºtimeoutçš„æ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">var semaphore = dispatch_semaphore_create(<span class="number">1</span>)  </span><br><span class="line">let queue = dispatch_queue_create(<span class="string">"com.gcd.kt"</span>, DISPATCH_QUEUE_CONCURRENT)  </span><br><span class="line">var array: [Int] = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">1.</span>.<span class="number">.100000</span> &#123;  </span><br><span class="line">	<span class="built_in">dispatch_async</span>(queue, &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           æŸä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå¦‚æœä¿¡å·é‡å€¼ä¸º1ï¼Œé‚£ä¹ˆwaitæ–¹æ³•è¿”å›1ï¼Œå¼€å§‹æ‰§è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">           ä¸æ­¤åŒæ—¶ï¼Œå› ä¸ºä¿¡å·é‡å˜ä¸º0ï¼Œå…¶å®ƒæ‰§è¡Œåˆ°è¿™é‡Œçš„çº¿ç¨‹éƒ½å¿…é¡»ç­‰å¾…</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER)</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           æ‰§è¡Œäº†waitæ–¹æ³•åï¼Œä¿¡å·é‡çš„å€¼å˜æˆäº†0ã€‚å¯ä»¥è¿›è¡Œæ¥ä¸‹æ¥çš„æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">           è¿™æ—¶å€™å…¶å®ƒçº¿ç¨‹éƒ½å¾—ç­‰å¾…waitæ–¹æ³•è¿”å›ã€‚</span></span><br><span class="line"><span class="comment">           å¯ä»¥å¯¹arrayä¿®æ”¹çš„çº¿ç¨‹åœ¨ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥å®‰å…¨çš„ä¿®æ”¹array</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       array.append(i)</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">           æ’ä»–æ“ä½œæ‰§è¡Œç»“æŸï¼Œè®°å¾—è¦è°ƒç”¨signalæ–¹æ³•ï¼ŒæŠŠä¿¡å·é‡çš„å€¼åŠ 1ã€‚</span></span><br><span class="line"><span class="comment">           è¿™æ ·ï¼Œå¦‚æœæœ‰åˆ«çš„çº¿ç¨‹åœ¨ç­‰å¾…waitå‡½æ•°è¿”å›ï¼Œå°±ç”±æœ€å…ˆç­‰å¾…çš„çº¿ç¨‹æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">       dispatch_semaphore_signal(semaphore)</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è®¡æ—¶å™¨"><a href="#è®¡æ—¶å™¨" class="headerlink" title="è®¡æ—¶å™¨"></a>è®¡æ—¶å™¨</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//è®¾ç½®æ—¶é—´é—´éš” 1ç§’</span></span><br><span class="line">uint64_t interval = <span class="built_in">NSEC_PER_SEC</span>;</span><br><span class="line"><span class="comment">//å¼€å¯ä¸€ä¸ªä¸“é—¨æ‰§è¡Œtimerçš„GCDå›è°ƒé˜Ÿåˆ—</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"myqueue"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//åˆ›å»ºtimer</span></span><br><span class="line">dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line"><span class="comment">//é…ç½®timer æœ€åä¸€ä¸ªå‚æ•°è¡¨ç¤ºç²¾å‡†åº¦ï¼Œ 0ä¸ºæœ€ç²¾å‡†</span></span><br><span class="line">dispatch_source_set_timer(_timer, dispatch_time(DISPATCH_TIME_NOW, <span class="number">0</span>), interval, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//è®¾ç½®å›è°ƒ</span></span><br><span class="line">__block <span class="keyword">int</span> timeCount = <span class="number">0</span>;</span><br><span class="line">dispatch_source_set_event_handler(_timer, ^&#123;</span><br><span class="line">    DLog(<span class="string">@"è®¡æ—¶å¼€å§‹"</span>);</span><br><span class="line">    timeCount ++;</span><br><span class="line">    <span class="keyword">if</span>(timeCount &gt;= <span class="number">6</span>)&#123;</span><br><span class="line">        DLog(<span class="string">@" da "</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(timeCount &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">    	<span class="comment">//ç»“æŸè®¡æ—¶</span></span><br><span class="line">        dispatch_source_cancel(_timer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//dispatch_sourceé»˜è®¤ä¸ºsuspendçŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨resume</span></span><br><span class="line">dispatch_resume(_timer);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>NSOperation-ç®€ä»‹.md</title>
    <url>/essay/NSOperation-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<blockquote>
<p>NSOperation-ç®€ä»‹</p>
</blockquote>
<a id="more"></a>
<h2 id="å¸¸ç”¨å­ç±»ï¼š"><a href="#å¸¸ç”¨å­ç±»ï¼š" class="headerlink" title="å¸¸ç”¨å­ç±»ï¼š"></a>å¸¸ç”¨å­ç±»ï¼š</h2><blockquote>
<p>NSOperationæ˜¯ä¸€ä¸ªåŸºç±»ï¼Œä¸åº”è¯¥ç›´æ¥ç”ŸæˆNSOperationå¯¹è±¡ï¼Œè€Œæ˜¯åº”è¯¥ç”¨å®ƒçš„å­ç±»ã€‚</p>
</blockquote>
<ul>
<li>NSInvocationOperation<ul>
<li>å°†ç‰¹å®šå¯¹è±¡çš„ç‰¹å®šæ–¹æ³•å°è£…æˆNSOperation</li>
</ul>
</li>
<li>NSBlockOperation<ul>
<li>å°†ä»£ç å—å°è£…æˆNSOpreation</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<p>åˆ›å»ºNSInvocationOperation</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">NSString</span>* url = <span class="string">@"http://www.xxx.com"</span>;</span><br><span class="line"><span class="comment">//ä»¥selfçš„downloadImageFromURL:æ–¹æ³•ä½œä¸ºæ‰§è¡Œä½“ï¼Œåˆ›å»ºNSOperation</span></span><br><span class="line"><span class="built_in">NSInvocationOperation</span>* operation = [[<span class="built_in">NSInvocationOperation</span> alloc]initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(downloadImageFromURL:) object:url];</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºNSBlockOperation</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">NSBlockOperation</span>* operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">	<span class="comment">//æ‰§è¡Œä½“</span></span><br><span class="line">	...</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h2 id="å¸¸ç”¨çŠ¶æ€ï¼š"><a href="#å¸¸ç”¨çŠ¶æ€ï¼š" class="headerlink" title="å¸¸ç”¨çŠ¶æ€ï¼š"></a>å¸¸ç”¨çŠ¶æ€ï¼š</h2><blockquote>
<p>å¯ä»¥é€šè¿‡KVOç›‘å¬NSOperationçš„çŠ¶æ€</p>
</blockquote>
<ul>
<li>isCancelled </li>
<li>isAsynchronous </li>
<li>isExecuting  </li>
<li>isFinished  </li>
<li>isReady  </li>
</ul>
<h2 id="æ‰§è¡Œä»»åŠ¡"><a href="#æ‰§è¡Œä»»åŠ¡" class="headerlink" title="æ‰§è¡Œä»»åŠ¡"></a>æ‰§è¡Œä»»åŠ¡</h2><blockquote>
<p>åˆ›å»ºäº†ä¸€ä¸ªNSBlockOperationï¼Œå¹¶ä¸”è®¾ç½®å¥½å®ƒçš„blockï¼Œä¹Ÿå°±æ˜¯å°†è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚è¿™ä¸ªä»»åŠ¡ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œã€‚</p>
</blockquote>
<blockquote>
<p>è°ƒç”¨startæ–¹æ³•è®©NSOperationæ–¹æ³•è¿è¡Œèµ·æ¥ã€‚startæ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨å½“å‰ä»»åŠ¡çŠ¶æ€å’Œä¾èµ–å…³ç³»åˆé€‚çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨NSOperationçš„mainæ–¹æ³•ä»»åŠ¡ï¼Œéœ€è¦æ³¨æ„ç¼ºçœå®ç°åªæ˜¯åœ¨å½“å‰çº¿ç¨‹è¿è¡Œã€‚å¦‚æœéœ€è¦å¹¶å‘æ‰§è¡Œï¼Œå­ç±»å¿…é¡»é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”ä½¿ - (BOOL)isConcurrent æ–¹æ³•è¿”å›YES</p>
</blockquote>
<pre><code><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line">let operation = <span class="built_in">NSBlockOperation</span> &#123; () -&gt; Void <span class="keyword">in</span>  </span><br><span class="line">   	print(<span class="built_in">NSThread</span>.currentThread())</span><br><span class="line">&#125;</span><br><span class="line">operation.addExecutionBlock &#123; () -&gt; Void <span class="keyword">in</span>  </span><br><span class="line">   	print(<span class="string">"execution block1 --(NSThread.currentThread())"</span>)</span><br><span class="line">&#125;</span><br><span class="line">operation.start()</span><br></pre></td></tr></table></figure>
</code></pre><p> é»˜è®¤çš„NSOperationæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚ç®€å•çš„çœ‹ä¸€ä¸‹NSOperationç±»çš„å®šä¹‰ä¼šå‘ç°å®ƒæœ‰ä¸€ä¸ªåªè¯»å±æ€§asynchronous</p>
<p> è¿™æ„å‘³ç€å¦‚æœæƒ³è¦å¼‚æ­¥æ‰§è¡Œï¼Œå°±éœ€è¦è‡ªå®šä¹‰NSOperationçš„å­ç±»ã€‚æˆ–è€…ä½¿ç”¨NSOperationQueue</p>
<h2 id="å–æ¶ˆä»»åŠ¡"><a href="#å–æ¶ˆä»»åŠ¡" class="headerlink" title="å–æ¶ˆä»»åŠ¡"></a>å–æ¶ˆä»»åŠ¡</h2><blockquote>
<p>å¦‚æœæˆ‘ä»¬æœ‰ä¸¤æ¬¡ç½‘ç»œè¯·æ±‚ï¼Œç¬¬äºŒæ¬¡è¯·æ±‚ä¼šç”¨åˆ°ç¬¬ä¸€æ¬¡çš„æ•°æ®ã€‚å¦‚æœæ­¤æ—¶ç½‘ç»œæƒ…å†µä¸å¥½ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚è¶…æ—¶äº†ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è¯·æ±‚ä¹Ÿæ²¡æœ‰å¿…è¦å‘é€äº†ã€‚å½“ç„¶ï¼Œç”¨æˆ·ä¹Ÿæœ‰å¯èƒ½äººä¸ºåœ°å–æ¶ˆæŸä¸ªNSOperationã€‚</p>
</blockquote>
<blockquote>
<p>å½“æŸä¸ªNSOperationè¢«å–æ¶ˆæ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½çš„æ¸…é™¤NSOperationå†…éƒ¨çš„æ•°æ®å¹¶ä¸”æŠŠcancelledå’Œfinishedè®¾ä¸ºtrueï¼ŒæŠŠexecutingè®¾ä¸ºfalseã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å–æ¶ˆæŸä¸ªNSOperation</span></span><br><span class="line">operation1.cancel()</span><br><span class="line"> </span><br><span class="line"><span class="comment">//å–æ¶ˆæŸä¸ªNSOperationQueueå‰©ä½™çš„NSOperation</span></span><br><span class="line">queue.cencelAllOperations()</span><br></pre></td></tr></table></figure>
<h2 id="è·å–çŠ¶æ€"><a href="#è·å–çŠ¶æ€" class="headerlink" title="è·å–çŠ¶æ€"></a>è·å–çŠ¶æ€</h2><ul>
<li>@property(readonly, getter=isCancelled) BOOL cancelled<ul>
<li>å½“å‰ä»»åŠ¡çŠ¶æ€æ˜¯å¦å·²æ ‡è®°ä¸ºå–æ¶ˆ  </li>
</ul>
</li>
<li>@property(readonly, getter=isExecuting) BOOL executing<ul>
<li>å½“å‰ä»»åŠ¡çŠ¶æ€æ˜¯å¦å·²æ ‡è®°ä¸ºå–æ¶ˆ </li>
</ul>
</li>
<li>@property(readonly, getter=isFinished) BOOL finished<ul>
<li>NSOperationä»»åŠ¡æ˜¯å¦å·²ç»“æŸ </li>
</ul>
</li>
<li>@property(readonly, getter=isConcurrent) BOOL concurrent</li>
<li>@property(readonly, getter=isAsynchronous) BOOL asynchronous</li>
<li>@property(readonly, getter=isReady) BOOL ready<ul>
<li>NSOperationä»»åŠ¡æ˜¯å¦å·²ç»“æŸ </li>
</ul>
</li>
<li>@property(copy) NSString *name</li>
</ul>
<h2 id="ç­‰å¾…"><a href="#ç­‰å¾…" class="headerlink" title="ç­‰å¾…"></a>ç­‰å¾…</h2><ul>
<li><p>-(void)waitUntilFinished</p>
  <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="built_in">NSBlockOperation</span> *opB = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">	[opA waitUntilFinished]; <span class="comment">//opBçº¿ç¨‹ç­‰å¾…ç›´åˆ°opAæ‰§è¡Œç»“æŸï¼ˆæ­£å¸¸ç»“æŸæˆ–è¢«å–æ¶ˆï¼‰</span></span><br><span class="line">      	[<span class="keyword">self</span> operate];</span><br><span class="line">  	&#125;];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="è®¾ç½®ä¾èµ–"><a href="#è®¾ç½®ä¾èµ–" class="headerlink" title="è®¾ç½®ä¾èµ–"></a>è®¾ç½®ä¾èµ–</h2><blockquote>
<p>ä¾ç„¶è€ƒè™‘åˆšåˆšæ‰€è¯´çš„ä¸¤æ¬¡ç½‘ç»œè¯·æ±‚çš„ä¾‹å­ã€‚å› ä¸ºç¬¬äºŒæ¬¡è¯·æ±‚ä¼šç”¨åˆ°ç¬¬ä¸€æ¬¡çš„æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯å‘å‡ºç¬¬äºŒæ¬¡è¯·æ±‚çš„æ—¶å€™ç¬¬ä¸€ä¸ªè¯·æ±‚å·²ç»æ‰§è¡Œå®Œã€‚ä½†æ˜¯æˆ‘ä»¬åŒæ—¶è¿˜å¸Œæœ›åˆ©ç”¨åˆ°NSOperationQueueçš„å¹¶å‘ç‰¹æ€§ï¼ˆå› ä¸ºå¯èƒ½ä¸æ­¢è¿™ä¸¤ä¸ªä»»åŠ¡ï¼‰ã€‚</p>
</blockquote>
<blockquote>
<p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥è®¾ç½®NSOperationä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¯­æ³•éå¸¸ç®€æ´ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">operation2.addDependency(operation1)</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯NSOperationä¹‹é—´çš„ç›¸äº’ä¾èµ–ä¼šå¯¼è‡´æ­»é”</p>
<p>ç§»é™¤ä¾èµ–ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeDependency:(<span class="built_in">NSOperation</span> *)operation</span><br></pre></td></tr></table></figure>
<h2 id="ä¼˜å…ˆçº§"><a href="#ä¼˜å…ˆçº§" class="headerlink" title="ä¼˜å…ˆçº§"></a>ä¼˜å…ˆçº§</h2><blockquote>
<p>GCDä¸­ï¼Œä»»åŠ¡ï¼ˆblockï¼‰æ˜¯æ²¡æœ‰ä¼˜å…ˆçº§çš„ï¼Œè€Œé˜Ÿåˆ—å…·æœ‰ä¼˜å…ˆçº§ã€‚å’ŒGCDç›¸åï¼Œæˆ‘ä»¬ä¸€èˆ¬è€ƒè™‘NSOperationçš„ä¼˜å…ˆçº§</p>
</blockquote>
<blockquote>
<p>NSOperationæœ‰ä¸€ä¸ªNSOperationQueuePriorityæšä¸¾ç±»å‹çš„å±æ€§queuePriority</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> : <span class="built_in">NSInteger</span> &#123;</span><br><span class="line">	<span class="built_in">NSOperationQueuePriorityVeryLow</span> = <span class="number">-8</span>,</span><br><span class="line">	<span class="built_in">NSOperationQueuePriorityLow</span> = <span class="number">-4</span>,</span><br><span class="line">	<span class="built_in">NSOperationQueuePriorityNormal</span> = <span class="number">0</span>,</span><br><span class="line">	<span class="built_in">NSOperationQueuePriorityHigh</span> = <span class="number">4</span>,</span><br><span class="line">	<span class="built_in">NSOperationQueuePriorityVeryHigh</span> = <span class="number">8</span></span><br><span class="line">&#125; <span class="built_in">NSOperationQueuePriority</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¦‚æœNSInvocationOperationå’ŒNSBlockOperationå¯¹è±¡ä¸èƒ½æ»¡è¶³éœ€æ±‚, æˆ‘ä»¬å¯ä»¥ç›´æ¥ç»§æ‰¿NSOperation, å¹¶æ·»åŠ é¢å¤–çš„åŠŸèƒ½ã€‚</p>
<p>ç»§æ‰¿æ‰€éœ€çš„å·¥ä½œé‡ä¸»è¦å–å†³äºä½ è¦å®ç°éå¹¶å‘è¿˜æ˜¯å¹¶å‘çš„NSOperationã€‚å®šä¹‰åŒæ­¥çš„NSOperationè¦ç®€å•è®¸å¤š,åªéœ€è¦é‡è½½-mainè¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢æ‰§è¡Œä¸»ä»»åŠ¡,å¹¶æ­£ç¡®åœ°å“åº”å–æ¶ˆäº‹ä»¶; å¯¹äºå¼‚æ­¥NSOperation, å¿…é¡»é‡å†™NSOperationçš„å¤šä¸ªåŸºæœ¬æ–¹æ³•è¿›è¡Œå®ç°ï¼ˆmainã€startï¼‰ã€‚</p>
</blockquote>
<!--more-->
<h2 id="è‡ªå®šä¹‰éå¹¶å‘NSOperation"><a href="#è‡ªå®šä¹‰éå¹¶å‘NSOperation" class="headerlink" title="è‡ªå®šä¹‰éå¹¶å‘NSOperation"></a>è‡ªå®šä¹‰éå¹¶å‘NSOperation</h2><ol>
<li>é‡å†™NSOperationçš„<code>main</code>æ–¹æ³•,è¯¥æ–¹æ³•ä¼šä½œä¸ºNSOperationæ‰€å¯åŠ¨çº¿ç¨‹çš„æ‰§è¡Œä½“<ul>
<li>åœ¨ operation çš„ main æ–¹æ³•é‡Œé¢,å¿…é¡»æä¾› autorelease pool,å› ä¸ºä½ çš„ operation å®Œæˆåéœ€è¦é”€æ¯ã€‚</li>
</ul>
</li>
<li>å®ç°KVOæœºåˆ¶ï¼Œä¸€æ—¦ä½ çš„ operation å¼€å§‹äº†,å¿…é¡»é€šè¿‡ KVO,å‘Šè¯‰æ‰€æœ‰çš„ç›‘å¬è€…,ç°åœ¨è¯¥operationçš„æ‰§è¡ŒçŠ¶æ€ã€‚ï¼ˆå³ä¿®æ”¹isFinishedï¼ŒisExecutingçš„å€¼ï¼‰</li>
<li>é‡è½½ isExecutingæ–¹æ³•å’ŒisFinishedæ–¹æ³•ã€‚åœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­,å¿…é¡»è¿”å›ä¸€ä¸ªçº¿ç¨‹å®‰å…¨å€¼ï¼ˆé€šå¸¸æ˜¯ä¸ªBOOLå€¼ï¼‰,è¿™ä¸ªå€¼å¯ä»¥åœ¨ operation ä¸­è¿›è¡Œæ“ä½œã€‚</li>
</ol>
<h3 id="ç¤ºä¾‹ä»£ç ï¼š"><a href="#ç¤ºä¾‹ä»£ç ï¼š" class="headerlink" title="ç¤ºä¾‹ä»£ç ï¼š"></a>ç¤ºä¾‹ä»£ç ï¼š</h3><blockquote>
<p>.hæ–‡ä»¶ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^HYBDownloadReponse)(<span class="built_in">UIImage</span> *image);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DownloadOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *url;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) HYBDownloadReponse responseBlock;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithUrl:(<span class="built_in">NSString</span> *)url completion:(HYBDownloadReponse)completion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>.mæ–‡ä»¶ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"DownloadOperation.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DownloadOperation</span> () </span>&#123;</span><br><span class="line">   <span class="built_in">BOOL</span> _isFinished;</span><br><span class="line">   <span class="built_in">BOOL</span> _isExecuting;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DownloadOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithUrl:(<span class="built_in">NSString</span> *)url completion:(HYBDownloadReponse)completion &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">       <span class="keyword">self</span>.url = url;</span><br><span class="line">       <span class="keyword">self</span>.responseBlock = completion;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¿…é¡»é‡å†™è¿™ä¸ªä¸»æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="comment">// æ–°å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¦‚æœæ˜¯å¼‚æ­¥æ‰§è¡Œæ“ä½œï¼Œé‚£ä¹ˆå°†æ— æ³•è®¿é—®åˆ°ä¸»çº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">   <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">       <span class="comment">// æä¾›ä¸€ä¸ªå˜é‡æ ‡è¯†ï¼Œæ¥è¡¨ç¤ºæˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„æ“ä½œæ˜¯å¦å®Œæˆäº†ï¼Œå½“ç„¶ï¼Œæ²¡å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œä¸ºNO</span></span><br><span class="line">       <span class="built_in">BOOL</span> taskIsFinished = <span class="literal">NO</span>;</span><br><span class="line">       <span class="built_in">UIImage</span> *image = <span class="literal">nil</span>;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// while ä¿è¯ï¼šåªæœ‰å½“æ²¡æœ‰æ‰§è¡Œå®Œæˆå’Œæ²¡æœ‰è¢«å–æ¶ˆï¼Œæ‰æ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç›¸åº”æ“ä½œ</span></span><br><span class="line">       <span class="keyword">while</span> (taskIsFinished == <span class="literal">NO</span> &amp;&amp; [<span class="keyword">self</span> isCancelled] == <span class="literal">NO</span>)&#123;</span><br><span class="line">           <span class="comment">// è·å–å›¾ç‰‡æ•°æ®</span></span><br><span class="line">           <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="keyword">self</span>.url];</span><br><span class="line">           <span class="built_in">NSData</span> *imageData = [<span class="built_in">NSData</span> dataWithContentsOfURL:url];</span><br><span class="line">           image = [<span class="built_in">UIImage</span> imageWithData:imageData];</span><br><span class="line">           <span class="built_in">NSLog</span>(<span class="string">@"Current Thread = %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">// è¿™é‡Œï¼Œè®¾ç½®æˆ‘ä»¬ç›¸åº”çš„æ“ä½œéƒ½å·²ç»å®Œæˆï¼Œåé¢å°±æ˜¯è¦é€šçŸ¥KVOæˆ‘ä»¬çš„æ“ä½œå®Œæˆäº†ã€‚</span></span><br><span class="line">           </span><br><span class="line">           taskIsFinished = <span class="literal">YES</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// KVO ç”Ÿæˆé€šçŸ¥ï¼Œå‘Šè¯‰å…¶ä»–çº¿ç¨‹ï¼Œè¯¥operation æ‰§è¡Œå®Œäº†</span></span><br><span class="line">       [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">       [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">       _isFinished = <span class="literal">YES</span>;</span><br><span class="line">       _isExecuting = <span class="literal">NO</span>;</span><br><span class="line">       [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">       [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">self</span>.responseBlock) &#123;</span><br><span class="line">           <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               <span class="keyword">self</span>.responseBlock(image);</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)start &#123;</span><br><span class="line">   <span class="comment">// å¦‚æœæˆ‘ä»¬å–æ¶ˆäº†åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å°±ç«‹å³è¿”å›å¹¶ç”Ÿæˆæ‰€éœ€çš„KVOé€šçŸ¥</span></span><br><span class="line">   <span class="keyword">if</span> ([<span class="keyword">self</span> isCancelled])&#123;</span><br><span class="line">       <span class="comment">// æˆ‘ä»¬å–æ¶ˆäº†è¯¥ operationï¼Œé‚£ä¹ˆå°±è¦å‘Šè¯‰KVOï¼Œè¯¥operationå·²ç»æ‰§è¡Œå®Œæˆï¼ˆisFinishedï¼‰</span></span><br><span class="line">       <span class="comment">// è¿™æ ·ï¼Œè°ƒç”¨çš„é˜Ÿåˆ—ï¼ˆæˆ–è€…çº¿ç¨‹ï¼‰ä¼šç»§ç»­æ‰§è¡Œã€‚</span></span><br><span class="line">       [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">       _isFinished = <span class="literal">NO</span>;</span><br><span class="line">       [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isFinished"</span>];</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// æ²¡æœ‰å–æ¶ˆï¼Œé‚£å°±è¦å‘Šè¯‰KVOï¼Œè¯¥é˜Ÿåˆ—å¼€å§‹æ‰§è¡Œäº†ï¼ˆisExecutingï¼‰ï¼é‚£ä¹ˆï¼Œå°±ä¼šè°ƒç”¨mainæ–¹æ³•ï¼Œè¿›è¡ŒåŒæ­¥æ‰§è¡Œã€‚</span></span><br><span class="line">       [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">       _isExecuting = <span class="literal">YES</span>;</span><br><span class="line">       [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(main) toTarget:<span class="keyword">self</span> withObject:<span class="literal">nil</span>];</span><br><span class="line">       [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"isExecuting"</span>];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isExecuting &#123;</span><br><span class="line">   <span class="keyword">return</span> _isExecuting;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isFinished &#123;</span><br><span class="line">   <span class="keyword">return</span> _isFinished;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h3><blockquote>
<p>queueæ–¹å¼ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">DownloadOperation *operation = [[DownloadOperation alloc] initWithUrl:<span class="string">@"https://mmbiz.qlogo.cn/mmbiz/sia5QxFVcFD0wkCgnmf6DVxI6fVewNS8rhtZb71v2DMpDy8jIdtviaetzicwQzTEoKKyHAN96Beibk2G61tZpezQ0Q/0?wx_fmt=png"</span> completion:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">   <span class="comment">//    self.imageView.image = image;</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">DownloadOperation *operation1 = [[DownloadOperation alloc] initWithUrl:<span class="string">@"https://mmbiz.qlogo.cn/mmbiz/sia5QxFVcFD0wkCgnmf6DVxI6fVewNS8rhtZb71v2DMpDy8jIdtviaetzicwQzTEoKKyHAN96Beibk2G61tZpezQ0Q/0?wx_fmt=png"</span> completion:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">   <span class="comment">//    self.imageView1.image = image;</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc]init];</span><br><span class="line">[queue addOperation:operation];</span><br><span class="line">[queue addOperation:operation1];</span><br><span class="line">[queue setMaxConcurrentOperationCount:<span class="number">2</span>];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ‰‹åŠ¨æ–¹å¼ï¼š</p>
</blockquote>
<pre><code>DownloadOperation *operation = [[DownloadOperation alloc] initWithUrl:@&quot;https://mmbiz.qlogo.cn/mmbiz/sia5QxFVcFD0wkCgnmf6DVxI6fVewNS8rhtZb71v2DMpDy8jIdtviaetzicwQzTEoKKyHAN96Beibk2G61tZpezQ0Q/0?wx_fmt=png&quot; completion:^(UIImage *image) {
//    self.imageView.image = image;
}];
[operation start];        
</code></pre><h2 id="è‡ªå®šä¹‰å¹¶å‘NSOperation"><a href="#è‡ªå®šä¹‰å¹¶å‘NSOperation" class="headerlink" title="è‡ªå®šä¹‰å¹¶å‘NSOperation"></a>è‡ªå®šä¹‰å¹¶å‘NSOperation</h2><ol>
<li>å’ŒåŒæ­¥ä¸€æ ·éœ€è¦ é‡å†™mian start</li>
<li>å’ŒåŒæ­¥ä¸€æ ·éœ€è¦ ä½¿ç”¨KVOé€šçŸ¥çŠ¶æ€æ”¹å˜</li>
<li>å’ŒåŒæ­¥ä¸€æ ·éœ€è¦ é‡å†™isExecuting isFinishing</li>
<li>æ¯”åŒæ­¥å¤šçš„æ˜¯ é‡å†™isAsynchronousï¼ˆæˆ–è€…isConcurrentï¼‰</li>
</ol>
<h3 id="ç¤ºä¾‹ä»£ç ï¼š-1"><a href="#ç¤ºä¾‹ä»£ç ï¼š-1" class="headerlink" title="ç¤ºä¾‹ä»£ç ï¼š"></a>ç¤ºä¾‹ä»£ç ï¼š</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"DownloadOperation.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DownloadOperation</span> () </span>&#123;</span><br><span class="line"><span class="keyword">@private</span> <span class="built_in">BOOL</span> _isFinished;</span><br><span class="line"><span class="keyword">@private</span> <span class="built_in">BOOL</span> _isExecuting;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DownloadOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithUrl:(<span class="built_in">NSString</span> *)url completion:(HYBDownloadReponse)completion &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">       <span class="keyword">self</span>.url = url;</span><br><span class="line">       <span class="keyword">self</span>.responseBlock = completion;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¿…é¡»é‡å†™è¿™ä¸ªä¸»æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)main &#123;</span><br><span class="line">   <span class="comment">// æ–°å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¦‚æœæ˜¯å¼‚æ­¥æ‰§è¡Œæ“ä½œï¼Œé‚£ä¹ˆå°†æ— æ³•è®¿é—®åˆ°ä¸»çº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ± </span></span><br><span class="line">   <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">       <span class="built_in">UIImage</span> *image = <span class="literal">nil</span>;</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">           <span class="comment">// è·å–å›¾ç‰‡æ•°æ®</span></span><br><span class="line">           <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="keyword">self</span>.url];</span><br><span class="line">           <span class="built_in">NSData</span> *imageData = [<span class="built_in">NSData</span> dataWithContentsOfURL:url];</span><br><span class="line">           image = [<span class="built_in">UIImage</span> imageWithData:imageData];</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"currentThread: %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// è¢«å–æ¶ˆï¼Œä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨è½¬æ¢çš„åœ°æ–¹</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">           image = <span class="literal">nil</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> (![<span class="keyword">self</span> isCancelled] &amp;&amp; <span class="keyword">self</span>.responseBlock) &#123;</span><br><span class="line">           <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               <span class="keyword">self</span>.responseBlock(image);</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸è‡ªå®šä¹‰åŒæ­¥NSOperationä¸åŒçš„æ˜¯ï¼Œå¿…é¡»è¦å®ç°ä¸‹é¢çš„æ–¹æ³•</span></span><br><span class="line"><span class="meta">#if __IPHONE_OS_VERSION_MAX_ALLOWED <span class="meta-string">&lt; __IPHONE_7_0</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">- (BOOL)isConcurrent &#123;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">   return YES;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">#else</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">- (BOOL)isAsynchronous &#123;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">   return YES;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">&#125;</span></span></span><br><span class="line"><span class="meta"><span class="meta-string">#endif</span></span></span><br><span class="line"><span class="meta"><span class="meta-string"></span></span></span><br><span class="line"><span class="meta"><span class="meta-string">@end</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¯¹äºéä¸»é˜Ÿåˆ—æ¥è¯´ï¼Œä¸€æ—¦ä¸€ä¸ªNSOperationè¢«æ”¾å…¥å…¶ä¸­ï¼Œé‚£è¿™ä¸ªNSOperationä¸€å®šæ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚ NSOperationQueueä¼šä¸ºæ¯ä¸€ä¸ªNSOperationåˆ›å»ºçº¿ç¨‹å¹¶è°ƒç”¨å®ƒçš„startæ–¹æ³•ã€‚ </p>
</blockquote>
<!--more-->
<h2 id="KVOé”®å€¼è§‚å¯Ÿ"><a href="#KVOé”®å€¼è§‚å¯Ÿ" class="headerlink" title="KVOé”®å€¼è§‚å¯Ÿ"></a>KVOé”®å€¼è§‚å¯Ÿ</h2><ul>
<li>operations - read-only</li>
<li>operationCount - read-only</li>
<li>maxConcurrentOperationCount - readable and writable</li>
<li>suspended - readable and writable</li>
<li>name - readable and writable</li>
</ul>
<h2 id="è·å–ç‰¹æ®ŠNSOperationQueue"><a href="#è·å–ç‰¹æ®ŠNSOperationQueue" class="headerlink" title="è·å–ç‰¹æ®ŠNSOperationQueue"></a>è·å–ç‰¹æ®ŠNSOperationQueue</h2><ul>
<li>+(NSOperationQueue *)currentQueue<ul>
<li>è¿”å›å½“å‰NSOperationQueueï¼Œå¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åœ¨NSOperationQueueä¸Šè¿è¡Œåˆ™è¿”å›nil </li>
</ul>
</li>
<li>+(NSOperationQueue *)mainQueue<ul>
<li>è¿”å›ä¸»çº¿ç¨‹çš„NSOperationQueue</li>
</ul>
</li>
</ul>
<h2 id="ç®¡ç†é˜Ÿåˆ—ä¸­çš„Operation"><a href="#ç®¡ç†é˜Ÿåˆ—ä¸­çš„Operation" class="headerlink" title="ç®¡ç†é˜Ÿåˆ—ä¸­çš„Operation"></a>ç®¡ç†é˜Ÿåˆ—ä¸­çš„Operation</h2><ul>
<li>-(void)addOperation:(NSOperation *)operation    <ul>
<li>åŠ å…¥åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå¦‚æœisReadyåˆ™å¼€å§‹æ‰§è¡Œ </li>
</ul>
</li>
<li>-(void)addOperations:(NSArray<nsoperation *> *)ops waitUntilFinished:(BOOL)wait<ul>
<li>æ‰¹é‡åŠ å…¥æ‰§è¡Œoperationï¼Œwaitæ ‡å¿—æ˜¯å¦å½“å‰çº¿ç¨‹ç­‰åˆ°æ‰€æœ‰operationç»“æŸ </li>
</ul>
</nsoperation></li>
<li>-(void)addOperationWithBlock:(void (^)(void))block<ul>
<li>ç›¸å½“äºåŠ å…¥ä¸€ä¸ªNSBlockOperationæ‰§è¡Œä»»åŠ¡ </li>
</ul>
</li>
<li>-(void)cancelAllOperations<ul>
<li>ç›¸å½“äºåŠ å…¥ä¸€ä¸ªNSBlockOperationæ‰§è¡Œä»»åŠ¡ </li>
</ul>
</li>
<li>-(void)waitUntilAllOperationsAreFinished<ul>
<li>å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰operationéƒ½æ‰§è¡Œç»“æŸ </li>
</ul>
</li>
<li>@property(readonly, copy) NSArray &lt;__kindof NSOperation <em>&gt; </em>operations<ul>
<li>è¿”å›å·²åŠ å…¥æ‰§è¡Œoperationçš„æ•°ç»„ï¼Œå½“æŸä¸ªoperationç»“æŸåä¼šè‡ªåŠ¨ä»è¿™ä¸ªæ•°ç»„æ¸…é™¤ </li>
</ul>
</li>
<li>@property(readonly) NSUInteger operationCount<ul>
<li>è¿”å›å·²åŠ å…¥æ‰§è¡Œoperationçš„æ•°ç›® </li>
</ul>
</li>
<li>@property NSInteger maxConcurrentOperationCount<ul>
<li>è®¾ç½®æœ€å¤§å¹¶å‘æ‰§è¡Œæ•°ï¼Œå¦‚æœä¸º1åˆ™åŒæ—¶åªæœ‰ä¸€ä¸ªå¹¶å‘ä»»åŠ¡åœ¨è¿è¡Œï¼Œå¯æ§åˆ¶é¡ºåºæ‰§è¡Œå…³ç³»</li>
</ul>
</li>
<li><p>@property(getter=isSuspended) BOOL suspended</p>
  <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">queue.suspended = <span class="literal">true</span> <span class="comment">//æš‚åœqueueä¸­æ‰€æœ‰operation  </span></span><br><span class="line">queue.suspended = <span class="literal">false</span> <span class="comment">//æ¢å¤queueä¸­æ‰€æœ‰operation</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ç®€å•ä½¿ç”¨ï¼š"><a href="#ç®€å•ä½¿ç”¨ï¼š" class="headerlink" title="ç®€å•ä½¿ç”¨ï¼š"></a>ç®€å•ä½¿ç”¨ï¼š</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">let operationQueue = <span class="built_in">NSOperationQueue</span>()  </span><br><span class="line">let operation = <span class="built_in">NSBlockOperation</span> &#123; () -&gt; Void <span class="keyword">in</span>  </span><br><span class="line">   	print(<span class="built_in">NSThread</span>.currentThread())</span><br><span class="line">&#125;</span><br><span class="line">   operation.addExecutionBlock &#123; () -&gt; Void <span class="keyword">in</span></span><br><span class="line">   	print(<span class="string">"execution block1 -- (NSThread.currentThread())"</span>)</span><br><span class="line">&#125;</span><br><span class="line">operationQueue.addOperation(operation)  </span><br><span class="line">print(<span class="string">"æ“ä½œç»“æŸ"</span>)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>NSRunloopç®€ä»‹.md</title>
    <url>/essay/NSRunloop%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<blockquote>
<p>NSRunLoopæ˜¯IOSæ¶ˆæ¯æœºåˆ¶çš„å¤„ç†æ¨¡å¼</p>
</blockquote>
<ul>
<li>NSRunLoopçš„ä¸»è¦ä½œç”¨ï¼šæ§åˆ¶NSRunLoopé‡Œé¢çº¿ç¨‹çš„æ‰§è¡Œå’Œä¼‘çœ ï¼Œåœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä½¿å½“å‰NSRunLoopæ§åˆ¶çš„çº¿ç¨‹å·¥ä½œï¼Œæ²¡æœ‰äº‹æƒ…åšè®©å½“å‰NSRunLoopçš„æ§åˆ¶çš„çº¿ç¨‹ä¼‘çœ ã€‚</li>
<li>NSRunLoop å°±æ˜¯ä¸€ç›´åœ¨å¾ªç¯æ£€æµ‹ï¼Œä»çº¿ç¨‹startåˆ°çº¿ç¨‹endï¼Œæ£€æµ‹inputsource(å¦‚ç‚¹å‡»ï¼ŒåŒå‡»ç­‰æ“ä½œ)åŒæ­¥äº‹ä»¶ï¼Œæ£€æµ‹timesourceåŒæ­¥äº‹ä»¶ï¼Œæ£€æµ‹åˆ°è¾“å…¥æºä¼šæ‰§è¡Œå¤„ç†å‡½æ•°ï¼Œé¦–å…ˆä¼šäº§ç”Ÿé€šçŸ¥ï¼Œcorefunctionå‘çº¿ç¨‹æ·»åŠ runloop observersæ¥ç›‘å¬äº‹ä»¶ï¼Œæ„åœ¨ç›‘å¬äº‹ä»¶å‘ç”Ÿæ—¶æ¥åšå¤„ç†ã€‚</li>
</ul>
<a id="more"></a>
<h2 id="ä»‹ç»ï¼š"><a href="#ä»‹ç»ï¼š" class="headerlink" title="ä»‹ç»ï¼š"></a>ä»‹ç»ï¼š</h2><ol>
<li>NSRunloopç±»ç”¨æ¥å¤„ç†ç±»ä¼¼é”®ç›˜é¼ æ ‡ä¹‹ç±»çš„è¾“å…¥æºï¼ŒNSPortå¯¹è±¡æˆ–è€…NSConnectionå¯¹è±¡ã€‚åŒæ—¶ä¹Ÿå¯ä»¥å¤„ç†NSTimerå¯¹è±¡ã€‚</li>
<li>ä¸èƒ½åˆ›å»ºå’Œæ˜¾ç¤ºç®¡ç†NSRunloopå¯¹è±¡ã€‚ä¸»çº¿ç¨‹å†…çš„NSThreadéƒ½å·²ç»è‡ªåŠ¨åˆ›å»ºäº†NSRunloopå¯¹è±¡ã€‚</li>
<li>é€šè¿‡ <code>[NSRunloop currentRunLoop]</code> è·å¾—å½“å‰çº¿ç¨‹çš„NSRunloopå¯¹è±¡ã€‚</li>
<li>NSTimerå¯¹è±¡ä½¿ç”¨ fire æ–¹æ³•æ—¶ä¸ä¼šåˆ›å»ºNSRunloopå¯¹è±¡ã€‚</li>
<li><p>NSTimerå½“ä½¿ç”¨scheduled åˆå§‹åŒ–æ—¶ä¼šæŠŠtimerä»¥é»˜è®¤æ¨¡å¼æ·»åŠ åˆ°å½“å‰NSRunloopä¸­ï¼Œè€Œå½“ä½¿ç”¨timeræ–¹æ³•åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨å°†timeræ·»åŠ åˆ°NSRunloopä¸­ã€‚</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop]addTimer:myTimer forMode:<span class="built_in">NSDefaultRunLoopMode</span>];</span><br><span class="line"></span><br><span class="line">å¦‚æœä¸å¯åŠ¨run loopï¼Œtimerçš„äº‹ä»¶æ˜¯ä¸ä¼šå“åº”çš„</span><br></pre></td></tr></table></figure>
</li>
<li><p>NSRunloopä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
</li>
</ol>
<h2 id="runloopå’Œçº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»"><a href="#runloopå’Œçº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»" class="headerlink" title="runloopå’Œçº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»"></a>runloopå’Œçº¿ç¨‹æœ‰ä»€ä¹ˆå…³ç³»</h2><p>Run loopsæ˜¯çº¿ç¨‹çš„åŸºç¡€æ¶æ„éƒ¨åˆ†ï¼Œ Cocoa å’Œ CoreFundation éƒ½æä¾›äº† run loop å¯¹è±¡æ–¹ä¾¿é…ç½®å’Œç®¡ç†çº¿ç¨‹çš„ run loop ï¼ˆä»¥ä¸‹éƒ½ä»¥ Cocoa ä¸ºä¾‹ï¼‰ã€‚æ¯ä¸ªçº¿ç¨‹ï¼ŒåŒ…æ‹¬ç¨‹åºçš„ä¸»çº¿ç¨‹ï¼ˆ main thread ï¼‰éƒ½æœ‰ä¸ä¹‹ç›¸åº”çš„ run loop å¯¹è±¡ã€‚</p>
<p>###runloop å’Œçº¿ç¨‹çš„å…³ç³»ï¼š</p>
<p>ä¸»çº¿ç¨‹çš„run loopé»˜è®¤æ˜¯å¯åŠ¨çš„ã€‚</p>
<p>iOSçš„åº”ç”¨ç¨‹åºé‡Œé¢ï¼Œç¨‹åºå¯åŠ¨åä¼šæœ‰ä¸€ä¸ªå¦‚ä¸‹çš„main()å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, 			<span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡ç‚¹æ˜¯UIApplicationMain()å‡½æ•°ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¸ºmain threadè®¾ç½®ä¸€ä¸ªNSRunLoopå¯¹è±¡ï¼Œè¿™å°±è§£é‡Šäº†ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬çš„åº”ç”¨å¯ä»¥åœ¨æ— äººæ“ä½œçš„æ—¶å€™ä¼‘æ¯ï¼Œéœ€è¦è®©å®ƒå¹²æ´»çš„æ—¶å€™åˆèƒ½ç«‹é©¬å“åº”ã€‚</p>
<p> å¯¹å…¶å®ƒçº¿ç¨‹æ¥è¯´ï¼Œrun loopé»˜è®¤æ˜¯æ²¡æœ‰å¯åŠ¨çš„ï¼Œå¦‚æœä½ éœ€è¦æ›´å¤šçš„çº¿ç¨‹äº¤äº’åˆ™å¯ä»¥æ‰‹åŠ¨é…ç½®å’Œå¯åŠ¨ï¼Œå¦‚æœçº¿ç¨‹åªæ˜¯å»æ‰§è¡Œä¸€ä¸ªé•¿æ—¶é—´çš„å·²ç¡®å®šçš„ä»»åŠ¡åˆ™ä¸éœ€è¦ã€‚</p>
<p> åœ¨ä»»ä½•ä¸€ä¸ª Cocoa ç¨‹åºçš„çº¿ç¨‹ä¸­ï¼Œéƒ½å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥è·å–åˆ°å½“å‰çº¿ç¨‹çš„ run loop ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSRunLoop</span> *runloop = [<span class="built_in">NSRunLoop</span> currentRunLoop];</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒé“¾æ¥ï¼š<a href="http://blog.csdn.net/wzzvictory/article/details/9237973" target="_blank" rel="noopener">ã€ŠObjective-Cä¹‹run loopè¯¦è§£ã€‹</a>ã€‚</p>
<h2 id="runloopçš„modeä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#runloopçš„modeä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="runloopçš„modeä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>runloopçš„modeä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>model ä¸»è¦æ˜¯ç”¨æ¥æŒ‡å®šäº‹ä»¶åœ¨è¿è¡Œå¾ªç¯ä¸­çš„ä¼˜å…ˆçº§çš„ï¼Œåˆ†ä¸ºï¼š</p>
<ul>
<li>NSDefaultRunLoopModeï¼ˆkCFRunLoopDefaultModeï¼‰ï¼šé»˜è®¤ï¼Œç©ºé—²çŠ¶æ€</li>
<li>UITrackingRunLoopModeï¼šScrollViewæ»‘åŠ¨æ—¶</li>
<li>UIInitializationRunLoopModeï¼šå¯åŠ¨æ—¶</li>
<li>NSRunLoopCommonModesï¼ˆkCFRunLoopCommonModesï¼‰ï¼šModeé›†åˆ</li>
</ul>
<p>è‹¹æœå…¬å¼€æä¾›çš„ Mode æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>NSDefaultRunLoopModeï¼ˆkCFRunLoopDefaultModeï¼‰</li>
<li>NSRunLoopCommonModesï¼ˆkCFRunLoopCommonModesï¼‰ </li>
</ul>
<h2 id="ä»¥-scheduledTimerWithTimeIntervalâ€¦çš„æ–¹å¼è§¦å‘çš„timerï¼Œåœ¨æ»‘åŠ¨é¡µé¢ä¸Šçš„åˆ—è¡¨æ—¶ï¼Œtimerä¼šæš‚å®šå›è°ƒï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ"><a href="#ä»¥-scheduledTimerWithTimeIntervalâ€¦çš„æ–¹å¼è§¦å‘çš„timerï¼Œåœ¨æ»‘åŠ¨é¡µé¢ä¸Šçš„åˆ—è¡¨æ—¶ï¼Œtimerä¼šæš‚å®šå›è°ƒï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ" class="headerlink" title="ä»¥+ scheduledTimerWithTimeIntervalâ€¦çš„æ–¹å¼è§¦å‘çš„timerï¼Œåœ¨æ»‘åŠ¨é¡µé¢ä¸Šçš„åˆ—è¡¨æ—¶ï¼Œtimerä¼šæš‚å®šå›è°ƒï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ"></a>ä»¥+ scheduledTimerWithTimeIntervalâ€¦çš„æ–¹å¼è§¦å‘çš„timerï¼Œåœ¨æ»‘åŠ¨é¡µé¢ä¸Šçš„åˆ—è¡¨æ—¶ï¼Œtimerä¼šæš‚å®šå›è°ƒï¼Œä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</h2><p>RunLoopåªèƒ½è¿è¡Œåœ¨ä¸€ç§modeä¸‹ï¼Œå¦‚æœè¦æ¢modeï¼Œå½“å‰çš„loopä¹Ÿéœ€è¦åœä¸‹é‡å¯æˆæ–°çš„ã€‚åˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼ŒScrollViewæ»šåŠ¨è¿‡ç¨‹ä¸­NSDefaultRunLoopModeï¼ˆkCFRunLoopDefaultModeï¼‰çš„modeä¼šåˆ‡æ¢åˆ°UITrackingRunLoopModeæ¥ä¿è¯ScrollViewçš„æµç•…æ»‘åŠ¨ï¼šåªèƒ½åœ¨NSDefaultRunLoopModeæ¨¡å¼ä¸‹å¤„ç†çš„äº‹ä»¶ä¼šå½±å“ScrollViewçš„æ»‘åŠ¨ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æŠŠä¸€ä¸ªNSTimerå¯¹è±¡ä»¥NSDefaultRunLoopModeï¼ˆkCFRunLoopDefaultModeï¼‰æ·»åŠ åˆ°ä¸»è¿è¡Œå¾ªç¯ä¸­çš„æ—¶å€™, ScrollViewæ»šåŠ¨è¿‡ç¨‹ä¸­ä¼šå› ä¸ºmodeçš„åˆ‡æ¢ï¼Œè€Œå¯¼è‡´NSTimerå°†ä¸å†è¢«è°ƒåº¦ã€‚</p>
<p>åŒæ—¶å› ä¸ºmodeè¿˜æ˜¯å¯å®šåˆ¶çš„ï¼Œæ‰€ä»¥ï¼š</p>
<p>Timerè®¡æ—¶ä¼šè¢«scrollViewçš„æ»‘åŠ¨å½±å“çš„é—®é¢˜å¯ä»¥é€šè¿‡å°†timeræ·»åŠ åˆ°NSRunLoopCommonModesï¼ˆkCFRunLoopCommonModesï¼‰æ¥è§£å†³ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°†timeræ·»åŠ åˆ°NSDefaultRunLoopModeä¸­</span></span><br><span class="line">[<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">    target:<span class="keyword">self</span></span><br><span class="line">    selector:<span class="keyword">@selector</span>(timerTick:)</span><br><span class="line">    userInfo:<span class="literal">nil</span></span><br><span class="line">    repeats:<span class="literal">YES</span>];</span><br><span class="line"><span class="comment">//ç„¶åå†æ·»åŠ åˆ°NSRunLoopCommonModesé‡Œ</span></span><br><span class="line"><span class="built_in">NSTimer</span> *timer = [<span class="built_in">NSTimer</span> timerWithTimeInterval:<span class="number">1.0</span></span><br><span class="line">    target:<span class="keyword">self</span></span><br><span class="line">    selector:<span class="keyword">@selector</span>(timerTick:)</span><br><span class="line">    userInfo:<span class="literal">nil</span></span><br><span class="line">    repeats:<span class="literal">YES</span>];</span><br><span class="line">[[<span class="built_in">NSRunLoop</span> currentRunLoop] addTimer:timer forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒé“¾æ¥ <a href="http://blog.ibireme.com/2015/05/18/runloop/#base" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a></p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>RNä¸­å¸ƒå±€æ ·å¼çš„å†™æ³•</title>
    <url>/essay/RN%E4%B8%AD%E5%B8%83%E5%B1%80%E6%A0%B7%E5%BC%8F%E7%9A%84%E5%86%99%E6%B3%95/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»åŸå§‹å†™æ³• &amp; åŠå…¶æ”¹è¿›å†™æ³•ä¸€</p>
<p>è¿˜æœ‰æ¯”è¾ƒæµè¡Œçš„ styled-componentsåœ¨RNä¸­çš„ä½¿ç”¨ &amp; åŠå…¶æ”¹è¿›å†™æ³•äºŒ</p>
</blockquote>
<h3 id="1-åŸå†™æ³•"><a href="#1-åŸå†™æ³•" class="headerlink" title="1.åŸå†™æ³•"></a>1.åŸå†™æ³•</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸå†™æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> styles1 = StyleSheet.create(&#123;</span><br><span class="line">    item1:&#123;</span><br><span class="line">        width:<span class="number">100</span>,</span><br><span class="line">        height:<span class="number">200</span>,</span><br><span class="line">        backgroundColor:<span class="string">'#66CCFF'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    item2:&#123;</span><br><span class="line">        width:<span class="number">100</span>,</span><br><span class="line">        height:<span class="number">200</span>,</span><br><span class="line">        backgroundColor:<span class="string">'#66CCFF'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    item3:&#123;</span><br><span class="line">        width:<span class="number">50</span>,</span><br><span class="line">        height:<span class="number">100</span>,</span><br><span class="line">        top:<span class="number">50</span>,</span><br><span class="line">        left:<span class="number">25</span>,</span><br><span class="line">        backgroundColor:<span class="string">'#66CCFF'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'styles1 :'</span>,styles1);</span><br></pre></td></tr></table></figure>
<p>åŸå†™æ³•çš„ç¼ºç‚¹åœ¨äºå˜é‡ä¸å¥½å¼•å…¥ï¼Œä¸å¥½ä½“ç°æ ·å¼é—´çš„å…³ç³»ï¼Œæ²¡æœ‰è®¡ç®—è¡¨è¾¾å¼ç­‰â€¦â€¦</p>
<a id="more"></a>
<h3 id="2-æ”¹è¿›å†™æ³•ä¸€"><a href="#2-æ”¹è¿›å†™æ³•ä¸€" class="headerlink" title="2.æ”¹è¿›å†™æ³•ä¸€"></a>2.æ”¹è¿›å†™æ³•ä¸€</h3><p>çœ‹StyleSheet.createçš„ä»£ç ï¼Œå°±æ˜¯ç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨react native 0.44ç‰ˆæœ¬ä¸­</span></span><br><span class="line"><span class="keyword">var</span> StyleSheet = &#123;</span><br><span class="line">  create: <span class="function"><span class="keyword">function</span>(<span class="params">styles</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> styles;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>é‚£å°±å¯ä»¥ä¸é™äºStyleSheet.createçš„å†™æ³•ï¼Œå¯ä»¥æ¯”è¾ƒè‡ªç”±çš„è¿”å›ä¸€ä¸ªå¯¹è±¡äº†ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªæˆ‘çš„ç®€å•ä¾‹å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¢ä¸€ç§å†™æ³•ï¼Œç®€å•å¼•å…¥äº†å˜é‡è¡¨è¾¾å¼</span></span><br><span class="line"><span class="comment"> * è™½ç„¶è¿˜æ˜¯æ²¡æœ‰åƒiOSä¸­ view.center / autolayoutä¹‹ç±»çš„å†™æ³•æ–¹ä¾¿</span></span><br><span class="line"><span class="comment"> * @returns &#123;&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">styles2Creator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> s = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> itemWidth = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">let</span> itemHeight = <span class="number">200</span>;</span><br><span class="line">    <span class="comment">//å¼•ç”¨å¸¸é‡</span></span><br><span class="line">    s.item1 = &#123;</span><br><span class="line">        width:itemWidth,</span><br><span class="line">        height:itemHeight,</span><br><span class="line">        backgroundColor:<span class="string">'#66CCFF'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//å¼•ç”¨å…¶ä»–æ ·å¼çš„å€¼</span></span><br><span class="line">    s.item2 = &#123;</span><br><span class="line">        width:s.item1.width,</span><br><span class="line">        height:itemHeight,</span><br><span class="line">        backgroundColor:<span class="string">`<span class="subst">$&#123;s.item1.backgroundColor&#125;</span>`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">//è®¡ç®—è¡¨è¾¾å¼ </span></span><br><span class="line">    s.item3 = &#123;</span><br><span class="line">        width: s.item2.width / <span class="number">2</span>,</span><br><span class="line">        height: s.item2.height / <span class="number">2</span>,</span><br><span class="line">        top:s.item2.height / <span class="number">4</span>,</span><br><span class="line">        left:s.item2.width / <span class="number">4</span>,</span><br><span class="line">        backgroundColor:s.item1.backgroundColor,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//æ ·å¼çš„ç»§æ‰¿</span></span><br><span class="line">    s.item4 = &#123;</span><br><span class="line">    	...s.item3,</span><br><span class="line">    	backgroundColor:<span class="string">'#FF00CC'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//å¸¦å‚æ•°</span></span><br><span class="line">    s.item5 = <span class="function">(<span class="params">top</span>) =&gt;</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> &#123;</span><br><span class="line">    		...s.item3,</span><br><span class="line">    		marginTop:top,</span><br><span class="line">    	&#125;;    	</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//å¸¦å‚æ•° + ç¼ºçœå€¼</span></span><br><span class="line">    s.item6 = <span class="function">(<span class="params">top</span>) =&gt;</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> &#123;</span><br><span class="line">    		...s.item3,</span><br><span class="line">    		marginTop:top ? top : <span class="number">10</span>,</span><br><span class="line">    	&#125;;       	</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> style2 = styles2Creator();</span><br><span class="line"><span class="comment">//const style2 = StyleSheet.create(styles2Creator());</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'style2 :'</span>,style2);</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¸€ä¸‹å¯ä»¥çœ‹åˆ° logå‡ºæ¥çš„style2å’Œstyle1çš„å±æ€§ã€‚</p>
<h3 id="3-styled-components"><a href="#3-styled-components" class="headerlink" title="3. styled-components"></a>3. styled-components</h3><blockquote>
<p>å·ç§°React ä¸­çš„ CSS æœ€ä½³å®è·µ,ä½¿ç”¨è¡Œå†…æ ·å¼ï¼Œæ”¯æŒCSSã€‚è¯¥ç¬¬ä¸‰æ–¹ä¹Ÿä¹Ÿå¯ç”¨äºRNã€‚</p>
</blockquote>
<p><code>react-native init</code>äº†ä¸ªRNå·¥ç¨‹ å†™äº†ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    AppRegistry,</span><br><span class="line">    StyleSheet,</span><br><span class="line">    Text,</span><br><span class="line">    View,</span><br><span class="line">    Image</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"><span class="comment">//éœ€è¦ `npm install --save styled-components`</span></span><br><span class="line"><span class="keyword">import</span> styled <span class="keyword">from</span> <span class="string">"styled-components/native"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œå¼€å§‹styled-components å¼çš„æ ·å¼ï¼š</span></span><br><span class="line"><span class="comment">//styled-componentsçš„æ ¼å¼ä¸ºï¼š const [è‡ªå®šä¹‰å˜é‡å] = styled.[ç›¸åº”çš„ç³»ç»Ÿç»„ä»¶]`cssè¡¨è¾¾å¼`;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ™®é€šå†™æ³• ï¼ˆä¸å¤§å†™å¼€å¤´ä¼šæŠ¥é”™â€¦â€¦</span></span><br><span class="line"><span class="keyword">const</span> ListContainerView = styled.View<span class="string">`</span></span><br><span class="line"><span class="string">    width:360;</span></span><br><span class="line"><span class="string">    height:280;</span></span><br><span class="line"><span class="string">    background-color: #F0F2F5;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰©å±• ï¼ˆbackgroundColor å’Œ background-coloréƒ½å¯ä»¥</span></span><br><span class="line"><span class="keyword">const</span> ItemContainerView = ListContainerView.extend<span class="string">`</span></span><br><span class="line"><span class="string">    backgroundColor: #66CCFF;</span></span><br><span class="line"><span class="string">    flexDirection:row;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¸¦å‚æ•°</span></span><br><span class="line"><span class="keyword">const</span> LeftImageContainerView = styled.View<span class="string">`</span></span><br><span class="line"><span class="string">    height:<span class="subst">$&#123;props =&gt; props.primary ? <span class="number">280</span> : <span class="number">180</span>&#125;</span>;;</span></span><br><span class="line"><span class="string">    width:180;</span></span><br><span class="line"><span class="string">    background-color: #77BB00;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç„¶åå‘ç°ä¸€ä¸ªå°´å°¬çš„äº‹å°±æ˜¯ä¸çŸ¥é“æ€ä¹ˆæ‰©å±•è‡ªå®šä¹‰ç»„ä»¶ æ¯”å¦‚JDImage</span></span><br><span class="line"><span class="comment">//å¸¦è®¡ç®—è¡¨è¾¾å¼</span></span><br><span class="line"><span class="keyword">const</span> LeftImageHeight = <span class="number">280</span> - <span class="number">10</span> *<span class="number">2</span>;</span><br><span class="line"><span class="keyword">const</span> LeftImage = styled.Image<span class="string">`</span></span><br><span class="line"><span class="string">    margin-top:10;</span></span><br><span class="line"><span class="string">    margin-left:10;</span></span><br><span class="line"><span class="string">    width:<span class="subst">$&#123;<span class="number">180</span> - <span class="number">10</span> *<span class="number">2</span>&#125;</span>;</span></span><br><span class="line"><span class="string">    height:<span class="subst">$&#123;LeftImageHeight&#125;</span>;</span></span><br><span class="line"><span class="string">    background-color: #FFFFFF;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æƒ³è¦è·å–å¦ä¸€ä¸ªç»„ä»¶æ ·å¼LeftImageçš„é«˜åº¦ ä¸èƒ½ç›´æ¥ä½¿ç”¨ $&#123;LeftImage.height&#125;</span></span><br><span class="line"><span class="comment">//å› ä¸º LeftImageè¿”å›çš„æ˜¯  Æ’ StyledNativeComponent()æ–¹æ³•â€¦â€¦</span></span><br><span class="line"><span class="keyword">const</span> RightContainerView = styled.View<span class="string">`</span></span><br><span class="line"><span class="string">    width:160;</span></span><br><span class="line"><span class="string">    height:<span class="subst">$&#123;LeftImageHeight&#125;</span>;</span></span><br><span class="line"><span class="string">    background-color: #FF00CC;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;ItemContainerView &gt;</span><br><span class="line">                &lt;LeftImageContainerView primary&gt;</span><br><span class="line">                    &#123;<span class="built_in">console</span>.log(<span class="string">'LeftImageContainerView.style:'</span>,LeftImageContainerView)&#125;</span><br><span class="line">                    &lt;LeftImage source=&#123;&#123;<span class="attr">uri</span>:<span class="string">'http://static.runoob.com/images/demo/demo2.jpg'</span>&#125;&#125;/&gt;</span><br><span class="line">                &lt;<span class="regexp">/LeftImageContainerView&gt;</span></span><br><span class="line"><span class="regexp">                &lt;RightContainerView&gt;&lt;/</span>RightContainerView&gt;</span><br><span class="line">            &lt;<span class="regexp">/ItemContainerView&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">AppRegistry.registerComponent('MyApp', () =&gt; MyApp);</span></span><br></pre></td></tr></table></figure>
<p><strong><em>ä¼˜ç‚¹ï¼š</em></strong></p>
<ul>
<li>reactæ¨èçš„è¡Œå†…æ ·å¼ css in jsï¼›</li>
<li>æ–¹ä¾¿å‰ç«¯åŒå­¦çš„å†™æ³• å¯ä»¥å®Œå…¨ä½¿ç”¨CSSçš„ä¹¦å†™ä¹ æƒ¯</li>
</ul>
<p>ç¼ºç‚¹å’ŒåŸå§‹å†™æ³•çš„å·®ä¸å¤šï¼Œè¿˜å¯¹æœ¬èº«ä¸æ˜¯å‰ç«¯å¼€å‘çš„äººæ¥è¯´å¸¦æ¥é¢å¤–çš„å­¦ä¹ æˆæœ¬â€¦â€¦ æ‰€ä»¥è¿˜æ˜¯ä¸æ¨èâ€¦â€¦</p>
<p><strong><em>å‚è€ƒé“¾æ¥ï¼š</em></strong></p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/29344146" target="_blank" rel="noopener">styled-components React ä¸­çš„ CSS æœ€ä½³å®è·µ | zhihu</a></li>
<li><a href="https://www.styled-components.com/" target="_blank" rel="noopener">styled-components | å®˜æ–¹æ–‡æ¡£</a></li>
<li><a href="http://www.alloyteam.com/2017/05/guide-styled-components/" target="_blank" rel="noopener">Styled Componentsï¼šè®©æ ·å¼ä¹Ÿæˆä¸ºç»„ä»¶ | alloyteam.</a></li>
</ul>
<h3 id="4-æ”¹è¿›å†™æ³•äºŒ"><a href="#4-æ”¹è¿›å†™æ³•äºŒ" class="headerlink" title="4.æ”¹è¿›å†™æ³•äºŒ"></a>4.æ”¹è¿›å†™æ³•äºŒ</h3><blockquote>
<p>ç®€å•æ¥è®² styled-components å°±æ˜¯ç”Ÿæˆä¸€ä¸ªå¸¦æ ·å¼çš„ç»„ä»¶ï¼Œå®Œå…¨å¯ä»¥å¸æ”¶è¿™ç§å†™æ³• è‡ªå·±æ”¹è¿›RNä¸­ ï¼Œè€Œä¸ä½¿ç”¨styled-componentsè¿™ä¸ªåº“</p>
</blockquote>
<p>ç»“åˆ å†™æ³•ä¸€ å’Œ styled-componentsçš„æƒ³æ³•ï¼Œç»™å‡ºä¸€ä¸ªç®€å•ä¾‹å­ï¼š</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Component&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    AppRegistry,</span><br><span class="line">    StyleSheet,</span><br><span class="line">    Text,</span><br><span class="line">    View,</span><br><span class="line">    Image</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å†™æ³•äºŒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stylesCreator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> s = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> width = <span class="number">360.0</span>, height = <span class="number">280.0</span>;</span><br><span class="line">    s.ListContainerView = &#123;</span><br><span class="line">        width:  width,</span><br><span class="line">        height: height,</span><br><span class="line">        backgroundColor: <span class="string">'#F0F2F5'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    s.ItemContainerView = &#123;</span><br><span class="line">        width:  width,</span><br><span class="line">        height: height,</span><br><span class="line">        backgroundColor: <span class="string">'#66CCFF'</span>,</span><br><span class="line">        flexDirection:<span class="string">'row'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'s.ItemContainerView :'</span>,s.ItemContainerView);</span><br><span class="line">    s.LeftImageContainerView = &#123;</span><br><span class="line">        height:height,</span><br><span class="line">        width:width / <span class="number">2</span>,</span><br><span class="line">        backgroundColor: <span class="string">'#77BB00'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    s.LeftImage = &#123;</span><br><span class="line">        marginTop:<span class="number">10</span>,</span><br><span class="line">        marginLeft:<span class="number">10</span>,</span><br><span class="line">        width: <span class="number">180</span> - <span class="number">10</span> *<span class="number">2</span>,</span><br><span class="line">        height: s.LeftImageContainerView.height - <span class="number">10</span>*<span class="number">2</span>,</span><br><span class="line">        backgroundColor: <span class="string">`#FFFFFF`</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    s.RightContainerView = &#123;</span><br><span class="line">        width: width / <span class="number">2</span>,</span><br><span class="line">        height: s.LeftImage.height,</span><br><span class="line">        backgroundColor: <span class="string">'#FF00CC'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> styles = stylesCreator();</span><br><span class="line"><span class="comment">//const styles = StyleSheet.create(stylesCreator());</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç„¶åå†ç»“åˆ styled-componentsï¼š</span></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿ styled-components API</span></span><br><span class="line"><span class="keyword">const</span> styled = <span class="function">(<span class="params">Component, styler</span>) =&gt;</span> (props) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> style = <span class="keyword">typeof</span> styler === <span class="string">'function'</span> ? styler(props) : styler;</span><br><span class="line">    <span class="keyword">return</span> &lt;Component &#123;...props&#125; style=&#123;[ style, props.style ]&#125; /&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// styled components</span><br><span class="line">//åŒæ ·å¯ä»¥å®Œæˆç»„ä»¶ï¼ˆå¸¦æ ·å¼ï¼‰çš„ç»§æ‰¿ const RightContainerView = styled(LeftImageContainerView,styles.RightContainerView);</span><br><span class="line"></span><br><span class="line">const ListContainerView = styled(View,styles.ListContainerView);</span><br><span class="line">const ItemContainerView = styled(View,styles.ItemContainerView);</span><br><span class="line">const LeftImageContainerView = styled(View,styles.LeftImageContainerView);</span><br><span class="line">const LeftImage = styled(Image,styles.LeftImage);</span><br><span class="line">const RightContainerView = styled(View,styles.RightContainerView);</span><br><span class="line"></span><br><span class="line">export default class MyApp extends Component &#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        return (</span><br><span class="line">            &lt;ItemContainerView &gt;</span><br><span class="line">                &lt;LeftImageContainerView primary&gt;</span><br><span class="line">                    &#123;console.log('LeftImageContainerView.style:',LeftImageContainerView)&#125;</span><br><span class="line">                    &lt;LeftImage source=&#123;&#123;uri:'http://static.runoob.com/images/demo/demo2.jpg'&#125;&#125;/&gt;</span><br><span class="line">                &lt;/LeftImageContainerView&gt;</span><br><span class="line">                &lt;RightContainerView&gt;&lt;/RightContainerView&gt;</span><br><span class="line">            &lt;/ItemContainerView&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AppRegistry.registerComponent('MyApp', () =&gt; MyApp);</span><br></pre></td></tr></table></figure>
<p>emmm ï¼Œæ— éœ€å¼•å…¥ç¬¬ä¸‰æ–¹åº“ æ„Ÿè§‰å¥½å¤šäº†ã€‚ç¼ºç‚¹å½“ç„¶æ˜¯ä¸æ”¯æŒåŸCSSå†™æ³•ã€‚</p>
<h3 id="5-react-native-0-45"><a href="#5-react-native-0-45" class="headerlink" title="5. react native 0.45"></a>5. react native 0.45</h3><p>åœ¨0.45ç‰ˆæœ¬ä¸­è¿è¡Œæ”¹è¿›å†™æ³•ä¸€æ—¶ï¼Œä½ å¯èƒ½çœ‹åˆ°style2åœ¨æ§åˆ¶å°çš„è¾“å‡ºç±»ä¼¼ä¸ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//const style2 = StyleSheet.create(styles2Creator());</span></span><br><span class="line"></span><br><span class="line">  style2 : </span><br><span class="line">&#123;<span class="attr">item1</span>: <span class="number">12</span>, <span class="attr">item2</span>: <span class="number">13</span>, <span class="attr">item3</span>: <span class="number">14</span>, <span class="attr">item4</span>: <span class="number">15</span>, <span class="attr">item5</span>: <span class="number">16</span>, â€¦&#125;</span><br><span class="line">	item1:<span class="number">12</span></span><br><span class="line">	item2:<span class="number">13</span></span><br><span class="line">	item3:<span class="number">14</span></span><br><span class="line">	item4:<span class="number">15</span></span><br><span class="line">	item5:<span class="number">16</span></span><br><span class="line">	item6:<span class="number">17</span></span><br><span class="line">__proto__:<span class="built_in">Object</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯æ€ä¹ˆè‚¥äº‹ï¼æˆ‘çš„itemå¯¹è±¡æ€ä¹ˆå˜æˆæ•°å­—äº†ï¼</p>
<p>åˆ«æ€¥ï¼Œåœ¨0.45ç‰ˆæœ¬åStyleSheetä»£ç æœ‰æ‰€æ”¹å˜ï¼ˆå…¶å®æˆ‘æ²¡çœ‹å…·ä½“å“ªä¸ªå°ç‰ˆæœ¬æ”¹çš„ <code>_(:Ğ·ã‚âˆ )_</code>ï¼‰, StyleSheet.createæ”¹æˆï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//react native : 0.45.1</span></span><br><span class="line">  create&lt;S: Styles&gt;(obj: S): StyleSheet&lt;S&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result: StyleSheet&lt;S&gt; = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">      StyleSheetValidation.validateStyle(key, obj);</span><br><span class="line">      result[key] = ReactNativePropRegistry.register(obj[key]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//react native0.45.1 ReactNativePropRegistry.js</span></span><br><span class="line"><span class="keyword">var</span> objects = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> uniqueID = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> emptyObject = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactNativePropRegistry</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> register(object: <span class="built_in">Object</span>): number &#123;</span><br><span class="line">    <span class="keyword">var</span> id = ++uniqueID;</span><br><span class="line">    <span class="keyword">if</span> (__DEV__) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.freeze(object);</span><br><span class="line">    &#125;</span><br><span class="line">    objects[id] = object;</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//å¤šçš„å°±ä¸çœ‹äº†â€¦â€¦å†…å®¹ä¸å¤šå„ä½æœ‰å…´è¶£è‡ªå·±çœ‹</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡çœ‹ReactNativePropRegistryä»£ç ï¼ŒStyleSheetå°†æ ·å¼å¯¹è±¡å‚¨å­˜åœ¨<code>objects</code>ä¸­,å¹¶è¿”å›<code>uniqueID</code></p>
<p>æ¯”å¦‚å–å›åŸæ¥çš„itemï¼Œå°±å¯ä»¥è¿™æ ·åšï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ReactNativePropRegistry <span class="keyword">from</span> <span class="string">'../node_modules/react-native/Libraries/Renderer/src/renderers/native/ReactNativePropRegistry'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"ReactNativePropRegistry.getByID(12): "</span>,ReactNativePropRegistry.getByID(<span class="number">12</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"ReactNativePropRegistry.getByID(style2. item1): "</span>,ReactNativePropRegistry.getByID(style2. item1));</span><br></pre></td></tr></table></figure>
<p>å°±å¯ä»¥é€šè¿‡ <strong>ReactNativePropRegistry.getByID</strong>å°±å¯ä»¥å–å¾—æ ·å¼å¯¹è±¡äº†ã€‚è¿™å¯èƒ½å¯¹äºä¹‹å‰çš„æ”¹è¿›å†™æ³•é€ æˆäº†ä¸€ç‚¹å°éº»çƒ¦ï¼Œä¸è¿‡è¿˜å¯ä»¥ç”¨~</p>
<hr>
<blockquote>
<p>å…¶ä»–å‚è€ƒé˜…è¯»ï¼š</p>
</blockquote>
<ul>
<li><a href="https://github.com/sabeurthabti/react-native-css" target="_blank" rel="noopener">react-native-css | github</a> css + sass in rn</li>
<li><a href="https://github.com/blackmiaool/rn-less" target="_blank" rel="noopener">rn-less | github</a> css + less in rn</li>
<li><a href="https://zhuanlan.zhihu.com/p/28060579" target="_blank" rel="noopener">React-Native æ ·å¼ç®¡ç†æ–¹æ¡ˆæµ…è°ˆ | zhihu</a></li>
</ul>
]]></content>
      <categories>
        <category>essay</category>
        <category>React Native</category>
      </categories>
      <tags>
        <tag>React Native</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHubç²¾é€‰åˆ†äº«ç¬¬ä¸€æœŸ</title>
    <url>/weekly-share/GitHub%E7%B2%BE%E9%80%89%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%80%E6%9C%9F/</url>
    <content><![CDATA[<p>è®°å½•è¿™å‘¨å€¼å¾—åˆ†äº«çš„äº‹ï¼Œä¸»è¦æ˜¯GitHubç²¾é€‰ å‰ç«¯ç›¸å…³~</p>
<h3 id="å‘ä½ çš„Hexoé‡Œæ”¾ä¸Šä¸€åªèŒèŒå“’äºŒæ¬¡å…ƒçœ‹æ¿å¨˜"><a href="#å‘ä½ çš„Hexoé‡Œæ”¾ä¸Šä¸€åªèŒèŒå“’äºŒæ¬¡å…ƒçœ‹æ¿å¨˜" class="headerlink" title="å‘ä½ çš„Hexoé‡Œæ”¾ä¸Šä¸€åªèŒèŒå“’äºŒæ¬¡å…ƒçœ‹æ¿å¨˜!"></a><a href="https://github.com/EYHN/hexo-helper-live2d" target="_blank" rel="noopener">å‘ä½ çš„Hexoé‡Œæ”¾ä¸Šä¸€åªèŒèŒå“’äºŒæ¬¡å…ƒçœ‹æ¿å¨˜!</a></h3><p><a href="https://github.com/EYHN/hexo-helper-live2d" target="_blank" rel="noopener"><img src="https://huaji8.top/img/hexo%E7%9A%84live2d%E6%8F%92%E4%BB%B6/live2d%20z16.jpg" alt></a></p>
<blockquote class="blockquote-center"><p>å¯ä»¥åœ¨hexoåšå®¢å³ä¸‹è§’æ·»åŠ live2Dè§’è‰²<br><a href="https://huaji8.top/post/live2d-plugin-2.0/" target="_blank" rel="noopener">çœ‹æ¿å¨˜åˆ—è¡¨</a></p>
</blockquote>
<a id="more"></a>
<h3 id="How-JavaScript-works"><a href="#How-JavaScript-works" class="headerlink" title="How JavaScript works"></a><a href="https://blog.sessionstack.com/tagged/tutorial" target="_blank" rel="noopener">How JavaScript works</a></h3><p><a href="https://blog.sessionstack.com/tagged/tutorial" target="_blank" rel="noopener"><img src="https://cdn-images-1.medium.com/max/800/1*lMBu87MtEsVFqqbfMum-kA.png" alt></a></p>
<p>ç³»åˆ—åšå®¢åŒ…å«ï¼šè¯­è¨€å¼•æ“ï¼Œè¿è¡Œæ—¶å’Œè°ƒç”¨æ ˆæ¦‚è¿°ï¼›å¦‚ä½•åœ¨ V8 å¼•æ“ä¸­ä¹¦å†™æœ€ä¼˜ä»£ç çš„ 5 æ¡å°æŠ€å·§ï¼›å†…å­˜ç®¡ç†åŠå¦‚ä½•å¤„ç† 4 ç±»å¸¸è§çš„å†…å­˜æ³„æ¼ï¼›äº‹ä»¶å¾ªç¯åŠå¼‚æ­¥ç¼–ç¨‹çš„å‡ºç°å’Œ 5 ç§æ›´å¥½çš„ async/await ç¼–ç¨‹æ–¹å¼ï¼›æ·±å…¥ç†è§£ WebSockets å’Œå¸¦æœ‰ SSE æœºåˆ¶çš„HTTP/2 ä»¥åŠæ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿ï¼›WebAssembly å¯¹æ¯” JavaScript åŠå…¶ä½¿ç”¨åœºæ™¯ï¼›Web Workers åˆ†ç±»åŠ 5 ä¸ªä½¿ç”¨åœºæ™¯ï¼›Service Workersï¼Œç”Ÿå‘½å‘¨æœŸåŠå…¶ä½¿ç”¨åœºæ™¯ï¼›ç½‘é¡µæ¶ˆæ¯æ¨é€é€šçŸ¥æœºåˆ¶ï¼›ä½¿ç”¨ MutationObserver ç›‘æµ‹ DOM å˜åŒ–ï¼›æ¸²æŸ“å¼•æ“åŠæ€§èƒ½ä¼˜åŒ–å°æŠ€å·§ï¼›è§£æï¼Œè¯­æ³•æŠ½è±¡æ ‘åŠæœ€å°åŒ–è§£ææ—¶é—´çš„ 5 æ¡å°æŠ€å·§ â€¦â€¦</p>
<h3 id="æ„å»ºæ—¶é¢„æ¸²æŸ“ï¼šç½‘é¡µé¦–å¸§ä¼˜åŒ–å®è·µ"><a href="#æ„å»ºæ—¶é¢„æ¸²æŸ“ï¼šç½‘é¡µé¦–å¸§ä¼˜åŒ–å®è·µ" class="headerlink" title="æ„å»ºæ—¶é¢„æ¸²æŸ“ï¼šç½‘é¡µé¦–å¸§ä¼˜åŒ–å®è·µ"></a><a href="https://tech.meituan.com/first_contentful_paint_practice.html" target="_blank" rel="noopener">æ„å»ºæ—¶é¢„æ¸²æŸ“ï¼šç½‘é¡µé¦–å¸§ä¼˜åŒ–å®è·µ</a></h3><p><a href="https://tech.meituan.com/first_contentful_paint_practice.html" target="_blank" rel="noopener"><img src="https://tech.meituan.com/img/shanghanyang/03.png" alt></a></p>
<blockquote class="blockquote-center"><p>ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåœ¨â€œé¦–å±ç™½å±â€é—®é¢˜ä¸Šçš„ä¼˜åŒ–å®è·µ</p>
</blockquote>
<h3 id="style2paints-è‡ªåŠ¨ä¸Šè‰²"><a href="#style2paints-è‡ªåŠ¨ä¸Šè‰²" class="headerlink" title="style2paints è‡ªåŠ¨ä¸Šè‰²"></a><a href="https://github.com/lllyasviel/style2paints" target="_blank" rel="noopener">style2paints è‡ªåŠ¨ä¸Šè‰²</a></h3><p><a href="https://github.com/lllyasviel/style2paints" target="_blank" rel="noopener"><img src="https://raw.githubusercontent.com/lllyasviel/style2paints/master/temps/show/5.jpg" alt></a></p>
<p>AI æ¼«ç”»ç¨¿åœ¨çº¿ä¸Šè‰²å·¥å…·ï¼Œé€šè¿‡äººå·¥æ™ºèƒ½ï¼Œå°†çº¿ç¨¿çš„é£æ ¼è½¬æ¢ä¸ºå½©è‰²æ¼«ç”»é£æ ¼ã€‚è¯¥é¡¹ç›®åŒæ—¶æä¾›äº†åœ¨çº¿ä½“éªŒç½‘ç«™æ ¹æ®ä¸åŒçš„æ¶‚è‰²é£æ ¼ï¼Œè·å¾—å„ç§ä¸Šè‰²å›¾ç‰‡ã€‚ç‰¹åˆ«å€¼å¾—å…³æ³¨çš„æ˜¯è¯¥é¡¹ç›®ç”±è‹å·å¤§å­¦å‘å¸ƒï¼Œæ˜¯ä¸­å›½ç§‘ç ”æœºæ„åœ¨æœ¬åˆ—è¡¨ä¸­æ’åæœ€é«˜çš„é¡¹ç›®ã€‚</p>
<h3 id="æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç "><a href="#æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç " class="headerlink" title="æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç "></a><a href="https://github.com/tonybeltramelli/pix2code" target="_blank" rel="noopener">æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç </a></h3><p><a href="https://github.com/tonybeltramelli/pix2code" target="_blank" rel="noopener"><img src="http://mmbiz.qpic.cn/mmbiz_png/KmXPKA19gW9RgiagIibfo1J7QcMtpOpVmrnM15s2ynV7Vbd2QnRrhibUYWFibSicaJTSNYxVyxHoxQO9tfN7OXWOM2A/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt></a></p>
<p>å“¥æœ¬å“ˆæ ¹çš„ä¸€å®¶åˆåˆ›å…¬å¸ UIzard Technologies è®­ç»ƒäº†ä¸€ä¸ªç¥ç»ç½‘ç»œï¼Œèƒ½å¤ŸæŠŠå›¾å½¢ç”¨æˆ·ç•Œé¢çš„æˆªå›¾è½¬è¯‘æˆä»£ç è¡Œï¼ŒæˆåŠŸä¸ºå¼€å‘è€…ä»¬åˆ†æ‹…äº†éƒ¨åˆ†ç½‘ç«™è®¾è®¡æµç¨‹ã€‚ä»¤äººæƒŠå¹çš„æ˜¯ï¼ŒåŒä¸€ä¸ªæ¨¡å‹èƒ½è·¨å¹³å°å·¥ä½œï¼ŒåŒ…æ‹¬ iOSã€Android å’Œ Web ç•Œé¢ï¼Œä»ç›®å‰çš„ç ”å‘æ°´å¹³æ¥çœ‹ï¼Œè¯¥ç®—æ³•çš„å‡†ç¡®ç‡è¾¾åˆ°äº† 77%ã€‚ è¯¦ç»†å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« <a href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650728064&amp;idx=1&amp;sn=adb744e599299916faa23545c2ab436e&amp;chksm=871b22feb06cabe83ba0e3268a7a8c0c486cf6f42427ab41814e69242f919b25bc7de06ea258&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">æœºå™¨ä¹‹å¿ƒ-æ·±åº¦å­¦ä¹ åŠ©åŠ›å‰ç«¯å¼€å‘ï¼šè‡ªåŠ¨ç”ŸæˆGUIå›¾ä»£ç ï¼ˆé™„è¯•ç”¨åœ°å€ï¼‰</a></p>
<h3 id="æ·±åº¦å­¦ä¹ 500é—®"><a href="#æ·±åº¦å­¦ä¹ 500é—®" class="headerlink" title="æ·±åº¦å­¦ä¹ 500é—®"></a><a href="https://github.com/scutan90/DeepLearning-500-questions" target="_blank" rel="noopener">æ·±åº¦å­¦ä¹ 500é—®</a></h3><p><a href="https://github.com/scutan90/DeepLearning-500-questions" target="_blank" rel="noopener"><img src="/res/weeklyshare/DeepLearning-500-questions.png" alt></a></p>
<p>æ·±åº¦å­¦ä¹ 500é—®ï¼Œä»¥é—®ç­”å½¢å¼å¯¹å¸¸ç”¨çš„æ¦‚ç‡çŸ¥è¯†ã€çº¿æ€§ä»£æ•°ã€æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ã€è®¡ç®—æœºè§†è§‰ç­‰çƒ­ç‚¹é—®é¢˜è¿›è¡Œé˜è¿°ï¼Œä»¥å¸®åŠ©è‡ªå·±åŠæœ‰éœ€è¦çš„è¯»è€…ã€‚ å…¨ä¹¦åˆ†ä¸º18ä¸ªç« èŠ‚ï¼Œè¿‘30ä¸‡å­—ã€‚ç”±äºæ°´å¹³æœ‰é™ï¼Œä¹¦ä¸­ä¸å¦¥ä¹‹å¤„æ³è¯·å¹¿å¤§è¯»è€…æ‰¹è¯„æŒ‡æ­£ã€‚ æœªå®Œå¾…ç»­â€¦..</p>
]]></content>
      <categories>
        <category>æ¯å‘¨åˆ†äº«</category>
      </categories>
  </entry>
  <entry>
    <title>sqlite3-ç®€ä»‹.md</title>
    <url>/essay/sqlite3-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>åœ¨iOSä¸­æ“ä½œSQLiteæ•°æ®åº“å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼ˆæ³¨æ„å…ˆåœ¨é¡¹ç›®ä¸­å¯¼å…¥libsqlite3æ¡†æ¶ï¼‰ï¼š</p>
<ol>
<li>æ·»åŠ libsqlite3.tbd</li>
<li>æ‰“å¼€æ•°æ®åº“ï¼Œåˆ©ç”¨sqlite3_open()æ‰“å¼€æ•°æ®åº“ä¼šæŒ‡å®šä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨åˆ™ç›´æ¥æ‰“å¼€ï¼Œå¦åˆ™åˆ›å»ºå¹¶æ‰“å¼€ã€‚æ‰“å¼€æ•°æ®åº“ä¼šå¾—åˆ°ä¸€ä¸ªsqlite3ç±»å‹çš„å¯¹è±¡ï¼Œåé¢éœ€è¦å€ŸåŠ©è¿™ä¸ªå¯¹è±¡è¿›è¡Œå…¶ä»–æ“ä½œ</li>
<li>æ‰§è¡ŒSQLè¯­å¥ï¼Œæ‰§è¡ŒSQLè¯­å¥åˆåŒ…æ‹¬æœ‰è¿”å›å€¼çš„è¯­å¥å’Œæ— è¿”å›å€¼è¯­å¥ã€‚<ul>
<li>å¯¹äºæ— è¿”å›å€¼çš„è¯­å¥ï¼ˆå¦‚å¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ç­‰ï¼‰ç›´æ¥é€šè¿‡sqlite3_exec()å‡½æ•°æ‰§è¡Œï¼›</li>
<li>å¯¹äºæœ‰è¿”å›å€¼çš„è¯­å¥åˆ™é¦–å…ˆé€šè¿‡sqlite3_prepare_v2()è¿›è¡Œsqlè¯­å¥è¯„ä¼°ï¼ˆè¯­æ³•æ£€æµ‹ï¼‰ï¼Œç„¶åé€šè¿‡sqlite3_step()ä¾æ¬¡å–å‡ºæŸ¥è¯¢ç»“æœçš„æ¯ä¸€è¡Œæ•°æ®ï¼Œå¯¹äºæ¯è¡Œæ•°æ®éƒ½å¯ä»¥é€šè¿‡å¯¹åº”çš„sqlite3_column_ç±»å‹()æ–¹æ³•è·å¾—å¯¹åº”åˆ—çš„æ•°æ®ï¼Œå¦‚æ­¤åå¤å¾ªç¯ç›´åˆ°éå†å®Œæˆã€‚å½“ç„¶ï¼Œæœ€åéœ€è¦é‡Šæ”¾å¥æŸ„ã€‚</li>
</ul>
</li>
</ol>
<a id="more"></a>
<p>åœ¨æ•´ä¸ªæ“ä½œè¿‡ç¨‹ä¸­æ— éœ€ç®¡ç†æ•°æ®åº“è¿æ¥ï¼Œå¯¹äºåµŒå…¥å¼SQLiteæ“ä½œæ˜¯æŒä¹…è¿æ¥ï¼ˆå°½ç®¡å¯ä»¥é€šè¿‡sqlite3_close()å…³é—­ï¼‰ï¼Œä¸éœ€è¦å¼€å‘äººå‘˜è‡ªå·±é‡Šæ”¾è¿æ¥ã€‚çºµè§‚æ•´ä¸ªæ“ä½œè¿‡ç¨‹ï¼Œå…¶å®ä¸å…¶ä»–å¹³å°çš„å¼€å‘æ²¡æœ‰æ˜æ˜¾çš„åŒºåˆ«ï¼Œè¾ƒä¸ºéº»çƒ¦çš„å°±æ˜¯æ•°æ®è¯»å–ï¼Œåœ¨iOSå¹³å°ä¸­ä½¿ç”¨Cè¿›è¡Œæ•°æ®è¯»å–é‡‡ç”¨äº†æ¸¸æ ‡çš„å½¢å¼ï¼Œæ¯æ¬¡åªèƒ½è¯»å–ä¸€è¡Œæ•°æ®ï¼Œè¾ƒä¸ºéº»çƒ¦ã€‚</p>
<h3 id="æ·»åŠ framework"><a href="#æ·»åŠ framework" class="headerlink" title="æ·»åŠ framework"></a>æ·»åŠ framework</h3><p>éœ€è¦æ·»åŠ libsqlite3.tbdï¼ˆè€ç‰ˆæœ¬xocdeä¸­å«libsqlite3.dylibï¼‰</p>
<h3 id="æ‰“å¼€-åˆ›å»ºæ•°æ®åº“ï¼š"><a href="#æ‰“å¼€-åˆ›å»ºæ•°æ®åº“ï¼š" class="headerlink" title="æ‰“å¼€/åˆ›å»ºæ•°æ®åº“ï¼š"></a>æ‰“å¼€/åˆ›å»ºæ•°æ®åº“ï¼š</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) sqlite3 *database;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">BOOL</span>)openDb:(<span class="built_in">NSString</span> *)dbname&#123;</span><br><span class="line">   <span class="comment">//å–å¾—æ•°æ®åº“ä¿å­˜è·¯å¾„ï¼Œé€šå¸¸ä¿å­˜æ²™ç›’Documentsç›®å½•</span></span><br><span class="line">   <span class="built_in">NSString</span> *directory=[<span class="built_in">NSSearchPathForDirectoriesInDomains</span>(<span class="built_in">NSDocumentDirectory</span>, <span class="built_in">NSUserDomainMask</span>, <span class="literal">YES</span>) firstObject];</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"æ•°æ®åº“dbå‚¨å­˜è·¯å¾„ ï¼š %@"</span>,directory);</span><br><span class="line">   <span class="built_in">NSString</span> *filePath=[directory stringByAppendingPathComponent:dbname];</span><br><span class="line">   <span class="comment">//å¦‚æœæœ‰æ•°æ®åº“åˆ™ç›´æ¥æ‰“å¼€ï¼Œå¦åˆ™åˆ›å»ºå¹¶æ‰“å¼€ï¼ˆæ³¨æ„filePathæ˜¯ObjCä¸­çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦è½¬åŒ–ä¸ºCè¯­è¨€å­—ç¬¦ä¸²ç±»å‹ï¼‰</span></span><br><span class="line">   <span class="keyword">if</span> (SQLITE_OK ==sqlite3_open(filePath.UTF8String, &amp;_database)) &#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"æ•°æ®åº“æ‰“å¼€æˆåŠŸ!"</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"æ•°æ®åº“æ‰“å¼€å¤±è´¥!"</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ‰§è¡Œè¯­å¥"><a href="#æ‰§è¡Œè¯­å¥" class="headerlink" title="æ‰§è¡Œè¯­å¥"></a>æ‰§è¡Œè¯­å¥</h2><h3 id="æ‰§è¡Œæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤è¯­å¥"><a href="#æ‰§è¡Œæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤è¯­å¥" class="headerlink" title="æ‰§è¡Œæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤è¯­å¥"></a>æ‰§è¡Œæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤è¯­å¥</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="built_in">BOOL</span>)executeNonQuery:(<span class="built_in">NSString</span> *)sql&#123;</span><br><span class="line">   <span class="keyword">char</span> *error;</span><br><span class="line">   <span class="comment">//å•æ­¥æ‰§è¡Œsqlè¯­å¥ï¼Œç”¨äºæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤</span></span><br><span class="line">   <span class="keyword">if</span> (SQLITE_OK!=sqlite3_exec(_database, sql.UTF8String, <span class="literal">NULL</span>, <span class="literal">NULL</span>,&amp;error)) &#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"æ‰§è¡ŒSQLè¯­å¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼é”™è¯¯ä¿¡æ¯ï¼š%s"</span>,error);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰§è¡ŒæŸ¥è¯¢è¯­å¥"><a href="#æ‰§è¡ŒæŸ¥è¯¢è¯­å¥" class="headerlink" title="æ‰§è¡ŒæŸ¥è¯¢è¯­å¥"></a>æ‰§è¡ŒæŸ¥è¯¢è¯­å¥</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">-(<span class="built_in">NSArray</span> *)executeQuery:(<span class="built_in">NSString</span> *)sql&#123;</span><br><span class="line">   <span class="built_in">NSMutableArray</span> *rows=[<span class="built_in">NSMutableArray</span> array];<span class="comment">//æ•°æ®è¡Œ</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//è¯„ä¼°è¯­æ³•æ­£ç¡®æ€§</span></span><br><span class="line">   sqlite3_stmt *stmt;</span><br><span class="line">   <span class="comment">//æ£€æŸ¥è¯­æ³•æ­£ç¡®æ€§</span></span><br><span class="line">   <span class="keyword">if</span> (SQLITE_OK==sqlite3_prepare_v2(_database, sql.UTF8String, <span class="number">-1</span>, &amp;stmt, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">       <span class="comment">//å•æ­¥æ‰§è¡Œsqlè¯­å¥</span></span><br><span class="line">       <span class="keyword">while</span> (SQLITE_ROW==sqlite3_step(stmt)) &#123;</span><br><span class="line">           <span class="keyword">int</span> columnCount= sqlite3_column_count(stmt);</span><br><span class="line">           <span class="built_in">NSMutableDictionary</span> *dic=[<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;columnCount; i++) &#123;</span><br><span class="line">               <span class="keyword">const</span> <span class="keyword">char</span> *name= sqlite3_column_name(stmt, i);<span class="comment">//å–å¾—åˆ—å</span></span><br><span class="line">               <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *value= sqlite3_column_text(stmt, i);<span class="comment">//å–å¾—æŸåˆ—çš„å€¼</span></span><br><span class="line">               dic[[<span class="built_in">NSString</span> stringWithUTF8String:name]]=[<span class="built_in">NSString</span> stringWithUTF8String:(<span class="keyword">const</span> <span class="keyword">char</span> *)value];</span><br><span class="line">           &#125;</span><br><span class="line">           [rows addObject:dic];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//é‡Šæ”¾å¥æŸ„</span></span><br><span class="line">   sqlite3_finalize(stmt);</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h2><h3 id="ä¸€äº›æ–¹æ³•ï¼š"><a href="#ä¸€äº›æ–¹æ³•ï¼š" class="headerlink" title="ä¸€äº›æ–¹æ³•ï¼š"></a>ä¸€äº›æ–¹æ³•ï¼š</h3><ul>
<li>sqlite3          *db, æ•°æ®åº“å¥æŸ„ï¼Œè·Ÿæ–‡ä»¶å¥æŸ„FILEå¾ˆç±»ä¼¼</li>
<li>sqlite3_stmt      *stmt, è¿™ä¸ªç›¸å½“äºODBCçš„Commandå¯¹è±¡ï¼Œç”¨äºä¿å­˜ç¼–è¯‘å¥½çš„SQLè¯­å¥</li>
<li>sqlite3_open(),   æ‰“å¼€æ•°æ®åº“ï¼Œæ²¡æœ‰æ•°æ®åº“æ—¶åˆ›å»ºã€‚</li>
<li>sqlite3_exec(),   æ‰§è¡ŒéæŸ¥è¯¢çš„sqlè¯­å¥</li>
<li>sqlite3_step(), åœ¨è°ƒç”¨sqlite3_prepareåï¼Œä½¿ç”¨è¿™ä¸ªå‡½æ•°åœ¨è®°å½•é›†ä¸­ç§»åŠ¨ã€‚</li>
<li>sqlite3_close(), å…³é—­æ•°æ®åº“æ–‡ä»¶</li>
<li>è¿˜æœ‰ä¸€ç³»åˆ—çš„å‡½æ•°ï¼Œç”¨äºä»è®°å½•é›†å­—æ®µä¸­è·å–æ•°æ®ï¼Œå¦‚<ul>
<li>sqlite3_column_text(), å–textç±»å‹çš„æ•°æ®ã€‚</li>
<li>sqlite3_column_blobï¼ˆï¼‰ï¼Œå–blobç±»å‹çš„æ•°æ®</li>
<li>sqlite3_column_int(), å–intç±»å‹çš„æ•°æ®</li>
</ul>
</li>
</ul>
<h3 id="sqlite3æ•°æ®åº“æ‰“å¼€æ—¶çš„è¿”å›å€¼åŠå…¶æ‰€ä»£è¡¨çš„å«ä¹‰"><a href="#sqlite3æ•°æ®åº“æ‰“å¼€æ—¶çš„è¿”å›å€¼åŠå…¶æ‰€ä»£è¡¨çš„å«ä¹‰" class="headerlink" title="sqlite3æ•°æ®åº“æ‰“å¼€æ—¶çš„è¿”å›å€¼åŠå…¶æ‰€ä»£è¡¨çš„å«ä¹‰:"></a>sqlite3æ•°æ®åº“æ‰“å¼€æ—¶çš„è¿”å›å€¼åŠå…¶æ‰€ä»£è¡¨çš„å«ä¹‰:</h3><ul>
<li>SQLITE_OK=0 è¿”å›æˆåŠŸ</li>
<li>SQLITE_FULL=13 æ•°æ®åº“æ»¡ï¼Œæ’å…¥å¤±è´¥</li>
<li>SQLITE_ERROR=1 Sqlé”™è¯¯æˆ–é”™è¯¯çš„æ•°æ®åº“</li>
<li>SQLITE_CANTOPEN=14 ä¸èƒ½æ‰“å¼€æ•°æ®åº“æ–‡ä»¶</li>
<li>SQLITE_INTERNAL=2 Sqliteçš„å†…éƒ¨é€»è¾‘é”™è¯¯</li>
<li>SQLITE_PROTOCOL=15 æ•°æ®åº“é”å®šåè®®é”™è¯¯</li>
<li>SQLITE_PERM=3 æ‹’ç»è®¿é—®</li>
<li>SQLITE_EMPTY=16 æ•°æ®åº“è¡¨ä¸ºç©º</li>
<li>SQLITE_ABORT=4 å›è°ƒå‡½æ•°è¯·æ±‚ä¸­æ–­</li>
<li>SQLITE_SCHEMA=17 æ•°æ®åº“æ¨¡å¼æ”¹å˜</li>
<li>SQLITE_BUSY=5 æ•°æ®åº“æ–‡ä»¶è¢«é”</li>
<li>SQLITE_TOOBIG=18 ä¸€ä¸ªè¡¨æ•°æ®è¡Œè¿‡å¤š</li>
<li>SQLITE_LOCKED=6 æ•°æ®åº“ä¸­çš„ä¸€ä¸ªè¡¨è¢«é”</li>
<li>SQLITE_CONSTRAINT=19 ç”±äºçº¦æŸå†²çªè€Œä¸­æ­¢</li>
<li>SQLITE_NOMEN=7 å†…å­˜åˆ†é…å¤±è´¥</li>
<li>SQLITE_MISMATCH=20 æ•°æ®ç±»å‹ä¸åŒ¹é…</li>
<li>SQLITE_READONLY=8 è¯•å›¾å¯¹ä¸€ä¸ªåªè¯»æ•°æ®åº“è¿›è¡Œå†™æ“ä½œ</li>
<li>SQLITE_MISUSE=21 æ•°æ®åº“é”™è¯¯ä½¿ç”¨</li>
<li>SQLITE_INTERRUPT=9 ç”±sqlite_interrupt()ç»“æŸæ“ä½œ</li>
<li>SQLITE_NOLFS=22 ä½¿ç”¨ä¸»æœºæ“ä½œç³»ç»Ÿä¸æ”¯æŒçš„ç‰¹æ€§</li>
<li>SQLITE_IOERR=10 ç£ç›˜I/Oå‘ç”Ÿé”™è¯¯</li>
<li>SQLITE_AUTH=23 éæ³•æˆæƒ</li>
<li>SQLITE_CORRUPT=11 æ•°æ®åº“ç£ç›˜é•œåƒç•¸å½¢</li>
<li>SQLITE_FORMAT=24 è¾…åŠ©æ•°æ®åº“æ ¼å¼é”™è¯¯</li>
<li>SQLITE_NOTFOUND=12ï¼ˆInternal Onlyï¼‰è¡¨æˆ–è®°å½•ä¸å­˜åœ¨</li>
<li>SQLITE_NOTADB=26 æ‰“å¼€çš„ä¸æ˜¯ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶</li>
</ul>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Reduxæºç æµ…è¯»</title>
    <url>/essay/Redux%E6%BA%90%E7%A0%81%E6%B5%85%E8%AF%BB/</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡æ˜¯å…³äº reduxï¼ˆ3.7.2ï¼‰æºä»£ç çš„ä¸€äº›æµ…è¯»</p>
</blockquote>
<p>åœ¨<a href="https://github.com/reactjs/redux/tree/master/src" target="_blank" rel="noopener">reduxæºç ç›®å½•</a>ä¸­ ï¼Œå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ç›®å½•ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">|-- utils/</span><br><span class="line">    |-- warning.js              <span class="comment">//æ‰“å°error</span></span><br><span class="line">|-- <span class="number">1.</span> applyMiddleware.js          <span class="comment">// </span></span><br><span class="line">|-- <span class="number">2.</span> bindActionCreators.js       <span class="comment">//</span></span><br><span class="line">|-- <span class="number">3.</span> combineReducers.js          <span class="comment">//</span></span><br><span class="line">|-- <span class="number">4.</span> compose.js                  <span class="comment">//</span></span><br><span class="line">|-- <span class="number">5.</span> createStore.js              <span class="comment">//</span></span><br><span class="line">|-- index.js                    <span class="comment">//å…¥å£æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>
<p>ä¸æ–‡ä»¶å¯¹åº”çš„ï¼Œä¸»è¦ä¹Ÿæ˜¯ä»‹ç» createStore compose combineReducers bindActionCreators applyMiddlewareè¿™å‡ ä¸ªå‡½æ•°ã€‚</p>
<a id="more"></a>
<h3 id="1-compose"><a href="#1-compose" class="headerlink" title="1. compose"></a>1. compose</h3><p>å…ˆæ¥çœ‹çœ‹composeå‡½æ•°ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//funcsä¿å­˜ç€æ‰€æœ‰å‚æ•°å‡½æ•°çš„æ•°ç»„</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _len = <span class="built_in">arguments</span>.length, funcs = <span class="built_in">Array</span>(_len), _key = <span class="number">0</span>; _key &lt; _len; _key++) &#123;</span><br><span class="line">    funcs[_key] = <span class="built_in">arguments</span>[_key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//çœç•¥ä¸€äº›é€»è¾‘åˆ¤æ–­â€¦â€¦</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//reduceæ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„å‡½æ•°å°†æ•°ç»„å…ƒç´ è¿›è¡Œç»„åˆï¼Œç”Ÿæˆå•ä¸ªå€¼</span></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> a(b.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ä¸»è¦å°±æ˜¯å¯¹ reduce çš„ç†è§£äº†ã€‚reduce()æ–¹æ³•ä½¿ç”¨æŒ‡å®šçš„å‡½æ•°å°†æ•°ç»„å…ƒç´ è¿›è¡Œç»„åˆï¼ˆä»å·¦åˆ°å³ï¼‰ï¼Œç”Ÿæˆå•ä¸ªå€¼ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" target="_blank" rel="noopener">Array.prototype.reduce() | MDN</a></p>
<p>composeçš„åŠŸèƒ½ä¸ºä»å³åˆ°å·¦,ç»„åˆå‚æ•°(å‡½æ•°)ã€‚ä¼ é€’ç»™composeæ–¹æ³•çš„å‚æ•°æ˜¯å‡½æ•°ç±»å‹çš„ï¼Œ</p>
<p><strong>compose(f, g, h) ç›¸å½“äº (â€¦args) =&gt; f(g(h(â€¦args)))</strong></p>
<h3 id="2-applyMiddleware-ä¸-ä¸­é—´ä»¶é“¾"><a href="#2-applyMiddleware-ä¸-ä¸­é—´ä»¶é“¾" class="headerlink" title="2. applyMiddleware ä¸ ä¸­é—´ä»¶é“¾"></a>2. applyMiddleware ä¸ ä¸­é—´ä»¶é“¾</h3><p>æ•…åæ€ä¹‰è¿™ä¸ªå‡½æ•°å°±æ˜¯åº”ç”¨ä¸­é—´ä»¶ï¼Œä¸€èˆ¬ä½¿ç”¨æ–¹å¼ä¸ºï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//thunkä»£è¡¨react-thunkä¸­é—´ä»¶</span></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState, applyMiddleware(thunk));</span><br></pre></td></tr></table></figure>
<h4 id="2-1-ä¸­é—´ä»¶åŠreact-thunk"><a href="#2-1-ä¸­é—´ä»¶åŠreact-thunk" class="headerlink" title="2.1 ä¸­é—´ä»¶åŠreact-thunk"></a>2.1 ä¸­é—´ä»¶åŠreact-thunk</h4><p>åœ¨çœ‹applyMiddlewareå‡½æ•°å‰ï¼Œå…ˆæ¥ç®€å•çœ‹ä¸€ä¸‹ä¸­é—´ä»¶ï¼Œreduxä¸­é—´ä»¶åœ¨å‘èµ·actionåˆ°è¾¾reducerä¹‹é—´æ‰©å±•äº†ä¸€äº›åŠŸèƒ½ã€‚ä¸€èˆ¬ç”¨äºè®°å½•æ—¥å¿—ï¼ˆreudx-loggerï¼‰å’Œå¢åŠ å¼‚æ­¥è°ƒç”¨ï¼ˆredux-thunk , redux-sagaï¼‰ç­‰ã€‚è¿™äº›ä¸­é—´ä»¶ä¸€èˆ¬æŒ‰ç…§ä¸€å®šçš„æ ¼å¼ä¹¦å†™ï¼Œæ¯”å¦‚react-thunk2.2.0çš„æºç ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//react-thunk2.2.0çš„ä»£ç ï¼Œå¾ˆç®€å• åªæœ‰åå‡ è¡Œâ€¦â€¦</span></span><br><span class="line"><span class="comment">//å¤–å±‚å‡½æ•°å¯ä»¥ä¼ å…¥å¤šä½™çš„å‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createThunkMiddleware</span>(<span class="params">extraArgument</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//è·å–dispatch getStateï¼ˆæ˜¯ç”±applyMiddlewareä¼ å…¥ï¼‰</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_ref</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dispatch = _ref.dispatch,</span><br><span class="line">        getState = _ref.getState;</span><br><span class="line">    <span class="comment">//1. å¦‚æœè¿™ä¸ªä¸­é—´ä»¶æ˜¯è°ƒç”¨é“¾æœ€å†…ç¯çš„ï¼ŒnextæŒ‡åŸstore.dispatch    </span></span><br><span class="line">    <span class="comment">//2. å…¶ä»–nextä¸€èˆ¬æŒ‡ä¸Šä¸€ä¸ªä¸­é—´ä»¶çš„è¿”å›å€¼ action =&gt; &#123;&#125;</span></span><br><span class="line">    <span class="comment">//å¯¹äºè¿™ä¸ªnextçš„èµ‹å€¼ä¸æ¸…æ¥šçš„è¯å¯ä»¥ç»“åˆä¹‹åçš„applyMiddlewareå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">next</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">action</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//1. åŸactionåªæ˜¯ä¸ªæ™®é€šçš„å¯¹è±¡ï¼Œthunkä½¿actionå¯ä»¥ä¼ å…¥å‡½æ•°ç±»å‹ï¼Œå¹¶ä¼ å…¥äº†dispatch, getState, extraArgument</span></span><br><span class="line">        <span class="comment">//2. å¦‚æœactionæ˜¯ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œthunkä¼šè°ƒç”¨è¯¥å‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> action(dispatch, getState, extraArgument);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3. å‡½æ•°è°ƒç”¨ç»“æŸåï¼Œè·å–å¿…è¦çš„æ•°æ®å†æ¬¡è§¦å‘dispatchç”±æ­¤å®ç°å¼‚æ­¥æ•ˆæœã€‚</span></span><br><span class="line">        <span class="keyword">return</span> next(action);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°react-thunkä¸­é—´ä»¶æ˜¯ä¸€ä¸ªå¤šå±‚çš„é«˜é˜¶å‡½æ•°ï¼Œæ ¼å¼å¤§è‡´ä¸ºï¼š </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(&#123;dispatch,getState&#125;) =&gt; <span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;<span class="keyword">return</span> next(action)&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸­é—´ä»¶çš„æ ¼å¼éƒ½è¦éµå¾ªè¿™æ ·ç›¸ä¼¼çš„æ ¼å¼ï¼Œè¿™æ˜¯ç”±applyMiddlewareå‡½æ•°å†³å®šçš„ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹applyMiddlewareçš„æºç ï¼š</p>
<h4 id="2-2-applyMiddlewareæºç "><a href="#2-2-applyMiddlewareæºç " class="headerlink" title="2.2 applyMiddlewareæºç "></a>2.2 applyMiddlewareæºç </h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//applyMiddlewareæºç </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//middlewaresä¿å­˜ä¼ è¿›æ¥çš„ä¸­é—´ä»¶</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> _len = <span class="built_in">arguments</span>.length, middlewares = <span class="built_in">Array</span>(_len), _key = <span class="number">0</span>; _key &lt; _len; _key++) &#123;</span><br><span class="line">    middlewares[_key] = <span class="built_in">arguments</span>[_key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//createStoreæ˜¯åˆ›å»ºcreateStoreçš„å‡½æ•°ï¼Œä¼šåœ¨ä¸‹æ–‡è§£è¯»ï¼Œè¿™é‡Œå…ˆä¸ç®¡</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">createStore</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//åˆ›å»ºstore å¹¶è·å–äº†å…¶dispatchæ–¹æ³•</span></span><br><span class="line">      <span class="keyword">var</span> store = createStore(reducer, preloadedState, enhancer);</span><br><span class="line">      <span class="keyword">var</span> _dispatch = store.dispatch;</span><br><span class="line">      <span class="keyword">var</span> chain = [];</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//ç”¨äºä¼ é€’ç»™ä¸­é—´ä»¶ç¬¬ä¸€å±‚å‡½æ•°çš„å‚æ•°ï¼Œä¸Šæ–‡åœ¨thunkä¸­æœ‰çœ‹åˆ°</span></span><br><span class="line">      <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">        getState: store.getState,</span><br><span class="line">        dispatch: <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> _dispatch(action);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">//middlewaresä¿å­˜çš„æ˜¯ä¸­é—´ä»¶ï¼Œchainå¯¹åº”ä¿å­˜çš„å°±æ˜¯ä¸­é—´ä»¶ç¬¬äºŒå±‚å‡½æ•°ç»„æˆçš„æ•°ç»„</span></span><br><span class="line">      <span class="comment">//å½¢è±¡ç‚¹å°±æ˜¯ä¸Šæ–‡ä¸­é—´ä»¶æ ¼å¼å»æ‰ç¬¬ä¸€å±‚ï¼šnext =&gt; action =&gt; &#123;&#125;</span></span><br><span class="line">      chain = middlewares.map(<span class="function"><span class="keyword">function</span> (<span class="params">middleware</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> middleware(middlewareAPI);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//1. componseçš„åŠŸèƒ½åœ¨ä¸Šæ–‡è¯´åˆ°ï¼Œå‡è®¾chainä¸º[F1,F2,F3],composeä¹‹åå˜æˆäº†F1(F2(F3))</span></span><br><span class="line">      <span class="comment">//2. ä¸ä¸Šæ–‡thunkä¸­è¯´åˆ°ä¸­é—´ä»¶æ ¼å¼å¯¹åº”ï¼ŒF3æ˜¯ä¸­é—´ä»¶é“¾çš„æœ€å†…ç¯ æ‰€ä»¥F3çš„nextå‚æ•°ä¸ºstore.dispatch</span></span><br><span class="line">      <span class="comment">//3. F2çš„nextå‚æ•°å°±æ˜¯F3è¿”å›çš„ action =&gt; &#123;&#125;</span></span><br><span class="line">      <span class="comment">//4. åŒæ ·çš„F1çš„nextå‚æ•°å°±æ˜¯F2è¿”å›çš„ action =&gt; &#123;&#125;      </span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">//_dispatchå°±ç›¸å½“äºF1(F2(F3(store.dispatch)))</span></span><br><span class="line">      <span class="comment">//è¿™æ ·å¤šä¸ªä¸­é—´ä»¶å°±ç»„åˆåˆ°äº†ä¸€èµ·ï¼Œå½¢æˆäº†ä¸­é—´ä»¶é“¾</span></span><br><span class="line">      _dispatch = compose.apply(<span class="literal">undefined</span>, chain)(store.dispatch);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">//æ–°çš„dispatchä¼šè¦†ç›–åŸdispatchï¼Œä¹‹åè°ƒç”¨dispatchåŒæ—¶ä¼šè°ƒç”¨ä¸­é—´ä»¶é“¾</span></span><br><span class="line">      <span class="keyword">return</span> _extends(&#123;&#125;, store, &#123;</span><br><span class="line">        dispatch: _dispatch</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>_dispatch = compose.apply(undefined, chain)(store.dispatch);</code>ç»„åˆåï¼Œä¸­é—´ä»¶çš„nextå°±æ˜¯store.dispatchä¸€è·¯ç»è¿‡ä¸Šä¸€ä¸ªä¸­é—´ä»¶å°è£…åçš„å˜ç§dispatchã€‚</p>
<h4 id="2-3-ä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåº"><a href="#2-3-ä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="2.3 ä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåº"></a>2.3 ä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåº</h4><p>å…‰çœ‹ä»£ç å¯èƒ½å¯¹äºä¸­é—´ä»¶é“¾çš„æ‰§è¡Œé¡ºåºçš„ç†è§£è¿˜æ˜¯ä¼˜ç‚¹è’™ï¼Œè¿™é‡Œæ¥åšä¸ªå®è·µåŠ æ·±ä¸€ä¸‹ç†è§£ã€‚</p>
<blockquote>
<p><strong>ä¸€ã€</strong> å…ˆæŒ‰ä¸Šæ–‡è¯´çš„ä¸­é—´ä»¶æ ¼å¼<code>({dispatch,getState}) =&gt; next =&gt; action =&gt; {return next(action)}</code> å†™ä¸‰ä¸ªä¸­é—´ä»¶ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware1</span>(<span class="params">&#123;dispatch,getState&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'middleware1 nextå±‚ next:'</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware1 actionå±‚ å¼€å§‹'</span>)</span><br><span class="line">            next(action)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware1 actionå±‚ ç»“æŸ'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware2</span>(<span class="params">&#123;dispatch,getState&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'middleware2 nextå±‚ next:'</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware2 actionå±‚ å¼€å§‹'</span>)</span><br><span class="line">            next(action)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware2 actionå±‚ ç»“æŸ'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">middleware3</span>(<span class="params">&#123;dispatch,getState&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'middleware3 nextå±‚ next:'</span>,next);</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware3 actionå±‚ å¼€å§‹'</span>)</span><br><span class="line">            next(action)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'middleware3 actionå±‚ ç»“æŸ'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>äºŒã€</strong> å°†å®ƒä»¬å’Œredux-thunk å’Œ redux-loggerä¸€èµ·åŠ å…¥ä¸­é—´ä»¶é“¾ï¼š</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> middlewares = [</span><br><span class="line">    middleware1,</span><br><span class="line">    thunkMiddleWare,</span><br><span class="line">    middleware2,</span><br><span class="line">    middleware3,</span><br><span class="line">    loggerMiddleWare,<span class="comment">//redux-loggeréœ€è¦æ”¾åœ¨æœ€åé¢</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(rootReducer, initialState, applyMiddleware(...middlewares));</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä½ çš„ä»£ç ååœ¨chromeæ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">middleware3 nextå±‚ next: Æ’ (l)&#123;<span class="keyword">if</span>(<span class="string">"function"</span>==<span class="keyword">typeof</span> â€¦</span><br><span class="line"> </span><br><span class="line">middleware2 nextå±‚ next: Æ’ (action)&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'middleware3 actionå±‚ å¼€å§‹'</span>);</span><br><span class="line">next(action);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'middleware3 actionå±‚ ç»“æŸ'</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">middleware1 nextå±‚ next: Æ’ (action) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> action(dispatch, getState, extraArgument);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> next(action);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¹ŸéªŒè¯äº†ä¸Šæ–‡å¯¹ <code>_dispatch = compose.apply(undefined, chain)(store.dispatch);</code>çš„ç†è§£ã€‚</p>
<p>è¿™é‡Œçš„ä¸­é—´ä»¶é“¾æ˜¯ç”± <code>[m1,thunk,m2,m3,logger]</code>ç»„æˆï¼Œåœ¨<code>compose</code>ä¹‹åå˜æˆäº† <code>m1(thunk(m2(m3(logger))))</code>,<br>æ‰€ä»¥</p>
<ul>
<li>m3çš„<em>next</em>å‚æ•°æ˜¯<strong>logger</strong>çš„actionå±‚å‡½æ•°ï¼ˆå‚æ•°ä¸ºactioné‚£å±‚å‡½æ•°ï¼‰</li>
<li>m2çš„<em>next</em>å‚æ•°æ˜¯<strong>m3</strong>çš„actionå±‚å‡½æ•°</li>
<li>m1çš„<em>next</em>å‚æ•°æ˜¯<strong>thunk</strong>çš„actionå±‚å‡½æ•°</li>
</ul>
<blockquote>
<p><strong>ä¸‰ã€</strong> æ‰§è¡Œä¸€ä¸‹ dispatch(action) :</p>
</blockquote>
<p>è¿™æ—¶å€™åˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<p>1ã€å½“actionç±»å‹ä¸ºå¯¹è±¡æ—¶,åœ¨chromeæ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">å‘èµ· dispatch(action) actionç±»å‹ä¸ºå¯¹è±¡</span><br><span class="line"></span><br><span class="line">middleware1 actionå±‚ å¼€å§‹</span><br><span class="line">middleware2 actionå±‚ å¼€å§‹</span><br><span class="line">middleware3 actionå±‚ å¼€å§‹</span><br><span class="line">action SOME_OBJ_ACTION       redux-logger.js:<span class="number">1</span></span><br><span class="line">middleware3 actionå±‚ ç»“æŸ</span><br><span class="line">middleware2 actionå±‚ ç»“æŸ</span><br><span class="line">middleware1 actionå±‚ ç»“æŸ</span><br></pre></td></tr></table></figure>
<p>ç²—ç²—ä¸€çœ‹å¥½åƒé¡ºåºä¸å¯¹å•Šï¼Œä¸è¯¥å…ˆæ‰§è¡Œmiddleware3çš„é€»è¾‘å˜›ï¼Ÿå…¶å®å†…å±‚ï¼ˆä½ç½®é åçš„ä¸­é—´ä»¶ï¼‰åªæ˜¯è¿”å›äº†ä¸€ä¸ªfunctionï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå…¶ä¸­çš„é€»è¾‘ï¼Œä¸æ–­ç”±å¤–å±‚çš„ä¸­é—´ä»¶åŒ…è£¹å½¢æˆäº†ä¸€ä¸ªâ€˜<strong>æ´‹è‘±æ¨¡å‹</strong>â€™ã€‚ç”±å¤–å‘å†…ç©¿å¿ƒè€Œè¿‡ï¼Œå†ç”±å†…å‘å¤–å®Œæˆæµç¨‹ã€‚</p>
<p>è¿™æ ·å­å°±å¾ˆæ˜ç¡®äº†ï¼Œ<strong>ä¸­é—´ä»¶çš„actionå±‚æ‰§è¡Œé¡ºåºä¸ºå…ˆåŠ å…¥ä¸­é—´ä»¶é“¾çš„å…ˆæ‰§è¡Œï¼</strong>ï¼Œæ›´å‡†ç¡®çš„è¯´ä¸­é—´ä»¶ä¸­å…ˆæ‰§è¡Œä»å¤–å±‚å‘å†…å±‚ä¸­ <code>next(action)</code>ä¹‹å‰çš„é€»è¾‘ï¼Œç„¶åæ‰§è¡Œä»å†…å±‚å‘å¤–å±‚ä¸­ <code>next(action)</code>ä¹‹åçš„é€»è¾‘ã€‚</p>
<p>2ã€å½“actionç±»å‹ä¸ºå‡½æ•°æ—¶,åœ¨chromeæ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">å‘èµ·  dispatch(action) actionç±»å‹ä¸ºå‡½æ•°</span><br><span class="line"></span><br><span class="line">middleware1 actionå±‚ å¼€å§‹</span><br><span class="line">middleware1 actionå±‚ ç»“æŸ</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åªæ‰§è¡Œäº† middleware1 å’Œ thunk ä¸¤ä¸ªä¸­é—´ä»¶ï¼<strong>è¿™æ˜¯å› ä¸ºthunkæ²¡æœ‰æ‰§è¡Œ <code>next(action)</code> ä¸­æ–­äº†ä¸­é—´ä»¶é“¾ï¼</strong> å½“ä¸­é—´ä»¶æ²¡æœ‰æ‰§è¡Œnext(action)æ—¶ä¼šå¯¼è‡´ä¸­é—´ä»¶é“¾ä¸­æ–­ï¼Œè¿™æ˜¯å› ä¸ºdispatchæ²¡æœ‰ä¼ é€’ä¸‹å»ï¼Œæ‰€ä»¥ä¸­é—´ä»¶è¿˜å¯ä»¥æ£ä¹±å’¯ï½</p>
<h3 id="3-bindActionCreators"><a href="#3-bindActionCreators" class="headerlink" title="3. bindActionCreators"></a>3. bindActionCreators</h3><p>bindActionCreatorsçš„åŠŸèƒ½æ˜¯ä¸ºaction creatersåŒ…è£…ä¸Šdispatchï¼Œä½¿å…¶è°ƒç”¨actionæ—¶è‡ªåŠ¨dispatchå¯¹åº”çš„actionã€‚</p>
<p>åœ¨bindActionCreators.jsä¸­åªæœ‰ä¸¤ä¸ªå‡½æ•° <code>bindActionCreator</code> å’Œ <code>bindActionCreators</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨è¿”å›çš„è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨çš„dispatchå¯¹åº”çš„action</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="literal">undefined</span>, <span class="built_in">arguments</span>));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//çœç•¥ä¸€äº›é€»è¾‘åˆ¤æ–­</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–æ‰€æœ‰action createrå‡½æ•°çš„åå­—</span></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="built_in">Object</span>.keys(actionCreators);</span><br><span class="line">  <span class="comment">// ä¿å­˜dispatchå’Œaction createrå‡½æ•°è¿›è¡Œç»‘å®šä¹‹åçš„é›†åˆ</span></span><br><span class="line">  <span class="keyword">var</span> boundActionCreators = &#123;&#125;;</span><br><span class="line">  <span class="comment">//ä¸ºæ¯ä¸ªactionCreators åŒ…è£…ä¸Š dispatch</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = keys[i];</span><br><span class="line">    <span class="keyword">var</span> actionCreator = actionCreators[key];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-combineReducers"><a href="#4-combineReducers" class="headerlink" title="4. combineReducers"></a>4. combineReducers</h3><p>Reduceråªæ˜¯ä¸€äº›çº¯å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¹‹å‰çš„stateå’Œactionï¼Œå¹¶è¿”å›æ–°çš„stateã€‚å½“åº”ç”¨å˜å¤§ï¼Œæˆ‘ä»¬å¯ä»¥æ‹†åˆ†å¤šä¸ªå°çš„reducersï¼Œåˆ†åˆ«ç‹¬ç«‹çš„æ“ä½œstate treeçš„ä¸åŒéƒ¨åˆ†ã€‚è€ŒcombineReducerså°±æ˜¯å°†å¤šä¸ªä¸åŒçš„reduceråˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„reducerï¼Œç”¨äºèµ‹å€¼ç»™createStoreå‡½æ•°ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//combineReducersçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œåœ¨çœç•¥ä¸€äº›é”™è¯¯åˆ¤æ–­çš„ä»£ç åï¼š</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;  </span><br><span class="line">  <span class="keyword">var</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers);</span><br><span class="line">  <span class="keyword">var</span> finalReducers = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = reducerKeys[i];</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä»ä¸Šé¢åˆ°è¿™é‡Œéƒ½æ˜¯ä¸ºäº†ä¿å­˜finalReducerKeys å’Œ finalReducers</span></span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è¿”å›çš„combinationå‡½æ•°å°±ç›¸å½“äºç»“åˆæ‰€æœ‰reducersä¹‹åæ–°çš„reducer</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="built_in">arguments</span>.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">arguments</span>[<span class="number">0</span>] !== <span class="literal">undefined</span> ? <span class="built_in">arguments</span>[<span class="number">0</span>] : &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> action = <span class="built_in">arguments</span>[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> hasChanged = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> nextState = &#123;&#125;;</span><br><span class="line">    <span class="comment">//è¿™é‡Œéå†äº†æ‰€æœ‰ä¹‹å‰è‡ªå®šä¹‰çš„reducersï¼Œå¹¶è®°å½•ä¸‹æ˜¯å¦stateæœ‰æ”¹å˜ï¼Œå¹¶è®°å½•ä¸‹æ”¹å˜çš„state</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; finalReducerKeys.length; _i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> _key = finalReducerKeys[_i];</span><br><span class="line">      <span class="keyword">var</span> reducer = finalReducers[_key];</span><br><span class="line">      <span class="keyword">var</span> previousStateForKey = state[_key];</span><br><span class="line">      <span class="comment">//éå†æ‰€æœ‰çš„reducerï¼Œè‹¥previousStateForKeyåŒ¹é…åˆ°åˆ™è¿”å›æ–°çš„state</span></span><br><span class="line">      <span class="comment">//è‹¥åŒ¹é…ä¸åˆ°å°±åœ¨reducerä¸­dufaultä¸­è¿”å›åŸstate</span></span><br><span class="line">      <span class="keyword">var</span> nextStateForKey = reducer(previousStateForKey, action);</span><br><span class="line">      ......</span><br><span class="line">      nextState[_key] = nextStateForKey;</span><br><span class="line">      <span class="comment">//è¿™é‡Œæœ‰ç‚¹æ„æ€ï¼Œå¹¶æ²¡æœ‰å› ä¸ºæ‰¾åˆ°ä¸åŒçš„stateå°±ç›´æ¥è¿”å›</span></span><br><span class="line">      <span class="comment">//è¿™æ„å‘³ç€ï¼Œå¤šä¸ªå­reducerså¯ä»¥å¯¹åŒä¸ªactionè¿”å›è‡ªå·±çš„state</span></span><br><span class="line">      <span class="comment">//å¹¶ä¸”è¿”å›çš„stateæ˜¯ä¾æ®é åçš„reducerçš„è¿”å›å€¼å†³å®šçš„</span></span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-createStore"><a href="#5-createStore" class="headerlink" title="5. createStore"></a>5. createStore</h3><p>ç°åœ¨æ¥çœ‹ä¸‹æœ€é‡è¦çš„createStoreå‡½æ•°ï¼š</p>
<!--preloadedState-->
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* reduxæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªstoreï¼ŒcreateStoreå‡½æ•°å°±æ˜¯ç”¨äºåˆ›å»ºä¸€ä¸ªstoreç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„stateã€‚</span></span><br><span class="line"><span class="comment">* @param &#123;Function&#125;  reducer</span></span><br><span class="line"><span class="comment">* @param &#123;any&#125; [preloadedState] åˆå§‹åŒ–state</span></span><br><span class="line"><span class="comment">* @param &#123;Function&#125; [enhancer] storeçš„å¢å¼ºå™¨ï¼Œæœ‰applyMiddlewareã€æ—¶é—´æ—…è¡Œï¼ˆtime travelï¼‰ã€æŒä¹…åŒ–ï¼ˆpersistenceï¼‰ç­‰ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æ˜¯createStoreçš„å‚æ•°ï¼Œå…¶ä¸­enhanceræŒ‡çš„æ˜¯storeçš„å¢å¼ºå™¨ï¼ˆå¯¹store APIè¿›è¡Œæ”¹é€ ï¼‰ã€‚</p>
<ul>
<li>applyMiddlewareåœ¨å‰é¢æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼ŒapplyMiddlewareæ˜¯å¯¹storeçš„dispatchå‡½æ•°çš„ä¿®æ”¹ã€‚</li>
<li><strong>æ—¶é—´æ—…è¡Œ</strong>åˆ™æ˜¯æŒ‡reduxå¯ä»¥å›åˆ°ä»»æ„ä»¥å‰çš„çŠ¶æ€ã€‚<ul>
<li>è¿™æ˜¯å› ä¸ºReduxä½¿ç”¨ç®€å•çš„å¯¹è±¡æ¥è¡¨ç¤ºstateçŠ¶æ€ï¼Œå¹¶ä½¿ç”¨çº¯å‡½æ•°è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚è¿™æ„å‘³ç€å¦‚æœç»™å®šä¸€ä¸ªç‰¹å®šstateçŠ¶æ€å’Œä¸€ä¸ªç‰¹å®šactionæ“ä½œï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªçŠ¶æ€å°†å§‹ç»ˆå®Œå…¨ç›¸åŒã€‚è¿™ç§ç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„çŠ¶æ€ä¿å­˜åœ¨ä¸€ä¸ªçŠ¶æ€å†å²å¯¹è±¡ä¸­ï¼Œé€šè¿‡æŒ‡å®šæ¢å¤åˆ°çŠ¶æ€å†å²å¯¹è±¡ä¸­ä»å‰çš„çŠ¶æ€ï¼Œæ¥å®Œæˆæ—¶é—´æ—…è¡Œã€‚</li>
<li>æ¯”è¾ƒå®¹æ˜“å¯ä»¥æƒ³åˆ°çš„åº”ç”¨å°±æ˜¯ä¸€äº›æ’¤é”€/é‡åšæ“ä½œã€‚</li>
</ul>
</li>
<li><strong>æŒä¹…åŒ–</strong>æŒä¹…åŒ–è¿™ä¸ªæ¦‚å¿µè‚¯å®šå¤§å®¶éƒ½ç†Ÿæ‚‰ï¼Œä¹Ÿæœ‰äººåšå‡ºäº†å®ç°ï¼š<a href="https://github.com/rt2zz/redux-persist" target="_blank" rel="noopener">redux-persist</a></li>
</ul>
<p>ä»‹ç»å®Œenhancerï¼Œæ¥æ¥ç€çœ‹ä»£ç é€»è¾‘ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _ref2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    enhancer = preloadedState;</span><br><span class="line">    preloadedState = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> currentReducer = reducer;      	<span class="comment">//</span></span><br><span class="line">  <span class="keyword">var</span> currentState = preloadedState; 	<span class="comment">//å½“å‰çš„state</span></span><br><span class="line">  <span class="keyword">var</span> currentListeners = [];           <span class="comment">//è®¢é˜…å‡½æ•°</span></span><br><span class="line">  <span class="keyword">var</span> nextListeners = currentListeners;<span class="comment">//è®¢é˜…å‡½æ•°å¤‡ä»½ï¼Œ</span></span><br><span class="line">  <span class="comment">//ç”¨äºè§£å†³listenersæ•°ç»„æ‰§è¡Œè¿‡ç¨‹ï¼ˆforå¾ªç¯ï¼‰ä¸­ï¼Œå–æ¶ˆè®¢é˜…listeneräº§ç”Ÿçš„listenersæ•°ç»„indexé”™è¯¯ã€‚</span></span><br><span class="line">  <span class="comment">//è¿™æ ·ä¿è¯åœ¨æŸä¸ªdispatchåï¼Œä¼šä¿è¯åœ¨è¿™ä¸ªdispatchä¹‹å‰çš„æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å…¨éƒ¨æ‰§è¡Œ</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> isDispatching = <span class="literal">false</span>; 			  <span class="comment">//dispatchæ–¹æ³•åŒæ­¥æ ‡å¿—</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * @returns &#123;any&#125; å½“å‰state</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * å°†ä¸€ä¸ªè®¢é˜…å‡½æ•°æ”¾åˆ° listeners é˜Ÿåˆ—é‡Œï¼Œå½“ dispatch çš„æ—¶å€™ï¼Œé€ä¸€è°ƒç”¨ listeners ä¸­çš„å›è°ƒæ–¹æ³•ã€‚    </span></span><br><span class="line"><span class="comment">  * @param &#123;Function&#125; listenerå‡½æ•°</span></span><br><span class="line"><span class="comment">  * @return &#123;Function&#125; è§£é™¤ç»‘å®šçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected listener to be a function.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> isSubscribed = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners();</span><br><span class="line">    nextListeners.push(listener);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è§£é™¤è®¢é˜…çš„æ–¹æ³•ï¼Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      ensureCanMutateNextListeners();</span><br><span class="line">      <span class="keyword">var</span> index = nextListeners.indexOf(listener);</span><br><span class="line">      nextListeners.splice(index, <span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * dispatchæ–¹æ³•,è°ƒç”¨reducer</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param &#123;Object&#125; action </span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @returns &#123;Object&#125; ä¸€èˆ¬ä¼šè¿”å›action,</span></span><br><span class="line"><span class="comment">   * å¦‚æœä½¿ç”¨äº†ä¸­é—´ä»¶ï¼Œå¯èƒ½è¿”å›promise æˆ–è€…functionä¹‹ç±»çš„ï¼ˆï¼‰</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">//dispatchæ˜¯åŒæ­¥çš„ï¼Œç”¨isDispatchingæ ‡å¿—æ¥åˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Reducers may not dispatch actions.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è°ƒç”¨reducer</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">//æ›´æ–°stateæ ‘</span></span><br><span class="line">      currentState = currentReducer(currentState, action);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è°ƒç”¨nextListenersä¸­çš„ç›‘å¬æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">var</span> listeners = currentListeners = nextListeners;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> listener = listeners[i];</span><br><span class="line">      listener();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * æ›¿æ¢reducer</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    currentReducer = nextReducer;</span><br><span class="line">    <span class="comment">//è§¦å‘ç”Ÿæˆæ–°çš„stateæ ‘</span></span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *ç•¥</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”Ÿæˆåˆå§‹stateæ ‘</span></span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _ref2 = &#123;</span><br><span class="line">    dispatch: dispatch,</span><br><span class="line">    subscribe: subscribe,</span><br><span class="line">    getState: getState,</span><br><span class="line">    replaceReducer: replaceReducer</span><br><span class="line">  &#125;, _ref2[$$observable] = observable, _ref2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>ä»¥ä¸Šå°±æ˜¯æˆ‘ä¸ªäººçš„ç®€å•è§è§£ï¼Œå¦‚æœæœ‰ä»€ä¹ˆé”™è¯¯ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å¯¼è®¨è®º</em></p>
<hr>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener">Redux å…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰ï¼šåŸºæœ¬ç”¨æ³• | é˜®ä¸€å³°</a></li>
<li><a href="http://cn.redux.js.org/" target="_blank" rel="noopener">Redux ä¸­æ–‡æ–‡æ¡£</a></li>
</ul>
]]></content>
      <categories>
        <category>essay</category>
        <category>Redux</category>
      </categories>
      <tags>
        <tag>å‰ç«¯å·¥ç¨‹åŒ–</tag>
        <tag>Redux</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHubç²¾é€‰åˆ†äº«ç¬¬ä¸‰æœŸ</title>
    <url>/weekly-share/GitHub%E7%B2%BE%E9%80%89%E5%88%86%E4%BA%AB%E7%AC%AC%E4%B8%89%E6%9C%9F/</url>
    <content><![CDATA[<p>è®°å½•è¿™å‘¨çœ‹åˆ°å€¼å¾—åˆ†äº«çš„äº‹ï¼Œæœ¬æœŸå°±åˆ†äº«ç‚¹å‰ç«¯å¯è§†åŒ–ç›¸å…³å§~</p>
<h3 id="lianjia-scrawler-é“¾å®¶äºŒæ‰‹æˆ¿ç§Ÿæˆ¿åœ¨çº¿æ•°æ®ï¼Œå­˜é‡æˆ¿äº¤æ˜“æœåŠ¡å¹³å°æ•°æ®"><a href="#lianjia-scrawler-é“¾å®¶äºŒæ‰‹æˆ¿ç§Ÿæˆ¿åœ¨çº¿æ•°æ®ï¼Œå­˜é‡æˆ¿äº¤æ˜“æœåŠ¡å¹³å°æ•°æ®" class="headerlink" title="lianjia-scrawler é“¾å®¶äºŒæ‰‹æˆ¿ç§Ÿæˆ¿åœ¨çº¿æ•°æ®ï¼Œå­˜é‡æˆ¿äº¤æ˜“æœåŠ¡å¹³å°æ•°æ®"></a><a href="https://github.com/XuefengHuang/lianjia-scrawler" target="_blank" rel="noopener">lianjia-scrawler é“¾å®¶äºŒæ‰‹æˆ¿ç§Ÿæˆ¿åœ¨çº¿æ•°æ®ï¼Œå­˜é‡æˆ¿äº¤æ˜“æœåŠ¡å¹³å°æ•°æ®</a></h3><a id="more"></a>
<p><a href="https://github.com/XuefengHuang/lianjia-scrawler" target="_blank" rel="noopener"><img src="https://github.com/XuefengHuang/lianjia-scrawler/raw/master/screenshots/homepage_1.png" width="50%"></a></p>
<blockquote class="blockquote-center"><p>è¯¥é¡¹ç›®æä¾›ä¸€ä¸ªé“¾å®¶ç½‘å…¨å›½æˆ¿æºçˆ¬è™«å·¥å…·ï¼Œæ•°æ®å­˜å‚¨ç›®å‰æ”¯æŒMysql,Sqliteå’ŒPostgresã€‚éå¸¸æ–¹ä¾¿è½¬åŒ–æˆcsvç­‰æ ¼å¼æ–‡ä»¶ã€‚<br>è¯¦ç»†æ•°æ®åˆ†ææ•™ç¨‹ <a href="http://www.ershoufangdata.com" target="_blank" rel="noopener">http://www.ershoufangdata.com</a></p>
</blockquote>
<h3 id="D3-ä¸€ä¸ªåŸºäºwebæ ‡å‡†çš„JavaScriptå¯è§†åŒ–åº“"><a href="#D3-ä¸€ä¸ªåŸºäºwebæ ‡å‡†çš„JavaScriptå¯è§†åŒ–åº“" class="headerlink" title="D3 ä¸€ä¸ªåŸºäºwebæ ‡å‡†çš„JavaScriptå¯è§†åŒ–åº“"></a><a href="https://github.com/d3/d3" target="_blank" rel="noopener">D3 ä¸€ä¸ªåŸºäºwebæ ‡å‡†çš„JavaScriptå¯è§†åŒ–åº“</a></h3><p><a href="https://github.com/d3/d3" target="_blank" rel="noopener"><img src="https://camo.githubusercontent.com/722a5cc12c7d40231ebeb8ca6facdc8547e2abf7/68747470733a2f2f64336a732e6f72672f6c6f676f2e737667" alt></a></p>
<blockquote class="blockquote-center"><p>D3 (æˆ–è€…å« D3.js )æ˜¯ä¸€ä¸ªåŸºäº web æ ‡å‡†çš„ JavaScript å¯è§†åŒ–åº“.<br>D3 å¯ä»¥å€ŸåŠ© SVG, Canvas ä»¥åŠ HTML å°†ä½ çš„æ•°æ®ç”ŸåŠ¨çš„å±•ç°å‡ºæ¥.<br>D3 ç»“åˆäº†å¼ºå¤§çš„å¯è§†åŒ–äº¤äº’æŠ€æœ¯ä»¥åŠæ•°æ®é©±åŠ¨ DOM çš„æŠ€æœ¯ç»“åˆèµ·æ¥,<br>è®©ä½ å¯ä»¥å€ŸåŠ©äºç°ä»£æµè§ˆå™¨çš„å¼ºå¤§åŠŸèƒ½è‡ªç”±çš„å¯¹æ•°æ®è¿›è¡Œå¯è§†åŒ–ã€‚</p>
</blockquote>
<h3 id="G2-ä¸€å¥—åŸºäºå¯è§†åŒ–ç¼–ç çš„å›¾å½¢è¯­æ³•"><a href="#G2-ä¸€å¥—åŸºäºå¯è§†åŒ–ç¼–ç çš„å›¾å½¢è¯­æ³•" class="headerlink" title="G2 ä¸€å¥—åŸºäºå¯è§†åŒ–ç¼–ç çš„å›¾å½¢è¯­æ³•"></a><a href="https://github.com/antvis/g2" target="_blank" rel="noopener">G2 ä¸€å¥—åŸºäºå¯è§†åŒ–ç¼–ç çš„å›¾å½¢è¯­æ³•</a></h3><p><a href="https://github.com/antvis/g2" target="_blank" rel="noopener"><img src="https://antv.alipay.com/assets/image/home/g2/case3.png" alt></a></p>
<blockquote class="blockquote-center"><p>G2 æ˜¯ä¸€å¥—åŸºäºå¯è§†åŒ–ç¼–ç çš„å›¾å½¢è¯­æ³•ï¼Œ<br>ä»¥æ•°æ®é©±åŠ¨ï¼Œå…·æœ‰é«˜åº¦çš„æ˜“ç”¨æ€§å’Œæ‰©å±•æ€§ï¼Œ<br>ç”¨æˆ·æ— éœ€å…³æ³¨å„ç§ç¹ççš„å®ç°ç»†èŠ‚ï¼Œä¸€æ¡è¯­å¥å³å¯æ„å»ºå‡ºå„ç§å„æ ·çš„å¯äº¤äº’çš„ç»Ÿè®¡å›¾è¡¨</p>
</blockquote>
<h3 id="echarts-ä¸€ä¸ªä½¿ç”¨JavaScriptå®ç°çš„å¼€æºå¯è§†åŒ–åº“"><a href="#echarts-ä¸€ä¸ªä½¿ç”¨JavaScriptå®ç°çš„å¼€æºå¯è§†åŒ–åº“" class="headerlink" title="echarts ä¸€ä¸ªä½¿ç”¨JavaScriptå®ç°çš„å¼€æºå¯è§†åŒ–åº“"></a><a href="https://github.com/apache/incubator-echarts" target="_blank" rel="noopener">echarts ä¸€ä¸ªä½¿ç”¨JavaScriptå®ç°çš„å¼€æºå¯è§†åŒ–åº“</a></h3><p><a href="https://github.com/apache/incubator-echarts" target="_blank" rel="noopener"><img src="https://github.com/apache/incubator-echarts/raw/master/asset/logo.png?raw=true" alt=" "></a></p>
<blockquote class="blockquote-center"><p>EChartsï¼Œä¸€ä¸ªä½¿ç”¨ JavaScript å®ç°çš„å¼€æºå¯è§†åŒ–åº“ï¼Œ<br>å¯ä»¥æµç•…çš„è¿è¡Œåœ¨ PC å’Œç§»åŠ¨è®¾å¤‡ä¸Šï¼Œ<br>å…¼å®¹å½“å‰ç»å¤§éƒ¨åˆ†æµè§ˆå™¨ï¼ˆIE8/9/10/11ï¼ŒChromeï¼ŒFirefoxï¼ŒSafariç­‰ï¼‰ï¼Œ<br>åº•å±‚ä¾èµ–è½»é‡çº§çš„çŸ¢é‡å›¾å½¢åº“ ZRenderï¼Œæä¾›ç›´è§‚ï¼Œäº¤äº’ä¸°å¯Œï¼Œå¯é«˜åº¦ä¸ªæ€§åŒ–å®šåˆ¶çš„æ•°æ®å¯è§†åŒ–å›¾è¡¨ã€‚</p>
</blockquote>
<h3 id="three-js-JavaScript-3D-library"><a href="#three-js-JavaScript-3D-library" class="headerlink" title="three.js JavaScript 3D library"></a><a href="https://github.com/mrdoob/three.js" target="_blank" rel="noopener">three.js JavaScript 3D library</a></h3><p><a href="https://github.com/mrdoob/three.js" target="_blank" rel="noopener"><img src="https://threejs.org/files/projects/infinitown.png" alt=" "></a></p>
<blockquote class="blockquote-center"><p>three.jsæ˜¯JavaScriptç¼–å†™çš„WebGLç¬¬ä¸‰æ–¹åº“ã€‚æä¾›äº†éå¸¸å¤šçš„3Dæ˜¾ç¤ºåŠŸèƒ½ã€‚T<br>hree.js æ˜¯ä¸€æ¬¾è¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„ 3D å¼•æ“ï¼Œ<br>ä½ å¯ä»¥ç”¨å®ƒåˆ›å»ºå„ç§ä¸‰ç»´åœºæ™¯ï¼ŒåŒ…æ‹¬äº†æ‘„å½±æœºã€å…‰å½±ã€æè´¨ç­‰å„ç§å¯¹è±¡ã€‚<br>ä½ å¯ä»¥åœ¨å®ƒçš„ä¸»é¡µä¸Šçœ‹åˆ°è®¸å¤šç²¾é‡‡çš„æ¼”ç¤ºã€‚</p>
</blockquote>
<h3 id="highcharts-HTML5äº¤äº’æ€§å›¾è¡¨åº“"><a href="#highcharts-HTML5äº¤äº’æ€§å›¾è¡¨åº“" class="headerlink" title="highcharts HTML5äº¤äº’æ€§å›¾è¡¨åº“"></a><a href="https://github.com/highcharts/highcharts" target="_blank" rel="noopener">highcharts HTML5äº¤äº’æ€§å›¾è¡¨åº“</a></h3><p><a href="https://github.com/highcharts/highcharts" target="_blank" rel="noopener"><img src="https://shop.highsoft.com/media/highsoft/highchart-in-laptop-960x552-optimized.png" alt=" "></a></p>
<blockquote class="blockquote-center"><p>å…¼å®¹ IE6+ã€å®Œç¾æ”¯æŒç§»åŠ¨ç«¯ã€å›¾è¡¨ç±»å‹ä¸°å¯Œã€æ–¹ä¾¿å¿«æ·çš„ HTML5 äº¤äº’æ€§å›¾è¡¨åº“</p>
</blockquote>
<h3 id="Leaflet-äº’åŠ¨åœ°å›¾"><a href="#Leaflet-äº’åŠ¨åœ°å›¾" class="headerlink" title="Leaflet äº’åŠ¨åœ°å›¾"></a><a href="https://github.com/Leaflet/Leaflet" target="_blank" rel="noopener">Leaflet äº’åŠ¨åœ°å›¾</a></h3><p><a href="https://github.com/Leaflet/Leaflet" target="_blank" rel="noopener"><img src="https://leafletjs.com/docs/images/logo.png" alt=" "></a></p>
<blockquote class="blockquote-center"><p>Leaflet æ˜¯ä¸€ä¸ªä¸ºå»ºè®¾ç§»åŠ¨è®¾å¤‡å‹å¥½çš„äº’åŠ¨åœ°å›¾,è€Œå¼€å‘çš„ç°ä»£çš„ã€å¼€æºçš„ JavaScript åº“</p>
</blockquote>
<h3 id="mxgraph"><a href="#mxgraph" class="headerlink" title="mxgraph "></a><a href="https://github.com/jgraph/mxgraph" target="_blank" rel="noopener">mxgraph </a></h3><p><a href="https://github.com/jgraph/mxgraph" target="_blank" rel="noopener"><img src="https://jgraph.github.io/mxgraph/docs/images/mxgraph_logo.gif" alt=" "></a></p>
<blockquote class="blockquote-center"><p>mxGraphå®¢æˆ·ç«¯åŠŸèƒ½æ˜¯ ä¸€ä¸ªJavaScriptåº“ï¼Œ<br>é€šè¿‡æµè§ˆå™¨ä¸æ‚¨çš„å›¾è¡¨æ˜¾ç¤ºå’Œäº¤äº’ï¼Œæä¾›é€šå¸¸æ‰€éœ€çš„æ‰€æœ‰åº”ç”¨ç¨‹åº åŠŸèƒ½ä»¥åŠæ–¹ä¾¿æ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½çš„é«˜æ‰©å±•æ€§ã€‚<br>mxGraphæ˜¯ä¸“ä¸ºä½¿ç”¨å®¢æˆ·ç«¯ - æœåŠ¡å™¨æ¶æ„è€Œè®¾è®¡ï¼Œ<br>å…¶ä¸­çš„JavaScriptåº“è´Ÿè´£ä¸æœåŠ¡å™¨é€šä¿¡äº¤æµä»¥åŠæ›´æ–°å›¾è¡¨çš„çŠ¶æ€ä¿¡æ¯</p>
</blockquote>]]></content>
      <categories>
        <category>æ¯å‘¨åˆ†äº«</category>
      </categories>
  </entry>
  <entry>
    <title>GitHubç²¾é€‰åˆ†äº«ç¬¬äºŒæœŸ</title>
    <url>/weekly-share/GitHub%E7%B2%BE%E9%80%89%E5%88%86%E4%BA%AB%E7%AC%AC%E4%BA%8C%E6%9C%9F/</url>
    <content><![CDATA[<p>è®°å½•è¿™å‘¨å€¼å¾—åˆ†äº«çš„äº‹ï¼Œä¸»è¦æ˜¯GitHubç²¾é€‰ å‰ç«¯ç›¸å…³~</p>
<h3 id="edex-uiï¼Œä¸€ä¸ªåˆ°éšå¤„è¿è¡Œçš„ç§‘å¹»æ¡Œé¢"><a href="#edex-uiï¼Œä¸€ä¸ªåˆ°éšå¤„è¿è¡Œçš„ç§‘å¹»æ¡Œé¢" class="headerlink" title="edex-uiï¼Œä¸€ä¸ªåˆ°éšå¤„è¿è¡Œçš„ç§‘å¹»æ¡Œé¢"></a><a href="https://github.com/GitSquared/edex-ui" target="_blank" rel="noopener">edex-uiï¼Œä¸€ä¸ªåˆ°éšå¤„è¿è¡Œçš„ç§‘å¹»æ¡Œé¢</a></h3><p><a href="https://github.com/GitSquared/edex-ui" target="_blank" rel="noopener"><img src="https://github.com/GitSquared/edex-ui/raw/master/media/screenshot_default.png"></a></p>
<blockquote class="blockquote-center"><p>eDEX-UI æ˜¯ä¸€ä¸ªå…¨å±æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œç±»ä¼¼äºç§‘å¹»ç”µè„‘ç•Œé¢ï¼Œ<br>å…¶çµæ„Ÿæ¥è‡ªäºDEX-UIå’ŒTRON Legacyç”µå½±ç‰¹æ•ˆã€‚<br>å®ƒåœ¨çœŸå®ç»ˆç«¯ä¸­è¿è¡Œæ‚¨é€‰æ‹©çš„shellï¼Œå¹¶æ˜¾ç¤ºæœ‰å…³ç³»ç»Ÿçš„å®æ—¶ä¿¡æ¯ã€‚</p>
</blockquote>
<a id="more"></a>
<h3 id="Howler-js-JavaScript-å¼€å‘è·¨å¹³å°éŸ³é¢‘ç›¸å…³çš„å¼€å‘"><a href="#Howler-js-JavaScript-å¼€å‘è·¨å¹³å°éŸ³é¢‘ç›¸å…³çš„å¼€å‘" class="headerlink" title="Howler.js - JavaScript å¼€å‘è·¨å¹³å°éŸ³é¢‘ç›¸å…³çš„å¼€å‘ "></a><a href="https://howlerjs.com/" target="_blank" rel="noopener">Howler.js - JavaScript å¼€å‘è·¨å¹³å°éŸ³é¢‘ç›¸å…³çš„å¼€å‘ </a></h3><p><a href="https://howlerjs.com/" target="_blank" rel="noopener"><img src="https://howlerjs.com/assets/images/logo-big.svg" width="50%"></a></p>
<blockquote class="blockquote-center"><p>Howler.jsæä¾›äº†ä¸€ä¸ªç°ä»£éŸ³é¢‘åº“ï¼Œæ”¯æŒWeb Audio APIå’ŒHTML5 Audioçš„å›é€€æœºåˆ¶ã€‚<br>è¯¥é¡¹ç›®è‡´åŠ›äºç®€åŒ–ä¸ä½¿ç”¨ JavaScript å¼€å‘è·¨å¹³å°éŸ³é¢‘ç›¸å…³çš„å¼€å‘å·¥ä½œã€‚<br>å‡ å®¶å¤§å‹æŠ€æœ¯å’Œåª’ä½“å…¬å¸æ­£åœ¨ä½¿ç”¨ Howler.jsï¼ŒåŒ…æ‹¬è°·æ­Œã€è¿ªå£«å°¼ã€Mozilla å’Œä¹é«˜ã€‚</p>
</blockquote>
<h3 id="NES-css-ä¸€æ¬¾åƒç´ é£æ ¼cssåº“"><a href="#NES-css-ä¸€æ¬¾åƒç´ é£æ ¼cssåº“" class="headerlink" title="NES.css - ä¸€æ¬¾åƒç´ é£æ ¼cssåº“"></a><a href="https://github.com/BcRikko/NES.css" target="_blank" rel="noopener">NES.css - ä¸€æ¬¾åƒç´ é£æ ¼cssåº“</a></h3><p><a href="https://github.com/BcRikko/NES.css" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/5305599/49061716-da649680-f254-11e8-9a89-d95a7407ec6a.png" alt></a></p>
<h3 id="33-js-concepts-æ¯ä¸ª-JavaScript-å·¥ç¨‹å¸ˆéƒ½åº”æ‡‚çš„33ä¸ªæ¦‚å¿µ"><a href="#33-js-concepts-æ¯ä¸ª-JavaScript-å·¥ç¨‹å¸ˆéƒ½åº”æ‡‚çš„33ä¸ªæ¦‚å¿µ" class="headerlink" title="33-js-concepts  æ¯ä¸ª JavaScript å·¥ç¨‹å¸ˆéƒ½åº”æ‡‚çš„33ä¸ªæ¦‚å¿µ"></a><a href="https://github.com/stephentian/33-js-concepts" target="_blank" rel="noopener">33-js-concepts  æ¯ä¸ª JavaScript å·¥ç¨‹å¸ˆéƒ½åº”æ‡‚çš„33ä¸ªæ¦‚å¿µ</a></h3><p><a href="https://github.com/stephentian/33-js-concepts" target="_blank" rel="noopener"><img src="https://github.com/stephentian/33-js-concepts/raw/master/33_js_concepts.jpg" alt></a></p>
<blockquote class="blockquote-center"><p>è¿™ä¸ªé¡¹ç›®æ˜¯ä¸ºäº†å¸®åŠ©å¼€å‘è€…æŒæ¡ JavaScript æ¦‚å¿µè€Œåˆ›ç«‹çš„ã€‚<br>åœ¨å­¦ä¹ ï¼ˆJavaScriptï¼‰ä¸­ï¼Œå¯ä»¥ä½œä¸ºä¸€ç¯‡æŒ‡å—ã€‚<br>ä» è°ƒç”¨å †æ ˆ / åŸå§‹ç±»å‹ åˆ° è®¾è®¡æ¨¡å¼/ä»£ç æ•´æ´ä¹‹é“</p>
</blockquote>
<h3 id="30-seconds-of-code-æœ‰è¶£çš„JSä»£ç ç‰‡æ®µé›†åˆ"><a href="#30-seconds-of-code-æœ‰è¶£çš„JSä»£ç ç‰‡æ®µé›†åˆ" class="headerlink" title="30-seconds-of-code æœ‰è¶£çš„JSä»£ç ç‰‡æ®µé›†åˆ"></a><a href="https://github.com/30-seconds/30-seconds-of-code" target="_blank" rel="noopener">30-seconds-of-code æœ‰è¶£çš„JSä»£ç ç‰‡æ®µé›†åˆ</a></h3><p><a href="https://github.com/30-seconds/30-seconds-of-code" target="_blank" rel="noopener"><img src="https://github.com/30-seconds/30-seconds-of-code/raw/master/logo.png" alt></a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ‘˜å–ä¸€æ®µ ï¼š Adapter-ary</span></span><br><span class="line"><span class="comment">//Creates a function that accepts up to n arguments, ignoring any additional arguments.</span></span><br><span class="line"><span class="comment">//Call the provided function, fn, with up to n arguments, </span></span><br><span class="line"><span class="comment">//using Array.prototype.slice(0,n) and the spread operator (...).</span></span><br><span class="line"><span class="keyword">const</span> ary = <span class="function">(<span class="params">fn, n</span>) =&gt;</span> (...args) =&gt; fn(...args.slice(<span class="number">0</span>, n));</span><br></pre></td></tr></table></figure>
<h3 id="scrcpyï¼Œ-Androidå±å¹•åˆ†äº«ä¸æ§åˆ¶"><a href="#scrcpyï¼Œ-Androidå±å¹•åˆ†äº«ä¸æ§åˆ¶" class="headerlink" title="scrcpyï¼Œ Androidå±å¹•åˆ†äº«ä¸æ§åˆ¶"></a><a href="https://github.com/Genymobile/scrcpy" target="_blank" rel="noopener">scrcpyï¼Œ Androidå±å¹•åˆ†äº«ä¸æ§åˆ¶</a></h3><p><a href="https://github.com/Genymobile/scrcpy" target="_blank" rel="noopener"><img src="https://github.com/Genymobile/scrcpy/raw/master/assets/screenshot-debian-600.jpg"></a></p>
<blockquote class="blockquote-center"><p>ç”± Genymobile æ¨å‡ºçš„å¯è·¨å¹³å°çš„ã€å¯è‡ªå®šä¹‰ç ç‡çš„ã€å¼€æºçš„å±å¹•å…±äº«å·¥å…·ã€‚<br>æä¾›äº†åœ¨ USB (æˆ– TCP/IP )ä¸Šè¿æ¥çš„ Android è®¾å¤‡çš„æ˜¾ç¤ºå’Œæ§åˆ¶ï¼Œ<br>é€‚ç”¨äº GNU/Linuxã€Windows å’Œ MacOS ã€‚</p>
</blockquote>
<h3 id="css-animation-101ï¼Œ-cssåŠ¨ç”»ç¤ºä¾‹"><a href="#css-animation-101ï¼Œ-cssåŠ¨ç”»ç¤ºä¾‹" class="headerlink" title="css-animation-101ï¼Œ cssåŠ¨ç”»ç¤ºä¾‹"></a><a href="https://github.com/cssanimation/css-animation-101" target="_blank" rel="noopener">css-animation-101ï¼Œ cssåŠ¨ç”»ç¤ºä¾‹</a></h3><p><a href="https://github.com/cssanimation/css-animation-101" target="_blank" rel="noopener"><img src="https://github.com/cssanimation/css-animation-101/raw/master/images/cover-small.png" alt></a></p>
<blockquote class="blockquote-center"><p>ä»é›¶å¼€å§‹ä»‹ç» CSS åŠ¨ç”»å¼€æºç”µå­ä¹¦<br><a href="https://cssanimation.rocks/" target="_blank" rel="noopener">https://cssanimation.rocks/</a></p>
</blockquote>
<h3 id="Dan-Abramov-ä¸ªäººåšå®¢"><a href="#Dan-Abramov-ä¸ªäººåšå®¢" class="headerlink" title="Dan Abramov ä¸ªäººåšå®¢"></a><a href="https://overreacted.io/" target="_blank" rel="noopener">Dan Abramov ä¸ªäººåšå®¢</a></h3><blockquote class="blockquote-center"><p>Dan Abramov å‚ä¸å¼€å‘è¿‡react, redux create-react-appçš„ä½œè€…ä¹‹ä¸€</p>
</blockquote>]]></content>
      <categories>
        <category>æ¯å‘¨åˆ†äº«</category>
      </categories>
  </entry>
  <entry>
    <title>GitHubç²¾é€‰åˆ†äº«ç¬¬å››æœŸ</title>
    <url>/weekly-share/GitHub%E7%B2%BE%E9%80%89%E5%88%86%E4%BA%AB%E7%AC%AC%E5%9B%9B%E6%9C%9F/</url>
    <content><![CDATA[<p>è®°å½•è¿™å‘¨çœ‹åˆ°å€¼å¾—åˆ†äº«çš„äº‹ï¼Œæœ¬æœŸå°±åˆ†äº«ç‚¹å›¾ç‰‡å‹ç¼©å·¥å…·ç±»å§~</p>
<p><img src="/res/weeklyshare/image-tool-stack.png" alt="image-tool-stack"></p>
<p>ä¸Šå›¾æ˜¯æˆ‘çš„å›¾ç‰‡å¤„ç†å·¥å…·æ ˆï¼ŒçŸ¢é‡åŸå‹ Sketchï¼Œä½å›¾ç¼–è¾‘ Pixelmatorï¼Œæœé›†ç®¡ç† Inboardï¼Œå‹ç¼©ä¼˜åŒ– JPEGminiã€ImageAlphaã€ImageOptimã€‚å‰å››ä¸ªæ˜¯ä»˜è´¹ Appï¼Œåä¸¤ä¸ªè‡ªç”±å¼€æºã€‚</p>
<p>æœ¬æ¬¡ä¸»è¦åˆ†äº«<strong>ImageOptim</strong> <strong>ImageAlpha</strong> <strong>ImageOptim-CLI</strong> å’Œ <strong>Squoosh</strong><br><a id="more"></a></p>
<h3 id="ImageOptim-JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨"><a href="#ImageOptim-JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨" class="headerlink" title="ImageOptim JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨"></a><a href="https://github.com/ImageOptim/ImageOptim" target="_blank" rel="noopener">ImageOptim JPGå›¾ç‰‡å‹ç¼©åˆ©å™¨</a></h3><blockquote class="blockquote-center"><p><a href="https://imageoptim.com/mac" target="_blank" rel="noopener">ImageOptimä¸‹è½½é“¾æ¥</a><br>å¦‚æœä½ æ˜¯Mac OS Xç”µè„‘çš„ä½¿ç”¨è€…ï¼Œä¹Ÿå¯è¯•è¯•çœ‹å¦å¤–è¿™ä¸€å¥—å›¾ç‰‡å‡è‚¥ã€æœ€ä½³åŒ–å·¥å…·ImageOptimï¼Œå®ƒå¯ä»¥æ”¯æŒPNGï¼ŒJPEGè·ŸGIFç­‰æ ¼å¼çš„å›¾æ¡£ï¼Œé€šè¿‡å†…ç½®çš„PNGOUTã€AdvPNGã€Pngcrushã€OptiPNGã€JpegOptimã€jpegrescanã€jpegtranä¸Gifsicleç­‰å›¾ç‰‡æœ€ä½³åŒ–å·¥å…·ï¼Œå¸®æˆ‘ä»¬å…¨è‡ªåŠ¨å‹ç¼©ã€ç¼©å‡å›¾ç‰‡çš„å¤§å°ã€‚</p>
<p>ImageOptimçš„ä½¿ç”¨æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠå›¾ç‰‡æ‹‰åˆ°ImageOptimçª—å£ä¸­ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰§è¡Œæœ€ä½³åŒ–ï¼Œç„¶åå°±æ²¡äº†ã€‚</p>
</blockquote>
<h3 id="ImageAlpha-PNGå›¾ç‰‡æœ‰æŸå‹ç¼©"><a href="#ImageAlpha-PNGå›¾ç‰‡æœ‰æŸå‹ç¼©" class="headerlink" title="ImageAlpha PNGå›¾ç‰‡æœ‰æŸå‹ç¼©"></a><a href="https://pngmini.com/" target="_blank" rel="noopener">ImageAlpha PNGå›¾ç‰‡æœ‰æŸå‹ç¼©</a></h3><blockquote class="blockquote-center"><p><a href="https://pngmini.com/" target="_blank" rel="noopener">ImageAlpha ä¸‹è½½é“¾æ¥</a><br>é€šè¿‡åº”ç”¨æœ‰æŸå‹ç¼©å’Œè½¬æ¢ä¸ºæ›´é«˜æ•ˆçš„PNG8 + alphaæ ¼å¼ï¼ŒmageAlphaå¤§å¤§å‡å°‘äº†24ä½PNGæ–‡ä»¶çš„æ–‡ä»¶å¤§å°ï¼ˆåŒ…æ‹¬alphaé€æ˜åº¦ï¼‰ã€‚è¿™äº›å›¾åƒä¸iOSï¼Œæ‰€æœ‰æµè§ˆå™¨å…¼å®¹ï¼Œç”šè‡³åœ¨IE6ä¸­é™çº§ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨æœ€æ–°çš„pngquantå’Œpngnq-s9ä»¥åŠAlphaé€šé“æ„ŸçŸ¥åå¤„ç†å™¨ï¼ŒImageAlphaå¯ä»¥åœ¨MacromediaAdobe Fireworksä¸­è·å¾—æ¯”ç±»ä¼¼åŠŸèƒ½æ›´å¥½çš„è´¨é‡ã€‚</p>
</blockquote>
<h3 id="ImageOptim-CLI-å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨"><a href="#ImageOptim-CLI-å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨" class="headerlink" title="ImageOptim-CLI å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨"></a><a href="https://github.com/JamieMason/ImageOptim-CLI" target="_blank" rel="noopener">ImageOptim-CLI å›¾ç‰‡å‹ç¼©å·¥å…·è°ƒç”¨</a></h3><p>ä»Šå¤©å¤„ç†çš„å›¾ç‰‡è¾ƒå¤šï¼Œæƒ³èƒ½ä¸èƒ½æœ‰ä¸ªè‡ªåŠ¨å·¥ä½œæµæ¥è§£æ”¾åŒæ‰‹ã€‚ä¸€æœï¼Œæ°å·§æ‰¾åˆ°äº† <a href="https://github.com/JamieMason/ImageOptim-CLI" target="_blank" rel="noopener">JamieMason/ImageOptim-CLI</a> è¿™ä¸ª macOS é¡¹ç›®ã€‚ä¸€å¥è¯æè¿°å°±æ˜¯ï¼Œå®ƒä¼šæ ¹æ®ä½ çš„æŒ‡å®šï¼Œé€‰æ‹©æ€§è°ƒç”¨ JPEGminiã€ImageAlphaã€ImageOptim ç­‰å·¥å…·ï¼Œæ¥å¤„ç†å›¾ç‰‡å‹ç¼©é—®é¢˜ã€‚å¼€å§‹æ•²ä¸€è¡Œå‘½ä»¤ï¼Œä¸­é—´è¿‡ç¨‹å…¨è‡ªåŠ¨ã€‚</p>
<p>79% TypeScript + 21% AppleScriptï¼Œåˆ†å‘ä¸ºå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ‰€ä»¥ä¸ä¾èµ– Node.jsï¼Œå¹¶ä¸”æ”¯æŒ Homebrew å®‰è£…ã€‚</p>
<p>ä½¿ç”¨ä¹Ÿéå¸¸æ–¹ä¾¿ï¼Œç»ˆç«¯è¾“å…¥ imageoptim â€“help å³å¯å¾—åˆ°è¯´æ˜ï¼Œåªéœ€æ³¨æ„ä¸‰ä¸ªäº‹é¡¹ï¼šç¬¬ä¸€ã€ç»ˆç«¯è¦å–å¾— Accessibility æƒé™ï¼›ç¬¬äºŒã€è°ƒç”¨çš„ App è¦è‡ªå·±å¦å¤–ä¸‹è½½å®‰è£…ï¼›ç¬¬ä¸‰ã€é¡¾åæ€ä¹‰ï¼Œå®ƒé»˜è®¤è°ƒç”¨ ImageOptimï¼Œå¦‚æœä¸ç”¨ï¼Œå¯é€šè¿‡ â€“no-imageoptim å‚æ•° disable å®ƒã€‚</p>
<p>æ”¯æŒçš„è°ƒç”¨çš„ 3 ä¸ª App å¦‚ä¸‹ï¼ŒJPEGmini Lite å…è´¹ï¼Œæ ‡å‡†å’Œ Pro å‡éœ€ä»˜è´¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Supported Apps:</span><br><span class="line"></span><br><span class="line">  ImageAlpha: https://pngmini.com</span><br><span class="line">  ImageOptim: https://imageoptim.com</span><br><span class="line">  JPEGmini Lite: https://itunes.apple.com/us/app/jpegmini-lite/id525742250</span><br><span class="line">  JPEGmini Pro: https://itunes.apple.com/us/app/jpegmini-pro/id887163276</span><br><span class="line">  JPEGmini: https://itunes.apple.com/us/app/jpegmini/id498944723</span><br></pre></td></tr></table></figure>
<p>å¦‚éœ€ç»„åˆå…¶ä»–å·¥å…·ï¼Œæ·»åŠ å¯¹åº”å‚æ•°å³å¯ï¼Œæ¯”å¦‚æ·»åŠ  â€“jpegmini å‚æ•°è°ƒç”¨ JPEGminiï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Examples:</span><br><span class="line"></span><br><span class="line">  # Run ImageOptim.app over every image in current directory</span><br><span class="line">  imageoptim</span><br><span class="line"></span><br><span class="line">  # Run ImageAlpha.app and ImageOptim.app over every PNG in current directory</span><br><span class="line">  imageoptim --imagealpha &apos;**/*.png&apos;</span><br><span class="line"></span><br><span class="line">  # Run JPEGmini.app and ImageOptim.app over every JPG in current directory</span><br><span class="line">  imageoptim --jpegmini &apos;**/*.jpg&apos; &apos;**/*.jpeg&apos;</span><br><span class="line"></span><br><span class="line">  # Run JPEGmini.app over every JPG in current directory</span><br><span class="line">  imageoptim --jpegmini --no-imageoptim &apos;**/*.jpg&apos; &apos;**/*.jpeg&apos;</span><br><span class="line"></span><br><span class="line">  # Run ImageOptim.app over every image in a specific directory</span><br><span class="line">  imageoptim &apos;~/Desktop&apos;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œè¿™å‡ ä¸ªå·¥å…·æ˜¯å•å¹²è¿˜æ˜¯ç»„åˆå¥½å‘¢ï¼Œå“ªä¸ªæ­é…å‹ç¼©å’Œè´¨é‡æœ€åˆç†å‘¢ï¼Ÿé’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼ŒImageOptim-CLI è´´å¿ƒåœ°ç»™å‡ºäº† GIFã€JPEGã€PNG å„ä¸ªæ ¼å¼å„ä¸ªå·¥å…·åŠç»„åˆçš„<a href="https://jamiemason.github.io/ImageOptim-CLI/comparison/all/photoshop/desc/" target="_blank" rel="noopener">å‹ç¼©æ•ˆæœå¯¹æ¯”</a></p>
<p><img src="/res/weeklyshare/imageoptim-cli-comparison.png" alt="imageoptim-cli-comparison"></p>
<p>å…ˆçœ‹ JPEG é¡¹ç›®ï¼Œæœä¸å…¶ç„¶ï¼ŒJPEGmini &amp; ImageOptim ç»„åˆå‡ æ— æ•Œæ‰‹ï¼Œåªåœ¨è“å¤©ç™½äº‘å’Œ bril äººåƒä¸Šè¾“ç»™äº† Krakenï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæˆç»©ä¸»è¦æ˜¯ JPEGmini çš„åŠŸåŠ³ã€‚</p>
<p>å†çœ‹ PNG é¡¹ç›®ï¼Œæ‚¬å¿µåªåœ¨ ImageOptim å•å¹²ä»¥åŠä¸ ImageOptim æ­é…ä¸¤ä¸ªæ–¹æ¡ˆä¹‹é—´ã€‚è€ƒè™‘åˆ° 24 ä½è‰²çš„å¤©é™…çº¿ã€é›€æ–‘è„¸ã€è“å¤©ç™½äº‘ç­‰å›¾ç‰‡ä¸Šï¼ŒImageOptim å•å¹²å¼±åŠ¿æ˜æ˜¾ï¼Œè¿˜æ˜¯å»ºè®®äºŒè€…æ— è„‘æ­é…ã€‚ImageAlphaåˆ™åˆæ˜¯æ˜æ˜¾ã€‚</p>
<p>ç»¼åˆä»¥ä¸Šä¸¤ä¸ªé¡¹ç›®æ¥çœ‹ï¼Œå¦‚æœèƒ½æ¥å—è¾ƒé«˜çš„å›¾ç‰‡è´¨é‡æŸè€—ï¼ˆæ³¨æ„è¡¨æ ¼ä¸­æ— åº•è‰²çš„çº¢å­—ï¼‰ï¼ŒKraken ä¹Ÿæ˜¯éå¸¸æœ‰ç«äº‰åŠ›çš„å•ä¸€ä¼˜åŒ–å·¥å…·ã€‚</p>
<h3 id="Squoosh-æ˜¯-Google-æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·"><a href="#Squoosh-æ˜¯-Google-æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·" class="headerlink" title="Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·"></a><a href="https://github.com/GoogleChromeLabs/squoosh" target="_blank" rel="noopener">Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·</a></h3><blockquote class="blockquote-center"><p><a href="https://squoosh.app/" target="_blank" rel="noopener">Squooshåœ¨çº¿é“¾æ¥</a><br>Squoosh æ˜¯ Google æ¨å‡ºçš„ä¸€æ¬¾åœ¨çº¿ç®€å•é«˜æ•ˆçš„å›¾ç‰‡å‹ç¼©å·¥å…·ï¼Œæ”¯æŒ JPGã€PNG å’Œ WebP æ ¼å¼ï¼Œå¯è®©æ‚¨æ·±å…¥äº†è§£å„ç§å›¾åƒå‹ç¼©å™¨æä¾›çš„é«˜çº§é€‰é¡¹</p>
</blockquote>]]></content>
      <categories>
        <category>æ¯å‘¨åˆ†äº«</category>
      </categories>
  </entry>
  <entry>
    <title>InjectionIII ä½¿ç”¨åŸç†ä»‹ç»</title>
    <url>/essay/injectIII/</url>
    <content><![CDATA[<blockquote>
<p>iOS åŸç”Ÿä»£ç çš„ç¼–è¯‘è°ƒè¯•ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€éåˆä¸€éåœ°ç¼–è¯‘é‡å¯ APPæ¥è¿›è¡Œçš„ã€‚æ‰€ä»¥é¡¹ç›®ä»£ç é‡è¶Šå¤§ï¼Œç¼–è¯‘æ—¶é—´å°±è¶Šé•¿ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥å°†éƒ¨åˆ†ä»£ç å…ˆç¼–è¯‘æˆäºŒè¿›åˆ¶é›†æˆåˆ°å·¥ç¨‹é‡Œï¼Œæ¥é¿å…æ¯æ¬¡éƒ½å…¨é‡ç¼–è¯‘æ¥åŠ å¿«ç¼–è¯‘é€Ÿåº¦ï¼Œä½†å³ä½¿è¿™æ ·ï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½è¿˜æ˜¯éœ€è¦é‡å¯Appï¼Œéœ€è¦å†èµ°ä¸€éè°ƒè¯•æµç¨‹ã€‚</p>
</blockquote>
<p>å¹¸è¿çš„æ˜¯ï¼ŒJohn Holdsworth å¼€å‘äº†ä¸€ä¸ªå«åš InjectionIII çš„å·¥å…·å¯ä»¥åŠ¨æ€åœ°å°† Swift æˆ– Objective-C çš„ä»£ç åœ¨å·²è¿è¡Œçš„ç¨‹åºä¸­æ‰§è¡Œï¼Œä»¥åŠ å¿«è°ƒè¯•é€Ÿåº¦ï¼ŒåŒæ—¶ä¿è¯ç¨‹åºä¸ç”¨é‡å¯ã€‚</p>
<a id="more"></a>
<h3 id="InjectionIIIä¸‹è½½ä½¿ç”¨"><a href="#InjectionIIIä¸‹è½½ä½¿ç”¨" class="headerlink" title="InjectionIIIä¸‹è½½ä½¿ç”¨"></a>InjectionIIIä¸‹è½½ä½¿ç”¨</h3><h4 id="ä¸‹è½½InjectionIII"><a href="#ä¸‹è½½InjectionIII" class="headerlink" title="ä¸‹è½½InjectionIII"></a>ä¸‹è½½InjectionIII</h4><p>å¦‚æœä»…ç”¨äºä½¿ç”¨çš„è¯åœ¨mac appStoreä¸‹è½½å°±å¯ä»¥äº†ï¼š</p>
<p><img src="/res/InjectionIII/1.png" width="50%"></p>
<h4 id="åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç "><a href="#åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç " class="headerlink" title="åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç "></a>åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»£ç </h4><p>åœ¨ - (BOOL)application:(UIApplication <em>)application willFinishLaunchingWithOptions:(NSDictionary </em>)launchOptions æ–¹æ³•é‡Œæ·»åŠ å¦‚ä¸‹ä»£ç </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    [[<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@"/Applications/InjectionIII.app/Contents/Resources/iOSInjection.bundle"</span>] load;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//æˆåŠŸæ—¶æ§åˆ¶å°ä¼šæ‰“å°ï¼š</span><br><span class="line">ğŸ’‰ Injection connected ğŸ‘</span><br><span class="line"></span><br><span class="line">//æ²¡æœ‰è¿è¡ŒInjectionIII æ§åˆ¶å°ä¼šæ‰“å°</span><br><span class="line">ğŸ’‰ Injection loaded but could not connect. Is InjectionIII.app running?</span><br></pre></td></tr></table></figure>
<h4 id="è¿è¡ŒInjectionIII-å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•"><a href="#è¿è¡ŒInjectionIII-å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•" class="headerlink" title="è¿è¡ŒInjectionIII å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•"></a>è¿è¡ŒInjectionIII å¹¶é€‰æ‹©é¡¹ç›®ç›®å½•</h4><p>ä½¿ç”¨çš„æ—¶å€™ä¼šè®©ä½ é€‰æ‹©é¡¹ç›®ç›®å½•ï¼ŒInjectionIII å°±æ˜¯ç›‘æ§çš„è¿™ä¸ªç›®å½•ï¼Œé‡Œé¢æ–‡ä»¶å˜åŠ¨ä¼šæœ‰é€šçŸ¥ã€‚</p>
<p><img src="/res/InjectionIII/2.png" width="50%"></p>
<h4 id="ä½¿ç”¨InjectionIII-å¹¶æµ‹è¯•å‡ ç§åœºæ™¯"><a href="#ä½¿ç”¨InjectionIII-å¹¶æµ‹è¯•å‡ ç§åœºæ™¯" class="headerlink" title="ä½¿ç”¨InjectionIII å¹¶æµ‹è¯•å‡ ç§åœºæ™¯:"></a>ä½¿ç”¨InjectionIII å¹¶æµ‹è¯•å‡ ç§åœºæ™¯:</h4><p>ä½ å¯ä»¥åœ¨åœ¨å¯¹åº”çš„VCæ§åˆ¶å™¨ä¸­å®ç° - (void)injected ç¼–å†™ä»£ç ï¼Œå†™å®Œåï¼Œcommand+s ä¿å­˜åˆ‡æ‰§è¡Œä»£ç ï¼ŒInjjectionå°±å¼€å§‹ç¼–è¯‘ä¿®æ”¹è¿‡çš„æ–‡ä»¶ä¸ºåŠ¨æ€åº“ï¼Œç„¶åæˆ‘ä»¬åœ¨Injectedæ–¹æ³•å†…åšUI reloadå·¥ä½œï¼Œå³å¯é‡ç»˜UIã€‚</p>
<p>ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹ä½ æƒ³æµ‹è¯•çš„VCä»£ç ï¼Œç„¶åé€€å‡ºé‡è¿›å³å¯é‡è½½VCã€‚</p>
<p>æµ‹è¯•ä¸€ä¸‹å››ç§åœºæ™¯ï¼š </p>
<ul>
<li>ä¿®æ”¹æ–¹æ³•</li>
<li>æ–°å¢æ–¹æ³•</li>
<li>æ–°å¢å±æ€§</li>
<li>æ–°å¢ç±»</li>
</ul>
<p>å…¶ä¸­ ä¿®æ”¹æ–¹æ³•/æ–°å¢æ–¹æ³•/æ–°å¢ç±» éƒ½å¯ä»¥åŠ¨æ€ä¿®æ”¹</p>
<p><img src="/res/InjectionIII/3.gif" alt></p>
<p>è€Œå½“åŠ¨æ€æ·»åŠ å±æ€§æ—¶åˆ™ä¼šæŠ¥é”™</p>
<p><img src="/res/InjectionIII/4.png" width="50%"></p>
<p>æˆ‘ä»¬å¾ˆè‡ªç„¶çš„æƒ³åˆ°å› ä¸ºä¸èƒ½å‘å·²æœ‰ç±»åŠ¨æ€æ·»åŠ å±æ€§ï¼Œä½†æ˜¯InjectionIIIåˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®æ¥çœ‹çœ‹InjectionIIIçš„åŸç†</p>
<blockquote>
<p>æ²¡æœ‰çœ‹åˆ°æ•ˆæœçš„é—®é¢˜?</p>
</blockquote>
<ul>
<li>ç¡®è®¤ Injection ç›‘å¬çš„ç›®å½•å’Œ Xcode é¡¹ç›®ç›®å½•æ˜¯å¦ä¸€è‡´ã€‚</li>
<li>å†çœ‹ä¸‹æœ‰æ²¡æœ‰ä¿å­˜æˆåŠŸï¼Œä¹Ÿå°±æ˜¯é’ˆç­’çš„é¢œè‰²ç”±ç»¿è‰²å˜æˆçº¢è‰²ã€‚</li>
<li>ç¡®è®¤ä¸Šé¢é‚£å¥è¯æœ‰æ²¡æœ‰æ‰“å°ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰æ²¡æœ‰çœŸçš„è¿è¡Œè¿™ä¸ªå·¥å…·ã€‚</li>
<li>å¦‚æœä¿®æ”¹çš„æ˜¯ cell / item ä¸Šé¢çš„å†…å®¹ï¼Œéœ€è¦ä¸Šä¸‹æ»šåŠ¨æ‰èƒ½çœ‹åˆ°æ•ˆæœã€‚</li>
<li>å¦‚æœä¿®æ”¹çš„æ˜¯ä¸€ä¸ªæ™®é€šé¡µé¢çš„å†…å®¹ï¼Œæœ€å¥½æ˜¯é€€å‡ºè¿™ä¸ªé¡µé¢ï¼Œå†è¿›å…¥è¿™ä¸ªé¡µé¢ã€‚</li>
<li>ç¡®è®¤ Xcode çš„ç‰ˆæœ¬å’Œå¯åŠ¨æ—¶æ·»åŠ çš„ä»£ç æ˜¯å¦åŒ¹é…ï¼ŒXcode10 éœ€è¦ iOSInjection10.bundle æ‰èƒ½ç”Ÿæ•ˆ</li>
</ul>
<h3 id="InjectionIIIåŸç†"><a href="#InjectionIIIåŸç†" class="headerlink" title="InjectionIIIåŸç†"></a>InjectionIIIåŸç†</h3><h4 id="å¤§è‡´æµç¨‹æ¢³ç†"><a href="#å¤§è‡´æµç¨‹æ¢³ç†" class="headerlink" title="å¤§è‡´æµç¨‹æ¢³ç†"></a>å¤§è‡´æµç¨‹æ¢³ç†</h4><p><img src="/res/InjectionIII/8.png" alt></p>
<ul>
<li>InjectionIII åˆ†ä¸ºserver å’Œ clientéƒ¨åˆ†ï¼Œ</li>
<li>clientéƒ¨åˆ†åœ¨ä½ çš„é¡¹ç›®å¯åŠ¨çš„æ—¶å€™ä¼šä½œä¸º bundle load è¿›å»ï¼Œserveréƒ¨åˆ†åœ¨Mac Appé‚£è¾¹ï¼Œserver å’Œ client éƒ½ä¼šåœ¨åå°å‘é€å’Œç›‘å¬ Socket æ¶ˆæ¯ï¼Œå®ç°é€»è¾‘åˆ†åˆ«åœ¨ InjectionServer.mm å’Œ InjectionClient.mm é‡Œçš„ runInBackground æ–¹æ³•é‡Œé¢ã€‚</li>
<li>InjectionIII ä¼šç›‘å¬æºä»£ç æ–‡ä»¶çš„å˜åŒ–ï¼Œå¦‚æœæ–‡ä»¶è¢«æ”¹åŠ¨äº†ï¼Œserver å°±ä¼šé€šè¿‡ Socket é€šçŸ¥ client è¿›è¡Œ rebuildClass é‡æ–°å¯¹è¯¥æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼Œæ‰“åŒ…æˆåŠ¨æ€åº“ï¼Œä¹Ÿå°±æ˜¯ .dylib æ–‡ä»¶ã€‚</li>
<li>ç„¶åé€šè¿‡ dlopen æŠŠåŠ¨æ€åº“æ–‡ä»¶è½½å…¥è¿è¡Œçš„ App é‡Œï¼Œæ¥ä¸‹æ¥ dlsym ä¼šå¾—åˆ°åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ï¼Œç„¶åå°±å¯ä»¥å¤„ç†ç±»çš„æ›¿æ¢å·¥ä½œã€‚</li>
<li>å½“ç±»çš„æ–¹æ³•è¢«æ›¿æ¢åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹é‡æ–°ç»˜åˆ¶ç•Œé¢äº†ã€‚æ•´ä¸ªè¿‡ç¨‹æ— éœ€é‡æ–°ç¼–è¯‘å’Œé‡è½½ Appï¼Œä½¿ç”¨åŠ¨æ€åº“æ–¹å¼æé€Ÿè°ƒè¯•çš„ç›®çš„å°±è¾¾æˆäº†ã€‚</li>
</ul>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæ¨¡æ‹Ÿå™¨ä¸‹iOSå¯åŠ è½½Macä»»æ„æ–‡ä»¶ï¼Œè€ŒçœŸæœºè®¾å¤‡å¦‚æœåŠ è½½åŠ¨æ€åº“ï¼Œåªèƒ½åŠ è½½App.contentç›®å½•ä¸‹çš„ï¼Œæ¢å¥è¯è¯´ï¼Œè¿™ä¸ªå·¥å…·åªæ”¯æŒæ¨¡æ‹Ÿå™¨ã€‚</p>
<h4 id="ç¼–è¯‘InjectionIIIå·¥ç¨‹"><a href="#ç¼–è¯‘InjectionIIIå·¥ç¨‹" class="headerlink" title="ç¼–è¯‘InjectionIIIå·¥ç¨‹"></a>ç¼–è¯‘InjectionIIIå·¥ç¨‹</h4><p>è¦äº†è§£ä¸€ä¸ªå·¥å…·ï¼Œæœ€å¥½çš„æ–¹å¼å½“ç„¶ç›´æ¥çœ‹æºç äº†ã€‚InjectionIII çš„æºä»£ç é“¾æ¥å¦‚ä¸‹ï¼š<a href="https://github.com/johnno1962/InjectionIII" target="_blank" rel="noopener">https://github.com/johnno1962/InjectionIII</a>ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥å¯¹ç€æºç åˆ†æã€‚</p>
<p><img src="/res/InjectionIII/5.png" width="50%"></p>
<p>ä¸‹è½½/clone InjectionIII ä¸»å·¥ç¨‹ä»£ç ï¼Œå­å·¥ç¨‹ remote SwiftTrace XprobePlugin ä¹Ÿä¸€å¹¶ç‚¹è¿›é“¾æ¥ä¸‹è½½åˆ°å¯¹åº”ç›®å½•ã€‚</p>
<p>ç„¶åè§£å†³ä¸‹è¯ä¹¦é—®é¢˜ ï¼Œç›´æ¥å‹¾é€‰ Automatically manage signingï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸‹å›¢é˜Ÿï¼Œæ³¨æ„ InjectionIII å’Œ InjectionBundle ä¸¤ä¸ª target éƒ½è¦é€‰æ‹©å¥½ã€‚å°±å¯ä»¥æ„‰å¿«çš„ç¼–è¯‘äº†~</p>
<p>æœ€åè¯´ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦ç”¨æºç åˆ†æï¼Œå½“ç„¶è¦å°†æºç ç¼–è¯‘èµ·æ¥ï¼Œæ‰“æ–­ç‚¹çœ‹æµç¨‹ã€‚è¿™æ ·çš„è¯å°±åœ¨ willFinishLaunchingWithOptions é‡Œé¢åŠ è½½çš„è·¯å¾„å°±è¦ç›¸åº”ä¿®æ”¹äº†ï¼Œæˆ‘è¿™è¾¹æ˜¯è¿™æ ·çš„ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#if DEBUG</span></span><br><span class="line">    [[<span class="built_in">NSBundle</span> bundleWithPath:<span class="string">@"/Users/suntongsheng/Library/Developer/Xcode/DerivedData/InjectionIII-aornltecfreqqwezgayglgjnnckg/Build/Products/Debug/InjectionIII.app/Contents/Resources/iOSInjection.bundle"</span>] load];</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure>
<h4 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h4><h5 id="ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥"><a href="#ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥" class="headerlink" title="ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥"></a>ä¸€ã€åˆå§‹åŒ–Serverå’ŒClientå¹¶é€šè¿‡Socketå»ºç«‹é“¾æ¥</h5><p><code>Serverç«¯ å³æ˜¯InjectionIIIå·¥ç¨‹ä¸­çš„Target-InjectionIII</code> åˆå§‹åŒ–è°ƒç”¨ SimpleSocket çš„ startServer æ–¹æ³•å¹¶ä¼ å…¥ç«¯å£å· åœ¨åå°è¿è¡Œå¼€å¯æœåŠ¡ç«¯socket æœåŠ¡ç”¨äºå’Œå®¢æˆ·ç«¯çš„é€šè®¯ï¼Œå¹¶è¿è¡Œ InjectionServer ç±»çš„ runInBackground æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå¼¹å‡ºé€‰æ‹©é¡¹ç›®ç›®å½•å¯¹è¯æ¡†ï¼Œå¦‚æœä¹‹å‰é€‰æ‹©è¿‡çš„è¯å°±ä¸ä¼šå¼¹å‡ºã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">+ (void)startServer:(<span class="type">NSString</span> *)address &#123;</span><br><span class="line">    <span class="type">NSLog</span>(@<span class="string">" %s %p "</span>,__func__,<span class="keyword">self</span>);</span><br><span class="line">    [<span class="keyword">self</span> performSelectorInBackground:@selector(runServer:) withObject:address];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)runServer:(<span class="type">NSString</span> *)address &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">serverAddr</span>;</span></span><br><span class="line"><span class="class">    [<span class="title">self</span> <span class="title">parseV4Address</span>:<span class="title">address</span> <span class="title">into</span>:&amp;<span class="title">serverAddr</span>];</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">serverSocket</span> = [<span class="title">self</span> <span class="title">newSocket</span>:<span class="title">serverAddr</span>.<span class="title">ss_family</span>];</span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">serverSocket</span> &lt; 0)</span></span><br><span class="line"><span class="class">        <span class="title">return</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">if</span> (<span class="title">bind</span>(<span class="title">serverSocket</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">serverAddr</span>, <span class="title">serverAddr</span>.<span class="title">ss_len</span>) &lt; 0)</span></span><br><span class="line"><span class="class">        [<span class="title">self</span> <span class="title">error</span>:@"<span class="title">Could</span> <span class="title">not</span> <span class="title">bind</span> <span class="title">service</span> <span class="title">socket</span>: %<span class="title">s</span>"];</span></span><br><span class="line"><span class="class">    <span class="title">else</span> <span class="title">if</span> (<span class="title">listen</span>(<span class="title">serverSocket</span>, 5) &lt; 0)</span></span><br><span class="line"><span class="class">        [<span class="title">self</span> <span class="title">error</span>:@"<span class="title">Service</span> <span class="title">socket</span> <span class="title">would</span> <span class="title">not</span> <span class="title">listen</span>: %<span class="title">s</span>"];</span></span><br><span class="line"><span class="class">    <span class="title">else</span></span></span><br><span class="line"><span class="class">        <span class="title">while</span> (<span class="title">TRUE</span>) </span>&#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class">            <span class="title">socklen_t</span> <span class="title">addrLen</span> = <span class="title">sizeof</span> <span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">            <span class="title">int</span> <span class="title">clientSocket</span> = <span class="title">accept</span>(<span class="title">serverSocket</span>, (<span class="title">struct</span> <span class="title">sockaddr</span> *)&amp;<span class="title">clientAddr</span>, &amp;<span class="title">addrLen</span>);</span></span><br><span class="line"><span class="class">            <span class="title">if</span> (<span class="title">clientSocket</span> &gt; 0) </span>&#123;</span><br><span class="line">                @autoreleasepool &#123;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">v4Addr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)&amp;<span class="title">clientAddr</span>;</span></span><br><span class="line"><span class="class">                    <span class="title">NSLog</span>(@"<span class="title">Connection</span> <span class="title">from</span> %<span class="title">s</span>:%<span class="title">d</span>\<span class="title">n</span>",</span></span><br><span class="line"><span class="class">                          <span class="title">inet_ntoa</span>(<span class="title">v4Addr</span>-&gt;<span class="title">sin_addr</span>), <span class="title">ntohs</span>(<span class="title">v4Addr</span>-&gt;<span class="title">sin_port</span>));</span></span><br><span class="line"><span class="class">                    [[[<span class="title">self</span> <span class="title">alloc</span>] <span class="title">initSocket</span>:<span class="title">clientSocket</span>] <span class="title">run</span>];</span></span><br><span class="line"><span class="class">                &#125;</span></span><br><span class="line"><span class="class">            &#125;</span></span><br><span class="line"><span class="class">            <span class="title">else</span></span></span><br><span class="line"><span class="class">                [<span class="title">NSThread</span> <span class="title">sleepForTimeInterval</span>:.5];</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>Clientç«¯ å³æ˜¯InjectionIIIå·¥ç¨‹ä¸­çš„Target-InjectionBundle</code> ä¼šåœ¨æˆ‘ä»¬çš„demoå·¥ç¨‹ä¸­åŠ è½½ï¼Œé¡¹ç›®å¯åŠ¨ä»¥åå¯ä»¥åœ¨æ§åˆ¶å°æ‰§è¡Œ image list -o -f æŸ¥çœ‹åŠ è½½çš„åŠ¨æ€åº“ï¼Œå¯ä»¥çœ‹åˆ° iOSInjection.bundle ç¡®å®å·²ç»ä»¥åŠ¨æ€åº“çš„å½¢å¼åŠ è½½è¿›æ¥äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">image list -o -f</span><br><span class="line"></span><br><span class="line">[377] 0x0000000102b13000 /Users/suntongsheng/Library/Developer/Xcode/DerivedData/InjectionIII-aornltecfreqqwezgayglgjnnckg/Build/Products/Debug/InjectionIII.app/Contents/Resources/iOSInjection.bundle/iOSInjection</span><br></pre></td></tr></table></figure>
<p>å…¶åˆå§‹åŒ–åœ¨InjectionClient ç±»çš„ +load æ–¹æ³•ã€‚åœ¨ InjectionClient ç±»çš„ +load æ–¹æ³•é‡Œä¼šè°ƒç”¨å…¶ connectTo æ–¹æ³•ä¼ å…¥å¯¹åº”çš„ç«¯å£å·æ¥è¿æ¥æœåŠ¡ç«¯çš„ socket æœåŠ¡ç”¨äºé€šè®¯ï¼Œå¹¶è¿è¡Œå…¶runInBackground æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">+ (void)load &#123;</span><br><span class="line">    <span class="type">NSLog</span>(@<span class="string">" %s %p "</span>,__func__,<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">// connect to InjectionIII.app using socket</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="type">InjectionClient</span> *client = [<span class="keyword">self</span> connectTo:<span class="type">INJECTION_ADDRESS</span>])</span><br><span class="line">        [client run];</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        printf(<span class="string">"ğŸ’‰ Injection loaded but could not connect. Is InjectionIII.app running?\n"</span>);</span><br><span class="line">#ifndef __IPHONE_OS_VERSION_MIN_REQUIRED</span><br><span class="line">        printf(<span class="string">"âš ï¸ For a macOS app you need to turn off the sandbox to connect. âš ï¸\n"</span>);</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InjectionIII è¿è¡Œä»¥åä¼šåœ¨åå°ç›‘å¬ socket æ¶ˆæ¯ï¼Œæ¯éš”0.5ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰å®¢æˆ·ç«¯è¿æ¥è¿‡æ¥ï¼Œç­‰æˆ‘ä»¬app å¯åŠ¨ä»¥ååŠ è½½äº† iOSInjection.bundleï¼Œå°±ä¼šå¯åŠ¨ client è·Ÿ server å»ºç«‹è¿æ¥ï¼Œç„¶åå°±å¯ä»¥å‘é€æ¶ˆæ¯äº†ã€‚</p>
<h5 id="äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹"><a href="#äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹" class="headerlink" title="äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹"></a>äºŒã€ç›‘å¬æ–‡ä»¶ä¿®æ”¹</h5><p>å½“æˆ‘ä»¬åœ¨è°ƒè¯•å·¥ç¨‹ä¸­ä¿®æ”¹äº†ä»£ç å¹¶ä¿å­˜åï¼ŒFileWatcher ä¼šç«‹å³æ”¶åˆ°æ–‡ä»¶æ”¹å˜çš„å›è°ƒï¼ŒFileWatcher ä½¿ç”¨ Mac OS ä¸Šçš„ FSEvents æ¡†æ¶å®ç°ï¼Œ<code>FileWatcher</code> ä¸­é€šè¿‡ <code>filesChanged</code> å‘Šè¯‰å›è°ƒæ–¹æ³•å³<code>InjectionServer</code>ä¸­çš„<code>fileChangeHandler</code>æ–¹æ³•</p>
<p><img src="/res/InjectionIII/6.png" alt></p>
<p>åœ¨<code>InjectionServer</code>æ–¹æ³•ä¸­ä¼šåˆ¤æ–­æ˜¯å¦ä¸ºè‡ªåŠ¨æ³¨å…¥ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œ injectPending æ–¹æ³•ï¼Œé€šè¿‡ socket å¯¹å®¢æˆ·ç«¯ä¸‹å‘InjectionInject ä»£ç æ³¨å…¥å‘½ä»¤å¹¶ä¼ å…¥éœ€è¦ä»£ç æ³¨å…¥çš„æ–‡ä»¶åç‰©ç†è·¯å¾„ã€‚å¦‚æœä¸æ˜¯è‡ªåŠ¨æ³¨å…¥é‚£ä¹ˆå°±åœ¨æ§åˆ¶å°è¾“å‡ºâ€œxxæ–‡ä»¶å·²ä¿å­˜ï¼Œè¾“å…¥ctrl-=è¿›è¡Œæ³¨å…¥â€å‘Šè¯‰æˆ‘ä»¬æ‰‹åŠ¨æ³¨å…¥çš„è§¦å‘æ–¹å¼ã€‚</p>
<h5 id="ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å"><a href="#ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å" class="headerlink" title="ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å"></a>ä¸‰ã€é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾å</h5><p>æ–‡ä»¶ä¿®æ”¹åè‹¥æ˜¯è‡ªåŠ¨æ³¨å…¥<code>injectPending</code>æ–¹æ³•ä¼šè°ƒç”¨ <code>recompileAndInject</code>æ–¹æ³•å®é™…ä¸Šä¼šè°ƒç”¨ SwiftEval å•ä¾‹çš„ rebuildClass æ–¹æ³•æ¥è¿›è¡Œä¿®æ”¹æ–‡ä»¶çš„é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾åï¼š</p>
<p>é¦–å…ˆæ ¹æ®ä¿®æ”¹çš„ç±»æ–‡ä»¶ååœ¨ Injection App çš„æ²™ç›’è·¯å¾„ç”Ÿæˆå¯¹åº”çš„ç¼–è¯‘è„šæœ¬ï¼Œè„šæœ¬å‘½åä¸ºeval+æ•°å­—ï¼Œæ•°å­—ä»¥100ä¸ºåŸºæ•°ï¼Œæ¯æ¬¡é€’å¢1ã€‚è„šæœ¬ç”Ÿæˆè°ƒç”¨æ–¹æ³•å¦‚ä¸‹å›¾ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">injectionNumber += <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> tmpfile = <span class="type">URL</span>(fileURLWithPath: tmpDir)</span><br><span class="line">    .appendingPathComponent(<span class="string">"eval\(injectionNumber)"</span>).path</span><br><span class="line"><span class="keyword">let</span> logfile = <span class="string">"\(tmpfile).log"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">guard</span> <span class="keyword">var</span> (compileCommand, sourceFile) = <span class="keyword">try</span> compileByClass[classNameOrFile] ??</span><br><span class="line">    findCompileCommand(logsDir: logsDir, classNameOrFile: classNameOrFile, tmpfile: tmpfile) ??</span><br><span class="line">    <span class="type">SwiftEval</span>.longTermCache[classNameOrFile].flatMap(&#123; ($<span class="number">0</span> <span class="keyword">as</span>! <span class="type">String</span>, classNameOrFile) &#125;) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> evalError(<span class="string">"""</span></span><br><span class="line"><span class="string">        Could not locate compile command for \(classNameOrFile).</span></span><br><span class="line"><span class="string">        This could be due to one of the following:</span></span><br><span class="line"><span class="string">        1. Injection does not work with Whole Module Optimization.</span></span><br><span class="line"><span class="string">        2. There are restrictions on characters allowed in paths.</span></span><br><span class="line"><span class="string">        3. File paths in the simulator paths are case sensitive.</span></span><br><span class="line"><span class="string">        Try a build clean then rebuild to make logs available or</span></span><br><span class="line"><span class="string">        consult: "\(commandFile)".</span></span><br><span class="line"><span class="string">        """</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ findCompileCommand ä¸ºç”Ÿæˆ sh è„šæœ¬çš„å…·ä½“æ–¹æ³•ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å½“å‰ä¿®æ”¹ç±»è®¾ç½®å¯¹åº”çš„ç¼–è¯‘è„šæœ¬å‘½ä»¤ã€‚ç”±äºè„šæœ¬å¤ªé•¿ï¼Œè¿™é‡Œå°±ä¸è´´ä¸Šæ¥äº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<p>ä½¿ç”¨æ”¹åŠ¨ç±»çš„ç¼–è¯‘è„šæœ¬å¯ä»¥ç”Ÿæˆå…¶.oæ–‡ä»¶ï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> toolchain = ((<span class="keyword">try</span>! <span class="type">NSRegularExpression</span>(pattern: <span class="string">"\\s*(\\S+?\\.xctoolchain)"</span>, options: []))</span><br><span class="line">    .firstMatch(<span class="keyword">in</span>: compileCommand, options: [], range: <span class="type">NSMakeRange</span>(<span class="number">0</span>, compileCommand.utf16.<span class="built_in">count</span>))?</span><br><span class="line">    .range(at: <span class="number">1</span>)).flatMap &#123; compileCommand[$<span class="number">0</span>] &#125; ?? <span class="string">"\(xcodeDev)/Toolchains/XcodeDefault.xctoolchain"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> osSpecific: <span class="type">String</span></span><br><span class="line"><span class="keyword">if</span> compileCommand.<span class="built_in">contains</span>(<span class="string">"iPhoneSimulator.platform"</span>) &#123;</span><br><span class="line">    osSpecific = <span class="string">"-isysroot \(xcodeDev)/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk -mios-simulator-version-min=9.0 -L\(toolchain)/usr/lib/swift/iphonesimulator -undefined dynamic_lookup"</span><span class="comment">// -Xlinker -bundle_loader -Xlinker \"\(Bundle.main.executablePath!)\""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé’ˆå¯¹æ¨¡æ‹Ÿå™¨ç¯å¢ƒè¿›è¡Œè„šæœ¬é…ç½®ï¼Œé…ç½®å®Œæˆåä½¿ç”¨ clang å‘½ä»¤æŠŠå¯¹åº”çš„.oæ–‡ä»¶ç”Ÿæˆç›¸åŒåå­—çš„åŠ¨æ€åº“ï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">guard</span> shell(command: <span class="string">"""</span></span><br><span class="line"><span class="string">    \(xcodeDev)/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -arch "\(arch)" -bundle \(osSpecific) -dead_strip -Xlinker -objc_abi_version -Xlinker 2 -fobjc-arc -fprofile-instr-generate \"\(tmpfile).o\" -L "\(frameworks)" -F "\(frameworks)" -rpath "\(frameworks)" -o \"\(tmpfile).dylib\" &gt;&gt;\"\(logfile)\" 2&gt;&amp;1</span></span><br><span class="line"><span class="string">    """</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> evalError(<span class="string">"Link failed, check \(commandFile)\n\(try! String(contentsOfFile: logfile))"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿‡ç¨‹ä¸­äº§ç”Ÿçš„äº§ç‰©å¦‚ä¸‹ï¼š</p>
<p><img src="/res/InjectionIII/7.png" width="50%"></p>
<p>è‹¹æœä¼šå¯¹åŠ è½½çš„åŠ¨æ€åº“è¿›è¡Œç­¾åæ ¡éªŒï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥éœ€è¦å¯¹è¿™ä¸ªåŠ¨æ€åº“ç­¾å,ç”±äºç­¾åéœ€è¦ä½¿ç”¨ Xcode ç¯å¢ƒï¼Œæ‰€ä»¥å®¢æˆ·ç«¯æ˜¯æ— æ³•è¿›è¡Œçš„ï¼Œåªèƒ½é€šè¿‡ socket å‘Šè¯‰æœåŠ¡ç«¯æ¥è¿›è¡Œæ“ä½œã€‚å½“æœåŠ¡ç«¯æ”¶åˆ° InjectionSign ç­¾åå‘½ä»¤åä¼šè°ƒç”¨ SignerService ç±»çš„ codesignDylib æ¥å¯¹ç›¸åº”çš„åŠ¨æ€åº“è¿›è¡Œç­¾åæ“ä½œ</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">@implementation <span class="type">SignerService</span></span><br><span class="line"></span><br><span class="line">+ (<span class="type">BOOL</span>)codesignDylib:(<span class="type">NSString</span> *)dylib identity:(<span class="type">NSString</span> *)identity &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">NSString</span> *adhocSign = @<span class="string">"-"</span>;</span><br><span class="line">    <span class="type">NSString</span> *command = [<span class="type">NSString</span> stringWithFormat:@<span class="string">""</span></span><br><span class="line">                         <span class="string">"(export CODESIGN_ALLOCATE=/Applications/Xcode.app"</span></span><br><span class="line">                         <span class="string">"/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/codesign_allocate; "</span></span><br><span class="line">                         <span class="string">"if /usr/bin/file \"%@\" | grep ' bundle ' &gt;/dev/null;"</span></span><br><span class="line">                         <span class="string">"then /usr/bin/codesign --force -s \"%@\" \"%@\";"</span></span><br><span class="line">                         <span class="string">"else exit 1; fi)"</span>,</span><br><span class="line">                         dylib, identity ?: adhocSign, dylib];</span><br><span class="line">    <span class="keyword">return</span> system(command.<span class="type">UTF8String</span>) &gt;&gt; <span class="number">8</span> == <span class="type">EXIT_SUCCESS</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)runInBackground &#123;</span><br><span class="line">    char __unused skip, buffer[<span class="number">1000</span>];</span><br><span class="line">    buffer[read(clientSocket, buffer, <span class="built_in">sizeof</span> buffer-<span class="number">1</span>)] = '\<span class="number">000</span>';</span><br><span class="line">    <span class="type">NSString</span> *path = [[<span class="type">NSString</span> stringWithUTF8String:buffer] componentsSeparatedByString:@<span class="string">" "</span>][<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="class"><span class="keyword">class</span>] <span class="title">codesignDylib</span>:<span class="title">path</span> <span class="title">identity</span>:<span class="title">nil</span>]) </span>&#123;</span><br><span class="line">        snprintf(buffer, <span class="built_in">sizeof</span> buffer, <span class="string">"HTTP/1.0 200 OK\r\n\r\n"</span>);</span><br><span class="line">        write(clientSocket, buffer, strlen(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ä¿®æ”¹æ–‡ä»¶çš„é‡æ–°ç¼–è¯‘ã€æ‰“åŒ…åŠ¨æ€åº“å’Œç­¾åæ“ä½œå°±å…¨éƒ¨å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢äº†ã€‚</p>
<h5 id="å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢"><a href="#å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢" class="headerlink" title="å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢"></a>å››ã€åŠ è½½åŠ¨æ€åº“è¿›è¡Œæ–¹æ³•æ›¿æ¢</h5><p>åœ¨ç”ŸæˆåŠ¨æ€åº“å å…ˆä½¿ç”¨dlopenæ–¹æ³•æŠŠå¯¹åº”çš„åŠ¨æ€åº“åŠ è½½åˆ°å½“å‰è¿è¡Œçš„è°ƒè¯•å·¥ç¨‹çš„è¿›ç¨‹ä¸­ å¹¶æ‹¿åˆ°è¿”å›çš„æŒ‡é’ˆdlï¼Œç„¶åä½¿ç”¨dlsymæ‹¿åˆ°åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">loadAndInject</span><span class="params">(tmpfile: String, oldClass: AnyClass? = <span class="literal">nil</span>)</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">AnyClass</span>] &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> dl = dlopen(<span class="string">"\(tmpfile).dylib"</span>, <span class="type">RTLD_NOW</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> oldClass != <span class="literal">nil</span> &#123;</span><br><span class="line">        </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// grep out symbols for classes being injected from object file</span></span><br><span class="line">        <span class="comment">//æ­£å¸¸æµç¨‹ä¼šèµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">try</span> extractClasses(dl: dl, tmpfile: tmpfile)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Overridden by SwiftInjectionEval subclass for injection</span></span><br><span class="line"><span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">extractClasses</span><span class="params">(dl: UnsafeMutableRawPointer,</span></span></span><br><span class="line"><span class="function"><span class="params">                          tmpfile: String)</span></span> <span class="keyword">throws</span> -&gt; [<span class="type">AnyClass</span>] &#123;</span><br><span class="line">    <span class="keyword">guard</span> shell(command: <span class="string">"""</span></span><br><span class="line"><span class="string">        \(xcodeDev)/Toolchains/XcodeDefault.xctoolchain/usr/bin/nm \(tmpfile).o | grep -E ' S _OBJC_CLASS_\\$_| _(_T0|\\$S|\\$s).*CN$' | awk '&#123;print $3&#125;' &gt;\(tmpfile).classes</span></span><br><span class="line"><span class="string">        """</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> evalError(<span class="string">"Could not list class symbols"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">var</span> classSymbolNames = (<span class="keyword">try</span>? <span class="type">String</span>(contentsOfFile: <span class="string">"\(tmpfile).classes"</span>))?.components(separatedBy: <span class="string">"\n"</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> evalError(<span class="string">"Could not load class symbol list"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    classSymbolNames.removeLast()</span><br><span class="line">    <span class="keyword">let</span> result =  <span class="type">Set</span>(classSymbolNames.compactMap &#123;</span><br><span class="line">        dlsym(dl, <span class="type">String</span>($<span class="number">0</span>.<span class="built_in">dropFirst</span>())) &#125;)</span><br><span class="line">        .<span class="built_in">map</span> &#123; <span class="built_in">unsafeBitCast</span>($<span class="number">0</span>, to: <span class="type">AnyClass</span>.<span class="keyword">self</span>) &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œdlopen ä¼šæŠŠ tmpfile åŠ¨æ€åº“æ–‡ä»¶è½½å…¥è¿è¡Œçš„ App é‡Œï¼Œè¿”å›æŒ‡é’ˆ dlã€‚å›åˆ°æµ‹è¯•å·¥ç¨‹ä½¿ç”¨ <code>lldb image list -o -f</code> ç¡®å®çœ‹åˆ°eval101.dylib è¢«åŠ è½½è¿›æ¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[408] 0x0000000111bfe000 /var/folders/tw/nl7v5_cd577bbdzfgxjy63bw0000gn/T/com.johnholdsworth.InjectionIII/eval101.dylib</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œ dlsym ä¼šå¾—åˆ° tmpfile åŠ¨æ€åº“çš„ç¬¦å·åœ°å€ï¼Œç„¶åå°±å¯ä»¥å¤„ç†ç±»çš„æ›¿æ¢å·¥ä½œäº†ã€‚åœ¨æ‹¿åˆ°æ–°ç±»çš„ç¬¦å·åœ°å€åï¼Œæˆ‘ä»¬æŠŠæ–°ç±»é‡Œæ‰€æœ‰çš„ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•éƒ½æ›¿æ¢åˆ°å¯¹åº”çš„æ—§ç±»ä¸­ï¼Œä½¿ç”¨çš„æ˜¯SwiftInjection çš„ injection æ–¹æ³•ï¼Œé€šè¿‡OC runtime çš„class_replaceMethodæŠŠæ•´ä¸ªç±»çš„å®ç°æ–¹æ³•éƒ½æ›¿æ¢äº†</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">injection</span><span class="params">(swizzle newClass: AnyClass?, onto oldClass: AnyClass?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> methodCount: <span class="type">UInt32</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> methods = class_copyMethodList(newClass, &amp;methodCount) &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span> ..&lt; <span class="type">Int</span>(methodCount) &#123;</span><br><span class="line">            <span class="keyword">let</span> method = method_getName(methods[i])</span><br><span class="line">            <span class="keyword">var</span> replacement = method_getImplementation(methods[i])</span><br><span class="line">            <span class="keyword">if</span> traceInjection, <span class="keyword">let</span> tracer = <span class="type">SwiftTrace</span></span><br><span class="line">                .trace(name: injectedPrefix+<span class="type">NSStringFromSelector</span>(method),</span><br><span class="line">                objcMethod: methods[i], objcClass: newClass,</span><br><span class="line">                original: autoBitCast(replacement)) &#123;</span><br><span class="line">                replacement = autoBitCast(tracer)</span><br><span class="line">            &#125;</span><br><span class="line">            class_replaceMethod(oldClass, method, replacement,</span><br><span class="line">                                method_getTypeEncoding(methods[i]))</span><br><span class="line">        &#125;</span><br><span class="line">        free(methods)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>iOSå¼€å‘è¿›é˜¶</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>create-react-appæ•™ç¨‹-ä½¿ç”¨ç¯‡</title>
    <url>/quick-start/create-react-app%E6%95%99%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87/</url>
    <content><![CDATA[<blockquote>
<p>æ˜¯ä¸æ˜¯åŒå€¦äº†æ¯æ¬¡æ–°å»ºwebé¡¹ç›®ç¹ççš„é…ç½®ï¼Œæƒ³ä¸æƒ³åªç”¨10ç§’æ­å»ºå°±æ­å»ºä¸€ä¸ªå®Œæ•´çš„reacté¡¹ç›®ï¼Ÿ </p>
</blockquote>
<p><img src="/res/create-react-app/1.svg" alt><br><a id="more"></a><br>create-react-app åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†</p>
<ul>
<li>å…¶ä¸­ <code>create-react-app</code>æ˜¯åˆ›å»ºå•é¡µé¢çš„reactè„šæ‰‹æ¶é¡¹ç›®è„šæœ¬ ï¼›</li>
<li>è€Œ<code>react-scripts</code>åˆ™ç®¡ç†ç€å·¥ç¨‹çš„ä¾èµ–ã€‚</li>
</ul>
<p>å¦‚æœæˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºreact webåº”ç”¨ç¨‹åºçš„æ—¶å€™,è¦è‡ªå·±é€šè¿‡ npm æˆ–è€… yarn å®‰è£…é¡¹ç›®çš„å…¨éƒ¨ä¾èµ–ï¼Œå†å†™webpack.config.js,ä¸€ç³»åˆ—å¤æ‚çš„é…ç½®,æ­å»ºå¥½å¼€å‘ç¯å¢ƒåå†™srcæºä»£ç ã€‚ä½¿ç”¨ create-react-app å»è‡ªåŠ¨æ„å»ºä½ çš„appç¨‹åº, ä½ çš„é¡¹ç›®æ— éœ€é…ç½®ï¼Œä¹Ÿæ²¡æœ‰å¤æ‚çš„ç›®å½•ç»“æ„ï¼Œåªæœ‰ä½ æ„å»ºåº”ç”¨æ‰€éœ€çš„æ–‡ä»¶ã€‚çœå»äº†å¾ˆå¤šç²¾åŠ›ï¼Œæœ€é€‚åˆå¿«é€Ÿä¸Šæ‰‹ä¸€ä¸ªdemoäº†ã€‚</p>
<h2 id="create-react-app-ä½¿ç”¨"><a href="#create-react-app-ä½¿ç”¨" class="headerlink" title="create-react-app ä½¿ç”¨"></a>create-react-app ä½¿ç”¨</h2><p>å…ˆæ¥çœ‹çœ‹å¦‚ä½•åç§’ä¸Šæ‰‹create-react-app!</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//my-app æ˜¯ä½ è¦åˆ›å»ºçš„webå•é¡µé¢é¡¹ç›®åå­—</span></span><br><span class="line">npx create-react-app my-app</span><br><span class="line"><span class="comment">//npx éœ€è¦ npm 5.2+ </span></span><br><span class="line">cd my-app</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥ä¸Šè¿°å‘½ä»¤åï¼Œæ‰“å¼€ <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a> å°±å¯ä»¥çœ‹åˆ°åˆå§‹é¡µé¢äº†~</p>
<h3 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h3><p>æ¥ç€ä¸Šé¢çš„å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†å¦‚ä¸‹æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my-app</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ node_modules</span><br><span class="line">â”œâ”€â”€ package.json</span><br><span class="line">â”œâ”€â”€ .gitignore</span><br><span class="line">â”œâ”€â”€ public</span><br><span class="line">â”‚   â”œâ”€â”€ favicon.ico</span><br><span class="line">â”‚   â”œâ”€â”€ index.html</span><br><span class="line">â”‚   â””â”€â”€ manifest.json</span><br><span class="line">â””â”€â”€ src</span><br><span class="line">    â”œâ”€â”€ App.css</span><br><span class="line">    â”œâ”€â”€ App.js</span><br><span class="line">    â”œâ”€â”€ App.test.js</span><br><span class="line">    â”œâ”€â”€ index.css</span><br><span class="line">    â”œâ”€â”€ index.js</span><br><span class="line">    â”œâ”€â”€ logo.svg</span><br><span class="line">    â””â”€â”€ serviceWorker.js</span><br></pre></td></tr></table></figure>
<p>public/index.html æ˜¯é¡µé¢æ¨¡æ¿,src/index.js åˆ™æ˜¯å…¥å£JSæ–‡ä»¶</p>
<p>å…¶ä¸­<code>src</code>ç›®å½•å’Œ <code>public</code>ç›®å½•éœ€è¦æ³¨æ„ä¸‹ã€‚åªæœ‰åœ¨<code>src</code>ç›®å½•ä¸‹çš„æ–‡ä»¶æ‰ä¼šè¢«webpackç¼–è¯‘ï¼Œjså’Œcssæ–‡ä»¶éƒ½å»ºè®®æ”¾åœ¨æ­¤å¤„ï¼›è€Œ<code>public</code>æ–‡ä»¶å¤¹åˆ™å­˜æ”¾ç€è¢« public/index.htmlä½¿ç”¨çš„èµ„æºã€‚</p>
<h3 id="webpacké…ç½®"><a href="#webpacké…ç½®" class="headerlink" title="webpacké…ç½®"></a>webpacké…ç½®</h3><p>å¯¹äºå–œæ¬¢æ‰‹åŠ¨åˆ›å»ºwebé¡¹ç›®çš„äººæ¥è¯´ï¼Œæ²¡æœ‰webpackçš„é…ç½®å¾ˆæ˜¯ä¸ä¹ æƒ¯å•Šï¼æˆ‘å°±æ˜¯è¦æ‰‹åŠ¨é…ç½®webpackæ€ä¹ˆåŠï¼Ÿ</p>
<p>é‚£å°±æ˜¯ä½¿ç”¨ <a href="https://github.com/timarney/react-app-rewired" target="_blank" rel="noopener">https://github.com/timarney/react-app-rewired</a> ä½¿ç”¨<code>react-app-rewired</code> éœ€è¦ä¸‰æ­¥ï¼š</p>
<p><strong>1)</strong> å®‰è£… react-app-rewired</p>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install react-app-rewired --save-dev</span><br></pre></td></tr></table></figure>
<p><strong>2)</strong> åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>config-overrides.js</code>æ–‡ä»¶</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="comment">/* config-overrides.js */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">override</span>(<span class="params">config, env</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//console.log('åŸwebpacké…ç½® config:',config)</span></span><br><span class="line">  <span class="comment">//åœ¨è¿™é‡Œä¿®æ”¹configå°±è¡Œ</span></span><br><span class="line">  <span class="comment">//console.log('ä¿®æ”¹åwebpacké…ç½® config:',config)</span></span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>3ï¼‰</strong> ä¿®æ”¹package.jsonä¸­script:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/* package.json */</span></span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line"><span class="comment">//   "start": "react-scripts start",</span></span><br><span class="line">   <span class="string">"start"</span>: <span class="string">"react-app-rewired start"</span>,</span><br><span class="line"><span class="comment">//    "build": "react-scripts build",</span></span><br><span class="line">   <span class="string">"build"</span>: <span class="string">"react-app-rewired build"</span>,</span><br><span class="line"><span class="comment">//   "test": "react-scripts test --env=jsdom",</span></span><br><span class="line">   <span class="string">"test"</span>: <span class="string">"react-app-rewired test --env=jsdom"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹create-react-appè‡ªå¸¦çš„ä¾èµ–é…ç½®å‘¢ï¼Ÿ"><a href="#é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹create-react-appè‡ªå¸¦çš„ä¾èµ–é…ç½®å‘¢ï¼Ÿ" class="headerlink" title="é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹create-react-appè‡ªå¸¦çš„ä¾èµ–é…ç½®å‘¢ï¼Ÿ"></a>é‚£ä¹ˆå¦‚ä½•æŸ¥çœ‹<code>create-react-app</code>è‡ªå¸¦çš„ä¾èµ–é…ç½®å‘¢ï¼Ÿ</h4><p>ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨<code>npm run eject</code> ã€‚<code>npm run eject</code>çš„ä½œç”¨å°±æ˜¯å°†åŸæœ‰éšè—çš„ä¾èµ–ï¼ˆæ¯”å¦‚Webpack, Babel, ESLintç­‰ï¼‰æš´éœ²å‡ºæ¥ï¼Œ è¯·æ³¨æ„è¿™æ˜¯ä¸å¯é€†çš„è¡Œä¸ºã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//npm run ejectæ‰§è¡Œå é¡¹ç›®ä¸‹å¤šäº†è¿™æ ·çš„æ–‡ä»¶</span><br><span class="line">//æˆ‘çš„create-react-appç‰ˆæœ¬ä¸º1.5.2</span><br><span class="line">|-config</span><br><span class="line">    |-jest</span><br><span class="line">        |-cssTransform.js</span><br><span class="line">        |-fileTransform.js</span><br><span class="line">    |-env.js</span><br><span class="line">    |-paths.js</span><br><span class="line">    |-webpack.config.dev.js</span><br><span class="line">    |-webpack.config.prod.js</span><br><span class="line">    |-webpackDevServer.config.js</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>webpack.config.dev.js</code> å’Œ <code>webpack.config.prod.js</code> æ”¯æŒçš„æ”¯æŒçš„ä¾èµ–å¤§è‡´æœ‰ï¼š</p>
<ul>
<li>React, JSX, ES6, TypeScript å’Œ Flow è¯­æ³•æ”¯æŒ<ul>
<li><a href="https://facebook.github.io/react/docs/introducing-jsx.html" target="_blank" rel="noopener">JSX</a>, </li>
<li><a href="https://facebook.github.io/create-react-app/docs/adding-flow" target="_blank" rel="noopener">Flow</a></li>
<li><a href="https://facebook.github.io/create-react-app/docs/adding-typescript" target="_blank" rel="noopener">TypeScript</a>.</li>
</ul>
</li>
<li>ES6ä»¥å¤–çš„ç‰¹æ€§<ul>
<li><a href="https://github.com/rwaldron/exponentiation-operator" target="_blank" rel="noopener">Exponentiation Operator</a> (ES2016).</li>
<li><a href="https://github.com/tc39/ecmascript-asyncawait" target="_blank" rel="noopener">Async/await</a> (ES2017).</li>
<li><a href="https://github.com/tc39/proposal-object-rest-spread" target="_blank" rel="noopener">Object Rest/Spread Properties</a> (ES2018).</li>
<li><a href>Dynamic import() </a>(stage 3 proposal)</li>
<li><a href="https://github.com/tc39/proposal-class-public-fields" target="_blank" rel="noopener">Class Fields and Static Properties</a> (part of stage 3 proposal).</li>
</ul>
</li>
<li>é€šè¿‡Autoprefixer å¸®ä½ çš„cssæ–‡ä»¶è‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å…¼å®¹å‰ç¼€</li>
<li>å¿«é€Ÿäº¤äº’å¼å•å…ƒæµ‹è¯•è¿è¡Œç¨‹åºï¼Œå†…ç½®å¯¹è¦†ç›–ç‡æŠ¥å‘Šçš„æ”¯æŒã€‚</li>
<li>ä¸€ä¸ªèƒ½æ£€æŸ¥å¸¸è§é”™è¯¯çš„å®æ—¶æœåŠ¡å™¨</li>
<li>æ‰“åŒ…è„šæœ¬ èƒ½è¾“å‡ºå¸¦ hashes å’Œ sourcemapsä¿¡æ¯.</li>
<li>ä½¿ç”¨å•ä¸ªreact-scriptè„šæœ¬å¯¹ä¸Šé¢ä¾èµ–æ— ä¾µå…¥æ›´æ–°</li>
</ul>
<h3 id="ä½¿ç”¨sassæ ·å¼"><a href="#ä½¿ç”¨sassæ ·å¼" class="headerlink" title="ä½¿ç”¨sassæ ·å¼"></a>ä½¿ç”¨sassæ ·å¼</h3><p>åœ¨create-react-appä¸­ä½¿ç”¨ Sasséœ€è¦ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<p><strong>1)</strong> å®‰è£… <code>node-sass</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install node-sass --save</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">yarn add node-sass</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ä½ å¯ä»¥é‡å‘½å <code>src/App.css</code> ä¸º <code>src/App.scss</code>ç„¶ååœ¨ <code>src/App.js</code>ä¸­æ›´æ–°ä¸º <code>import src/App.scss</code> ,.scss æˆ– .sass åç¼€çš„æ–‡ä»¶ä¼šè‡ªåŠ¨è¢«ç¼–è¯‘ã€‚</p>
<h3 id="ä½¿ç”¨-Bootstrap"><a href="#ä½¿ç”¨-Bootstrap" class="headerlink" title="ä½¿ç”¨ Bootstrap"></a>ä½¿ç”¨ Bootstrap</h3><p>ä½ å¯ä»¥å°è¯•ä½¿ç”¨ä¸‹<a href="https://reactstrap.github.io/" target="_blank" rel="noopener">reactstrap</a>, è¿™æ˜¯ä¸€ä¸ªæµè¡Œçš„æ•´åˆbootstrapå’Œreactçš„åº“ã€‚</p>
<p><strong>1ï¼‰</strong> å®‰è£…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install --save reactstrap bootstrap@4</span><br><span class="line"><span class="comment">#or</span></span><br><span class="line">yarn add bootstrap@4 reactstrap</span><br></pre></td></tr></table></figure>
<p><strong>2ï¼‰</strong> åœ¨ä½ çš„src/index.js æ–‡ä»¶å†…å®¹çš„é¡¶éƒ¨ï¼Œå¯¼å…¥ Bootstrap CSS å’Œå¯é€‰çš„ Bootstrap theme CSS</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'bootstrap/dist/css/bootstrap.css'</span>;  <span class="comment">// å¿…é¡»çš„ </span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'bootstrap/dist/css/bootstrap-theme.css'</span>;  <span class="comment">//  å¯é€‰çš„</span></span><br></pre></td></tr></table></figure>
<p><strong>3ï¼‰</strong> ä½¿ç”¨ reactstrap ç»„ä»¶ </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Grid, Navbar, Jumbotron, Button &#125; <span class="keyword">from</span> <span class="string">'react-bootstrap'</span>;</span><br></pre></td></tr></table></figure>
<blockquote class="blockquote-center"><p>ä¼šåœ¨ä¹‹åçš„ <a href="../create-react-appæ•™ç¨‹-æºç ç¯‡/">create-react-appæ•™ç¨‹-æºç ç¯‡</a> ä¸­ä»‹ç»create-react-appçš„æºç </p>
</blockquote>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>create-react-appæ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>å‰ç«¯å·¥ç¨‹åŒ–</tag>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title>é‡å­¦iOS-çŸ¥è¯†æ ‘å¤§çº²</title>
    <url>/quick-start/ReLearning-iOS/</url>
    <content><![CDATA[<p>æ¥äº¬ä¸œä¸€å¹´å¤šäº†ï¼Œä»é¢„æƒ³çš„ipadä¸šåŠ¡åˆ°RNä¸šåŠ¡ï¼Œå†åˆ°ç°åœ¨çš„iphoneä¸šåŠ¡åŠ RNä¸šåŠ¡ã€‚å­¦ä¹ äº†å¾ˆå¤šRNã€å‰ç«¯ç›¸å…³çš„çŸ¥è¯†ä¹Ÿé—å¿˜äº†éƒ¨åˆ†iOSçš„ç›¸å…³é€»è¾‘ã€‚<br>ç°åœ¨æ‰“ç®—é‡æ–°å›é¡¾å­¦ä¹ ä¸€ä¸‹iOS,åšä¸€ä¸ªç³»åˆ—å¸®åŠ©è‡ªå·±é‡å­¦iOS,å¸¦è‡ªå·±è¿˜æœ‰ä½ é‡æ–°è®¤è¯†iOSã€‚</p>
<p>åœ¨å¼€å§‹ç”»çŸ¥è¯†æ ‘å¤§çº²ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆæ¥ä¸ºè¿™ä¸ªç³»åˆ—å®šä¸‹ä¸€ä¸ªå°è§„èŒƒã€‚æœ¬èº«æˆ‘ä»¬å¯ä»¥ç½‘ä¸Šæ‰¾åˆ°å¾ˆå¤šå‚è€ƒèµ„æ–™ï¼Œæ¯”å¦‚å®˜æ–¹å¼€å‘è€…æ–‡æ¡£è¿™æ ·çš„å‚è€ƒæ‰‹å†Œã€‚è‹¹æœçš„å‚è€ƒæ‰‹å†Œåšçš„æ˜¯å¾ˆå¥½å¥½å…¨é¢ï¼Œä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›å­¦ä¹ çš„ï¼Œæˆ‘æƒ³å°½é‡å’Œä½ ä¸€èµ·æ‰“é€ ä¸€ä¸ªiOSçŸ¥è¯†æ¡†æ¶ï¼Œå†æŠŠä¸»è¦çš„çŸ¥è¯†ç‚¹åšä¸ªéå†ï¼Œå…¶ä¸­ä¸»è¦æ¢è®¨åŸç†å’ŒèƒŒæ™¯ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚è¿™æ ·å°±ç®—é‡åˆ°äº†ä¸è®¤è¯†çš„APIçŸ¥è¯†ç‚¹ï¼Œä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“åœ°æŸ¥é˜…å¼€å‘è€…æ–‡æ¡£æ¥è§£å†³ã€‚<br><a id="more"></a><br>æˆ‘ç®€å•åšä¸ªäº†ä¸€ä¸ªåˆ’åˆ†ï¼Œå°†iOSçŸ¥è¯†åœ¨æ€»ä½“ä¸Šåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š<br><strong>ä¸€æ˜¯åŸºç¡€éƒ¨åˆ†ï¼Œä¸»è¦æ¢è®¨åˆå­¦è€…åœ¨ä¸šåŠ¡ä¸­å¸¸é‡è§çŸ¥è¯†ç‚¹å’Œç–‘æƒ‘ï¼›</strong><br><img src="/res/reLearningiOS/é‡å­¦iOS-åŸºç¡€.png" width="80%"></p>
<p><strong>äºŒæ˜¯æ·±å…¥éƒ¨åˆ†ï¼Œä¸»è¦æ¢è®¨iOSæœºåˆ¶åŸç†å’Œæ¯”è¾ƒå…·ä½“ä¸šåŠ¡å€¾å‘çš„æ¡†æ¶åº”ç”¨ï¼›</strong><br><img src="/res/reLearningiOS/é‡å­¦iOS-æ·±å…¥.png" width="80%"><br><strong>ä¸‰æ˜¯è¿›é˜¶å®è·µéƒ¨åˆ†ï¼Œä¸»è¦æ¢è®¨ä¸šåŠ¡å¼€å‘ä¸­çš„éš¾ç‚¹ç–‘ç‚¹ã€‚</strong><br><img src="/res/reLearningiOS/é‡å­¦iOS-è¿›é˜¶.png" width="80%"></p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSç›´æ’­æ•™ç¨‹</title>
    <url>/quick-start/iOS%E7%9B%B4%E6%92%AD%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="ç›´æ’­åŸç†"><a href="#ç›´æ’­åŸç†" class="headerlink" title="ç›´æ’­åŸç†"></a>ç›´æ’­åŸç†</h2><p>ä¸€ä¸ªç®€å•çš„ç›´æ’­æµç¨‹æ˜¯: </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app        -&gt; è§†é¢‘é‡‡é›†   -&gt;  ç¼–ç     -&gt; æ¨æµ     -&gt; æœåŠ¡å™¨</span><br><span class="line">æœåŠ¡å™¨      -&gt; æ‹‰æµ      -&gt;  è§£ç     -&gt; æ’­æ”¾     -&gt; app</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹æ¯”è¾ƒå¤š:</p>
<p><img src="/res/live/ç›´æ’­æŠ€æœ¯ç‚¹.png" alt></p>
<a id="more"></a>
<h3 id="æµåª’ä½“ä¼ è¾“åè®®"><a href="#æµåª’ä½“ä¼ è¾“åè®®" class="headerlink" title="æµåª’ä½“ä¼ è¾“åè®®"></a>æµåª’ä½“ä¼ è¾“åè®®</h3><h4 id="RTMP"><a href="#RTMP" class="headerlink" title="RTMP"></a>RTMP</h4><ul>
<li>RTMP:å®æ—¶æ¶ˆæ¯ä¼ è¾“åè®®,Adobe Systemså…¬å¸ä¸ºFlashæ’­æ”¾å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´éŸ³é¢‘ã€è§†é¢‘å’Œæ•°æ®ä¼ è¾“å¼€å‘çš„å¼€æ”¾åè®®ï¼Œå› ä¸ºæ˜¯å¼€æ”¾åè®®æ‰€ä»¥éƒ½å¯ä»¥ä½¿ç”¨äº†ã€‚<ul>
<li>RTMPåè®®ç”¨äºå¯¹è±¡ã€è§†é¢‘ã€éŸ³é¢‘çš„ä¼ è¾“ã€‚<ul>
<li>è¿™ä¸ªåè®®å»ºç«‹åœ¨TCPåè®®æˆ–è€…è½®è¯¢HTTPåè®®ä¹‹ä¸Šã€‚</li>
<li>RTMPåè®®å°±åƒä¸€ä¸ªç”¨æ¥è£…æ•°æ®åŒ…çš„å®¹å™¨ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯FLVä¸­çš„è§†éŸ³é¢‘æ•°æ®ã€‚ä¸€ä¸ªå•ä¸€çš„è¿æ¥å¯ä»¥é€šè¿‡ä¸åŒçš„é€šé“ä¼ è¾“å¤šè·¯ç½‘ç»œæµï¼Œè¿™äº›é€šé“ä¸­çš„åŒ…éƒ½æ˜¯æŒ‰ç…§å›ºå®šå¤§å°çš„åŒ…ä¼ è¾“çš„</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="HLS-HTTP-Live-Streaming"><a href="#HLS-HTTP-Live-Streaming" class="headerlink" title="HLS (HTTP Live Streaming)"></a>HLS (HTTP Live Streaming)</h4><p>HTTP Live Streamingï¼ˆHLSï¼‰æ˜¯è‹¹æœå…¬å¸(Apple Inc.)å®ç°çš„åŸºäºHTTPçš„æµåª’ä½“ä¼ è¾“åè®®ï¼Œå¯å®ç°æµåª’ä½“çš„ç›´æ’­å’Œç‚¹æ’­ï¼Œä¸»è¦åº”ç”¨åœ¨iOSç³»ç»Ÿï¼Œä¸ºiOSè®¾å¤‡ï¼ˆå¦‚iPhoneã€iPadï¼‰æä¾›éŸ³è§†é¢‘ç›´æ’­å’Œç‚¹æ’­æ–¹æ¡ˆã€‚HLSç‚¹æ’­ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å¸¸è§çš„åˆ†æ®µHTTPç‚¹æ’­ï¼Œä¸åŒåœ¨äºï¼Œå®ƒçš„åˆ†æ®µéå¸¸å°ã€‚</p>
<p>ç›¸å¯¹äºå¸¸è§çš„æµåª’ä½“ç›´æ’­åè®®ï¼Œä¾‹å¦‚RTMPåè®®ç­‰ï¼ŒHLSç›´æ’­æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œç›´æ’­å®¢æˆ·ç«¯è·å–åˆ°çš„ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®æµã€‚HLSåè®®åœ¨æœåŠ¡å™¨ç«¯å°†ç›´æ’­æ•°æ®æµå­˜å‚¨ä¸ºè¿ç»­çš„ã€å¾ˆçŸ­æ—¶é•¿çš„åª’ä½“æ–‡ä»¶ï¼ˆMPEG-TSæ ¼å¼ï¼‰ï¼Œè€Œå®¢æˆ·ç«¯åˆ™ä¸æ–­çš„ä¸‹è½½å¹¶æ’­æ”¾è¿™äº›å°æ–‡ä»¶ï¼Œå› ä¸ºæœåŠ¡å™¨ç«¯æ€»æ˜¯ä¼šå°†æœ€æ–°çš„ç›´æ’­æ•°æ®ç”Ÿæˆæ–°çš„å°æ–‡ä»¶ï¼Œè¿™æ ·å®¢æˆ·ç«¯åªè¦ä¸åœçš„æŒ‰é¡ºåºæ’­æ”¾ä»æœåŠ¡å™¨è·å–åˆ°çš„æ–‡ä»¶ï¼Œå°±å®ç°äº†ç›´æ’­ã€‚ç”±æ­¤å¯è§ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºï¼ŒHLSæ˜¯ä»¥ç‚¹æ’­çš„æŠ€æœ¯æ–¹å¼æ¥å®ç°ç›´æ’­ã€‚ç”±äºæ•°æ®é€šè¿‡HTTPåè®®ä¼ è¾“ï¼Œæ‰€ä»¥å®Œå…¨ä¸ç”¨è€ƒè™‘é˜²ç«å¢™æˆ–è€…ä»£ç†çš„é—®é¢˜ï¼Œè€Œä¸”åˆ†æ®µæ–‡ä»¶çš„æ—¶é•¿å¾ˆçŸ­ï¼Œå®¢æˆ·ç«¯å¯ä»¥å¾ˆå¿«çš„é€‰æ‹©å’Œåˆ‡æ¢ç ç‡ï¼Œä»¥é€‚åº”ä¸åŒå¸¦å®½æ¡ä»¶ä¸‹çš„æ’­æ”¾ã€‚ä¸è¿‡HLSçš„è¿™ç§æŠ€æœ¯ç‰¹ç‚¹ï¼Œå†³å®šäº†å®ƒçš„å»¶è¿Ÿä¸€èˆ¬æ€»æ˜¯ä¼šé«˜äºæ™®é€šçš„æµåª’ä½“ç›´æ’­åè®®ã€‚</p>
<p>m3u8ï¼Œæ˜¯HTTP Live Streamingç›´æ’­çš„ç´¢å¼•æ–‡ä»¶ã€‚</p>
<ul>
<li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/StreamingMediaGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40008332-CH1-SW1" target="_blank" rel="noopener">Apple: HTTP Live Streaming Overview </a></li>
<li><a href="https://developer.apple.com/streaming/" target="_blank" rel="noopener">Apple: HTTP Live Streaming(HLS) Overview</a></li>
</ul>
<h2 id="ç›´æ’­iOSå®æˆ˜"><a href="#ç›´æ’­iOSå®æˆ˜" class="headerlink" title="ç›´æ’­iOSå®æˆ˜"></a>ç›´æ’­iOSå®æˆ˜</h2><h3 id="æœåŠ¡ç«¯é…ç½®"><a href="#æœåŠ¡ç«¯é…ç½®" class="headerlink" title="æœåŠ¡ç«¯é…ç½®"></a>æœåŠ¡ç«¯é…ç½®</h3><h4 id="å®‰è£…-nginx"><a href="#å®‰è£…-nginx" class="headerlink" title="å®‰è£… nginx"></a>å®‰è£… nginx</h4><blockquote>
<p>ä½¿ç”¨HomeBrew å®‰è£… nginx<br>æ²¡å®‰è£…è¿‡HomwBrewçš„ çœ‹ä¸€ä¸‹ <a href="https://brew.sh/" target="_blank" rel="noopener">HomeBrewä¸»é¡µ</a> å®‰è£…ä¸€ä¸‹</p>
</blockquote>
<p><strong>ä¸€ï¼š</strong> <em>å¢åŠ home-brewå¯¹nginxçš„æ‰©å±•</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew tap homebrew/nginx</span><br></pre></td></tr></table></figure>
<p><strong>äºŒï¼š</strong> <em>å®‰è£…NginxæœåŠ¡å™¨å’Œrtmpæ¨¡å—</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install nginx-full --with-rtmp-module</span><br></pre></td></tr></table></figure>
<p><strong>ä¸‰ï¼š</strong> <em>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</em></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew info nginx-full</span><br></pre></td></tr></table></figure>
<p><img src="/res/live/brewInfoNginx.png" alt>    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/usr/local/etc/nginx/nginx.conf ï¼ˆé…ç½®æ–‡ä»¶è·¯å¾„ï¼‰</span><br><span class="line">/usr/local/var/www ï¼ˆæœåŠ¡å™¨é»˜è®¤è·¯å¾„ï¼‰</span><br><span class="line">/usr/local/Cellar/ ï¼ˆå®‰è£…è·¯å¾„ï¼‰</span><br><span class="line">open -t /usr/local/etc/nginx/nginx.conf å¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€é…ç½®æ–‡ä»¶</span><br><span class="line">nginx -s reload é‡æ–°åŠ è½½é…ç½®</span><br><span class="line">nginx -s reopen é‡æ–°æ‰“å¼€log</span><br><span class="line">nginx -s stop åœæ­¢nginx</span><br><span class="line">nginx -s quit é€€å‡ºnginx</span><br></pre></td></tr></table></figure>
<p><strong>å››ï¼š</strong> <em>å¯åŠ¨nginx</em></p>
<p>è¾“å…¥ å¼€å¯æœåŠ¡å™¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure>
<p>åœ¨æµè§ˆå™¨ä¸­ è¾“å…¥ <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a><br>å¦‚æœå‡ºç°ä¸‹å›¾, åˆ™è¡¨ç¤ºå®‰è£…æˆåŠŸ:</p>
<p><img src="/res/live/welcomeNginx.png" alt></p>
<h4 id="é…ç½®-nginx"><a href="#é…ç½®-nginx" class="headerlink" title="é…ç½® nginx"></a>é…ç½® nginx</h4><p><strong>ä¸€ï¼š</strong> <em>é…ç½®Nginxï¼Œæ”¯æŒhttpåè®®æ‹‰æµ</em></p>
<p>åœ¨ç»ˆç«¯è¾“å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">open -t  /usr/local/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€nginxé…ç½®æ–‡ä»¶,åœ¨httpå±æ€§ä¸‹æ‰¾åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    root   html;</span><br><span class="line">    index  index.html index.htm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸‹é¢æ·»åŠ ï¼Œæˆä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root   html;</span><br><span class="line">	index  index.html index.htm;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /hls &#123; </span><br><span class="line">	#æ”¯æŒhttpåè®®æ‹‰æµ</span><br><span class="line">	types &#123; </span><br><span class="line">		application/vnd.apple.mpegurl m3u8; </span><br><span class="line">		video/mp2t ts; </span><br><span class="line">	&#125; </span><br><span class="line">	root /usr/local/var/www; </span><br><span class="line">	add_header Cache-Control no-cache; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>äºŒï¼š</strong> <em>é…ç½®Nginxï¼Œæ”¯æŒrtmpåè®®æ¨æµ</em></p>
<p>åœ¨ç»ˆç«¯è¾“å…¥<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">open -t  /usr/local/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å¼€nginxé…ç½®æ–‡ä»¶, æ–‡ä»¶çš„æœ«å°¾(æœ€åä¸€ä¸ª â€œ}â€ ä¸‹ä¸€è¡Œ )æ·»åŠ ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rtmp &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 1990;</span><br><span class="line">        </span><br><span class="line">        application hls&#123;</span><br><span class="line"></span><br><span class="line">          live on;</span><br><span class="line">          record off;</span><br><span class="line">          hls on;</span><br><span class="line">          hls_path /usr/local/var/www/hls;</span><br><span class="line">          hls_fragment 1s;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¸‰ï¼š</strong> åº”ç”¨é…ç½®</p>
<p>é‡å¯ä¸‹nginxå°±è¡Œ </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨-ffmepg-æµ‹è¯•æ¨æµ"><a href="#ä½¿ç”¨-ffmepg-æµ‹è¯•æ¨æµ" class="headerlink" title="ä½¿ç”¨ ffmepg æµ‹è¯•æ¨æµ"></a>ä½¿ç”¨ ffmepg æµ‹è¯•æ¨æµ</h4><h3 id="åœ¨iOSç«¯ä½¿ç”¨-LFLiveKit-æ¨æµ"><a href="#åœ¨iOSç«¯ä½¿ç”¨-LFLiveKit-æ¨æµ" class="headerlink" title="åœ¨iOSç«¯ä½¿ç”¨ LFLiveKit æ¨æµ"></a>åœ¨iOSç«¯ä½¿ç”¨ LFLiveKit æ¨æµ</h3><blockquote>
<p>LFLiveKitå®ƒå·²ç»å¸®æˆ‘ä»¬å®ç°äº†è§†é¢‘é‡‡é›†ã€åå°å½•åˆ¶ã€ç¾é¢œåŠŸèƒ½ã€æ”¯æŒh264ã€AACç¼–ç ï¼ŒåŠ¨æ€æ”¹å˜é€Ÿç‡ï¼ŒRTMPä¼ è¾“ç­‰<br><a href="https://github.com/LaiFengiOS/LFLiveKit" target="_blank" rel="noopener">LFLiveKitä¸»é¡µ</a></p>
</blockquote>
<h4 id="ä½¿ç”¨LFLiveKit-demo-æ¨æµ"><a href="#ä½¿ç”¨LFLiveKit-demo-æ¨æµ" class="headerlink" title="ä½¿ç”¨LFLiveKit demo æ¨æµ"></a>ä½¿ç”¨LFLiveKit demo æ¨æµ</h4><p>ä¸‹è½½æºä»£ç åï¼Œè¿›å…¥sample/LFLiveKitDemo ç›®å½•ï¼Œè¿è¡Œä¸‹<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pod install</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å¼€LFLiveKitDemo.xcworkspace å·¥ç¨‹</p>
<p>å°†<strong>LFLivePreview.m</strong>æ–‡ä»¶çš„362è¡Œæ”¹ä¸ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">stream.url = <span class="string">@"rtmp://10.45.33.96:1990/hls/abc"</span>;</span><br></pre></td></tr></table></figure>
<p>urlå¯¹åº”çš„æ˜¯ rtmp://[nginxæœåŠ¡å™¨åœ°å€] : [ç«¯å£] / [é…ç½®çš„åº”ç”¨] / éšä¾¿å†™</p>
<p>ç„¶åçœŸæœºè¿è¡Œæ•ˆæœå¦‚ä¸‹:</p>
<p><img src="/res/live/LFLiveKitPreview.png" width="50%"></p>
<h4 id="æµ‹è¯•LFLiveKit-demo-æ¨æµ"><a href="#æµ‹è¯•LFLiveKit-demo-æ¨æµ" class="headerlink" title="æµ‹è¯•LFLiveKit demo æ¨æµ"></a>æµ‹è¯•LFLiveKit demo æ¨æµ</h4><blockquote>
<p>ä¿è¯nginxæœåŠ¡å™¨æ˜¯å¼€å¯çŠ¶æ€<br>ç‚¹å‡»ä¸Šé¢demoä¸­çš„å¼€å§‹ç›´æ’­åï¼š</p>
</blockquote>
<p>åœ¨mac <strong>Safari</strong> æµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://localhost:8080/hls/abc.m3u8" target="_blank" rel="noopener">http://localhost:8080/hls/abc.m3u8</a> æŸ¥çœ‹æ•ˆæœï¼š</p>
<p><img src="/res/live/LFLiveKitTest.png" width="80%"></p>
<p>ç›¸å¯¹åº”çš„ï¼Œç›´æ¥ä½¿ç”¨iOSè‡ªå¸¦çš„AVPlayerå°±å¯ä»¥æ’­æ”¾è¯¥é“¾æ¥ã€‚</p>
]]></content>
      <categories>
        <category>quick-start</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯è§†åŒ–D3æ•™ç¨‹-å¿«é€Ÿå¼€å§‹</title>
    <url>/quick-start/d3-tutorials-quickstart/</url>
    <content><![CDATA[<blockquote>
<p>æœ€è¿‘æƒ³å¼€ä¸ªå¯è§†åŒ–çš„å‘ï¼Œå°±çœ‹åˆ°äº† <a href="https://github.com/d3/d3" target="_blank" rel="noopener">D3</a> , åˆ«é—®ä¸ºä»€ä¹ˆä¸é€‰æ‹©echartsã€Highchartsä¹‹ç±»çš„ï¼Œè€å¤«å†™ä»£ç å°±çœ‹staræ•°æœ€å¤šçš„â€¦â€¦<br>D3 çš„å…¨ç§°æ˜¯ï¼ˆData-Driven Documentsï¼‰, D3 å°†ç”Ÿæˆå¯è§†åŒ–çš„å¤æ‚æ­¥éª¤ç²¾ç®€åˆ°äº†å‡ ä¸ªç®€å•çš„å‡½æ•°ï¼Œä½ åªéœ€è¦è¾“å…¥å‡ ä¸ªç®€å•çš„æ•°æ®ï¼Œå°±èƒ½å¤Ÿè½¬æ¢ä¸ºå„ç§ç»šä¸½çš„å›¾å½¢ã€‚<br>å’‹ä¸€çœ‹d3é¦–é¡µ è¢«å…¶å‡Œä¹±çš„æ–‡æ¡£æŠ˜æœäº† å·®ç‚¹å°±å®Œæˆäº†å°±å…¥é—¨åˆ°æ”¾å¼ƒï¼Œäºæ˜¯åšä¸ªå­¦ä¹ è¿‡ç¨‹è®°å½•ï¼Œå¸®åŠ©ä¸€èµ·å…¥é—¨d3çš„å¤§å®¶^_^</p>
</blockquote>
<a id="more"></a>
<p>æœ¬æ–‡å¿«é€Ÿä¸Šæ‰‹å…ˆæ¥ç”»å‡ºè¿™æ ·ä¸€ä¸ªå›¾å½¢ï¼š</p>
<p><img src="/res/d3/quick-start-2.png" width="33%"></p>
<p>è¿«äºåªä¼š React  ä¹‹åçš„ä»£ç é‡Œå¯èƒ½ä¼šå‡ºç° reactç›¸å…³çŸ¥è¯†ï¼Œä½†æ˜¯åªä¼švueçš„åŒå­¦ä¸ç”¨ç€æ€¥ é‡ç‚¹ç›¸å…³çš„éƒ½æ˜¯ d3 ï¼Œéƒ½å¯ä»¥çœ‹å¾—æ‡‚å¾—å•¦~ åºŸè¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬å¿«é€Ÿä¸Šæ‰‹d3å§ã€‚</p>
<h3 id="å¼•å…¥d3"><a href="#å¼•å…¥d3" class="headerlink" title="å¼•å…¥d3"></a>å¼•å…¥d3</h3><p>å¼•å…¥d3çš„æ–¹å¼å¾ˆå¤šï¼Œæˆ‘æ˜¯ç”¨create-react-appåˆ›å»ºç¤ºä¾‹å·¥ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œç”¨npmå¼•å…¥</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npm install d3</span><br><span class="line"><span class="comment">//å®‰è£…åå¾—åˆ°çš„d3ç‰ˆæœ¬ ä¹‹åéƒ½ä¼šä¾æ®è¿™ä¸ªç‰ˆæœ¬åšç¤ºä¾‹ï¼š "d3": "^5.7.0",</span></span><br><span class="line"><span class="comment">//d3 4/5 ç‰ˆæœ¬ä¹‹é—´çš„APIä¼šç•¥æœ‰ä¸åŒ</span></span><br><span class="line"><span class="comment">//ç„¶ååœ¨jsæ–‡ä»¶ä¸­</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> d3 <span class="keyword">from</span> <span class="string">'d3'</span></span><br></pre></td></tr></table></figure>
<h3 id="å‡†å¤‡æ ¹è§†å›¾å’Œæ•°æ®"><a href="#å‡†å¤‡æ ¹è§†å›¾å’Œæ•°æ®" class="headerlink" title="å‡†å¤‡æ ¹è§†å›¾å’Œæ•°æ®"></a>å‡†å¤‡æ ¹è§†å›¾å’Œæ•°æ®</h3><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¹‹åä¼šåœ¨è¿™é‡ŒåŠ å…¥ç”»å¸ƒ</span></span><br><span class="line">&lt;div id=<span class="string">"graph"</span> /&gt;</span><br><span class="line"><span class="comment">//æœ¬æ¬¡æœ€åä¼šç”»å‡ºä¸€ä¸ªâ€œæŸ±çŠ¶å›¾â€ï¼Œç®€å•å‡†å¤‡ä¸‹è¿™æ ·çš„æ•°æ®æº</span></span><br><span class="line"><span class="keyword">let</span> data = [<span class="number">2500</span>, <span class="number">2100</span>, <span class="number">1700</span>, <span class="number">1300</span>, <span class="number">900</span>]</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®ç”»å¸ƒ"><a href="#è®¾ç½®ç”»å¸ƒ" class="headerlink" title="è®¾ç½®ç”»å¸ƒ"></a>è®¾ç½®ç”»å¸ƒ</h3><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨ä¹‹å‰å‡†å¤‡çš„divä¸‹æ’å…¥svg</span></span><br><span class="line"><span class="keyword">let</span> svg = d3.select(<span class="string">"#graph"</span>) <span class="comment">// d3.select()ï¼šæ˜¯é€‰æ‹©æ‰€æœ‰æŒ‡å®šå…ƒç´ çš„ç¬¬ä¸€ä¸ª</span></span><br><span class="line">    .append(<span class="string">"svg"</span>)<span class="comment">//è·å–åˆ°ç”»å¸ƒ</span></span><br><span class="line">    .attr(<span class="string">"width"</span>, <span class="number">500</span>)<span class="comment">//è®¾ç½®å®½åº¦</span></span><br><span class="line">    .attr(<span class="string">"height"</span>, <span class="number">500</span>);<span class="comment">//è®¾ç½®é«˜åº¦</span></span><br></pre></td></tr></table></figure>
<p>D3 è™½ç„¶æ²¡æœ‰æ˜æ–‡è§„å®šä¸€å®šè¦åœ¨ SVG ä¸­ç»˜å›¾ï¼Œä½†æ˜¯ D3 æä¾›äº†ä¼—å¤šçš„ SVG å›¾å½¢çš„ç”Ÿæˆå™¨ï¼Œå®ƒä»¬éƒ½æ˜¯åªæ”¯æŒ SVG çš„ã€‚å› æ­¤ï¼Œå»ºè®®ä½¿ç”¨ SVG ç”»å¸ƒã€‚        </p>
<p>SVGï¼ŒæŒ‡å¯ç¼©æ”¾çŸ¢é‡å›¾å½¢ï¼ˆScalable Vector Graphicsï¼‰ï¼Œæ˜¯ç”¨äºæè¿°äºŒç»´çŸ¢é‡å›¾å½¢çš„ä¸€ç§å›¾å½¢æ ¼å¼ï¼Œæ˜¯ç”±ä¸‡ç»´ç½‘è”ç›Ÿåˆ¶å®šçš„å¼€æ”¾æ ‡å‡†ã€‚SVG ä½¿ç”¨ XML æ ¼å¼æ¥å®šä¹‰å›¾å½¢ï¼Œå¯å°† SVG æ–‡æœ¬ç›´æ¥åµŒå…¥ HTML ä¸­æ˜¾ç¤ºã€‚</p>
<p>SVG æœ‰å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>SVG ç»˜åˆ¶çš„æ˜¯çŸ¢é‡å›¾ï¼Œå› æ­¤å¯¹å›¾åƒè¿›è¡Œæ”¾å¤§ä¸ä¼šå¤±çœŸã€‚</li>
<li>åŸºäº XMLï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå…ƒç´ æ·»åŠ  JavaScript äº‹ä»¶å¤„ç†å™¨ã€‚</li>
<li>æ¯ä¸ªå›¾å½¢å‡è§†ä¸ºå¯¹è±¡ï¼Œæ›´æ”¹å¯¹è±¡çš„å±æ€§ï¼Œå›¾å½¢ä¹Ÿä¼šæ”¹å˜ã€‚</li>
<li>ä¸é€‚åˆæ¸¸æˆåº”ç”¨ã€‚</li>
</ul>
<h3 id="è®¾ç½®æ¯”ä¾‹å°º"><a href="#è®¾ç½®æ¯”ä¾‹å°º" class="headerlink" title="è®¾ç½®æ¯”ä¾‹å°º"></a>è®¾ç½®æ¯”ä¾‹å°º</h3><p>ä¸ºä»€ä¹ˆè¦è®¾ç½®æ¯”ä¾‹å°ºï¼Ÿç›´æ¥ä½¿ç”¨è¾“å…¥çš„æ•°å€¼å½“æˆçŸ©å½¢çš„é•¿åº¦ å¦‚æœæ•°å€¼è¿‡å¤§æˆ–è¿‡å° å¯èƒ½ç”»å¸ƒæ²¡æœ‰è¿™ä¹ˆå¤§ï¼Œæˆ–è€…æ ¹æœ¬çœ‹ä¸è§ã€‚</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> linear = d3.scaleLinear()<span class="comment">//è¿”å›çº¿æ€§æ¯”ä¾‹å°º</span></span><br><span class="line">    .domain([<span class="number">0</span>, <span class="number">2500</span>])<span class="comment">// 0-2500 æ˜ å°„åˆ° 0-100</span></span><br><span class="line">    .range([<span class="number">0</span>, <span class="number">250</span>]);<span class="comment">//è¿™é‡Œ0 2500å¯¹åº”è¾“å…¥æ•°æ®çš„æœ€å°æœ€å¤§å€¼</span></span><br></pre></td></tr></table></figure>
<h3 id="ç”»å‡ºçŸ©å½¢"><a href="#ç”»å‡ºçŸ©å½¢" class="headerlink" title="ç”»å‡ºçŸ©å½¢"></a>ç”»å‡ºçŸ©å½¢</h3><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ äº†ä¸ data æ•°ç»„çš„é•¿åº¦ç›¸åŒæ•°é‡çš„çŸ©å½¢</span></span><br><span class="line">svg.selectAll(<span class="string">"rect"</span>)   <span class="comment">//é€‰æ‹©svgå†…æ‰€æœ‰çš„çŸ©å½¢</span></span><br><span class="line">    .data(<span class="keyword">this</span>.props.data)  <span class="comment">//ç»‘å®šæ•°ç»„</span></span><br><span class="line">    .enter()        <span class="comment">//æŒ‡å®šé€‰æ‹©é›†çš„enteréƒ¨åˆ†</span></span><br><span class="line">    .append(<span class="string">"rect"</span>) <span class="comment">//æ·»åŠ è¶³å¤Ÿæ•°é‡çš„çŸ©å½¢å…ƒç´  rectè¡¨ç¤ºçŸ©å½¢</span></span><br><span class="line">    <span class="comment">//è®¾ç½®å„ä¸ªçŸ©å½¢çš„åæ ‡å’Œé•¿å®½</span></span><br><span class="line">    .attr(<span class="string">"x"</span>, <span class="number">25</span>) <span class="comment">//æ¯ä¸ªçŸ©å½¢çš„xåæ ‡</span></span><br><span class="line">    .attr(<span class="string">"y"</span>, (d, i) =&gt; i * <span class="number">40</span>) <span class="comment">//æ¯ä¸ªçŸ©å½¢çš„yåæ ‡</span></span><br><span class="line">    <span class="comment">//å°†æ¯”ä¾‹å°ºåº”ç”¨åˆ°width</span></span><br><span class="line">    .attr(<span class="string">"width"</span>, (d, i) =&gt; &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"&#123;d,i&#125;"</span>, &#123; d, i &#125;)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"linear(d)"</span>, linear(d))</span><br><span class="line">        <span class="keyword">return</span> linear(d);</span><br><span class="line">        &#125;)</span><br><span class="line">    .attr(<span class="string">"height"</span>, <span class="number">25</span>)</span><br><span class="line">    <span class="comment">//è®¾ç½®é¢œè‰²</span></span><br><span class="line">    .attr(<span class="string">"fill"</span>, <span class="string">"#66ccff"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="ç”»å‡ºåæ ‡è½´"><a href="#ç”»å‡ºåæ ‡è½´" class="headerlink" title="ç”»å‡ºåæ ‡è½´"></a>ç”»å‡ºåæ ‡è½´</h3><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> g = svg.append(<span class="string">"g"</span>);</span><br><span class="line">    <span class="comment">//è®¾ç½®xè½´</span></span><br><span class="line">    g.append(<span class="string">"g"</span>)<span class="comment">//å®šä¹‰äº†åæ ‡è½´ä¹‹åï¼Œåªéœ€è¦åœ¨ SVG ä¸­æ·»åŠ ä¸€ä¸ªåˆ†ç»„å…ƒç´  &lt;g&gt;ï¼Œå†å°†åæ ‡è½´çš„å…¶ä»–å…ƒç´ æ·»åŠ åˆ°è¿™ä¸ª &lt;g&gt; é‡Œå³å¯</span></span><br><span class="line">        .attr(<span class="string">"transform"</span>, <span class="string">"translate(25,0)"</span>)<span class="comment">//åæ ‡è½´çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡ transform å±æ€§æ¥è®¾å®šã€‚</span></span><br><span class="line">        .call(</span><br><span class="line">            d3.axisBottom(linear)<span class="comment">//axisBottomè¡¨ç¤ºåˆ»åº¦å‘ä¸‹çš„åæ ‡è½´</span></span><br><span class="line">            .ticks(<span class="number">5</span>)<span class="comment">//åˆ»åº¦çš„æ•°é‡</span></span><br><span class="line">        );</span><br><span class="line">    <span class="comment">//è®¾ç½®yè½´</span></span><br><span class="line">    <span class="comment">// 	svg.append("g").call(axis); ç­‰ä»·äº  axis(svg.append(g));</span></span><br><span class="line">    g.append(<span class="string">"g"</span>)</span><br><span class="line">        .attr(<span class="string">"transform"</span>, <span class="string">"translate(25,0)"</span>)</span><br><span class="line">        .call(d3.axisLeft(linear).ticks(<span class="number">0</span>))</span><br></pre></td></tr></table></figure>
<h3 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h3><p>çœ‹åˆ°è¿™é‡Œæˆ–è®¸ä½ ä¼šå¯¹ react/g ã€ x/y/width/height/fill ä»¥åŠ svgåæ ‡ç³»äº§ç”Ÿå¥½å¥‡,è¿™é‡Œå°±æ¨è MDN çš„æ–‡æ¡£äº† :</p>
<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Element" target="_blank" rel="noopener">SVGå…ƒç´ å‚è€ƒ</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Attribute" target="_blank" rel="noopener">SVGå±æ€§å‚è€ƒ</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/SVG/Tutorial" target="_blank" rel="noopener">SVGæ•™ç¨‹</a></li>
</ul>
<p>å®Œæ•´ä»£ç  ï¼š <a href="https://github.com/sunyanyan/d3-start/blob/master/src/View/D3/QuickStart.js" target="_blank" rel="noopener">QuickStart.js</a></p>
<p>åœ¨çº¿æ¼”ç¤º ï¼š <a href="/d3start/#/quick-start">å¯è§†åŒ–å­¦ä¹ -quick-start</a></p>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>å¯è§†åŒ–D3æ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>å¯è§†åŒ–</tag>
        <tag>D3</tag>
      </tags>
  </entry>
  <entry>
    <title>xcodebuildå‘½ä»¤</title>
    <url>/quick-start/xcodebuild%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<blockquote>
<p>xcodebuild ç”Ÿæˆappä»¥åŠç”Ÿæˆipaæ–‡ä»¶ </p>
</blockquote>
<a id="more"></a>
<h1 id="xcodebuildå‘½ä»¤"><a href="#xcodebuildå‘½ä»¤" class="headerlink" title="xcodebuildå‘½ä»¤"></a>xcodebuildå‘½ä»¤</h1><h2 id="æŸ¥çœ‹ä¿¡æ¯"><a href="#æŸ¥çœ‹ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ä¿¡æ¯"></a>æŸ¥çœ‹ä¿¡æ¯</h2><h3 id="æŸ¥çœ‹xcodeçš„ç‰ˆæœ¬å·å’Œbuildç‰ˆæœ¬"><a href="#æŸ¥çœ‹xcodeçš„ç‰ˆæœ¬å·å’Œbuildç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹xcodeçš„ç‰ˆæœ¬å·å’Œbuildç‰ˆæœ¬"></a>æŸ¥çœ‹xcodeçš„ç‰ˆæœ¬å·å’Œbuildç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -version</span><br></pre></td></tr></table></figure>
<h3 id="æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„sdkã€åŠå…¶ç‰ˆæœ¬"><a href="#æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„sdkã€åŠå…¶ç‰ˆæœ¬" class="headerlink" title="æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„sdkã€åŠå…¶ç‰ˆæœ¬"></a>æ˜¾ç¤ºå½“å‰ç³»ç»Ÿçš„sdkã€åŠå…¶ç‰ˆæœ¬</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -showsdks</span><br></pre></td></tr></table></figure>
<h3 id="æ˜¾ç¤ºå·¥ç¨‹é¡¹ç›®ä¿¡æ¯"><a href="#æ˜¾ç¤ºå·¥ç¨‹é¡¹ç›®ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºå·¥ç¨‹é¡¹ç›®ä¿¡æ¯"></a>æ˜¾ç¤ºå·¥ç¨‹é¡¹ç›®ä¿¡æ¯</h3><p>å…ˆcdåˆ°å·¥ç¨‹ç›®å½•ä¸‹ï¼ˆæœ‰ï¼Š.xcodeprojçš„ç›®å½•ï¼Œæ¯”å¦‚MakeFileTest.xcodeprojï¼‰ï¼Œç„¶åè¾“å…¥å‘½ä»¤<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -list</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœæœªæŒ‡å®šConfigurationsï¼Œé»˜è®¤ä¸ºrelease</p>
<h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><h3 id="build"><a href="#build" class="headerlink" title="build"></a>build</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -sdk iphonesimulator5.0</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºä¸€å †ç¼–è¯‘è¿‡ç¨‹ï¼Œæœ€åè¾“å‡º<code>** BUILD SUCCEEDED **</code> è¡¨ç¤ºåˆ›å»ºæˆåŠŸï¼›è‹¥è¾“å‡º <code>** BUILD FAILED **</code>è¡¨ç¤ºåˆ›å»ºå¤±è´¥</p>
<blockquote>
<p>ä¸åœ¨xcodeä¸­ç¼–è¯‘ä¸åŒ ï¼ŒæˆåŠŸåä¼šåœ¨å½“å‰å·¥ç¨‹ç›®å½•ä¸‹åˆ›å»ºbuildç›®å½•<br>é»˜è®¤æ˜¯Releaseå·¥ç¨‹</p>
</blockquote>
<h3 id="clean"><a href="#clean" class="headerlink" title="clean"></a>clean</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild clean -sdk iphonesimulator5.0</span><br></pre></td></tr></table></figure>
<h3 id="å…¶ä»–å‚æ•°"><a href="#å…¶ä»–å‚æ•°" class="headerlink" title="å…¶ä»–å‚æ•°"></a>å…¶ä»–å‚æ•°</h3><blockquote>
<p>æœªæŒ‡å®štargeté»˜è®¤ç¼–è¯‘ç¬¬ä¸€ä¸ª<br>æœªæŒ‡å®šsdké»˜è®¤ç¼–è¯‘iphoneosç‰ˆæœ¬</p>
</blockquote>
<p>æŒ‡å®šTarget,æŒ‡å®šDebugæ¨¡å¼,æŒ‡å®šçœŸæœº<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -sdk iphoneos9.3 -target LAIQUSDKRes -configuration Debug</span><br></pre></td></tr></table></figure></p>
<p>æŒ‡å®šæ‰€æœ‰targetï¼ŒæŒ‡å®šDebug,æŒ‡å®šçœŸæœº<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -sdk iphoneos9.3 -alltargets -configuration Debug</span><br></pre></td></tr></table></figure></p>
<p>æŒ‡å®šå·¥ç¨‹,æŒ‡å®štarget,æŒ‡å®šarch<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -project wlle.xcodeproj -target LAIQUSDK -configuration Debug -sdk iphoneos9.3 ARCHS=<span class="string">'armv7 arm64'</span> VALID_ARCHS=<span class="string">'armv7 arm64'</span></span><br></pre></td></tr></table></figure></p>
<p>é«˜çº§ç”¨æ³•:ç»™åº”ç”¨ç­¾åã€‚ä¸Šé¢ä¸¤ä¸ªå‘½ä»¤éƒ½å¯ä»¥ç»™åº”ç”¨ç­¾åçš„ï¼Œæ ¼å¼åˆ†åˆ«æ˜¯:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -target targetName CODE_SIGN_IDENTITY=â€iPhone Distribution:XXXXXXâ€</span><br><span class="line">xcrun -sdk iphoneos PackageApplication -v æºappè·¯å¾„ -o è¾“å‡ºçš„ipaè·¯å¾„ â€“sign â€œiPhone Distribution:XXXXXXâ€</span><br></pre></td></tr></table></figure></p>
<h3 id="è‹¥å·¥ç¨‹å«æœ‰pod"><a href="#è‹¥å·¥ç¨‹å«æœ‰pod" class="headerlink" title="è‹¥å·¥ç¨‹å«æœ‰pod"></a>è‹¥å·¥ç¨‹å«æœ‰pod</h3><p>å‚è€ƒ<a href="http://stackoverflow.com/questions/23344617/xcodebuild-of-cocoapods-project-with-product-name-fails" target="_blank" rel="noopener">http://stackoverflow.com/questions/23344617/xcodebuild-of-cocoapods-project-with-product-name-fails</a></p>
<p>å…ˆç¼–è¯‘podså·¥ç¨‹æ‰€æœ‰target</p>
<p>å†ç¼–è¯‘ç›®æ ‡target</p>
<h1 id="ç”Ÿæˆipa"><a href="#ç”Ÿæˆipa" class="headerlink" title="ç”Ÿæˆipa"></a>ç”Ÿæˆipa</h1><p>æŸ¥åˆ°æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<h2 id="å°†buildç”Ÿæˆappæ–‡ä»¶å‹ç¼©æˆipaæ–‡ä»¶"><a href="#å°†buildç”Ÿæˆappæ–‡ä»¶å‹ç¼©æˆipaæ–‡ä»¶" class="headerlink" title="å°†buildç”Ÿæˆappæ–‡ä»¶å‹ç¼©æˆipaæ–‡ä»¶"></a>å°†buildç”Ÿæˆappæ–‡ä»¶å‹ç¼©æˆipaæ–‡ä»¶</h2><p>å‚è€ƒ: <a href="http://www.apblog.cn/blog/2013/10/18/ioskai-fa-zi-dong-gou-jian-zi-dong-da-bao/" target="_blank" rel="noopener">http://www.apblog.cn/blog/2013/10/18/ioskai-fa-zi-dong-gou-jian-zi-dong-da-bao/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ROOT_DIR=$(<span class="built_in">pwd</span>)/../Build    <span class="comment"># buildç›®å½•</span></span><br><span class="line">APP_PATH=<span class="variable">$ROOT_DIR</span>/Release-iphoneos/XCToolDemo.app</span><br><span class="line"><span class="comment"># å‹ç¼©æˆipaå®‰è£…åŒ…</span></span><br><span class="line"><span class="keyword">if</span> [ -a <span class="variable">$APP_PATH</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ Start ZIP To ipa ]"</span></span><br><span class="line">    mkdir <span class="string">"<span class="variable">$ROOT_DIR</span>/Payload"</span></span><br><span class="line">    rm <span class="string">"<span class="variable">$ROOT_DIR</span>/Demo.ipa"</span></span><br><span class="line">    cp -r <span class="string">"<span class="variable">$APP_PATH</span>"</span> <span class="string">"<span class="variable">$ROOT_DIR</span>/Payload"</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">"<span class="variable">$ROOT_DIR</span>"</span></span><br><span class="line">    zip -r <span class="string">"<span class="variable">$ROOT_DIR</span>/Demo.ipa"</span> <span class="string">"Payload"</span></span><br><span class="line">    rm -rf <span class="string">"<span class="variable">$ROOT_DIR</span>/Payload"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[ ZIP To ipa SUCCESS!! ]"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">".app file <span class="variable">$APP_PATH</span> not exist!!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h2 id="é€šè¿‡-xcrunè´Ÿè´£ç»™xxx-app-ç­¾åå¹¶-æ‰“åŒ…æˆxxx-ipa"><a href="#é€šè¿‡-xcrunè´Ÿè´£ç»™xxx-app-ç­¾åå¹¶-æ‰“åŒ…æˆxxx-ipa" class="headerlink" title="é€šè¿‡ xcrunè´Ÿè´£ç»™xxx.app(ç­¾åå¹¶)æ‰“åŒ…æˆxxx.ipa"></a>é€šè¿‡ xcrunè´Ÿè´£ç»™xxx.app(ç­¾åå¹¶)æ‰“åŒ…æˆxxx.ipa</h2><p>å‚è€ƒ:<a href="http://121.199.54.6/wordpress/?p=865" target="_blank" rel="noopener">http://121.199.54.6/wordpress/?p=865</a></p>
<p>ç¬¬ä¸€æ­¥æ¸…ç†:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/bin/xcodebuild -target targetName clean</span><br></pre></td></tr></table></figure></p>
<p>ç¬¬äºŒæ­¥ç¼–è¯‘:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/bin/xcodebuild -target targetName</span><br></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸‰æ­¥æ‰“åŒ…:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/usr/bin/xcrun -sdk iphoneos PackageApplication -v path/To/xxx.app -o xxx.ipa</span><br></pre></td></tr></table></figure></p>
<h2 id="å…ˆç”ŸæˆarchiveåŒ…å†ç”ŸæˆipaåŒ…"><a href="#å…ˆç”ŸæˆarchiveåŒ…å†ç”ŸæˆipaåŒ…" class="headerlink" title="å…ˆç”ŸæˆarchiveåŒ…å†ç”ŸæˆipaåŒ…"></a>å…ˆç”ŸæˆarchiveåŒ…å†ç”ŸæˆipaåŒ…</h2><p>å‚è€ƒ :<a href="http://www.voidcn.com/blog/potato512/article/p-6150876.html" target="_blank" rel="noopener">http://www.voidcn.com/blog/potato512/article/p-6150876.html</a></p>
<p>1ã€ç”ŸæˆarchiveåŒ…<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// ä½¿ç”¨podç®¡ç†ç¬¬ä¸‰æ–¹</span><br><span class="line">xcodebuild archive -workspace é¡¹ç›®åç§°.xcworkspace -scheme é¡¹ç›®åç§° -configuration Release -archivePath archiveåŒ…å­˜å‚¨è·¯å¾„ CODE_SIGN_IDENTITY=è¯ä¹¦ PROVISIONING_PROFILE=æè¿°æ–‡ä»¶UUID</span><br><span class="line">// æœªä½¿ç”¨podç®¡ç†ç¬¬ä¸‰æ–¹</span><br><span class="line">xcodebuild archive -project é¡¹ç›®åç§°.xcodeproj -scheme é¡¹ç›®åç§° -configuration Release -archivePath archiveåŒ…å­˜å‚¨è·¯å¾„ CODE_SIGN_IDENTITY=è¯ä¹¦ PROVISIONING_PROFILE=æè¿°æ–‡ä»¶UUID</span><br></pre></td></tr></table></figure></p>
<p>2ã€ç”ŸæˆipaåŒ…<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xcodebuild -exportArchive -exportFormat ipaæ–‡ä»¶æ ¼å¼ -archivePath archiveåŒ…å­˜å‚¨è·¯å¾„ -exportPath ipaåŒ…å­˜å‚¨è·¯å¾„  -exportProvisioningProfile æè¿°æ–‡ä»¶åç§°</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>create-react-appæ•™ç¨‹-æºç ç¯‡</title>
    <url>/quick-start/create-react-app%E6%95%99%E7%A8%8B-%E6%BA%90%E7%A0%81%E7%AF%87/</url>
    <content><![CDATA[<blockquote class="blockquote-center"><p>ä¹‹å‰åœ¨ <a href="../create-react-appæ•™ç¨‹-ä½¿ç”¨ç¯‡/">create-react-appæ•™ç¨‹-ä½¿ç”¨ç¯‡</a> ä¸­ä»‹ç»äº†create-react-appçš„åŸºæœ¬ä½¿ç”¨ï¼Œ<br>ä¸ºäº†ä¾¿äºç†è§£ä¸€ä¸ªè„šæ‰‹æ¶è„šæœ¬æ˜¯å¦‚ä½•è¿ä½œçš„ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹ create-react-app v1.5.2 çš„æºç </p>
</blockquote>
<h2 id="å…¥å£index-js"><a href="#å…¥å£index-js" class="headerlink" title="å…¥å£index.js"></a>å…¥å£index.js</h2><p>create-react-app ä¸€èˆ¬ä¼šä½œä¸ºå…¨å±€å‘½ä»¤ï¼Œå› ä¸ºä¾¿äºæ›´æ–°ç­‰åŸå› ï¼Œcreate-react-app åªä¼šåšåˆå§‹åŒ–ä»“åº“ æ‰§è¡Œå½“å‰ç‰ˆæœ¬å‘½ä»¤ç­‰æ“ä½œã€‚</p>
<p>æ‰¾åˆ° <code>create-react-app</code> å…¥å£indexæ–‡ä»¶ï¼š<br><a id="more"></a><br><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> chalk = <span class="built_in">require</span>(<span class="string">'chalk'</span>);</span><br><span class="line"><span class="comment">// è¿”å›Nodeç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚æœæœ‰å¤šä¸ªç‰ˆæœ¬è¿”å›å¤šä¸ªç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">var</span> currentNodeVersion = process.versions.node; </span><br><span class="line"><span class="keyword">var</span> semver = currentNodeVersion.split(<span class="string">'.'</span>);</span><br><span class="line"><span class="keyword">var</span> major = semver[<span class="number">0</span>];<span class="comment">// å–å‡ºç¬¬ä¸€ä¸ªNodeç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line"><span class="comment">//å°äº 4.xçš„æç¤ºå¹¶ç»ˆæ­¢ç¨‹åº</span></span><br><span class="line"><span class="keyword">if</span> (major &lt; <span class="number">4</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(</span><br><span class="line">    chalk.red(</span><br><span class="line">      <span class="string">'You are running Node '</span> +</span><br><span class="line">        currentNodeVersion +</span><br><span class="line">        <span class="string">'.\n'</span> +</span><br><span class="line">        <span class="string">'Create React App requires Node 4 or higher. \n'</span> +</span><br><span class="line">        <span class="string">'Please update your version of Node.'</span></span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ²¡æœ‰å°äº4å°±å¼•å…¥ä»¥ä¸‹æ–‡ä»¶ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'./createReactApp'</span>);</span><br></pre></td></tr></table></figure></p>
<p>å¯ä»¥çœ‹åˆ° index æ–‡ä»¶æ²¡æœ‰åšä»€ä¹ˆï¼Œåªæ˜¯åšä¸ºä¸€ä¸ªå…¥å£æ–‡ä»¶åˆ¤æ–­ä¸€ä¸‹ nodeç‰ˆæœ¬ï¼Œå°äº 4.xçš„æç¤ºå¹¶ç»ˆæ­¢ç¨‹åºï¼Œ å¦‚æœæ­£å¸¸åˆ™åŠ è½½ ./createReactApp è¿™ä¸ªæ–‡ä»¶ï¼Œä¸»è¦çš„é€»è¾‘åœ¨è¯¥æ–‡ä»¶å®ç°ã€‚</p>
<h2 id="createReactApp-js"><a href="#createReactApp-js" class="headerlink" title="createReactApp.js"></a>createReactApp.js</h2><p>è™½ç„¶ createReactApp.js æœ‰751è¡Œï¼Œä½†æ˜¯é‡Œé¢æœ‰ä¸€å¤§åŠæ˜¯æ³¨é‡Šå’Œé”™è¯¯å‹å¥½ä¿¡æ¯ã€‚</p>
<p>é™¤äº†å£°æ˜çš„ä¾èµ–ã€‚è·Ÿç€æ‰§è¡Œé¡ºåºå…ˆçœ‹åˆ°çš„æ˜¯ç¬¬56è¡Œ <code>program</code>  ï¼Œ</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> program = <span class="keyword">new</span> commander.Command(packageJson.name)</span><br><span class="line">  .version(packageJson.version)<span class="comment">// create-react-app -v æ—¶è¾“å‡º $&#123;packageJson.version&#125;</span></span><br><span class="line">  .arguments(<span class="string">'&lt;project-directory&gt;'</span>)<span class="comment">// è¿™é‡Œç”¨&lt;&gt; åŒ…ç€project-directory è¡¨ç¤º project-directoryä¸ºå¿…å¡«é¡¹</span></span><br><span class="line">  .usage(<span class="string">`<span class="subst">$&#123;chalk.green(<span class="string">'&lt;project-directory&gt;'</span>)&#125;</span> [options]`</span>)<span class="comment">// ç”¨ç»¿è‰²å­—ä½“è¾“å‡º &lt;project-directory&gt;</span></span><br><span class="line">  .action(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">    projectName = name;</span><br><span class="line">  &#125;)<span class="comment">// è·å–ç”¨æˆ·ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸º projectName</span></span><br><span class="line">  .option(<span class="string">'--verbose'</span>, <span class="string">'print additional logs'</span>)</span><br><span class="line">  <span class="comment">// optionç”¨äºé…ç½®`create-react-app -[option]`çš„é€‰é¡¹ï¼Œ</span></span><br><span class="line">  <span class="comment">//æ¯”å¦‚è¿™é‡Œå¦‚æœç”¨æˆ·å‚æ•°å¸¦äº† --verboseï¼Œ ä¼šè‡ªåŠ¨è®¾ç½®program.verbose = true;</span></span><br><span class="line">  .option(<span class="string">'--info'</span>, <span class="string">'print environment debug info'</span>)</span><br><span class="line">  <span class="comment">// infoï¼Œç”¨äºæ‰“å°å‡ºç¯å¢ƒè°ƒè¯•çš„ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">  .option(</span><br><span class="line">    <span class="string">'--scripts-version &lt;alternative-package&gt;'</span>,</span><br><span class="line">    <span class="string">'use a non-standard version of react-scripts'</span></span><br><span class="line">  )</span><br><span class="line">  .option(<span class="string">'--use-npm'</span>)<span class="comment">// é»˜è®¤ä½¿ç”¨`yarn`ï¼ŒæŒ‡å®šä½¿ç”¨`npm`</span></span><br><span class="line">  .allowUnknownOption()</span><br><span class="line">  .on(<span class="string">'--help'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">//help ä¿¡æ¯</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .parse(process.argv);<span class="comment">// è§£æä¼ å…¥çš„å‚æ•°</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨åˆ° <code>commander</code> çš„ä¾èµ–ï¼Œè¿™æ˜¯ node.js å‘½ä»¤è¡Œæ¥å£çš„è§£å†³æ–¹æ¡ˆï¼Œæ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ å¤„ç†ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼Œè¾“å‡ºå‹å¥½çš„æç¤ºä¿¡æ¯ç­‰ã€‚</p>
<p>æ¥ç€åˆ°äº†ç¬¬109è¡Œï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ²¡æœ‰è¾“å…¥projectNameçš„è¯,è¾“å‡ºä¸€äº›æç¤ºä¿¡æ¯å°±ç»ˆæ­¢ç¨‹åº</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> projectName === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (program.info) &#123;<span class="comment">// å¦‚æœå‚æ•°è¾“å…¥äº† --info,å°±ä¼šè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">    envinfo.print(&#123;<span class="comment">// envinfo æ˜¯ä¸€ä¸ªç”¨æ¥è¾“å‡ºå½“å‰ç¯å¢ƒç³»ç»Ÿçš„è€Œä¸€äº›ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line">      packages: [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, <span class="string">'react-scripts'</span>],</span><br><span class="line">      noNativeIDE: <span class="literal">true</span>,</span><br><span class="line">      duplicates: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    process.exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//ç•¥å»éƒ¨åˆ†log...</span></span><br><span class="line">  process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ projectName å°±æ˜¯æˆ‘ä»¬è¦åˆ›å»ºçš„webåº”ç”¨åç§°ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥çš„è¯,è¾“å‡ºä¸€äº›æç¤ºä¿¡æ¯å°±ç»ˆæ­¢ç¨‹åºã€‚</p>
<h3 id="createApp-æ£€æµ‹åˆ¤æ–­"><a href="#createApp-æ£€æµ‹åˆ¤æ–­" class="headerlink" title="createApp æ£€æµ‹åˆ¤æ–­"></a>createApp æ£€æµ‹åˆ¤æ–­</h3><p>ç„¶ååˆ°äº†ç¬¬148è¡Œ æ‰§è¡Œ<code>createApp</code>ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">createApp(</span><br><span class="line">  projectName,<span class="comment">//é¡¹ç›®åç§° </span></span><br><span class="line">  program.verbose, <span class="comment">//æ˜¯å¦æš‘ä¿ƒé¢å¤–ä¿¡æ¯</span></span><br><span class="line">  program.scriptsVersion, <span class="comment">//ä¼ å…¥çš„è„šæœ¬ç‰ˆæœ¬</span></span><br><span class="line">  program.useNpm, <span class="comment">//æ˜¯å¦ä½¿ç”¨npm</span></span><br><span class="line">  hiddenProgram.internalTestingTemplate <span class="comment">//è°ƒè¯•çš„æ¨¡æ¿è·¯å¾„ï¼Œè¿™ä¸ªä¸ç®¡å®ƒï¼Œç»™å¼€å‘äººå‘˜è°ƒè¯•ç”¨çš„â€¦â€¦</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params">name, verbose, version, useNpm, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = path.resolve(name);<span class="comment">// è·å–å½“å‰è¿›ç¨‹è¿è¡Œçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ç›®å½•çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">  <span class="keyword">const</span> appName = path.basename(root);<span class="comment">// è¿”å›rootè·¯å¾„ä¸‹æœ€åä¸€éƒ¨åˆ†</span></span><br><span class="line"></span><br><span class="line">  checkAppName(appName);<span class="comment">// æ£€æŸ¥ä¼ å…¥çš„é¡¹ç›®ååˆæ³•æ€§</span></span><br><span class="line">  fs.ensureDirSync(name);<span class="comment">//è¿™é‡Œçš„ fs = require('fs-extra');</span></span><br><span class="line">  <span class="keyword">if</span> (!isSafeToCreateProjectIn(root, name)) &#123;</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†™å…¥ package.json æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">const</span> packageJson = &#123;</span><br><span class="line">    name: appName,</span><br><span class="line">    version: <span class="string">'0.1.0'</span>,</span><br><span class="line">    private: <span class="literal">true</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  fs.writeFileSync(</span><br><span class="line">    path.join(root, <span class="string">'package.json'</span>),</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(packageJson, <span class="literal">null</span>, <span class="number">2</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> useYarn = useNpm ? <span class="literal">false</span> : shouldUseYarn();</span><br><span class="line">  <span class="keyword">const</span> originalDirectory = process.cwd();</span><br><span class="line">  process.chdir(root);<span class="comment">// åœ¨è¿™é‡Œå°±æŠŠè¿›ç¨‹ç›®å½•ä¿®æ”¹ä¸ºäº†æˆ‘ä»¬åˆ›å»ºçš„ç›®å½•</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ä½¿ç”¨npmï¼Œæ£€æŸ¥npmæ˜¯å¦èƒ½æ­£å¸¸æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (!useYarn &amp;&amp; !checkThatNpmCanReadCwd()) &#123;</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è¿™é‡Œçš„ semver = require('semver'); åšç‰ˆæœ¬å¤„ç†çš„</span></span><br><span class="line">  <span class="comment">//å¦‚æœnodeç‰ˆæœ¬ä¸ç¬¦åˆè¦æ±‚å°±ä½¿ç”¨æ—§ç‰ˆæœ¬çš„ react-scripts</span></span><br><span class="line">  <span class="keyword">if</span> (!semver.satisfies(process.version, <span class="string">'&gt;=6.0.0'</span>)) &#123;</span><br><span class="line">    <span class="comment">//ç•¥å»logä¿¡æ¯...</span></span><br><span class="line">    <span class="comment">// Fall back to latest supported react-scripts on Node 4</span></span><br><span class="line">    version = <span class="string">'react-scripts@0.9.x'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœnpmç‰ˆæœ¬å°äº3.xï¼Œä½¿ç”¨æ—§ç‰ˆçš„ react-scripts</span></span><br><span class="line">  <span class="keyword">if</span> (!useYarn) &#123;</span><br><span class="line">    <span class="keyword">const</span> npmInfo = checkNpmVersion();</span><br><span class="line">    <span class="keyword">if</span> (!npmInfo.hasMinNpm) &#123;</span><br><span class="line">      <span class="comment">//ç•¥å»logä¿¡æ¯...</span></span><br><span class="line">      <span class="comment">// Fall back to latest supported react-scripts for npm 3</span></span><br><span class="line">      version = <span class="string">'react-scripts@0.9.x'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ç»“æŸä¹‹åï¼Œæ‰§è¡Œ run æ–¹æ³•</span></span><br><span class="line">  run(root, appName, version, verbose, originalDirectory, template, useYarn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥äº†è§£åˆ° createApp ä¸»è¦åšçš„äº‹æƒ…å°±æ˜¯åšä¸€äº›å®‰å…¨åˆ¤æ–­æ¯”å¦‚ï¼šæ£€æŸ¥é¡¹ç›®åæ˜¯å¦åˆæ³•ï¼Œæ£€æŸ¥æ–°å»ºçš„è¯æ˜¯å¦å®‰å…¨ï¼Œæ£€æŸ¥npmç‰ˆæœ¬ï¼Œå¤„ç†react-scriptçš„ç‰ˆæœ¬å…¼å®¹ã€‚ç„¶åçœ‹ä¸‹åœ¨<code>createApp</code>ä¸­ç”¨åˆ°çš„ <code>checkAppName</code></p>
<h4 id="checkAppName-æ£€æŸ¥é¡¹ç›®å"><a href="#checkAppName-æ£€æŸ¥é¡¹ç›®å" class="headerlink" title="checkAppName æ£€æŸ¥é¡¹ç›®å"></a>checkAppName æ£€æŸ¥é¡¹ç›®å</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAppName</span>(<span class="params">appName</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//è¿™é‡Œ validateProjectName = require('validate-npm-package-name');</span></span><br><span class="line">  <span class="comment">//å¯ä»¥ç”¨æ¥åˆ¤æ–­å½“å‰çš„é¡¹ç›®åæ˜¯å¦ç¬¦åˆnpmè§„èŒƒ æ¯”å¦‚ä¸èƒ½å¤§å†™ç­‰</span></span><br><span class="line">  <span class="keyword">const</span> validationResult = validateProjectName(appName);</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦ç¬¦åˆnpmè§„èŒƒå¦‚æœä¸ç¬¦åˆï¼Œè¾“å‡ºæç¤ºå¹¶ç»“æŸä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> (!validationResult.validForNewPackages) &#123;</span><br><span class="line">    <span class="comment">//ç•¥å»logä¿¡æ¯...</span></span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dependencies = [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, <span class="string">'react-scripts'</span>].sort();</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ˜¯å¦é‡åï¼Œå¦‚æœé‡ååˆ™è¾“å‡ºæç¤ºå¹¶ç»“æŸä»»åŠ¡</span></span><br><span class="line">  <span class="keyword">if</span> (dependencies.indexOf(appName) &gt;= <span class="number">0</span>) &#123;    </span><br><span class="line">    <span class="comment">//ç•¥å»logä¿¡æ¯...</span></span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="run-å®‰è£…ä¾èµ–æ‹·è´æ¨¡ç‰ˆ"><a href="#run-å®‰è£…ä¾èµ–æ‹·è´æ¨¡ç‰ˆ" class="headerlink" title="run å®‰è£…ä¾èµ–æ‹·è´æ¨¡ç‰ˆ"></a>run å®‰è£…ä¾èµ–æ‹·è´æ¨¡ç‰ˆ</h3><p>åœ¨ createApp æ–¹æ³•ä½“å†…è°ƒç”¨äº†runæ–¹æ³•ï¼Œrunæ–¹æ³•ä½“å†…å®Œæˆä¸»è¦çš„å®‰è£…ä¾èµ– æ‹·è´æ¨¡æ¿ç­‰åŠŸèƒ½ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">root,appName,version,verbose,originalDirectory,template,useYarn</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œè·å–è¦å®‰è£…çš„packageï¼Œ</span></span><br><span class="line">  <span class="comment">//    getInstallPackage é»˜è®¤æƒ…å†µä¸‹packageToInstallæ˜¯ `react-scripts`ã€‚</span></span><br><span class="line">  <span class="comment">//    ä¹Ÿå¯èƒ½æ˜¯æ ¹æ®å»æœ¬åœ°æ‹¿åˆ°å¯¹åº”çš„package</span></span><br><span class="line">  <span class="comment">//    react-scriptsæ˜¯ä¸€ç³»åˆ—çš„webpacké…ç½®ä¸æ¨¡ç‰ˆ</span></span><br><span class="line">  <span class="keyword">const</span> packageToInstall = getInstallPackage(version, originalDirectory);</span><br><span class="line">  <span class="comment">// éœ€è¦å®‰è£…æ‰€æœ‰çš„ä¾èµ–</span></span><br><span class="line">  <span class="keyword">const</span> allDependencies = [<span class="string">'react'</span>, <span class="string">'react-dom'</span>, packageToInstall];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getPackageName è·å–ä¾èµ–åŒ…åŸå§‹åç§°å¹¶è¿”å›</span></span><br><span class="line">  getPackageName(packageToInstall)</span><br><span class="line">    .then(<span class="function"><span class="params">packageName</span> =&gt;</span></span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯yarn,åˆ¤æ–­æ˜¯å¦åœ¨çº¿æ¨¡å¼ï¼ˆå¯¹åº”çš„å°±æ˜¯ç¦»çº¿æ¨¡å¼ï¼‰ï¼Œå¤„ç†å®Œåˆ¤æ–­å°±è¿”å›ç»™ä¸‹ä¸€ä¸ªthenå¤„ç†</span></span><br><span class="line">      checkIfOnline(useYarn).then(<span class="function"><span class="params">isOnline</span> =&gt;</span> (&#123;</span><br><span class="line">        isOnline: isOnline,</span><br><span class="line">        packageName: packageName,</span><br><span class="line">      &#125;))</span><br><span class="line">    )</span><br><span class="line">    .then(<span class="function"><span class="params">info</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> isOnline = info.isOnline;</span><br><span class="line">      <span class="keyword">const</span> packageName = info.packageName;</span><br><span class="line">      <span class="comment">//ç•¥å»logä¿¡æ¯...      </span></span><br><span class="line">      <span class="comment">//ä¼ å‚æ•°ç»™install è´Ÿè´£å®‰è£… allDependencies</span></span><br><span class="line">      <span class="keyword">return</span> install(root, useYarn, allDependencies, verbose, isOnline).then(</span><br><span class="line">        () =&gt; packageName</span><br><span class="line">      );</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">packageName</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//æ£€æŸ¥å½“å‰ç¯å¢ƒè¿è¡Œçš„nodeç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚</span></span><br><span class="line">      checkNodeVersion(packageName);</span><br><span class="line">      <span class="comment">//ä¿®æ”¹react, react-domçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œå°†å‡†ç¡®ç‰ˆæœ¬ä¿¡æ¯æ”¹ä¸ºé«˜äºç­‰äºç‰ˆæœ¬</span></span><br><span class="line">      <span class="comment">//    ä¾‹å¦‚ 15.0.0 =&gt; ^15.0.0</span></span><br><span class="line">      setCaretRangeForRuntimeDeps(packageName);</span><br><span class="line">      <span class="comment">// `react-scripts`è„šæœ¬çš„ç›®å½•</span></span><br><span class="line">      <span class="keyword">const</span> scriptsPath = path.resolve(</span><br><span class="line">        process.cwd(),</span><br><span class="line">        <span class="string">'node_modules'</span>,</span><br><span class="line">        packageName,</span><br><span class="line">        <span class="string">'scripts'</span>,</span><br><span class="line">        <span class="string">'init.js'</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> init = <span class="built_in">require</span>(scriptsPath);</span><br><span class="line">      <span class="comment">//è°ƒç”¨å®‰è£…äº†çš„ react-scripts/script/init å»æ‹·è´æ¨¡ç‰ˆ</span></span><br><span class="line">      init(root, appName, verbose, originalDirectory, template);</span><br><span class="line">      <span class="comment">//ç•¥å»logä¿¡æ¯...  </span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    .catch(<span class="function"><span class="params">reason</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// å‡ºé”™çš„è¯ï¼ŒæŠŠå®‰è£…äº†çš„æ–‡ä»¶å…¨åˆ äº† å¹¶è¾“å‡ºä¸€äº›æ—¥å¿—ä¿¡æ¯ç­‰</span></span><br><span class="line">      <span class="comment">// é”™è¯¯å¤„ç† ç•¥</span></span><br><span class="line">      process.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çŒœåˆ°å…¶ä¸­æœ€é‡è¦çš„é€»è¾‘æ˜¯ <code>install</code> å®‰è£…ä¾èµ–å’Œ <code>init</code> æ‹·è´æ¨¡æ¿ã€‚</p>
<h3 id="install-å®‰è£…ä¾èµ–"><a href="#install-å®‰è£…ä¾èµ–" class="headerlink" title="install  å®‰è£…ä¾èµ–"></a>install  å®‰è£…ä¾èµ–</h3><p>install æ–¹æ³•ä½“ä¸­æ˜¯æ ¹æ®å‚æ•°æ‹¼è£…å‘½ä»¤è¡Œï¼Œç„¶åç”¨nodeå»è·‘å®‰è£…è„šæœ¬ ï¼Œæ‰§è¡Œå®Œæˆåè¿”å›ä¸€ä¸ª Promise</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">root, useYarn, dependencies, verbose, isOnline</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> command;</span><br><span class="line">    <span class="keyword">let</span> args;</span><br><span class="line">    <span class="comment">// å‚æ•°æ‹¼è£…å‘½ä»¤è¡Œï¼Œ</span></span><br><span class="line">    <span class="comment">//    ä¾‹å¦‚ ä½¿ç”¨yarn ï¼š `yarn add react react-dom`</span></span><br><span class="line">    <span class="comment">//    æˆ– ä½¿ç”¨npm ï¼š `npm install react react-dom --save` </span></span><br><span class="line">    <span class="keyword">if</span> (useYarn) &#123;</span><br><span class="line">      command = <span class="string">'yarnpkg'</span>;</span><br><span class="line">      args = [<span class="string">'add'</span>, <span class="string">'--exact'</span>];</span><br><span class="line">      <span class="keyword">if</span> (!isOnline) &#123;</span><br><span class="line">        args.push(<span class="string">'--offline'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      [].push.apply(args, dependencies);</span><br><span class="line">      args.push(<span class="string">'--cwd'</span>);</span><br><span class="line">      args.push(root);</span><br><span class="line">      <span class="comment">//ç•¥å»logä¿¡æ¯... </span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      command = <span class="string">'npm'</span>;</span><br><span class="line">      args = [</span><br><span class="line">        <span class="string">'install'</span>,</span><br><span class="line">        <span class="string">'--save'</span>,</span><br><span class="line">        <span class="string">'--save-exact'</span>,</span><br><span class="line">        <span class="string">'--loglevel'</span>,</span><br><span class="line">        <span class="string">'error'</span>,</span><br><span class="line">      ].concat(dependencies);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">      args.push(<span class="string">'--verbose'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç„¶åç”¨nodeå»è·‘å®‰è£…è„šæœ¬ </span></span><br><span class="line">    <span class="comment">//è¿™é‡Œ spawn = require('cross-spawn'); å‡ºæ¥å¤„ç†å¹³å°å·®å¼‚</span></span><br><span class="line">    <span class="keyword">const</span> child = spawn(command, args, &#123; <span class="attr">stdio</span>: <span class="string">'inherit'</span> &#125;);</span><br><span class="line">    child.on(<span class="string">'close'</span>, code =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (code !== <span class="number">0</span>) &#123;</span><br><span class="line">        reject(&#123;</span><br><span class="line">          command: <span class="string">`<span class="subst">$&#123;command&#125;</span> <span class="subst">$&#123;args.join(<span class="string">' '</span>)&#125;</span>`</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      resolve();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="init-æ‹·è´æ¨¡æ¿"><a href="#init-æ‹·è´æ¨¡æ¿" class="headerlink" title="init æ‹·è´æ¨¡æ¿"></a><code>init</code> æ‹·è´æ¨¡æ¿</h3><p>init æ–¹æ³•é»˜è®¤æ˜¯åœ¨ ã€å½“å‰webé¡¹ç›®è·¯å¾„ã€‘/node_modules/react-scripts/script/init.js ä¸­ ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  appPath,</span></span></span><br><span class="line"><span class="function"><span class="params">  appName,</span></span></span><br><span class="line"><span class="function"><span class="params">  verbose,</span></span></span><br><span class="line"><span class="function"><span class="params">  originalDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">  template</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ownPath = path.dirname(</span><br><span class="line">    <span class="built_in">require</span>.resolve(path.join(__dirname, <span class="string">'..'</span>, <span class="string">'package.json'</span>))</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> appPackage = <span class="built_in">require</span>(path.join(appPath, <span class="string">'package.json'</span>));</span><br><span class="line">  <span class="keyword">const</span> useYarn = fs.existsSync(path.join(appPath, <span class="string">'yarn.lock'</span>));</span><br><span class="line">  appPackage.dependencies = appPackage.dependencies || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> useTypeScript = appPackage.dependencies[<span class="string">'typescript'</span>] != <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®package.json ä¸­ scripts/eslint/browserslist ä¿¡æ¯</span></span><br><span class="line">  appPackage.scripts = &#123;</span><br><span class="line">    start: <span class="string">'react-scripts start'</span>,</span><br><span class="line">    build: <span class="string">'react-scripts build'</span>,</span><br><span class="line">    test: <span class="string">'react-scripts test'</span>,</span><br><span class="line">    eject: <span class="string">'react-scripts eject'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  appPackage.eslintConfig = &#123;</span><br><span class="line">    extends: <span class="string">'react-app'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  appPackage.browserslist = defaultBrowsers;</span><br><span class="line"></span><br><span class="line">  fs.writeFileSync(</span><br><span class="line">    path.join(appPath, <span class="string">'package.json'</span>),</span><br><span class="line">    <span class="built_in">JSON</span>.stringify(appPackage, <span class="literal">null</span>, <span class="number">2</span>) + os.EOL</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå·²æœ‰ README.md åˆ™é‡å‘½å</span></span><br><span class="line">  <span class="keyword">const</span> readmeExists = fs.existsSync(path.join(appPath, <span class="string">'README.md'</span>));</span><br><span class="line">  <span class="keyword">if</span> (readmeExists) &#123;</span><br><span class="line">    fs.renameSync(</span><br><span class="line">      path.join(appPath, <span class="string">'README.md'</span>),</span><br><span class="line">      path.join(appPath, <span class="string">'README.old.md'</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æŠŠé¢„è®¾çš„æ¨¡ç‰ˆæ‹·è´åˆ°é¡¹ç›®ä¸‹</span></span><br><span class="line">  <span class="comment">//  å¯ä»¥åœ¨ react-scripts/template çœ‹åˆ°è¿™äº›æ–‡ä»¶ publicç›®å½• srcç›®å½• gitignore README.md</span></span><br><span class="line">  <span class="keyword">const</span> templatePath = template</span><br><span class="line">    ? path.resolve(originalDirectory, template)</span><br><span class="line">    : path.join(ownPath, useTypeScript ? <span class="string">'template-typescript'</span> : <span class="string">'template'</span>);</span><br><span class="line">  <span class="keyword">if</span> (fs.existsSync(templatePath)) &#123;</span><br><span class="line">    fs.copySync(templatePath, appPath);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      <span class="string">`Could not locate supplied template: <span class="subst">$&#123;chalk.green(templatePath)&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå‘ç°æ²¡æœ‰å®‰è£…reactå’Œreact-dom,é‡æ–°å®‰è£…ä¸€æ¬¡ ä»£ç ç•¥</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Install additional template dependencies, if present</span></span><br><span class="line">  <span class="comment">//ç•¥å»logä¿¡æ¯... </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç®€åŒ–ä¸€ä¸‹é€»è¾‘è¿™é‡Œçš„ä¸»è¦å†…å®¹å°±æ˜¯ ä¿®æ”¹package.jsonä¿¡æ¯å’Œæ‹·è´æ¨¡æ¿æ–‡ä»¶</p>
<p>~END~</p>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>create-react-appæ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>å‰ç«¯å·¥ç¨‹åŒ–</tag>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title>(è½¬)æµè§ˆå™¨çš„å·¥ä½œåŸç†-ç°ä»£æµè§ˆå™¨å¹•å</title>
    <url>/essay/(%E8%BD%AC)%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E7%8E%B0%E4%BB%A3%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B9%95%E5%90%8E/</url>
    <content><![CDATA[<blockquote>
<p>åŸæ–‡åœ°å€ï¼š <a href="https://www.html5rocks.com/en/tutorials/internals/howbrowserswork/" target="_blank" rel="noopener">How Browsers Work: Behind the scenes of modern web browsers</a></p>
</blockquote>
<center><strong>åºè¨€</strong></center>

<p>è¿™æ˜¯ä¸€ç¯‡å…¨é¢ä»‹ç» WebKit å’Œ Gecko å†…éƒ¨æ“ä½œçš„å…¥é—¨æ–‡ç« ï¼Œæ˜¯ä»¥è‰²åˆ—å¼€å‘äººå‘˜å¡”åˆ©Â·åŠ å¸Œå°”å¤§é‡ç ”ç©¶çš„æˆæœã€‚åœ¨è¿‡å»çš„å‡ å¹´ä¸­ï¼Œå¥¹æŸ¥é˜…äº†æ‰€æœ‰å…¬å¼€å‘å¸ƒçš„å…³äºæµè§ˆå™¨å†…éƒ¨æœºåˆ¶çš„æ•°æ®ï¼ˆè¯·å‚è§èµ„æºï¼‰ï¼Œå¹¶èŠ±äº†å¾ˆå¤šæ—¶é—´æ¥ç ”è¯»ç½‘ç»œæµè§ˆå™¨çš„æºä»£ç ã€‚å¥¹å†™é“ï¼š</p>
<p>åœ¨ IE å æ® 90% å¸‚åœºä»½é¢çš„å¹´ä»£ï¼Œæˆ‘ä»¬é™¤äº†æŠŠæµè§ˆå™¨å½“æˆä¸€ä¸ªâ€œé»‘ç®±â€ï¼Œä»€ä¹ˆä¹Ÿåšä¸äº†ã€‚ä½†æ˜¯ç°åœ¨ï¼Œå¼€æ”¾æºä»£ç çš„æµè§ˆå™¨æ‹¥æœ‰äº†è¿‡åŠçš„å¸‚åœºä»½é¢ï¼Œå› æ­¤ï¼Œæ˜¯æ—¶å€™æ¥æ­å¼€ç¥ç§˜çš„é¢çº±ï¼Œä¸€æ¢ç½‘ç»œæµè§ˆå™¨çš„å†…å¹•äº†ã€‚å‘ƒï¼Œé‡Œé¢åªæœ‰æ•°ä»¥ç™¾ä¸‡è¡Œè®¡çš„ C++ ä»£ç â€¦</p>
<p>å¡”åˆ©åœ¨å¥¹çš„ç½‘ç«™ä¸Šå…¬å¸ƒäº†è‡ªå·±çš„ç ”ç©¶æˆæœï¼Œä½†æ˜¯æˆ‘ä»¬è§‰å¾—å®ƒå€¼å¾—è®©æ›´å¤šçš„äººæ¥äº†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­¤é‡æ–°æ•´ç†å¹¶å…¬å¸ƒã€‚</p>
<p>ä½œä¸ºä¸€åç½‘ç»œå¼€å‘äººå‘˜ï¼Œå­¦ä¹ æµè§ˆå™¨çš„å†…éƒ¨å·¥ä½œåŸç†å°†æœ‰åŠ©äºæ‚¨ä½œå‡ºæ›´æ˜æ™ºçš„å†³ç­–ï¼Œå¹¶ç†è§£é‚£äº›æœ€ä½³å¼€å‘å®è·µçš„ä¸ªä¸­ç¼˜ç”±ã€‚å°½ç®¡è¿™æ˜¯ä¸€ç¯‡ç›¸å½“é•¿çš„æ–‡æ¡£ï¼Œä½†æ˜¯æˆ‘ä»¬å»ºè®®æ‚¨èŠ±äº›æ—¶é—´æ¥ä»”ç»†é˜…è¯»ï¼›è¯»å®Œä¹‹åï¼Œæ‚¨è‚¯å®šä¼šè§‰å¾—æ‰€è´¹ä¸è™šã€‚</p>
<p align="right">ä¿ç½—Â·çˆ±ä¸½è¯— (Paul Irish)ï¼ŒChrome æµè§ˆå™¨å¼€å‘äººå‘˜äº‹åŠ¡éƒ¨</p>

<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>ç½‘ç»œæµè§ˆå™¨å¾ˆå¯èƒ½æ˜¯ä½¿ç”¨æœ€å¹¿çš„è½¯ä»¶ã€‚åœ¨è¿™ç¯‡å…¥é—¨æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä¼šä»‹ç»å®ƒä»¬çš„å¹•åå·¥ä½œåŸç†ã€‚æˆ‘ä»¬ä¼šäº†è§£åˆ°ï¼Œä»æ‚¨åœ¨åœ°å€æ è¾“å…¥ google.com ç›´åˆ°æ‚¨åœ¨æµè§ˆå™¨å±å¹•ä¸Šçœ‹åˆ° Google é¦–é¡µçš„æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½å‘ç”Ÿäº†äº›ä»€ä¹ˆã€‚</p>
<a id="more"></a>
<h3 id="æˆ‘ä»¬è¦è®¨è®ºçš„æµè§ˆå™¨"><a href="#æˆ‘ä»¬è¦è®¨è®ºçš„æµè§ˆå™¨" class="headerlink" title="æˆ‘ä»¬è¦è®¨è®ºçš„æµè§ˆå™¨"></a>æˆ‘ä»¬è¦è®¨è®ºçš„æµè§ˆå™¨</h3><p>ç›®å‰ä½¿ç”¨çš„ä¸»æµæµè§ˆå™¨æœ‰äº”ä¸ªï¼šInternet Explorerã€Firefoxã€Safariã€Chrome æµè§ˆå™¨å’Œ Operaã€‚æœ¬æ–‡ä¸­ä»¥å¼€æ”¾æºä»£ç æµè§ˆå™¨ä¸ºä¾‹ï¼Œå³ Firefoxã€Chrome æµè§ˆå™¨å’Œ Safariï¼ˆéƒ¨åˆ†å¼€æºï¼‰ã€‚æ ¹æ® StatCounter æµè§ˆå™¨ç»Ÿè®¡æ•°æ®ï¼Œç›®å‰ï¼ˆ2011 å¹´ 8 æœˆï¼‰Firefoxã€Safari å’Œ Chrome æµè§ˆå™¨çš„æ€»å¸‚åœºå æœ‰ç‡å°†è¿‘ 60%ã€‚ç”±æ­¤å¯è§ï¼Œå¦‚ä»Šå¼€æ”¾æºä»£ç æµè§ˆå™¨åœ¨æµè§ˆå™¨å¸‚åœºä¸­å æ®äº†éå¸¸åšå®çš„éƒ¨åˆ†ã€‚</p>
<h3 id="æµè§ˆå™¨çš„ä¸»è¦åŠŸèƒ½"><a href="#æµè§ˆå™¨çš„ä¸»è¦åŠŸèƒ½" class="headerlink" title="æµè§ˆå™¨çš„ä¸»è¦åŠŸèƒ½"></a>æµè§ˆå™¨çš„ä¸»è¦åŠŸèƒ½</h3><p>æµè§ˆå™¨çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œåœ¨æµè§ˆå™¨çª—å£ä¸­å±•ç¤ºæ‚¨é€‰æ‹©çš„ç½‘ç»œèµ„æºã€‚è¿™é‡Œæ‰€è¯´çš„èµ„æºä¸€èˆ¬æ˜¯æŒ‡ HTML æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥æ˜¯ PDFã€å›¾ç‰‡æˆ–å…¶ä»–çš„ç±»å‹ã€‚èµ„æºçš„ä½ç½®ç”±ç”¨æˆ·ä½¿ç”¨ URIï¼ˆç»Ÿä¸€èµ„æºæ ‡ç¤ºç¬¦ï¼‰æŒ‡å®šã€‚</p>
<p>æµè§ˆå™¨è§£é‡Šå¹¶æ˜¾ç¤º HTML æ–‡ä»¶çš„æ–¹å¼æ˜¯åœ¨ HTML å’Œ CSS è§„èŒƒä¸­æŒ‡å®šçš„ã€‚è¿™äº›è§„èŒƒç”±ç½‘ç»œæ ‡å‡†åŒ–ç»„ç»‡ W3Cï¼ˆä¸‡ç»´ç½‘è”ç›Ÿï¼‰è¿›è¡Œç»´æŠ¤ã€‚<br>å¤šå¹´ä»¥æ¥ï¼Œå„æµè§ˆå™¨éƒ½æ²¡æœ‰å®Œå…¨éµä»è¿™äº›è§„èŒƒï¼ŒåŒæ—¶è¿˜åœ¨å¼€å‘è‡ªå·±ç‹¬æœ‰çš„æ‰©å±•ç¨‹åºï¼Œè¿™ç»™ç½‘ç»œå¼€å‘äººå‘˜å¸¦æ¥äº†ä¸¥é‡çš„å…¼å®¹æ€§é—®é¢˜ã€‚å¦‚ä»Šï¼Œå¤§å¤šæ•°çš„æµè§ˆå™¨éƒ½æ˜¯æˆ–å¤šæˆ–å°‘åœ°éµä»è§„èŒƒã€‚</p>
<p>æµè§ˆå™¨çš„ç”¨æˆ·ç•Œé¢æœ‰å¾ˆå¤šå½¼æ­¤ç›¸åŒçš„å…ƒç´ ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼š</p>
<ul>
<li>ç”¨æ¥è¾“å…¥ URI çš„åœ°å€æ </li>
<li>å‰è¿›å’Œåé€€æŒ‰é’®</li>
<li>ä¹¦ç­¾è®¾ç½®é€‰é¡¹</li>
<li>ç”¨äºåˆ·æ–°å’Œåœæ­¢åŠ è½½å½“å‰æ–‡æ¡£çš„åˆ·æ–°å’Œåœæ­¢æŒ‰é’®</li>
<li>ç”¨äºè¿”å›ä¸»é¡µçš„ä¸»é¡µæŒ‰é’®</li>
</ul>
<p>å¥‡æ€ªçš„æ˜¯ï¼Œæµè§ˆå™¨çš„ç”¨æˆ·ç•Œé¢å¹¶æ²¡æœ‰ä»»ä½•æ­£å¼çš„è§„èŒƒï¼Œè¿™æ˜¯å¤šå¹´æ¥çš„æœ€ä½³å®è·µè‡ªç„¶å‘å±•ä»¥åŠå½¼æ­¤ä¹‹é—´ç›¸äº’æ¨¡ä»¿çš„ç»“æœã€‚HTML5 ä¹Ÿæ²¡æœ‰å®šä¹‰æµè§ˆå™¨å¿…é¡»å…·æœ‰çš„ç”¨æˆ·ç•Œé¢å…ƒç´ ï¼Œä½†åˆ—å‡ºäº†ä¸€äº›é€šç”¨çš„å…ƒç´ ï¼Œä¾‹å¦‚åœ°å€æ ã€çŠ¶æ€æ å’Œå·¥å…·æ ç­‰ã€‚å½“ç„¶ï¼Œå„æµè§ˆå™¨ä¹Ÿå¯ä»¥æœ‰è‡ªå·±ç‹¬ç‰¹çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ Firefox çš„ä¸‹è½½ç®¡ç†å™¨ã€‚</p>
<h3 id="æµè§ˆå™¨çš„é«˜å±‚ç»“æ„"><a href="#æµè§ˆå™¨çš„é«˜å±‚ç»“æ„" class="headerlink" title="æµè§ˆå™¨çš„é«˜å±‚ç»“æ„"></a>æµè§ˆå™¨çš„é«˜å±‚ç»“æ„</h3><p>æµè§ˆå™¨çš„ä¸»è¦ç»„ä»¶ä¸º (1.1)ï¼š</p>
<ol>
<li>ç”¨æˆ·ç•Œé¢ - åŒ…æ‹¬åœ°å€æ ã€å‰è¿›/åé€€æŒ‰é’®ã€ä¹¦ç­¾èœå•ç­‰ã€‚é™¤äº†æµè§ˆå™¨ä¸»çª—å£æ˜¾ç¤ºçš„æ‚¨è¯·æ±‚çš„é¡µé¢å¤–ï¼Œå…¶ä»–æ˜¾ç¤ºçš„å„ä¸ªéƒ¨åˆ†éƒ½å±äºç”¨æˆ·ç•Œé¢ã€‚</li>
</ol>
<ul>
<li>æµè§ˆå™¨å¼•æ“ - åœ¨ç”¨æˆ·ç•Œé¢å’Œå‘ˆç°å¼•æ“ä¹‹é—´ä¼ é€æŒ‡ä»¤ã€‚</li>
<li>å‘ˆç°å¼•æ“ - è´Ÿè´£æ˜¾ç¤ºè¯·æ±‚çš„å†…å®¹ã€‚å¦‚æœè¯·æ±‚çš„å†…å®¹æ˜¯ HTMLï¼Œå®ƒå°±è´Ÿè´£è§£æ HTML å’Œ CSS å†…å®¹ï¼Œå¹¶å°†è§£æåçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</li>
<li>ç½‘ç»œ - ç”¨äºç½‘ç»œè°ƒç”¨ï¼Œæ¯”å¦‚ HTTP è¯·æ±‚ã€‚å…¶æ¥å£ä¸å¹³å°æ— å…³ï¼Œå¹¶ä¸ºæ‰€æœ‰å¹³å°æä¾›åº•å±‚å®ç°ã€‚</li>
<li>ç”¨æˆ·ç•Œé¢åç«¯ - ç”¨äºç»˜åˆ¶åŸºæœ¬çš„çª—å£å°éƒ¨ä»¶ï¼Œæ¯”å¦‚ç»„åˆæ¡†å’Œçª—å£ã€‚å…¶å…¬å¼€äº†ä¸å¹³å°æ— å…³çš„é€šç”¨æ¥å£ï¼Œè€Œåœ¨åº•å±‚ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ç•Œé¢æ–¹æ³•ã€‚</li>
<li>JavaScript è§£é‡Šå™¨ã€‚ç”¨äºè§£æå’Œæ‰§è¡Œ JavaScript ä»£ç ã€‚</li>
<li>æ•°æ®å­˜å‚¨ã€‚è¿™æ˜¯æŒä¹…å±‚ã€‚æµè§ˆå™¨éœ€è¦åœ¨ç¡¬ç›˜ä¸Šä¿å­˜å„ç§æ•°æ®ï¼Œä¾‹å¦‚ Cookieã€‚æ–°çš„ HTML è§„èŒƒ (HTML5) å®šä¹‰äº†â€œç½‘ç»œæ•°æ®åº“â€ï¼Œè¿™æ˜¯ä¸€ä¸ªå®Œæ•´ï¼ˆä½†æ˜¯è½»ä¾¿ï¼‰çš„æµè§ˆå™¨å†…æ•°æ®åº“ã€‚</li>
</ul>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/layers.png" alt></p>
<center><strong>å›¾ï¼šæµè§ˆå™¨çš„ä¸»è¦ç»„ä»¶</strong></center>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå’Œå¤§å¤šæ•°æµè§ˆå™¨ä¸åŒï¼ŒChrome æµè§ˆå™¨çš„æ¯ä¸ªæ ‡ç­¾é¡µéƒ½åˆ†åˆ«å¯¹åº”ä¸€ä¸ªå‘ˆç°å¼•æ“å®ä¾‹ã€‚æ¯ä¸ªæ ‡ç­¾é¡µéƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ã€‚</p>
<h2 id="å‘ˆç°å¼•æ“"><a href="#å‘ˆç°å¼•æ“" class="headerlink" title="å‘ˆç°å¼•æ“"></a>å‘ˆç°å¼•æ“</h2><p>å‘ˆç°å¼•æ“çš„ä½œç”¨å˜›â€¦å½“ç„¶å°±æ˜¯â€œå‘ˆç°â€äº†ï¼Œä¹Ÿå°±æ˜¯åœ¨æµè§ˆå™¨çš„å±å¹•ä¸Šæ˜¾ç¤ºè¯·æ±‚çš„å†…å®¹ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ˆç°å¼•æ“å¯æ˜¾ç¤º HTML å’Œ XML æ–‡æ¡£ä¸å›¾ç‰‡ã€‚é€šè¿‡æ’ä»¶ï¼ˆæˆ–æµè§ˆå™¨æ‰©å±•ç¨‹åºï¼‰ï¼Œè¿˜å¯ä»¥æ˜¾ç¤ºå…¶ä»–ç±»å‹çš„å†…å®¹ï¼›ä¾‹å¦‚ï¼Œä½¿ç”¨ PDF æŸ¥çœ‹å™¨æ’ä»¶å°±èƒ½æ˜¾ç¤º PDF æ–‡æ¡£ã€‚ä½†æ˜¯åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†é›†ä¸­ä»‹ç»å…¶ä¸»è¦ç”¨é€”ï¼šæ˜¾ç¤ºä½¿ç”¨ CSS æ ¼å¼åŒ–çš„ HTML å†…å®¹å’Œå›¾ç‰‡ã€‚</p>
<h3 id="å‘ˆç°å¼•æ“-1"><a href="#å‘ˆç°å¼•æ“-1" class="headerlink" title="å‘ˆç°å¼•æ“"></a>å‘ˆç°å¼•æ“</h3><p>æœ¬æ–‡æ‰€è®¨è®ºçš„æµè§ˆå™¨ï¼ˆFirefoxã€Chrome æµè§ˆå™¨å’Œ Safariï¼‰æ˜¯åŸºäºä¸¤ç§å‘ˆç°å¼•æ“æ„å»ºçš„ã€‚Firefox ä½¿ç”¨çš„æ˜¯ Geckoï¼Œè¿™æ˜¯ Mozilla å…¬å¸â€œè‡ªåˆ¶â€çš„å‘ˆç°å¼•æ“ã€‚è€Œ Safari å’Œ Chrome æµè§ˆå™¨ä½¿ç”¨çš„éƒ½æ˜¯ WebKitã€‚</p>
<p>WebKit æ˜¯ä¸€ç§å¼€æ”¾æºä»£ç å‘ˆç°å¼•æ“ï¼Œèµ·åˆç”¨äº Linux å¹³å°ï¼Œéšåç”± Apple å…¬å¸è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œæ”¯æŒè‹¹æœæœºå’Œ Windowsã€‚æœ‰å…³è¯¦æƒ…ï¼Œè¯·å‚é˜… webkit.orgã€‚</p>
<h3 id="ä¸»æµç¨‹"><a href="#ä¸»æµç¨‹" class="headerlink" title="ä¸»æµç¨‹"></a>ä¸»æµç¨‹</h3><p>å‘ˆç°å¼•æ“ä¸€å¼€å§‹ä¼šä»ç½‘ç»œå±‚è·å–è¯·æ±‚æ–‡æ¡£çš„å†…å®¹ï¼Œå†…å®¹çš„å¤§å°ä¸€èˆ¬é™åˆ¶åœ¨ 8000 ä¸ªå—ä»¥å†…ã€‚</p>
<p>ç„¶åè¿›è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„åŸºæœ¬æµç¨‹ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/flow.png" alt></p>
<center><strong>å›¾ï¼šå‘ˆç°å¼•æ“çš„åŸºæœ¬æµç¨‹ã€‚</strong></center>

<p>å‘ˆç°å¼•æ“å°†å¼€å§‹è§£æ HTML æ–‡æ¡£ï¼Œå¹¶å°†å„æ ‡è®°é€ä¸ªè½¬åŒ–æˆâ€œå†…å®¹æ ‘â€ä¸Šçš„ DOM èŠ‚ç‚¹ã€‚åŒæ—¶ä¹Ÿä¼šè§£æå¤–éƒ¨ CSS æ–‡ä»¶ä»¥åŠæ ·å¼å…ƒç´ ä¸­çš„æ ·å¼æ•°æ®ã€‚HTML ä¸­è¿™äº›å¸¦æœ‰è§†è§‰æŒ‡ä»¤çš„æ ·å¼ä¿¡æ¯å°†ç”¨äºåˆ›å»ºå¦ä¸€ä¸ªæ ‘ç»“æ„ï¼šå‘ˆç°æ ‘ã€‚</p>
<p>å‘ˆç°æ ‘åŒ…å«å¤šä¸ªå¸¦æœ‰è§†è§‰å±æ€§ï¼ˆå¦‚é¢œè‰²å’Œå°ºå¯¸ï¼‰çš„çŸ©å½¢ã€‚è¿™äº›çŸ©å½¢çš„æ’åˆ—é¡ºåºå°±æ˜¯å®ƒä»¬å°†åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„é¡ºåºã€‚</p>
<p>å‘ˆç°æ ‘æ„å»ºå®Œæ¯•ä¹‹åï¼Œè¿›å…¥â€œå¸ƒå±€â€å¤„ç†é˜¶æ®µï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªåº”å‡ºç°åœ¨å±å¹•ä¸Šçš„ç¡®åˆ‡åæ ‡ã€‚ä¸‹ä¸€ä¸ªé˜¶æ®µæ˜¯ç»˜åˆ¶ - å‘ˆç°å¼•æ“ä¼šéå†å‘ˆç°æ ‘ï¼Œç”±ç”¨æˆ·ç•Œé¢åç«¯å±‚å°†æ¯ä¸ªèŠ‚ç‚¹ç»˜åˆ¶å‡ºæ¥ã€‚</p>
<p>éœ€è¦ç€é‡æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¸è¿›çš„è¿‡ç¨‹ã€‚ä¸ºè¾¾åˆ°æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå‘ˆç°å¼•æ“ä¼šåŠ›æ±‚å°½å¿«å°†å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å®ƒä¸å¿…ç­‰åˆ°æ•´ä¸ª HTML æ–‡æ¡£è§£æå®Œæ¯•ä¹‹åï¼Œå°±ä¼šå¼€å§‹æ„å»ºå‘ˆç°æ ‘å’Œè®¾ç½®å¸ƒå±€ã€‚åœ¨ä¸æ–­æ¥æ”¶å’Œå¤„ç†æ¥è‡ªç½‘ç»œçš„å…¶ä½™å†…å®¹çš„åŒæ—¶ï¼Œå‘ˆç°å¼•æ“ä¼šå°†éƒ¨åˆ†å†…å®¹è§£æå¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚</p>
<h3 id="ä¸»æµç¨‹ç¤ºä¾‹"><a href="#ä¸»æµç¨‹ç¤ºä¾‹" class="headerlink" title="ä¸»æµç¨‹ç¤ºä¾‹"></a>ä¸»æµç¨‹ç¤ºä¾‹</h3><p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/webkitflow.png" alt></p>
<center><strong>å›¾ï¼šWebKit ä¸»æµç¨‹</strong></center>


<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image008.jpg" alt></p>
<center><strong>å›¾ï¼šMozilla çš„ Gecko å‘ˆç°å¼•æ“ä¸»æµç¨‹ (3.6)</strong></center>

<p>ä»å›¾ 3 å’Œå›¾ 4 å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶ WebKit å’Œ Gecko ä½¿ç”¨çš„æœ¯è¯­ç•¥æœ‰ä¸åŒï¼Œä½†æ•´ä½“æµç¨‹æ˜¯åŸºæœ¬ç›¸åŒçš„ã€‚</p>
<p>Gecko å°†è§†è§‰æ ¼å¼åŒ–å…ƒç´ ç»„æˆçš„æ ‘ç§°ä¸ºâ€œæ¡†æ¶æ ‘â€ã€‚æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ¡†æ¶ã€‚WebKit ä½¿ç”¨çš„æœ¯è¯­æ˜¯â€œå‘ˆç°æ ‘â€ï¼Œå®ƒç”±â€œå‘ˆç°å¯¹è±¡â€ç»„æˆã€‚å¯¹äºå…ƒç´ çš„æ”¾ç½®ï¼ŒWebKit ä½¿ç”¨çš„æœ¯è¯­æ˜¯â€œå¸ƒå±€â€ï¼Œè€Œ Gecko ç§°ä¹‹ä¸ºâ€œé‡æ’â€ã€‚å¯¹äºè¿æ¥ DOM èŠ‚ç‚¹å’Œå¯è§†åŒ–ä¿¡æ¯ä»è€Œåˆ›å»ºå‘ˆç°æ ‘çš„è¿‡ç¨‹ï¼ŒWebKit ä½¿ç”¨çš„æœ¯è¯­æ˜¯â€œé™„åŠ â€ã€‚æœ‰ä¸€ä¸ªç»†å¾®çš„éè¯­ä¹‰å·®åˆ«ï¼Œå°±æ˜¯ Gecko åœ¨ HTML ä¸ DOM æ ‘ä¹‹é—´è¿˜æœ‰ä¸€ä¸ªç§°ä¸ºâ€œå†…å®¹æ§½â€çš„å±‚ï¼Œç”¨äºç”Ÿæˆ DOM å…ƒç´ ã€‚æˆ‘ä»¬ä¼šé€ä¸€è®ºè¿°æµç¨‹ä¸­çš„æ¯ä¸€éƒ¨åˆ†ï¼š</p>
<h2 id="è§£æå’Œ-DOM-æ ‘æ„å»º"><a href="#è§£æå’Œ-DOM-æ ‘æ„å»º" class="headerlink" title="è§£æå’Œ DOM æ ‘æ„å»º"></a>è§£æå’Œ DOM æ ‘æ„å»º</h2><h3 id="è§£æ-ç»¼è¿°"><a href="#è§£æ-ç»¼è¿°" class="headerlink" title="è§£æ - ç»¼è¿°"></a>è§£æ - ç»¼è¿°</h3><p>è§£ææ˜¯å‘ˆç°å¼•æ“ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå› æ­¤æˆ‘ä»¬è¦æ›´æ·±å…¥åœ°è®²è§£ã€‚é¦–å…ˆï¼Œæ¥ä»‹ç»ä¸€ä¸‹è§£æã€‚</p>
<p>è§£ææ–‡æ¡£æ˜¯æŒ‡å°†æ–‡æ¡£è½¬åŒ–æˆä¸ºæœ‰æ„ä¹‰çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯å¯è®©ä»£ç ç†è§£å’Œä½¿ç”¨çš„ç»“æ„ã€‚è§£æå¾—åˆ°çš„ç»“æœé€šå¸¸æ˜¯ä»£è¡¨äº†æ–‡æ¡£ç»“æ„çš„èŠ‚ç‚¹æ ‘ï¼Œå®ƒç§°ä½œè§£ææ ‘æˆ–è€…è¯­æ³•æ ‘ã€‚</p>
<p>ç¤ºä¾‹ - è§£æ <code>2 + 3 - 1</code> è¿™ä¸ªè¡¨è¾¾å¼ï¼Œä¼šè¿”å›ä¸‹é¢çš„æ ‘ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image009.png" alt></p>
<center><strong>å›¾ï¼šæ•°å­¦è¡¨è¾¾å¼æ ‘èŠ‚ç‚¹</strong></center>

<h4 id="è¯­æ³•"><a href="#è¯­æ³•" class="headerlink" title="è¯­æ³•"></a>è¯­æ³•</h4><p>è§£ææ˜¯ä»¥æ–‡æ¡£æ‰€éµå¾ªçš„è¯­æ³•è§„åˆ™ï¼ˆç¼–å†™æ–‡æ¡£æ‰€ç”¨çš„è¯­è¨€æˆ–æ ¼å¼ï¼‰ä¸ºåŸºç¡€çš„ã€‚æ‰€æœ‰å¯ä»¥è§£æçš„æ ¼å¼éƒ½å¿…é¡»å¯¹åº”ç¡®å®šçš„è¯­æ³•ï¼ˆç”±è¯æ±‡å’Œè¯­æ³•è§„åˆ™æ„æˆï¼‰ã€‚è¿™ç§°ä¸ºä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ã€‚äººç±»è¯­è¨€å¹¶ä¸å±äºè¿™æ ·çš„è¯­è¨€ï¼Œå› æ­¤æ— æ³•ç”¨å¸¸è§„çš„è§£ææŠ€æœ¯è¿›è¡Œè§£æã€‚</p>
<h4 id="è§£æå™¨å’Œè¯æ³•åˆ†æå™¨çš„ç»„åˆ"><a href="#è§£æå™¨å’Œè¯æ³•åˆ†æå™¨çš„ç»„åˆ" class="headerlink" title="è§£æå™¨å’Œè¯æ³•åˆ†æå™¨çš„ç»„åˆ"></a>è§£æå™¨å’Œè¯æ³•åˆ†æå™¨çš„ç»„åˆ</h4><p>è§£æçš„è¿‡ç¨‹å¯ä»¥åˆ†æˆä¸¤ä¸ªå­è¿‡ç¨‹ï¼šè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æã€‚</p>
<p>è¯æ³•åˆ†ææ˜¯å°†è¾“å…¥å†…å®¹åˆ†å‰²æˆå¤§é‡æ ‡è®°çš„è¿‡ç¨‹ã€‚æ ‡è®°æ˜¯è¯­è¨€ä¸­çš„è¯æ±‡ï¼Œå³æ„æˆå†…å®¹çš„å•ä½ã€‚åœ¨äººç±»è¯­è¨€ä¸­ï¼Œå®ƒç›¸å½“äºè¯­è¨€å­—å…¸ä¸­çš„å•è¯ã€‚</p>
<p>è¯­æ³•åˆ†ææ˜¯åº”ç”¨è¯­è¨€çš„è¯­æ³•è§„åˆ™çš„è¿‡ç¨‹ã€‚</p>
<p>è§£æå™¨é€šå¸¸å°†è§£æå·¥ä½œåˆ†ç»™ä»¥ä¸‹ä¸¤ä¸ªç»„ä»¶æ¥å¤„ç†ï¼šè¯æ³•åˆ†æå™¨ï¼ˆæœ‰æ—¶ä¹Ÿç§°ä¸ºæ ‡è®°ç”Ÿæˆå™¨ï¼‰ï¼Œè´Ÿè´£å°†è¾“å…¥å†…å®¹åˆ†è§£æˆä¸€ä¸ªä¸ªæœ‰æ•ˆæ ‡è®°ï¼›è€Œè§£æå™¨è´Ÿè´£æ ¹æ®è¯­è¨€çš„è¯­æ³•è§„åˆ™åˆ†ææ–‡æ¡£çš„ç»“æ„ï¼Œä»è€Œæ„å»ºè§£ææ ‘ã€‚è¯æ³•åˆ†æå™¨çŸ¥é“å¦‚ä½•å°†æ— å…³çš„å­—ç¬¦ï¼ˆæ¯”å¦‚ç©ºæ ¼å’Œæ¢è¡Œç¬¦ï¼‰åˆ†ç¦»å‡ºæ¥ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image011.png" alt></p>
<center><strong>å›¾ï¼šä»æºæ–‡æ¡£åˆ°è§£ææ ‘</strong></center>

<p>è§£ææ˜¯ä¸€ä¸ªè¿­ä»£çš„è¿‡ç¨‹ã€‚é€šå¸¸ï¼Œè§£æå™¨ä¼šå‘è¯æ³•åˆ†æå™¨è¯·æ±‚ä¸€ä¸ªæ–°æ ‡è®°ï¼Œå¹¶å°è¯•å°†å…¶ä¸æŸæ¡è¯­æ³•è§„åˆ™è¿›è¡ŒåŒ¹é…ã€‚å¦‚æœå‘ç°äº†åŒ¹é…è§„åˆ™ï¼Œè§£æå™¨ä¼šå°†ä¸€ä¸ªå¯¹åº”äºè¯¥æ ‡è®°çš„èŠ‚ç‚¹æ·»åŠ åˆ°è§£ææ ‘ä¸­ï¼Œç„¶åç»§ç»­è¯·æ±‚ä¸‹ä¸€ä¸ªæ ‡è®°ã€‚</p>
<p>å¦‚æœæ²¡æœ‰è§„åˆ™å¯ä»¥åŒ¹é…ï¼Œè§£æå™¨å°±ä¼šå°†æ ‡è®°å­˜å‚¨åˆ°å†…éƒ¨ï¼Œå¹¶ç»§ç»­è¯·æ±‚æ ‡è®°ï¼Œç›´è‡³æ‰¾åˆ°å¯ä¸æ‰€æœ‰å†…éƒ¨å­˜å‚¨çš„æ ‡è®°åŒ¹é…çš„è§„åˆ™ã€‚å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•åŒ¹é…è§„åˆ™ï¼Œè§£æå™¨å°±ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ã€‚è¿™æ„å‘³ç€æ–‡æ¡£æ— æ•ˆï¼ŒåŒ…å«è¯­æ³•é”™è¯¯ã€‚</p>
<h4 id="ç¿»è¯‘"><a href="#ç¿»è¯‘" class="headerlink" title="ç¿»è¯‘"></a>ç¿»è¯‘</h4><p>å¾ˆå¤šæ—¶å€™ï¼Œè§£ææ ‘è¿˜ä¸æ˜¯æœ€ç»ˆäº§å“ã€‚è§£æé€šå¸¸æ˜¯åœ¨ç¿»è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ï¼Œè€Œç¿»è¯‘æ˜¯æŒ‡å°†è¾“å…¥æ–‡æ¡£è½¬æ¢æˆå¦ä¸€ç§æ ¼å¼ã€‚ç¼–è¯‘å°±æ˜¯è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚ç¼–è¯‘å™¨å¯å°†æºä»£ç ç¼–è¯‘æˆæœºå™¨ä»£ç ï¼Œå…·ä½“è¿‡ç¨‹æ˜¯é¦–å…ˆå°†æºä»£ç è§£ææˆè§£ææ ‘ï¼Œç„¶åå°†è§£ææ ‘ç¿»è¯‘æˆæœºå™¨ä»£ç æ–‡æ¡£ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image013.png" alt></p>
<center><strong>å›¾ï¼šç¼–è¯‘æµç¨‹</strong></center>

<h4 id="è§£æç¤ºä¾‹"><a href="#è§£æç¤ºä¾‹" class="headerlink" title="è§£æç¤ºä¾‹"></a>è§£æç¤ºä¾‹</h4><p>åœ¨å›¾ 5 ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªæ•°å­¦è¡¨è¾¾å¼å»ºç«‹äº†è§£ææ ‘ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯•ç€å®šä¹‰ä¸€ä¸ªç®€å•çš„æ•°å­¦è¯­è¨€ï¼Œç”¨æ¥æ¼”ç¤ºè§£æçš„è¿‡ç¨‹ã€‚</p>
<p>è¯æ±‡ï¼šæˆ‘ä»¬ç”¨çš„è¯­è¨€å¯åŒ…å«æ•´æ•°ã€åŠ å·å’Œå‡å·ã€‚</p>
<p>è¯­æ³•ï¼š</p>
<ol>
<li>æ„æˆè¯­è¨€çš„è¯­æ³•å•ä½æ˜¯è¡¨è¾¾å¼ã€é¡¹å’Œè¿ç®—ç¬¦ã€‚</li>
</ol>
<ul>
<li>æˆ‘ä»¬ç”¨çš„è¯­è¨€å¯ä»¥åŒ…å«ä»»æ„æ•°é‡çš„è¡¨è¾¾å¼ã€‚</li>
<li>è¡¨è¾¾å¼çš„å®šä¹‰æ˜¯ï¼šä¸€ä¸ªâ€œé¡¹â€æ¥ä¸€ä¸ªâ€œè¿ç®—ç¬¦â€ï¼Œç„¶åå†æ¥ä¸€ä¸ªâ€œé¡¹â€ã€‚</li>
<li>è¿ç®—ç¬¦æ˜¯åŠ å·æˆ–å‡å·ã€‚</li>
<li>é¡¹æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–ä¸€ä¸ªè¡¨è¾¾å¼ã€‚</li>
</ul>
<p>è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹ <code>2 + 3 - 1</code>ã€‚ </p>
<p>åŒ¹é…è¯­æ³•è§„åˆ™çš„ç¬¬ä¸€ä¸ªå­ä¸²æ˜¯ 2ï¼Œè€Œæ ¹æ®ç¬¬ 5 æ¡è¯­æ³•è§„åˆ™ï¼Œè¿™æ˜¯ä¸€ä¸ªé¡¹ã€‚åŒ¹é…è¯­æ³•è§„åˆ™çš„ç¬¬äºŒä¸ªå­ä¸²æ˜¯ 2 + 3ï¼Œè€Œæ ¹æ®ç¬¬ 3 æ¡è§„åˆ™ï¼ˆä¸€ä¸ªé¡¹æ¥ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œç„¶åå†æ¥ä¸€ä¸ªé¡¹ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ã€‚ä¸‹ä¸€ä¸ªåŒ¹é…é¡¹å·²ç»åˆ°äº†è¾“å…¥çš„ç»“æŸã€‚2 + 3 - 1 æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»çŸ¥é“ 2 + 3 æ˜¯ä¸€ä¸ªé¡¹ï¼Œè¿™æ ·å°±ç¬¦åˆâ€œä¸€ä¸ªé¡¹æ¥ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œç„¶åå†æ¥ä¸€ä¸ªé¡¹â€çš„è§„åˆ™ã€‚2 + + ä¸ä¸ä»»ä½•è§„åˆ™åŒ¹é…ï¼Œå› æ­¤æ˜¯æ— æ•ˆçš„è¾“å…¥ã€‚</p>
<h4 id="è¯æ±‡å’Œè¯­æ³•çš„æ­£å¼å®šä¹‰"><a href="#è¯æ±‡å’Œè¯­æ³•çš„æ­£å¼å®šä¹‰" class="headerlink" title="è¯æ±‡å’Œè¯­æ³•çš„æ­£å¼å®šä¹‰"></a>è¯æ±‡å’Œè¯­æ³•çš„æ­£å¼å®šä¹‰</h4><p>è¯æ±‡é€šå¸¸ç”¨æ­£åˆ™è¡¨è¾¾å¼è¡¨ç¤ºã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„ç¤ºä¾‹è¯­è¨€å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INTEGER :0|[1-9][0-9]*</span><br><span class="line">PLUS : +</span><br><span class="line">MINUS: -</span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œè¿™é‡Œç”¨æ­£åˆ™è¡¨è¾¾å¼ç»™å‡ºäº†æ•´æ•°çš„å®šä¹‰ã€‚<br>è¯­æ³•é€šå¸¸ä½¿ç”¨ä¸€ç§ç§°ä¸º BNF çš„æ ¼å¼æ¥å®šä¹‰ã€‚æˆ‘ä»¬çš„ç¤ºä¾‹è¯­è¨€å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">expression :=  term  operation  term</span><br><span class="line">operation :=  PLUS | MINUS</span><br><span class="line">term := INTEGER | expression</span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼Œå¦‚æœè¯­è¨€çš„è¯­æ³•æ˜¯ä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ï¼Œå°±å¯ä»¥ç”±å¸¸è§„è§£æå™¨è¿›è¡Œè§£æã€‚ä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•çš„ç›´è§‚å®šä¹‰å°±æ˜¯å¯ä»¥å®Œå…¨ç”¨ BNF æ ¼å¼è¡¨è¾¾çš„è¯­æ³•ã€‚æœ‰å…³æ­£å¼å®šä¹‰ï¼Œè¯·å‚é˜…å…³äºä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•çš„ç»´åŸºç™¾ç§‘æ–‡ç« ã€‚</p>
<h4 id="è§£æå™¨ç±»å‹"><a href="#è§£æå™¨ç±»å‹" class="headerlink" title="è§£æå™¨ç±»å‹"></a>è§£æå™¨ç±»å‹</h4><p>æœ‰ä¸¤ç§åŸºæœ¬ç±»å‹çš„è§£æå™¨ï¼šè‡ªä¸Šè€Œä¸‹è§£æå™¨å’Œè‡ªä¸‹è€Œä¸Šè§£æå™¨ã€‚ç›´è§‚åœ°æ¥è¯´ï¼Œè‡ªä¸Šè€Œä¸‹çš„è§£æå™¨ä»è¯­æ³•çš„é«˜å±‚ç»“æ„å‡ºå‘ï¼Œå°è¯•ä»ä¸­æ‰¾åˆ°åŒ¹é…çš„ç»“æ„ã€‚è€Œè‡ªä¸‹è€Œä¸Šçš„è§£æå™¨ä»ä½å±‚è§„åˆ™å‡ºå‘ï¼Œå°†è¾“å…¥å†…å®¹é€æ­¥è½¬åŒ–ä¸ºè¯­æ³•è§„åˆ™ï¼Œç›´è‡³æ»¡è¶³é«˜å±‚è§„åˆ™ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸¤ç§è§£æå™¨ä¼šå¦‚ä½•è§£ææˆ‘ä»¬çš„ç¤ºä¾‹ï¼š</p>
<p>è‡ªä¸Šè€Œä¸‹çš„è§£æå™¨ä¼šä»é«˜å±‚çš„è§„åˆ™å¼€å§‹ï¼šé¦–å…ˆå°† 2 + 3 æ ‡è¯†ä¸ºä¸€ä¸ªè¡¨è¾¾å¼ï¼Œç„¶åå°† 2 + 3 - 1 æ ‡è¯†ä¸ºä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆæ ‡è¯†è¡¨è¾¾å¼çš„è¿‡ç¨‹æ¶‰åŠåˆ°åŒ¹é…å…¶ä»–è§„åˆ™ï¼Œä½†æ˜¯èµ·ç‚¹æ˜¯æœ€é«˜çº§åˆ«çš„è§„åˆ™ï¼‰ã€‚</p>
<p>è‡ªä¸‹è€Œä¸Šçš„è§£æå™¨å°†æ‰«æè¾“å…¥å†…å®¹ï¼Œæ‰¾åˆ°åŒ¹é…çš„è§„åˆ™åï¼Œå°†åŒ¹é…çš„è¾“å…¥å†…å®¹æ›¿æ¢æˆè§„åˆ™ã€‚å¦‚æ­¤ç»§ç»­æ›¿æ¢ï¼Œç›´åˆ°è¾“å…¥å†…å®¹çš„ç»“å°¾ã€‚éƒ¨åˆ†åŒ¹é…çš„è¡¨è¾¾å¼ä¿å­˜åœ¨è§£æå™¨çš„å †æ ˆä¸­ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">å †æ ˆ	         è¾“å…¥</span><br><span class="line"> 	              2 + 3 - 1</span><br><span class="line">é¡¹	            + 3 - 1</span><br><span class="line">é¡¹è¿ç®—	        3 - 1</span><br><span class="line">è¡¨è¾¾å¼	        - 1</span><br><span class="line">è¡¨è¾¾å¼è¿ç®—ç¬¦	    1</span><br><span class="line">è¡¨è¾¾å¼</span><br></pre></td></tr></table></figure>
<p>è¿™ç§è‡ªä¸‹è€Œä¸Šçš„è§£æå™¨ç§°ä¸ºç§»ä½å½’çº¦è§£æå™¨ï¼Œå› ä¸ºè¾“å…¥åœ¨å‘å³ç§»ä½ï¼ˆè®¾æƒ³æœ‰ä¸€ä¸ªæŒ‡é’ˆä»è¾“å…¥å†…å®¹çš„å¼€å¤´ç§»åŠ¨åˆ°ç»“å°¾ï¼‰ï¼Œå¹¶ä¸”é€æ¸å½’çº¦åˆ°è¯­æ³•è§„åˆ™ä¸Šã€‚</p>
<h4 id="è‡ªåŠ¨ç”Ÿæˆè§£æå™¨"><a href="#è‡ªåŠ¨ç”Ÿæˆè§£æå™¨" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆè§£æå™¨"></a>è‡ªåŠ¨ç”Ÿæˆè§£æå™¨</h4><p>æœ‰ä¸€äº›å·¥å…·å¯ä»¥å¸®åŠ©æ‚¨ç”Ÿæˆè§£æå™¨ï¼Œå®ƒä»¬ç§°ä¸ºè§£æå™¨ç”Ÿæˆå™¨ã€‚æ‚¨åªè¦å‘å…¶æä¾›æ‚¨æ‰€ç”¨è¯­è¨€çš„è¯­æ³•ï¼ˆè¯æ±‡å’Œè¯­æ³•è§„åˆ™ï¼‰ï¼Œå®ƒå°±ä¼šç”Ÿæˆç›¸åº”çš„è§£æå™¨ã€‚åˆ›å»ºè§£æå™¨éœ€è¦å¯¹è§£ææœ‰æ·±åˆ»ç†è§£ï¼Œè€Œäººå·¥åˆ›å»ºå¹¶ä¼˜åŒ–è§£æå™¨å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œæ‰€ä»¥è§£æå™¨ç”Ÿæˆå™¨æ˜¯éå¸¸å®ç”¨çš„ã€‚</p>
<p>WebKit ä½¿ç”¨äº†ä¸¤ç§éå¸¸æœ‰åçš„è§£æå™¨ç”Ÿæˆå™¨ï¼šç”¨äºåˆ›å»ºè¯æ³•åˆ†æå™¨çš„ Flex ä»¥åŠç”¨äºåˆ›å»ºè§£æå™¨çš„ Bisonï¼ˆæ‚¨ä¹Ÿå¯èƒ½é‡åˆ° Lex å’Œ Yacc è¿™æ ·çš„åˆ«åï¼‰ã€‚Flex çš„è¾“å…¥æ˜¯åŒ…å«æ ‡è®°çš„æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰çš„æ–‡ä»¶ã€‚Bison çš„è¾“å…¥æ˜¯é‡‡ç”¨ BNF æ ¼å¼çš„è¯­è¨€è¯­æ³•è§„åˆ™ã€‚</p>
<h3 id="HTML-è§£æå™¨"><a href="#HTML-è§£æå™¨" class="headerlink" title="HTML è§£æå™¨"></a>HTML è§£æå™¨</h3><p>HTML è§£æå™¨çš„ä»»åŠ¡æ˜¯å°† HTML æ ‡è®°è§£ææˆè§£ææ ‘ã€‚</p>
<h4 id="HTML-è¯­æ³•å®šä¹‰"><a href="#HTML-è¯­æ³•å®šä¹‰" class="headerlink" title="HTML è¯­æ³•å®šä¹‰"></a>HTML è¯­æ³•å®šä¹‰</h4><p>HTML çš„è¯æ±‡å’Œè¯­æ³•åœ¨ W3C ç»„ç»‡åˆ›å»ºçš„è§„èŒƒä¸­è¿›è¡Œäº†å®šä¹‰ã€‚å½“å‰çš„ç‰ˆæœ¬æ˜¯ HTML4ï¼ŒHTML5 æ­£åœ¨å¤„ç†è¿‡ç¨‹ä¸­ã€‚</p>
<h4 id="éä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•"><a href="#éä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•" class="headerlink" title="éä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•"></a>éä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•</h4><p>æ­£å¦‚æˆ‘ä»¬åœ¨è§£æè¿‡ç¨‹çš„ç®€ä»‹ä¸­å·²ç»äº†è§£åˆ°çš„ï¼Œè¯­æ³•å¯ä»¥ç”¨ BNF ç­‰æ ¼å¼è¿›è¡Œæ­£å¼å®šä¹‰ã€‚</p>
<p>å¾ˆé—æ†¾ï¼Œæ‰€æœ‰çš„å¸¸è§„è§£æå™¨éƒ½ä¸é€‚ç”¨äº HTMLï¼ˆæˆ‘å¹¶ä¸æ˜¯å¼€ç©ç¬‘ï¼Œå®ƒä»¬å¯ä»¥ç”¨äºè§£æ CSS å’Œ JavaScriptï¼‰ã€‚HTML å¹¶ä¸èƒ½å¾ˆå®¹æ˜“åœ°ç”¨è§£æå™¨æ‰€éœ€çš„ä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•æ¥å®šä¹‰ã€‚</p>
<p>æœ‰ä¸€ç§å¯ä»¥å®šä¹‰ HTML çš„æ­£è§„æ ¼å¼ï¼šDTDï¼ˆDocument Type Definitionï¼Œæ–‡æ¡£ç±»å‹å®šä¹‰ï¼‰ï¼Œä½†å®ƒä¸æ˜¯ä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ã€‚</p>
<p>è¿™åˆçœ‹èµ·æ¥å¾ˆå¥‡æ€ªï¼šHTML å’Œ XML éå¸¸ç›¸ä¼¼ã€‚æœ‰å¾ˆå¤š XML è§£æå™¨å¯ä»¥ä½¿ç”¨ã€‚HTML å­˜åœ¨ä¸€ä¸ª XML å˜ä½“ (XHTML)ï¼Œé‚£ä¹ˆæœ‰ä»€ä¹ˆå¤§çš„åŒºåˆ«å‘¢ï¼Ÿ</p>
<p>åŒºåˆ«åœ¨äº HTML çš„å¤„ç†æ›´ä¸ºâ€œå®½å®¹â€ï¼Œå®ƒå…è®¸æ‚¨çœç•¥æŸäº›éšå¼æ·»åŠ çš„æ ‡è®°ï¼Œæœ‰æ—¶è¿˜èƒ½çœç•¥ä¸€äº›èµ·å§‹æˆ–è€…ç»“æŸæ ‡è®°ç­‰ç­‰ã€‚å’Œ XML ä¸¥æ ¼çš„è¯­æ³•ä¸åŒï¼ŒHTML æ•´ä½“æ¥çœ‹æ˜¯ä¸€ç§â€œè½¯æ€§â€çš„è¯­æ³•ã€‚</p>
<p>æ˜¾ç„¶ï¼Œè¿™ç§çœ‹ä¸Šå»ç»†å¾®çš„å·®åˆ«å®é™…ä¸Šå´å¸¦æ¥äº†å·¨å¤§çš„å½±å“ã€‚ä¸€æ–¹é¢ï¼Œè¿™æ˜¯ HTML å¦‚æ­¤æµè¡Œçš„åŸå› ï¼šå®ƒèƒ½åŒ…å®¹æ‚¨çš„é”™è¯¯ï¼Œç®€åŒ–ç½‘ç»œå¼€å‘ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™ä½¿å¾—å®ƒå¾ˆéš¾ç¼–å†™æ­£å¼çš„è¯­æ³•ã€‚æ¦‚æ‹¬åœ°è¯´ï¼ŒHTML æ— æ³•å¾ˆå®¹æ˜“åœ°é€šè¿‡å¸¸è§„è§£æå™¨è§£æï¼ˆå› ä¸ºå®ƒçš„è¯­æ³•ä¸æ˜¯ä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ï¼‰ï¼Œä¹Ÿæ— æ³•é€šè¿‡ XML è§£æå™¨æ¥è§£æã€‚</p>
<h4 id="HTML-DTD"><a href="#HTML-DTD" class="headerlink" title="HTML DTD"></a>HTML DTD</h4><p>HTML çš„å®šä¹‰é‡‡ç”¨äº† DTD æ ¼å¼ã€‚æ­¤æ ¼å¼å¯ç”¨äºå®šä¹‰ SGML æ—çš„è¯­è¨€ã€‚å®ƒåŒ…æ‹¬æ‰€æœ‰å…è®¸ä½¿ç”¨çš„å…ƒç´ åŠå…¶å±æ€§å’Œå±‚æ¬¡ç»“æ„çš„å®šä¹‰ã€‚å¦‚ä¸Šæ–‡æ‰€è¿°ï¼ŒHTML DTD æ— æ³•æ„æˆä¸ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ã€‚</p>
<p>DTD å­˜åœ¨ä¸€äº›å˜ä½“ã€‚ä¸¥æ ¼æ¨¡å¼å®Œå…¨éµå®ˆ HTML è§„èŒƒï¼Œè€Œå…¶ä»–æ¨¡å¼å¯æ”¯æŒä»¥å‰çš„æµè§ˆå™¨æ‰€ä½¿ç”¨çš„æ ‡è®°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ç¡®ä¿å‘ä¸‹å…¼å®¹ä¸€äº›æ—©æœŸç‰ˆæœ¬çš„å†…å®¹ã€‚æœ€æ–°çš„ä¸¥æ ¼æ¨¡å¼ DTD å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š<a href="http://www.w3.org/TR/html4/strict.dtd" target="_blank" rel="noopener">www.w3.org/TR/html4/strict.dtd</a></p>
<h4 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h4><p>è§£æå™¨çš„è¾“å‡ºâ€œè§£ææ ‘â€æ˜¯ç”± DOM å…ƒç´ å’Œå±æ€§èŠ‚ç‚¹æ„æˆçš„æ ‘ç»“æ„ã€‚DOM æ˜¯æ–‡æ¡£å¯¹è±¡æ¨¡å‹ (Document Object Model) çš„ç¼©å†™ã€‚å®ƒæ˜¯ HTML æ–‡æ¡£çš„å¯¹è±¡è¡¨ç¤ºï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¤–éƒ¨å†…å®¹ï¼ˆä¾‹å¦‚ JavaScriptï¼‰ä¸ HTML å…ƒç´ ä¹‹é—´çš„æ¥å£ã€‚<br>è§£ææ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯â€œDocumentâ€å¯¹è±¡ã€‚</p>
<p>DOM ä¸æ ‡è®°ä¹‹é—´å‡ ä¹æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µæ ‡è®°ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">      Hello World</span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"example.png"</span>/&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å¯ç¿»è¯‘æˆå¦‚ä¸‹çš„ DOM æ ‘ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image015.png" alt></p>
<center><strong>å›¾ï¼šç¤ºä¾‹æ ‡è®°çš„ DOM æ ‘</strong></center>

<p>å’Œ HTML ä¸€æ ·ï¼ŒDOM ä¹Ÿæ˜¯ç”± W3C ç»„ç»‡æŒ‡å®šçš„ã€‚è¯·å‚è§ <a href="http://www.w3.org/DOM/DOMTR" target="_blank" rel="noopener">www.w3.org/DOM/DOMTR</a>ã€‚è¿™æ˜¯å…³äºæ–‡æ¡£æ“ä½œçš„é€šç”¨è§„èŒƒã€‚å…¶ä¸­ä¸€ä¸ªç‰¹å®šæ¨¡å—æè¿°é’ˆå¯¹ HTML çš„å…ƒç´ ã€‚HTML çš„å®šä¹‰å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ï¼š<a href="http://www.w3.org/TR/2003/REC-DOM-Level-2-HTML-20030109/idl-definitions.html" target="_blank" rel="noopener">www.w3.org/TR/2003/REC-DOM-Level-2-HTML-20030109/idl-definitions.html</a>ã€‚</p>
<p>æˆ‘æ‰€è¯´çš„æ ‘åŒ…å« DOM èŠ‚ç‚¹ï¼ŒæŒ‡çš„æ˜¯æ ‘æ˜¯ç”±å®ç°äº†æŸä¸ª DOM æ¥å£çš„å…ƒç´ æ„æˆçš„ã€‚æµè§ˆå™¨åœ¨å…·ä½“çš„å®ç°ä¸­ä¼šæœ‰ä¸€äº›ä¾›å†…éƒ¨ä½¿ç”¨çš„å…¶ä»–å±æ€§ã€‚</p>
<h4 id="è§£æç®—æ³•"><a href="#è§£æç®—æ³•" class="headerlink" title="è§£æç®—æ³•"></a>è§£æç®—æ³•</h4><p>æˆ‘ä»¬åœ¨ä¹‹å‰ç« èŠ‚å·²ç»è¯´è¿‡ï¼ŒHTML æ— æ³•ç”¨å¸¸è§„çš„è‡ªä¸Šè€Œä¸‹æˆ–è‡ªä¸‹è€Œä¸Šçš„è§£æå™¨è¿›è¡Œè§£æã€‚</p>
<p>åŸå› åœ¨äºï¼š</p>
<ol>
<li>è¯­è¨€çš„å®½å®¹æœ¬è´¨ã€‚</li>
</ol>
<ul>
<li>æµè§ˆå™¨å†æ¥å¯¹ä¸€äº›å¸¸è§çš„æ— æ•ˆ HTML ç”¨æ³•é‡‡å–åŒ…å®¹æ€åº¦ã€‚</li>
<li>è§£æè¿‡ç¨‹éœ€è¦ä¸æ–­åœ°åå¤ã€‚æºå†…å®¹åœ¨è§£æè¿‡ç¨‹ä¸­é€šå¸¸ä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯åœ¨ HTML ä¸­ï¼Œè„šæœ¬æ ‡è®°å¦‚æœåŒ…å« document.writeï¼Œå°±ä¼šæ·»åŠ é¢å¤–çš„æ ‡è®°ï¼Œè¿™æ ·è§£æè¿‡ç¨‹å®é™…ä¸Šå°±æ›´æ”¹äº†è¾“å…¥å†…å®¹ã€‚</li>
</ul>
<p>ç”±äºä¸èƒ½ä½¿ç”¨å¸¸è§„çš„è§£ææŠ€æœ¯ï¼Œæµè§ˆå™¨å°±åˆ›å»ºäº†è‡ªå®šä¹‰çš„è§£æå™¨æ¥è§£æ HTMLã€‚</p>
<p>HTML5 è§„èŒƒè¯¦ç»†åœ°æè¿°äº†è§£æç®—æ³•ã€‚æ­¤ç®—æ³•ç”±ä¸¤ä¸ªé˜¶æ®µç»„æˆï¼šæ ‡è®°åŒ–å’Œæ ‘æ„å»ºã€‚</p>
<p>æ ‡è®°åŒ–æ˜¯è¯æ³•åˆ†æè¿‡ç¨‹ï¼Œå°†è¾“å…¥å†…å®¹è§£ææˆå¤šä¸ªæ ‡è®°ã€‚HTML æ ‡è®°åŒ…æ‹¬èµ·å§‹æ ‡è®°ã€ç»“æŸæ ‡è®°ã€å±æ€§åç§°å’Œå±æ€§å€¼ã€‚</p>
<p>æ ‡è®°ç”Ÿæˆå™¨è¯†åˆ«æ ‡è®°ï¼Œä¼ é€’ç»™æ ‘æ„é€ å™¨ï¼Œç„¶åæ¥å—ä¸‹ä¸€ä¸ªå­—ç¬¦ä»¥è¯†åˆ«ä¸‹ä¸€ä¸ªæ ‡è®°ï¼›å¦‚æ­¤åå¤ç›´åˆ°è¾“å…¥çš„ç»“æŸã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image017.png" alt></p>
<center><strong>å›¾ï¼šHTML è§£ææµç¨‹ï¼ˆæ‘˜è‡ª HTML5 è§„èŒƒï¼‰</strong></center>

<h4 id="æ ‡è®°åŒ–ç®—æ³•"><a href="#æ ‡è®°åŒ–ç®—æ³•" class="headerlink" title="æ ‡è®°åŒ–ç®—æ³•"></a>æ ‡è®°åŒ–ç®—æ³•</h4><p>è¯¥ç®—æ³•çš„è¾“å‡ºç»“æœæ˜¯ HTML æ ‡è®°ã€‚è¯¥ç®—æ³•ä½¿ç”¨çŠ¶æ€æœºæ¥è¡¨ç¤ºã€‚æ¯ä¸€ä¸ªçŠ¶æ€æ¥æ”¶æ¥è‡ªè¾“å…¥ä¿¡æ¯æµçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ï¼Œå¹¶æ ¹æ®è¿™äº›å­—ç¬¦æ›´æ–°ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚å½“å‰çš„æ ‡è®°åŒ–çŠ¶æ€å’Œæ ‘ç»“æ„çŠ¶æ€ä¼šå½±å“è¿›å…¥ä¸‹ä¸€çŠ¶æ€çš„å†³å®šã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿æ¥æ”¶çš„å­—ç¬¦ç›¸åŒï¼Œå¯¹äºä¸‹ä¸€ä¸ªæ­£ç¡®çš„çŠ¶æ€ä¹Ÿä¼šäº§ç”Ÿä¸åŒçš„ç»“æœï¼Œå…·ä½“å–å†³äºå½“å‰çš„çŠ¶æ€ã€‚è¯¥ç®—æ³•ç›¸å½“å¤æ‚ï¼Œæ— æ³•åœ¨æ­¤è¯¦è¿°ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥å¸®åŠ©å¤§å®¶ç†è§£å…¶åŸç†ã€‚</p>
<p>åŸºæœ¬ç¤ºä¾‹ - å°†ä¸‹é¢çš„ HTML ä»£ç æ ‡è®°åŒ–ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello world</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åˆå§‹çŠ¶æ€æ˜¯æ•°æ®çŠ¶æ€ã€‚é‡åˆ°å­—ç¬¦ &lt; æ—¶ï¼ŒçŠ¶æ€æ›´æ”¹ä¸ºâ€œæ ‡è®°æ‰“å¼€çŠ¶æ€â€ã€‚æ¥æ”¶ä¸€ä¸ª a-z å­—ç¬¦ä¼šåˆ›å»ºâ€œèµ·å§‹æ ‡è®°â€ï¼ŒçŠ¶æ€æ›´æ”¹ä¸ºâ€œæ ‡è®°åç§°çŠ¶æ€â€ã€‚è¿™ä¸ªçŠ¶æ€ä¼šä¸€ç›´ä¿æŒåˆ°æ¥æ”¶ &gt; å­—ç¬¦ã€‚åœ¨æ­¤æœŸé—´æ¥æ”¶çš„æ¯ä¸ªå­—ç¬¦éƒ½ä¼šé™„åŠ åˆ°æ–°çš„æ ‡è®°åç§°ä¸Šã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºçš„æ ‡è®°æ˜¯ html æ ‡è®°ã€‚</p>
<p>é‡åˆ° &gt; æ ‡è®°æ—¶ï¼Œä¼šå‘é€å½“å‰çš„æ ‡è®°ï¼ŒçŠ¶æ€æ”¹å›â€œæ•°æ®çŠ¶æ€â€ã€‚<body> æ ‡è®°ä¹Ÿä¼šè¿›è¡ŒåŒæ ·çš„å¤„ç†ã€‚ç›®å‰ html å’Œ body æ ‡è®°å‡å·²å‘å‡ºã€‚ç°åœ¨æˆ‘ä»¬å›åˆ°â€œæ•°æ®çŠ¶æ€â€ã€‚æ¥æ”¶åˆ° Hello world ä¸­çš„ H å­—ç¬¦æ—¶ï¼Œå°†åˆ›å»ºå¹¶å‘é€å­—ç¬¦æ ‡è®°ï¼Œç›´åˆ°æ¥æ”¶ <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"superSample":2,"width":100,"height":200,"position":"right","hOffset":0,"vOffset":-20},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body> ä¸­çš„ &lt;ã€‚æˆ‘ä»¬å°†ä¸º Hello world ä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½å‘é€ä¸€ä¸ªå­—ç¬¦æ ‡è®°ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å›åˆ°â€œæ ‡è®°æ‰“å¼€çŠ¶æ€â€ã€‚æ¥æ”¶ä¸‹ä¸€ä¸ªè¾“å…¥å­—ç¬¦ / æ—¶ï¼Œä¼šåˆ›å»º end tag token å¹¶æ”¹ä¸ºâ€œæ ‡è®°åç§°çŠ¶æ€â€ã€‚æˆ‘ä»¬ä¼šå†æ¬¡ä¿æŒè¿™ä¸ªçŠ¶æ€ï¼Œç›´åˆ°æ¥æ”¶ &gt;ã€‚ç„¶åå°†å‘é€æ–°çš„æ ‡è®°ï¼Œå¹¶å›åˆ°â€œæ•°æ®çŠ¶æ€â€ã€‚ è¾“å…¥ä¹Ÿä¼šè¿›è¡ŒåŒæ ·çš„å¤„ç†ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image019.png" alt></p>
<center><strong>å›¾ï¼šå¯¹ç¤ºä¾‹è¾“å…¥è¿›è¡Œæ ‡è®°åŒ–</strong></center>

<h4 id="æ ‘æ„å»ºç®—æ³•"><a href="#æ ‘æ„å»ºç®—æ³•" class="headerlink" title="æ ‘æ„å»ºç®—æ³•"></a>æ ‘æ„å»ºç®—æ³•</h4><p>åœ¨åˆ›å»ºè§£æå™¨çš„åŒæ—¶ï¼Œä¹Ÿä¼šåˆ›å»º Document å¯¹è±¡ã€‚åœ¨æ ‘æ„å»ºé˜¶æ®µï¼Œä»¥ Document ä¸ºæ ¹èŠ‚ç‚¹çš„ DOM æ ‘ä¹Ÿä¼šä¸æ–­è¿›è¡Œä¿®æ”¹ï¼Œå‘å…¶ä¸­æ·»åŠ å„ç§å…ƒç´ ã€‚æ ‡è®°ç”Ÿæˆå™¨å‘é€çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šç”±æ ‘æ„å»ºå™¨è¿›è¡Œå¤„ç†ã€‚è§„èŒƒä¸­å®šä¹‰äº†æ¯ä¸ªæ ‡è®°æ‰€å¯¹åº”çš„ DOM å…ƒç´ ï¼Œè¿™äº›å…ƒç´ ä¼šåœ¨æ¥æ”¶åˆ°ç›¸åº”çš„æ ‡è®°æ—¶åˆ›å»ºã€‚è¿™äº›å…ƒç´ ä¸ä»…ä¼šæ·»åŠ åˆ° DOM æ ‘ä¸­ï¼Œè¿˜ä¼šæ·»åŠ åˆ°å¼€æ”¾å…ƒç´ çš„å †æ ˆä¸­ã€‚æ­¤å †æ ˆç”¨äºçº æ­£åµŒå¥—é”™è¯¯å’Œå¤„ç†æœªå…³é—­çš„æ ‡è®°ã€‚å…¶ç®—æ³•ä¹Ÿå¯ä»¥ç”¨çŠ¶æ€æœºæ¥æè¿°ã€‚è¿™äº›çŠ¶æ€ç§°ä¸ºâ€œæ’å…¥æ¨¡å¼â€ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ç¤ºä¾‹è¾“å…¥çš„æ ‘æ„å»ºè¿‡ç¨‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello world</span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ ‘æ„å»ºé˜¶æ®µçš„è¾“å…¥æ˜¯ä¸€ä¸ªæ¥è‡ªæ ‡è®°åŒ–é˜¶æ®µçš„æ ‡è®°åºåˆ—ã€‚ç¬¬ä¸€ä¸ªæ¨¡å¼æ˜¯â€œinitial modeâ€ã€‚æ¥æ”¶ HTML æ ‡è®°åè½¬ä¸ºâ€œbefore htmlâ€æ¨¡å¼ï¼Œå¹¶åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹é‡æ–°å¤„ç†æ­¤æ ‡è®°ã€‚è¿™æ ·ä¼šåˆ›å»ºä¸€ä¸ª HTMLHtmlElement å…ƒç´ ï¼Œå¹¶å°†å…¶é™„åŠ åˆ° Document æ ¹å¯¹è±¡ä¸Šã€‚</p>
<p>ç„¶åçŠ¶æ€å°†æ”¹ä¸ºâ€œbefore headâ€ã€‚æ­¤æ—¶æˆ‘ä»¬æ¥æ”¶â€œbodyâ€æ ‡è®°ã€‚å³ä½¿æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­æ²¡æœ‰â€œheadâ€æ ‡è®°ï¼Œç³»ç»Ÿä¹Ÿä¼šéšå¼åˆ›å»ºä¸€ä¸ª HTMLHeadElementï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ ‘ä¸­ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬è¿›å…¥äº†â€œin headâ€æ¨¡å¼ï¼Œç„¶åè½¬å…¥â€œafter headâ€æ¨¡å¼ã€‚ç³»ç»Ÿå¯¹ body æ ‡è®°è¿›è¡Œé‡æ–°å¤„ç†ï¼Œåˆ›å»ºå¹¶æ’å…¥ HTMLBodyElementï¼ŒåŒæ—¶æ¨¡å¼è½¬å˜ä¸ºâ€œin bodyâ€ã€‚</p>
<p>ç°åœ¨ï¼Œæ¥æ”¶ç”±â€œHello worldâ€å­—ç¬¦ä¸²ç”Ÿæˆçš„ä¸€ç³»åˆ—å­—ç¬¦æ ‡è®°ã€‚æ¥æ”¶ç¬¬ä¸€ä¸ªå­—ç¬¦æ—¶ä¼šåˆ›å»ºå¹¶æ’å…¥â€œTextâ€èŠ‚ç‚¹ï¼Œè€Œå…¶ä»–å­—ç¬¦ä¹Ÿå°†é™„åŠ åˆ°è¯¥èŠ‚ç‚¹ã€‚</p>
<p>æ¥æ”¶ body ç»“æŸæ ‡è®°ä¼šè§¦å‘â€œafter bodyâ€æ¨¡å¼ã€‚ç°åœ¨æˆ‘ä»¬å°†æ¥æ”¶ HTML ç»“æŸæ ‡è®°ï¼Œç„¶åè¿›å…¥â€œafter after bodyâ€æ¨¡å¼ã€‚æ¥æ”¶åˆ°æ–‡ä»¶ç»“æŸæ ‡è®°åï¼Œè§£æè¿‡ç¨‹å°±æ­¤ç»“æŸã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image022.gif" alt></p>
<center><strong>å›¾ï¼šç¤ºä¾‹ HTML çš„æ ‘æ„å»º</strong></center>

<h4 id="è§£æç»“æŸåçš„æ“ä½œ"><a href="#è§£æç»“æŸåçš„æ“ä½œ" class="headerlink" title="è§£æç»“æŸåçš„æ“ä½œ"></a>è§£æç»“æŸåçš„æ“ä½œ</h4><p>åœ¨æ­¤é˜¶æ®µï¼Œæµè§ˆå™¨ä¼šå°†æ–‡æ¡£æ ‡æ³¨ä¸ºäº¤äº’çŠ¶æ€ï¼Œå¹¶å¼€å§‹è§£æé‚£äº›å¤„äºâ€œdeferredâ€æ¨¡å¼çš„è„šæœ¬ï¼Œä¹Ÿå°±æ˜¯é‚£äº›åº”åœ¨æ–‡æ¡£è§£æå®Œæˆåæ‰æ‰§è¡Œçš„è„šæœ¬ã€‚ç„¶åï¼Œæ–‡æ¡£çŠ¶æ€å°†è®¾ç½®ä¸ºâ€œå®Œæˆâ€ï¼Œä¸€ä¸ªâ€œåŠ è½½â€äº‹ä»¶å°†éšä¹‹è§¦å‘ã€‚</p>
<p>æ‚¨å¯ä»¥åœ¨ HTML5 è§„èŒƒä¸­æŸ¥çœ‹æ ‡è®°åŒ–å’Œæ ‘æ„å»ºçš„å®Œæ•´ç®—æ³•</p>
<h4 id="æµè§ˆå™¨çš„å®¹é”™æœºåˆ¶"><a href="#æµè§ˆå™¨çš„å®¹é”™æœºåˆ¶" class="headerlink" title="æµè§ˆå™¨çš„å®¹é”™æœºåˆ¶"></a>æµè§ˆå™¨çš„å®¹é”™æœºåˆ¶</h4><p>æ‚¨åœ¨æµè§ˆ HTML ç½‘é¡µæ—¶ä»æ¥ä¸ä¼šçœ‹åˆ°â€œè¯­æ³•æ— æ•ˆâ€çš„é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºæµè§ˆå™¨ä¼šçº æ­£ä»»ä½•æ— æ•ˆå†…å®¹ï¼Œç„¶åç»§ç»­å·¥ä½œã€‚</p>
<p>ä»¥ä¸‹é¢çš„ HTML ä»£ç ä¸ºä¾‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mytag</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mytag</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    Really lousy HTML</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘å·²ç»è¿åäº†å¾ˆå¤šè¯­æ³•è§„åˆ™ï¼ˆâ€œmytagâ€ä¸æ˜¯æ ‡å‡†çš„æ ‡è®°ï¼Œâ€œpâ€å’Œâ€œdivâ€å…ƒç´ ä¹‹é—´çš„åµŒå¥—æœ‰è¯¯ç­‰ç­‰ï¼‰ï¼Œä½†æ˜¯æµè§ˆå™¨ä»ç„¶ä¼šæ­£ç¡®åœ°æ˜¾ç¤ºè¿™äº›å†…å®¹ï¼Œå¹¶ä¸”æ¯«æ— æ€¨è¨€ã€‚å› ä¸ºæœ‰å¤§é‡çš„è§£æå™¨ä»£ç ä¼šçº æ­£ HTML ç½‘é¡µä½œè€…çš„é”™è¯¯ã€‚</p>
<p>ä¸åŒæµè§ˆå™¨çš„é”™è¯¯å¤„ç†æœºåˆ¶ç›¸å½“ä¸€è‡´ï¼Œä½†ä»¤äººç§°å¥‡çš„æ˜¯ï¼Œè¿™ç§æœºåˆ¶å¹¶ä¸æ˜¯ HTML å½“å‰è§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚å’Œä¹¦ç­¾ç®¡ç†ä»¥åŠå‰è¿›/åé€€æŒ‰é’®ä¸€æ ·ï¼Œå®ƒä¹Ÿæ˜¯æµè§ˆå™¨åœ¨å¤šå¹´å‘å±•ä¸­çš„äº§ç‰©ã€‚å¾ˆå¤šç½‘ç«™éƒ½æ™®éå­˜åœ¨ç€ä¸€äº›å·²çŸ¥çš„æ— æ•ˆ HTML ç»“æ„ï¼Œæ¯ä¸€ç§æµè§ˆå™¨éƒ½ä¼šå°è¯•é€šè¿‡å’Œå…¶ä»–æµè§ˆå™¨ä¸€æ ·çš„æ–¹å¼æ¥ä¿®å¤è¿™äº›æ— æ•ˆç»“æ„ã€‚</p>
<p>HTML5 è§„èŒƒå®šä¹‰äº†ä¸€éƒ¨åˆ†è¿™æ ·çš„è¦æ±‚ã€‚WebKit åœ¨ HTML è§£æå™¨ç±»çš„å¼€å¤´æ³¨é‡Šä¸­å¯¹æ­¤åšäº†å¾ˆå¥½çš„æ¦‚æ‹¬ã€‚</p>
<blockquote>
<p>è§£æå™¨å¯¹æ ‡è®°åŒ–è¾“å…¥å†…å®¹è¿›è¡Œè§£æï¼Œä»¥æ„å»ºæ–‡æ¡£æ ‘ã€‚å¦‚æœæ–‡æ¡£çš„æ ¼å¼æ­£ç¡®ï¼Œå°±ç›´æ¥è¿›è¡Œè§£æã€‚<br>é—æ†¾çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å¤„ç†å¾ˆå¤šæ ¼å¼é”™è¯¯çš„ HTML æ–‡æ¡£ï¼Œæ‰€ä»¥è§£æå™¨å¿…é¡»å…·å¤‡ä¸€å®šçš„å®¹é”™æ€§ã€‚<br>æˆ‘ä»¬è‡³å°‘è¦èƒ½å¤Ÿå¤„ç†ä»¥ä¸‹é”™è¯¯æƒ…å†µï¼š</p>
<ol>
<li>æ˜æ˜¾ä¸èƒ½åœ¨æŸäº›å¤–éƒ¨æ ‡è®°ä¸­æ·»åŠ çš„å…ƒç´ ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å…³é—­æ‰€æœ‰æ ‡è®°ï¼Œç›´åˆ°å‡ºç°ç¦æ­¢æ·»åŠ çš„å…ƒç´ ï¼Œç„¶åå†åŠ å…¥è¯¥å…ƒç´ ã€‚</li>
<li>æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ·»åŠ çš„å…ƒç´ ã€‚è¿™å¾ˆå¯èƒ½æ˜¯ç½‘é¡µä½œè€…å¿˜è®°æ·»åŠ äº†å…¶ä¸­çš„ä¸€äº›æ ‡è®°ï¼ˆæˆ–è€…å…¶ä¸­çš„æ ‡è®°æ˜¯å¯é€‰çš„ï¼‰ã€‚è¿™äº›æ ‡ç­¾å¯èƒ½åŒ…æ‹¬ï¼šHTML HEAD BODY TBODY TR TD LIï¼ˆè¿˜æœ‰é—æ¼çš„å—ï¼Ÿï¼‰ã€‚</li>
<li>å‘ inline å…ƒç´ å†…æ·»åŠ  block å…ƒç´ ã€‚å…³é—­æ‰€æœ‰ inline å…ƒç´ ï¼Œç›´åˆ°å‡ºç°ä¸‹ä¸€ä¸ªè¾ƒé«˜çº§çš„ block å…ƒç´ ã€‚</li>
<li>å¦‚æœè¿™æ ·ä»ç„¶æ— æ•ˆï¼Œå¯å…³é—­æ‰€æœ‰å…ƒç´ ï¼Œç›´åˆ°å¯ä»¥æ·»åŠ å…ƒç´ ä¸ºæ­¢ï¼Œæˆ–è€…å¿½ç•¥è¯¥æ ‡è®°ã€‚</li>
</ol>
</blockquote>
<p>è®©æˆ‘ä»¬çœ‹ä¸€äº› WebKit å®¹é”™çš„ç¤ºä¾‹ï¼š</p>
<h5 id="ä½¿ç”¨äº†-lt-br-gt-è€Œä¸æ˜¯-lt-br-gt"><a href="#ä½¿ç”¨äº†-lt-br-gt-è€Œä¸æ˜¯-lt-br-gt" class="headerlink" title="ä½¿ç”¨äº† &lt;/br&gt; è€Œä¸æ˜¯ &lt;br&gt;"></a><code>ä½¿ç”¨äº† &lt;/br&gt; è€Œä¸æ˜¯ &lt;br&gt;</code></h5><p>æœ‰äº›ç½‘ç«™ä½¿ç”¨äº† <code>&lt;/br&gt;</code> è€Œä¸æ˜¯ <code>&lt;br&gt;</code>ã€‚ä¸ºäº†ä¸ IE å’Œ Firefox å…¼å®¹ï¼ŒWebKit å°†å…¶ä¸ <code>&lt;br&gt;</code> åšåŒæ ·çš„å¤„ç†ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">if (t-&gt;isCloseTag(brTag) &amp;&amp; m_document-&gt;inCompatMode()) &#123;</span><br><span class="line">     reportError(MalformedBRError);</span><br><span class="line">     t-&gt;beginTag = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯·æ³¨æ„ï¼Œé”™è¯¯å¤„ç†æ˜¯åœ¨å†…éƒ¨è¿›è¡Œçš„ï¼Œç”¨æˆ·å¹¶ä¸ä¼šçœ‹åˆ°è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<h5 id="ç¦»æ•£è¡¨æ ¼"><a href="#ç¦»æ•£è¡¨æ ¼" class="headerlink" title="ç¦»æ•£è¡¨æ ¼"></a><code>ç¦»æ•£è¡¨æ ¼</code></h5><p>ç¦»æ•£è¡¨æ ¼æ˜¯æŒ‡ä½äºå…¶ä»–è¡¨æ ¼å†…å®¹ä¸­ï¼Œä½†åˆä¸åœ¨ä»»ä½•ä¸€ä¸ªå•å…ƒæ ¼å†…çš„è¡¨æ ¼ã€‚<br>æ¯”å¦‚ä»¥ä¸‹çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>inner table<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>outer table<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>WebKit ä¼šå°†å…¶å±‚æ¬¡ç»“æ„æ›´æ”¹ä¸ºä¸¤ä¸ªåŒçº§è¡¨æ ¼ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>outer table<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span>inner table<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (m_inStrayTableContent &amp;&amp; localName == tableTag)</span><br><span class="line">        popBlock(tableTag);</span><br></pre></td></tr></table></figure>
<p>WebKit ä½¿ç”¨ä¸€ä¸ªå †æ ˆæ¥ä¿å­˜å½“å‰çš„å…ƒç´ å†…å®¹ï¼Œå®ƒä¼šä»å¤–éƒ¨è¡¨æ ¼çš„å †æ ˆä¸­å¼¹å‡ºå†…éƒ¨è¡¨æ ¼ã€‚ç°åœ¨ï¼Œè¿™ä¸¤ä¸ªè¡¨æ ¼å°±å˜æˆäº†åŒçº§å…³ç³»ã€‚</p>
<h5 id="åµŒå¥—çš„è¡¨å•å…ƒç´ "><a href="#åµŒå¥—çš„è¡¨å•å…ƒç´ " class="headerlink" title="åµŒå¥—çš„è¡¨å•å…ƒç´ "></a><code>åµŒå¥—çš„è¡¨å•å…ƒç´ </code></h5><p>å¦‚æœç”¨æˆ·åœ¨ä¸€ä¸ªè¡¨å•å…ƒç´ ä¸­åˆæ”¾å…¥äº†å¦ä¸€ä¸ªè¡¨å•ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªè¡¨å•å°†è¢«å¿½ç•¥ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!m_currentFormElement) &#123;</span><br><span class="line">        m_currentFormElement = <span class="keyword">new</span> HTMLFormElement(formTag,    m_document);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è¿‡äºå¤æ‚çš„æ ‡è®°å±‚æ¬¡ç»“æ„"><a href="#è¿‡äºå¤æ‚çš„æ ‡è®°å±‚æ¬¡ç»“æ„" class="headerlink" title="è¿‡äºå¤æ‚çš„æ ‡è®°å±‚æ¬¡ç»“æ„"></a><code>è¿‡äºå¤æ‚çš„æ ‡è®°å±‚æ¬¡ç»“æ„</code></h5><p>ä»£ç çš„æ³¨é‡Šå·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†ã€‚ </p>
<blockquote>
<p>ç¤ºä¾‹ç½‘ç«™ <a href="http://www.liceo.edu.mx" target="_blank" rel="noopener">www.liceo.edu.mx</a> åµŒå¥—äº†çº¦ 1500 ä¸ªæ ‡è®°ï¼Œå…¨éƒ½æ¥è‡ªä¸€å † <b> æ ‡è®°ã€‚æˆ‘ä»¬åªå…è®¸æœ€å¤š 20 å±‚åŒç±»å‹æ ‡è®°çš„åµŒå¥—ï¼Œå¦‚æœå†åµŒå¥—æ›´å¤šï¼Œå°±ä¼šå…¨éƒ¨å¿½ç•¥ã€‚</b></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">bool HTMLParser::allowNestedRedundantTag(<span class="keyword">const</span> AtomicString&amp; tagName)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">unsigned i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (HTMLStackElem* curr = m_blockStack;</span><br><span class="line">         i &lt; cMaxRedundantTagDepth &amp;&amp; curr &amp;&amp; curr-&gt;tagName == tagName;</span><br><span class="line">     curr = curr-&gt;next, i++) &#123; &#125;</span><br><span class="line"><span class="keyword">return</span> i != cMaxRedundantTagDepth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="æ”¾é”™ä½ç½®çš„-html-æˆ–è€…-body-ç»“æŸæ ‡è®°"><a href="#æ”¾é”™ä½ç½®çš„-html-æˆ–è€…-body-ç»“æŸæ ‡è®°" class="headerlink" title="æ”¾é”™ä½ç½®çš„ html æˆ–è€… body ç»“æŸæ ‡è®°"></a><code>æ”¾é”™ä½ç½®çš„ html æˆ–è€… body ç»“æŸæ ‡è®°</code></h5><p>åŒæ ·ï¼Œä»£ç çš„æ³¨é‡Šå·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†ã€‚</p>
<blockquote>
<p>æ”¯æŒæ ¼å¼éå¸¸ç³Ÿç³•çš„ HTML ä»£ç ã€‚æˆ‘ä»¬ä»ä¸å…³é—­ body æ ‡è®°ï¼Œå› ä¸ºä¸€äº›æ„šè ¢çš„ç½‘é¡µä¼šåœ¨å®é™…æ–‡æ¡£ç»“æŸä¹‹å‰å°±å…³é—­ã€‚æˆ‘ä»¬é€šè¿‡è°ƒç”¨ end() æ¥æ‰§è¡Œå…³é—­æ“ä½œã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (t-&gt;tagName == htmlTag || t-&gt;tagName == bodyTag )</span><br><span class="line">        <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ç½‘é¡µä½œè€…éœ€è¦æ³¨æ„ï¼Œé™¤éæ‚¨æƒ³ä½œä¸ºåé¢æ•™æå‡ºç°åœ¨ WebKit å®¹é”™ä»£ç æ®µçš„ç¤ºä¾‹ä¸­ï¼Œå¦åˆ™è¿˜è¯·ç¼–å†™æ ¼å¼æ­£ç¡®çš„ HTML ä»£ç ã€‚</p>
<h3 id="CSS-è§£æ"><a href="#CSS-è§£æ" class="headerlink" title="CSS è§£æ"></a>CSS è§£æ</h3><p>è¿˜è®°å¾—ç®€ä»‹ä¸­è§£æçš„æ¦‚å¿µå—ï¼Ÿå’Œ HTML ä¸åŒï¼ŒCSS æ˜¯ä¸Šä¸‹æ–‡æ— å…³çš„è¯­æ³•ï¼Œå¯ä»¥ä½¿ç”¨ç®€ä»‹ä¸­æè¿°çš„å„ç§è§£æå™¨è¿›è¡Œè§£æã€‚äº‹å®ä¸Šï¼ŒCSS è§„èŒƒå®šä¹‰äº† CSS çš„è¯æ³•å’Œè¯­æ³•ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€äº›ç¤ºä¾‹ï¼š<br>è¯æ³•è¯­æ³•ï¼ˆè¯æ±‡ï¼‰æ˜¯é’ˆå¯¹å„ä¸ªæ ‡è®°ç”¨æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">comment   \/\*[^*]*\*+([^/*][^*]*\*+)*\/</span><br><span class="line">num   [0-9]+|[0-9]*&quot;.&quot;[0-9]+</span><br><span class="line">nonascii  [\200-\377]</span><br><span class="line">nmstart   [_a-z]|&#123;nonascii&#125;|&#123;escape&#125;</span><br><span class="line">nmchar    [_a-z0-9-]|&#123;nonascii&#125;|&#123;escape&#125;</span><br><span class="line">name    &#123;nmchar&#125;+</span><br><span class="line">ident   &#123;nmstart&#125;&#123;nmchar&#125;*</span><br></pre></td></tr></table></figure>
<p>â€œidentâ€æ˜¯æ ‡è¯†ç¬¦ (identifier) çš„ç¼©å†™ï¼Œæ¯”å¦‚ç±»åã€‚â€œnameâ€æ˜¯å…ƒç´ çš„ IDï¼ˆé€šè¿‡â€œ#â€æ¥å¼•ç”¨ï¼‰ã€‚</p>
<p>è¯­æ³•æ˜¯é‡‡ç”¨ BNF æ ¼å¼æè¿°çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ruleset</span><br><span class="line">  : selector [ &apos;,&apos; S* selector ]*</span><br><span class="line">    &apos;&#123;&apos; S* declaration [ &apos;;&apos; S* declaration ]* &apos;&#125;&apos; S*</span><br><span class="line">  ;</span><br><span class="line">selector</span><br><span class="line">  : simple_selector [ combinator selector | S+ [ combinator? selector ]? ]?</span><br><span class="line">  ;</span><br><span class="line">simple_selector</span><br><span class="line">  : element_name [ HASH | class | attrib | pseudo ]*</span><br><span class="line">  | [ HASH | class | attrib | pseudo ]+</span><br><span class="line">  ;</span><br><span class="line">class</span><br><span class="line">  : &apos;.&apos; IDENT</span><br><span class="line">  ;</span><br><span class="line">element_name</span><br><span class="line">  : IDENT | &apos;*&apos;</span><br><span class="line">  ;</span><br><span class="line">attrib</span><br><span class="line">  : &apos;[&apos; S* IDENT S* [ [ &apos;=&apos; | INCLUDES | DASHMATCH ] S*</span><br><span class="line">    [ IDENT | STRING ] S* ] &apos;]&apos;</span><br><span class="line">  ;</span><br><span class="line">pseudo</span><br><span class="line">  : &apos;:&apos; [ IDENT | FUNCTION S* [IDENT S*] &apos;)&apos; ]</span><br><span class="line">  ;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼šè¿™æ˜¯ä¸€ä¸ªè§„åˆ™é›†çš„ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">div.error , a.error &#123;</span><br><span class="line">  color:red;</span><br><span class="line">  font-weight:bold;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>div.error å’Œ a.error æ˜¯é€‰æ‹©å™¨ã€‚å¤§æ‹¬å·å†…çš„éƒ¨åˆ†åŒ…å«äº†ç”±æ­¤è§„åˆ™é›†åº”ç”¨çš„è§„åˆ™ã€‚æ­¤ç»“æ„çš„æ­£å¼å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ruleset</span><br><span class="line">  : selector [ &apos;,&apos; S* selector ]*</span><br><span class="line">    &apos;&#123;&apos; S* declaration [ &apos;;&apos; S* declaration ]* &apos;&#125;&apos; S*</span><br><span class="line">  ;</span><br></pre></td></tr></table></figure>
<p>è¿™è¡¨ç¤ºä¸€ä¸ªè§„åˆ™é›†å°±æ˜¯ä¸€ä¸ªé€‰æ‹©å™¨ï¼Œæˆ–è€…ç”±é€—å·å’Œç©ºæ ¼ï¼ˆS è¡¨ç¤ºç©ºæ ¼ï¼‰åˆ†éš”çš„å¤šä¸ªï¼ˆæ•°é‡å¯é€‰ï¼‰é€‰æ‹©å™¨ã€‚è§„åˆ™é›†åŒ…å«äº†å¤§æ‹¬å·ï¼Œä»¥åŠå…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼ˆæ•°é‡å¯é€‰ï¼‰ç”±åˆ†å·åˆ†éš”çš„å£°æ˜ã€‚â€œå£°æ˜â€å’Œâ€œé€‰æ‹©å™¨â€å°†ç”±ä¸‹é¢çš„ BNF æ ¼å¼å®šä¹‰ã€‚</p>
<h4 id="WebKit-CSS-è§£æå™¨"><a href="#WebKit-CSS-è§£æå™¨" class="headerlink" title="WebKit CSS è§£æå™¨"></a>WebKit CSS è§£æå™¨</h4><p>WebKit ä½¿ç”¨ Flex å’Œ Bison è§£æå™¨ç”Ÿæˆå™¨ï¼Œé€šè¿‡ CSS è¯­æ³•æ–‡ä»¶è‡ªåŠ¨åˆ›å»ºè§£æå™¨ã€‚æ­£å¦‚æˆ‘ä»¬ä¹‹å‰åœ¨è§£æå™¨ç®€ä»‹ä¸­æ‰€è¯´ï¼ŒBison ä¼šåˆ›å»ºè‡ªä¸‹è€Œä¸Šçš„ç§»ä½å½’çº¦è§£æå™¨ã€‚Firefox ä½¿ç”¨çš„æ˜¯äººå·¥ç¼–å†™çš„è‡ªä¸Šè€Œä¸‹çš„è§£æå™¨ã€‚è¿™ä¸¤ç§è§£æå™¨éƒ½ä¼šå°† CSS æ–‡ä»¶è§£ææˆ StyleSheet å¯¹è±¡ï¼Œä¸”æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å« CSS è§„åˆ™ã€‚CSS è§„åˆ™å¯¹è±¡åˆ™åŒ…å«é€‰æ‹©å™¨å’Œå£°æ˜å¯¹è±¡ï¼Œä»¥åŠå…¶ä»–ä¸ CSS è¯­æ³•å¯¹åº”çš„å¯¹è±¡ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image023.png" alt></p>
<center><strong>å›¾ï¼šè§£æ CSS</strong></center>

<h3 id="å¤„ç†è„šæœ¬å’Œæ ·å¼è¡¨çš„é¡ºåº"><a href="#å¤„ç†è„šæœ¬å’Œæ ·å¼è¡¨çš„é¡ºåº" class="headerlink" title="å¤„ç†è„šæœ¬å’Œæ ·å¼è¡¨çš„é¡ºåº"></a>å¤„ç†è„šæœ¬å’Œæ ·å¼è¡¨çš„é¡ºåº</h3><h4 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h4><p>ç½‘ç»œçš„æ¨¡å‹æ˜¯åŒæ­¥çš„ã€‚ç½‘é¡µä½œè€…å¸Œæœ›è§£æå™¨é‡åˆ° <code>&lt;script&gt;</code> æ ‡è®°æ—¶ç«‹å³è§£æå¹¶æ‰§è¡Œè„šæœ¬ã€‚æ–‡æ¡£çš„è§£æå°†åœæ­¢ï¼Œç›´åˆ°è„šæœ¬æ‰§è¡Œå®Œæ¯•ã€‚å¦‚æœè„šæœ¬æ˜¯å¤–éƒ¨çš„ï¼Œé‚£ä¹ˆè§£æè¿‡ç¨‹ä¼šåœæ­¢ï¼Œç›´åˆ°ä»ç½‘ç»œåŒæ­¥æŠ“å–èµ„æºå®Œæˆåå†ç»§ç»­ã€‚æ­¤æ¨¡å‹å·²ç»ä½¿ç”¨äº†å¤šå¹´ï¼Œä¹Ÿåœ¨ HTML4 å’Œ HTML5 è§„èŒƒä¸­è¿›è¡Œäº†æŒ‡å®šã€‚ä½œè€…ä¹Ÿå¯ä»¥å°†è„šæœ¬æ ‡æ³¨ä¸ºâ€œdeferâ€ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šåœæ­¢æ–‡æ¡£è§£æï¼Œè€Œæ˜¯ç­‰åˆ°è§£æç»“æŸæ‰æ‰§è¡Œã€‚HTML5 å¢åŠ äº†ä¸€ä¸ªé€‰é¡¹ï¼Œå¯å°†è„šæœ¬æ ‡è®°ä¸ºå¼‚æ­¥ï¼Œä»¥ä¾¿ç”±å…¶ä»–çº¿ç¨‹è§£æå’Œæ‰§è¡Œã€‚</p>
<h4 id="é¢„è§£æ"><a href="#é¢„è§£æ" class="headerlink" title="é¢„è§£æ"></a>é¢„è§£æ</h4><p>WebKit å’Œ Firefox éƒ½è¿›è¡Œäº†è¿™é¡¹ä¼˜åŒ–ã€‚åœ¨æ‰§è¡Œè„šæœ¬æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¼šè§£ææ–‡æ¡£çš„å…¶ä½™éƒ¨åˆ†ï¼Œæ‰¾å‡ºå¹¶åŠ è½½éœ€è¦é€šè¿‡ç½‘ç»œåŠ è½½çš„å…¶ä»–èµ„æºã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œèµ„æºå¯ä»¥åœ¨å¹¶è¡Œè¿æ¥ä¸ŠåŠ è½½ï¼Œä»è€Œæé«˜æ€»ä½“é€Ÿåº¦ã€‚è¯·æ³¨æ„ï¼Œé¢„è§£æå™¨ä¸ä¼šä¿®æ”¹ DOM æ ‘ï¼Œè€Œæ˜¯å°†è¿™é¡¹å·¥ä½œäº¤ç”±ä¸»è§£æå™¨å¤„ç†ï¼›é¢„è§£æå™¨åªä¼šè§£æå¤–éƒ¨èµ„æºï¼ˆä¾‹å¦‚å¤–éƒ¨è„šæœ¬ã€æ ·å¼è¡¨å’Œå›¾ç‰‡ï¼‰çš„å¼•ç”¨ã€‚</p>
<h4 id="æ ·å¼è¡¨"><a href="#æ ·å¼è¡¨" class="headerlink" title="æ ·å¼è¡¨"></a>æ ·å¼è¡¨</h4><p>å¦ä¸€æ–¹é¢ï¼Œæ ·å¼è¡¨æœ‰ç€ä¸åŒçš„æ¨¡å‹ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œåº”ç”¨æ ·å¼è¡¨ä¸ä¼šæ›´æ”¹ DOM æ ‘ï¼Œå› æ­¤ä¼¼ä¹æ²¡æœ‰å¿…è¦ç­‰å¾…æ ·å¼è¡¨å¹¶åœæ­¢æ–‡æ¡£è§£æã€‚ä½†è¿™æ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è„šæœ¬åœ¨æ–‡æ¡£è§£æé˜¶æ®µä¼šè¯·æ±‚æ ·å¼ä¿¡æ¯ã€‚å¦‚æœå½“æ—¶è¿˜æ²¡æœ‰åŠ è½½å’Œè§£ææ ·å¼ï¼Œè„šæœ¬å°±ä¼šè·å¾—é”™è¯¯çš„å›å¤ï¼Œè¿™æ ·æ˜¾ç„¶ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ã€‚è¿™çœ‹ä¸Šå»æ˜¯ä¸€ä¸ªéå…¸å‹æ¡ˆä¾‹ï¼Œä½†äº‹å®ä¸Šéå¸¸æ™®éã€‚Firefox åœ¨æ ·å¼è¡¨åŠ è½½å’Œè§£æçš„è¿‡ç¨‹ä¸­ï¼Œä¼šç¦æ­¢æ‰€æœ‰è„šæœ¬ã€‚è€Œå¯¹äº WebKit è€Œè¨€ï¼Œä»…å½“è„šæœ¬å°è¯•è®¿é—®çš„æ ·å¼å±æ€§å¯èƒ½å—å°šæœªåŠ è½½çš„æ ·å¼è¡¨å½±å“æ—¶ï¼Œå®ƒæ‰ä¼šç¦æ­¢è¯¥è„šæœ¬ã€‚</p>
<h2 id="å‘ˆç°æ ‘æ„å»º"><a href="#å‘ˆç°æ ‘æ„å»º" class="headerlink" title="å‘ˆç°æ ‘æ„å»º"></a>å‘ˆç°æ ‘æ„å»º</h2><p>åœ¨ DOM æ ‘æ„å»ºçš„åŒæ—¶ï¼Œæµè§ˆå™¨è¿˜ä¼šæ„å»ºå¦ä¸€ä¸ªæ ‘ç»“æ„ï¼šå‘ˆç°æ ‘ã€‚è¿™æ˜¯ç”±å¯è§†åŒ–å…ƒç´ æŒ‰ç…§å…¶æ˜¾ç¤ºé¡ºåºè€Œç»„æˆçš„æ ‘ï¼Œä¹Ÿæ˜¯æ–‡æ¡£çš„å¯è§†åŒ–è¡¨ç¤ºã€‚å®ƒçš„ä½œç”¨æ˜¯è®©æ‚¨æŒ‰ç…§æ­£ç¡®çš„é¡ºåºç»˜åˆ¶å†…å®¹ã€‚</p>
<p>Firefox å°†å‘ˆç°æ ‘ä¸­çš„å…ƒç´ ç§°ä¸ºâ€œæ¡†æ¶â€ã€‚WebKit ä½¿ç”¨çš„æœ¯è¯­æ˜¯å‘ˆç°å™¨æˆ–å‘ˆç°å¯¹è±¡ã€‚<br>å‘ˆç°å™¨çŸ¥é“å¦‚ä½•å¸ƒå±€å¹¶å°†è‡ªèº«åŠå…¶å­å…ƒç´ ç»˜åˆ¶å‡ºæ¥ã€‚<br>WebKits RenderObject ç±»æ˜¯æ‰€æœ‰å‘ˆç°å™¨çš„åŸºç±»ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class RenderObject&#123;</span><br><span class="line">  virtual void layout();</span><br><span class="line">  virtual void paint(PaintInfo);</span><br><span class="line">  virtual void rect repaintRect();</span><br><span class="line">  Node* node;  //the DOM node</span><br><span class="line">  RenderStyle* style;  // the computed style</span><br><span class="line">  RenderLayer* containgLayer; //the containing z-index layer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€ä¸ªå‘ˆç°å™¨éƒ½ä»£è¡¨äº†ä¸€ä¸ªçŸ©å½¢çš„åŒºåŸŸï¼Œé€šå¸¸å¯¹åº”äºç›¸å…³èŠ‚ç‚¹çš„ CSS æ¡†ï¼Œè¿™ä¸€ç‚¹åœ¨ CSS2 è§„èŒƒä¸­æœ‰æ‰€æè¿°ã€‚å®ƒåŒ…å«è¯¸å¦‚å®½åº¦ã€é«˜åº¦å’Œä½ç½®ç­‰å‡ ä½•ä¿¡æ¯ã€‚<br>æ¡†çš„ç±»å‹ä¼šå—åˆ°ä¸èŠ‚ç‚¹ç›¸å…³çš„â€œdisplayâ€æ ·å¼å±æ€§çš„å½±å“ï¼ˆè¯·å‚é˜…æ ·å¼è®¡ç®—ç« èŠ‚ï¼‰ã€‚ä¸‹é¢è¿™æ®µ WebKit ä»£ç æè¿°äº†æ ¹æ® display å±æ€§çš„ä¸åŒï¼Œé’ˆå¯¹åŒä¸€ä¸ª DOM èŠ‚ç‚¹åº”åˆ›å»ºä»€ä¹ˆç±»å‹çš„å‘ˆç°å™¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RenderObject* RenderObject::createObject(Node* node, RenderStyle* style)</span><br><span class="line">&#123;</span><br><span class="line">    Document* doc = node-&gt;document();</span><br><span class="line">    RenderArena* arena = doc-&gt;renderArena();</span><br><span class="line">    ...</span><br><span class="line">    RenderObject* o = 0;</span><br><span class="line"></span><br><span class="line">    switch (style-&gt;display()) &#123;</span><br><span class="line">        case NONE:</span><br><span class="line">            break;</span><br><span class="line">        case INLINE:</span><br><span class="line">            o = new (arena) RenderInline(node);</span><br><span class="line">            break;</span><br><span class="line">        case BLOCK:</span><br><span class="line">            o = new (arena) RenderBlock(node);</span><br><span class="line">            break;</span><br><span class="line">        case INLINE_BLOCK:</span><br><span class="line">            o = new (arena) RenderBlock(node);</span><br><span class="line">            break;</span><br><span class="line">        case LIST_ITEM:</span><br><span class="line">            o = new (arena) RenderListItem(node);</span><br><span class="line">            break;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ƒç´ ç±»å‹ä¹Ÿæ˜¯è€ƒè™‘å› ç´ ä¹‹ä¸€ï¼Œä¾‹å¦‚è¡¨å•æ§ä»¶å’Œè¡¨æ ¼éƒ½å¯¹åº”ç‰¹æ®Šçš„æ¡†æ¶ã€‚<br>åœ¨ WebKit ä¸­ï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ éœ€è¦åˆ›å»ºç‰¹æ®Šçš„å‘ˆç°å™¨ï¼Œå°±ä¼šæ›¿æ¢ createRenderer æ–¹æ³•ã€‚å‘ˆç°å™¨æ‰€æŒ‡å‘çš„æ ·å¼å¯¹è±¡ä¸­åŒ…å«äº†ä¸€äº›å’Œå‡ ä½•æ— å…³çš„ä¿¡æ¯ã€‚</p>
<h3 id="å‘ˆç°æ ‘å’Œ-DOM-æ ‘çš„å…³ç³»"><a href="#å‘ˆç°æ ‘å’Œ-DOM-æ ‘çš„å…³ç³»" class="headerlink" title="å‘ˆç°æ ‘å’Œ DOM æ ‘çš„å…³ç³»"></a>å‘ˆç°æ ‘å’Œ DOM æ ‘çš„å…³ç³»</h3><p>å‘ˆç°å™¨æ˜¯å’Œ DOM å…ƒç´ ç›¸å¯¹åº”çš„ï¼Œä½†å¹¶éä¸€ä¸€å¯¹åº”ã€‚éå¯è§†åŒ–çš„ DOM å…ƒç´ ä¸ä¼šæ’å…¥å‘ˆç°æ ‘ä¸­ï¼Œä¾‹å¦‚â€œheadâ€å…ƒç´ ã€‚å¦‚æœå…ƒç´ çš„ display å±æ€§å€¼ä¸ºâ€œnoneâ€ï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šæ˜¾ç¤ºåœ¨å‘ˆç°æ ‘ä¸­ï¼ˆä½†æ˜¯ visibility å±æ€§å€¼ä¸ºâ€œhiddenâ€çš„å…ƒç´ ä»ä¼šæ˜¾ç¤ºï¼‰ã€‚<br>æœ‰ä¸€äº› DOM å…ƒç´ å¯¹åº”å¤šä¸ªå¯è§†åŒ–å¯¹è±¡ã€‚å®ƒä»¬å¾€å¾€æ˜¯å…·æœ‰å¤æ‚ç»“æ„çš„å…ƒç´ ï¼Œæ— æ³•ç”¨å•ä¸€çš„çŸ©å½¢æ¥æè¿°ã€‚ä¾‹å¦‚ï¼Œâ€œselectâ€å…ƒç´ æœ‰ 3 ä¸ªå‘ˆç°å™¨ï¼šä¸€ä¸ªç”¨äºæ˜¾ç¤ºåŒºåŸŸï¼Œä¸€ä¸ªç”¨äºä¸‹æ‹‰åˆ—è¡¨æ¡†ï¼Œè¿˜æœ‰ä¸€ä¸ªç”¨äºæŒ‰é’®ã€‚å¦‚æœç”±äºå®½åº¦ä¸å¤Ÿï¼Œæ–‡æœ¬æ— æ³•åœ¨ä¸€è¡Œä¸­æ˜¾ç¤ºè€Œåˆ†ä¸ºå¤šè¡Œï¼Œé‚£ä¹ˆæ–°çš„è¡Œä¹Ÿä¼šä½œä¸ºæ–°çš„å‘ˆç°å™¨è€Œæ·»åŠ ã€‚<br>å¦ä¸€ä¸ªå…³äºå¤šå‘ˆç°å™¨çš„ä¾‹å­æ˜¯æ ¼å¼æ— æ•ˆçš„ HTMLã€‚æ ¹æ® CSS è§„èŒƒï¼Œinline å…ƒç´ åªèƒ½åŒ…å« block å…ƒç´ æˆ– inline å…ƒç´ ä¸­çš„ä¸€ç§ã€‚å¦‚æœå‡ºç°äº†æ··åˆå†…å®¹ï¼Œåˆ™åº”åˆ›å»ºåŒ¿åçš„ block å‘ˆç°å™¨ï¼Œä»¥åŒ…è£¹ inline å…ƒç´ ã€‚</p>
<p>æœ‰ä¸€äº›å‘ˆç°å¯¹è±¡å¯¹åº”äº DOM èŠ‚ç‚¹ï¼Œä½†åœ¨æ ‘ä¸­æ‰€åœ¨çš„ä½ç½®ä¸ DOM èŠ‚ç‚¹ä¸åŒã€‚æµ®åŠ¨å®šä½å’Œç»å¯¹å®šä½çš„å…ƒç´ å°±æ˜¯è¿™æ ·ï¼Œå®ƒä»¬å¤„äºæ­£å¸¸çš„æµç¨‹ä¹‹å¤–ï¼Œæ”¾ç½®åœ¨æ ‘ä¸­çš„å…¶ä»–åœ°æ–¹ï¼Œå¹¶æ˜ å°„åˆ°çœŸæ­£çš„æ¡†æ¶ï¼Œè€Œæ”¾åœ¨åŸä½çš„æ˜¯å ä½æ¡†æ¶ã€‚</p>
<p> <img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image025.png" alt></p>
<center><strong>å›¾ï¼šå‘ˆç°æ ‘åŠå…¶å¯¹åº”çš„ DOM æ ‘ (3.1)ã€‚åˆå§‹å®¹å™¨ block ä¸ºâ€œviewportâ€ï¼Œè€Œåœ¨ WebKit ä¸­åˆ™ä¸ºâ€œRenderViewâ€å¯¹è±¡ã€‚</strong></center>



<h3 id="æ„å»ºå‘ˆç°æ ‘çš„æµç¨‹"><a href="#æ„å»ºå‘ˆç°æ ‘çš„æµç¨‹" class="headerlink" title="æ„å»ºå‘ˆç°æ ‘çš„æµç¨‹"></a>æ„å»ºå‘ˆç°æ ‘çš„æµç¨‹</h3><p>åœ¨ Firefox ä¸­ï¼Œç³»ç»Ÿä¼šé’ˆå¯¹ DOM æ›´æ–°æ³¨å†Œå±•ç¤ºå±‚ï¼Œä½œä¸ºä¾¦å¬å™¨ã€‚å±•ç¤ºå±‚å°†æ¡†æ¶åˆ›å»ºå·¥ä½œå§”æ‰˜ç»™ FrameConstructorï¼Œç”±è¯¥æ„é€ å™¨è§£ææ ·å¼ï¼ˆè¯·å‚é˜…æ ·å¼è®¡ç®—ï¼‰å¹¶åˆ›å»ºæ¡†æ¶ã€‚</p>
<p>åœ¨ WebKit ä¸­ï¼Œè§£ææ ·å¼å’Œåˆ›å»ºå‘ˆç°å™¨çš„è¿‡ç¨‹ç§°ä¸ºâ€œé™„åŠ â€ã€‚æ¯ä¸ª DOM èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªâ€œattachâ€æ–¹æ³•ã€‚é™„åŠ æ˜¯åŒæ­¥è¿›è¡Œçš„ï¼Œå°†èŠ‚ç‚¹æ’å…¥ DOM æ ‘éœ€è¦è°ƒç”¨æ–°çš„èŠ‚ç‚¹â€œattachâ€æ–¹æ³•ã€‚</p>
<p>å¤„ç† html å’Œ body æ ‡è®°å°±ä¼šæ„å»ºå‘ˆç°æ ‘æ ¹èŠ‚ç‚¹ã€‚è¿™ä¸ªæ ¹èŠ‚ç‚¹å‘ˆç°å¯¹è±¡å¯¹åº”äº CSS è§„èŒƒä¸­æ‰€è¯´çš„å®¹å™¨ blockï¼Œè¿™æ˜¯æœ€ä¸Šå±‚çš„ blockï¼ŒåŒ…å«äº†å…¶ä»–æ‰€æœ‰ blockã€‚å®ƒçš„å°ºå¯¸å°±æ˜¯è§†å£ï¼Œå³æµè§ˆå™¨çª—å£æ˜¾ç¤ºåŒºåŸŸçš„å°ºå¯¸ã€‚Firefox ç§°ä¹‹ä¸º ViewPortFrameï¼Œè€Œ WebKit ç§°ä¹‹ä¸º RenderViewã€‚è¿™å°±æ˜¯æ–‡æ¡£æ‰€æŒ‡å‘çš„å‘ˆç°å¯¹è±¡ã€‚å‘ˆç°æ ‘çš„å…¶ä½™éƒ¨åˆ†ä»¥ DOM æ ‘èŠ‚ç‚¹æ’å…¥çš„å½¢å¼æ¥æ„å»ºã€‚</p>
<p>è¯·å‚é˜…å…³äºå¤„ç†æ¨¡å‹çš„ CSS2 è§„èŒƒã€‚</p>
<h3 id="æ ·å¼è®¡ç®—"><a href="#æ ·å¼è®¡ç®—" class="headerlink" title="æ ·å¼è®¡ç®—"></a>æ ·å¼è®¡ç®—</h3><p>æ„å»ºå‘ˆç°æ ‘æ—¶ï¼Œéœ€è¦è®¡ç®—æ¯ä¸€ä¸ªå‘ˆç°å¯¹è±¡çš„å¯è§†åŒ–å±æ€§ã€‚è¿™æ˜¯é€šè¿‡è®¡ç®—æ¯ä¸ªå…ƒç´ çš„æ ·å¼å±æ€§æ¥å®Œæˆçš„ã€‚</p>
<p>æ ·å¼åŒ…æ‹¬æ¥è‡ªå„ç§æ¥æºçš„æ ·å¼è¡¨ã€inline æ ·å¼å…ƒç´ å’Œ HTML ä¸­çš„å¯è§†åŒ–å±æ€§ï¼ˆä¾‹å¦‚â€œbgcolorâ€å±æ€§ï¼‰ã€‚å…¶ä¸­åè€…å°†ç»è¿‡è½¬åŒ–ä»¥åŒ¹é… CSS æ ·å¼å±æ€§ã€‚</p>
<p>æ ·å¼è¡¨çš„æ¥æºåŒ…æ‹¬æµè§ˆå™¨çš„é»˜è®¤æ ·å¼è¡¨ã€ç”±ç½‘é¡µä½œè€…æä¾›çš„æ ·å¼è¡¨ä»¥åŠç”±æµè§ˆå™¨ç”¨æˆ·æä¾›çš„ç”¨æˆ·æ ·å¼è¡¨ï¼ˆæµè§ˆå™¨å…è®¸æ‚¨å®šä¹‰è‡ªå·±å–œæ¬¢çš„æ ·å¼ã€‚ä»¥ Firefox ä¸ºä¾‹ï¼Œç”¨æˆ·å¯ä»¥å°†è‡ªå·±å–œæ¬¢çš„æ ·å¼è¡¨æ”¾åœ¨â€œFirefox Profileâ€æ–‡ä»¶å¤¹ä¸‹ï¼‰ã€‚</p>
<p>æ ·å¼è®¡ç®—å­˜åœ¨ä»¥ä¸‹éš¾ç‚¹ï¼š</p>
<ol>
<li>æ ·å¼æ•°æ®æ˜¯ä¸€ä¸ªè¶…å¤§çš„ç»“æ„ï¼Œå­˜å‚¨äº†æ— æ•°çš„æ ·å¼å±æ€§ï¼Œè¿™å¯èƒ½é€ æˆå†…å­˜é—®é¢˜ã€‚</li>
<li><p>å¦‚æœä¸è¿›è¡Œä¼˜åŒ–ï¼Œä¸ºæ¯ä¸€ä¸ªå…ƒç´ æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™ä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚è¦ä¸ºæ¯ä¸€ä¸ªå…ƒç´ éå†æ•´ä¸ªè§„åˆ™åˆ—è¡¨æ¥å¯»æ‰¾åŒ¹é…è§„åˆ™ï¼Œè¿™æ˜¯ä¸€é¡¹æµ©å¤§çš„å·¥ç¨‹ã€‚é€‰æ‹©å™¨ä¼šå…·æœ‰å¾ˆå¤æ‚çš„ç»“æ„ï¼Œè¿™å°±ä¼šå¯¼è‡´æŸä¸ªåŒ¹é…è¿‡ç¨‹ä¸€å¼€å§‹çœ‹èµ·æ¥å¾ˆå¯èƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æœ€ç»ˆå‘ç°å…¶å®æ˜¯å¾’åŠ³çš„ï¼Œå¿…é¡»å°è¯•å…¶ä»–åŒ¹é…è·¯å¾„ã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢è¿™ä¸ªç»„åˆé€‰æ‹©å™¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">div div div div&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ„å‘³ç€è§„åˆ™é€‚ç”¨äºä½œä¸º 3 ä¸ª div å…ƒç´ çš„å­ä»£çš„ <div>ã€‚å¦‚æœæ‚¨è¦æ£€æŸ¥è§„åˆ™æ˜¯å¦é€‚ç”¨äºæŸä¸ªæŒ‡å®šçš„ <div> å…ƒç´ ï¼Œåº”é€‰æ‹©æ ‘ä¸Šçš„ä¸€æ¡å‘ä¸Šè·¯å¾„è¿›è¡Œæ£€æŸ¥ã€‚æ‚¨å¯èƒ½éœ€è¦å‘ä¸Šéå†èŠ‚ç‚¹æ ‘ï¼Œç»“æœå‘ç°åªæœ‰ä¸¤ä¸ª divï¼Œè€Œä¸”è§„åˆ™å¹¶ä¸é€‚ç”¨ã€‚ç„¶åï¼Œæ‚¨å¿…é¡»å°è¯•æ ‘ä¸­çš„å…¶ä»–è·¯å¾„ã€‚</div></div></p>
</li>
<li><p>åº”ç”¨è§„åˆ™æ¶‰åŠåˆ°ç›¸å½“å¤æ‚çš„å±‚å è§„åˆ™ï¼ˆç”¨äºå®šä¹‰è¿™äº›è§„åˆ™çš„å±‚æ¬¡ï¼‰ã€‚</p>
</li>
</ol>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹æµè§ˆå™¨æ˜¯å¦‚ä½•å¤„ç†è¿™äº›é—®é¢˜çš„ï¼š</p>
<h4 id="å…±äº«æ ·å¼æ•°æ®"><a href="#å…±äº«æ ·å¼æ•°æ®" class="headerlink" title="å…±äº«æ ·å¼æ•°æ®"></a>å…±äº«æ ·å¼æ•°æ®</h4><p>WebKit èŠ‚ç‚¹ä¼šå¼•ç”¨æ ·å¼å¯¹è±¡ (RenderStyle)ã€‚è¿™äº›å¯¹è±¡åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥ç”±ä¸åŒèŠ‚ç‚¹å…±äº«ã€‚è¿™äº›èŠ‚ç‚¹æ˜¯åŒçº§å…³ç³»ï¼Œå¹¶ä¸”ï¼š</p>
<ol>
<li>è¿™äº›å…ƒç´ å¿…é¡»å¤„äºç›¸åŒçš„é¼ æ ‡çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œä¸å…è®¸å…¶ä¸­ä¸€ä¸ªæ˜¯â€œ:hoverâ€çŠ¶æ€ï¼Œè€Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰</li>
<li>ä»»ä½•å…ƒç´ éƒ½æ²¡æœ‰ ID</li>
<li>æ ‡è®°åç§°åº”åŒ¹é…</li>
<li>ç±»å±æ€§åº”åŒ¹é…</li>
<li>æ˜ å°„å±æ€§çš„é›†åˆå¿…é¡»æ˜¯å®Œå…¨ç›¸åŒçš„</li>
<li>é“¾æ¥çŠ¶æ€å¿…é¡»åŒ¹é…</li>
<li>ç„¦ç‚¹çŠ¶æ€å¿…é¡»åŒ¹é…</li>
<li>ä»»ä½•å…ƒç´ éƒ½ä¸åº”å—å±æ€§é€‰æ‹©å™¨çš„å½±å“ï¼Œè¿™é‡Œæ‰€è¯´çš„â€œå½±å“â€æ˜¯æŒ‡åœ¨é€‰æ‹©å™¨ä¸­çš„ä»»ä½•ä½ç½®æœ‰ä»»ä½•ä½¿ç”¨äº†å±æ€§é€‰æ‹©å™¨çš„é€‰æ‹©å™¨åŒ¹é…</li>
<li>å…ƒç´ ä¸­ä¸èƒ½æœ‰ä»»ä½• inline æ ·å¼å±æ€§</li>
<li>ä¸èƒ½ä½¿ç”¨ä»»ä½•åŒçº§é€‰æ‹©å™¨ã€‚WebCore åœ¨é‡åˆ°ä»»ä½•åŒçº§é€‰æ‹©å™¨æ—¶ï¼Œåªä¼šå¼•å‘ä¸€ä¸ªå…¨å±€å¼€å…³ï¼Œå¹¶åœç”¨æ•´ä¸ªæ–‡æ¡£çš„æ ·å¼å…±äº«ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚è¿™åŒ…æ‹¬ + é€‰æ‹©å™¨ä»¥åŠ :first-child å’Œ :last-child ç­‰é€‰æ‹©å™¨ã€‚</li>
</ol>
<h4 id="Firefox-è§„åˆ™æ ‘"><a href="#Firefox-è§„åˆ™æ ‘" class="headerlink" title="Firefox è§„åˆ™æ ‘"></a>Firefox è§„åˆ™æ ‘</h4><p>ä¸ºäº†ç®€åŒ–æ ·å¼è®¡ç®—ï¼ŒFirefox è¿˜é‡‡ç”¨äº†å¦å¤–ä¸¤ç§æ ‘ï¼šè§„åˆ™æ ‘å’Œæ ·å¼ä¸Šä¸‹æ–‡æ ‘ã€‚WebKit ä¹Ÿæœ‰æ ·å¼å¯¹è±¡ï¼Œä½†å®ƒä»¬ä¸æ˜¯ä¿å­˜åœ¨ç±»ä¼¼æ ·å¼ä¸Šä¸‹æ–‡æ ‘è¿™æ ·çš„æ ‘ç»“æ„ä¸­ï¼Œåªæ˜¯ç”± DOM èŠ‚ç‚¹æŒ‡å‘æ­¤ç±»å¯¹è±¡çš„ç›¸å…³æ ·å¼ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image035.png" alt></p>
<center><strong>å›¾ï¼šFirefox æ ·å¼ä¸Šä¸‹æ–‡æ ‘ (2.2)</strong></center>

<p>æ ·å¼ä¸Šä¸‹æ–‡åŒ…å«ç«¯å€¼ã€‚è¦è®¡ç®—å‡ºè¿™äº›å€¼ï¼Œåº”æŒ‰ç…§æ­£ç¡®é¡ºåºåº”ç”¨æ‰€æœ‰çš„åŒ¹é…è§„åˆ™ï¼Œå¹¶å°†å…¶ä»é€»è¾‘å€¼è½¬åŒ–ä¸ºå…·ä½“çš„å€¼ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé€»è¾‘å€¼æ˜¯å±å¹•å¤§å°çš„ç™¾åˆ†æ¯”ï¼Œåˆ™éœ€è¦æ¢ç®—æˆç»å¯¹çš„å•ä½ã€‚è§„åˆ™æ ‘çš„ç‚¹å­çœŸçš„å¾ˆå·§å¦™ï¼Œå®ƒä½¿å¾—èŠ‚ç‚¹ä¹‹é—´å¯ä»¥å…±äº«è¿™äº›å€¼ï¼Œä»¥é¿å…é‡å¤è®¡ç®—ï¼Œè¿˜å¯ä»¥èŠ‚çº¦ç©ºé—´ã€‚</p>
<p>æ‰€æœ‰åŒ¹é…çš„è§„åˆ™éƒ½å­˜å‚¨åœ¨æ ‘ä¸­ã€‚è·¯å¾„ä¸­çš„åº•å±‚èŠ‚ç‚¹æ‹¥æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚è§„åˆ™æ ‘åŒ…å«äº†æ‰€æœ‰å·²çŸ¥è§„åˆ™åŒ¹é…çš„è·¯å¾„ã€‚è§„åˆ™çš„å­˜å‚¨æ˜¯å»¶è¿Ÿè¿›è¡Œçš„ã€‚è§„åˆ™æ ‘ä¸ä¼šåœ¨å¼€å§‹çš„æ—¶å€™å°±ä¸ºæ‰€æœ‰çš„èŠ‚ç‚¹è¿›è¡Œè®¡ç®—ï¼Œè€Œæ˜¯åªæœ‰å½“æŸä¸ªèŠ‚ç‚¹æ ·å¼éœ€è¦è¿›è¡Œè®¡ç®—æ—¶ï¼Œæ‰ä¼šå‘è§„åˆ™æ ‘æ·»åŠ è®¡ç®—çš„è·¯å¾„ã€‚</p>
<p>è¿™ä¸ªæƒ³æ³•ç›¸å½“äºå°†è§„åˆ™æ ‘è·¯å¾„è§†ä¸ºè¯å…¸ä¸­çš„å•è¯ã€‚å¦‚æœæˆ‘ä»¬å·²ç»è®¡ç®—å‡ºå¦‚ä¸‹çš„è§„åˆ™æ ‘ï¼š</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/tree.png" alt><br>å‡è®¾æˆ‘ä»¬éœ€è¦ä¸ºå†…å®¹æ ‘ä¸­çš„å¦ä¸€ä¸ªå…ƒç´ åŒ¹é…è§„åˆ™ï¼Œå¹¶ä¸”æ‰¾åˆ°åŒ¹é…è·¯å¾„æ˜¯ B - E - Iï¼ˆæŒ‰ç…§æ­¤é¡ºåºï¼‰ã€‚ç”±äºæˆ‘ä»¬åœ¨æ ‘ä¸­å·²ç»è®¡ç®—å‡ºäº†è·¯å¾„ A - B - E - I - Lï¼Œå› æ­¤å°±å·²ç»æœ‰äº†æ­¤è·¯å¾„ï¼Œè¿™å°±å‡å°‘äº†ç°åœ¨æ‰€éœ€çš„å·¥ä½œé‡ã€‚<br>è®©æˆ‘ä»¬çœ‹çœ‹è§„åˆ™æ ‘å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å‡å°‘å·¥ä½œã€‚</p>
<h5 id="ç»“æ„åˆ’åˆ†"><a href="#ç»“æ„åˆ’åˆ†" class="headerlink" title="ç»“æ„åˆ’åˆ†"></a>ç»“æ„åˆ’åˆ†</h5><p>æ ·å¼ä¸Šä¸‹æ–‡å¯åˆ†å‰²æˆå¤šä¸ªç»“æ„ã€‚è¿™äº›ç»“æ„ä½“åŒ…å«äº†ç‰¹å®šç±»åˆ«ï¼ˆå¦‚ border æˆ– colorï¼‰çš„æ ·å¼ä¿¡æ¯ã€‚ç»“æ„ä¸­çš„å±æ€§éƒ½æ˜¯ç»§æ‰¿çš„æˆ–éç»§æ‰¿çš„ã€‚ç»§æ‰¿å±æ€§å¦‚æœæœªç”±å…ƒç´ å®šä¹‰ï¼Œåˆ™ç»§æ‰¿è‡ªå…¶çˆ¶ä»£ã€‚éç»§æ‰¿å±æ€§ï¼ˆä¹Ÿç§°ä¸ºâ€œé‡ç½®â€å±æ€§ï¼‰å¦‚æœæœªè¿›è¡Œå®šä¹‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚</p>
<p>è§„åˆ™æ ‘é€šè¿‡ç¼“å­˜æ•´ä¸ªç»“æ„ï¼ˆåŒ…å«è®¡ç®—å‡ºçš„ç«¯å€¼ï¼‰ä¸ºæˆ‘ä»¬æä¾›å¸®åŠ©ã€‚è¿™ä¸€æƒ³æ³•å‡å®šåº•å±‚èŠ‚ç‚¹æ²¡æœ‰æä¾›ç»“æ„çš„å®šä¹‰ï¼Œåˆ™å¯ä½¿ç”¨ä¸Šå±‚èŠ‚ç‚¹ä¸­çš„ç¼“å­˜ç»“æ„ã€‚</p>
<h5 id="ä½¿ç”¨è§„åˆ™æ ‘è®¡ç®—æ ·å¼ä¸Šä¸‹æ–‡"><a href="#ä½¿ç”¨è§„åˆ™æ ‘è®¡ç®—æ ·å¼ä¸Šä¸‹æ–‡" class="headerlink" title="ä½¿ç”¨è§„åˆ™æ ‘è®¡ç®—æ ·å¼ä¸Šä¸‹æ–‡"></a>ä½¿ç”¨è§„åˆ™æ ‘è®¡ç®—æ ·å¼ä¸Šä¸‹æ–‡</h5><p>åœ¨è®¡ç®—æŸä¸ªç‰¹å®šå…ƒç´ çš„æ ·å¼ä¸Šä¸‹æ–‡æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè®¡ç®—è§„åˆ™æ ‘ä¸­çš„å¯¹åº”è·¯å¾„ï¼Œæˆ–è€…ä½¿ç”¨ç°æœ‰çš„è·¯å¾„ã€‚ç„¶åæˆ‘ä»¬æ²¿æ­¤è·¯å¾„åº”ç”¨è§„åˆ™ï¼Œåœ¨æ–°çš„æ ·å¼ä¸Šä¸‹æ–‡ä¸­å¡«å……ç»“æ„ã€‚æˆ‘ä»¬ä»è·¯å¾„ä¸­æ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§çš„åº•å±‚èŠ‚ç‚¹ï¼ˆé€šå¸¸ä¹Ÿæ˜¯æœ€ç‰¹æ®Šçš„é€‰æ‹©å™¨ï¼‰å¼€å§‹ï¼Œå¹¶å‘ä¸Šéå†è§„åˆ™æ ‘ï¼Œç›´åˆ°ç»“æ„å¡«å……å®Œæ¯•ã€‚å¦‚æœè¯¥è§„åˆ™èŠ‚ç‚¹å¯¹äºæ­¤ç»“æ„æ²¡æœ‰ä»»ä½•è§„èŒƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®ç°æ›´å¥½çš„ä¼˜åŒ–ï¼šå¯»æ‰¾è·¯å¾„æ›´ä¸Šå±‚çš„èŠ‚ç‚¹ï¼Œæ‰¾åˆ°åæŒ‡å®šå®Œæ•´çš„è§„èŒƒå¹¶æŒ‡å‘ç›¸å…³èŠ‚ç‚¹å³å¯ã€‚è¿™æ˜¯æœ€å¥½çš„ä¼˜åŒ–æ–¹æ³•ï¼Œå› ä¸ºæ•´ä¸ªç»“æ„éƒ½èƒ½å…±äº«ã€‚è¿™å¯ä»¥å‡å°‘ç«¯å€¼çš„è®¡ç®—é‡å¹¶èŠ‚çº¦å†…å­˜ã€‚<br>å¦‚æœæˆ‘ä»¬æ‰¾åˆ°äº†éƒ¨åˆ†å®šä¹‰ï¼Œå°±ä¼šå‘ä¸Šéå†è§„åˆ™æ ‘ï¼Œç›´åˆ°ç»“æ„å¡«å……å®Œæ¯•ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬æ‰¾ä¸åˆ°ç»“æ„çš„ä»»ä½•å®šä¹‰ï¼Œé‚£ä¹ˆå‡å¦‚è¯¥ç»“æ„æ˜¯â€œç»§æ‰¿â€ç±»å‹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸Šä¸‹æ–‡æ ‘ä¸­æŒ‡å‘çˆ¶ä»£çš„ç»“æ„ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥å…±äº«ç»“æ„ã€‚å¦‚æœæ˜¯ reset ç±»å‹çš„ç»“æ„ï¼Œåˆ™ä¼šä½¿ç”¨é»˜è®¤å€¼ã€‚</p>
<p>å¦‚æœæœ€ç‰¹æ®Šçš„èŠ‚ç‚¹ç¡®å®æ·»åŠ äº†å€¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å¦å¤–è¿›è¡Œä¸€äº›è®¡ç®—ï¼Œä»¥ä¾¿å°†è¿™äº›å€¼è½¬åŒ–æˆå®é™…å€¼ã€‚ç„¶åæˆ‘ä»¬å°†ç»“æœç¼“å­˜åœ¨æ ‘èŠ‚ç‚¹ä¸­ï¼Œä¾›å­ä»£ä½¿ç”¨ã€‚</p>
<p>å¦‚æœæŸä¸ªå…ƒç´ ä¸å…¶åŒçº§å…ƒç´ éƒ½æŒ‡å‘åŒä¸€ä¸ªæ ‘èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒä»¬å°±å¯ä»¥å…±äº«æ•´ä¸ªæ ·å¼ä¸Šä¸‹æ–‡ã€‚</p>
<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹ HTML ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"err"</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        this is a <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"big"</span>&gt;</span> big error <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        this is also a</span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"big"</span>&gt;</span> very  big  error<span class="tag">&lt;/<span class="name">span</span>&gt;</span> error</span><br><span class="line">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"err"</span> <span class="attr">id</span>=<span class="string">"div2"</span>&gt;</span>another error<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰å¦‚ä¸‹è§„åˆ™ï¼š</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;<span class="attribute">margin</span>:<span class="number">5px</span>;<span class="attribute">color</span>:black&#125;</span><br><span class="line"><span class="selector-class">.err</span> &#123;<span class="attribute">color</span>:red&#125;</span><br><span class="line"><span class="selector-class">.big</span> &#123;<span class="attribute">margin-top</span>:<span class="number">3px</span>&#125;</span><br><span class="line"><span class="selector-tag">div</span> <span class="selector-tag">span</span> &#123;<span class="attribute">margin-bottom</span>:<span class="number">4px</span>&#125;</span><br><span class="line"><span class="selector-id">#div1</span> &#123;<span class="attribute">color</span>:blue&#125;</span><br><span class="line"><span class="selector-id">#div2</span> &#123;<span class="attribute">color</span>:green&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†ç®€ä¾¿èµ·è§ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å……ä¸¤ä¸ªç»“æ„ï¼šcolor ç»“æ„å’Œ margin ç»“æ„ã€‚color ç»“æ„åªåŒ…å«ä¸€ä¸ªæˆå‘˜ï¼ˆå³â€œcolorâ€ï¼‰ï¼Œè€Œ margin ç»“æ„åŒ…å«å››æ¡è¾¹ã€‚<br>å½¢æˆçš„è§„åˆ™æ ‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆèŠ‚ç‚¹çš„æ ‡è®°æ–¹å¼ä¸ºâ€œèŠ‚ç‚¹å : æŒ‡å‘çš„è§„åˆ™åºå·â€ï¼‰ï¼š</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image027.png" alt></p>
<center><strong>å›¾ï¼šè§„åˆ™æ ‘</strong></center>

<p>ä¸Šä¸‹æ–‡æ ‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆèŠ‚ç‚¹å : æŒ‡å‘çš„è§„åˆ™èŠ‚ç‚¹ï¼‰ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image029.png" alt></p>
<center><strong>å›¾ï¼šä¸Šä¸‹æ–‡æ ‘</strong></center>

<p>å‡è®¾æˆ‘ä»¬è§£æ HTML æ—¶é‡åˆ°äº†ç¬¬äºŒä¸ª <div> æ ‡è®°ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæ­¤èŠ‚ç‚¹åˆ›å»ºæ ·å¼ä¸Šä¸‹æ–‡ï¼Œå¹¶å¡«å……å…¶æ ·å¼ç»“æ„ã€‚<br>ç»è¿‡è§„åˆ™åŒ¹é…ï¼Œæˆ‘ä»¬å‘ç°è¯¥ <div> çš„åŒ¹é…è§„åˆ™æ˜¯ç¬¬ 1ã€2 å’Œ 6 æ¡ã€‚è¿™æ„å‘³ç€è§„åˆ™æ ‘ä¸­å·²æœ‰ä¸€æ¡è·¯å¾„å¯ä¾›æˆ‘ä»¬çš„å…ƒç´ ä½¿ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦å†ä¸ºå…¶æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ä»¥åŒ¹é…ç¬¬ 6 æ¡è§„åˆ™ï¼ˆè§„åˆ™æ ‘ä¸­çš„ F èŠ‚ç‚¹ï¼‰ã€‚<br>æˆ‘ä»¬å°†åˆ›å»ºæ ·å¼ä¸Šä¸‹æ–‡å¹¶å°†å…¶æ”¾å…¥ä¸Šä¸‹æ–‡æ ‘ä¸­ã€‚æ–°çš„æ ·å¼ä¸Šä¸‹æ–‡å°†æŒ‡å‘è§„åˆ™æ ‘ä¸­çš„ F èŠ‚ç‚¹ã€‚</div></div></p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å¡«å……æ ·å¼ç»“æ„ã€‚é¦–å…ˆè¦å¡«å……çš„æ˜¯ margin ç»“æ„ã€‚ç”±äºæœ€åçš„è§„åˆ™èŠ‚ç‚¹ (F) å¹¶æ²¡æœ‰æ·»åŠ åˆ° margin ç»“æ„ï¼Œæˆ‘ä»¬éœ€è¦ä¸Šæº¯è§„åˆ™æ ‘ï¼Œç›´è‡³æ‰¾åˆ°åœ¨å…ˆå‰èŠ‚ç‚¹æ’å…¥ä¸­è®¡ç®—è¿‡çš„ç¼“å­˜ç»“æ„ï¼Œç„¶åä½¿ç”¨è¯¥ç»“æ„ã€‚æˆ‘ä»¬ä¼šåœ¨æŒ‡å®š margin è§„åˆ™çš„æœ€ä¸Šå±‚èŠ‚ç‚¹ï¼ˆå³ B èŠ‚ç‚¹ï¼‰ä¸Šæ‰¾åˆ°è¯¥ç»“æ„ã€‚</p>
<p>æˆ‘ä»¬å·²ç»æœ‰äº† color ç»“æ„çš„å®šä¹‰ï¼Œå› æ­¤ä¸èƒ½ä½¿ç”¨ç¼“å­˜çš„ç»“æ„ã€‚ç”±äº color æœ‰ä¸€ä¸ªå±æ€§ï¼Œæˆ‘ä»¬æ— éœ€ä¸Šæº¯è§„åˆ™æ ‘ä»¥å¡«å……å…¶ä»–å±æ€§ã€‚æˆ‘ä»¬å°†è®¡ç®—ç«¯å€¼ï¼ˆå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸º RGB ç­‰ï¼‰å¹¶åœ¨æ­¤èŠ‚ç‚¹ä¸Šç¼“å­˜ç»è¿‡è®¡ç®—çš„ç»“æ„ã€‚</p>
<p>ç¬¬äºŒä¸ª <span> å…ƒç´ å¤„ç†èµ·æ¥æ›´åŠ ç®€å•ã€‚æˆ‘ä»¬å°†åŒ¹é…è§„åˆ™ï¼Œæœ€ç»ˆå‘ç°å®ƒå’Œä¹‹å‰çš„ span ä¸€æ ·æŒ‡å‘è§„åˆ™ Gã€‚ç”±äºæˆ‘ä»¬æ‰¾åˆ°äº†æŒ‡å‘åŒä¸€èŠ‚ç‚¹çš„åŒçº§ï¼Œå°±å¯ä»¥å…±äº«æ•´ä¸ªæ ·å¼ä¸Šä¸‹æ–‡äº†ï¼Œåªéœ€æŒ‡å‘ä¹‹å‰ span çš„ä¸Šä¸‹æ–‡å³å¯ã€‚</span></p>
<p>å¯¹äºåŒ…å«äº†ç»§æ‰¿è‡ªçˆ¶ä»£çš„è§„åˆ™çš„ç»“æ„ï¼Œç¼“å­˜æ˜¯åœ¨ä¸Šä¸‹æ–‡æ ‘ä¸­è¿›è¡Œçš„ï¼ˆäº‹å®ä¸Š color å±æ€§æ˜¯ç»§æ‰¿çš„ï¼Œä½†æ˜¯ Firefox å°†å…¶è§†ä¸º reset å±æ€§ï¼Œå¹¶ç¼“å­˜åˆ°è§„åˆ™æ ‘ä¸Šï¼‰ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æŸä¸ªæ®µè½ä¸­æ·»åŠ  font è§„åˆ™ï¼š<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">p &#123;font-family:Verdana;font size:10px;font-weight:bold&#125;</span><br></pre></td></tr></table></figure></p>
<p>é‚£ä¹ˆï¼Œè¯¥æ®µè½å…ƒç´ ä½œä¸ºä¸Šä¸‹æ–‡æ ‘ä¸­çš„ div çš„å­ä»£ï¼Œå°±ä¼šå…±äº«ä¸å…¶çˆ¶ä»£ç›¸åŒçš„ font<br>ç»“æ„ï¼ˆå‰ææ˜¯è¯¥æ®µè½æ²¡æœ‰æŒ‡å®š font è§„åˆ™ï¼‰ã€‚</p>
<p>åœ¨ WebKit ä¸­æ²¡æœ‰è§„åˆ™æ ‘ï¼Œå› æ­¤ä¼šå¯¹åŒ¹é…çš„å£°æ˜éå† 4 æ¬¡ã€‚é¦–å…ˆåº”ç”¨éé‡è¦é«˜ä¼˜å…ˆçº§çš„å±æ€§ï¼ˆç”±äºä½œä¸ºå…¶ä»–å±æ€§çš„ä¾æ®è€Œåº”é¦–å…ˆåº”ç”¨çš„å±æ€§ï¼Œä¾‹å¦‚ displayï¼‰ï¼Œæ¥ç€æ˜¯é«˜ä¼˜å…ˆçº§é‡è¦è§„åˆ™ï¼Œç„¶åæ˜¯æ™®é€šä¼˜å…ˆçº§éé‡è¦è§„åˆ™ï¼Œæœ€åæ˜¯æ™®é€šä¼˜å…ˆçº§é‡è¦è§„åˆ™ã€‚è¿™æ„å‘³ç€å¤šæ¬¡å‡ºç°çš„å±æ€§ä¼šæ ¹æ®æ­£ç¡®çš„å±‚å é¡ºåºè¿›è¡Œè§£æã€‚æœ€åå‡ºç°çš„æœ€ç»ˆç”Ÿæ•ˆã€‚ </p>
<p>å› æ­¤æ¦‚æ‹¬æ¥è¯´ï¼Œå…±äº«æ ·å¼å¯¹è±¡ï¼ˆæ•´ä¸ªå¯¹è±¡æˆ–è€…å¯¹è±¡ä¸­çš„éƒ¨åˆ†ç»“æ„ï¼‰å¯ä»¥è§£å†³é—®é¢˜ 1 å’Œé—®é¢˜ 3ã€‚Firefox è§„åˆ™æ ‘è¿˜æœ‰åŠ©äºæŒ‰ç…§æ­£ç¡®çš„é¡ºåºåº”ç”¨å±æ€§ã€‚</p>
<h4 id="å¯¹è§„åˆ™è¿›è¡Œå¤„ç†ä»¥ç®€åŒ–åŒ¹é…"><a href="#å¯¹è§„åˆ™è¿›è¡Œå¤„ç†ä»¥ç®€åŒ–åŒ¹é…" class="headerlink" title="å¯¹è§„åˆ™è¿›è¡Œå¤„ç†ä»¥ç®€åŒ–åŒ¹é…"></a>å¯¹è§„åˆ™è¿›è¡Œå¤„ç†ä»¥ç®€åŒ–åŒ¹é…</h4><p>æ ·å¼è§„åˆ™æœ‰ä¸€äº›æ¥æºï¼š</p>
<ul>
<li>å¤–éƒ¨æ ·å¼è¡¨æˆ–æ ·å¼å…ƒç´ ä¸­çš„ CSS è§„åˆ™<br><code>p {color:blue}</code></li>
<li>inline æ ·å¼å±æ€§åŠç±»ä¼¼å†…å®¹<br><code>&lt;p style=&quot;color:blue&quot; /&gt;</code></li>
<li>HTML å¯è§†åŒ–å±æ€§ï¼ˆæ˜ å°„åˆ°ç›¸å…³çš„æ ·å¼è§„åˆ™ï¼‰<br><code>&lt;p bgcolor=&quot;blue&quot; /&gt;</code></li>
</ul>
<p>åä¸¤ç§å¾ˆå®¹æ˜“å’Œå…ƒç´ è¿›è¡ŒåŒ¹é…ï¼Œå› ä¸ºå…ƒç´ æ‹¥æœ‰æ ·å¼å±æ€§ï¼Œè€Œä¸” HTML å±æ€§å¯ä»¥ä½¿ç”¨å…ƒç´ ä½œä¸ºé”®å€¼è¿›è¡Œæ˜ å°„ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰åœ¨ç¬¬ 2 ä¸ªé—®é¢˜ä¸­æåˆ°è¿‡ï¼ŒCSS è§„åˆ™åŒ¹é…å¯èƒ½æ¯”è¾ƒæ£˜æ‰‹ã€‚ä¸ºäº†è§£å†³è¿™ä¸€éš¾é¢˜ï¼Œå¯ä»¥å¯¹ CSS è§„åˆ™è¿›è¡Œä¸€äº›å¤„ç†ï¼Œä»¥ä¾¿è®¿é—®ã€‚</p>
<p>æ ·å¼è¡¨è§£æå®Œæ¯•åï¼Œç³»ç»Ÿä¼šæ ¹æ®é€‰æ‹©å™¨å°† CSS è§„åˆ™æ·»åŠ åˆ°æŸä¸ªå“ˆå¸Œè¡¨ä¸­ã€‚è¿™äº›å“ˆå¸Œè¡¨çš„é€‰æ‹©å™¨å„ä¸ç›¸åŒï¼ŒåŒ…æ‹¬ IDã€ç±»åç§°ã€æ ‡è®°åç§°ç­‰ï¼Œè¿˜æœ‰ä¸€ç§é€šç”¨å“ˆå¸Œè¡¨ï¼Œé€‚åˆä¸å±äºä¸Šè¿°ç±»åˆ«çš„è§„åˆ™ã€‚å¦‚æœé€‰æ‹©å™¨æ˜¯ IDï¼Œè§„åˆ™å°±ä¼šæ·»åŠ åˆ° ID è¡¨ä¸­ï¼›å¦‚æœé€‰æ‹©å™¨æ˜¯ç±»ï¼Œè§„åˆ™å°±ä¼šæ·»åŠ åˆ°ç±»è¡¨ä¸­ï¼Œä¾æ­¤ç±»æ¨ã€‚<br>è¿™ç§å¤„ç†å¯ä»¥å¤§å¤§ç®€åŒ–è§„åˆ™åŒ¹é…ã€‚æˆ‘ä»¬æ— éœ€æŸ¥çœ‹æ¯ä¸€æ¡å£°æ˜ï¼Œåªè¦ä»å“ˆå¸Œè¡¨ä¸­æå–å…ƒç´ çš„ç›¸å…³è§„åˆ™å³å¯ã€‚è¿™ç§ä¼˜åŒ–æ–¹æ³•å¯æ’é™¤æ‰ 95% ä»¥ä¸Šè§„åˆ™ï¼Œå› æ­¤åœ¨åŒ¹é…è¿‡ç¨‹ä¸­æ ¹æœ¬å°±ä¸ç”¨è€ƒè™‘è¿™äº›è§„åˆ™äº† (4.1)ã€‚</p>
<p>æˆ‘ä»¬ä»¥å¦‚ä¸‹çš„æ ·å¼è§„åˆ™ä¸ºä¾‹ï¼š</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">p</span><span class="selector-class">.error</span> &#123;<span class="attribute">color</span>:red&#125;</span><br><span class="line"><span class="selector-id">#messageDiv</span> &#123;<span class="attribute">height</span>:<span class="number">50px</span>&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;<span class="attribute">margin</span>:<span class="number">5px</span>&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€æ¡è§„åˆ™å°†æ’å…¥ç±»è¡¨ï¼Œç¬¬äºŒæ¡å°†æ’å…¥ ID è¡¨ï¼Œè€Œç¬¬ä¸‰æ¡å°†æ’å…¥æ ‡è®°è¡¨ã€‚<br>å¯¹äºä¸‹é¢çš„ HTML ä»£ç æ®µï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"error"</span>&gt;</span>an error occurred <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"messageDiv"</span>&gt;</span>this is a message<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬é¦–å…ˆä¼šä¸º p å…ƒç´ å¯»æ‰¾åŒ¹é…çš„è§„åˆ™ã€‚ç±»è¡¨ä¸­æœ‰ä¸€ä¸ªâ€œerrorâ€é”®ï¼Œåœ¨ä¸‹é¢å¯ä»¥æ‰¾åˆ°â€œp.errorâ€çš„è§„åˆ™ã€‚div å…ƒç´ åœ¨ ID è¡¨ï¼ˆé”®ä¸º IDï¼‰å’Œæ ‡è®°è¡¨ä¸­æœ‰ç›¸å…³çš„è§„åˆ™ã€‚å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯æ‰¾å‡ºå“ªäº›æ ¹æ®é”®æå–çš„è§„åˆ™æ˜¯çœŸæ­£åŒ¹é…çš„äº†ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœ div çš„å¯¹åº”è§„åˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">table</span> <span class="selector-tag">div</span> &#123;<span class="attribute">margin</span>:<span class="number">5px</span>&#125;</span><br></pre></td></tr></table></figure>
<p> è¿™æ¡è§„åˆ™ä»ç„¶ä¼šä»æ ‡è®°è¡¨ä¸­æå–å‡ºæ¥ï¼Œå› ä¸ºé”®æ˜¯æœ€å³è¾¹çš„é€‰æ‹©å™¨ï¼Œä½†è¿™æ¡è§„åˆ™å¹¶ä¸åŒ¹é…æˆ‘ä»¬çš„ div å…ƒç´ ï¼Œå› ä¸º div æ²¡æœ‰ table ç¥–å…ˆã€‚<br>WebKit å’Œ Firefox éƒ½è¿›è¡Œäº†è¿™ä¸€å¤„ç†ã€‚</p>
<h4 id="ä»¥æ­£ç¡®çš„å±‚å é¡ºåºåº”ç”¨è§„åˆ™"><a href="#ä»¥æ­£ç¡®çš„å±‚å é¡ºåºåº”ç”¨è§„åˆ™" class="headerlink" title="ä»¥æ­£ç¡®çš„å±‚å é¡ºåºåº”ç”¨è§„åˆ™"></a>ä»¥æ­£ç¡®çš„å±‚å é¡ºåºåº”ç”¨è§„åˆ™</h4><p>æ ·å¼å¯¹è±¡å…·æœ‰ä¸æ¯ä¸ªå¯è§†åŒ–å±æ€§ä¸€ä¸€å¯¹åº”çš„å±æ€§ï¼ˆå‡ä¸º CSS å±æ€§ä½†æ›´ä¸ºé€šç”¨ï¼‰ã€‚å¦‚æœæŸä¸ªå±æ€§æœªç”±ä»»ä½•åŒ¹é…è§„åˆ™æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆéƒ¨åˆ†å±æ€§å°±å¯ç”±çˆ¶ä»£å…ƒç´ æ ·å¼å¯¹è±¡ç»§æ‰¿ã€‚å…¶ä»–å±æ€§å…·æœ‰é»˜è®¤å€¼ã€‚</p>
<p>å¦‚æœå®šä¹‰ä¸æ­¢ä¸€ä¸ªï¼Œå°±ä¼šå‡ºç°é—®é¢˜ï¼Œéœ€è¦é€šè¿‡å±‚å é¡ºåºæ¥è§£å†³ã€‚</p>
<h5 id="æ ·å¼è¡¨å±‚å é¡ºåº"><a href="#æ ·å¼è¡¨å±‚å é¡ºåº" class="headerlink" title="æ ·å¼è¡¨å±‚å é¡ºåº"></a>æ ·å¼è¡¨å±‚å é¡ºåº</h5><p>æŸä¸ªæ ·å¼å±æ€§çš„å£°æ˜å¯èƒ½ä¼šå‡ºç°åœ¨å¤šä¸ªæ ·å¼è¡¨ä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨åŒä¸€ä¸ªæ ·å¼è¡¨ä¸­å‡ºç°å¤šæ¬¡ã€‚è¿™æ„å‘³ç€åº”ç”¨è§„åˆ™çš„é¡ºåºæä¸ºé‡è¦ã€‚è¿™ç§°ä¸ºâ€œå±‚å â€é¡ºåºã€‚æ ¹æ® CSS2 è§„èŒƒï¼Œå±‚å çš„é¡ºåºä¸ºï¼ˆä¼˜å…ˆçº§ä»ä½åˆ°é«˜ï¼‰ï¼š</p>
<ol>
<li>æµè§ˆå™¨å£°æ˜</li>
<li>ç”¨æˆ·æ™®é€šå£°æ˜</li>
<li>ä½œè€…æ™®é€šå£°æ˜</li>
<li>ä½œè€…é‡è¦å£°æ˜</li>
<li>ç”¨æˆ·é‡è¦å£°æ˜</li>
</ol>
<p>æµè§ˆå™¨å£°æ˜æ˜¯é‡è¦ç¨‹åº¦æœ€ä½çš„ï¼Œè€Œç”¨æˆ·åªæœ‰å°†è¯¥å£°æ˜æ ‡è®°ä¸ºâ€œé‡è¦â€æ‰å¯ä»¥æ›¿æ¢ç½‘é¡µä½œè€…çš„å£°æ˜ã€‚åŒæ ·é¡ºåºçš„å£°æ˜ä¼šæ ¹æ®ç‰¹å¼‚æ€§è¿›è¡Œæ’åºï¼Œç„¶åå†æ˜¯å…¶æŒ‡å®šé¡ºåºã€‚HTML å¯è§†åŒ–å±æ€§ä¼šè½¬æ¢æˆåŒ¹é…çš„ CSS å£°æ˜ã€‚å®ƒä»¬è¢«è§†ä¸ºä½ä¼˜å…ˆçº§çš„ç½‘é¡µä½œè€…è§„åˆ™ã€‚</p>
<h5 id="ç‰¹å¼‚æ€§"><a href="#ç‰¹å¼‚æ€§" class="headerlink" title="ç‰¹å¼‚æ€§"></a>ç‰¹å¼‚æ€§</h5><p>é€‰æ‹©å™¨çš„ç‰¹å¼‚æ€§ç”± CSS2 è§„èŒƒå®šä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœå£°æ˜æ¥è‡ªäºâ€œstyleâ€å±æ€§ï¼Œè€Œä¸æ˜¯å¸¦æœ‰é€‰æ‹©å™¨çš„è§„åˆ™ï¼Œåˆ™è®°ä¸º 1ï¼Œå¦åˆ™è®°ä¸º 0 (= a)</li>
<li>è®°ä¸ºé€‰æ‹©å™¨ä¸­ ID å±æ€§çš„ä¸ªæ•° (= b)</li>
<li>è®°ä¸ºé€‰æ‹©å™¨ä¸­å…¶ä»–å±æ€§å’Œä¼ªç±»çš„ä¸ªæ•° (= c)</li>
<li>è®°ä¸ºé€‰æ‹©å™¨ä¸­å…ƒç´ åç§°å’Œä¼ªå…ƒç´ çš„ä¸ªæ•° (= d)</li>
</ul>
<p>å°†å››ä¸ªæ•°å­—æŒ‰ a-b-c-d è¿™æ ·è¿æ¥èµ·æ¥ï¼ˆä½äºå¤§æ•°è¿›åˆ¶çš„æ•°å­—ç³»ç»Ÿä¸­ï¼‰ï¼Œæ„æˆç‰¹å¼‚æ€§ã€‚<br>æ‚¨ä½¿ç”¨çš„è¿›åˆ¶å–å†³äºä¸Šè¿°ç±»åˆ«ä¸­çš„æœ€é«˜è®¡æ•°ã€‚<br>ä¾‹å¦‚ï¼Œå¦‚æœ a=14ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨åå…­è¿›åˆ¶ã€‚å¦‚æœ a=17ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦ä½¿ç”¨åä¸ƒè¿›åˆ¶ï¼›å½“ç„¶ä¸å¤ªå¯èƒ½å‡ºç°è¿™ç§æƒ…å†µï¼Œé™¤éæ˜¯å­˜åœ¨å¦‚ä¸‹çš„é€‰æ‹©å™¨ï¼šhtml body div div p â€¦ï¼ˆåœ¨é€‰æ‹©å™¨ä¸­å‡ºç°äº† 17 ä¸ªæ ‡è®°ï¼Œè¿™æ ·çš„å¯èƒ½æ€§æä½ï¼‰ã€‚</p>
<p>ä¸€äº›ç¤ºä¾‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*             &#123;&#125;  /* a=0 b=0 c=0 d=0 -&gt; specificity = 0,0,0,0 */</span><br><span class="line">li            &#123;&#125;  /* a=0 b=0 c=0 d=1 -&gt; specificity = 0,0,0,1 */</span><br><span class="line">li:first-line &#123;&#125;  /* a=0 b=0 c=0 d=2 -&gt; specificity = 0,0,0,2 */</span><br><span class="line">ul li         &#123;&#125;  /* a=0 b=0 c=0 d=2 -&gt; specificity = 0,0,0,2 */</span><br><span class="line">ul ol+li      &#123;&#125;  /* a=0 b=0 c=0 d=3 -&gt; specificity = 0,0,0,3 */</span><br><span class="line">h1 + *[rel=up]&#123;&#125;  /* a=0 b=0 c=1 d=1 -&gt; specificity = 0,0,1,1 */</span><br><span class="line">ul ol li.red  &#123;&#125;  /* a=0 b=0 c=1 d=3 -&gt; specificity = 0,0,1,3 */</span><br><span class="line">li.red.level  &#123;&#125;  /* a=0 b=0 c=2 d=1 -&gt; specificity = 0,0,2,1 */</span><br><span class="line">#x34y         &#123;&#125;  /* a=0 b=1 c=0 d=0 -&gt; specificity = 0,1,0,0 */</span><br><span class="line">style=&quot;&quot;          /* a=1 b=0 c=0 d=0 -&gt; specificity = 1,0,0,0 */</span><br></pre></td></tr></table></figure>
<h5 id="è§„åˆ™æ’åº"><a href="#è§„åˆ™æ’åº" class="headerlink" title="è§„åˆ™æ’åº"></a>è§„åˆ™æ’åº</h5><p>æ‰¾åˆ°åŒ¹é…çš„è§„åˆ™ä¹‹åï¼Œåº”æ ¹æ®çº§è”é¡ºåºå°†å…¶æ’åºã€‚WebKit å¯¹äºè¾ƒå°çš„åˆ—è¡¨ä¼šä½¿ç”¨å†’æ³¡æ’åºï¼Œè€Œå¯¹è¾ƒå¤§çš„åˆ—è¡¨åˆ™ä½¿ç”¨å½’å¹¶æ’åºã€‚å¯¹äºä»¥ä¸‹è§„åˆ™ï¼ŒWebKit é€šè¿‡æ›¿æ¢â€œ&gt;â€è¿ç®—ç¬¦æ¥å®ç°æ’åºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static bool operator &gt;(CSSRuleData&amp; r1, CSSRuleData&amp; r2)</span><br><span class="line">&#123;</span><br><span class="line">    int spec1 = r1.selector()-&gt;specificity();</span><br><span class="line">    int spec2 = r2.selector()-&gt;specificity();</span><br><span class="line">    return (spec1 == spec2) : r1.position() &gt; r2.position() : spec1 &gt; spec2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¸è¿›å¼å¤„ç†"><a href="#æ¸è¿›å¼å¤„ç†" class="headerlink" title="æ¸è¿›å¼å¤„ç†"></a>æ¸è¿›å¼å¤„ç†</h3><p>WebKit ä½¿ç”¨ä¸€ä¸ªæ ‡è®°æ¥è¡¨ç¤ºæ˜¯å¦æ‰€æœ‰çš„é¡¶çº§æ ·å¼è¡¨ï¼ˆåŒ…æ‹¬ @importsï¼‰å‡å·²åŠ è½½å®Œæ¯•ã€‚å¦‚æœåœ¨é™„åŠ è¿‡ç¨‹ä¸­å°šæœªå®Œå…¨åŠ è½½æ ·å¼ï¼Œåˆ™ä½¿ç”¨å ä½ç¬¦ï¼Œå¹¶åœ¨æ–‡æ¡£ä¸­è¿›è¡Œæ ‡æ³¨ï¼Œç­‰æ ·å¼è¡¨åŠ è½½å®Œæ¯•åå†é‡æ–°è®¡ç®—ã€‚</p>
<h2 id="å¸ƒå±€"><a href="#å¸ƒå±€" class="headerlink" title="å¸ƒå±€"></a>å¸ƒå±€</h2><p>å‘ˆç°å™¨åœ¨åˆ›å»ºå®Œæˆå¹¶æ·»åŠ åˆ°å‘ˆç°æ ‘æ—¶ï¼Œå¹¶ä¸åŒ…å«ä½ç½®å’Œå¤§å°ä¿¡æ¯ã€‚è®¡ç®—è¿™äº›å€¼çš„è¿‡ç¨‹ç§°ä¸ºå¸ƒå±€æˆ–é‡æ’ã€‚</p>
<p>HTML é‡‡ç”¨åŸºäºæµçš„å¸ƒå±€æ¨¡å‹ï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•°æƒ…å†µä¸‹åªè¦ä¸€æ¬¡éå†å°±èƒ½è®¡ç®—å‡ºå‡ ä½•ä¿¡æ¯ã€‚å¤„äºæµä¸­é åä½ç½®å…ƒç´ é€šå¸¸ä¸ä¼šå½±å“é å‰ä½ç½®å…ƒç´ çš„å‡ ä½•ç‰¹å¾ï¼Œå› æ­¤å¸ƒå±€å¯ä»¥æŒ‰ä»å·¦è‡³å³ã€ä»ä¸Šè‡³ä¸‹çš„é¡ºåºéå†æ–‡æ¡£ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–æƒ…å†µï¼Œæ¯”å¦‚ HTML è¡¨æ ¼çš„è®¡ç®—å°±éœ€è¦ä¸æ­¢ä¸€æ¬¡çš„éå† (3.5)ã€‚</p>
<p>åæ ‡ç³»æ˜¯ç›¸å¯¹äºæ ¹æ¡†æ¶è€Œå»ºç«‹çš„ï¼Œä½¿ç”¨çš„æ˜¯ä¸Šåæ ‡å’Œå·¦åæ ‡ã€‚</p>
<p>å¸ƒå±€æ˜¯ä¸€ä¸ªé€’å½’çš„è¿‡ç¨‹ã€‚å®ƒä»æ ¹å‘ˆç°å™¨ï¼ˆå¯¹åº”äº HTML æ–‡æ¡£çš„ <html> å…ƒç´ ï¼‰å¼€å§‹ï¼Œç„¶åé€’å½’éå†éƒ¨åˆ†æˆ–æ‰€æœ‰çš„æ¡†æ¶å±‚æ¬¡ç»“æ„ï¼Œä¸ºæ¯ä¸€ä¸ªéœ€è¦è®¡ç®—çš„å‘ˆç°å™¨è®¡ç®—å‡ ä½•ä¿¡æ¯ã€‚</html></p>
<p>æ ¹å‘ˆç°å™¨çš„ä½ç½®å·¦è¾¹æ˜¯ 0,0ï¼Œå…¶å°ºå¯¸ä¸ºè§†å£ï¼ˆä¹Ÿå°±æ˜¯æµè§ˆå™¨çª—å£çš„å¯è§åŒºåŸŸï¼‰ã€‚<br>æ‰€æœ‰çš„å‘ˆç°å™¨éƒ½æœ‰ä¸€ä¸ªâ€œlayoutâ€æˆ–è€…â€œreflowâ€æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªå‘ˆç°å™¨éƒ½ä¼šè°ƒç”¨å…¶éœ€è¦è¿›è¡Œå¸ƒå±€çš„å­ä»£çš„ layout æ–¹æ³•ã€‚</p>
<h3 id="Dirty-ä½ç³»ç»Ÿ"><a href="#Dirty-ä½ç³»ç»Ÿ" class="headerlink" title="Dirty ä½ç³»ç»Ÿ"></a>Dirty ä½ç³»ç»Ÿ</h3><p>ä¸ºé¿å…å¯¹æ‰€æœ‰ç»†å°æ›´æ”¹éƒ½è¿›è¡Œæ•´ä½“å¸ƒå±€ï¼Œæµè§ˆå™¨é‡‡ç”¨äº†ä¸€ç§â€œdirty ä½â€ç³»ç»Ÿã€‚å¦‚æœæŸä¸ªå‘ˆç°å™¨å‘ç”Ÿäº†æ›´æ”¹ï¼Œæˆ–è€…å°†è‡ªèº«åŠå…¶å­ä»£æ ‡æ³¨ä¸ºâ€œdirtyâ€ï¼Œåˆ™éœ€è¦è¿›è¡Œå¸ƒå±€ã€‚</p>
<p>æœ‰ä¸¤ç§æ ‡è®°ï¼šâ€œdirtyâ€å’Œâ€œchildren are dirtyâ€ã€‚â€œchildren are dirtyâ€è¡¨ç¤ºå°½ç®¡å‘ˆç°å™¨è‡ªèº«æ²¡æœ‰å˜åŒ–ï¼Œä½†å®ƒè‡³å°‘æœ‰ä¸€ä¸ªå­ä»£éœ€è¦å¸ƒå±€ã€‚</p>
<h3 id="å…¨å±€å¸ƒå±€å’Œå¢é‡å¸ƒå±€"><a href="#å…¨å±€å¸ƒå±€å’Œå¢é‡å¸ƒå±€" class="headerlink" title="å…¨å±€å¸ƒå±€å’Œå¢é‡å¸ƒå±€"></a>å…¨å±€å¸ƒå±€å’Œå¢é‡å¸ƒå±€</h3><p>å…¨å±€å¸ƒå±€æ˜¯æŒ‡è§¦å‘äº†æ•´ä¸ªå‘ˆç°æ ‘èŒƒå›´çš„å¸ƒå±€ï¼Œè§¦å‘åŸå› å¯èƒ½åŒ…æ‹¬ï¼š</p>
<ol>
<li>å½±å“æ‰€æœ‰å‘ˆç°å™¨çš„å…¨å±€æ ·å¼æ›´æ”¹ï¼Œä¾‹å¦‚å­—ä½“å¤§å°æ›´æ”¹ã€‚</li>
<li>å±å¹•å¤§å°è°ƒæ•´ã€‚</li>
</ol>
<p>å¸ƒå±€å¯ä»¥é‡‡ç”¨å¢é‡æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯åªå¯¹ dirty å‘ˆç°å™¨è¿›è¡Œå¸ƒå±€ï¼ˆè¿™æ ·å¯èƒ½å­˜åœ¨éœ€è¦è¿›è¡Œé¢å¤–å¸ƒå±€çš„å¼Šç«¯ï¼‰ã€‚<br>å½“å‘ˆç°å™¨ä¸º dirty æ—¶ï¼Œä¼šå¼‚æ­¥è§¦å‘å¢é‡å¸ƒå±€ã€‚ä¾‹å¦‚ï¼Œå½“æ¥è‡ªç½‘ç»œçš„é¢å¤–å†…å®¹æ·»åŠ åˆ° DOM æ ‘ä¹‹åï¼Œæ–°çš„å‘ˆç°å™¨é™„åŠ åˆ°äº†å‘ˆç°æ ‘ä¸­ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/reflow.png" alt></p>
<center><strong>å›¾ï¼šå¢é‡å¸ƒå±€ - åªæœ‰ dirty å‘ˆç°å™¨åŠå…¶å­ä»£è¿›è¡Œå¸ƒå±€ (3.6)ã€‚</strong></center>

<h3 id="å¼‚æ­¥å¸ƒå±€å’ŒåŒæ­¥å¸ƒå±€"><a href="#å¼‚æ­¥å¸ƒå±€å’ŒåŒæ­¥å¸ƒå±€" class="headerlink" title="å¼‚æ­¥å¸ƒå±€å’ŒåŒæ­¥å¸ƒå±€"></a>å¼‚æ­¥å¸ƒå±€å’ŒåŒæ­¥å¸ƒå±€</h3><p>å¢é‡å¸ƒå±€æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚Firefox å°†å¢é‡å¸ƒå±€çš„â€œreflow å‘½ä»¤â€åŠ å…¥é˜Ÿåˆ—ï¼Œè€Œè°ƒåº¦ç¨‹åºä¼šè§¦å‘è¿™äº›å‘½ä»¤çš„æ‰¹é‡æ‰§è¡Œã€‚WebKit ä¹Ÿæœ‰ç”¨äºæ‰§è¡Œå¢é‡å¸ƒå±€çš„è®¡æ—¶å™¨ï¼šå¯¹å‘ˆç°æ ‘è¿›è¡Œéå†ï¼Œå¹¶å¯¹ dirty å‘ˆç°å™¨è¿›è¡Œå¸ƒå±€ã€‚<br>è¯·æ±‚æ ·å¼ä¿¡æ¯ï¼ˆä¾‹å¦‚â€œoffsetHeightâ€ï¼‰çš„è„šæœ¬å¯åŒæ­¥è§¦å‘å¢é‡å¸ƒå±€ã€‚<br>å…¨å±€å¸ƒå±€å¾€å¾€æ˜¯åŒæ­¥è§¦å‘çš„ã€‚<br>æœ‰æ—¶ï¼Œå½“åˆå§‹å¸ƒå±€å®Œæˆä¹‹åï¼Œå¦‚æœä¸€äº›å±æ€§ï¼ˆå¦‚æ»šåŠ¨ä½ç½®ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œå¸ƒå±€å°±ä¼šä½œä¸ºå›è°ƒè€Œè§¦å‘ã€‚</p>
<h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>å¦‚æœå¸ƒå±€æ˜¯ç”±â€œå¤§å°è°ƒæ•´â€æˆ–å‘ˆç°å™¨çš„ä½ç½®ï¼ˆè€Œéå¤§å°ï¼‰æ”¹å˜è€Œè§¦å‘çš„ï¼Œé‚£ä¹ˆå¯ä»¥ä»ç¼“å­˜ä¸­è·å–å‘ˆç°å™¨çš„å¤§å°ï¼Œè€Œæ— éœ€é‡æ–°è®¡ç®—ã€‚<br>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªå­æ ‘è¿›è¡Œäº†ä¿®æ”¹ï¼Œå› æ­¤æ— éœ€ä»æ ¹èŠ‚ç‚¹å¼€å§‹å¸ƒå±€ã€‚è¿™é€‚ç”¨äºåœ¨æœ¬åœ°è¿›è¡Œæ›´æ”¹è€Œä¸å½±å“å‘¨å›´å…ƒç´ çš„æƒ…å†µï¼Œä¾‹å¦‚åœ¨æ–‡æœ¬å­—æ®µä¸­æ’å…¥æ–‡æœ¬ï¼ˆå¦åˆ™æ¯æ¬¡é”®ç›˜è¾“å…¥éƒ½å°†è§¦å‘ä»æ ¹èŠ‚ç‚¹å¼€å§‹çš„å¸ƒå±€ï¼‰ã€‚</p>
<h3 id="å¸ƒå±€å¤„ç†"><a href="#å¸ƒå±€å¤„ç†" class="headerlink" title="å¸ƒå±€å¤„ç†"></a>å¸ƒå±€å¤„ç†</h3><p>å¸ƒå±€é€šå¸¸å…·æœ‰ä»¥ä¸‹æ¨¡å¼ï¼š</p>
<ol>
<li>çˆ¶å‘ˆç°å™¨ç¡®å®šè‡ªå·±çš„å®½åº¦ã€‚</li>
<li>çˆ¶å‘ˆç°å™¨ä¾æ¬¡å¤„ç†å­å‘ˆç°å™¨ï¼Œå¹¶ä¸”ï¼š<ol>
<li>æ”¾ç½®å­å‘ˆç°å™¨ï¼ˆè®¾ç½® x,y åæ ‡ï¼‰ã€‚</li>
<li>å¦‚æœæœ‰å¿…è¦ï¼Œè°ƒç”¨å­å‘ˆç°å™¨çš„å¸ƒå±€ï¼ˆå¦‚æœå­å‘ˆç°å™¨æ˜¯ dirty çš„ï¼Œæˆ–è€…è¿™æ˜¯å…¨å±€å¸ƒå±€ï¼Œæˆ–å‡ºäºå…¶ä»–æŸäº›åŸå› ï¼‰ï¼Œè¿™ä¼šè®¡ç®—å­å‘ˆç°å™¨çš„é«˜åº¦ã€‚</li>
</ol>
</li>
<li>çˆ¶å‘ˆç°å™¨æ ¹æ®å­å‘ˆç°å™¨çš„ç´¯åŠ é«˜åº¦ä»¥åŠè¾¹è·å’Œè¡¥ç™½çš„é«˜åº¦æ¥è®¾ç½®è‡ªèº«é«˜åº¦ï¼Œæ­¤å€¼ä¹Ÿå¯ä¾›çˆ¶å‘ˆç°å™¨çš„çˆ¶å‘ˆç°å™¨ä½¿ç”¨ã€‚</li>
<li>å°†å…¶ dirty ä½è®¾ç½®ä¸º falseã€‚</li>
</ol>
<p>Firefox ä½¿ç”¨â€œstateâ€å¯¹è±¡ (nsHTMLReflowState) ä½œä¸ºå¸ƒå±€çš„å‚æ•°ï¼ˆç§°ä¸ºâ€œreflowâ€ï¼‰ï¼Œè¿™å…¶ä¸­åŒ…æ‹¬äº†çˆ¶å‘ˆç°å™¨çš„å®½åº¦ã€‚<br>Firefox å¸ƒå±€çš„è¾“å‡ºä¸ºâ€œmetricsâ€å¯¹è±¡ (nsHTMLReflowMetrics)ï¼Œå…¶åŒ…å«è®¡ç®—å¾—å‡ºçš„å‘ˆç°å™¨é«˜åº¦ã€‚</p>
<h3 id="å®½åº¦è®¡ç®—"><a href="#å®½åº¦è®¡ç®—" class="headerlink" title="å®½åº¦è®¡ç®—"></a>å®½åº¦è®¡ç®—</h3><p>å‘ˆç°å™¨å®½åº¦æ˜¯æ ¹æ®å®¹å™¨å—çš„å®½åº¦ã€å‘ˆç°å™¨æ ·å¼ä¸­çš„â€œwidthâ€å±æ€§ä»¥åŠè¾¹è·å’Œè¾¹æ¡†è®¡ç®—å¾—å‡ºçš„ã€‚<br>ä¾‹å¦‚ä»¥ä¸‹ div çš„å®½åº¦ï¼š</p>
<p><code>&lt;div style=&quot;width:30%&quot;/&gt;</code> å°†ç”± WebKit è®¡ç®—å¦‚ä¸‹ï¼ˆBenderBox ç±»ï¼ŒcalcWidth æ–¹æ³•ï¼‰ï¼š</p>
<ul>
<li>å®¹å™¨çš„å®½åº¦å–å®¹å™¨çš„ availableWidth å’Œ 0 ä¸­çš„è¾ƒå¤§å€¼ã€‚availableWidth åœ¨æœ¬ä¾‹ä¸­ç›¸å½“äº contentWidthï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š<br><code>clientWidth() - paddingLeft() - paddingRight()</code><br>clientWidth å’Œ clientHeight è¡¨ç¤ºä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨ï¼ˆé™¤å»è¾¹æ¡†å’Œæ»šåŠ¨æ¡ï¼‰ã€‚</li>
<li>å…ƒç´ çš„å®½åº¦æ˜¯â€œwidthâ€æ ·å¼å±æ€§ã€‚å®ƒä¼šæ ¹æ®å®¹å™¨å®½åº¦çš„ç™¾åˆ†æ¯”è®¡ç®—å¾—å‡ºä¸€ä¸ªç»å¯¹å€¼ã€‚</li>
<li>ç„¶ååŠ ä¸Šæ°´å¹³æ–¹å‘çš„è¾¹æ¡†å’Œè¡¥ç™½ã€‚</li>
</ul>
<p>ç°åœ¨è®¡ç®—å¾—å‡ºçš„æ˜¯â€œpreferred widthâ€ã€‚ç„¶åéœ€è¦è®¡ç®—æœ€å°å®½åº¦å’Œæœ€å¤§å®½åº¦ã€‚<br>å¦‚æœé¦–é€‰å®½åº¦å¤§äºæœ€å¤§å®½åº¦ï¼Œé‚£ä¹ˆåº”ä½¿ç”¨æœ€å¤§å®½åº¦ã€‚å¦‚æœé¦–é€‰å®½åº¦å°äºæœ€å°å®½åº¦ï¼ˆæœ€å°çš„ä¸å¯ç ´å¼€å•ä½ï¼‰ï¼Œé‚£ä¹ˆåº”ä½¿ç”¨æœ€å°å®½åº¦ã€‚<br>è¿™äº›å€¼ä¼šç¼“å­˜èµ·æ¥ï¼Œä»¥ç”¨äºéœ€è¦å¸ƒå±€è€Œå®½åº¦ä¸å˜çš„æƒ…å†µã€‚</p>
<h3 id="æ¢è¡Œ"><a href="#æ¢è¡Œ" class="headerlink" title="æ¢è¡Œ"></a>æ¢è¡Œ</h3><p>å¦‚æœå‘ˆç°å™¨åœ¨å¸ƒå±€è¿‡ç¨‹ä¸­éœ€è¦æ¢è¡Œï¼Œä¼šç«‹å³åœæ­¢å¸ƒå±€ï¼Œå¹¶å‘ŠçŸ¥å…¶çˆ¶ä»£éœ€è¦æ¢è¡Œã€‚çˆ¶ä»£ä¼šåˆ›å»ºé¢å¤–çš„å‘ˆç°å™¨ï¼Œå¹¶å¯¹å…¶è°ƒç”¨å¸ƒå±€ã€‚</p>
<h2 id="ç»˜åˆ¶"><a href="#ç»˜åˆ¶" class="headerlink" title="ç»˜åˆ¶"></a>ç»˜åˆ¶</h2><p>åœ¨ç»˜åˆ¶é˜¶æ®µï¼Œç³»ç»Ÿä¼šéå†å‘ˆç°æ ‘ï¼Œå¹¶è°ƒç”¨å‘ˆç°å™¨çš„â€œpaintâ€æ–¹æ³•ï¼Œå°†å‘ˆç°å™¨çš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ç»˜åˆ¶å·¥ä½œæ˜¯ä½¿ç”¨ç”¨æˆ·ç•Œé¢åŸºç¡€ç»„ä»¶å®Œæˆçš„ã€‚</p>
<h2 id="å…¨å±€ç»˜åˆ¶å’Œå¢é‡ç»˜åˆ¶"><a href="#å…¨å±€ç»˜åˆ¶å’Œå¢é‡ç»˜åˆ¶" class="headerlink" title="å…¨å±€ç»˜åˆ¶å’Œå¢é‡ç»˜åˆ¶"></a>å…¨å±€ç»˜åˆ¶å’Œå¢é‡ç»˜åˆ¶</h2><p>å’Œå¸ƒå±€ä¸€æ ·ï¼Œç»˜åˆ¶ä¹Ÿåˆ†ä¸ºå…¨å±€ï¼ˆç»˜åˆ¶æ•´ä¸ªå‘ˆç°æ ‘ï¼‰å’Œå¢é‡ä¸¤ç§ã€‚åœ¨å¢é‡ç»˜åˆ¶ä¸­ï¼Œéƒ¨åˆ†å‘ˆç°å™¨å‘ç”Ÿäº†æ›´æ”¹ï¼Œä½†æ˜¯ä¸ä¼šå½±å“æ•´ä¸ªæ ‘ã€‚æ›´æ”¹åçš„å‘ˆç°å™¨å°†å…¶åœ¨å±å¹•ä¸Šå¯¹åº”çš„çŸ©å½¢åŒºåŸŸè®¾ä¸ºæ— æ•ˆï¼Œè¿™å¯¼è‡´ OS å°†å…¶è§†ä¸ºä¸€å—â€œdirty åŒºåŸŸâ€ï¼Œå¹¶ç”Ÿæˆâ€œpaintâ€äº‹ä»¶ã€‚OS ä¼šå¾ˆå·§å¦™åœ°å°†å¤šä¸ªåŒºåŸŸåˆå¹¶æˆä¸€ä¸ªã€‚åœ¨ Chrome æµè§ˆå™¨ä¸­ï¼Œæƒ…å†µè¦æ›´å¤æ‚ä¸€äº›ï¼Œå› ä¸º Chrome æµè§ˆå™¨çš„å‘ˆç°å™¨ä¸åœ¨ä¸»è¿›ç¨‹ä¸Šã€‚Chrome æµè§ˆå™¨ä¼šåœ¨æŸç§ç¨‹åº¦ä¸Šæ¨¡æ‹Ÿ OS çš„è¡Œä¸ºã€‚å±•ç¤ºå±‚ä¼šä¾¦å¬è¿™äº›äº‹ä»¶ï¼Œå¹¶å°†æ¶ˆæ¯å§”æ‰˜ç»™å‘ˆç°æ ¹èŠ‚ç‚¹ã€‚ç„¶åéå†å‘ˆç°æ ‘ï¼Œç›´åˆ°æ‰¾åˆ°ç›¸å…³çš„å‘ˆç°å™¨ï¼Œè¯¥å‘ˆç°å™¨ä¼šé‡æ–°ç»˜åˆ¶è‡ªå·±ï¼ˆé€šå¸¸ä¹ŸåŒ…æ‹¬å…¶å­ä»£ï¼‰ã€‚</p>
<h3 id="ç»˜åˆ¶é¡ºåº"><a href="#ç»˜åˆ¶é¡ºåº" class="headerlink" title="ç»˜åˆ¶é¡ºåº"></a>ç»˜åˆ¶é¡ºåº</h3><p>CSS2 è§„èŒƒå®šä¹‰äº†ç»˜åˆ¶æµç¨‹çš„é¡ºåºã€‚ç»˜åˆ¶çš„é¡ºåºå…¶å®å°±æ˜¯å…ƒç´ è¿›å…¥å †æ ˆæ ·å¼ä¸Šä¸‹æ–‡çš„é¡ºåºã€‚è¿™äº›å †æ ˆä¼šä»åå¾€å‰ç»˜åˆ¶ï¼Œå› æ­¤è¿™æ ·çš„é¡ºåºä¼šå½±å“ç»˜åˆ¶ã€‚å—å‘ˆç°å™¨çš„å †æ ˆé¡ºåºå¦‚ä¸‹ï¼š</p>
<ol>
<li>èƒŒæ™¯é¢œè‰²</li>
<li>èƒŒæ™¯å›¾ç‰‡</li>
<li>è¾¹æ¡†</li>
<li>å­ä»£</li>
<li>è½®å»“</li>
</ol>
<h3 id="Firefox-æ˜¾ç¤ºåˆ—è¡¨"><a href="#Firefox-æ˜¾ç¤ºåˆ—è¡¨" class="headerlink" title="Firefox æ˜¾ç¤ºåˆ—è¡¨"></a>Firefox æ˜¾ç¤ºåˆ—è¡¨</h3><p>Firefox éå†æ•´ä¸ªå‘ˆç°æ ‘ï¼Œä¸ºç»˜åˆ¶çš„çŸ©å½¢å»ºç«‹ä¸€ä¸ªæ˜¾ç¤ºåˆ—è¡¨ã€‚åˆ—è¡¨ä¸­æŒ‰ç…§æ­£ç¡®çš„ç»˜åˆ¶é¡ºåºï¼ˆå…ˆæ˜¯å‘ˆç°å™¨çš„èƒŒæ™¯ï¼Œç„¶åæ˜¯è¾¹æ¡†ç­‰ç­‰ï¼‰åŒ…å«äº†ä¸çŸ©å½¢ç›¸å…³çš„å‘ˆç°å™¨ã€‚è¿™æ ·ç­‰åˆ°é‡æ–°ç»˜åˆ¶çš„æ—¶å€™ï¼Œåªéœ€éå†ä¸€æ¬¡å‘ˆç°æ ‘ï¼Œè€Œä¸ç”¨å¤šæ¬¡éå†ï¼ˆç»˜åˆ¶æ‰€æœ‰èƒŒæ™¯ï¼Œç„¶åç»˜åˆ¶æ‰€æœ‰å›¾ç‰‡ï¼Œå†ç»˜åˆ¶æ‰€æœ‰è¾¹æ¡†ç­‰ç­‰ï¼‰ã€‚<br>Firefox å¯¹æ­¤è¿‡ç¨‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä¹Ÿå°±æ˜¯ä¸æ·»åŠ éšè—çš„å…ƒç´ ï¼Œä¾‹å¦‚è¢«ä¸é€æ˜å…ƒç´ å®Œå…¨é®æŒ¡ä½çš„å…ƒç´ ã€‚</p>
<h3 id="WebKit-çŸ©å½¢å­˜å‚¨"><a href="#WebKit-çŸ©å½¢å­˜å‚¨" class="headerlink" title="WebKit çŸ©å½¢å­˜å‚¨"></a>WebKit çŸ©å½¢å­˜å‚¨</h3><p>åœ¨é‡æ–°ç»˜åˆ¶ä¹‹å‰ï¼ŒWebKit ä¼šå°†åŸæ¥çš„çŸ©å½¢å¦å­˜ä¸ºä¸€å¼ ä½å›¾ï¼Œç„¶ååªç»˜åˆ¶æ–°æ—§çŸ©å½¢ä¹‹é—´çš„å·®å¼‚éƒ¨åˆ†ã€‚ </p>
<h2 id="åŠ¨æ€å˜åŒ–"><a href="#åŠ¨æ€å˜åŒ–" class="headerlink" title="åŠ¨æ€å˜åŒ–"></a>åŠ¨æ€å˜åŒ–</h2><p>åœ¨å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæµè§ˆå™¨ä¼šå°½å¯èƒ½åšå‡ºæœ€å°çš„å“åº”ã€‚å› æ­¤ï¼Œå…ƒç´ çš„é¢œè‰²æ”¹å˜åï¼Œåªä¼šå¯¹è¯¥å…ƒç´ è¿›è¡Œé‡ç»˜ã€‚å…ƒç´ çš„ä½ç½®æ”¹å˜åï¼Œåªä¼šå¯¹è¯¥å…ƒç´ åŠå…¶å­å…ƒç´ ï¼ˆå¯èƒ½è¿˜æœ‰åŒçº§å…ƒç´ ï¼‰è¿›è¡Œå¸ƒå±€å’Œé‡ç»˜ã€‚æ·»åŠ  DOM èŠ‚ç‚¹åï¼Œä¼šå¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œå¸ƒå±€å’Œé‡ç»˜ã€‚ä¸€äº›é‡å¤§å˜åŒ–ï¼ˆä¾‹å¦‚å¢å¤§â€œhtmlâ€å…ƒç´ çš„å­—ä½“ï¼‰ä¼šå¯¼è‡´ç¼“å­˜æ— æ•ˆï¼Œä½¿å¾—æ•´ä¸ªå‘ˆç°æ ‘éƒ½ä¼šè¿›è¡Œé‡æ–°å¸ƒå±€å’Œç»˜åˆ¶ã€‚</p>
<h2 id="å‘ˆç°å¼•æ“çš„çº¿ç¨‹"><a href="#å‘ˆç°å¼•æ“çš„çº¿ç¨‹" class="headerlink" title="å‘ˆç°å¼•æ“çš„çº¿ç¨‹"></a>å‘ˆç°å¼•æ“çš„çº¿ç¨‹</h2><p>å‘ˆç°å¼•æ“é‡‡ç”¨äº†å•çº¿ç¨‹ã€‚å‡ ä¹æ‰€æœ‰æ“ä½œï¼ˆé™¤äº†ç½‘ç»œæ“ä½œï¼‰éƒ½æ˜¯åœ¨å•çº¿ç¨‹ä¸­è¿›è¡Œçš„ã€‚åœ¨ Firefox å’Œ Safari ä¸­ï¼Œè¯¥çº¿ç¨‹å°±æ˜¯æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ã€‚è€Œåœ¨ Chrome æµè§ˆå™¨ä¸­ï¼Œè¯¥çº¿ç¨‹æ˜¯æ ‡ç­¾è¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚<br>ç½‘ç»œæ“ä½œå¯ç”±å¤šä¸ªå¹¶è¡Œçº¿ç¨‹æ‰§è¡Œã€‚å¹¶è¡Œè¿æ¥æ•°æ˜¯æœ‰é™çš„ï¼ˆé€šå¸¸ä¸º 2 è‡³ 6 ä¸ªï¼Œä»¥ Firefox 3 ä¸ºä¾‹æ˜¯ 6 ä¸ªï¼‰ã€‚</p>
<h3 id="äº‹ä»¶å¾ªç¯"><a href="#äº‹ä»¶å¾ªç¯" class="headerlink" title="äº‹ä»¶å¾ªç¯"></a>äº‹ä»¶å¾ªç¯</h3><p>æµè§ˆå™¨çš„ä¸»çº¿ç¨‹æ˜¯äº‹ä»¶å¾ªç¯ã€‚å®ƒæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæ°¸è¿œå¤„äºæ¥å—å¤„ç†çŠ¶æ€ï¼Œå¹¶ç­‰å¾…äº‹ä»¶ï¼ˆå¦‚å¸ƒå±€å’Œç»˜åˆ¶äº‹ä»¶ï¼‰å‘ç”Ÿï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚è¿™æ˜¯ Firefox ä¸­å…³äºä¸»äº‹ä»¶å¾ªç¯çš„ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">while (!mExiting)</span><br><span class="line">    NS_ProcessNextEvent(thread);</span><br></pre></td></tr></table></figure></p>
<h2 id="CSS2-å¯è§†åŒ–æ¨¡å‹"><a href="#CSS2-å¯è§†åŒ–æ¨¡å‹" class="headerlink" title="CSS2 å¯è§†åŒ–æ¨¡å‹"></a>CSS2 å¯è§†åŒ–æ¨¡å‹</h2><h3 id="ç”»å¸ƒ"><a href="#ç”»å¸ƒ" class="headerlink" title="ç”»å¸ƒ"></a>ç”»å¸ƒ</h3><p>æ ¹æ® CSS2 è§„èŒƒï¼Œâ€œç”»å¸ƒâ€è¿™ä¸€æœ¯è¯­æ˜¯æŒ‡â€œç”¨æ¥å‘ˆç°æ ¼å¼åŒ–ç»“æ„çš„ç©ºé—´â€ï¼Œä¹Ÿå°±æ˜¯ä¾›æµè§ˆå™¨ç»˜åˆ¶å†…å®¹çš„åŒºåŸŸã€‚ç”»å¸ƒçš„ç©ºé—´å°ºå¯¸å¤§å°æ˜¯æ— é™çš„ï¼Œä½†æ˜¯æµè§ˆå™¨ä¼šæ ¹æ®è§†å£çš„å°ºå¯¸é€‰æ‹©ä¸€ä¸ªåˆå§‹å®½åº¦ã€‚</p>
<p>æ ¹æ® <a href="http://www.w3.org/TR/CSS2/zindex.html" target="_blank" rel="noopener">www.w3.org/TR/CSS2/zindex.html</a>ï¼Œç”»å¸ƒå¦‚æœåŒ…å«åœ¨å…¶ä»–ç”»å¸ƒå†…ï¼Œå°±æ˜¯é€æ˜çš„ï¼›å¦åˆ™ä¼šç”±æµè§ˆå™¨æŒ‡å®šä¸€ç§é¢œè‰²ã€‚</p>
<h3 id="CSS-æ¡†æ¨¡å‹"><a href="#CSS-æ¡†æ¨¡å‹" class="headerlink" title="CSS æ¡†æ¨¡å‹"></a>CSS æ¡†æ¨¡å‹</h3><p>CSS æ¡†æ¨¡å‹æè¿°çš„æ˜¯é’ˆå¯¹æ–‡æ¡£æ ‘ä¸­çš„å…ƒç´ è€Œç”Ÿæˆï¼Œå¹¶æ ¹æ®å¯è§†åŒ–æ ¼å¼æ¨¡å‹è¿›è¡Œå¸ƒå±€çš„çŸ©å½¢æ¡†ã€‚<br>æ¯ä¸ªæ¡†éƒ½æœ‰ä¸€ä¸ªå†…å®¹åŒºåŸŸï¼ˆä¾‹å¦‚æ–‡æœ¬ã€å›¾ç‰‡ç­‰ï¼‰ï¼Œè¿˜æœ‰å¯é€‰çš„å‘¨å›´è¡¥ç™½ã€è¾¹æ¡†å’Œè¾¹è·åŒºåŸŸã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image046.jpg" alt></p>
<center><strong>å›¾ï¼šCSS2 æ¡†æ¨¡å‹</strong></center>

<p>æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šç”Ÿæˆ 0..n ä¸ªè¿™æ ·çš„æ¡†ã€‚<br>æ‰€æœ‰å…ƒç´ éƒ½æœ‰ä¸€ä¸ªâ€œdisplayâ€å±æ€§ï¼Œå†³å®šäº†å®ƒä»¬æ‰€å¯¹åº”ç”Ÿæˆçš„æ¡†ç±»å‹ã€‚ç¤ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">block  - generates a block box.</span><br><span class="line">inline - generates one or more inline boxes.</span><br><span class="line">none - no box is generated.</span><br></pre></td></tr></table></figure></p>
<p> é»˜è®¤å€¼æ˜¯ inlineï¼Œä½†æ˜¯æµè§ˆå™¨æ ·å¼è¡¨è®¾ç½®äº†å…¶ä»–é»˜è®¤å€¼ã€‚ä¾‹å¦‚ï¼Œâ€œdivâ€å…ƒç´ çš„ display å±æ€§é»˜è®¤å€¼æ˜¯ blockã€‚<br>æ‚¨å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°é»˜è®¤æ ·å¼è¡¨ç¤ºä¾‹ï¼š<a href="http://www.w3.org/TR/CSS2/sample.html" target="_blank" rel="noopener">www.w3.org/TR/CSS2/sample.html</a></p>
<h3 id="å®šä½æ–¹æ¡ˆ"><a href="#å®šä½æ–¹æ¡ˆ" class="headerlink" title="å®šä½æ–¹æ¡ˆ"></a>å®šä½æ–¹æ¡ˆ</h3><p>æœ‰ä¸‰ç§å®šä½æ–¹æ¡ˆï¼š</p>
<ol>
<li>æ™®é€šï¼šæ ¹æ®å¯¹è±¡åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®è¿›è¡Œå®šä½ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹è±¡åœ¨å‘ˆç°æ ‘ä¸­çš„ä½ç½®å’Œå®ƒåœ¨ DOM æ ‘ä¸­çš„ä½ç½®ç›¸ä¼¼ï¼Œå¹¶æ ¹æ®å…¶æ¡†ç±»å‹å’Œå°ºå¯¸è¿›è¡Œå¸ƒå±€ã€‚</li>
<li>æµ®åŠ¨ï¼šå¯¹è±¡å…ˆæŒ‰ç…§æ™®é€šæµè¿›è¡Œå¸ƒå±€ï¼Œç„¶åå°½å¯èƒ½åœ°å‘å·¦æˆ–å‘å³ç§»åŠ¨ã€‚</li>
<li>ç»å¯¹ï¼šå¯¹è±¡åœ¨å‘ˆç°æ ‘ä¸­çš„ä½ç½®å’Œå®ƒåœ¨ DOM æ ‘ä¸­çš„ä½ç½®ä¸åŒã€‚</li>
</ol>
<p>å®šä½æ–¹æ¡ˆæ˜¯ç”±â€œpositionâ€å±æ€§å’Œâ€œfloatâ€å±æ€§è®¾ç½®çš„ã€‚</p>
<ul>
<li>å¦‚æœå€¼æ˜¯ static å’Œ relativeï¼Œå°±æ˜¯æ™®é€šæµ</li>
<li>å¦‚æœå€¼æ˜¯ absolute å’Œ fixedï¼Œå°±æ˜¯ç»å¯¹å®šä½</li>
</ul>
<p>static å®šä½æ— éœ€å®šä¹‰ä½ç½®ï¼Œè€Œæ˜¯ä½¿ç”¨é»˜è®¤å®šä½ã€‚å¯¹äºå…¶ä»–æ–¹æ¡ˆï¼Œç½‘é¡µä½œè€…éœ€è¦æŒ‡å®šä½ç½®ï¼štopã€bottomã€leftã€rightã€‚<br>æ¡†çš„å¸ƒå±€æ–¹å¼æ˜¯ç”±ä»¥ä¸‹å› ç´ å†³å®šçš„ï¼š</p>
<ul>
<li>æ¡†ç±»å‹</li>
<li>æ¡†å°ºå¯¸</li>
<li>å®šä½æ–¹æ¡ˆ</li>
<li>å¤–éƒ¨ä¿¡æ¯ï¼Œä¾‹å¦‚å›¾ç‰‡å¤§å°å’Œå±å¹•å¤§å°</li>
</ul>
<h3 id="æ¡†ç±»å‹"><a href="#æ¡†ç±»å‹" class="headerlink" title="æ¡†ç±»å‹"></a>æ¡†ç±»å‹</h3><p>block æ¡†ï¼šå½¢æˆä¸€ä¸ª blockï¼Œåœ¨æµè§ˆå™¨çª—å£ä¸­æ‹¥æœ‰å…¶è‡ªå·±çš„çŸ©å½¢åŒºåŸŸã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image057.png" alt></p>
<center><strong>å›¾ï¼šblock æ¡†</strong></center>

<p>inline æ¡†ï¼šæ²¡æœ‰è‡ªå·±çš„ blockï¼Œä½†æ˜¯ä½äºå®¹å™¨ block å†…ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image059.png" alt></p>
<center><strong>å›¾ï¼šinline æ¡†</strong></center>

<p>block é‡‡ç”¨çš„æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªçš„å‚ç›´æ ¼å¼ï¼Œè€Œ inline é‡‡ç”¨çš„æ˜¯æ°´å¹³æ ¼å¼ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image061.png" alt></p>
<center><strong>å›¾ï¼šblock å’Œ inline æ ¼å¼</strong></center>

<p>inline æ¡†æ”¾ç½®åœ¨è¡Œä¸­æˆ–â€œè¡Œæ¡†â€ä¸­ã€‚è¿™äº›è¡Œè‡³å°‘å’Œæœ€é«˜çš„æ¡†ä¸€æ ·é«˜ï¼Œè¿˜å¯ä»¥æ›´é«˜ï¼Œå½“æ¡†æ ¹æ®â€œåº•çº¿â€å¯¹é½æ—¶ï¼Œè¿™æ„å‘³ç€å…ƒç´ çš„åº•éƒ¨éœ€è¦æ ¹æ®å…¶ä»–æ¡†ä¸­éåº•éƒ¨çš„ä½ç½®å¯¹é½ã€‚å¦‚æœå®¹å™¨çš„å®½åº¦ä¸å¤Ÿï¼Œinline å…ƒç´ å°±ä¼šåˆ†ä¸ºå¤šè¡Œæ”¾ç½®ã€‚åœ¨æ®µè½ä¸­ç»å¸¸å‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image063.png" alt></p>
<center><strong>å›¾ï¼šè¡Œ</strong></center>

<h3 id="å®šä½"><a href="#å®šä½" class="headerlink" title="å®šä½"></a>å®šä½</h3><h4 id="ç›¸å¯¹"><a href="#ç›¸å¯¹" class="headerlink" title="ç›¸å¯¹"></a>ç›¸å¯¹</h4><p>ç›¸å¯¹å®šä½ï¼šå…ˆæŒ‰ç…§æ™®é€šæ–¹å¼å®šä½ï¼Œç„¶åæ ¹æ®æ‰€éœ€åç§»é‡è¿›è¡Œç§»åŠ¨ã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image065.png" alt></p>
<center><strong>å›¾ï¼šç›¸å¯¹å®šä½</strong></center>

<h4 id="æµ®åŠ¨"><a href="#æµ®åŠ¨" class="headerlink" title="æµ®åŠ¨"></a>æµ®åŠ¨</h4><p>æµ®åŠ¨æ¡†ä¼šç§»åŠ¨åˆ°è¡Œçš„å·¦è¾¹æˆ–å³è¾¹ã€‚æœ‰è¶£çš„ç‰¹å¾åœ¨äºï¼Œå…¶ä»–æ¡†ä¼šæµ®åŠ¨åœ¨å®ƒçš„å‘¨å›´ã€‚ä¸‹é¢è¿™æ®µ HTML ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">style</span>=<span class="string">"float:right"</span> <span class="attr">src</span>=<span class="string">"images/image.gif"</span> <span class="attr">width</span>=<span class="string">"100"</span> <span class="attr">height</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">  Lorem ipsum dolor sit amet, consectetuer...</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image067.png" alt></p>
<center><strong>å›¾ï¼šæµ®åŠ¨</strong></center>

<h4 id="ç»å¯¹å®šä½å’Œå›ºå®šå®šä½"><a href="#ç»å¯¹å®šä½å’Œå›ºå®šå®šä½" class="headerlink" title="ç»å¯¹å®šä½å’Œå›ºå®šå®šä½"></a>ç»å¯¹å®šä½å’Œå›ºå®šå®šä½</h4><p>è¿™ç§å¸ƒå±€æ˜¯å‡†ç¡®å®šä¹‰çš„ï¼Œä¸æ™®é€šæµæ— å…³ã€‚å…ƒç´ ä¸å‚ä¸æ™®é€šæµã€‚å°ºå¯¸æ˜¯ç›¸å¯¹äºå®¹å™¨è€Œè¨€çš„ã€‚åœ¨å›ºå®šå®šä½ä¸­ï¼Œå®¹å™¨å°±æ˜¯å¯è§†åŒºåŸŸã€‚</p>
<p><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image069.png" alt></p>
<center><strong>å›¾ï¼šå›ºå®šå®šä½</strong></center>

<p>è¯·æ³¨æ„ï¼Œå³ä½¿åœ¨æ–‡æ¡£æ»šåŠ¨æ—¶ï¼Œå›ºå®šæ¡†ä¹Ÿä¸ä¼šç§»åŠ¨ã€‚</p>
<h3 id="åˆ†å±‚å±•ç¤º"><a href="#åˆ†å±‚å±•ç¤º" class="headerlink" title="åˆ†å±‚å±•ç¤º"></a>åˆ†å±‚å±•ç¤º</h3><p>è¿™æ˜¯ç”± z-index CSS å±æ€§æŒ‡å®šçš„ã€‚å®ƒä»£è¡¨äº†æ¡†çš„ç¬¬ä¸‰ä¸ªç»´åº¦ï¼Œä¹Ÿå°±æ˜¯æ²¿â€œz è½´â€æ–¹å‘çš„ä½ç½®ã€‚</p>
<p>è¿™äº›æ¡†åˆ†æ•£åˆ°å¤šä¸ªå †æ ˆï¼ˆç§°ä¸ºå †æ ˆä¸Šä¸‹æ–‡ï¼‰ä¸­ã€‚åœ¨æ¯ä¸€ä¸ªå †æ ˆä¸­ï¼Œä¼šé¦–å…ˆç»˜åˆ¶åé¢çš„å…ƒç´ ï¼Œç„¶ååœ¨é¡¶éƒ¨ç»˜åˆ¶å‰é¢çš„å…ƒç´ ï¼Œä»¥ä¾¿æ›´é è¿‘ç”¨æˆ·ã€‚å¦‚æœå‡ºç°é‡å ï¼Œæ–°ç»˜åˆ¶çš„å…ƒç´ å°±ä¼šè¦†ç›–ä¹‹å‰çš„å…ƒç´ ã€‚<br>å †æ ˆæ˜¯æŒ‰ç…§ z-index å±æ€§è¿›è¡Œæ’åºçš„ã€‚å…·æœ‰â€œz-indexâ€å±æ€§çš„æ¡†å½¢æˆäº†æœ¬åœ°å †æ ˆã€‚è§†å£å…·æœ‰å¤–éƒ¨å †æ ˆã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">      div &#123;</span></span><br><span class="line"><span class="undefined">        position: absolute;</span></span><br><span class="line"><span class="undefined">        left: 2in;</span></span><br><span class="line"><span class="undefined">        top: 2in;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">         <span class="attr">style</span>=<span class="string">"z-index: 3;background-color:red; width: 1in; height: 1in; "</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">         <span class="attr">style</span>=<span class="string">"z-index: 1;background-color:green;width: 2in; height: 2in;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š<br><img src="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/image071.png" alt></p>
<center><strong>å›¾ï¼šå›ºå®šå®šä½</strong></center>

<p>è™½ç„¶çº¢è‰² div åœ¨æ ‡è®°ä¸­çš„ä½ç½®æ¯”ç»¿è‰² div é å‰ï¼ˆæŒ‰ç†åº”è¯¥åœ¨å¸¸è§„æµç¨‹ä¸­ä¼˜å…ˆç»˜åˆ¶ï¼‰ï¼Œä½†æ˜¯ z-index å±æ€§çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå› æ­¤å®ƒç§»åŠ¨åˆ°äº†æ ¹æ¡†æ‰€ä¿æŒçš„å †æ ˆä¸­æ›´é å‰çš„ä½ç½®ã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>è½¬è½½</category>
      </categories>
      <tags>
        <tag>å‰ç«¯</tag>
      </tags>
  </entry>
  <entry>
    <title>AFNetworking3æºç é˜…è¯»-Reachability</title>
    <url>/essay/AFNetworking/AFNetworking3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-Reachability/</url>
    <content><![CDATA[<blockquote>
<p>AFNetworking3æºç é˜…è¯»-Reachability</p>
<p>ç”¨äºç›‘æ§ç½‘ç»œçŠ¶æ€ã€‚å½“ç½‘ç»œçŠ¶æ€æ”¹å˜æ—¶ï¼Œæ˜¯é‡æ–°å‘èµ·ä¸€äº›è¯·æ±‚çš„å¥½æ—¶é—´ï¼›ç½‘ç»œçŠ¶æ€çš„ç›‘æ§ä¹Ÿèƒ½ç»™ç”¨æˆ·æ›´å¥½çš„ç½‘ç»œå¤±è´¥æç¤ºã€‚</p>
</blockquote>
<h2 id="AFNetworkReachabilityManager"><a href="#AFNetworkReachabilityManager" class="headerlink" title="AFNetworkReachabilityManager"></a>AFNetworkReachabilityManager</h2><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[AFNetworkReachabilityManager sharedManager] setReachabilityStatusChangeBlock:^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Reachability: %@"</span>, AFStringFromNetworkReachabilityStatus(status));</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[[AFNetworkReachabilityManager sharedManager] startMonitoring];</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>AFNetworkReachabilityManagerä¸­å¤§æ¦‚æœ‰è¿™ä¹ˆå‡ ä¸ªæ–¹æ³•ï¼š</p>
<p><img src="/res/AFNetworking/AFNetworking3æºç é˜…è¯»-Reachability-1.jpg" width="50%"></p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><blockquote>
<p>sharedManager ä½¿ç”¨GCD <code>dispatch_once_t</code>å•ä¾‹åŒ–ã€‚å…·ä½“å®ä¾‹è°ƒç”¨ manager æ–¹æ³•ã€‚<br>+manageræ–¹æ³•ä½¿ç”¨äº†è¿™ä¸ªå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ï¼Œç”¨äº0.0.0.0çš„è¿æ¥å™¨</p>
</blockquote>
<p><code>__IPHONE_OS_VERSION_MIN_REQUIRED</code> åœ¨iOSç¯å¢ƒä¸‹ï¼ˆè¦æ±‚æœ€ä½çš„ç³»ç»Ÿç‰ˆæœ¬ï¼‰ï¼›<br><code>__MAC_OS_X_VERSION_MIN_REQUIRED</code>åˆ™è¡¨ç¤ºmacç¯å¢ƒä¸‹è¦æ±‚çš„æœ€ä½ç¯å¢ƒ<br>90000 è¡¨ç¤º <code>__IPHONE_9_0</code> ï¼›101100 è¡¨ç¤º <code>__MAC_10_11</code></p>
<p>sockaddr_in6 ä»£è¡¨ipv6åœ°å€<br>sockaddr_in ä»£è¡¨ipv4dåœ°å€<br>ç”±äºIPv6 æ˜¯ios9å’Œos_x 10.11åè¾¹æ¨å‡ºçš„ï¼Œè¿™é‡Œè¦è¿›è¡Œç‰ˆæœ¬åˆ¤æ–­ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)manager</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#if (defined(__IPHONE_OS_VERSION_MIN_REQUIRED) &amp;&amp; __IPHONE_OS_VERSION_MIN_REQUIRED &gt;= 90000) || (defined(__MAC_OS_X_VERSION_MIN_REQUIRED) &amp;&amp; __MAC_OS_X_VERSION_MIN_REQUIRED &gt;= 101100)</span></span><br><span class="line">    <span class="keyword">struct</span> sockaddr_in6 address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin6_len = <span class="keyword">sizeof</span>(address);</span><br><span class="line">    address.sin6_family = AF_INET6;</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="keyword">struct</span> sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_len = <span class="keyword">sizeof</span>(address);</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> managerForAddress:&amp;address];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é€šè¿‡<code>SCNetworkReachabilityCreateWithAddress</code>ç”ŸæˆSCNetworkReachabilityRefå¯¹è±¡ï¼Œé€šè¿‡ç›‘æ§è¯¥å¯¹è±¡ï¼Œå³å¯è·å¾—ç½‘ç»œè¿æ¥æƒ…å†µã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)managerForAddress:(<span class="keyword">const</span> <span class="keyword">void</span> *)address &#123;</span><br><span class="line">    <span class="built_in">SCNetworkReachabilityRef</span> reachability = <span class="built_in">SCNetworkReachabilityCreateWithAddress</span>(kCFAllocatorDefault, (<span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *)address);</span><br><span class="line">    AFNetworkReachabilityManager *manager = [[<span class="keyword">self</span> alloc] initWithReachability:reachability];</span><br><span class="line">	<span class="comment">//åœ¨`initWithReachability `ä¸­CFRetainäº†reachabilityï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦CFReleaseã€‚</span></span><br><span class="line">    <span class="built_in">CFRelease</span>(reachability);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç›‘å¬"><a href="#ç›‘å¬" class="headerlink" title="ç›‘å¬"></a>ç›‘å¬</h3><blockquote>
<p>å¼€å¯ç›‘å¬åï¼Œè·å¾—è¿æ¥çŠ¶æ€ä¼šè°ƒç”¨<code>AFPostReachabilityStatusChange</code>ï¼Œåœ¨AFPostReachabilityStatusChangeä¸­è°ƒç”¨å›è°ƒï¼Œå¹¶å‘é€é€šçŸ¥</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startMonitoring &#123;</span><br><span class="line">    [<span class="keyword">self</span> stopMonitoring];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.networkReachability) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç›‘å¬å›è°ƒï¼ŒåŒæ—¶è°ƒç”¨networkReachabilityStatusBlock</span></span><br><span class="line">    __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf = <span class="keyword">self</span>;</span><br><span class="line">    AFNetworkReachabilityStatusBlock callback = ^(AFNetworkReachabilityStatus status) &#123;</span><br><span class="line">        __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf = weakSelf;</span><br><span class="line">		<span class="comment">//ä¿®æ”¹networkReachabilityStatusçŠ¶æ€</span></span><br><span class="line">        strongSelf.networkReachabilityStatus = status;</span><br><span class="line">        <span class="keyword">if</span> (strongSelf.networkReachabilityStatusBlock) &#123;</span><br><span class="line">            strongSelf.networkReachabilityStatusBlock(status);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//ç›‘å¬éœ€è¦çš„æ­¥éª¤ï¼š</span></span><br><span class="line">    <span class="comment">//1. æ–°å»ºä¸Šä¸‹æ–‡</span></span><br><span class="line">    <span class="built_in">SCNetworkReachabilityContext</span> context = &#123;<span class="number">0</span>, (__bridge <span class="keyword">void</span> *)callback, AFNetworkReachabilityRetainCallback, AFNetworkReachabilityReleaseCallback, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    <span class="comment">//2. è®¾ç½®å›è°ƒï¼Œ, å½“self.networkReachabilityçš„ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶ï¼Œå‘Šä¹‹callBackå¤„ç†</span></span><br><span class="line">    <span class="built_in">SCNetworkReachabilitySetCallback</span>(<span class="keyword">self</span>.networkReachability, AFNetworkReachabilityCallback, &amp;context);</span><br><span class="line">    <span class="comment">//3. å°†networkReachabilityåŠ å…¥RunLoop</span></span><br><span class="line">    <span class="built_in">SCNetworkReachabilityScheduleWithRunLoop</span>(<span class="keyword">self</span>.networkReachability, <span class="built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes);</span><br><span class="line">    <span class="comment">//4. è·å¾—è¿æ¥çŠ¶æ€ï¼Œå¹¶è°ƒç”¨å›è°ƒ</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, <span class="number">0</span>),^&#123;</span><br><span class="line">        <span class="built_in">SCNetworkReachabilityFlags</span> flags;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">SCNetworkReachabilityGetFlags</span>(<span class="keyword">self</span>.networkReachability, &amp;flags)) &#123;</span><br><span class="line">            AFPostReachabilityStatusChange(flags, callback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å…³é—­ç›‘å¬</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)stopMonitoring &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.networkReachability) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†networkReachabilityä»RunLoopä¸­ç§»é™¤</span></span><br><span class="line">    <span class="built_in">SCNetworkReachabilityUnscheduleFromRunLoop</span>(<span class="keyword">self</span>.networkReachability, <span class="built_in">CFRunLoopGetMain</span>(), kCFRunLoopCommonModes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨å†Œé”®å€¼ç›‘å¬</p>
</blockquote>
<p>é‡è£…keyPathsForValuesAffectingValueForKeyï¼ŒæŒ‡æ˜reachable ã€reachableViaWWAN å’ŒreachableViaWiFiå±æ€§ä¾èµ–äºnetworkReachabilityStatusã€‚å½“networkReachabilityStatusæ”¹å˜æ—¶ï¼Œè§‚å¯Ÿreachable ã€reachableViaWWAN å’ŒreachableViaWiFiå±æ€§çš„ç¨‹åºéœ€è¦è¢«é€šçŸ¥ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºè·å¾—ç½‘ç»œçŠ¶æ€æ—¶ï¼Œå›è°ƒä¸­åªä¿®æ”¹äº†networkReachabilityStatuså€¼ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span> *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"reachable"</span>] || [key isEqualToString:<span class="string">@"reachableViaWWAN"</span>] || [key isEqualToString:<span class="string">@"reachableViaWiFi"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObject:<span class="string">@"networkReachabilityStatus"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SCNetworkReachability"><a href="#SCNetworkReachability" class="headerlink" title="SCNetworkReachability"></a>SCNetworkReachability</h3><blockquote>
<p>ä»ä¸Šæ–‡å¯ä»¥çœ‹å‡ºç›‘å¬ä¸»è¦ä½¿ç”¨çš„æ˜¯SystemConfigurationæ¡†æ¶ä¸­ SCNetworkReachability.hä¸­çš„æ–¹æ³•ã€‚è¿™é‡Œä»‹ç»ä¸€ä¸‹ç”¨åˆ°çš„æ–¹æ³•å’Œæ•°æ®ç±»å‹ã€‚</p>
</blockquote>
<p><strong>SCNetworkReachabilityFlags</strong>ï¼š ä¿å­˜è¿æ¥çŠ¶æ€å„ä¸ªçŠ¶æ€çš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_OPTIONS</span>(uint32_t, <span class="built_in">SCNetworkReachabilityFlags</span>) &#123;</span><br><span class="line">	kSCNetworkReachabilityFlagsTransientConnection = <span class="number">1</span>&lt;&lt;<span class="number">0</span>, <span class="comment">// å¯ä»¥é€šè¿‡ç¬æ—¶è¿æ¥ï¼ˆä¾‹å¦‚PPPï¼ï¼ï¼ç‚¹å¯¹ç‚¹é€šè®¯åè®®ï¼‰ é“¾æ¥åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€</span></span><br><span class="line">	kSCNetworkReachabilityFlagsReachable	 = <span class="number">1</span>&lt;&lt;<span class="number">1</span>, <span class="comment">// å½“å‰ç½‘ç»œé…ç½®å¯ä»¥è¯·æ±‚åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€</span></span><br><span class="line">	kSCNetworkReachabilityFlagsConnectionRequired = <span class="number">1</span>&lt;&lt;<span class="number">2</span>, <span class="comment">//å½“å‰ç½‘ç»œé…ç½®å¯ä»¥è¯·æ±‚åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€ï¼Œä½†å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚å¦‚æœåˆ›å»ºè¿™ä¸ªæ ‡è¯†ï¼Œéœ€è¦è±¡å¾æ€§åœ°ç”Ÿæˆ</span></span><br><span class="line">	kSCNetworkReachabilityFlagsConnectionOnTraffic = <span class="number">1</span>&lt;&lt;<span class="number">3</span>, <span class="comment">//å½“å‰ç½‘ç»œé…ç½®å¯ä»¥è¯·æ±‚åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€ï¼Œä½†å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚å®šå‘åˆ°æŒ‡å®šèŠ‚ç‚¹æˆ–åœ°å€çš„é€šä¿¡å°†å‘èµ·è¯¥è¿æ¥</span></span><br><span class="line">	kSCNetworkReachabilityFlagsInterventionRequired = <span class="number">1</span>&lt;&lt;<span class="number">4</span>, <span class="comment">//å½“å‰ç½‘ç»œé…ç½®å¯ä»¥è¯·æ±‚åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€ï¼Œä½†å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚</span></span><br><span class="line">	<span class="comment">//ç”¨æˆ·éœ€è¦é€šè¿‡æŸäº›æ–¹å¼çš„ä»‹å…¥æ¥åˆ›å»ºè¯¥è¿æ¥ï¼Œæ¯”å¦‚æä¾›å¯†ç ã€è®¤è¯å£ä»¤ç­‰ã€‚</span></span><br><span class="line">	<span class="comment">//ä¸€èˆ¬çš„ï¼Œåªæœ‰åœ¨ä¸€ä¸ªæ‹¨å·é€šä¿¡çš„é…ç½®ä¸­ï¼Œåœ¨è‡ªåŠ¨è¿æ¥è¿‡ç¨‹ä¸­å‘ç”ŸæŸäº›é”™è¯¯ï¼ˆæ¯”å¦‚æ²¡æœ‰æ‹¨å·éŸ³ï¼Œæ²¡æœ‰å›åº”ï¼Œæ— æ•ˆçš„å¯†ç ç­‰ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒPPPé€šä¿¡å°†ä¼šç»ˆæ­¢è¿æ¥ç›´åˆ°ç”¨æˆ·ä»‹å…¥ã€‚</span></span><br><span class="line">	kSCNetworkReachabilityFlagsConnectionOnDemand = <span class="number">1</span>&lt;&lt;<span class="number">5</span>, <span class="comment">//å½“å‰ç½‘ç»œé…ç½®å¯ä»¥è¯·æ±‚åˆ°ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€ï¼Œä½†å¿…é¡»å…ˆåˆ›å»ºä¸€ä¸ªè¿æ¥ã€‚è¯¥è¯·æ±‚ä¸€ç»CFSocketStreamç¨‹åºæ¥å£è¯·æ±‚å°±åˆ›å»ºï¼Œå…¶ä»–çš„å‡½æ•°ä¸ä¼šåˆ›å»ºè¯¥è¿æ¥</span></span><br><span class="line">	kSCNetworkReachabilityFlagsIsLocalAddress = <span class="number">1</span>&lt;&lt;<span class="number">16</span>, <span class="comment">//æ‰€è¯·æ±‚çš„èŠ‚ç‚¹æˆ–åœ°å€ä¸ºè¿æ¥åˆ°å½“å‰ç³»ç»Ÿçš„ç½‘ç»œèŠ‚ç‚¹</span></span><br><span class="line">	kSCNetworkReachabilityFlagsIsDirect	= <span class="number">1</span>&lt;&lt;<span class="number">17</span>, <span class="comment">//ç½‘ç»œé€šä¿¡ä¸ä¼šé€šè¿‡ç½‘å…³è¿æ¥ç»™å®šçš„èŠ‚ç‚¹åå’Œåœ°å€ï¼Œè€Œæ˜¯ç›´æ¥è·¯ç”±åˆ°ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¥å£ä¸Š</span></span><br><span class="line"><span class="meta">#if	TARGET_OS_IPHONE</span></span><br><span class="line">	kSCNetworkReachabilityFlagsIsWWAN		= <span class="number">1</span>&lt;&lt;<span class="number">18</span>, <span class="comment">// å¯é€šè¿‡èœ‚çªæ•°æ®ç½‘ç»œè®¿é—®ç»™å®šçš„èŠ‚ç‚¹æˆ–åœ°å€</span></span><br><span class="line"><span class="meta">#endif	// TARGET_OS_IPHONE</span></span><br><span class="line"></span><br><span class="line">	kSCNetworkReachabilityFlagsConnectionAutomatic	= kSCNetworkReachabilityFlagsConnectionOnTraffic</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>SCNetworkReachabilityRef</strong> ç”¨æ¥æµ‹è¯•è¿æ¥çš„å¼•ç”¨ã€‚æœ‰ä¸‰ç§åˆ›å»ºæ–¹å¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">SCNetworkReachabilityCreateWithAddress</span>(allocator,address)</span><br><span class="line"><span class="built_in">SCNetworkReachabilityCreateWithAddressPair</span>(allocator,localAddress,remoteAddress)</span><br><span class="line"><span class="built_in">SCNetworkReachabilityCreateWithName</span>(allocator,nodename)</span><br></pre></td></tr></table></figure>
<p><strong>SCNetworkReachabilityContext</strong> ä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line"> <span class="comment">// åˆ›å»ºä¸€ä¸ªSCNetworkReachabilityContextç»“æ„ä½“æ—¶ï¼Œéœ€è¦è°ƒç”¨SCDynamicStoreçš„åˆ›å»ºå‡½æ•°ï¼Œè€Œæ­¤åˆ›å»ºå‡½æ•°ä¼šæ ¹æ®versionæ¥åˆ›å»ºå‡ºä¸åŒçš„ç»“æ„ä½“ï¼ŒSCNetworkReachabilityContextå¯¹åº”çš„versionæ˜¯0</span></span><br><span class="line"> <span class="built_in">CFIndex</span>        version;  </span><br><span class="line"><span class="comment">// ä¸‹é¢ä¸¤ä¸ªblockï¼ˆreleaseå’Œretainï¼‰çš„å‚æ•°å°±æ˜¯infoï¼Œæ­¤å¤„è¡¨ç¤ºçš„æ˜¯ç½‘ç»œçŠ¶æ€å¤„ç†çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  <span class="keyword">void</span> *        __<span class="keyword">nullable</span> info;</span><br><span class="line"><span class="comment">// è¯¥retain blockç”¨äºå¯¹infoè¿›è¡Œretainï¼Œä¸‹é¢é‚£ä¸ªAFNetworkReachabilityRetainCallbackæ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº†Block_copyï¼ˆç”¨äºretainä¸€ä¸ªblockå‡½æ•°ï¼Œå³åœ¨å †ç©ºé—´æ–°å»ºæˆ–ç›´æ¥å¼•ç”¨ä¸€ä¸ªblockæ‹·è´ï¼‰</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span>    * __<span class="keyword">nonnull</span> (* __<span class="keyword">nullable</span> <span class="keyword">retain</span>)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line"><span class="comment">// è¯¥release blockç”¨äºå¯¹infoè¿›è¡Œreleaseï¼Œä¸‹é¢é‚£ä¸ªAFNetworkReachabilityReleaseCallbackæ ¸å¿ƒå°±æ˜¯è°ƒç”¨äº†Block_releaseï¼ˆç”¨äºreleaseä¸€ä¸ªblockå‡½æ•°ï¼Œå³å°†blockä»å †ç©ºé—´ç§»é™¤æˆ–ç§»é™¤ç›¸åº”å¼•ç”¨ï¼‰</span></span><br><span class="line">  <span class="keyword">void</span>        (* __<span class="keyword">nullable</span> release)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line"><span class="comment">// æä¾›infoçš„descriptionï¼Œæ­¤å¤„è°ƒç”¨ä¸ºNULL</span></span><br><span class="line"><span class="built_in">CFStringRef</span>    __<span class="keyword">nonnull</span> (* __<span class="keyword">nullable</span> copyDescription)(<span class="keyword">const</span> <span class="keyword">void</span> *info);</span><br><span class="line">&#125; <span class="built_in">SCNetworkReachabilityContext</span>;</span><br></pre></td></tr></table></figure>
<p><strong>SCNetworkReachabilitySetCallback</strong> ç»™å®¢æˆ·ç«¯æŒ‡å®šå¯¹åº”targetï¼ˆè¯¥å‚æ•°å’Œéœ€è¦æ£€æµ‹ç½‘ç»œçŠ¶å†µçš„åœ°å€æœ‰ä¸€å®šå…³è”ï¼Œæ­¤å¤„ä½¿ç”¨çš„æ˜¯self.networkReachabilityï¼‰ï¼Œç„¶åå½“è¿™ä¸ªtargetçš„ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶ï¼Œå‘Šä¹‹SCNetworkReachabilityCallBackå¯¹è±¡callBackå¤„ç†ï¼ˆæ­¤å¤„ä½¿ç”¨çš„æ˜¯AFNetworkReachabilityCallbackï¼‰ï¼Œå¦å¤–callBackä¸­ä½¿ç”¨åˆ°çš„å‚æ•°åŒ…æ‹¬targetå’Œcontextæä¾›çš„infoã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">Boolean</span><br><span class="line"><span class="built_in">SCNetworkReachabilitySetCallback</span>		(</span><br><span class="line">						<span class="built_in">SCNetworkReachabilityRef</span> target,</span><br><span class="line">						<span class="built_in">SCNetworkReachabilityCallBack</span> __<span class="keyword">nullable</span> callout,</span><br><span class="line">						<span class="built_in">SCNetworkReachabilityContext</span> * __<span class="keyword">nullable</span> context</span><br><span class="line">						)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AFNetworking</category>
      </categories>
      <tags>
        <tag>AFNetworking</tag>
      </tags>
  </entry>
  <entry>
    <title>AFNetworking3æºç é˜…è¯»-Serialization</title>
    <url>/essay/AFNetworking/AFNetworking3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-Serialization/</url>
    <content><![CDATA[<blockquote>
<p>Serialization åŒ…æ‹¬ <code>AFURLResponseSerialization</code> å’Œ <code>AFURLRequestSerialization</code></p>
</blockquote>
<p><strong>AFURLResponseSerialization</strong> æ˜¯å¤„ç†å“åº”çš„æ¨¡å—ï¼Œå°†è¯·æ±‚è¿”å›çš„æ•°æ®è§£ææˆå¯¹åº”çš„æ ¼å¼ã€‚è€Œ<strong>AFURLRequestSerialization</strong>çš„ä¸»è¦ä½œç”¨æ˜¯ä¿®æ”¹è¯·æ±‚ï¼ˆä¸»è¦æ˜¯ HTTP è¯·æ±‚ï¼‰çš„å¤´éƒ¨ï¼Œæä¾›äº†ä¸€äº›è¯­ä¹‰æ˜ç¡®çš„æ¥å£è®¾ç½® HTTP å¤´éƒ¨å­—æ®µã€‚</p>
<h2 id="AFURLResponseSerialization"><a href="#AFURLResponseSerialization" class="headerlink" title="AFURLResponseSerialization"></a>AFURLResponseSerialization</h2><blockquote>
<p>AFURLResponseSerialization æ˜¯ä¸€ä¸ªåè®®ï¼Œåè®®çš„å†…å®¹ä¸ºï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)responseObjectForResponse:(<span class="keyword">nullable</span> <span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„å®ç°ç±»ä¸ºï¼š</p>
<ul>
<li>AFURLResponseSerialization<ul>
<li>AFHTTPResponseSerializer<ul>
<li>AFJSONResponseSerializer</li>
<li>AFXMLParserResponseSerializer</li>
<li>AFXMLDocumentResponseSerializer</li>
<li>AFPropertyListResponseSerializer</li>
<li>AFImageResponseSerializer</li>
<li>AFCompoundResponseSerializer</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åœ¨æ–‡ä»¶ä¸­ æ‰€æœ‰ç±»éƒ½éµå¾ª<strong>AFURLResponseSerialization</strong>ï¼Œè€Œ<strong>AFHTTPResponseSerializer</strong>æ˜¯å…¶ä»–ç±»çš„åŸºç±»ã€‚</p>
<a id="more"></a>
<h3 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h3><p><strong>åˆå§‹åŒ–:</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.acceptableStatusCodes = [<span class="built_in">NSIndexSet</span> indexSetWithIndexesInRange:<span class="built_in">NSMakeRange</span>(<span class="number">200</span>, <span class="number">100</span>)];</span><br><span class="line">    <span class="keyword">self</span>.acceptableContentTypes = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ˜¯å¯¹ HTTP å“åº”è¿›è¡Œåºåˆ—åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®äº† stringEncoding ä¸º NSUTF8StringEncoding è€Œä¸”æ²¡æœ‰å¯¹æ¥æ”¶çš„å†…å®¹ç±»å‹åŠ ä»¥é™åˆ¶ã€‚<br>å°† acceptableStatusCodes è®¾ç½®ä¸ºä» 200 åˆ° 299 ä¹‹é—´çš„çŠ¶æ€ç , å› ä¸ºåªæœ‰è¿™äº›çŠ¶æ€ç è¡¨ç¤ºè·å¾—äº†æœ‰æ•ˆçš„å“åº”ã€‚</p>
<p><strong>éªŒè¯å“åº”çš„æœ‰æ•ˆæ€§:</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response</span><br><span class="line">                    data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                   error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> responseIsValid = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">NSError</span> *validationError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response &amp;&amp; [response isKindOfClass:[<span class="built_in">NSHTTPURLResponse</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableContentTypes &amp;&amp; ![<span class="keyword">self</span>.acceptableContentTypes containsObject:[response MIMEType]]) &#123;</span><br><span class="line">			<span class="meta">#1: è¿”å›å†…å®¹ç±»å‹æ— æ•ˆ</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableStatusCodes &amp;&amp; ![<span class="keyword">self</span>.acceptableStatusCodes containsIndex:(<span class="built_in">NSUInteger</span>)response.statusCode] &amp;&amp; [response URL]) &#123;</span><br><span class="line">			<span class="meta">#2: è¿”å›çŠ¶æ€ç æ— æ•ˆ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; !responseIsValid) &#123;</span><br><span class="line">        *error = validationError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseIsValid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•æ ¹æ®åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­åˆå§‹åŒ–çš„å±æ€§ acceptableContentTypes å’Œ acceptableStatusCodes æ¥åˆ¤æ–­å½“å‰å“åº”æ˜¯å¦æœ‰æ•ˆã€‚</p>
<h4 id="AFURLResponseSerializationåè®®çš„å®ç°"><a href="#AFURLResponseSerializationåè®®çš„å®ç°" class="headerlink" title="AFURLResponseSerializationåè®®çš„å®ç°"></a>AFURLResponseSerializationåè®®çš„å®ç°</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response data:data error:error];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å¯¹å“åº”è¿›è¡ŒéªŒè¯ï¼Œç„¶åè¿”å›æ•°æ®</p>
<h3 id="AFJSONResponseSerializer"><a href="#AFJSONResponseSerializer" class="headerlink" title="AFJSONResponseSerializer"></a>AFJSONResponseSerializer</h3><p><strong>åˆå§‹åŒ–ï¼š</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> serializerWithReadingOptions:(<span class="built_in">NSJSONReadingOptions</span>)<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializerWithReadingOptions:(<span class="built_in">NSJSONReadingOptions</span>)readingOptions &#123;</span><br><span class="line">    AFJSONResponseSerializer *serializer = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    serializer.readingOptions = readingOptions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"application/json"</span>, <span class="string">@"text/json"</span>, <span class="string">@"text/javascript"</span>, <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å¯¹AFHTTPResponseSerializer è®¾ç½®äº†<strong>acceptableContentTypes</strong>ï¼›</p>
<h4 id="AFURLResponseSerializationåè®®çš„å®ç°ï¼š"><a href="#AFURLResponseSerializationåè®®çš„å®ç°ï¼š" class="headerlink" title="AFURLResponseSerializationåè®®çš„å®ç°ï¼š"></a>AFURLResponseSerializationåè®®çš„å®ç°ï¼š</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">	<span class="number">1.</span> éªŒè¯è¯·æ±‚</span><br><span class="line"></span><br><span class="line">	<span class="number">2.</span> è§£å†³ä¸€ä¸ªç”±åªåŒ…å«ä¸€ä¸ªç©ºæ ¼çš„å“åº”å¼•èµ·çš„ bug</span><br><span class="line"></span><br><span class="line">	<span class="number">3.</span> åºåˆ—åŒ– JSON</span><br><span class="line">	</span><br><span class="line">	<span class="number">4.</span> ç§»é™¤ JSON ä¸­çš„ null</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        *error = AFErrorWithUnderlyingError(serializationError, *error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1. éªŒè¯è¯·æ±‚</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (![<span class="keyword">self</span> validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response data:data error:error]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, <span class="built_in">NSURLErrorCannotDecodeContentData</span>, AFURLResponseSerializationErrorDomain)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨è‡ªèº«çš„validateResponseéªŒè¯å“åº”ï¼Œ<br>validateResponse:ä¸­å¦‚æœcontent-typeä¸æ»¡è¶³ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„validationErrorå°±æ˜¯Domainä¸ºAFURLResponseSerializationErrorDomainï¼Œcodeä¸ºNSURLErrorCannotDecodeContentDataï¼Œå†ç”¨ <strong>AFErrorOrUnderlyingErrorHasCodeInDomain</strong>æ£€éªŒerror å’Œdomainï¼Œå¦‚æœå°±æ˜¯è¿™ä¸¤ä¸ªå€¼ å°±è¿”å›nilã€‚</p>
<p><strong>2. è§£å†³ä¸€ä¸ªç”±åªåŒ…å«ä¸€ä¸ªç©ºæ ¼çš„å“åº”å¼•èµ·çš„ bug</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> isSpace = [data isEqualToData:[<span class="built_in">NSData</span> dataWithBytes:<span class="string">" "</span> length:<span class="number">1</span>]];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (data.length == <span class="number">0</span> || isSpace) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºâ€™head :okâ€™ï¼ŒRailsè¿”å›çš„æ˜¯ä¸€ä¸ªç©ºæ ¼ (è¿™æ˜¯Safariä¸Šçš„ä¸€ä¸ªbug)ï¼Œå¹¶ä¸”è¿™æ ·çš„JSONæ ¼å¼ä¸ä¼šè¢«NSJSONSerializationè§£æã€‚å¦‚æœæ˜¯å•ä¸ªç©ºæ ¼ï¼Œå°±ä¸è§£æ<br>æŸ¥çœ‹ <a href="https://github.com/rails/rails/issues/1742" target="_blank" rel="noopener">Issues 1742</a></p>
<p><strong>3.åºåˆ—åŒ– JSON</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span> responseObject = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:<span class="keyword">self</span>.readingOptions error:&amp;serializationError];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!responseObject)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        *error = AFErrorWithUnderlyingError(serializationError, *error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„NSJSONSerializationæ¥è§£æNSDataæ•°æ®,å¦‚æœserializationErrorä¸ä¸ºç©ºï¼Œé‚£ä¹ˆæœ€ç»ˆçš„errorå…¶å®å°±æ˜¯serializationError</p>
<p><strong>4. ç§»é™¤ JSON ä¸­çš„ null</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.removesKeysWithNullValues) &#123;</span><br><span class="line">    <span class="keyword">return</span> AFJSONObjectByRemovingKeysWithNullValues(responseObject, <span class="keyword">self</span>.readingOptions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AFJSONObjectByRemovingKeysWithNullValuesé€šè¿‡é€’å½’çš„æ–¹æ³•ï¼ŒæŠŠJSONä¸­NSDictionaryçš„æ•°æ®ï¼ˆä¸åŒ…æ‹¬NSArrayï¼‰ä¸­çš„å¯¹åº”valueä¸ºç©ºçš„keyç§»é™¤ã€‚</p>
<h2 id="AFURLRequestSerialization"><a href="#AFURLRequestSerialization" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h2><p>AFURLRequestSerialization çš„ä¸»è¦å·¥ä½œæ˜¯å¯¹å‘å‡ºçš„ HTTP è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚</p>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[AFHTTPRequestSerializer serializer] requestWithMethod:<span class="string">@"GET"</span> URLString:URLString parameters:parameters error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">[[AFHTTPRequestSerializer serializer] requestWithMethod:<span class="string">@"POST"</span> URLString:URLString parameters:parameters error:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">[[AFJSONRequestSerializer serializer] requestWithMethod:<span class="string">@"POST"</span> URLString:URLString parameters:parameters error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h3 id="AFURLRequestSerialization-1"><a href="#AFURLRequestSerialization-1" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h3><blockquote>
<p>AFURLRequestSerialization æ˜¯ä¸€ä¸ªåè®®</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„å®ç°ç±»ä¸ºï¼š</p>
<ul>
<li>AFURLRequestSerialization<ul>
<li>AFHTTPRequestSerializer<ul>
<li>AFJSONRequestSerializer</li>
<li>AFPropertyListRequestSerializer</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>AFHTTPRequestSerializer</strong>æ˜¯æ‰€æœ‰ç±»çš„åŸºç±»ï¼ŒAFJSONRequestSerializer å’Œ AFPropertyListRequestSerializerç»§æ‰¿äº†AFHTTPRequestSerializerã€‚</p>
<h3 id="AFHTTPRequestSerializer"><a href="#AFHTTPRequestSerializer" class="headerlink" title="AFHTTPRequestSerializer"></a>AFHTTPRequestSerializer</h3><p><strong>åˆå§‹åŒ–ï¼š</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init&#123;</span><br><span class="line">	<span class="number">1.</span> åˆå§‹åŒ–å‚æ•°, </span><br><span class="line">	<span class="number">2.</span> è®¾ç½®HTTP å¤´éƒ¨å­—æ®µ</span><br><span class="line">	<span class="number">3.</span> KVO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1. åˆå§‹åŒ–å‚æ•°</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">self</span>.stringEncoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line"><span class="keyword">self</span>.mutableHTTPRequestHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line"><span class="keyword">self</span>.requestHeaderModificationQueue = dispatch_queue_create(<span class="string">"requestHeaderModificationQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"GET"</span>, <span class="string">@"HEAD"</span>, <span class="string">@"DELETE"</span>, <span class="literal">nil</span>];</span><br><span class="line"><span class="keyword">self</span>.mutableObservedChangedKeyPaths = [<span class="built_in">NSMutableSet</span> set];</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–äº†ä¸€äº›å‚æ•° ,<strong>HTTPMethodsEncodingParametersInURI</strong>è¡¨ç¤ºéœ€è¦å°†çš„queyæ˜¯æ‹¼æ¥åˆ°urlåé¢çš„çš„æ–¹æ³•ï¼Œå°±æ˜¯<code>GET HEAD DELETE</code>ï¼Œä¸æ­¤å¯¹åº”çš„<code>POST PUT</code>æ–¹æ³•å°†queryæ‹¼åˆ°http bodyä¸­ã€‚<strong>mutableHTTPRequestHeaders</strong> å‚¨å­˜httpå¤´éƒ¨ä¿¡æ¯ã€‚<strong>mutableObservedChangedKeyPaths</strong>ä¿å­˜éœ€è¦é”®å€¼è§‚å¯Ÿçš„å€¼ã€‚<br><strong>requestHeaderModificationQueue</strong> ï¼Ÿï¼Ÿ</p>
<p><strong>2. è®¾ç½®HTTP å¤´éƒ¨å­—æ®µ</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">   <span class="built_in">NSMutableArray</span> *acceptLanguagesComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">...</span><br><span class="line">[<span class="keyword">self</span> setValue:[acceptLanguagesComponents componentsJoinedByString:<span class="string">@", "</span>] forHTTPHeaderField:<span class="string">@"Accept-Language"</span>];</span><br><span class="line">   </span><br><span class="line"><span class="built_in">NSString</span> *userAgent = <span class="literal">nil</span>;</span><br><span class="line">...</span><br><span class="line">[<span class="keyword">self</span> setValue:userAgent forHTTPHeaderField:<span class="string">@"User-Agent"</span>];</span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«è®¾ç½®äº†<strong>acceptLanguagesComponents</strong>å’Œ<strong>userAgent</strong>ä¿¡æ¯ã€‚<br>å…¶ä¸­<code>acceptLanguagesComponents</code>ä¸€èˆ¬ä¸º:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">en;q=1</span><br></pre></td></tr></table></figure></p>
<p>userAgentä¸º:<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[å·¥ç¨‹åå­—]/[å·¥ç¨‹ç‰ˆæœ¬] (iPhone; iOS <span class="number">10.2</span>; Scale/<span class="number">2.00</span>)</span><br></pre></td></tr></table></figure></p>
<p><strong>3.KVO</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">       <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">           [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:keyPath options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹ä¸€äº›å±æ€§è¿›è¡Œ KVOï¼Œç¡®ä¿å®ƒä»¬åœ¨æ”¹å˜åæ›´æ–° NSMutableURLRequest ä¸­å¯¹åº”çš„å±æ€§ã€‚å…¶ä¸­<strong>AFHTTPRequestSerializerObservedKeyPaths</strong>ä¸ºè¿™äº›å€¼ï¼š<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//æ˜¯å¦å…è®¸ä½¿ç”¨è®¾å¤‡çš„èœ‚çªç§»åŠ¨ç½‘ç»œæ¥åˆ›å»ºrequestï¼Œé»˜è®¤ä¸ºå…è®¸</span><br><span class="line">allowsCellularAccess, </span><br><span class="line">/* åˆ›å»ºçš„requestæ‰€ä½¿ç”¨çš„ç¼“å­˜ç­–ç•¥ï¼Œé»˜è®¤ä½¿ç”¨`NSURLRequestUseProtocolCachePolicy`ï¼Œè¯¥ç­–ç•¥è¡¨ç¤º </span><br><span class="line"> å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œç›´æ¥ä»æœåŠ¡ç«¯è·å–ã€‚å¦‚æœç¼“å­˜å­˜åœ¨ï¼Œä¼šæ ¹æ®responseä¸­çš„Cache-Controlå­—æ®µåˆ¤æ–­</span><br><span class="line"> ä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦‚: Cache-Controlå­—æ®µä¸ºmust-revalidata, åˆ™ è¯¢é—®æœåŠ¡ç«¯è¯¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼Œæ— æ›´æ–°è¯</span><br><span class="line"> ç›´æ¥è¿”å›ç»™ç”¨æˆ·ç¼“å­˜æ•°æ®ï¼Œè‹¥å·²æ›´æ–°ï¼Œåˆ™è¯·æ±‚æœåŠ¡ç«¯.*/</span><br><span class="line">cachePolicy, </span><br><span class="line">/**</span><br><span class="line"> å¦‚æœè®¾ç½®HTTPShouldHandleCookiesä¸ºYESï¼Œå°±å¤„ç†å­˜å‚¨åœ¨NSHTTPCookieStoreä¸­çš„cookies</span><br><span class="line"> HTTPShouldHandleCookiesè¡¨ç¤ºæ˜¯å¦åº”è¯¥ç»™requestè®¾ç½®cookieå¹¶éšrequestä¸€èµ·å‘é€å‡ºå»</span><br><span class="line"> */</span><br><span class="line">HTTPShouldHandleCookies, </span><br><span class="line">/**</span><br><span class="line"> HTTPShouldUsePipeliningè¡¨ç¤ºreceiver(ç†è§£ä¸ºiOSå®¢æˆ·ç«¯)çš„ä¸‹ä¸€ä¸ªä¿¡æ¯æ˜¯å¦å¿…é¡»ç­‰åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚å›å¤æ‰èƒ½å‘é€ã€‚</span><br><span class="line"> å¦‚æœä¸ºYESè¡¨ç¤ºå¯ä»¥ï¼ŒNOè¡¨ç¤ºå¿…é¡»ç­‰receiveræ”¶åˆ°å…ˆå‰çš„å›å¤æ‰èƒ½å‘é€ä¸‹ä¸ªä¿¡æ¯ã€‚</span><br><span class="line"> */</span><br><span class="line">HTTPShouldUsePipelining,</span><br><span class="line">    /**</span><br><span class="line">     è®¾å®šrequestçš„network serviceç±»å‹. é»˜è®¤æ˜¯`NSURLNetworkServiceTypeDefault`.</span><br><span class="line">     è¿™ä¸ªnetwork serviceæ˜¯ä¸ºäº†å‘Šè¯‰ç³»ç»Ÿç½‘ç»œå±‚è¿™ä¸ªrequestä½¿ç”¨çš„ç›®çš„</span><br><span class="line">     æ¯”å¦‚NSURLNetworkServiceTypeVoIPè¡¨ç¤ºçš„å°±è¿™ä¸ªrequestæ˜¯ç”¨æ¥è¯·æ±‚ç½‘é™…åè®®é€šè¯æŠ€æœ¯(Voice over IP)ã€‚</span><br><span class="line"></span><br><span class="line">     ç³»ç»Ÿèƒ½æ ¹æ®æä¾›çš„ä¿¡æ¯æ¥ä¼˜åŒ–ç½‘ç»œå¤„ç†ï¼Œä»è€Œä¼˜åŒ–ç”µæ± å¯¿å‘½ï¼Œç½‘ç»œæ€§èƒ½ç­‰ç­‰</span><br><span class="line">     */</span><br><span class="line">networkServiceType,</span><br><span class="line">/**</span><br><span class="line"> è¶…æ—¶æœºåˆ¶ï¼Œé»˜è®¤60ç§’</span><br><span class="line"> */</span><br><span class="line">timeoutInterval</span><br></pre></td></tr></table></figure></p>
<h4 id="AFURLRequestSerialization-åè®®çš„å®ç°"><a href="#AFURLRequestSerialization-åè®®çš„å®ç°" class="headerlink" title="AFURLRequestSerialization åè®®çš„å®ç°"></a>AFURLRequestSerialization åè®®çš„å®ç°</h4><p>åˆå§‹åŒ–ä¹‹åï¼Œå¦‚æœè°ƒç”¨äº† - [AFHTTPSessionManager dataTaskWithHTTPMethod:URLString:parameters:uploadProgress:downloadProgress:success:failure:]ï¼Œå°±ä¼šè¿›å…¥ AFHTTPRequestSerializer çš„è¿™ä¸€æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­è°ƒç”¨äº†AFURLRequestSerialization åè®®çš„å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error&#123;</span><br><span class="line">                                        </span><br><span class="line"><span class="number">1.</span> é€šè¿‡ HTTPRequestHeaders å­—å…¸è®¾ç½®å¤´éƒ¨å­—æ®µ</span><br><span class="line"><span class="number">2.</span> å°†parametersè½¬æ¢ä¸ºæŸ¥è¯¢å‚æ•°query</span><br><span class="line"><span class="number">3.</span> å°† query æ·»åŠ åˆ° URL æˆ–è€… HTTP body ä¸­</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.é€šè¿‡ HTTPRequestHeaders å­—å…¸è®¾ç½®å¤´éƒ¨å­—æ®µ</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">     <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">         [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>
<p><strong>2. å°†parametersè½¬æ¢ä¸ºæŸ¥è¯¢å‚æ•°query</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">query = AFQueryStringFromParameters(parameters);</span><br></pre></td></tr></table></figure>
<p>AFQueryStringFromParameters (è°ƒç”¨)-&gt; AFQueryStringPairsFromDictionary -&gt; AFQueryStringPairsFromKeyAndValue<br>å…¶ä¸­AFQueryStringPairsFromKeyAndValueé€’å½’è°ƒç”¨å¹¶è§£æï¼Œè¿”å›æŸ¥è¯¢å‚æ•°ã€‚</p>
<p><strong>3. å°† query æ·»åŠ åˆ° URL æˆ–è€… HTTP body ä¸­</strong></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (query &amp;&amp; query.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        mutableRequest.URL = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span></span><br><span class="line">    <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">        query = <span class="string">@""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">        [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span>.stringEncoding]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª NSMutableURLRequestã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>AFNetworking</category>
      </categories>
      <tags>
        <tag>AFNetworking</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§1 Cpu å’Œ Memoryä¿¡æ¯</title>
    <url>/essay/APM/iOSAPM1/</url>
    <content><![CDATA[<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>CPU å ç”¨ç‡çš„é‡‡é›†åŸç†å…¶å®å¾ˆç®€å•ï¼šApp ä½œä¸ºè¿›ç¨‹è¿è¡Œæ—¶ä¼šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨ç‡ä¸åŒã€‚å„ä¸ªçº¿ç¨‹å¯¹ CPU ä½¿ç”¨ç‡çš„æ€»å’Œï¼Œå°±æ˜¯å½“å‰ App å¯¹ CPU çš„å ç”¨ç‡ã€‚</p>
<p>wikiä¸Šæ¯”è¾ƒå…¨çš„iPhone CPUä¿¡æ¯ : <a href="https://en.wikipedia.org/wiki/Apple-designed_processors" target="_blank" rel="noopener">Apple-designed_processors</a>)</p>
<h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p>iOS æ˜¯åŸºäº Apple Darwin å†…æ ¸ï¼Œç”± kernelã€XNU å’Œ Runtime ç»„æˆï¼ŒXNUï¼ˆX is not UNIXï¼‰ æ˜¯ Darwin çš„å†…æ ¸ï¼Œä¸€ä¸ªæ··åˆå†…æ ¸ï¼Œç”± Mach å¾®å†…æ ¸å’Œ BSD ç»„æˆã€‚Mach å†…æ ¸æ˜¯è½»é‡çº§çš„å¹³å°ï¼Œåªèƒ½å®Œæˆæ“ä½œç³»ç»Ÿæœ€åŸºæœ¬çš„èŒè´£ï¼Œå¦‚ï¼šè¿›ç¨‹å’Œçº¿ç¨‹ã€è™šæ‹Ÿå†…å­˜ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ã€è¿›ç¨‹é€šä¿¡å’Œæ¶ˆæ¯ä¼ é€’æœºåˆ¶ã€‚å…¶ä»–çš„å·¥ä½œï¼Œå¦‚æ–‡ä»¶æ“ä½œå’Œè®¾å¤‡è®¿é—®ï¼Œéƒ½æ˜¯ç”± BSD å±‚å®ç°ã€‚</p>
<p>äº‹å®ä¸Šï¼ŒMach å¹¶ä¸èƒ½è¯†åˆ« UNIX ä¸­çš„æ‰€æœ‰è¿›ç¨‹ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§ç¨å¾®ä¸åŒçš„æ–¹å¼ï¼Œä½¿ç”¨äº†æ¯”è¿›ç¨‹æ›´è½»é‡çº§çš„æ¦‚å¿µï¼šä»»åŠ¡ï¼ˆTaskï¼‰ã€‚ç»å…¸çš„ UNIX é‡‡ç”¨äº†è‡ªä¸Šè€Œä¸‹çš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å¯¹è±¡æ˜¯è¿›ç¨‹ï¼Œç„¶åè¿›ä¸€æ­¥åˆ’åˆ†ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼›Mach åˆ™é‡‡ç”¨äº†è‡ªåº•å‘ä¸Šçš„æ–¹å¼ï¼šæœ€åŸºæœ¬çš„å•å…ƒæ˜¯çº¿ç¨‹ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åŒ…å«åœ¨ä¸€ä¸ªä»»åŠ¡ä¸­ã€‚</p>
<ul>
<li>çº¿ç¨‹<ul>
<li>çº¿ç¨‹å®šä¹‰äº† Mach ä¸­æœ€å°çš„æ‰§è¡Œå•å…ƒã€‚çº¿ç¨‹è¡¨ç¤ºçš„æ˜¯åº•å±‚çš„æœºå™¨å¯„å­˜å™¨çŠ¶æ€ä»¥åŠå„ç§è°ƒåº¦ç»Ÿè®¡æ•°æ®ï¼Œå…¶ä»è®¾è®¡ä¸Šæä¾›äº†è°ƒåº¦æ‰€éœ€è¦çš„å¤§é‡ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>ä»»åŠ¡<ul>
<li>ä»»åŠ¡æ˜¯ä¸€ç§å®¹å™¨å¯¹è±¡ï¼Œè™šæ‹Ÿå†…å­˜ç©ºé—´å’Œå…¶ä»–èµ„æºéƒ½æ˜¯é€šè¿‡è¿™ä¸ªå®¹å™¨å¯¹è±¡ç®¡ç†çš„ã€‚è¿™äº›èµ„æºåŒ…æ‹¬è®¾å¤‡å’Œå…¶ä»–å¥æŸ„ã€‚èµ„æºè¿›ä¸€æ­¥è¢«æŠ½è±¡ä¸ºç«¯å£ã€‚å› æ­¤ï¼Œèµ„æºçš„å…±äº«å®é™…ä¸Šç›¸å½“äºå…è®¸å¯¹å¯¹åº”ç«¯å£è¿›è¡Œè®¿é—®ã€‚</li>
</ul>
</li>
</ul>
<a id="more"></a>
<p>ä¸¥æ ¼æ¥è¯´ï¼ŒMach çš„ä»»åŠ¡å¹¶ä¸æ˜¯hiæ“ä½œç³»ç»Ÿä¸­æ‰€è°“çš„è¿›ç¨‹ï¼Œå› ä¸º Mach ä½œä¸ºä¸€ä¸ªå¾®å†…æ ¸çš„æ“ä½œç³»ç»Ÿï¼Œå¹¶æ²¡æœ‰æä¾›â€œè¿›ç¨‹â€çš„é€»è¾‘ï¼Œè€Œåªæä¾›äº†æœ€åŸºæœ¬çš„å®ç°ã€‚åœ¨ BSD æ¨¡å‹ä¸­ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µæœ‰ä¸€å¯¹ä¸€çš„ç®€å•æ˜ å°„ï¼Œæ¯ä¸ª BSD è¿›ç¨‹ï¼ˆå³ OS X è¿›ç¨‹ï¼‰éƒ½åœ¨åº•å±‚å…³è”äº†ä¸€ä¸ª Mach ä»»åŠ¡å¯¹è±¡ã€‚å®ç°è¿™ç§æ˜ å°„çš„æ–¹æ³•æ˜¯æŒ‡å®šä¸€ä¸ªé€æ˜çš„æŒ‡é’ˆ bsd_infoï¼ŒMach å¯¹ bsd_info å®Œå…¨æ— çŸ¥ã€‚Mach å°†å†…æ ¸ä¹Ÿç”¨ä»»åŠ¡è¡¨ç¤ºï¼ˆå…¨å±€èŒƒå›´ç§°ä¸º kernel_taskï¼‰ï¼Œå°½ç®¡è¯¥ä»»åŠ¡æ²¡æœ‰å¯¹åº”çš„ PIDï¼Œä½†å¯ä»¥æƒ³è±¡ PID ä¸º 0ã€‚</p>
<p>ä¸‹å›¾æ‰€ç¤ºä¸ºæƒå¨è‘—ä½œã€ŠOS X Internal: A System Approachã€‹ä¸­æä¾›çš„ Mach OS X ä¸­è¿›ç¨‹å­ç³»ç»Ÿç»„æˆçš„æ¦‚å¿µå›¾ã€‚ä¸ Mac OS X ç±»ä¼¼ï¼ŒiOS çš„çº¿ç¨‹æŠ€æœ¯ä¹Ÿæ˜¯åŸºäº Mach çº¿ç¨‹æŠ€æœ¯å®ç°çš„ã€‚</p>
<p><img src="/res/apm/mach-task-thread-system.png" alt></p>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ä¸Šè¿°æåˆ°çº¿ç¨‹è¡¨ç¤ºçš„æ˜¯åº•å±‚çš„æœºå™¨å¯„å­˜å™¨çŠ¶æ€ä»¥åŠå„ç§ç»™è°ƒåº¦ç»Ÿè®¡æ•°æ®ã€‚å†æ¥çœ‹ Mach å±‚ä¸­çš„ thread_basic_info ç»“æ„ä½“çš„å®šä¹‰ï¼Œå…¶æˆå‘˜ä¿¡æ¯ä¹Ÿè¯å®äº†è¿™ä¸€ç‚¹ã€‚<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;      <span class="comment">// ç”¨æˆ·è¿è¡Œæ—¶é•¿</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;    <span class="comment">// ç³»ç»Ÿè¿è¡Œæ—¶é•¿</span></span><br><span class="line">        <span class="keyword">integer_t</span>       cpu_usage;      <span class="comment">// CPU ä½¿ç”¨ç‡</span></span><br><span class="line">        <span class="keyword">policy_t</span>        policy;         <span class="comment">// è°ƒåº¦ç­–ç•¥</span></span><br><span class="line">        <span class="keyword">integer_t</span>       run_state;      <span class="comment">// è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">integer_t</span>       flags;          <span class="comment">// å„ç§æ ‡è®°</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;  <span class="comment">// æš‚åœçº¿ç¨‹çš„è®¡æ•°</span></span><br><span class="line">        <span class="keyword">integer_t</span>       sleep_time;     <span class="comment">// ä¼‘çœ æ—¶é—´</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è¿™ä¸ªç»“æ„ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å®šæ—¶å»éå†æ¯ä¸ªçº¿ç¨‹ï¼Œç´¯åŠ æ¯ä¸ªçº¿ç¨‹çš„ cpu_usage å­—æ®µçš„å€¼ï¼Œå°±å¯ä»¥å¾—åˆ°å½“å‰ App æ‰€åœ¨è¿›ç¨‹çš„ CPU ä½¿ç”¨ç‡ã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºä¸º CPU å ç”¨ç‡ çš„ä»£ç å®ç°ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å– CPU ä½¿ç”¨ç‡</span></span><br><span class="line">+ (CGFloat)appCpuUsage &#123;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr;</span><br><span class="line">    <span class="keyword">task_info_data_t</span> tinfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> task_info_count;</span><br><span class="line">    </span><br><span class="line">    task_info_count = TASK_INFO_MAX;</span><br><span class="line">    kr = task_info(mach_task_self(), MACH_TASK_BASIC_INFO, (<span class="keyword">task_info_t</span>)tinfo, &amp;task_info_count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_array_t</span>         thread_list;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> thread_count;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_info_data_t</span>     thinfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> thread_info_count;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">thread_basic_info_t</span> basic_info_th;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// get threads in the task</span></span><br><span class="line">    kr = task_threads(mach_task_self(), &amp;thread_list, &amp;thread_count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">long</span> total_time     = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> total_userTime = <span class="number">0</span>;</span><br><span class="line">    CGFloat total_cpu   = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// for each thread</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; (<span class="keyword">int</span>)thread_count; j++) &#123;</span><br><span class="line">        thread_info_count = THREAD_INFO_MAX;</span><br><span class="line">        kr = thread_info(thread_list[j], THREAD_BASIC_INFO,</span><br><span class="line">                         (<span class="keyword">thread_info_t</span>)thinfo, &amp;thread_info_count);</span><br><span class="line">        <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        basic_info_th = (<span class="keyword">thread_basic_info_t</span>)thinfo;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!(basic_info_th-&gt;flags &amp; TH_FLAGS_IDLE)) &#123;</span><br><span class="line">            total_time     = total_time + basic_info_th-&gt;user_time.seconds + basic_info_th-&gt;system_time.seconds;</span><br><span class="line">            total_userTime = total_userTime + basic_info_th-&gt;user_time.microseconds + basic_info_th-&gt;system_time.microseconds;</span><br><span class="line">            total_cpu      = total_cpu + basic_info_th-&gt;cpu_usage / (<span class="keyword">float</span>)TH_USAGE_SCALE * kMaxPercent;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    kr = vm_deallocate(mach_task_self(), (<span class="keyword">vm_offset_t</span>)thread_list, thread_count * <span class="keyword">sizeof</span>(<span class="keyword">thread_t</span>));</span><br><span class="line">    assert(kr == KERN_SUCCESS);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> total_cpu;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä»£ç ä¸­ä½¿ç”¨ task_threads API è°ƒç”¨è·å–æŒ‡å®šçš„ task çš„çº¿ç¨‹åˆ—è¡¨ã€‚task_threads å°† target_task ä»»åŠ¡ä¸­çš„æ‰€æœ‰çº¿ç¨‹ä¿å­˜åœ¨ act_list æ•°ç»„ä¸­ï¼Œæ•°ç»„åŒ…å« act_listCnt ä¸ªæ¡ç›®ã€‚ä¸Šè¿°æºç ä¸­ï¼Œåœ¨è°ƒç”¨ task_threads API æ—¶ï¼Œtarget_task å‚æ•°ä¼ å…¥çš„æ˜¯ mach_task_self()ï¼Œè¡¨ç¤ºè·å–å½“å‰çš„ Mach taskã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span> task_threads</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">task_t</span> target_task,</span><br><span class="line">	<span class="keyword">thread_act_array_t</span> *act_list,</span><br><span class="line">	<span class="keyword">mach_msg_type_number_t</span> *act_listCnt</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>åœ¨è·å–åˆ°çº¿ç¨‹åˆ—è¡¨åï¼Œä»£ç ä¸­ä½¿ç”¨ thread_info API è°ƒç”¨è·å–æŒ‡å®šçº¿ç¨‹çš„çº¿ç¨‹ä¿¡æ¯ã€‚thread_info æŸ¥è¯¢ flavor æŒ‡å®šçš„çº¿ç¨‹ä¿¡æ¯ï¼Œå°†ä¿¡æ¯è¿”å›åˆ°é•¿åº¦ä¸º thread_info_outCnt å­—èŠ‚çš„ thread_info_out ç¼“å­˜åŒºä¸­ã€‚ä¸Šè¿°æºç ï¼Œåœ¨è°ƒç”¨ thread_info API æ—¶ï¼Œflavor å‚æ•°ä¼ å…¥çš„æ˜¯ THREAD_BASIC_INFOï¼Œä½¿ç”¨è¿™ä¸ªç±»å‹ä¼šè¿”å›çº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼Œå³ thread_basic_info_t ç»“æ„ä½“ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span> thread_info</span><br><span class="line">(</span><br><span class="line">	<span class="keyword">thread_act_t</span> target_act,</span><br><span class="line">	<span class="keyword">thread_flavor_t</span> flavor,</span><br><span class="line">	<span class="keyword">thread_info_t</span> thread_info_out,</span><br><span class="line">	<span class="keyword">mach_msg_type_number_t</span> *thread_info_outCnt</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>ä¸Šè¿°æºç çš„æœ€åï¼Œä½¿ç”¨ vm_deallocate API ä»¥é˜²æ­¢å‡ºç°å†…å­˜æ³„éœ²ã€‚</p>
<h3 id="æ€»çš„-CPU-å ç”¨ç‡"><a href="#æ€»çš„-CPU-å ç”¨ç‡" class="headerlink" title="æ€»çš„ CPU å ç”¨ç‡"></a>æ€»çš„ CPU å ç”¨ç‡</h3><p>ä½¿ç”¨ <code>host_statistics</code> å‡½æ•°æ‹¿åˆ° host_cpu_load_info çš„å€¼ï¼Œè¿™ä¸ªç»“æ„ä½“çš„æˆå‘˜å˜é‡ cpu_ticks åŒ…å«äº† CPU è¿è¡Œçš„æ—¶é’Ÿè„‰å†²çš„æ•°é‡ï¼Œcpu_ticks æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé‡Œé¢åˆ†åˆ«åŒ…å«äº† CPU_STATE_USER, CPU_STATE_SYSTEM, CPU_STATE_IDLE å’Œ CPU_STATE_NICE æ¨¡å¼ä¸‹çš„æ—¶é’Ÿè„‰å†²ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (CGFloat)cpuUsage &#123;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kr;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">host_cpu_load_info_data_t</span> previous_info = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">host_cpu_load_info_data_t</span> info;</span><br><span class="line">    </span><br><span class="line">    count = HOST_CPU_LOAD_INFO_COUNT;</span><br><span class="line">    </span><br><span class="line">    kr = host_statistics(mach_host_self(), HOST_CPU_LOAD_INFO, (<span class="keyword">host_info_t</span>)&amp;info, &amp;count);</span><br><span class="line">    <span class="keyword">if</span> (kr != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">natural_t</span> user   = info.cpu_ticks[CPU_STATE_USER] - previous_info.cpu_ticks[CPU_STATE_USER];</span><br><span class="line">    <span class="keyword">natural_t</span> nice   = info.cpu_ticks[CPU_STATE_NICE] - previous_info.cpu_ticks[CPU_STATE_NICE];</span><br><span class="line">    <span class="keyword">natural_t</span> system = info.cpu_ticks[CPU_STATE_SYSTEM] - previous_info.cpu_ticks[CPU_STATE_SYSTEM];</span><br><span class="line">    <span class="keyword">natural_t</span> idle   = info.cpu_ticks[CPU_STATE_IDLE] - previous_info.cpu_ticks[CPU_STATE_IDLE];</span><br><span class="line">    <span class="keyword">natural_t</span> total  = user + nice + system + idle;</span><br><span class="line">    previous_info    = info;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (user + nice + system) * <span class="number">100.0</span> / total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»£ç é€šè¿‡è®¡ç®— info å’Œ previous_info çš„å·®å€¼ï¼Œåˆ†åˆ«å¾—åˆ°åœ¨è¿™å‡ ä¸ªæ¨¡å¼ä¸‹çš„ cpu_ticksï¼Œé™¤ idle ä»¥å¤–éƒ½å±äº CPU è¢«å ç”¨çš„æƒ…å†µï¼Œæœ€åå°±èƒ½æ±‚å‡º CPU çš„å ç”¨ç‡ã€‚</p>
<h3 id="CPU-æ ¸æ•°"><a href="#CPU-æ ¸æ•°" class="headerlink" title="CPU æ ¸æ•°"></a>CPU æ ¸æ•°</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (NSUInteger)cpuNumber &#123;</span><br><span class="line">    <span class="keyword">return</span> [NSProcessInfo processInfo].activeProcessorCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CPU-é¢‘ç‡"><a href="#CPU-é¢‘ç‡" class="headerlink" title="CPU é¢‘ç‡"></a>CPU é¢‘ç‡</h3><p>CPU é¢‘ç‡ï¼Œå°±æ˜¯ CPU çš„æ—¶é’Ÿé¢‘ç‡ï¼Œ æ˜¯ CPU è¿ç®—æ—¶çš„å·¥ä½œçš„é¢‘ç‡ï¼ˆ1ç§’å†…å‘ç”Ÿçš„åŒæ­¥è„‰å†²æ•°ï¼‰çš„ç®€ç§°ã€‚å•ä½æ˜¯ Hzï¼Œå®ƒå†³å®šç§»åŠ¨è®¾å¤‡çš„è¿è¡Œé€Ÿåº¦ã€‚</p>
<p>ç”±äºå®‰å…¨æ€§è€ƒè™‘ï¼Œè‹¹æœå·²ç»ç¦æ­¢è®¿é—®å†…æ ¸å˜é‡æ¥è·å– CPU é¢‘ç‡ã€‚ç°å®ç°æ–¹æ³•æ˜¯é€šè¿‡ç¡¬ç¼–ç æ–¹å¼è·å– CPU é¢‘ç‡ï¼Œæ–°æœºå‘å¸ƒéœ€æ›´æ–°ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼ï¼Œå»ºç«‹ä¸€å¼ æœºå‹å’Œ CPU ä¸»é¢‘çš„æ˜ å°„è¡¨ï¼Œç„¶åæ ¹æ®æœºå‹æ‰¾åˆ°å¯¹åº”çš„ CPU ä¸»é¢‘å³å¯ã€‚</p>
<p>å¯ä»¥åœ¨å…¶ä¸­æ‰¾åˆ°å¯¹åº”æœºå‹cpuçš„å¯¹åº” : <a href="https://en.wikipedia.org/wiki/Apple-designed_processors" target="_blank" rel="noopener">Apple-designed_processors</a></p>
<h3 id="CPU-ç±»å‹"><a href="#CPU-ç±»å‹" class="headerlink" title="CPU ç±»å‹"></a>CPU ç±»å‹</h3><p>æˆ‘ä»¬çŸ¥é“ iPhone ä½¿ç”¨çš„å¤„ç†å™¨æ¶æ„éƒ½æ˜¯ ARM çš„ï¼Œè€Œ ARM åˆåˆ†ä¸º ARMV7ã€ARMV7S å’Œ ARM64ç­‰ã€‚è€Œæƒ³è¦è·å–è®¾å¤‡å…·ä½“çš„å¤„ç†å™¨æ¶æ„åˆ™éœ€è¦ä½¿ç”¨ NXGetLocalArchInfo() å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ NXArchInfo ç»“æ„ä½“ç±»å‹ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">cpu_type_t</span> cputype;</span><br><span class="line">    <span class="keyword">cpu_subtype_t</span> cpusubtype;</span><br><span class="line">    <span class="keyword">enum</span> NXByteOrder byteorder;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *description;</span><br><span class="line">&#125; NXArchInfo;</span><br></pre></td></tr></table></figure>
<p>NXArchInfo ç»“æ„ä½“æˆå‘˜å˜é‡ä¸­å°±åŒ…å«æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯ï¼šcputype å’Œ cpusubtypeï¼Œè¿™ä¸¤ä¸ªå˜é‡ç±»å‹çš„å®šä¹‰åœ¨ mach/machine.h å¤´æ–‡ä»¶ä¸­ç»™å‡ºï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ int ç±»å‹ typedef å¾—åˆ°çš„ã€‚</p>
<p>æ ¹æ® mach/machine.h å¤´æ–‡ä»¶ç»™å‡ºçš„ CPU æ¶æ„ç±»å‹çš„å®šä¹‰ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å»ºç«‹èµ·å„ CPU æ¶æ„åˆ°å…¶å¯¹åº”æè¿°çš„æ˜ å°„å…³ç³»ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (NSInteger)cpuType &#123;</span><br><span class="line">    <span class="keyword">return</span> (NSInteger)NXGetLocalArchInfo()-&gt;cputype;</span><br><span class="line">&#125;</span><br><span class="line">+ (NSInteger)cpuSubtype &#123;</span><br><span class="line">    <span class="keyword">return</span> (NSInteger)NXGetLocalArchInfo()-&gt;cpusubtype;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)p_stringFromCpuType:(NSInteger)cpuType &#123;</span><br><span class="line">    <span class="keyword">switch</span> (cpuType) &#123;</span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_VAX:          <span class="keyword">return</span> @<span class="string">"VAX"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC680x0:      <span class="keyword">return</span> @<span class="string">"MC680x0"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_X86:          <span class="keyword">return</span> @<span class="string">"X86"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_X86_64:       <span class="keyword">return</span> @<span class="string">"X86_64"</span>;       </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC98000:      <span class="keyword">return</span> @<span class="string">"MC98000"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_HPPA:         <span class="keyword">return</span> @<span class="string">"HPPA"</span>;         </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_ARM:          <span class="keyword">return</span> @<span class="string">"ARM"</span>;          </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_ARM64:        <span class="keyword">return</span> @<span class="string">"ARM64"</span>;        </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_MC88000:      <span class="keyword">return</span> @<span class="string">"MC88000"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_SPARC:        <span class="keyword">return</span> @<span class="string">"SPARC"</span>;        </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_I860:         <span class="keyword">return</span> @<span class="string">"I860"</span>;         </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_POWERPC:      <span class="keyword">return</span> @<span class="string">"POWERPC"</span>;      </span><br><span class="line">        <span class="keyword">case</span> CPU_TYPE_POWERPC64:    <span class="keyword">return</span> @<span class="string">"POWERPC64"</span>;    </span><br><span class="line">        <span class="keyword">default</span>:                    <span class="keyword">return</span> @<span class="string">"Unknown"</span>;      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)cpuTypeString &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_cpuTypeString) &#123;</span><br><span class="line">        _cpuTypeString = [self p_stringFromCpuType:[[self class] cpuType]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _cpuTypeString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)cpuSubtypeString &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_cpuSubtypeString) &#123;</span><br><span class="line">        _cpuSubtypeString = [NSString stringWithUTF8String:NXGetLocalArchInfo()-&gt;description];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> _cpuSubtypeString;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç»æµ‹è¯•å‘ç° NXArchInfo ç»“æ„ä½“æˆå‘˜å˜é‡ description åŒ…å«çš„å°±æ˜¯ CPU æ¶æ„çš„è¯¦å°½ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥ç”¨å®ƒä½œä¸º cpuSubtypeStringï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å»ºç«‹ cpuSubtype çš„æ˜ å°„å…³ç³»ã€‚</p>
]]></content>
      <categories>
        <category>APM</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>AFNetworking3æºç é˜…è¯»-NSURLSession</title>
    <url>/essay/AFNetworking/AFNetworking3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-NSURLSession/</url>
    <content><![CDATA[<blockquote>
<p>AFURLSessionManager å’Œ AFHTTPSessionManager æ˜¯AFNetworkingçš„æ ¸å¿ƒç±»<br>è¿™é‡Œå…ˆé˜…è¯»AFURLSessionManagerã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨-AFURLSessionManager-åˆ›å»ºä¸‹è½½ä»»åŠ¡"><a href="#ä½¿ç”¨-AFURLSessionManager-åˆ›å»ºä¸‹è½½ä»»åŠ¡" class="headerlink" title="ä½¿ç”¨ AFURLSessionManager åˆ›å»ºä¸‹è½½ä»»åŠ¡"></a>ä½¿ç”¨ AFURLSessionManager åˆ›å»ºä¸‹è½½ä»»åŠ¡</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">AFURLSessionManager *manager = [[AFURLSessionManager alloc] initWithSessionConfiguration:configuration];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://example.com/download.zip"</span>];</span><br><span class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:URL];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = [manager downloadTaskWithRequest:request progress:<span class="literal">nil</span> destination:^<span class="built_in">NSURL</span> *(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response) &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *documentsDirectoryURL = [[<span class="built_in">NSFileManager</span> defaultManager] URLForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomain:<span class="built_in">NSUserDomainMask</span> appropriateForURL:<span class="literal">nil</span> create:<span class="literal">NO</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="keyword">return</span> [documentsDirectoryURL URLByAppendingPathComponent:[response suggestedFilename]];</span><br><span class="line">&#125; completionHandler:^(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"File downloaded to: %@"</span>, filePath);</span><br><span class="line">&#125;];</span><br><span class="line">[downloadTask resume];</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="AFURLSessionManager-åˆå§‹åŒ–"><a href="#AFURLSessionManager-åˆå§‹åŒ–" class="headerlink" title="AFURLSessionManager åˆå§‹åŒ–"></a>AFURLSessionManager åˆå§‹åŒ–</h2><blockquote>
<p><code>initWithSessionConfiguration:</code> åˆ›å»ºå’Œç®¡ç† NSURLSession</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration&#123;</span><br><span class="line">	<span class="number">1.</span> åˆå§‹åŒ–ç›¸åº”çš„å±æ€§</span><br><span class="line">	<span class="number">2.</span> ä¸ºtaskè®¾ç½®ä»£ç†</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.</strong> åˆå§‹åŒ–ç›¸åº”çš„å±æ€§</p>
<ul>
<li>åˆå§‹åŒ–<strong>ä¼šè¯é…ç½®</strong>(NSURLSessionConfiguration),é»˜è®¤ä¸º<code>defaultSessionConfiguration</code></li>
<li>åˆå§‹åŒ–<strong>ä¼šè¯</strong>(NSURLSession),è®¾ç½®ä¼šè¯çš„é…ç½®ï¼Œä»£ç†ä»¥åŠé˜Ÿåˆ—</li>
<li>åˆå§‹åŒ–<strong>å“åº”åºåˆ—åŒ–</strong>(AFJSONResponseSerializer),<strong>å®‰å…¨è®¤è¯</strong>(AFSecurityPolicy),<strong>ç½‘ç»œçŠ¶æ€ç›‘æ§</strong>(AFNetworkReachabilityManager)</li>
<li>åˆå§‹åŒ–ä¿å­˜ data task çš„å­—å…¸ï¼ˆmutableTaskDelegatesKeyedByTaskIdentifierï¼‰</li>
</ul>
<p><strong>2.</strong> ä¸ºtaskè®¾ç½®ä»£ç†</p>
<p>ä½¿ç”¨<code>getTasksWithCompletionHandler</code>ä»sessionä¸­å–å‡ºtaskï¼Œå¹¶ä¸ºtaskè®¾ç½®ä»£ç†ã€‚</p>
<h2 id="ç®¡ç†NSURLSessionTask"><a href="#ç®¡ç†NSURLSessionTask" class="headerlink" title="ç®¡ç†NSURLSessionTask"></a>ç®¡ç†NSURLSessionTask</h2><blockquote>
<p>AFURLSessionManageråˆå§‹åŒ–åï¼Œå°±å¯ä»¥è·å–NSURLSessionTaskå¯¹è±¡</p>
</blockquote>
<p>AFNetworking3 ä¸­æœ‰7ä¸ªæ–¹æ³•åˆ†åˆ«è¿”å›<code>NSURLSessionDataTask</code>,<code>NSURLSessionUploadTask</code>,<code>NSURLSessionDownloadTask</code>ã€‚è¿™é‡Œä»ä»¥ä¸‹æ–¹æ³•æ¥çœ‹æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                         fromData:(<span class="built_in">NSData</span> *)bodyData</span><br><span class="line">                                         progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                                completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionUploadTask</span> *uploadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        uploadTask = [<span class="keyword">self</span>.session uploadTaskWithRequest:request fromData:bodyData];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:uploadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>url_session_manager_create_task_safely</code>æ˜¯è§£å†³iOS8ä¹‹å‰çš„ä¸€ä¸ªbug ï¼Œè¯¦æƒ…å¯ä»¥çœ‹ <a href="https://github.com/AFNetworking/AFNetworking/issues/2093" target="_blank" rel="noopener">Issue 2093</a></p>
<ul>
<li>é€šè¿‡ä¼ å…¥çš„<em>NSURLRequest</em>ç”Ÿæˆ<strong>NSURLSessionUploadTask</strong>å¯¹è±¡</li>
<li>è°ƒç”¨è‡ªå®šä¹‰æ–¹æ³• <code>addDelegateForUploadTask...</code>æ¥ä¸ºtaskæ·»åŠ å›è°ƒäº‹ä»¶</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:dataTask];</span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line"></span><br><span class="line">    dataTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:dataTask];</span><br><span class="line"></span><br><span class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</span><br><span class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ <strong>AFURLSessionManagerTaskDelegate</strong> ç±»å®ç°äº† <code>NSURLSessionTaskDelegate, NSURLSessionDataDelegate, NSURLSessionDownloadDelegate</code>ä»£ç†ã€‚</li>
<li>ä½¿ç”¨ <code>setDelegate</code>æ¥è®¾ç½®ä»£ç†</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</span><br><span class="line">            forTask:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#æ£€æŸ¥å‚æ•°</span></span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</span><br><span class="line">    [<span class="keyword">self</span> addNotificationObserverForTask:task];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AFURLSessionManager å°±æ˜¯é€šè¿‡å­—å…¸ <strong>mutableTaskDelegatesKeyedByTaskIdentifier</strong> æ¥å­˜å‚¨å¹¶ç®¡ç†æ¯ä¸€ä¸ª NSURLSessionTaskï¼Œå®ƒä»¥ taskIdentifier ä¸ºé”®å­˜å‚¨ taskã€‚<br>è¯¥æ–¹æ³•ä½¿ç”¨ <strong>NSLock</strong> æ¥ä¿è¯ä¸åŒçº¿ç¨‹ä½¿ç”¨ mutableTaskDelegatesKeyedByTaskIdentifier æ—¶ï¼Œä¸ä¼šå‡ºç°<strong>çº¿ç¨‹ç«äº‰</strong>çš„é—®é¢˜ã€‚</p>
<h2 id="å®ç°-NSURLSessionDelegate"><a href="#å®ç°-NSURLSessionDelegate" class="headerlink" title="å®ç° NSURLSessionDelegate"></a>å®ç° NSURLSessionDelegate</h2><blockquote>
<p>AFURLSessionManageråˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨ initWithSessionConfigurationï¼Œå°† NSURLSession çš„ä»£ç†è®¾ç½®ä¸ºself</p>
</blockquote>
<p>AFURLSessionManagerå®ç°äº†è¿™äº›åè®®ï¼š</p>
<ul>
<li>NSURLSessionDelegate</li>
<li>NSURLSessionTaskDelegate</li>
<li>NSURLSessionDataDelegate</li>
<li>NSURLSessionDownloadDelegate</li>
</ul>
<p>æ‰€æœ‰çš„delegate å®ç°æ–¹æ³•éƒ½æä¾›å¯¹åº”çš„blockæ¥å£,æ¯”å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSURLSessionDelegate</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didBecomeInvalidWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidBecomeInvalid) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sessionDidBecomeInvalid(session, error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDidInvalidateNotification object:session];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹åº”çš„blockæ¥å£æ˜¯ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setSessionDidBecomeInvalidBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSError</span> *error))block;</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨-AFURLSessionManagerTaskDelegate-ç®¡ç†è¿›åº¦"><a href="#ä½¿ç”¨-AFURLSessionManagerTaskDelegate-ç®¡ç†è¿›åº¦" class="headerlink" title="ä½¿ç”¨ AFURLSessionManagerTaskDelegate ç®¡ç†è¿›åº¦"></a>ä½¿ç”¨ AFURLSessionManagerTaskDelegate ç®¡ç†è¿›åº¦</h2><blockquote>
<p>ä¸Šæ–‡çš„AFURLSessionManagerTaskDelegateå®ç°äº† <code>NSURLSessionTaskDelegate, NSURLSessionDataDelegate, NSURLSessionDownloadDelegate</code>ä»£ç†ã€‚<br>å®ƒä¸»è¦ä¸º task æä¾›è¿›åº¦ç®¡ç†åŠŸèƒ½ï¼Œå¹¶åœ¨ task ç»“æŸæ—¶å›è°ƒï¼Œè¿™é‡Œå¼€å§‹æŸ¥çœ‹å¦‚ä½•å®ç°çš„ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)initWithTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="number">1.</span> è®¾ç½®ä¸Šä¼ æˆ–è€…ä¸‹è½½ä»»åŠ¡çŠ¶æ€æ”¹å˜çš„æ˜¯å›è°ƒ</span><br><span class="line">    <span class="number">2.</span> KVO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.</strong> è®¾ç½®ä¸Šä¼ æˆ–è€…ä¸‹è½½ä»»åŠ¡çŠ¶æ€æ”¹å˜çš„æ˜¯å›è°ƒ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">progress.totalUnitCount = <span class="built_in">NSURLSessionTransferSizeUnknown</span>;</span><br><span class="line">    progress.cancellable = <span class="literal">YES</span>;</span><br><span class="line">    progress.cancellationHandler = ^&#123;</span><br><span class="line">        [weakTask cancel];</span><br><span class="line">    &#125;;</span><br><span class="line">    progress.pausable = <span class="literal">YES</span>;</span><br><span class="line">    progress.pausingHandler = ^&#123;</span><br><span class="line">        [weakTask suspend];</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ([progress respondsToSelector:<span class="keyword">@selector</span>(setResumingHandler:)]) &#123;</span><br><span class="line">        progress.resumingHandler = ^&#123;</span><br><span class="line">            [weakTask resume];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å¯¹åº”çš„<strong>NSProgress</strong>çŠ¶æ€æ”¹å˜æ—¶ï¼Œè°ƒç”¨ <code>resume</code> <code>suspend</code>ç­‰æ–¹æ³•æ”¹å˜ task çš„çŠ¶æ€</p>
<p><strong>2.</strong> KVO</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[progress addObserver:<span class="keyword">self</span></span><br><span class="line">                   forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))</span><br><span class="line">                      options:<span class="built_in">NSKeyValueObservingOptionNew</span></span><br><span class="line">                      context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">   <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.downloadProgress]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.downloadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.uploadProgress]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.uploadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.uploadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹progressè¿›è¡Œé”®å€¼è§‚å¯Ÿï¼Œå¯¹è±¡çš„æŸäº›å±æ€§æ”¹å˜æ—¶æ›´æ–° NSProgress å¯¹è±¡æˆ–ä½¿ç”¨ block ä¼ é€’ NSProgress å¯¹è±¡ <code>self.uploadProgressBlock(object)</code>æˆ–è€… <code>self.downloadProgressBlock(object);</code>ã€‚å…¶ä¸­fractionCompletedè¡¨ç¤º NSProgressçš„<strong>è¿›åº¦</strong>ã€‚</p>
<h3 id="ä»£ç†æ–¹æ³•-URLSession-task-didCompleteWithError"><a href="#ä»£ç†æ–¹æ³•-URLSession-task-didCompleteWithError" class="headerlink" title="ä»£ç†æ–¹æ³• URLSession:task:didCompleteWithError:"></a>ä»£ç†æ–¹æ³• <code>URLSession:task:didCompleteWithError:</code></h3><blockquote>
<p>å½“taskå®Œæˆæ•°æ®ä¼ è¾“æ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•,æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åœ¨ AFURLSessionManagerTaskDelegateä¸­çš„å®ç°</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">1.</span> å–å‡ºæ•°æ®ã€‚å‚¨å­˜responseSerializer downloadFileURL</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(error)&#123;</span><br><span class="line">    	<span class="number">2.</span> æœ‰é”™è¯¯æ—¶è°ƒç”¨completionHandler</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">    	<span class="number">3.</span> æ— é”™è¯¯æ—¶è°ƒç”¨completionHandler</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.</strong> å–å‡ºæ•°æ®ã€‚å‚¨å­˜responseSerializer downloadFileURL</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__<span class="keyword">strong</span> AFURLSessionManager *manager = <span class="keyword">self</span>.manager;</span><br><span class="line"></span><br><span class="line">    __block <span class="keyword">id</span> responseObject = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Performance Improvement from #2672</span></span><br><span class="line">    <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.mutableData) &#123;</span><br><span class="line">        data = [<span class="keyword">self</span>.mutableData <span class="keyword">copy</span>];</span><br><span class="line">        <span class="comment">//We no longer need the reference, so nil it out to gain back some memory.</span></span><br><span class="line">        <span class="keyword">self</span>.mutableData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™éƒ¨åˆ†ä»£ç ä» mutableData ä¸­å–å‡ºäº†æ•°æ®ï¼Œè®¾ç½®äº† userInfoã€‚å…¶ä¸­ <code>self. mutableData</code>æ˜¯ä»<br><code>URLSession:dataTask:didReceiveData</code>ä»£ç†æ–¹æ³•ä¸­è·å–çš„ã€‚userInfo ç”¨æ¥åšé€šçŸ¥æ—¶ä¼ é€çš„æ•°æ®</p>
<p><strong>2. 3.è°ƒç”¨completionHandler</strong></p>
<p>è¯¥ä»£ç†æ–¹æ³•ä¸­çš„errorä»…æŒ‡æœ¬åœ°ç«¯çš„é”™è¯¯ï¼Œæ¯”å¦‚æ— æ³•è§£æåŸŸåæˆ–è€…ä¸èƒ½è¿ä¸Šhostç­‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                <span class="keyword">self</span>.completionHandler(task.response, responseObject, error);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå½“å‰ manager æŒæœ‰ completionGroup æˆ–è€… completionQueue å°±ä½¿ç”¨å®ƒä»¬ã€‚å¦åˆ™ä¼šåˆ›å»ºä¸€ä¸ª dispatch_group_t å¹¶åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ completionHandler å¹¶å‘é€é€šçŸ¥(åœ¨ä¸»çº¿ç¨‹ä¸­)ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">                responseObject = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (responseObject) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰errorï¼Œå…ˆå¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œç„¶ååŒæ ·è°ƒç”¨ block å¹¶å‘é€é€šçŸ¥ã€‚</p>
<h2 id="AFURLSessionTaskSwizzling"><a href="#AFURLSessionTaskSwizzling" class="headerlink" title="_AFURLSessionTaskSwizzling"></a>_AFURLSessionTaskSwizzling</h2><blockquote>
<p>å› ä¸º iOS7 å’Œ iOS8 ä¸Šå¯¹äº NSURLSessionTask çš„å®ç°ä¸åŒ,AFURLSessionTaskSwizzling çš„å°±æ˜¯ä¿®æ”¹ NSURLSessionTask çš„ resume å’Œ suspend æ–¹æ³•</p>
</blockquote>
<p>ä½¿ç”¨+load æ›¿æ¢æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+(<span class="keyword">void</span>)load&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">NSClassFromString</span>(<span class="string">@"NSURLSessionTask"</span>)) &#123;</span><br><span class="line">	        <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> ephemeralSessionConfiguration];</span><br><span class="line">        <span class="built_in">NSURLSession</span> * session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration];</span><br><span class="line"><span class="meta">#pragma GCC diagnostic push</span></span><br><span class="line"><span class="meta">#pragma GCC diagnostic ignored <span class="meta-string">"-Wnonnull"</span></span></span><br><span class="line">        <span class="built_in">NSURLSessionDataTask</span> *localDataTask = [session dataTaskWithURL:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line">        IMP originalAFResumeIMP = method_getImplementation(class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(af_resume)));</span><br><span class="line">        Class currentClass = [localDataTask <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume))) &#123;</span><br><span class="line">            Class superClass = [currentClass superclass];</span><br><span class="line">            IMP classResumeIMP = method_getImplementation(class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            IMP superclassResumeIMP = method_getImplementation(class_getInstanceMethod(superClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            <span class="keyword">if</span> (classResumeIMP != superclassResumeIMP &amp;&amp;</span><br><span class="line">                originalAFResumeIMP != classResumeIMP) &#123;</span><br><span class="line">                [<span class="keyword">self</span> swizzleResumeAndSuspendMethodForClass:currentClass];</span><br><span class="line">            &#125;</span><br><span class="line">            currentClass = [currentClass superclass];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [localDataTask cancel];</span><br><span class="line">        [session finishTasksAndInvalidate];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>é¦–å…ˆç”¨ NSClassFromString(@â€NSURLSessionTaskâ€) åˆ¤æ–­å½“å‰éƒ¨ç½²çš„ iOS ç‰ˆæœ¬æ˜¯å¦å«æœ‰ç±» NSURLSessionTask</li>
<li>å› ä¸º iOS7 å’Œ iOS8 ä¸Šå¯¹äº NSURLSessionTask çš„å®ç°ä¸åŒï¼Œæ‰€ä»¥ä¼šé€šè¿‡ - [NSURLSession dataTaskWithURL:] æ–¹æ³•è¿”å›ä¸€ä¸ª NSURLSessionTask å®ä¾‹</li>
<li>å–å¾—å½“å‰ç±» _AFURLSessionTaskSwizzling ä¸­çš„å®ç° af_resume</li>
<li>å¦‚æœå½“å‰ç±» currentClass æœ‰ resume æ–¹æ³•<ul>
<li>çœŸï¼š5</li>
<li>å‡ï¼š6</li>
</ul>
</li>
<li>ä½¿ç”¨ swizzleResumeAndSuspendMethodForClass: è°ƒå‰‚è¯¥ç±»çš„ resume å’Œ suspend æ–¹æ³•</li>
<li>currentClass = [currentClass superclass]</li>
</ol>
<h2 id="ä½¿ç”¨-AFSecurityPolicy-ä¿è¯è¯·æ±‚çš„å®‰å…¨"><a href="#ä½¿ç”¨-AFSecurityPolicy-ä¿è¯è¯·æ±‚çš„å®‰å…¨" class="headerlink" title="ä½¿ç”¨ AFSecurityPolicy ä¿è¯è¯·æ±‚çš„å®‰å…¨"></a>ä½¿ç”¨ AFSecurityPolicy ä¿è¯è¯·æ±‚çš„å®‰å…¨</h2><p><strong>AFSecurityPolicy</strong> å…·ä½“å‚è€ƒ <a href="../AFNetworking3æºç é˜…è¯»-Security/">AFNetworking3æºç é˜…è¯»-Security</a></p>
<p>åœ¨ä»£ç†æ–¹æ³• <code>URLSession:didReceiveChallenge:completionHandler</code>ä¸­è°ƒç”¨</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AFNetworking</category>
      </categories>
      <tags>
        <tag>AFNetworking</tag>
      </tags>
  </entry>
  <entry>
    <title>AFNetworking3æºç é˜…è¯»-Security</title>
    <url>/essay/AFNetworking/AFNetworking3%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-Security/</url>
    <content><![CDATA[<blockquote>
<p>AFNetworking3æºç é˜…è¯»-Security<br>è‡ª iOS9 å‘å¸ƒä¹‹åï¼Œç”±äºæ–°ç‰¹æ€§ App Transport Security çš„å¼•å…¥ï¼Œåœ¨é»˜è®¤è¡Œä¸ºä¸‹æ˜¯ä¸èƒ½å‘é€ HTTP è¯·æ±‚çš„ã€‚å¾ˆå¤šç½‘ç«™éƒ½åœ¨è½¬ç”¨ HTTPSï¼Œè€Œ AFNetworking ä¸­çš„ AFSecurityPolicy å°±æ˜¯ä¸ºäº†é˜»æ­¢ä¸­é—´äººæ”»å‡»ï¼Œä»¥åŠå…¶å®ƒæ¼æ´çš„å·¥å…·ã€‚<br>AFSecurityPolicy ä¸»è¦ä½œç”¨å°±æ˜¯éªŒè¯ HTTPS è¯·æ±‚çš„è¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœ app ä¸­æœ‰ä¸€äº›æ•æ„Ÿä¿¡æ¯æˆ–è€…æ¶‰åŠäº¤æ˜“ä¿¡æ¯ï¼Œä¸€å®šè¦ä½¿ç”¨ HTTPS æ¥ä¿è¯äº¤æ˜“æˆ–è€…ç”¨æˆ·ä¿¡æ¯çš„å®‰å…¨ã€‚</p>
</blockquote>
<h2 id="https-amp-SSL-Pinning"><a href="#https-amp-SSL-Pinning" class="headerlink" title="https &amp; SSL Pinning"></a>https &amp; SSL Pinning</h2><h3 id="https"><a href="#https" class="headerlink" title="https"></a>https</h3><p>HTTPSå…¶å®æ˜¯æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼šHTTP + SSL / TLSï¼Œä¹Ÿå°±æ˜¯åœ¨HTTPä¸ŠåˆåŠ äº†ä¸€å±‚å¤„ç†åŠ å¯†ä¿¡æ¯çš„æ¨¡å—ã€‚æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä¿¡æ¯ä¼ è¾“éƒ½ä¼šé€šè¿‡TLSè¿›è¡ŒåŠ å¯†</p>
<p><img src="/res/AFNetworking/AFNetworking3æºç é˜…è¯»-Security-https.png" width="50%"></p>
<h3 id="SSL-Pinning"><a href="#SSL-Pinning" class="headerlink" title="SSL Pinning"></a>SSL Pinning</h3><p>å¯ ä»¥ç†è§£ä¸ºè¯ä¹¦ç»‘å®šï¼Œæ˜¯æŒ‡å®¢æˆ·ç«¯ç›´æ¥ä¿å­˜æœåŠ¡ç«¯çš„è¯ä¹¦ï¼Œå»ºç«‹httpsè¿æ¥æ—¶ç›´æ¥å¯¹æ¯”æœåŠ¡ç«¯è¿”å›çš„å’Œå®¢æˆ·ç«¯ä¿å­˜çš„ä¸¤ä¸ªè¯ä¹¦æ˜¯å¦ä¸€æ ·ï¼Œä¸€æ ·å°±è¡¨æ˜è¯ä¹¦ æ˜¯çœŸçš„ï¼Œä¸å†å»ç³»ç»Ÿçš„ä¿¡ä»»è¯ä¹¦æœºæ„é‡Œå¯»æ‰¾éªŒè¯ã€‚è¿™é€‚ç”¨äºéæµè§ˆå™¨åº”ç”¨ï¼Œå› ä¸ºæµè§ˆå™¨è·Ÿå¾ˆå¤šæœªçŸ¥æœåŠ¡ç«¯æ‰“äº¤é“ï¼Œæ— æ³•æŠŠæ¯ä¸ªæœåŠ¡ç«¯çš„è¯ä¹¦éƒ½ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†CSæ¶æ„çš„åƒæ‰‹æœºAPPäº‹å…ˆå·²ç»çŸ¥é“è¦è¿›è¡Œé€šä¿¡çš„æœåŠ¡ç«¯ï¼Œå¯ä»¥ç›´æ¥åœ¨å®¢æˆ·ç«¯ä¿å­˜è¿™ä¸ªæœåŠ¡ç«¯çš„è¯ä¹¦ç”¨äºæ ¡éªŒã€‚</p>
<p>ä¸ºä»€ä¹ˆç›´æ¥å¯¹æ¯”å°±èƒ½ä¿è¯è¯ä¹¦æ²¡é—®é¢˜ï¼Ÿ å¦‚æœä¸­é—´äººä»å®¢æˆ·ç«¯å–å‡ºè¯ä¹¦ï¼Œå†ä¼ªè£…æˆæœåŠ¡ç«¯è·Ÿå…¶ä»–å®¢æˆ·ç«¯é€šä¿¡ï¼Œå®ƒå‘é€ç»™å®¢æˆ·ç«¯çš„è¿™ä¸ªè¯ä¹¦ä¸å°±èƒ½é€šè¿‡éªŒè¯å—ï¼Ÿç¡®å®å¯ä»¥é€šè¿‡éªŒè¯ï¼Œä½†åç»­çš„æµç¨‹èµ°ä¸ä¸‹å»ï¼Œå› ä¸ºä¸‹ä¸€æ­¥å®¢æˆ·ç«¯ä¼šç”¨è¯ä¹¦é‡Œçš„å…¬é’¥åŠ å¯†ï¼Œä¸­é—´äººæ²¡æœ‰è¿™ä¸ªè¯ä¹¦çš„ç§é’¥å°±è§£ä¸å‡ºå†…å®¹ï¼Œä¹Ÿå°±æˆªè·ä¸åˆ°æ•°æ®ï¼Œè¿™ä¸ªè¯ä¹¦çš„ç§é’¥åªæœ‰çœŸæ­£çš„æœåŠ¡ç«¯æœ‰ï¼Œä¸­é—´äººä¼ªé€ è¯ä¹¦ä¸»è¦ä¼ªé€ çš„æ˜¯å…¬é’¥ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦ç”¨SSL  Pinningï¼Ÿæ­£å¸¸çš„éªŒè¯æ–¹å¼ä¸å¤Ÿå—ï¼Ÿå¦‚æœæœåŠ¡ç«¯çš„è¯ä¹¦æ˜¯ä»å—ä¿¡ä»»çš„çš„CAæœºæ„é¢å‘çš„ï¼ŒéªŒè¯æ˜¯æ²¡é—®é¢˜çš„ï¼Œä½†CAæœºæ„é¢å‘è¯ä¹¦æ¯”è¾ƒæ˜‚è´µï¼Œå°ä¼ä¸šæˆ–ä¸ªäººç”¨ æˆ· å¯èƒ½ä¼šé€‰æ‹©è‡ªå·±é¢å‘è¯ä¹¦ï¼Œè¿™æ ·å°±æ— æ³•é€šè¿‡ç³»ç»Ÿå—ä¿¡ä»»çš„CAæœºæ„åˆ—è¡¨éªŒè¯è¿™ä¸ªè¯ä¹¦çš„çœŸä¼ªäº†ï¼Œæ‰€ä»¥éœ€è¦SSL Pinningè¿™æ ·çš„æ–¹å¼å»éªŒè¯ã€‚</p>
<a id="more"></a>
<h2 id="AFSecurityPolicy"><a href="#AFSecurityPolicy" class="headerlink" title="AFSecurityPolicy"></a>AFSecurityPolicy</h2><blockquote>
<p>NSURLConnection å·²ç»å°è£…äº†httpsè¿æ¥çš„å»ºç«‹ã€æ•°æ®çš„åŠ å¯†è§£å¯†åŠŸèƒ½ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨NSURLConnectionæ˜¯å¯ä»¥è®¿é—® httpsç½‘ç«™çš„ï¼Œä½†NSURLConnectionå¹¶æ²¡æœ‰éªŒè¯è¯ä¹¦æ˜¯å¦åˆæ³•ï¼Œæ— æ³•é¿å…ä¸­é—´äººæ”»å‡»ã€‚<br>è¦åšåˆ°çœŸæ­£å®‰å…¨é€šè®¯ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»éªŒè¯æœåŠ¡ç«¯è¿”å›çš„ è¯ä¹¦ï¼ŒAFSecurityPolicyå°è£…äº†è¯ä¹¦éªŒè¯çš„è¿‡ç¨‹ï¼Œè®©ç”¨æˆ·å¯ä»¥è½»æ˜“ä½¿ç”¨ï¼Œé™¤äº†å»ç³»ç»Ÿä¿¡ä»»CAæœºæ„åˆ—è¡¨éªŒè¯ï¼Œè¿˜æ”¯æŒSSL  Pinningæ–¹å¼çš„éªŒè¯</p>
</blockquote>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><blockquote>
<p>æŠŠæœåŠ¡ç«¯è¯ä¹¦(éœ€è¦è½¬æ¢æˆceræ ¼å¼)æ”¾åˆ°APPé¡¹ç›®èµ„æºé‡Œï¼ŒAFSecurityPolicyä¼šè‡ªåŠ¨å¯»æ‰¾æ ¹ç›®å½•ä¸‹æ‰€æœ‰ceræ–‡ä»¶</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">AFSecurityPolicy *securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModePublicKey];</span><br><span class="line">securityPolicy.allowInvalidCertificates = <span class="literal">YES</span>;</span><br><span class="line">[AFHTTPRequestOperationManager manager].securityPolicy = securityPolicy;</span><br></pre></td></tr></table></figure>
<p>éªŒè¯æ—¶ ä½¿ç”¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain;</span><br></pre></td></tr></table></figure>
<h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>UMLå›¾å¦‚ä¸‹:</p>
<p><img src="/res/AFNetworking//AFNetworking3æºç é˜…è¯»-Security-uml.jpg" width="70%"></p>
<h3 id="AFSSLPinningMode-éªŒè¯æ¨¡å¼"><a href="#AFSSLPinningMode-éªŒè¯æ¨¡å¼" class="headerlink" title="AFSSLPinningMode éªŒè¯æ¨¡å¼"></a>AFSSLPinningMode éªŒè¯æ¨¡å¼</h3><ul>
<li><p>AFSSLPinningModeNone</p>
<p>  è¿™ä¸ªæ¨¡å¼è¡¨ç¤ºä¸åšSSL pinningï¼Œåªè·Ÿæµè§ˆå™¨ä¸€æ ·åœ¨ç³»ç»Ÿçš„ä¿¡ä»»æœºæ„åˆ—è¡¨é‡ŒéªŒè¯æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ã€‚è‹¥è¯ä¹¦æ˜¯ä¿¡ä»»æœºæ„ç­¾å‘çš„å°±ä¼šé€šè¿‡ï¼Œè‹¥æ˜¯è‡ªå·±æœåŠ¡å™¨ç”Ÿæˆçš„è¯ä¹¦ï¼Œè¿™é‡Œæ˜¯ä¸ä¼šé€šè¿‡çš„ã€‚</p>
</li>
<li><p>AFSSLPinningModeCertificate</p>
<p>  è¿™ä¸ªæ¨¡å¼è¡¨ç¤ºç”¨è¯ä¹¦ç»‘å®šæ–¹å¼éªŒè¯è¯ä¹¦ï¼Œéœ€è¦å®¢æˆ·ç«¯ä¿å­˜æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œè¿™é‡ŒéªŒè¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥éªŒè¯è¯ä¹¦çš„åŸŸå/æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ï¼Œç¬¬äºŒæ­¥æ˜¯å¯¹æ¯”æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦è·Ÿå®¢æˆ·ç«¯è¿”å›çš„æ˜¯å¦ä¸€è‡´ã€‚</p>
</li>
<li><p>AFSSLPinningModePublicKey</p>
<p>  è¿™ä¸ªæ¨¡å¼åŒæ ·æ˜¯ç”¨è¯ä¹¦ç»‘å®šæ–¹å¼éªŒè¯ï¼Œå®¢æˆ·ç«¯è¦æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œåªæ˜¯éªŒè¯æ—¶åªéªŒè¯è¯ä¹¦é‡Œçš„å…¬é’¥ï¼Œä¸éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ã€‚åªè¦å…¬é’¥æ˜¯æ­£ç¡®çš„ï¼Œå°±èƒ½ä¿è¯é€šä¿¡ä¸ä¼šè¢«çªƒå¬ï¼Œå› ä¸ºä¸­é—´äººæ²¡æœ‰ç§é’¥ï¼Œæ— æ³•è§£å¼€é€šè¿‡å…¬é’¥åŠ å¯†çš„æ•°æ®ã€‚</p>
</li>
</ul>
<h3 id="éªŒè¯æœåŠ¡ç«¯æ˜¯å¦å—ä¿¡"><a href="#éªŒè¯æœåŠ¡ç«¯æ˜¯å¦å—ä¿¡" class="headerlink" title="éªŒè¯æœåŠ¡ç«¯æ˜¯å¦å—ä¿¡"></a>éªŒè¯æœåŠ¡ç«¯æ˜¯å¦å—ä¿¡</h3><blockquote>
<p>éªŒè¯æœåŠ¡ç«¯æ˜¯å¦å®ˆä¿¡æ˜¯é€šè¿‡<code>- [AFSecurityPolicy evaluateServerTrust:forDomain:]</code> æ–¹æ³•è¿›è¡Œçš„ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®severTrustå’Œdomainæ¥æ£€æŸ¥æœåŠ¡å™¨ç«¯å‘æ¥çš„è¯ä¹¦æ˜¯å¦å¯ä¿¡</span></span><br><span class="line"><span class="comment">// å…¶ä¸­SecTrustRefæ˜¯ä¸€ä¸ªCoreFoundationç±»å‹ï¼Œç”¨äºå¯¹æœåŠ¡å™¨ç«¯ä¼ æ¥çš„X.509è¯ä¹¦è¯„ä¼°çš„</span></span><br><span class="line"><span class="comment">// è€Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œæ•°å­—è¯ä¹¦çš„ç­¾å‘æœºæ„CAï¼Œåœ¨æ¥æ”¶åˆ°ç”³è¯·è€…çš„èµ„æ–™åè¿›è¡Œæ ¸å¯¹å¹¶ç¡®å®šä¿¡æ¯çš„çœŸå®æœ‰æ•ˆï¼Œç„¶åå°±ä¼šåˆ¶ä½œä¸€ä»½ç¬¦åˆX.509æ ‡å‡†çš„æ–‡ä»¶ã€‚è¯ä¹¦ä¸­çš„è¯ä¹¦å†…å®¹åŒ…å«çš„æŒæœ‰è€…ä¿¡æ¯å’Œå…¬é’¥ç­‰éƒ½æ˜¯ç”±ç”³è¯·è€…æä¾›çš„ï¼Œè€Œæ•°å­—ç­¾ååˆ™æ˜¯CAæœºæ„å¯¹è¯ä¹¦å†…å®¹è¿›è¡ŒhashåŠ å¯†åå¾—åˆ°çš„ï¼Œè€Œè¿™ä¸ªæ•°å­—ç­¾åå°±æ˜¯æˆ‘ä»¬éªŒè¯è¯ä¹¦æ˜¯å¦æ˜¯æœ‰å¯ä¿¡CAç­¾å‘çš„æ•°æ®ã€‚</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain&#123;</span><br><span class="line"></span><br><span class="line">	<span class="number">1</span>: ä¸èƒ½éšå¼åœ°ä¿¡ä»»è‡ªå·±ç­¾å‘çš„è¯ä¹¦</span><br><span class="line"></span><br><span class="line">	<span class="number">2</span>: è®¾ç½® policy</span><br><span class="line"></span><br><span class="line">	<span class="number">3</span>: éªŒè¯è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line"></span><br><span class="line">	<span class="number">4</span>: æ ¹æ® SSLPinningMode å¯¹æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">                  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1#</strong> ä¸èƒ½éšå¼åœ°ä¿¡ä»»è‡ªå·±ç­¾å‘çš„è¯ä¹¦</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">//self.allowInvalidCertificates==YESè¡¨ç¤ºå¦‚æœæ­¤å¤„å…è®¸ä½¿ç”¨è‡ªå»ºè¯ä¹¦ï¼ˆæœåŠ¡å™¨è‡ªå·±å¼„çš„CAè¯ä¹¦ï¼Œéå®˜æ–¹ï¼‰ï¼Œå¹¶ä¸”è¿˜æƒ³éªŒè¯domainæ˜¯å¦æœ‰æ•ˆ(self.validatesDomainName == YES)ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ æƒ³éªŒè¯è‡ªå»ºè¯ä¹¦çš„domainæ˜¯å¦æœ‰æ•ˆã€‚</span></span><br><span class="line"> <span class="comment">//é‚£ä¹ˆä½ å¿…é¡»ä½¿ç”¨pinnedCertificatesï¼ˆå°±æ˜¯åœ¨å®¢æˆ·ç«¯ä¿å­˜æœåŠ¡å™¨ç«¯é¢å‘çš„è¯ä¹¦æ‹·è´ï¼‰æ‰å¯ä»¥ã€‚</span></span><br><span class="line"> <span class="comment">//ä½†æ˜¯ä½ çš„SSLPinningModeä¸ºAFSSLPinningModeNoneï¼Œè¡¨ç¤ºä½ ä¸ä½¿ç”¨SSL pinningï¼Œåªè·Ÿæµè§ˆå™¨ä¸€æ ·åœ¨ç³»ç»Ÿçš„ä¿¡ä»»æœºæ„åˆ—è¡¨é‡ŒéªŒè¯æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ã€‚æ‰€ä»¥å½“ç„¶ä½ çš„å®¢æˆ·ç«¯ä¸Šæ²¡æœ‰ä½ å¯¼å…¥çš„pinnedCertificatesï¼ŒåŒæ ·è¡¨ç¤ºä½ æ— æ³•éªŒè¯è¯¥è‡ªå»ºè¯ä¹¦ã€‚æ‰€ä»¥éƒ½è¿”å›NOã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (domain &amp;&amp; <span class="keyword">self</span>.allowInvalidCertificates &amp;&amp; <span class="keyword">self</span>.validatesDomainName &amp;&amp; (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone || [<span class="keyword">self</span>.pinnedCertificates count] == <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"In order to validate a domain name for self signed certificates, you MUST use pinning."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2#</strong> è®¾ç½® policy</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ­¤å¤„è®¾ç½®éªŒè¯è¯ä¹¦çš„ç­–ç•¥</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.validatesDomainName) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦éªŒè¯domainï¼Œé‚£ä¹ˆå°±ä½¿ç”¨SecPolicyCreateSSLå‡½æ•°åˆ›å»ºéªŒè¯ç­–ç•¥ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºtrueè¡¨ç¤ºéªŒè¯æ•´ä¸ªSSLè¯ä¹¦é“¾ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥domainï¼Œç”¨äºåˆ¤æ–­æ•´ä¸ªè¯ä¹¦é“¾ä¸Šå¶å­èŠ‚ç‚¹è¡¨ç¤ºçš„é‚£ä¸ªdomainæ˜¯å¦å’Œæ­¤å¤„ä¼ å…¥domainä¸€è‡´</span></span><br><span class="line">    [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸éœ€è¦éªŒè¯domainï¼Œå°±ä½¿ç”¨é»˜è®¤çš„BasicX509éªŒè¯ç­–ç•¥</span></span><br><span class="line">    [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä¸ºserverTrustè®¾ç½®éªŒè¯ç­–ç•¥ï¼Œå³å‘Šè¯‰å®¢æˆ·ç«¯å¦‚ä½•éªŒè¯serverTrust</span></span><br><span class="line">SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</span><br></pre></td></tr></table></figure>
<p><strong>3#</strong> éªŒè¯è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœSSLPinningModeä¸º AFSSLPinningModeNoneï¼Œè¡¨ç¤ºä½ ä¸ä½¿ç”¨SSL pinningï¼Œä½†æ˜¯æˆ‘å…è®¸è‡ªå»ºè¯ä¹¦ï¼Œé‚£ä¹ˆè¿”å›YESï¼Œæˆ–è€…ä½¿ç”¨AFServerTrustIsValidå‡½æ•°çœ‹çœ‹serverTrustæ˜¯å¦å¯ä¿¡ä»»ï¼Œå¦‚æœä¿¡ä»»ï¼Œä¹Ÿè¿”å›YES</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ—¢ä¸å…è®¸è‡ªå»ºè¯ä¹¦ï¼Œè€Œä¸”ä½¿ç”¨AFServerTrustIsValidå‡½æ•°åˆè¿”å›NOï¼Œé‚£ä¹ˆè¯¥serverTrustå°±çœŸçš„ä¸èƒ½é€šè¿‡éªŒè¯äº†</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="keyword">self</span>.allowInvalidCertificates) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4#</strong> æ ¹æ® SSLPinningMode å¯¹æœåŠ¡ç«¯è¿›è¡ŒéªŒè¯</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="keyword">self</span>.SSLPinningMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeNone:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeCertificate: &#123;<span class="comment">//éªŒè¯æ•´ä¸ªè¯ä¹¦</span></span><br><span class="line">            <span class="built_in">NSMutableArray</span> *pinnedCertificates = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificateData <span class="keyword">in</span> <span class="keyword">self</span>.pinnedCertificates) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œä½¿ç”¨SecCertificateCreateWithDataå‡½æ•°å¯¹åŸå…ˆçš„pinnedCertificatesåšä¸€äº›å¤„ç†ï¼Œä¿è¯è¿”å›çš„è¯ä¹¦éƒ½æ˜¯DERç¼–ç çš„X.509è¯ä¹¦</span></span><br><span class="line">                [pinnedCertificates addObject:(__bridge_transfer <span class="keyword">id</span>)SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificateData)];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†pinnedCertificatesè®¾ç½®æˆéœ€è¦å‚ä¸éªŒè¯çš„Anchor Certificateï¼ˆé”šç‚¹è¯ä¹¦ï¼Œé€šè¿‡SecTrustSetAnchorCertificatesè®¾ç½®äº†å‚ä¸æ ¡éªŒé”šç‚¹è¯ä¹¦ä¹‹åï¼Œå‡å¦‚éªŒè¯çš„æ•°å­—è¯ä¹¦æ˜¯è¿™ä¸ªé”šç‚¹è¯ä¹¦çš„å­èŠ‚ç‚¹ï¼Œå³éªŒè¯çš„æ•°å­—è¯ä¹¦æ˜¯ç”±é”šç‚¹è¯ä¹¦å¯¹åº”CAæˆ–å­CAç­¾å‘çš„ï¼Œæˆ–æ˜¯è¯¥è¯ä¹¦æœ¬èº«ï¼Œåˆ™ä¿¡ä»»è¯¥è¯ä¹¦ï¼‰ï¼Œå…·ä½“å°±æ˜¯è°ƒç”¨SecTrustEvaluateæ¥éªŒè¯ã€‚</span></span><br><span class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)pinnedCertificates);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//éªŒè¯æ•´ä¸ªè¯ä¹¦é“¾</span></span><br><span class="line">            <span class="comment">// æœåŠ¡å™¨ç«¯çš„è¯ä¹¦é“¾ï¼Œæ³¨æ„æ­¤å¤„è¿”å›çš„è¯ä¹¦é“¾é¡ºåºæ˜¯ä»å¶èŠ‚ç‚¹åˆ°æ ¹èŠ‚ç‚¹</span></span><br><span class="line">            <span class="built_in">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</span><br><span class="line">            <span class="comment">// ä»æœåŠ¡å™¨ç«¯è¯ä¹¦é“¾çš„æ ¹èŠ‚ç‚¹å¾€ä¸‹éå†ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä¸å®¢æˆ·ç«¯çš„ç»‘å®šè¯ä¹¦ä¸€è‡´çš„ï¼Œæœ‰çš„è¯ï¼Œå°±è¯´æ˜æœåŠ¡å™¨ç«¯æ˜¯å¯ä¿¡çš„ã€‚å› ä¸ºéå†é¡ºåºæ­£å¥½ç›¸åï¼Œæ‰€ä»¥ä½¿ç”¨reverseObjectEnumerator</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *trustChainCertificate <span class="keyword">in</span> [serverCertificates reverseObjectEnumerator]) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([<span class="keyword">self</span>.pinnedCertificates containsObject:trustChainCertificate]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="comment">// AFSSLPinningModePublicKeyæ¨¡å¼åŒæ ·æ˜¯ç”¨è¯ä¹¦ç»‘å®š(SSL Pinning)æ–¹å¼éªŒè¯ï¼Œå®¢æˆ·ç«¯è¦æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œåªæ˜¯éªŒè¯æ—¶åªéªŒè¯è¯ä¹¦é‡Œçš„å…¬é’¥ï¼Œä¸éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ã€‚åªè¦å…¬é’¥æ˜¯æ­£ç¡®çš„ï¼Œå°±èƒ½ä¿è¯é€šä¿¡ä¸ä¼šè¢«çªƒå¬ï¼Œå› ä¸ºä¸­é—´äººæ²¡æœ‰ç§é’¥ï¼Œæ— æ³•è§£å¼€é€šè¿‡å…¬é’¥åŠ å¯†çš„æ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModePublicKey: &#123;</span><br><span class="line">            <span class="built_in">NSUInteger</span> trustedPublicKeyCount = <span class="number">0</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ä»serverTrustä¸­å–å‡ºæœåŠ¡å™¨ç«¯ä¼ è¿‡æ¥çš„æ‰€æœ‰å¯ç”¨çš„è¯ä¹¦ï¼Œå¹¶ä¾æ¬¡å¾—åˆ°ç›¸åº”çš„å…¬é’¥</span></span><br><span class="line">            <span class="built_in">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ä¾æ¬¡éå†è¿™äº›å…¬é’¥ï¼Œå¦‚æœå’Œå®¢æˆ·ç«¯ç»‘å®šè¯ä¹¦çš„å…¬é’¥ä¸€è‡´ï¼Œé‚£ä¹ˆå°±ç»™trustedPublicKeyCountåŠ ä¸€</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> trustChainPublicKey <span class="keyword">in</span> publicKeys) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> pinnedPublicKey <span class="keyword">in</span> <span class="keyword">self</span>.pinnedPublicKeys) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</span><br><span class="line">                        trustedPublicKeyCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ‰¾åˆ°ä¸€ä¸ªéªŒè¯é€šè¿‡çš„public keyå°±ç®—é€šè¿‡</span></span><br><span class="line">            <span class="keyword">return</span> trustedPublicKeyCount &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨ä¸Šé¢ç”¨åˆ°äº†ä¸€äº›é™æ€æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»è¯ä¹¦ä¸­è·å–public key</span></span><br><span class="line"><span class="comment">//__Require_Quiet __Require_noErr_Quiet è¿™ä¸¤ä¸ªå®æ–¹æ³•ç”¨äºæ–¹ä¾¿åœ°å¤„ç†è°ƒç”¨å„ç§è¯ä¹¦æ–¹æ³•è¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯</span></span><br><span class="line"><span class="comment">//å‡ºç°é”™è¯¯åç”¨gotoè¯­å¥ç›´æ¥è·³è½¬åˆ°ç›¸åº”ä½ç½®</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> AFPublicKeyForCertificate(<span class="built_in">NSData</span> *certificate) &#123;</span><br><span class="line">    <span class="keyword">id</span> allowedPublicKey = <span class="literal">nil</span>;</span><br><span class="line">    SecCertificateRef allowedCertificate;</span><br><span class="line">    SecPolicyRef policy = <span class="literal">nil</span>;</span><br><span class="line">    SecTrustRef allowedTrust = <span class="literal">nil</span>;</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1. è·å–è¯ä¹¦SecCertificateRefå¯¹è±¡</span></span><br><span class="line">    allowedCertificate = SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificate);</span><br><span class="line">    __Require_Quiet(allowedCertificate != <span class="literal">NULL</span>, _<span class="keyword">out</span>);</span><br><span class="line">    <span class="comment">//2. è·å–é»˜è®¤x.509è¯ä¹¦æ ‡å‡†</span></span><br><span class="line">    policy = SecPolicyCreateBasicX509();</span><br><span class="line">    <span class="comment">//3. ç”ŸæˆSecTrustRef å¯¹è±¡</span></span><br><span class="line">    __Require_noErr_Quiet(SecTrustCreateWithCertificates(allowedCertificate, policy, &amp;allowedTrust), _<span class="keyword">out</span>);</span><br><span class="line">    <span class="comment">//4. è¯„ä¼°SecTrustRefå¯¹è±¡</span></span><br><span class="line">    __Require_noErr_Quiet(SecTrustEvaluate(allowedTrust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line">    <span class="comment">//5. è·å¾—å…¬é’¥SecTrustCopyPublicKeyå¯¹è±¡</span></span><br><span class="line">    allowedPublicKey = (__bridge_transfer <span class="keyword">id</span>)SecTrustCopyPublicKey(allowedTrust);</span><br><span class="line"></span><br><span class="line">_<span class="keyword">out</span>:</span><br><span class="line">    <span class="keyword">if</span> (allowedTrust) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(allowedTrust);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (policy) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(policy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (allowedCertificate) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(allowedCertificate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> allowedPublicKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">BOOL</span> AFServerTrustIsValid(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isValid = <span class="literal">NO</span>;</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line">    __Require_noErr_Quiet(SecTrustEvaluate(serverTrust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//kSecTrustResultUnspecified:è¯ä¹¦é€šè¿‡éªŒè¯ï¼Œä½†ç”¨æˆ·æ²¡æœ‰è®¾ç½®è¿™äº›è¯ä¹¦æ˜¯å¦è¢«ä¿¡ä»»</span></span><br><span class="line">    <span class="comment">//kSecTrustResultProceed:è¯ä¹¦é€šè¿‡éªŒè¯ï¼Œç”¨æˆ·æœ‰æ“ä½œè®¾ç½®äº†è¯ä¹¦è¢«ä¿¡ä»»ï¼Œä¾‹å¦‚åœ¨å¼¹å‡ºçš„æ˜¯å¦ä¿¡ä»»çš„alertæ¡†ä¸­é€‰æ‹©always trust</span></span><br><span class="line">    isValid = (result == kSecTrustResultUnspecified || result == kSecTrustResultProceed);</span><br><span class="line"></span><br><span class="line">_<span class="keyword">out</span>:</span><br><span class="line">    <span class="keyword">return</span> isValid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å–å‡ºæœåŠ¡ç«¯è¿”å›çš„æ‰€æœ‰è¯ä¹¦</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFCertificateTrustChainForServerTrust(SecTrustRef serverTrust) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨SecTrustGetCertificateCountå‡½æ•°tè·å–åˆ°serverTrustä¸­éœ€è¦è¯„ä¼°çš„è¯ä¹¦é“¾ä¸­çš„è¯ä¹¦æ•°ç›®ï¼Œå¹¶ä¿å­˜åˆ°certificateCountä¸­</span></span><br><span class="line">    <span class="built_in">CFIndex</span> certificateCount = SecTrustGetCertificateCount(serverTrust);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *trustChain = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:(<span class="built_in">NSUInteger</span>)certificateCount];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨SecTrustGetCertificateAtIndexå‡½æ•°è·å–åˆ°è¯ä¹¦é“¾ä¸­çš„æ¯ä¸ªè¯ä¹¦ï¼Œå¹¶æ·»åŠ åˆ°trustChainä¸­ï¼Œæœ€åè¿”å›trustChain</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">CFIndex</span> i = <span class="number">0</span>; i &lt; certificateCount; i++) &#123;</span><br><span class="line">        SecCertificateRef certificate = SecTrustGetCertificateAtIndex(serverTrust, i);</span><br><span class="line">        [trustChain addObject:(__bridge_transfer <span class="built_in">NSData</span> *)SecCertificateCopyData(certificate)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:trustChain];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å–å‡ºæœåŠ¡ç«¯è¿”å›è¯ä¹¦é‡Œæ‰€æœ‰çš„public key</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFPublicKeyTrustChainForServerTrust(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥çš„ä¸€å°æ®µä»£ç å’Œä¸Šé¢AFCertificateTrustChainForServerTrustå‡½æ•°çš„ä½œç”¨åŸºæœ¬ä¸€è‡´ï¼Œéƒ½æ˜¯ä¸ºäº†è·å–åˆ°serverTrustä¸­è¯ä¹¦é“¾ä¸Šçš„æ‰€æœ‰è¯ä¹¦ï¼Œå¹¶ä¾æ¬¡éå†ï¼Œå–å‡ºå…¬é’¥ã€‚</span></span><br><span class="line">    SecPolicyRef policy = SecPolicyCreateBasicX509();</span><br><span class="line">    <span class="built_in">CFIndex</span> certificateCount = SecTrustGetCertificateCount(serverTrust);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *trustChain = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:(<span class="built_in">NSUInteger</span>)certificateCount];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">CFIndex</span> i = <span class="number">0</span>; i &lt; certificateCount; i++) &#123;</span><br><span class="line">        SecCertificateRef certificate = SecTrustGetCertificateAtIndex(serverTrust, i);</span><br><span class="line"></span><br><span class="line">        SecCertificateRef someCertificates[] = &#123;certificate&#125;;</span><br><span class="line">        <span class="built_in">CFArrayRef</span> certificates = <span class="built_in">CFArrayCreate</span>(<span class="literal">NULL</span>, (<span class="keyword">const</span> <span class="keyword">void</span> **)someCertificates, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        SecTrustRef trust;</span><br><span class="line">        <span class="comment">// æ ¹æ®ç»™å®šçš„certificateså’Œpolicyæ¥ç”Ÿæˆä¸€ä¸ªtrustå¯¹è±¡</span></span><br><span class="line">        __Require_noErr_Quiet(SecTrustCreateWithCertificates(certificates, policy, &amp;trust), _<span class="keyword">out</span>);</span><br><span class="line"></span><br><span class="line">        SecTrustResultType result;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨SecTrustEvaluateæ¥è¯„ä¼°ä¸Šé¢æ„å»ºçš„trust</span></span><br><span class="line">        __Require_noErr_Quiet(SecTrustEvaluate(trust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥trustç¬¦åˆX.509è¯ä¹¦æ ¼å¼ï¼Œé‚£ä¹ˆå…ˆä½¿ç”¨SecTrustCopyPublicKeyè·å–åˆ°trustçš„å…¬é’¥ï¼Œå†å°†æ­¤å…¬é’¥æ·»åŠ åˆ°trustChainä¸­</span></span><br><span class="line">        [trustChain addObject:(__bridge_transfer <span class="keyword">id</span>)SecTrustCopyPublicKey(trust)];</span><br><span class="line"></span><br><span class="line">    _<span class="keyword">out</span>:</span><br><span class="line">        <span class="comment">// æ³¨æ„é‡Šæ”¾èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> (trust) &#123;</span><br><span class="line">            <span class="built_in">CFRelease</span>(trust);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (certificates) &#123;</span><br><span class="line">            <span class="built_in">CFRelease</span>(certificates);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CFRelease</span>(policy);</span><br><span class="line">    <span class="comment">// è¿”å›å¯¹åº”çš„ä¸€ç»„å…¬é’¥</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:trustChain];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸-AFURLSessionManager-åä½œ"><a href="#ä¸-AFURLSessionManager-åä½œ" class="headerlink" title="ä¸ AFURLSessionManager åä½œ"></a>ä¸ AFURLSessionManager åä½œ</h2><p>åœ¨ä»£ç†åè®® <code>- URLSession:didReceiveChallenge:completionHandler:</code> æˆ–è€… <code>- URLSession:task:didReceiveChallenge:completionHandler:</code> ä»£ç†æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼šè¿è¡Œè¿™æ®µä»£ç </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;  </span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">        disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">        credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        disposition = <span class="built_in">NSURLSessionAuthChallengeRejectProtectionSpace</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NSURLAuthenticationChallenge è¡¨ç¤ºä¸€ä¸ªè®¤è¯çš„æŒ‘æˆ˜ï¼Œæä¾›äº†å…³äºè¿™æ¬¡è®¤è¯çš„å…¨éƒ¨ä¿¡æ¯ã€‚å®ƒæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å±æ€§ protectionSpaceï¼Œè¿™é‡Œä¿å­˜äº†éœ€è¦è®¤è¯çš„ä¿æŠ¤ç©ºé—´, æ¯ä¸€ä¸ª NSURLProtectionSpace å¯¹è±¡éƒ½ä¿å­˜äº†ä¸»æœºåœ°å€ï¼Œç«¯å£å’Œè®¤è¯æ–¹æ³•ç­‰é‡è¦ä¿¡æ¯ã€‚</p>
<p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œå¦‚æœä¿æŠ¤ç©ºé—´ä¸­çš„è®¤è¯æ–¹æ³•ä¸º NSURLAuthenticationMethodServerTrustï¼Œé‚£ä¹ˆå°±ä¼šä½¿ç”¨åœ¨ä¸Šä¸€å°èŠ‚ä¸­æåˆ°çš„æ–¹æ³• - [AFSecurityPolicy evaluateServerTrust:forDomain:] å¯¹ä¿æŠ¤ç©ºé—´ä¸­çš„ serverTrust ä»¥åŠåŸŸå host è¿›è¡Œè®¤è¯</p>
<p>æ ¹æ®è®¤è¯çš„ç»“æœï¼Œä¼šåœ¨ completionHandler ä¸­ä¼ å…¥ä¸åŒçš„ disposition å’Œ credential å‚æ•°ã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>AFNetworking</category>
      </categories>
      <tags>
        <tag>AFNetworking</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-AVAudioPlayerç®€ä»‹</title>
    <url>/essay/AVFoundation/AVFoundation-AVAudioPlayer%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h1 id="ä½¿ç”¨System-Sound-Serviceæ’­æ”¾éŸ³æ•ˆ"><a href="#ä½¿ç”¨System-Sound-Serviceæ’­æ”¾éŸ³æ•ˆ" class="headerlink" title="ä½¿ç”¨System Sound Serviceæ’­æ”¾éŸ³æ•ˆ"></a>ä½¿ç”¨System Sound Serviceæ’­æ”¾éŸ³æ•ˆ</h1><p>å‚è€ƒ <a href></a></p>
<blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<ol>
<li>è°ƒç”¨<code>AudioServicesCreateSystemSoundID(   CFURLRef  inFileURL, SystemSoundID*   outSystemSoundID)</code>å‡½æ•°è·å¾—ç³»ç»Ÿå£°éŸ³IDã€‚</li>
<li>å¦‚æœéœ€è¦ç›‘å¬æ’­æ”¾å®Œæˆæ“ä½œï¼Œåˆ™ä½¿ç”¨<code>AudioServicesAddSystemSoundCompletion(  SystemSoundID inSystemSoundID,
 CFRunLoopRef  inRunLoop, CFStringRef  inRunLoopMode, AudioServicesSystemSoundCompletionProc  inCompletionRoutine, void*  inClientData)</code>æ–¹æ³•æ³¨å†Œå›è°ƒå‡½æ•°ã€‚</li>
<li>è°ƒç”¨<code>AudioServicesPlaySystemSound(SystemSoundID inSystemSoundID)</code>æˆ–è€…<code>AudioServicesPlayAlertSound(SystemSoundID inSystemSoundID)</code> æ–¹æ³•æ’­æ”¾éŸ³æ•ˆï¼ˆåè€…å¸¦æœ‰éœ‡åŠ¨æ•ˆæœï¼‰ã€‚</li>
</ol>
<a id="more"></a>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;AudioToolbox/AudioToolbox.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ’­æ”¾å®Œæˆå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param soundID    ç³»ç»Ÿå£°éŸ³ID</span></span><br><span class="line"><span class="comment"> *  @param clientData å›è°ƒæ—¶ä¼ é€’çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> soundCompleteCallback(SystemSoundID soundID,<span class="keyword">void</span> * clientData)&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æ’­æ”¾å®Œæˆ..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ’­æ”¾éŸ³æ•ˆæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param name éŸ³é¢‘æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)playSoundEffect:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *audioFile=[[<span class="built_in">NSBundle</span> mainBundle] pathForResource:name ofType:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSURL</span> *fileUrl=[<span class="built_in">NSURL</span> fileURLWithPath:audioFile];</span><br><span class="line">    <span class="comment">//1.è·å¾—ç³»ç»Ÿå£°éŸ³ID</span></span><br><span class="line">    SystemSoundID soundID=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * inFileUrl:éŸ³é¢‘æ–‡ä»¶url</span></span><br><span class="line"><span class="comment">     * outSystemSoundID:å£°éŸ³idï¼ˆæ­¤å‡½æ•°ä¼šå°†éŸ³æ•ˆæ–‡ä»¶åŠ å…¥åˆ°ç³»ç»ŸéŸ³é¢‘æœåŠ¡ä¸­å¹¶è¿”å›ä¸€ä¸ªé•¿æ•´å½¢IDï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AudioServicesCreateSystemSoundID((__bridge <span class="built_in">CFURLRef</span>)(fileUrl), &amp;soundID);</span><br><span class="line">    <span class="comment">//å¦‚æœéœ€è¦åœ¨æ’­æ”¾å®Œä¹‹åæ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¯ä»¥è°ƒç”¨å¦‚ä¸‹æ–¹æ³•æ³¨å†Œä¸€ä¸ªæ’­æ”¾å®Œæˆå›è°ƒå‡½æ•°</span></span><br><span class="line">    AudioServicesAddSystemSoundCompletion(soundID, <span class="literal">NULL</span>, <span class="literal">NULL</span>, soundCompleteCallback, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//2.æ’­æ”¾éŸ³é¢‘</span></span><br><span class="line">    AudioServicesPlaySystemSound(soundID);<span class="comment">//æ’­æ”¾éŸ³æ•ˆ</span></span><br><span class="line"><span class="comment">//    AudioServicesPlayAlertSound(soundID);//æ’­æ”¾éŸ³æ•ˆå¹¶éœ‡åŠ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="AVAudioPlayeræ’­æ”¾å’Œå½•åˆ¶éŸ³é¢‘"><a href="#AVAudioPlayeræ’­æ”¾å’Œå½•åˆ¶éŸ³é¢‘" class="headerlink" title="AVAudioPlayeræ’­æ”¾å’Œå½•åˆ¶éŸ³é¢‘"></a>AVAudioPlayeræ’­æ”¾å’Œå½•åˆ¶éŸ³é¢‘</h1><blockquote>
<p>ä¸»è¦é€šè¿‡ AVAudioPlayer å’Œ AVAudioRecorder ç±»æ¥å®ç°ã€‚</p>
</blockquote>
<h2 id="AVAudioPlayer-ç®€ä»‹"><a href="#AVAudioPlayer-ç®€ä»‹" class="headerlink" title="AVAudioPlayer ç®€ä»‹"></a>AVAudioPlayer ç®€ä»‹</h2><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p>ä¸€èˆ¬é€šè¿‡ ä½¿ç”¨æœ¬åœ°éŸ³é¢‘æ–‡ä»¶çš„ NSURL æˆ–è€…åŒ…å«éŸ³é¢‘çš„å†…å­˜çš„ NSDataã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithContentsOfURL:(<span class="built_in">NSURL</span> *)url error:(<span class="built_in">NSError</span> **)outError;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithData:(<span class="built_in">NSData</span> *)data error:(<span class="built_in">NSError</span> **)outError;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <strong>prepareToPlay</strong> æ–¹æ³• å¯ä»¥å–å¾—éœ€è¦çš„éŸ³é¢‘ç¡¬ä»¶å¹¶é¢„åŠ è½½ Audio Queue çš„ç¼“å†²åŒºã€‚åœ¨åˆ›å»ºçš„æ—¶å€™è°ƒç”¨å¯ä»¥é™ä½è°ƒç”¨ <strong>play</strong> æ–¹æ³•å’Œå¬åˆ°å£°éŸ³è¾“å‡ºä¹‹é—´çš„å»¶è¿Ÿã€‚</p>
<h3 id="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"><a href="#å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶" class="headerlink" title="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"></a>å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶</h3><blockquote>
<p>å¸¸è§çš„ <code>play</code>ã€<code>stop</code>å’Œ <code>pause</code>çš„æ’­æ”¾æš‚åœåŠŸèƒ½ã€‚<br>å…¶ä¸­ stop å’Œ pause çš„åŒºåˆ«æ˜¯ stop æ–¹æ³•ä¼šæ’¤é”€è°ƒç”¨ prepareToPlayæ—¶æ‰€åšçš„è®¾ç½®ï¼Œè€Œ pause æ–¹æ³•ä¸ä¼šã€‚</p>
</blockquote>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ï¼š</p>
<ul>
<li><strong>ä¿®æ”¹æ’­æ”¾å™¨çš„éŸ³é‡</strong> ï¼ˆvolumeï¼‰ï¼šä»0.0ï¼ˆé™éŸ³ï¼‰åˆ°1.0ï¼ˆæœ€å¤§éŸ³é‡ä¹‹é—´ï¼‰ã€‚</li>
<li><strong>ä¿®æ”¹æ’­æ”¾å™¨çš„ pan å€¼</strong>ï¼šå…è®¸ä½¿ç”¨ç«‹ä½“å£°æ’­æ”¾å£°éŸ³ï¼Œä» -1.0ï¼ˆæå·¦ï¼‰åˆ° 1.0ï¼ˆæå³ï¼‰ã€‚é»˜è®¤ 0.0ï¼ˆå±…ä¸­ï¼‰ã€‚</li>
<li><strong>è°ƒæ•´æ’­æ”¾ç‡</strong> ï¼ˆrateï¼‰ï¼šéœ€è¦é…åˆ enableRate ä½¿ç”¨ã€‚èŒƒå›´ä» 0.5ï¼ˆåŠæ•°ï¼‰åˆ°2.0ï¼ˆ2å€æ•°ï¼‰ã€‚</li>
<li><strong>æ— ç¼å¾ªç¯</strong> (numberOfLoops): æ’­æ”¾ n+1æ¬¡ï¼Œè‹¥ n&lt;-1 åˆ™æ’­æ”¾æ— é™æ¬¡ç›´åˆ°è¢«åœæ­¢ã€‚</li>
<li><strong>éŸ³é¢‘è®¡é‡</strong>ï¼š å¯ä»¥è¯»å–éŸ³é‡åŠ›åº¦çš„å¹³å‡å€¼å’Œå³°å€¼ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§3 FPSä¸å¡é¡¿</title>
    <url>/essay/APM/iOSAPM3/</url>
    <content><![CDATA[<h3 id="FPS"><a href="#FPS" class="headerlink" title="FPS"></a>FPS</h3><p>FPSï¼ˆFrames Per Secondï¼‰æ˜¯æŒ‡ç”»é¢æ¯ç§’ä¼ è¾“çš„å¸§æ•°ã€‚æ¯ç§’å¸§æ•°è¶Šå¤šï¼Œæ‰€æ˜¾ç¤ºçš„åŠ¨ç”»å°±è¶Šæµç•…ï¼Œä¸€èˆ¬åªè¦ä¿æŒ FPS åœ¨ 50-60ï¼ŒApp å°±ä¼šæœ‰æµç•…çš„ä½“éªŒï¼Œåä¹‹ä¼šæ„Ÿè§‰åˆ°å¡é¡¿ã€‚</p>
<h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p><code>CADisplayLink</code> æ˜¯ä¸€ä¸ªèƒ½è®©æˆ‘ä»¬ä»¥å’Œå±å¹•åˆ·æ–°ç‡ç›¸åŒçš„é¢‘ç‡å°†å†…å®¹ç”»åˆ°å±å¹•ä¸Šçš„å®šæ—¶å™¨ã€‚</p>
<p>ä¸€æ—¦ CADisplayLink ä»¥ç‰¹å®šçš„æ¨¡å¼æ³¨å†Œåˆ° runloop ä¹‹åï¼Œæ¯å½“å±å¹•éœ€è¦åˆ·æ–°æ—¶ï¼Œrunloop å°±ä¼šè°ƒç”¨ CADisplayLink ç»‘å®šçš„ target ä¸Šçš„ selectorï¼Œæ­¤æ—¶ target å¯ä»¥è¯»å–åˆ° CADisplayLink çš„æ¯æ¬¡è°ƒç”¨çš„æ—¶é—´æˆ³ï¼Œç”¨æ¥å‡†å¤‡ä¸‹ä¸€å¸§æ˜¾ç¤ºéœ€è¦çš„æ•°æ®ã€‚å¦‚ï¼šä¸€ä¸ªè§†é¢‘åº”ç”¨ä½¿ç”¨æ—¶é—´æˆ³æ¥è®¡ç®—ä¸‹ä¸€å¸§è¦æ˜¾ç¤ºçš„è§†é¢‘æ•°æ®ã€‚</p>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>ç°é˜¶æ®µï¼Œå¸¸ç”¨çš„ FPS ç›‘æ§å‡ ä¹éƒ½æ˜¯åŸºäº CADisplayLink å®ç°çš„ã€‚</p>
<a id="more"></a>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// swift</span></span><br><span class="line">final <span class="class"><span class="keyword">class</span> <span class="title">FPSMonitor</span>:</span> NSObject &#123;</span><br><span class="line">    <span class="keyword">private</span> var timer: Timer?</span><br><span class="line">    <span class="keyword">private</span> var link: CADisplayLink?</span><br><span class="line">    <span class="keyword">private</span> var count: UInt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> var lastTime: TimeInterval = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    func enableMonitor() &#123;</span><br><span class="line">        <span class="keyword">if</span> link == nil &#123;</span><br><span class="line">            link = CADisplayLink(target: self, selector: #selector(fpsInfoCalculate(_:)))</span><br><span class="line">            link?.add(to: RunLoop.main, forMode: .common)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            link?.isPaused = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    func disableMonitor() &#123;</span><br><span class="line">        <span class="keyword">if</span> let link = link &#123;</span><br><span class="line">            link.isPaused = <span class="literal">true</span></span><br><span class="line">            link.invalidate()</span><br><span class="line">            self.link = nil</span><br><span class="line">            lastTime = <span class="number">0</span></span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @objc</span><br><span class="line">    func fpsInfoCalculate(_ link: CADisplayLink) &#123;</span><br><span class="line">        <span class="keyword">if</span> lastTime == <span class="number">0</span> &#123;</span><br><span class="line">            lastTime = link.timestamp</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        let delta = link.timestamp - lastTime</span><br><span class="line">        <span class="keyword">if</span> delta &gt;= <span class="number">1</span> &#123;</span><br><span class="line">            <span class="comment">// é—´éš”è¶…è¿‡ 1 ç§’</span></span><br><span class="line">            lastTime = link.timestamp</span><br><span class="line">            let fps = Double(count) / delta</span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            let intFps = Int(fps + <span class="number">0.5</span>)</span><br><span class="line">            print(<span class="string">"å¸§ç‡ï¼š\(intFps)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CADisplayLink å®ç°çš„ FPS åœ¨ç”Ÿäº§åœºæ™¯ä¸­åªæœ‰æŒ‡å¯¼æ„ä¹‰ï¼Œä¸èƒ½ä»£è¡¨çœŸå®çš„ FPSã€‚å› ä¸ºåŸºäº CADisplayLink å®ç°çš„ FPS æ— æ³•å®Œå…¨æ£€æµ‹å‡ºå½“å‰ Core Animation çš„æ€§èƒ½æƒ…å†µï¼Œåªèƒ½æ£€æµ‹å‡ºå½“å‰ RunLoop çš„å¸§ç‡ã€‚</p>
<h3 id="å¦‚ä½•ç›‘æ§å¡é¡¿"><a href="#å¦‚ä½•ç›‘æ§å¡é¡¿" class="headerlink" title="å¦‚ä½•ç›‘æ§å¡é¡¿"></a>å¦‚ä½•ç›‘æ§å¡é¡¿</h3><p>é‚£æ€ä¹ˆç›‘æ§åº”ç”¨çš„å¡é¡¿æƒ…å†µï¼Ÿé€šå¸¸æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ¡ˆ</p>
<ul>
<li>FPS ç›‘æ§ï¼šè¿™æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„ä¸€ç§æ–¹æ¡ˆï¼Œå¦‚æœå¸§ç‡è¶Šé«˜æ„å‘³ç€ç•Œé¢è¶Šæµç•…ï¼Œä¸Šæ–‡ä¹Ÿç»™å‡ºäº†è®¡ç®— FPS çš„å®ç°æ–¹å¼ï¼Œé€šè¿‡ä¸€æ®µè¿ç»­çš„ FPS è®¡ç®—ä¸¢å¸§ç‡æ¥è¡¡é‡å½“å‰é¡µé¢ç»˜åˆ¶çš„è´¨é‡ã€‚<ul>
<li>FPS çš„åˆ·æ–°é¢‘ç‡éå¸¸å¿«ï¼Œå¹¶ä¸”å®¹æ˜“å‘ç”ŸæŠ–åŠ¨ï¼Œå› æ­¤ç›´æ¥é€šè¿‡æ¯”è¾ƒ FPS æ¥ä¾¦æµ‹å¡é¡¿æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼›æ­¤å¤–ï¼Œä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§ä¹Ÿä¼šå‘ç”ŸæŠ–åŠ¨ï¼Œæ‰€ä»¥å¾®ä¿¡è¯»ä¹¦å›¢é˜Ÿç»™å‡ºä¸€ç§ç»¼åˆæ–¹æ¡ˆï¼Œç»“åˆä¸»çº¿ç¨‹ç›‘æ§ã€FPS ç›‘æ§ï¼Œä»¥åŠ CPU ä½¿ç”¨ç‡ç­‰æŒ‡æ ‡ï¼Œä½œä¸ºåˆ¤æ–­å¡é¡¿çš„æ ‡å‡†ã€‚Bugly çš„å¡é¡¿æ£€æµ‹ä¹Ÿæ˜¯åŸºäºè¿™å¥—æ ‡å‡†ã€‚</li>
</ul>
</li>
<li>çº¿ç¨‹å¡é¡¿ç›‘æ§ï¼šè¿™æ˜¯ä¸šå†…å¸¸ç”¨çš„ä¸€ç§æ£€æµ‹å¡é¡¿çš„æ–¹æ³•ï¼Œé€šè¿‡å¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹æ¥ç›‘æ§ä¸»çº¿ç¨‹çš„ RunLoopï¼Œå½“ä¸¤ä¸ªçŠ¶æ€åŒºåŸŸä¹‹é—´çš„è€—æ—¶å¤§äºé˜ˆå€¼æ—¶ï¼Œå°±è®°ä¸ºå‘ç”Ÿä¸€æ¬¡å¡é¡¿ã€‚ç¾å›¢çš„ç§»åŠ¨ç«¯æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ Hertz é‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼</li>
</ul>
<p>ä¸»çº¿ç¨‹å¡é¡¿ç›‘æ§çš„å®ç°æ€è·¯ï¼šå¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹ï¼Œç„¶åå®æ—¶è®¡ç®— kCFRunLoopBeforeSources å’Œ kCFRunLoopAfterWaiting ä¸¤ä¸ªçŠ¶æ€åŒºåŸŸä¹‹é—´çš„è€—æ—¶æ˜¯å¦è¶…è¿‡æŸä¸ªé˜€å€¼ï¼Œæ¥æ–­å®šä¸»çº¿ç¨‹çš„å¡é¡¿æƒ…å†µï¼Œå¯ä»¥å°†è¿™ä¸ªè¿‡ç¨‹æƒ³è±¡æˆæ“åœºä¸Šè·‘åœˆçš„è¿åŠ¨å‘˜ï¼Œæˆ‘ä»¬ä¼šæ¯éš”ä¸€æ®µæ—¶é—´é—´éš”å»åˆ¤æ–­æ˜¯å¦è·‘äº†ä¸€åœˆï¼Œå¦‚æœå‘ç°åœ¨æŒ‡å®šæ—¶é—´é—´éš”æ²¡æœ‰è·‘å®Œä¸€åœˆï¼Œåˆ™è®¤ä¸ºåœ¨æ¶ˆæ¯å¤„ç†çš„è¿‡ç¨‹ä¸­è€—æ—¶å¤ªå¤šï¼Œè§†ä¸ºä¸»çº¿ç¨‹å¡é¡¿ã€‚</p>
<h3 id="ä»£ç å®ç°-1"><a href="#ä»£ç å®ç°-1" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ CFRunLoopObserverRef å®æ—¶è·å– NSRunLoop çš„çŠ¶æ€ã€‚å…·ä½“ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª CFRunLoopObserverContext è§‚å¯Ÿè€… observerã€‚ç„¶åå°†è§‚å¯Ÿè€… observer æ·»åŠ åˆ°ä¸»çº¿ç¨‹ RunLoop çš„ kCFRunLoopCommonModes æ¨¡å¼ä¸‹è¿›è¡Œè§‚å¯Ÿã€‚</p>
<p>ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªæŒç»­çš„å­çº¿ç¨‹ä¸“é—¨ç”¨æ¥ç›‘æ§ä¸»çº¿ç¨‹çš„ RunLoop çŠ¶æ€ã€‚ä¸ºäº†è®©è®¡ç®—æ›´ç²¾ç¡®ï¼Œéœ€è¦è®©å­çº¿ç¨‹æ›´åŠæ—¶çš„è·çŸ¥ä¸»çº¿ç¨‹ RunLoop çŠ¶æ€å˜åŒ–ï¼Œdispatch_semaphore_t æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å¦å¤–ï¼Œå¡é¡¿éœ€è¦è¦†ç›–å¤šæ¬¡è¿ç»­çŸ­æ—¶é—´å¡é¡¿å’Œå•æ¬¡é•¿æ—¶é—´å¡é¡¿ä¸¤ç§æƒ…æ™¯ï¼Œæ‰€ä»¥åˆ¤å®šæ¡ä»¶ä¹Ÿéœ€è¦åšé€‚å½“ä¼˜åŒ–ã€‚ä¼˜åŒ–åçš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runLoopObserverCallBack</span><span class="params">(CFRunLoopObserverRef observer, CFRunLoopActivity activity, <span class="keyword">void</span> *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MyClass *object = (__bridge MyClass*)info;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®°å½•çŠ¶æ€å€¼</span></span><br><span class="line">    object-&gt;activity = activity;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å‘é€ä¿¡å·</span></span><br><span class="line">    <span class="keyword">dispatch_semaphore_t</span> semaphore = moniotr-&gt;semaphore;</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)registerObserver</span><br><span class="line">&#123;</span><br><span class="line">    CFRunLoopObserverContext context = &#123;<span class="number">0</span>,(__bridge <span class="keyword">void</span>*)self,<span class="literal">NULL</span>,<span class="literal">NULL</span>&#125;;</span><br><span class="line">    CFRunLoopObserverRef observer = CFRunLoopObserverCreate(kCFAllocatorDefault,</span><br><span class="line">                                                            kCFRunLoopAllActivities,</span><br><span class="line">                                                            YES,</span><br><span class="line">                                                            <span class="number">0</span>,</span><br><span class="line">                                                            &amp;runLoopObserverCallBack,</span><br><span class="line">                                                            &amp;context);</span><br><span class="line">    CFRunLoopAddObserver(CFRunLoopGetMain(), observer, kCFRunLoopCommonModes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¿¡å·</span></span><br><span class="line">    semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åœ¨å­çº¿ç¨‹ç›‘æ§æ—¶é•¿</span></span><br><span class="line">    dispatch_async(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">        <span class="keyword">while</span> (YES)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å‡å®šè¿ç»­5æ¬¡è¶…æ—¶50msè®¤ä¸ºå¡é¡¿(å½“ç„¶ä¹ŸåŒ…å«äº†å•æ¬¡è¶…æ—¶250ms)</span></span><br><span class="line">            <span class="keyword">long</span> st = dispatch_semaphore_wait(semaphore, dispatch_time(DISPATCH_TIME_NOW, <span class="number">50</span>*NSEC_PER_MSEC));</span><br><span class="line">            <span class="keyword">if</span> (st != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (activity==kCFRunLoopBeforeSources || activity==kCFRunLoopAfterWaiting)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (++timeoutCount &lt; <span class="number">5</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// æ£€æµ‹åˆ°å¡é¡¿ï¼Œè¿›è¡Œå¡é¡¿ä¸ŠæŠ¥</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            timeoutCount = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>APM</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§2 Memoryä¿¡æ¯</title>
    <url>/essay/APM/iOSAPM2/</url>
    <content><![CDATA[<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><p>æˆ‘ä»¬å¯ä»¥è”æƒ³ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µæ˜¯å¦ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼CPUçš„æ–¹å¼è·å–åˆ°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p>
<h3 id="ç›¸å…³ç³»ç»ŸåŸç†"><a href="#ç›¸å…³ç³»ç»ŸåŸç†" class="headerlink" title="ç›¸å…³ç³»ç»ŸåŸç†"></a>ç›¸å…³ç³»ç»ŸåŸç†</h3><p>å†…å­˜æ˜¯æœ‰é™ä¸”ç³»ç»Ÿå…±äº«çš„èµ„æºï¼Œä¸€ä¸ªç¨‹åºå ç”¨è¶Šå¤šï¼Œç³»ç»Ÿå’Œå…¶ä»–ç¨‹åºæ‰€èƒ½ç”¨çš„å°±è¶Šå°‘ã€‚ç¨‹åºå¯åŠ¨å‰éƒ½éœ€è¦å…ˆåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„æ•°æ®æ“ä½œä¹Ÿä¼šå ç”¨ä¸€å®šçš„å†…å­˜èµ„æºã€‚å‡å°‘å†…å­˜å ç”¨ä¹Ÿèƒ½åŒæ—¶å‡å°‘å…¶å¯¹ CPU æ—¶é—´ç»´åº¦ä¸Šçš„æ¶ˆè€—ï¼Œä»è€Œä½¿ä¸ä»…ä½¿ App ä»¥åŠæ•´ä¸ªç³»ç»Ÿä¹Ÿéƒ½èƒ½è¡¨ç°çš„æ›´å¥½ã€‚</p>
<p>MacOS å’Œ iOS éƒ½é‡‡ç”¨äº†è™šæ‹Ÿå†…å­˜æŠ€æœ¯æ¥çªç ´ç‰©ç†å†…å­˜çš„å¤§å°é™åˆ¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€æ®µç”±å¤šä¸ªå¤§å°ç›¸åŒçš„é¡µï¼ˆPageï¼‰æ‰€æ„æˆçš„é€»è¾‘åœ°å€ç©ºé—´ã€‚å¤„ç†å™¨å’Œå†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼ŒMemory Management Unitï¼‰ç»´æŠ¤ç€ç”±é€»è¾‘åœ°å€åˆ°ç‰©ç†åœ°å€çš„ é¡µé¢æ˜ å°„è¡¨ï¼ˆç®€ç§° é¡µè¡¨ï¼‰ï¼Œå½“ç¨‹åºè®¿é—®é€»è¾‘å†…å­˜åœ°å€æ—¶ï¼Œç”± MMU æ ¹æ®é¡µè¡¨å°†é€»è¾‘åœ°å€è½¬æ¢ä¸ºçœŸå®çš„ç‰©ç†åœ°å€ã€‚åœ¨æ—©æœŸçš„è‹¹æœè®¾å¤‡ä¸­ï¼Œæ¯ä¸ªé¡µçš„å¤§å°ä¸º 4KBï¼›åŸºäº A7 å’Œ A8 å¤„ç†å™¨çš„ç³»ç»Ÿä¸º 64 ä½ç¨‹åºæä¾›äº† 16KB çš„è™šæ‹Ÿå†…å­˜åˆ†é¡µå’Œ 4KB çš„ç‰©ç†å†…å­˜åˆ†é¡µï¼›åœ¨ A9 ä¹‹åï¼Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„åˆ†é¡µå¤§å°éƒ½è¾¾åˆ°äº† 16KBã€‚</p>
<p>è™šæ‹Ÿå†…å­˜åˆ†é¡µï¼ˆVirtual Pageï¼ŒVPï¼‰æœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li>Cleanï¼šæŒ‡èƒ½å¤Ÿè¢«ç³»ç»Ÿæ¸…ç†å‡ºå†…å­˜ä¸”åœ¨éœ€è¦æ—¶èƒ½é‡æ–°åŠ è½½çš„æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š<ul>
<li>å†…å­˜æ˜ å°„æ–‡ä»¶</li>
<li>Frameworks ä¸­çš„ __DATA_CONST éƒ¨åˆ†</li>
<li>åº”ç”¨çš„äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶</li>
</ul>
</li>
<li>Dirtyï¼šæŒ‡ä¸èƒ½è¢«ç³»ç»Ÿå›æ”¶çš„å†…å­˜å ç”¨ï¼ŒåŒ…æ‹¬ï¼š<ul>
<li>æ‰€æœ‰å †ä¸Šçš„å¯¹è±¡</li>
<li>å›¾ç‰‡è§£ç ç¼“å†²æ•°æ®</li>
<li>Framework ä¸­çš„ DATA å’Œ DATA_DIRTY éƒ¨åˆ†</li>
</ul>
</li>
</ul>
<a id="more"></a>
<p>ç”±äºå†…å­˜å®¹é‡å’Œè¯»å†™å¯¿å‘½çš„é™åˆ¶ï¼ŒiOS ä¸Šæ²¡æœ‰ Disk Swap æœºåˆ¶ï¼Œå–è€Œä»£ä¹‹ä½¿ç”¨ Compressed Memory æŠ€æœ¯ã€‚ Disk Swap æ˜¯æŒ‡åœ¨ macOS ä»¥åŠä¸€äº›å…¶ä»–æ¡Œé¢æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“å†…å­˜å¯ç”¨èµ„æºç´§å¼ æ—¶ï¼Œç³»ç»Ÿå°†å†…å­˜ä¸­çš„å†…å®¹å†™å…¥ç£ç›˜ä¸­çš„backing storeï¼ˆSwapping outï¼‰ï¼Œå¹¶ä¸”åœ¨éœ€è¦è®¿é—®æ—¶ä»ç£ç›˜ä¸­å†è¯»å…¥ RAMï¼ˆSwapping inï¼‰ã€‚ä¸å¤§å¤šæ•° UNIX ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼ŒmacOS æ²¡æœ‰é¢„å…ˆåˆ†é…ç£ç›˜ä¸­çš„ä¸€éƒ¨åˆ†ä½œä¸º backing storeï¼Œè€Œæ˜¯åˆ©ç”¨å¼•å¯¼åˆ†åŒºæ‰€æœ‰å¯ç”¨çš„ç£ç›˜ç©ºé—´ã€‚</p>
<p>è‹¹æœæœ€åˆåªæ˜¯å…¬å¼€äº†ä» OS X Mavericks å¼€å§‹ä½¿ç”¨ Compressed Memory æŠ€æœ¯ï¼Œä½† iOS ç³»ç»Ÿä¹Ÿä» iOS 7 å¼€å§‹æ‚„æ‚„åœ°ä½¿ç”¨ã€‚</p>
<p>Compressed Memory æŠ€æœ¯åœ¨å†…å­˜ç´§å¼ æ—¶èƒ½å¤Ÿå°†æœ€è¿‘ä½¿ç”¨è¿‡çš„å†…å­˜å ç”¨å‹ç¼©è‡³åŸæœ‰å¤§å°çš„ä¸€åŠä»¥ä¸‹ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨éœ€è¦æ—¶è§£å‹å¤ç”¨ã€‚å®ƒåœ¨èŠ‚çœå†…å­˜çš„åŒæ—¶æé«˜äº†ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼Œå…¶ç‰¹ç‚¹å¯ä»¥å½’ç»“ä¸ºï¼š</p>
<ul>
<li>å‡å°‘äº†ä¸æ´»è·ƒå†…å­˜å ç”¨</li>
<li>æ”¹å–„ç”µæºæ•ˆç‡ï¼Œé€šè¿‡å‹ç¼©å‡å°‘ç£ç›˜ IO å¸¦æ¥çš„æŸè€—</li>
<li>å‹ç¼©/è§£å‹éå¸¸å¿«ï¼Œèƒ½å¤Ÿå°½å¯èƒ½å‡å°‘ CPU çš„æ—¶é—´å¼€é”€</li>
<li>æ”¯æŒå¤šæ ¸æ“ä½œ</li>
</ul>
<p>æœ¬è´¨ä¸Šï¼ŒCompressed Memory ä¹Ÿæ˜¯ Dirty Memoryã€‚å› æ­¤ï¼Œmemory footprint = dirty size + compressed sizeï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦å¹¶ä¸”èƒ½å¤Ÿå°è¯•å»å‡å°‘çš„å†…å­˜å ç”¨ã€‚</p>
<h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>åœ¨ /usr/include/mach/task_info.h ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° mach_task_basic_info å’Œ task_basic_info ç»“æ„ä½“çš„å®šä¹‰ï¼Œåˆ†åˆ«å¦‚ä¸‹æ‰€ç¤ºã€‚äº‹å®ä¸Šï¼Œè‹¹æœå…¬å¸å·²ç»ä¸å»ºè®®å†ä½¿ç”¨ task_basic_info ç»“æ„ä½“äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MACH_TASK_BASIC_INFO     20         <span class="comment">/* always 64-bit basic info */</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_task_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  virtual_size;       <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  resident_size;      <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">mach_vm_size_t</span>  resident_size_max;  <span class="comment">/* maximum resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;          <span class="comment">/* total user run time for</span></span><br><span class="line"><span class="comment">                                               terminated threads */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;        <span class="comment">/* total system run time for</span></span><br><span class="line"><span class="comment">                                               terminated threads */</span></span><br><span class="line">        <span class="keyword">policy_t</span>        policy;             <span class="comment">/* default policy for new threads */</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;      <span class="comment">/* suspend count for task */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* localized structure - cannot be safely passed between tasks of differing sizes */</span></span><br><span class="line"><span class="comment">/* Don't use this, use MACH_TASK_BASIC_INFO instead */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_basic_info</span> &#123;</span></span><br><span class="line">        <span class="keyword">integer_t</span>       suspend_count;  <span class="comment">/* suspend count for task */</span></span><br><span class="line">        <span class="keyword">vm_size_t</span>       virtual_size;   <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">vm_size_t</span>       resident_size;  <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    user_time;      <span class="comment">/* total user run time for</span></span><br><span class="line"><span class="comment">                                           terminated threads */</span></span><br><span class="line">        <span class="keyword">time_value_t</span>    system_time;    <span class="comment">/* total system run time for</span></span><br><span class="line"><span class="comment">                                           terminated threads */</span></span><br><span class="line">	<span class="keyword">policy_t</span>	policy;		<span class="comment">/* default policy for new threads */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>mach_task_basic_info ç»“æ„ä½“å­˜å‚¨äº† Mach task çš„å†…å­˜ä½¿ç”¨ä¿¡æ¯ï¼Œå…¶ä¸­ resident_size æ˜¯ App ä½¿ç”¨çš„é©»ç•™å†…å­˜å¤§å°ï¼Œvirtual_size æ˜¯ App ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜å¤§å°ã€‚</p>
<p>å¦‚ä¸‹æ‰€ç¤ºä¸ºå†…å­˜ä½¿ç”¨æƒ…å†µçš„ä»£ç å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ app å†…å­˜ä½¿ç”¨é‡</span></span><br><span class="line">+ (NSInteger)useMemoryForApp &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mach_task_basic_info</span> <span class="title">info</span>;</span></span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count = MACH_TASK_BASIC_INFO_COUNT;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">kern_return_t</span> kr = task_info(mach_task_self(), MACH_TASK_BASIC_INFO, (<span class="keyword">task_info_t</span>) &amp;info, &amp;count);</span><br><span class="line">	<span class="keyword">if</span> (kr == KERN_SUCCESS) &#123;</span><br><span class="line">		<span class="keyword">return</span> info.resident_size;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œæˆ‘ç”¨ é€šè¿‡æ­¤æ–¹æ³•è·å–åˆ°çš„å†…å­˜ä¿¡æ¯ä¸ Instruments ä¸­çš„ Activity Monitor é‡‡é›†åˆ°çš„å†…å­˜ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°å‰è€…è¦å¤šå‡ºå°†è¿‘ 100MBã€‚ç»è¿‡è°ƒç ”å‘ç°ï¼Œè‹¹æœä½¿ç”¨äº†ä¸Šè¿°çš„ Compressed Memoryï¼Œæˆ‘çŒœæµ‹ï¼šresident_size å¯èƒ½æ˜¯å°† Compressed Memory è§£å‹åæ‰€ç»Ÿè®¡åˆ°çš„ä¸€ä¸ªæ•°å€¼ã€‚<strong>çœŸå®çš„ç‰©ç†å†…å­˜çš„å€¼åº”è¯¥æ˜¯ task_vm_info ç»“æ„ä½“ä¸­çš„ pyhs_footprint æˆå‘˜çš„å€¼ã€‚</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_VM_INFO            22</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_VM_INFO_PURGEABLE  23</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_vm_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  virtual_size;       <span class="comment">/* virtual memory size (bytes) */</span></span><br><span class="line">	<span class="keyword">integer_t</span>       region_count;       <span class="comment">/* number of memory regions */</span></span><br><span class="line">	<span class="keyword">integer_t</span>       page_size;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  resident_size;      <span class="comment">/* resident memory size (bytes) */</span></span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  resident_size_peak; <span class="comment">/* peak resident size (bytes) */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  device;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  device_peak;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  internal;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  internal_peak;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  external;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  external_peak;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  reusable;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  reusable_peak;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  purgeable_volatile_pmap;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  purgeable_volatile_resident;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  purgeable_volatile_virtual;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  compressed;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  compressed_peak;</span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  compressed_lifetime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* added for rev1 */</span></span><br><span class="line">	<span class="keyword">mach_vm_size_t</span>  phys_footprint;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* added for rev2 */</span></span><br><span class="line">	<span class="keyword">mach_vm_address_t</span>       min_address;</span><br><span class="line">	<span class="keyword">mach_vm_address_t</span>       max_address;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œæ­£ç¡®çš„å†…å­˜ä½¿ç”¨æƒ…å†µçš„ä»£ç å®ç°åº”è¯¥å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ app å†…å­˜ä½¿ç”¨é‡</span></span><br><span class="line">+ (NSInteger)useMemoryForApp &#123;</span><br><span class="line">    <span class="keyword">task_vm_info_data_t</span> vmInfo;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> count = TASK_VM_INFO_COUNT;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kernelReturn = task_info(mach_task_self(), TASK_VM_INFO, (<span class="keyword">task_info_t</span>) &amp;vmInfo, &amp;count);</span><br><span class="line">    <span class="keyword">if</span> (kernelReturn == KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">int64_t</span> memoryUsageInByte = (<span class="keyword">int64_t</span>) vmInfo.phys_footprint;</span><br><span class="line">        <span class="keyword">return</span> memoryUsageInByte / <span class="number">1024</span> / <span class="number">1024</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°"><a href="#è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°" class="headerlink" title="è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°"></a>è®¾å¤‡æ‰€æœ‰ç‰©ç†å†…å­˜å¤§å°</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">[NSProcessInfo processInfo].physicalMemory</span><br></pre></td></tr></table></figure>
<h3 id="è®¾å¤‡ä½¿ç”¨çš„å†…å­˜"><a href="#è®¾å¤‡ä½¿ç”¨çš„å†…å­˜" class="headerlink" title="è®¾å¤‡ä½¿ç”¨çš„å†…å­˜"></a>è®¾å¤‡ä½¿ç”¨çš„å†…å­˜</h3><p>è·å–å½“å‰è®¾å¤‡çš„ Memory ä½¿ç”¨æƒ…å†µ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">int64_t getUsedMemory()</span><br><span class="line">&#123;</span><br><span class="line">    size_t length = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mib[<span class="number">6</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> pagesize = <span class="number">0</span>;</span><br><span class="line">    mib[<span class="number">0</span>] = <span class="built_in">CTL_HW</span>;</span><br><span class="line">    mib[<span class="number">1</span>] = HW_PAGESIZE;</span><br><span class="line">    length = <span class="keyword">sizeof</span>(pagesize);</span><br><span class="line">    <span class="keyword">if</span> (sysctl(mib, <span class="number">2</span>, &amp;pagesize, &amp;length, <span class="literal">NULL</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mach_msg_type_number_t count = HOST_VM_INFO_COUNT;</span><br><span class="line">    </span><br><span class="line">    vm_statistics_data_t vmstat;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (host_statistics(mach_host_self(), HOST_VM_INFO, (host_info_t)&amp;vmstat, &amp;count) != KERN_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> wireMem = vmstat.wire_count * pagesize;</span><br><span class="line">    <span class="keyword">int</span> activeMem = vmstat.active_count * pagesize;</span><br><span class="line">    <span class="keyword">return</span> wireMem + activeMem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¾å¤‡å¯ç”¨çš„å†…å­˜"><a href="#è®¾å¤‡å¯ç”¨çš„å†…å­˜" class="headerlink" title="è®¾å¤‡å¯ç”¨çš„å†…å­˜"></a>è®¾å¤‡å¯ç”¨çš„å†…å­˜</h3><p>è·å–å½“å‰è®¾å¤‡å¯ç”¨çš„ Memory</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">uint64_t</span>)availableMemory &#123;</span><br><span class="line">    <span class="keyword">vm_statistics64_data_t</span> vmStats;</span><br><span class="line">    <span class="keyword">mach_msg_type_number_t</span> infoCount = HOST_VM_INFO_COUNT;</span><br><span class="line">    <span class="keyword">kern_return_t</span> kernReturn = host_statistics(mach_host_self(),</span><br><span class="line">                                               HOST_VM_INFO,</span><br><span class="line">                                               (<span class="keyword">host_info_t</span>)&amp;vmStats,</span><br><span class="line">                                               &amp;infoCount);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (kernReturn != KERN_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">return</span> NSNotFound;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> vm_page_size * (vmStats.free_count + vmStats.inactive_count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯»è€…å¯èƒ½ä¼šçœ‹åˆ°æœ‰äº›ä»£ç ä¼šä½¿ç”¨ vm_statistics_data_t ç»“æ„ä½“ï¼Œä½†æ˜¯è¿™ä¸ªç»“æ„ä½“æ˜¯32ä½æœºå™¨çš„ï¼Œéšç€ Apple é€æ¸æ”¾å¼ƒå¯¹32ä½åº”ç”¨çš„æ”¯æŒï¼Œæ‰€ä»¥å»ºè®®è¯»è€…è¿˜æ˜¯ä½¿ç”¨ vm_statistics64_data_t 64ä½çš„ç»“æ„ä½“ã€‚</p>
]]></content>
      <categories>
        <category>APM</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-avspeechsynthesizeræ–‡å­—è½¬è¯­éŸ³</title>
    <url>/essay/AVFoundation/AVFoundation-avspeechsynthesizer%E6%96%87%E5%AD%97%E8%BD%AC%E8%AF%AD%E9%9F%B3/</url>
    <content><![CDATA[<h2 id="AVSpeechSynthesizer-æ–‡å­—è½¬è¯­éŸ³"><a href="#AVSpeechSynthesizer-æ–‡å­—è½¬è¯­éŸ³" class="headerlink" title="AVSpeechSynthesizer æ–‡å­—è½¬è¯­éŸ³"></a>AVSpeechSynthesizer æ–‡å­—è½¬è¯­éŸ³</h2><blockquote>
<p>  ç®€å•ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">AVSpeechSynthesizer</span> *synthesizer = [<span class="built_in">AVSpeechSynthesizer</span> new];</span><br><span class="line"><span class="built_in">AVSpeechUtterance</span> * utterance = [[<span class="built_in">AVSpeechUtterance</span> alloc] initWithString:<span class="string">@"éœ€è¦è½¬åŒ–çš„æ–‡å­—"</span>];</span><br><span class="line"><span class="comment">//è¯­éŸ³åˆæˆå™¨ä¼šç”ŸæˆéŸ³é¢‘</span></span><br><span class="line">[synthesizer speakUtterance:utterance];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æŒ‡å®šå£°éŸ³ï¼š</p>
</blockquote>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è®¾ç½®è¯­è¨€ç±»åˆ«ï¼ˆä¸èƒ½è¢«è¯†åˆ«ï¼Œè¿”å›å€¼ä¸ºnilï¼‰</span></span><br><span class="line"><span class="built_in">AVSpeechSynthesisVoice</span> *voice = [<span class="built_in">AVSpeechSynthesisVoice</span> voiceWithLanguage:<span class="string">@"en-US"</span>];</span><br><span class="line">utterance.voice = voiceType;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¯­é€Ÿï¼š</p>
</blockquote>
<pre><code class="objc"><span class="comment">//è®¾ç½®è¯­é€Ÿå¿«æ…¢</span>
utterance.rate *= <span class="number">0.5</span>;    
</code></pre>
<blockquote>
<p>é˜Ÿåˆ—ä¸­æ’å…¥è¯­éŸ³</p>
</blockquote>
<p>ä½¿ç”¨ <a href="https://github.com/quentinhayot/QHSpeechSynthesizerQueue" target="_blank" rel="noopener">https://github.com/quentinhayot/QHSpeechSynthesizerQueue</a></p>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-äººè„¸è¯†åˆ«</title>
    <url>/essay/AVFoundation/AVFoundation-%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB/</url>
    <content><![CDATA[<blockquote>
<p>Core Imageæ¡†æ¶ä¸­å®šä¹‰äº†CIDetectorå’ŒCUFaceFeatureï¼Œå®ƒä»¬ä½¿ç”¨èµ·æ¥æä¾›äº†ç®€å•è€Œå¼ºå¤§çš„äººè„¸æ£€æµ‹åŠŸèƒ½<br>ä½†æ˜¯è¿™äº›æ–¹æ³•æ²¡æœ‰é’ˆå¯¹å®æ—¶æ€§è¿›è¡Œä¼˜åŒ–ï¼Œåœ¨AVFoundationä¸­é€šè¿‡ç‰¹å®šçš„AVCaptureOutputç±»å‹çš„ AVCaptureMetadataOutputä¹Ÿå¯ä»¥å®ç°äººè„¸æ£€æµ‹ã€‚</p>
</blockquote>
<p>å½“ä½¿ç”¨äººè„¸æ£€æµ‹æ—¶ï¼Œä¼šè¾“å‡ºä¸€ä¸ªå…·ä½“å­ç±»ç±»å‹AVMetadataFaceObjectã€‚<strong>AVMetadataFaceObject</strong> å®šä¹‰äº†å¤šä¸ªç”¨æˆ·æè¿°è¢«æ£€æµ‹åˆ°çš„äººè„¸çš„å±æ€§ï¼Œæœ€é‡è¦çš„æ˜¯äººè„¸çš„è¾¹ç•Œï¼ˆboundsï¼‰ï¼Œè¿˜ç»™å‡ºäº†ç”¨äºå®šä¹‰æ£€æµ‹äººè„¸å€¾æ–œè§’ï¼ˆroll angleï¼‰è¡¨ç¤ºäººçš„å¤´éƒ¨å‘è‚©è†€æ–¹å‘ä¾§å€¾è§’åº¦ï¼Œåè½¬è§’ï¼ˆyaw angleï¼‰è¡¨ç¤ºäººè„¸ç»•yè½´æ—‹è½¬çš„è§’åº¦ã€‚</p>
<p>é…ç½®ä¼šè¯ä¸ä¹‹å‰ä½¿ç”¨æ‘„åƒå¤´æ‹ç…§ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºæ›´æ¢ä¸€ä¸ªoutputï¼Œå¦‚ï¼š</p>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)setupSessionOutputs:(<span class="built_in">NSError</span> **)error &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.metadataOutput = [[<span class="built_in">AVCaptureMetadataOutput</span> alloc] init];           <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddOutput:<span class="keyword">self</span>.metadataOutput]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.captureSession addOutput:<span class="keyword">self</span>.metadataOutput];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æŒ‡å®šå¯¹è±¡è¾“å‡ºçš„å…ƒæ•°æ®ç±»å‹ï¼ŒAV Foundationæ”¯æŒå¤šç§ç±»å‹ è¿™é‡Œé™åˆ¶ä½¿ç”¨äººè„¸å…ƒæ•°æ®</span></span><br><span class="line">        <span class="built_in">NSArray</span> *metadataObjectTypes = @[<span class="built_in">AVMetadataObjectTypeFace</span>];         <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">self</span>.metadataOutput.metadataObjectTypes = metadataObjectTypes;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//äººè„¸æ£€æµ‹ç”¨åˆ°çš„ç¡¬ä»¶åŠ é€Ÿï¼Œè€Œä¸”è®¸å¤šé‡è¦çš„ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ï¼Œä¸€èˆ¬æŒ‡å®šä¸»çº¿ç¨‹</span></span><br><span class="line">        <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</span><br><span class="line">        <span class="comment">//æŒ‡å®šAVCaptureMetadataOutputObjectsDelegate</span></span><br><span class="line">        [<span class="keyword">self</span>.metadataOutput setMetadataObjectsDelegate:<span class="keyword">self</span>                <span class="comment">// 4</span></span><br><span class="line">                                                  queue:mainQueue];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                                                                <span class="comment">// 5</span></span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedDescriptionKey</span>:</span><br><span class="line">                                           <span class="string">@"Failed to still image output."</span>&#125;;</span><br><span class="line">            *error = [<span class="built_in">NSError</span> errorWithDomain:THCameraErrorDomain</span><br><span class="line">                                         code:THCameraErrorFailedToAddOutput</span><br><span class="line">                                     userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AVCaptureMetadataOutputObjectsDelegate éœ€è¦å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput</span><br><span class="line">didOutputMetadataObjects:(<span class="built_in">NSArray</span> *)metadataObjects</span><br><span class="line">       fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç®€å•è¾“å‡ºä¸€äº›AVMetadataFaceObjectæ•°æ®</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">AVMetadataFaceObject</span> *face <span class="keyword">in</span> metadataObjects) &#123;                   <span class="comment">// 2</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Face detected with ID: %li"</span>, (<span class="keyword">long</span>)face.faceID);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Face bounds: %@"</span>, <span class="built_in">NSStringFromCGRect</span>(face.bounds));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†äººè„¸æ•°æ®ä¼ ç»™å§”æ‰˜å¯¹è±¡</span></span><br><span class="line">    [<span class="keyword">self</span>.faceDetectionDelegate didDetectFaces:metadataObjects];            <span class="comment">// 3</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>THFaceDetectionDelegateé•¿è¿™æ ·ï¼š<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">THFaceDetectionDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)didDetectFaces:(<span class="built_in">NSArray</span> *)faces;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>è·å–åˆ°AVMetadataFaceObject åï¼Œå°†äººè„¸æ•°æ®å¯è§†åŒ–ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)didDetectFaces:(<span class="built_in">NSArray</span> *)faces &#123;</span><br><span class="line">    <span class="comment">//å°†è®¾å¤‡åæ ‡ç©ºé—´è½¬æ¢ä¸ºè§†å›¾ç©ºé—´å¯¹è±¡é›†åˆ</span></span><br><span class="line">    <span class="built_in">NSArray</span> *transformedFaces = [<span class="keyword">self</span> transformedFacesFromFaces:faces];</span><br><span class="line">    <span class="comment">//faceLayers ä¿å­˜äººè„¸æ•°æ®å¯¹åº”çš„layer</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *lostFaces = [<span class="keyword">self</span>.faceLayers.allKeys mutableCopy];      <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">AVMetadataFaceObject</span> *face <span class="keyword">in</span> transformedFaces) &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤å·²ä¸å­˜åœ¨çš„äººè„¸ï¼Œæ·»åŠ æ–°çš„äººè„¸</span></span><br><span class="line">        <span class="built_in">NSNumber</span> *faceID = @(face.faceID);                                  <span class="comment">// 2</span></span><br><span class="line">		[lostFaces removeObject:faceID];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">CALayer</span> *layer = [<span class="keyword">self</span>.faceLayers objectForKey:faceID];             <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">if</span> (!layer) &#123;</span><br><span class="line">            <span class="comment">// no layer for faceID, create new face layer</span></span><br><span class="line">            layer = [<span class="keyword">self</span> makeFaceLayer];                                   <span class="comment">// 4</span></span><br><span class="line">            [<span class="keyword">self</span>.overlayLayer addSublayer:layer];</span><br><span class="line">            <span class="keyword">self</span>.faceLayers[faceID] = layer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        layer.transform = <span class="built_in">CATransform3DIdentity</span>;                            <span class="comment">// 1</span></span><br><span class="line">        layer.frame = face.bounds;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä¿®æ”¹äººè„¸çš„å€¾æ–œè§’</span></span><br><span class="line">        <span class="keyword">if</span> (face.hasRollAngle) &#123;</span><br><span class="line">            <span class="built_in">CATransform3D</span> t = [<span class="keyword">self</span> transformForRollAngle:face.rollAngle];  <span class="comment">// 2</span></span><br><span class="line">            layer.transform = <span class="built_in">CATransform3DConcat</span>(layer.transform, t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®æ”¹äººè„¸çš„åè½¬è§’</span></span><br><span class="line">        <span class="keyword">if</span> (face.hasYawAngle) &#123;</span><br><span class="line">            <span class="built_in">CATransform3D</span> t = [<span class="keyword">self</span> transformForYawAngle:face.yawAngle];    <span class="comment">// 4</span></span><br><span class="line">            layer.transform = <span class="built_in">CATransform3DConcat</span>(layer.transform, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSNumber</span> *faceID <span class="keyword">in</span> lostFaces) &#123;                                   <span class="comment">// 6</span></span><br><span class="line">        <span class="built_in">CALayer</span> *layer = [<span class="keyword">self</span>.faceLayers objectForKey:faceID];</span><br><span class="line">        [layer removeFromSuperlayer];</span><br><span class="line">        [<span class="keyword">self</span>.faceLayers removeObjectForKey:faceID];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†è®¾å¤‡åæ ‡ç©ºé—´è½¬æ¢ä¸ºè§†å›¾ç©ºé—´å¯¹è±¡é›†åˆ</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)transformedFacesFromFaces:(<span class="built_in">NSArray</span> *)faces &#123;                   <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *transformedFaces = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">AVMetadataObject</span> *face <span class="keyword">in</span> faces) &#123;</span><br><span class="line">        <span class="built_in">AVMetadataObject</span> *transformedFace =                                 <span class="comment">// 3</span></span><br><span class="line">            [<span class="keyword">self</span>.previewLayer transformedMetadataObjectForMetadataObject:face];</span><br><span class="line">        [transformedFaces addObject:transformedFace];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformedFaces;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CALayer</span> *)makeFaceLayer &#123;</span><br><span class="line">    <span class="built_in">CALayer</span> *layer = [<span class="built_in">CALayer</span> layer];</span><br><span class="line">    layer.borderWidth = <span class="number">5.0</span>f;</span><br><span class="line">    layer.borderColor =</span><br><span class="line">        [<span class="built_in">UIColor</span> colorWithRed:<span class="number">0.188</span> green:<span class="number">0.517</span> blue:<span class="number">0.877</span> alpha:<span class="number">1.000</span>].CGColor;</span><br><span class="line">    <span class="keyword">return</span> layer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rotate around Z-axis</span></span><br><span class="line">- (<span class="built_in">CATransform3D</span>)transformForRollAngle:(<span class="built_in">CGFloat</span>)rollAngleInDegrees &#123;        <span class="comment">// 3</span></span><br><span class="line">    <span class="built_in">CGFloat</span> rollAngleInRadians = THDegreesToRadians(rollAngleInDegrees);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CATransform3DMakeRotation</span>(rollAngleInRadians, <span class="number">0.0</span>f, <span class="number">0.0</span>f, <span class="number">1.0</span>f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rotate around Y-axis</span></span><br><span class="line">- (<span class="built_in">CATransform3D</span>)transformForYawAngle:(<span class="built_in">CGFloat</span>)yawAngleInDegrees &#123;          <span class="comment">// 5</span></span><br><span class="line">    <span class="built_in">CGFloat</span> yawAngleInRadians = THDegreesToRadians(yawAngleInDegrees);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CATransform3D</span> yawTransform =</span><br><span class="line">        <span class="built_in">CATransform3DMakeRotation</span>(yawAngleInRadians, <span class="number">0.0</span>f, <span class="number">-1.0</span>f, <span class="number">0.0</span>f);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CATransform3DConcat</span>(yawTransform, [<span class="keyword">self</span> orientationTransform]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-AVPlayerè§†é¢‘æ’­æ”¾</title>
    <url>/essay/AVFoundation/AVFoundation-AVPlayer%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE/</url>
    <content><![CDATA[<blockquote>
<p>AV Playeræ˜¯ä¸€ä¸ªç”¨æ¥æ’­æ”¾ç»™äºˆæ—¶é—´çš„è§†å¬åª’ä½“çš„æ§åˆ¶å™¨å¯¹è±¡ã€‚å°†è§†é¢‘èµ„æºå¯¼å‡ºåˆ°ç•Œé¢éœ€è¦ä½¿ç”¨AVPlayerLayerç±»ï¼›AVPlayeråªç®¡ç†ä¸€ä¸ªå•ç‹¬èµ„æºçš„æ’­æ”¾ï¼Œå½“éœ€è¦æ’­æ”¾å¤šä¸ªéŸ³é¢‘èµ„æºå¯ä»¥ä½¿ç”¨å­ç±»AVQueuePlayer</p>
</blockquote>
<blockquote>
<p>ä¸éœ€è¦è‡ªå®šä¹‰æ’­æ”¾å™¨çš„æƒ…å†µå¯ä»¥ä½¿ç”¨ <code>MPMoviewPlayerController</code></p>
</blockquote>
<p>å‚è€ƒ <a href="http://www.cnblogs.com/kenshincui/p/4186022.html#avPlayer" target="_blank" rel="noopener">http://www.cnblogs.com/kenshincui/p/4186022.html#avPlayer</a></p>
<h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p><em>ç¤ºä¾‹:</em></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSURL</span> *assetURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"waves"</span> withExtension:<span class="string">@"mp4"</span>];</span><br><span class="line"><span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:assetURL];</span><br><span class="line"><span class="built_in">AVPlayerItem</span> *playeritem = [<span class="built_in">AVPlayerItem</span> playerItemWithAsset:asset];</span><br><span class="line"><span class="keyword">self</span>.player = [<span class="built_in">AVPlayer</span> playerWithPlayerItem:playerItem];</span><br><span class="line"><span class="built_in">AVPlayerLayer</span> *playerLayer = [<span class="built_in">AVPlayer</span> playerLayerWithPlayer:<span class="keyword">self</span>.player];</span><br><span class="line"><span class="comment">//playerLayer.videoGravity=AVLayerVideoGravityResizeAspect;//è§†é¢‘å¡«å……æ¨¡å¼</span></span><br><span class="line">[<span class="keyword">self</span>.view.layer addSubLayer:playerLayer];</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"><a href="#å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶" class="headerlink" title="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"></a>å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶</h3><h2 id="ç›‘å¬æ’­æ”¾çŠ¶æ€"><a href="#ç›‘å¬æ’­æ”¾çŠ¶æ€" class="headerlink" title="ç›‘å¬æ’­æ”¾çŠ¶æ€"></a>ç›‘å¬æ’­æ”¾çŠ¶æ€</h2><blockquote>
<p>ç›‘å¬AVPlayerItemçš„<em>status</em>å±æ€§ï¼Œæ’­æ”¾é¡¹å¼€å§‹æ—¶statusä¸º <code>AVPlayerItemStatusUnknow</code>ï¼Œå½“çŠ¶æ€æ”¹å˜ä¸º <code>AVPlayerItemStatusReadyToPlay</code>æ‰å¯ä»¥å¼€å§‹æ’­æ”¾ï¼Œåªæœ‰å¤„äºè¿™ä¸ªçŠ¶æ€æ—¶æ‰èƒ½è·å¾—è§†é¢‘æ—¶é•¿ç­‰ä¿¡æ¯ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç›‘æ§çŠ¶æ€å±æ€§ï¼Œæ³¨æ„AVPlayerä¹Ÿæœ‰ä¸€ä¸ªstatuså±æ€§ï¼Œé€šè¿‡ç›‘æ§å®ƒçš„statusä¹Ÿå¯ä»¥è·å¾—æ’­æ”¾çŠ¶æ€</span></span><br><span class="line">    [playerItem addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"status"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">-(<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context&#123;</span><br><span class="line">    <span class="built_in">AVPlayerItem</span> *playerItem=object;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@"status"</span>]) &#123;</span><br><span class="line">        <span class="built_in">AVPlayerStatus</span> status= [[change objectForKey:<span class="string">@"new"</span>] intValue];</span><br><span class="line">        <span class="keyword">if</span>(status==<span class="built_in">AVPlayerStatusReadyToPlay</span>)&#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"æ­£åœ¨æ’­æ”¾...ï¼Œè§†é¢‘æ€»é•¿åº¦:%.2f"</span>,<span class="built_in">CMTimeGetSeconds</span>(playerItem.duration));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›‘æ§ç½‘ç»œåŠ è½½æƒ…å†µå±æ€§"><a href="#ç›‘æ§ç½‘ç»œåŠ è½½æƒ…å†µå±æ€§" class="headerlink" title="ç›‘æ§ç½‘ç»œåŠ è½½æƒ…å†µå±æ€§"></a>ç›‘æ§ç½‘ç»œåŠ è½½æƒ…å†µå±æ€§</h2><blockquote>
<p>ç›‘å¬AVPlayerItemçš„<em>loadedTimeRanges</em>å±æ€§ï¼Œå½“loadedTimeRangesçš„æ”¹å˜æ—¶ï¼ˆæ¯ç¼“å†²ä¸€éƒ¨åˆ†æ•°æ®å°±ä¼šæ›´æ–°æ­¤å±æ€§ï¼‰å¯ä»¥è·å¾—æœ¬æ¬¡ç¼“å†²åŠ è½½çš„è§†é¢‘èŒƒå›´ï¼ˆåŒ…å«èµ·å§‹æ—¶é—´ã€æœ¬æ¬¡åŠ è½½æ—¶é•¿ï¼‰ï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥å®æ—¶è·å¾—ç¼“å†²æƒ…å†µã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç›‘æ§ç½‘ç»œåŠ è½½æƒ…å†µå±æ€§</span></span><br><span class="line">    [playerItem addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"loadedTimeRanges"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:<span class="literal">nil</span>];</span><br><span class="line"> </span><br><span class="line">-(<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context&#123;</span><br><span class="line">    <span class="built_in">AVPlayerItem</span> *playerItem=object;</span><br><span class="line">	<span class="keyword">if</span>([keyPath isEqualToString:<span class="string">@"loadedTimeRanges"</span>])&#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *array=playerItem.loadedTimeRanges;</span><br><span class="line">        <span class="built_in">CMTimeRange</span> timeRange = [array.firstObject <span class="built_in">CMTimeRangeValue</span>];<span class="comment">//æœ¬æ¬¡ç¼“å†²æ—¶é—´èŒƒå›´</span></span><br><span class="line">        <span class="keyword">float</span> startSeconds = <span class="built_in">CMTimeGetSeconds</span>(timeRange.start);</span><br><span class="line">        <span class="keyword">float</span> durationSeconds = <span class="built_in">CMTimeGetSeconds</span>(timeRange.duration);</span><br><span class="line">        <span class="built_in">NSTimeInterval</span> totalBuffer = startSeconds + durationSeconds;<span class="comment">//ç¼“å†²æ€»é•¿åº¦</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å…±ç¼“å†²ï¼š%.2f"</span>,totalBuffer);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ—¶é—´ç›‘å¬"><a href="#æ—¶é—´ç›‘å¬" class="headerlink" title="æ—¶é—´ç›‘å¬"></a>æ—¶é—´ç›‘å¬</h2><blockquote>
<p>AVPlayeræä¾›äº†ä¸¤ç§æ—¶é—´ç›‘å¬æ–¹æ³•</p>
</blockquote>
<h3 id="å®šæœŸç›‘å¬"><a href="#å®šæœŸç›‘å¬" class="headerlink" title="å®šæœŸç›‘å¬"></a>å®šæœŸç›‘å¬</h3><blockquote>
<p>ä½¿ç”¨<code>- (id)addPeriodicTimeObserverForInterval:(CMTime)interval queue:(nullable dispatch_queue_t)queue usingBlock:(void (^)(CMTime time))block;</code></p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ¯ç§’</span></span><br><span class="line"><span class="built_in">CMTime</span> interval = <span class="built_in">CMTimeMake</span>(<span class="number">1.0</span>, <span class="number">1.0</span>);              <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Main dispatch queue</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_main_queue();                     <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Create callback block for time observer</span></span><br><span class="line">__<span class="keyword">weak</span> THPlayerController *weakSelf = <span class="keyword">self</span>;                             <span class="comment">// 3</span></span><br><span class="line"><span class="keyword">void</span> (^callback)(<span class="built_in">CMTime</span> time) = ^(<span class="built_in">CMTime</span> time) &#123;</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> currentTime = <span class="built_in">CMTimeGetSeconds</span>(time);</span><br><span class="line">    <span class="built_in">NSTimeInterval</span> duration = <span class="built_in">CMTimeGetSeconds</span>(weakSelf.playerItem.duration);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"å½“å‰å·²ç»æ’­æ”¾%.2fs."</span>, currentTime);  <span class="comment">// 4</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add observer and store pointer for future use</span></span><br><span class="line"><span class="keyword">self</span>.timeObserver =                                                     <span class="comment">// 5</span></span><br><span class="line">    [<span class="keyword">self</span>.player addPeriodicTimeObserverForInterval:interval</span><br><span class="line">                                              queue:queue</span><br><span class="line">                                         usingBlock:callback];</span><br></pre></td></tr></table></figure>
<h3 id="è¾¹ç•Œæ—¶é—´ç›‘å¬"><a href="#è¾¹ç•Œæ—¶é—´ç›‘å¬" class="headerlink" title="è¾¹ç•Œæ—¶é—´ç›‘å¬"></a>è¾¹ç•Œæ—¶é—´ç›‘å¬</h3><blockquote>
<p>ä½¿ç”¨ <code>- (id)addBoundaryTimeObserverForTimes:(NSArray&lt;NSValue *&gt; *)times queue:(nullable dispatch_queue_t)queue usingBlock:(void (^)(void))block;</code></p>
</blockquote>
<ul>
<li>times : CMTimeå€¼ç»„æˆçš„NSArrayæ•°ç»„ï¼Œå®šä¹‰äº†éœ€è¦é€šçŸ¥çš„è¾¹ç•Œç‚¹</li>
<li>queue ï¼š è°ƒåº¦é˜Ÿåˆ—ï¼ŒæŒ‡å®šNULLç­‰åŒè®¾ç½®ä¸»é˜Ÿåˆ—</li>
<li>block ï¼š å›è°ƒå—</li>
</ul>
<h2 id="ç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥"><a href="#ç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥" class="headerlink" title="ç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥"></a>ç›‘å¬æ’­æ”¾å®Œæˆé€šçŸ¥</h2><blockquote>
<p>æ³¨å†Œ <code>AVPlayerItemDidPlayToEndTimeNotification</code>çš„é€šçŸ¥</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">    <span class="comment">//ç»™AVPlayerItemæ·»åŠ æ’­æ”¾å®Œæˆé€šçŸ¥</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(playbackFinished:) name:<span class="built_in">AVPlayerItemDidPlayToEndTimeNotification</span> object:<span class="keyword">self</span>.player.currentItem];</span><br><span class="line">   </span><br><span class="line">-(<span class="keyword">void</span>)playbackFinished:(<span class="built_in">NSNotification</span> *)notification&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"è§†é¢‘æ’­æ”¾å®Œæˆ."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾"><a href="#ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾" class="headerlink" title="ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾"></a>ç”Ÿæˆè§†é¢‘ç¼©ç•¥å›¾</h2><blockquote>
<p>ä½¿ç”¨ <code>AVAssetImageGenerator</code>ç±»å¯ä»¥ä» AVAssetè§†é¢‘ä¸­æå–å›¾ç‰‡ã€‚</p>
</blockquote>
<p><em>AVAssetImageGenerator</em>æœ‰ä¸¤ä¸ªå¯ä»¥æ£€ç´¢å›¾ç‰‡çš„æ–¹æ³•ï¼š</p>
<ul>
<li><code>- (void)generateCGImagesAsynchronouslyForTimes:(NSArray&lt;NSValue *&gt; *)requestedTimes completionHandler:(AVAssetImageGeneratorCompletionHandler)handler;</code><ul>
<li>ç”Ÿæˆä¸€ç»„å›¾ç‰‡</li>
</ul>
</li>
<li><code>- (nullable CGImageRef)copyCGImageAtTime:(CMTime)requestedTime actualTime:(nullable CMTime *)actualTime error:(NSError * __nullable * __nullable)outError CF_RETURNS_RETAINED;</code><ul>
<li>åœ¨æŒ‡å®šæ—¶é—´æ•æ‰å›¾ç‰‡</li>
</ul>
</li>
</ul>
<p><em>ç”Ÿæˆä¸€ç»„å›¾ç‰‡ç¤ºä¾‹ï¼š</em></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">self</span>.imageGenerator =                                                   <span class="comment">// 1</span></span><br><span class="line">       [<span class="built_in">AVAssetImageGenerator</span> assetImageGeneratorWithAsset:<span class="keyword">self</span>.asset];</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//é»˜è®¤æƒ…å†µä¸‹æ•æ‰çš„å›¾ç‰‡éƒ½æ˜¯åŸå§‹å°ºå¯¸ï¼Œè®¾ç½®(200.0f, 0.0f)å¯ä»¥è®©å›¾ç‰‡å®½åº¦å›ºå®šï¼Œé«˜åº¦è‡ªé€‚åº”</span></span><br><span class="line">   <span class="keyword">self</span>.imageGenerator.maximumSize = <span class="built_in">CGSizeMake</span>(<span class="number">200.0</span>f, <span class="number">0.0</span>f);             <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">CMTime</span> duration = <span class="keyword">self</span>.asset.duration;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”Ÿæˆè§†é¢‘æ•æ‰ä½ç½®çš„CMTimeé›†åˆ</span></span><br><span class="line">   <span class="built_in">NSMutableArray</span> *times = [<span class="built_in">NSMutableArray</span> array];                         <span class="comment">// 3</span></span><br><span class="line">   <span class="built_in">CMTimeValue</span> increment = duration.value / <span class="number">20</span>;</span><br><span class="line">   <span class="built_in">CMTimeValue</span> currentValue = <span class="number">2.0</span> * duration.timescale;</span><br><span class="line">   <span class="keyword">while</span> (currentValue &lt;= duration.value) &#123;</span><br><span class="line">       <span class="built_in">CMTime</span> time = <span class="built_in">CMTimeMake</span>(currentValue, duration.timescale);</span><br><span class="line">       [times addObject:[<span class="built_in">NSValue</span> valueWithCMTime:time]];</span><br><span class="line">       currentValue += increment;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   __block <span class="built_in">NSUInteger</span> imageCount = times.count;                            <span class="comment">// 4</span></span><br><span class="line">   __block <span class="built_in">NSMutableArray</span> *images = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">   <span class="built_in">AVAssetImageGeneratorCompletionHandler</span> handler;                         <span class="comment">// 5</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">//requestedTimeï¼šè¯·æ±‚çš„æ—¶é—´å¯¹åº”timesæ•°ç»„ä¸­çš„å€¼ï¼›</span></span><br><span class="line">   <span class="comment">//imageRef :ç”Ÿæˆçš„CGImageRefï¼Œè‹¥è¯¥æ—¶é—´ç‚¹æ²¡æœ‰å›¾ç‰‡åˆ™ä¸ºNULL</span></span><br><span class="line">   <span class="comment">//actualTime:å›¾ç‰‡å®é™…ç”Ÿæˆçš„æ—¶é—´</span></span><br><span class="line">   <span class="comment">//result:è¡¨ç¤ºç”Ÿæˆå›¾ç‰‡å¤±è´¥è¿˜æ˜¯æˆåŠŸ</span></span><br><span class="line">   handler = ^(<span class="built_in">CMTime</span> requestedTime,</span><br><span class="line">               <span class="built_in">CGImageRef</span> imageRef,</span><br><span class="line">               <span class="built_in">CMTime</span> actualTime,</span><br><span class="line">               <span class="built_in">AVAssetImageGeneratorResult</span> result,</span><br><span class="line">               <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (result == <span class="built_in">AVAssetImageGeneratorSucceeded</span>) &#123;                     <span class="comment">// 6</span></span><br><span class="line">           <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</span><br><span class="line">           <span class="keyword">id</span> thumbnail =</span><br><span class="line">               [THThumbnail thumbnailWithImage:image time:actualTime];</span><br><span class="line">           [images addObject:thumbnail];</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="built_in">NSLog</span>(<span class="string">@"Error: %@"</span>, [error localizedDescription]);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If the decremented image count is at 0, we're all done.</span></span><br><span class="line">       <span class="keyword">if</span> (--imageCount == <span class="number">0</span>) &#123;                                            <span class="comment">// 7</span></span><br><span class="line">           <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               <span class="built_in">NSString</span> *name = THThumbnailsGeneratedNotification;</span><br><span class="line">               <span class="built_in">NSNotificationCenter</span> *nc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">               [nc postNotificationName:name object:images];</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   [<span class="keyword">self</span>.imageGenerator generateCGImagesAsynchronouslyForTimes:times       <span class="comment">// 8</span></span><br><span class="line">                                             completionHandler:handler];</span><br></pre></td></tr></table></figure>
<h2 id="æ˜¾ç¤ºå­—å¹•ï¼ˆè§†é¢‘è‡ªå¸¦ï¼‰"><a href="#æ˜¾ç¤ºå­—å¹•ï¼ˆè§†é¢‘è‡ªå¸¦ï¼‰" class="headerlink" title="æ˜¾ç¤ºå­—å¹•ï¼ˆè§†é¢‘è‡ªå¸¦ï¼‰"></a>æ˜¾ç¤ºå­—å¹•ï¼ˆè§†é¢‘è‡ªå¸¦ï¼‰</h2><blockquote>
<p>æ˜¾ç¤ºå­—å¹•éœ€è¦ç”¨åˆ°<code>AVMediaSelectionGroup</code>å’Œ<code>AVMediaSelectionOption</code>ä¸¤ä¸ªç±»</p>
</blockquote>
<ol>
<li>åˆå§‹åŒ– <em>AVAsset</em> çš„æ—¶å€™åŠ ä¸Š <strong><em>availableMediaCharacteristicsWithMediaSelectionOptions</em></strong> å±æ€§<ul>
<li><em>AVMediaSelectionOption</em>çš„è¯¥å±æ€§ä¼šè¿”å›ä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²çš„æ•°ç»„,è¿™äº›å­—ç¬¦ä¸²è¡¨ç¤ºå¯ç”¨çš„åª’ä½“ç‰¹æ€§<ul>
<li>AVMediaCharacteristicLegible ï¼ˆå­—å¹•æˆ–è€…éšè—å¼å­—å¹•ï¼‰</li>
<li>AVMediaCharacteristicAudible ï¼ˆéŸ³é¢‘ï¼‰</li>
<li>AVMediaCharacteristicVisual ï¼ˆå­—å¹•ï¼‰ </li>
</ul>
</li>
</ul>
</li>
<li><p>è¯·æ±‚å¯ç”¨çš„åª’ä½“ç‰¹æ€§æ•°æ®åï¼Œè°ƒç”¨ <em>AVAsset</em> çš„ <strong><em>mediaSelectionGroupForMediaCharacteristicï¼š</em></strong>æ–¹æ³•ä¸ºå…¶ä¼ é€’éœ€è¦çš„åª’ä½“ç‰¹æ€§ï¼Œä¼šè¿”å› <em>AVMediaSelectionGroup</em> ï¼Œè¡¨ç¤ºåŒ…å«çš„å¤‡ç”¨åª’ä½“è½¨é“</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">  <span class="built_in">NSString</span> *mc = <span class="built_in">AVMediaCharacteristicLegible</span>;                            <span class="comment">// 1</span></span><br><span class="line">  <span class="built_in">AVMediaSelectionGroup</span> *group =</span><br><span class="line">      [<span class="keyword">self</span>.asset mediaSelectionGroupForMediaCharacteristic:mc];          <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">if</span> (group) &#123;</span><br><span class="line">      <span class="built_in">NSMutableArray</span> *subtitles = [<span class="built_in">NSMutableArray</span> array];                 <span class="comment">// 3</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="built_in">AVMediaSelectionOption</span> *option <span class="keyword">in</span> group.options) &#123;</span><br><span class="line">          <span class="built_in">NSLog</span>(<span class="string">@" %@ "</span>,option.displayName);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//è¾“å‡º ï¼Œè¡¨ç¤ºå¤šä¸ªå­—å¹•è½¨é“</span></span><br><span class="line"><span class="string">@"English"</span></span><br><span class="line"><span class="string">@"English Forced"</span></span><br><span class="line"><span class="string">@"Italian"</span></span><br><span class="line"><span class="string">@"Italian Forced"</span></span><br><span class="line"><span class="string">@"Portuguese"</span></span><br><span class="line"><span class="string">@"Portuguese Forced"</span></span><br><span class="line"><span class="string">@"Russian"</span></span><br><span class="line"><span class="string">@"Russian Forced"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ˜¾ç¤ºå­—å¹•ï¼Œé€šè¿‡è°ƒç”¨ <em>AVPlayerItem</em> çš„ <strong><em>selectMediaOptionï¼šinMediaSelectionGroupï¼š</em></strong>æ–¹æ³•ã€‚</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)subtitleSelected:(<span class="built_in">NSString</span> *)subtitle &#123;</span><br><span class="line">   <span class="built_in">NSString</span> *mc = <span class="built_in">AVMediaCharacteristicLegible</span>;</span><br><span class="line">   <span class="built_in">AVMediaSelectionGroup</span> *group =</span><br><span class="line">       [<span class="keyword">self</span>.asset mediaSelectionGroupForMediaCharacteristic:mc];          <span class="comment">// 1</span></span><br><span class="line">   <span class="built_in">BOOL</span> selected = <span class="literal">NO</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="built_in">AVMediaSelectionOption</span> *option <span class="keyword">in</span> group.options) &#123;</span><br><span class="line">       <span class="keyword">if</span> ([option.displayName isEqualToString:subtitle]) &#123;</span><br><span class="line">           [<span class="keyword">self</span>.playerItem selectMediaOption:option                       <span class="comment">// 2</span></span><br><span class="line">                        inMediaSelectionGroup:group];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS æ€§èƒ½ç›‘æ§4 ç½‘ç»œç›‘æ§-NSURLProtocol</title>
    <url>/essay/APM/iOSAPM4/</url>
    <content><![CDATA[<p>åœ¨iOSä¸­è‹¹æœæä¾›äº†NSURLConnectionã€NSURLSessionç­‰ä¼˜ç§€çš„ç½‘è·¯æ¥å£ä¾›æˆ‘ä»¬æ¥è°ƒç”¨ï¼Œå¼€æºç¤¾åŒºä¹Ÿæœ‰å¾ˆå¤šçš„å¼€æºåº“ï¼Œå¦‚ä¹‹å‰çš„ASIHttpRequest ç°åœ¨çš„AFNetworkingå’ŒAlamofireï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»çš„NSURLProtocolï¼Œéƒ½å¯ä»¥ç›‘æ§åˆ°è¿™äº›å¼€æºåº“çš„ç½‘ç»œè¯·æ±‚ã€‚</p>
<h3 id="NSURLProtocol"><a href="#NSURLProtocol" class="headerlink" title="NSURLProtocol"></a>NSURLProtocol</h3><p>NSURLProtocolæ˜¯iOSç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­å¾ˆå¼ºçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»§æ‰¿å­ç±»åŒ–æ¥æ‹¦æˆªAPPä¸­çš„ç½‘ç»œè¯·æ±‚ã€‚</p>
<p>ä¸¾å‡ ä¸ªä¾‹å­ï¼š</p>
<ul>
<li>æˆ‘ä»¬çš„APPå†…çš„æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦å¢åŠ å…¬å…±çš„å¤´ï¼Œåƒè¿™ç§æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥é€šè¿‡NSURLProtocolæ¥å®ç°ï¼Œå½“ç„¶å®ç°çš„æ–¹å¼æœ‰å¾ˆå¤šç§</li>
<li>æˆ‘ä»¬éœ€è¦å°†APPæŸä¸ªAPIè¿›è¡Œä¸€äº›è®¿é—®çš„ç»Ÿè®¡</li>
<li>æˆ‘ä»¬éœ€è¦ç»Ÿè®¡APPå†…çš„ç½‘ç»œè¯·æ±‚å¤±è´¥ç‡</li>
</ul>
<p>ç­‰ç­‰ï¼Œéƒ½å¯ä»¥ç”¨åˆ° NSURLProtocolæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬éœ€è¦å­ç±»åŒ–æ‰èƒ½å®ç°ç½‘ç»œè¯·æ±‚æ‹¦æˆªã€‚</p>
<a id="more"></a>
<h3 id="æ–°å»º-NSURLProtocolçš„å­ç±»"><a href="#æ–°å»º-NSURLProtocolçš„å­ç±»" class="headerlink" title="æ–°å»º NSURLProtocolçš„å­ç±»"></a>æ–°å»º NSURLProtocolçš„å­ç±»</h3><p>æ–°å»º NSURLProtocolçš„å­ç±» å¹¶ä¸”éœ€è¦é‡å†™ä¸€äº›æ–¹æ³• </p>
<h3 id="é‡å†™-canâ€‹Initâ€‹Withâ€‹Request"><a href="#é‡å†™-canâ€‹Initâ€‹Withâ€‹Request" class="headerlink" title="é‡å†™ canâ€‹Initâ€‹Withâ€‹Request :"></a>é‡å†™ <code>canâ€‹Initâ€‹Withâ€‹Request</code> :</h3><p>æˆ‘ä»¬éœ€è¦å‘Šè¯‰å®ƒå“ªäº›ç½‘ç»œè¯·æ±‚æ˜¯éœ€è¦æˆ‘ä»¬æ‹¦æˆªçš„ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡æ–¹æ³•canâ€‹Initâ€‹Withâ€‹Request:â€‹æ¥å®ç°çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦æ‹¦æˆªå…¨éƒ¨çš„HTTPå’ŒHTTPSè¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªé€»è¾‘æˆ‘ä»¬å°±å¯ä»¥åœ¨canâ€‹Initâ€‹Withâ€‹Request:â€‹ä¸­æ¥å®šä¹‰</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> éœ€è¦æ§åˆ¶çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param request æ­¤æ¬¡è¯·æ±‚</span></span><br><span class="line"><span class="comment"> @return æ˜¯å¦éœ€è¦ç›‘æ§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (BOOL)canInitWithRequest:(NSURLRequest *)request &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (![request.URL.scheme isEqualToString:@<span class="string">"http"</span>] &amp;&amp;</span><br><span class="line">        ![request.URL.scheme isEqualToString:@<span class="string">"https"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é‡å†™-canonicalRequestForRequest"><a href="#é‡å†™-canonicalRequestForRequest" class="headerlink" title="é‡å†™ canonicalRequestForRequest:"></a>é‡å†™ <code>canonicalRequestForRequest:</code></h3><p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰å½“å‰çš„è¯·æ±‚requestï¼Œé€šè¿‡é‡å†™ canonicalRequestForRequest: æ¥å®ç°ã€‚å½“ç„¶å¦‚æœä¸éœ€è¦è‡ªå®šä¹‰ï¼Œç›´æ¥è¿”å›å°±è¡Œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è®¾ç½®æˆ‘ä»¬è‡ªå·±çš„è‡ªå®šä¹‰è¯·æ±‚</span></span><br><span class="line"><span class="comment"> å¯ä»¥åœ¨è¿™é‡Œç»Ÿä¸€åŠ ä¸Šå¤´ä¹‹ç±»çš„</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param request åº”ç”¨çš„æ­¤æ¬¡è¯·æ±‚</span></span><br><span class="line"><span class="comment"> @return æˆ‘ä»¬è‡ªå®šä¹‰çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (NSURLRequest *)canonicalRequestForRequest:(NSURLRequest *)request &#123;</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±å·²ç»èƒ½å¤Ÿæ‹¦æˆªä½iOSçš„ç½‘ç»œè¯·æ±‚äº† </p>
<h3 id="canâ€‹Initâ€‹Withâ€‹Request-ä¸-canonicalRequestForRequest"><a href="#canâ€‹Initâ€‹Withâ€‹Request-ä¸-canonicalRequestForRequest" class="headerlink" title="canâ€‹Initâ€‹Withâ€‹Request: ä¸ canonicalRequestForRequest"></a><code>canâ€‹Initâ€‹Withâ€‹Request:</code> ä¸ <code>canonicalRequestForRequest</code></h3><p>åœ¨æˆ‘ä»¬ä¸Šå±‚ä¸šåŠ¡è°ƒç”¨ç½‘ç»œè¯·æ±‚çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè°ƒç”¨æˆ‘ä»¬çš„canâ€‹Initâ€‹Withâ€‹Request:æ–¹æ³•ï¼Œè¯¢é—®æ˜¯å¦å¯¹è¯¥è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ¥ç€ä¼šè°ƒç”¨æˆ‘ä»¬çš„canonicalRequestForRequest:æ¥è‡ªå®šä¹‰ä¸€ä¸ªrequestï¼Œæ¥ç€åˆä¼šå»è°ƒç”¨canâ€‹Initâ€‹Withâ€‹Request:è¯¢é—®è‡ªå®šä¹‰çš„requestæ˜¯å¦éœ€è¦å¤„ç†ï¼Œæˆ‘ä»¬åˆè¿”å›YESï¼Œç„¶ååˆå»è°ƒç”¨äº†canonicalRequestForRequest:ï¼Œè¿™æ ·ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªæ­»å¾ªç¯äº†ï¼Œè¿™è‚¯å®šæ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚</p>
<p>æœ‰ä¸ªå¤„ç†æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªå¤„ç†è¿‡çš„requestè¿›è¡Œæ ‡è®°ï¼Œåœ¨åˆ¤æ–­å¦‚æœè¿™ä¸ªrequestå·²ç»å¤„ç†è¿‡äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸å†è¿›è¡Œå¤„ç†ï¼Œè¿™æ ·å°±æœ‰æ•ˆé¿å…äº†æ­»å¾ªç¯</p>
<p>åœ¨æˆ‘ä»¬è‡ªå®šä¹‰requestçš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥è®¾ç½®å¤„ç†æ ‡å¿—</p>
<ul>
<li><p>(NSURLRequest <em>)canonicalRequestForRequest:(NSURLRequest </em>)request {<br>  NSMutableURLRequest *mutableReqeust = [request mutableCopy];<br>  [NSURLProtocol setProperty:@YES</p>
<pre><code>   forKey:PPSHTTP
inRequest:mutableReqeust];
</code></pre><p>  return [mutableReqeust copy];<br>}<br>ç„¶ååœ¨æˆ‘ä»¬çš„è¯¢é—®å¤„ç†æ–¹æ³•ä¸­ï¼Œé€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰å¤„ç†è¿‡çš„æ ‡å¿—ï¼Œæ¥è¿›è¡Œæ‹¦æˆª</p>
</li>
<li><p>(BOOL)canInitWithRequest:(NSURLRequest *)request {</p>
<p>  if (![request.URL.scheme isEqualToString:@â€httpâ€] &amp;&amp;</p>
<pre><code>![request.URL.scheme isEqualToString:@&quot;https&quot;]) {
return NO;
</code></pre><p>  }<br>  //å¦‚æœæ˜¯å·²ç»æ‹¦æˆªè¿‡çš„  å°±æ”¾è¡Œ<br>  if ([NSURLProtocol propertyForKey:PPSHTTP inRequest:request] ) {</p>
<pre><code>return NO;
</code></pre><p>  }<br>  return YES;<br>}<br>è¿™æ ·ï¼Œæˆ‘ä»¬å°±é¿å…äº†æ­»å¾ªç¯</p>
</li>
</ul>
<h3 id="é‡å†™-startLoading-å’Œ-stopLoading"><a href="#é‡å†™-startLoading-å’Œ-stopLoading" class="headerlink" title="é‡å†™ startLoading å’Œ stopLoading"></a>é‡å†™ <code>startLoading</code> å’Œ <code>stopLoading</code></h3><p>æ¥ä¸‹æ¥ï¼Œå°±æ˜¯éœ€è¦å°†è¿™ä¸ªrequestå‘é€å‡ºå»äº†ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬ä¸å¤„ç†è¿™ä¸ªrequestè¯·æ±‚ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‘å‡ºè¿™ä¸ªç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å¤„ç†äº†è¿™ä¸ªè¯·æ±‚ï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è¿›è¡Œå‘é€äº†ã€‚</p>
<p>æˆ‘ä»¬è¦æ‰‹åŠ¨å‘é€è¿™ä¸ªç½‘ç»œè¯·æ±‚ï¼Œéœ€è¦é‡å†™startLoadingæ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startLoading &#123;</span><br><span class="line">    NSURLRequest *request = [[self class] canonicalRequestForRequest:self.request];</span><br><span class="line">    self.connection = [[NSURLConnection alloc] initWithRequest:request delegate:self startImmediately:YES];</span><br><span class="line">    self.pps_request = self.request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬æ‹¦æˆªçš„è¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ªçœŸå®çš„è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ›å»ºè¿™æ ·ä¸€ä¸ªçœŸå®çš„ç½‘ç»œè¯·æ±‚ï¼Œåœ¨ç¬¬äºŒè¡Œä»£ç ä¸­ï¼Œå°†æˆ‘ä»¬è‡ªå®šä¹‰åˆ›å»ºçš„requestå‘äº†å‡ºäº†ï¼Œç¬¬ä¸‰è¡Œæ˜¯ä¸ºäº†ä¿å­˜å½“å‰çš„requestï¼Œä½œä¸ºæˆ‘ä»¬åé¢çš„å¤„ç†å¯¹è±¡ã€‚</p>
<p>å½“ç„¶ï¼Œæœ‰startå°±æœ‰stopï¼Œstopå°±å¾ˆç®€å•äº†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)stopLoading &#123;</span><br><span class="line">    [self.connection cancel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NSURLConnectionDelegate-è½¬å‘"><a href="#NSURLConnectionDelegate-è½¬å‘" class="headerlink" title="NSURLConnectionDelegate è½¬å‘"></a>NSURLConnectionDelegate è½¬å‘</h3><p>åœ¨startLoadingä¸­ï¼Œæˆ‘ä»¬å‘èµ·äº†ä¸€ä¸ªNSURLConnectionçš„è¯·æ±‚ï¼Œå› ä¸ºNSURLProtocolä½¿æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ç½‘ç»œè¯·æ±‚çš„ä¸€ç³»åˆ—æ“ä½œå…¨éƒ¨ä¼ é€’å‡ºå»ï¼Œä¸ç„¶ä¸Šå±‚å°±ä¸çŸ¥é“å½“å‰ç½‘ç»œçš„ä¸€ä¸ªè¯·æ±‚çŠ¶æ€ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå°†è¿™ä¸ªç½‘ç»œçŠ¶æ€ä¼ åˆ°ä¸Šå±‚ï¼Ÿæ¯ä¸ªprotocolæœ‰ä¸€ä¸ªNSURLProtocolClientå®ä¾‹ï¼Œæˆ‘ä»¬å°±é€šè¿‡è¿™ä¸ªclientæ¥ä¼ é€’ã€‚</p>
<p>ä¼ é€’ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œæ— å¤–ä¹å°±æ˜¯ä¼ é€’è¯·æ±‚çš„ä¸€äº›è¿‡ç¨‹ï¼Œæ•°æ®ï¼Œç»“æœç­‰ç­‰ã€‚ å‘èµ·äº†å‘èµ·äº†ä¸€ä¸ªNSURLConnectionçš„è¯·æ±‚ï¼Œå®ç°å®ƒçš„delegateå°±èƒ½å¤ŸçŸ¥é“ç½‘ç»œè¯·æ±‚çš„ä¸€ç³»åˆ—æ“ä½œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - NSURLConnectionDelegate</span></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didFailWithError:(NSError *)error&#123;</span><br><span class="line">    [self.client URLProtocol:self didFailWithError:error];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)connectionShouldUseCredentialStorage:(NSURLConnection *)connection&#123;</span><br><span class="line">    <span class="keyword">return</span> YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge&#123;</span><br><span class="line">    [self.client URLProtocol:self didReceiveAuthenticationChallenge:challenge];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection</span><br><span class="line">didCancelAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge &#123;</span><br><span class="line">    [self.client URLProtocol:self didCancelAuthenticationChallenge:challenge];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - NSURLConnectionDataDelegate</span></span><br><span class="line">-(NSURLRequest *)connection:(NSURLConnection *)connection willSendRequest:(NSURLRequest *)request redirectResponse:(NSURLResponse *)response&#123;</span><br><span class="line">    <span class="keyword">if</span> (response != nil) &#123;</span><br><span class="line">        self.pps_response = response;</span><br><span class="line">        [self.client URLProtocol:self wasRedirectedToRequest:request redirectResponse:response];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection</span><br><span class="line">didReceiveResponse:(NSURLResponse *)response &#123;</span><br><span class="line">    [[self client] URLProtocol:self didReceiveResponse:response cacheStoragePolicy:NSURLCacheStorageAllowed];</span><br><span class="line">    self.pps_response = response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data &#123;</span><br><span class="line">    [self.client URLProtocol:self didLoadData:data];</span><br><span class="line">    [self.pps_data appendData:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSCachedURLResponse *)connection:(NSURLConnection *)connection</span><br><span class="line">                  willCacheResponse:(NSCachedURLResponse *)cachedResponse &#123;</span><br><span class="line">    <span class="keyword">return</span> cachedResponse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)connectionDidFinishLoading:(NSURLConnection *)connection &#123;</span><br><span class="line">    [[self client] URLProtocolDidFinishLoading:self];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‹¦æˆªç½‘ç»œ"><a href="#æ‹¦æˆªç½‘ç»œ" class="headerlink" title="æ‹¦æˆªç½‘ç»œ"></a>æ‹¦æˆªç½‘ç»œ</h3><p>è¿™æ ·ï¼ŒåŸºæœ¬çš„protocolå°±å·²ç»å®ç°å®Œæˆï¼Œé‚£ä¹ˆæ€æ ·æ¥æ‹¦æˆªç½‘ç»œã€‚æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocolé€šè¿‡NSURLProtocolæ³¨å†Œåˆ°æˆ‘ä»¬çš„ç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­ï¼Œå‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å¤„ç†ç±»ä¸å†æ˜¯é»˜è®¤çš„NSURLProtocolï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocol</p>
<p>ã€‚æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocolé€šè¿‡NSURLProtocolæ³¨å†Œåˆ°æˆ‘ä»¬çš„ç½‘ç»œåŠ è½½ç³»ç»Ÿä¸­ï¼Œå‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚å¤„ç†ç±»ä¸å†æ˜¯é»˜è®¤çš„NSURLProtocolï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„PPSURLProtocol</p>
<p>æˆ‘ä»¬åœ¨PPSURLProtocolæš´éœ²ä¸¤ä¸ªæ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">@interface PPSURLProtocol : NSURLProtocol</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)start;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)end;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨æˆ‘ä»¬çš„APPå¯åŠ¨çš„æ—¶å€™ï¼Œè°ƒç”¨startï¼Œå°±å¯ä»¥ç›‘å¬åˆ°æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    PPSURLSessionConfiguration *sessionConfiguration = [PPSURLSessionConfiguration defaultConfiguration];</span><br><span class="line">    [NSURLProtocol registerClass:[PPSURLProtocol <span class="class"><span class="keyword">class</span>]];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)end &#123;</span><br><span class="line">    PPSURLSessionConfiguration *sessionConfiguration = [PPSURLSessionConfiguration defaultConfiguration];</span><br><span class="line">    [NSURLProtocol unregisterClass:[PPSURLProtocol <span class="class"><span class="keyword">class</span>]];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å…¶ä»–å¤„ç†"><a href="#å…¶ä»–å¤„ç†" class="headerlink" title="å…¶ä»–å¤„ç†"></a>å…¶ä»–å¤„ç†</h3><p>ä¸Šé¢çš„ä»£ç å·²ç»èƒ½å¤Ÿç›‘æ§åˆ°ç»å¤§éƒ¨åˆ†çš„ç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯å‘¢ï¼Œæœ‰ä¸€ä¸ªå´æ˜¯ç‰¹æ®Šçš„ã€‚</p>
<p>å¯¹äºNSURLSessionå‘èµ·çš„ç½‘ç»œè¯·æ±‚ï¼Œæˆ‘ä»¬å‘ç°é€šè¿‡sharedå¾—åˆ°çš„sessionå‘èµ·çš„ç½‘ç»œè¯·æ±‚éƒ½èƒ½å¤Ÿç›‘å¬åˆ°ï¼Œä½†æ˜¯é€šè¿‡æ–¹æ³•<em>sessionWithConfiguration:delegate:delegateQueue:</em>å¾—åˆ°çš„sessionï¼Œæˆ‘ä»¬æ˜¯ä¸èƒ½ç›‘å¬åˆ°çš„ï¼ŒåŸå› å°±å‡ºåœ¨NSURLSessionConfigurationä¸Šï¼Œæˆ‘ä»¬è¿›åˆ°NSURLSessionConfigurationé‡Œé¢çœ‹ä¸€ä¸‹ï¼Œä»–æœ‰ä¸€ä¸ªå±æ€§</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">@property (nullable, copy) NSArray&lt;Class&gt; *protocolClasses;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªNSURLProtocolæ•°ç»„ï¼Œä¸Šé¢æˆ‘ä»¬æåˆ°äº†ï¼Œæˆ‘ä»¬ç›‘æ§ç½‘ç»œæ˜¯é€šè¿‡æ³¨å†ŒNSURLProtocolæ¥è¿›è¡Œç½‘ç»œç›‘æ§çš„ï¼Œä½†æ˜¯é€šè¿‡<em>sessionWithConfiguration:delegate:delegateQueue:å¾—åˆ°çš„sessionï¼Œä»–çš„configurationä¸­å·²ç»æœ‰ä¸€ä¸ªNSURLProtocolï¼Œæ‰€ä»¥ä»–ä¸ä¼šèµ°æˆ‘ä»¬çš„protocolæ¥ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ å…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°†NSURLSessionConfigurationçš„å±æ€§protocolClassesçš„getæ–¹æ³•hookæ‰ï¼Œé€šè¿‡è¿”å›æˆ‘ä»¬è‡ªå·±çš„protocolï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿç›‘æ§åˆ°é€šè¿‡sessionWithConfiguration:delegate:delegateQueue:</em>å¾—åˆ°çš„sessionçš„ç½‘ç»œè¯·æ±‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> hook çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> BOOL isHookWorking = NO;</span><br><span class="line"></span><br><span class="line">@<span class="function">implementation <span class="title">NSURLSessionConfiguration</span> <span class="params">(FSAPM)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Life Cycle</span></span></span><br><span class="line"><span class="function"><span class="comment">/**</span></span></span><br><span class="line"><span class="function"><span class="comment"> swizzle method</span></span></span><br><span class="line"><span class="function"><span class="comment"> */</span></span></span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">dispatch_once_t</span> onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// é¿å…ä½¿ç”¨ç§æœ‰ APImï¼Œä¸è¿‡å®¡</span></span><br><span class="line">        Class cls = NSClassFromString([NSString stringWithFormat:@<span class="string">"%@%@%@"</span>, @<span class="string">"__NSCFU"</span>, @<span class="string">"RLSessionCon"</span>, @<span class="string">"figuration"</span>]) ?: NSClassFromString(@<span class="string">"NSURLSessionConfiguration"</span>);</span><br><span class="line">        Method origMethod = class_getInstanceMethod(cls, @selector(protocolClasses));</span><br><span class="line">        Method replMethod = class_getInstanceMethod(self, @selector(fs_protocolClasses));</span><br><span class="line">        <span class="keyword">if</span> (origMethod &amp;&amp; replMethod) &#123;</span><br><span class="line">            <span class="keyword">if</span> (class_addMethod(cls, @selector(protocolClasses), method_getImplementation(replMethod), method_getTypeEncoding(replMethod))) &#123;</span><br><span class="line">                class_replaceMethod(self, @selector(fs_protocolClasses), method_getImplementation(origMethod), method_getTypeEncoding(origMethod));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                method_exchangeImplementations(origMethod, replMethod);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Public Method</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å¼€å¯ hook</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)start &#123;</span><br><span class="line">    isHookWorking = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å…³é—­ hook</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)stop &#123;</span><br><span class="line">    isHookWorking = NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - Private Method</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å°† FSURLProtocol å¯¹è±¡æ”¾åœ¨é¦–ä½</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return NSArray&lt;NSURLProtocol&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (NSArray&lt;Class&gt; *)fs_protocolClasses &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHookWorking) &#123;</span><br><span class="line">        <span class="keyword">return</span> [self fs_protocolClasses];</span><br><span class="line">    &#125;</span><br><span class="line">    NSMutableArray *<span class="built_in">array</span> = [[self fs_protocolClasses] mutableCopy];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">array</span>.count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> @[[FSURLProtocol class]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="built_in">array</span> containsObject:[FSURLProtocol class]]) &#123;</span><br><span class="line">        [<span class="built_in">array</span> insertObject:[FSURLProtocol <span class="class"><span class="keyword">class</span>] <span class="title">atIndex</span>:</span><span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">array</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°†è¿™ä¸ªæ–¹æ³•æ›¿æ¢æ‰ï¼Œåœ¨ç§»é™¤ç›‘å¬çš„æ—¶å€™ï¼Œæ¢å¤ä¹‹å‰çš„æ–¹æ³•</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ç›‘å¬å°±å®Œæˆäº†ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å°†è¿™æ‰€æœ‰çš„ç›‘å¬å­˜èµ·æ¥ï¼Œåœ¨protocolçš„startæˆ–è€…stopä¸­è·å–åˆ°requestå’Œresponseï¼Œå°†ä»–ä»¬å­˜å‚¨èµ·æ¥å°±è¡Œï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ®è‹¹æœçš„å®˜æ–¹è¯´æ˜ï¼Œå› ä¸ºè¯·æ±‚å‚æ•°å¯èƒ½ä¼šå¾ˆå¤§ï¼Œä¸ºäº†ä¿è¯æ€§èƒ½ï¼Œè¯·æ±‚å‚æ•°æ˜¯æ²¡æœ‰è¢«æ‹¦æˆªæ‰çš„ï¼Œå°±æ˜¯postçš„HTTPBodyæ˜¯æ²¡æœ‰çš„</p>
]]></content>
      <categories>
        <category>APM</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-æ‹ç…§å’Œå½•åƒ</title>
    <url>/essay/AVFoundation/AVFoundation-%E6%8B%8D%E7%85%A7%E5%92%8C%E5%BD%95%E5%83%8F/</url>
    <content><![CDATA[<blockquote>
<p>ä½¿ç”¨AV Foundation æ•æ‰ç…§ç‰‡å’Œè§†é¢‘</p>
</blockquote>
<p>ä½¿ç”¨AVFoundationæ‹ç…§å’Œå½•åˆ¶è§†é¢‘çš„ä¸€èˆ¬æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»º<strong>AVCaptureSession</strong>å¯¹è±¡ã€‚</li>
<li>ä½¿ç”¨<strong>AVCaptureDevice</strong>çš„é™æ€æ–¹æ³•è·å¾—éœ€è¦ä½¿ç”¨çš„è®¾å¤‡ï¼Œä¾‹å¦‚æ‹ç…§å’Œå½•åƒå°±éœ€è¦è·å¾—æ‘„åƒå¤´è®¾å¤‡ï¼Œå½•éŸ³å°±è¦è·å¾—éº¦å…‹é£è®¾å¤‡ã€‚</li>
<li>åˆ©ç”¨è¾“å…¥è®¾å¤‡AVCaptureDeviceåˆå§‹åŒ–<strong>AVCaptureDeviceInput</strong>å¯¹è±¡ã€‚</li>
<li>åˆå§‹åŒ–è¾“å‡ºæ•°æ®ç®¡ç†å¯¹è±¡ï¼Œå¦‚æœè¦æ‹ç…§å°±åˆå§‹åŒ–AVCaptureStillImageOutputå¯¹è±¡ï¼›å¦‚æœæ‹æ‘„è§†é¢‘å°±åˆå§‹åŒ–AVCaptureMovieFileOutputå¯¹è±¡ã€‚</li>
<li>å°†æ•°æ®è¾“å…¥å¯¹è±¡AVCaptureDeviceInputã€æ•°æ®è¾“å‡ºå¯¹è±¡<strong>AVCaptureOutput</strong>æ·»åŠ åˆ°åª’ä½“ä¼šè¯ç®¡ç†å¯¹è±¡AVCaptureSessionä¸­ã€‚</li>
<li>åˆ›å»ºè§†é¢‘é¢„è§ˆå›¾å±‚<strong>AVCaptureVideoPreviewLayer</strong>å¹¶æŒ‡å®šåª’ä½“ä¼šè¯ï¼Œæ·»åŠ å›¾å±‚åˆ°æ˜¾ç¤ºå®¹å™¨ä¸­ï¼Œè°ƒç”¨AVCaptureSessionçš„startRuningæ–¹æ³•å¼€å§‹æ•è·ã€‚</li>
<li>å°†æ•è·çš„éŸ³é¢‘æˆ–è§†é¢‘æ•°æ®è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶ã€‚</li>
</ol>
<a id="more"></a>
<p>ä¸»è¦ç”¨åˆ°çš„ç±»ï¼š</p>
<ul>
<li>AVCaptureDeviceInput (è¾“å…¥è®¾å¤‡)<ul>
<li>AVCaptureDevice </li>
</ul>
</li>
<li>AVCaptureSession ï¼ˆæ•æ‰ä¼šè¯ï¼‰</li>
<li>AVCaptureVideoPreviewLayer ï¼ˆå±•ç¤ºå±‚)</li>
<li>AVCaptureOutput ï¼ˆè¾“å‡ºï¼‰<ul>
<li>AVCaptureStillImageOutput (æ•æ‰å›¾ç‰‡)</li>
<li>AVCaptureAudioDataOutput </li>
<li>AVCaptureVideoDataOutput</li>
<li>AVCaptureFileOutput</li>
</ul>
</li>
</ul>
<h2 id="é…ç½®ä¼šè¯ï¼š"><a href="#é…ç½®ä¼šè¯ï¼š" class="headerlink" title="é…ç½®ä¼šè¯ï¼š"></a>é…ç½®ä¼šè¯ï¼š</h2><blockquote>
<p>ç®€å•é…ç½®ä¼šè¯</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–ä¼šè¯</span></span><br><span class="line">    _captureSession=[[<span class="built_in">AVCaptureSession</span> alloc]init];</span><br><span class="line">    <span class="keyword">if</span> ([_captureSession canSetSessionPreset:<span class="built_in">AVCaptureSessionPreset1280x720</span>]) &#123;<span class="comment">//è®¾ç½®åˆ†è¾¨ç‡</span></span><br><span class="line">        _captureSession.sessionPreset=<span class="built_in">AVCaptureSessionPreset1280x720</span>;</span><br><span class="line">        <span class="comment">//_captureSession.sessionPreset=AVCaptureSessionPresetHigh;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å¾—è§†é¢‘æ•æ‰è®¾å¤‡</span></span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *captureDevice=[<span class="keyword">self</span> getCameraDeviceWithPosition:<span class="built_in">AVCaptureDevicePositionBack</span>];<span class="comment">//å–å¾—åç½®æ‘„åƒå¤´</span></span><br><span class="line">    <span class="comment">//	AVCaptureDevice *videoDevice = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo];//è·å–é»˜è®¤æ‘„åƒå¤´</span></span><br><span class="line">    <span class="keyword">if</span> (!captureDevice) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å–å¾—åç½®æ‘„åƒå¤´æ—¶å‡ºç°é—®é¢˜."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">NSError</span> *error=<span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//æ ¹æ®è¾“å…¥è®¾å¤‡åˆå§‹åŒ–è®¾å¤‡è¾“å…¥å¯¹è±¡ï¼Œç”¨äºè·å¾—è¾“å…¥æ•°æ®</span></span><br><span class="line">    _captureDeviceInput=[[<span class="built_in">AVCaptureDeviceInput</span> alloc]initWithDevice:captureDevice error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"å–å¾—è®¾å¤‡è¾“å…¥å¯¹è±¡æ—¶å‡ºé”™ï¼Œé”™è¯¯åŸå› ï¼š%@"</span>,error.localizedDescription);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    <span class="comment">//è·å–é™æ€å›¾ç‰‡è¾“å‡º</span></span><br><span class="line">    _captureStillImageOutput=[[<span class="built_in">AVCaptureStillImageOutput</span> alloc]init];</span><br><span class="line">    <span class="built_in">NSDictionary</span> *outputSettings = @&#123;<span class="built_in">AVVideoCodecKey</span>:<span class="built_in">AVVideoCodecJPEG</span>&#125;;</span><br><span class="line">    [_captureStillImageOutput setOutputSettings:outputSettings];<span class="comment">//è¾“å‡ºè®¾ç½®</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å°†è®¾å¤‡è¾“å…¥æ·»åŠ åˆ°ä¼šè¯ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> ([_captureSession canAddInput:_captureDeviceInput]) &#123;</span><br><span class="line">        [_captureSession addInput:_captureDeviceInput];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å°†è®¾å¤‡è¾“å‡ºæ·»åŠ åˆ°ä¼šè¯ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> ([_captureSession canAddOutput:_captureStillImageOutput]) &#123;</span><br><span class="line">        [_captureSession addOutput:_captureStillImageOutput];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºè§†é¢‘é¢„è§ˆå±‚ï¼Œç”¨äºå®æ—¶å±•ç¤ºæ‘„åƒå¤´çŠ¶æ€</span></span><br><span class="line">    _captureVideoPreviewLayer=[[<span class="built_in">AVCaptureVideoPreviewLayer</span> alloc]initWithSession:<span class="keyword">self</span>.captureSession];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CALayer</span> *layer=<span class="keyword">self</span>.viewContainer.layer;</span><br><span class="line">    layer.masksToBounds=<span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    _captureVideoPreviewLayer.frame=layer.bounds;</span><br><span class="line">    _captureVideoPreviewLayer.videoGravity=<span class="built_in">AVLayerVideoGravityResizeAspectFill</span>;<span class="comment">//å¡«å……æ¨¡å¼</span></span><br><span class="line">    <span class="comment">//å°†è§†é¢‘é¢„è§ˆå±‚æ·»åŠ åˆ°ç•Œé¢ä¸­</span></span><br><span class="line">    \[layer addSublayer:_captureVideoPreviewLayer];</span><br></pre></td></tr></table></figure>
<h3 id="æ·»åŠ éŸ³é¢‘æ•æ‰è®¾å¤‡ï¼ˆéº¦å…‹é£ï¼‰"><a href="#æ·»åŠ éŸ³é¢‘æ•æ‰è®¾å¤‡ï¼ˆéº¦å…‹é£ï¼‰" class="headerlink" title="æ·»åŠ éŸ³é¢‘æ•æ‰è®¾å¤‡ï¼ˆéº¦å…‹é£ï¼‰"></a>æ·»åŠ éŸ³é¢‘æ•æ‰è®¾å¤‡ï¼ˆéº¦å…‹é£ï¼‰</h3><blockquote>
<p>è¾“å…¥ä¸ä»…å¯ä»¥æ·»åŠ æ‘„åƒå¤´ ï¼Œé¡µå¯ä»¥æ·»åŠ éº¦å…‹é£</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Setup default microphone</span></span><br><span class="line"><span class="built_in">AVCaptureDevice</span> *audioDevice =                                          <span class="comment">// 5</span></span><br><span class="line">    [<span class="built_in">AVCaptureDevice</span> defaultDeviceWithMediaType:<span class="built_in">AVMediaTypeAudio</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">AVCaptureDeviceInput</span> *audioInput =                                      <span class="comment">// 6</span></span><br><span class="line">    [<span class="built_in">AVCaptureDeviceInput</span> deviceInputWithDevice:audioDevice error:error];</span><br><span class="line"><span class="keyword">if</span> (audioInput) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddInput:audioInput]) &#123;                 <span class="comment">// 7</span></span><br><span class="line">        [<span class="keyword">self</span>.captureSession addInput:audioInput];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ·»åŠ è§†é¢‘è¾“å‡º"><a href="#æ·»åŠ è§†é¢‘è¾“å‡º" class="headerlink" title="æ·»åŠ è§†é¢‘è¾“å‡º"></a>æ·»åŠ è§†é¢‘è¾“å‡º</h3><blockquote>
<p>è¾“å‡ºä¸ä»…å¯ä»¥æ·»åŠ é™æ€å›¾ç‰‡ï¼Œå¯ä»¥æ·»åŠ è§†é¢‘è¾“å‡º</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Setup movie file output</span></span><br><span class="line"><span class="keyword">self</span>.movieOutput = [[<span class="built_in">AVCaptureMovieFileOutput</span> alloc] init];             <span class="comment">// 9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddOutput:<span class="keyword">self</span>.movieOutput]) &#123;</span><br><span class="line">    [<span class="keyword">self</span>.captureSession addOutput:<span class="keyword">self</span>.movieOutput];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¯åŠ¨æˆ–è€…åœæ­¢ä¼šè¯"><a href="#å¯åŠ¨æˆ–è€…åœæ­¢ä¼šè¯" class="headerlink" title="å¯åŠ¨æˆ–è€…åœæ­¢ä¼šè¯"></a>å¯åŠ¨æˆ–è€…åœæ­¢ä¼šè¯</h3><blockquote>
<p>å¯åŠ¨ä¼šè¯ï¼Œä½¿å®ƒå¤„äºå›¾ç‰‡å’Œè§†é¢‘æ•æ‰çŠ¶æ€ã€‚æœ€å¥½ä¸è¦åœ¨ä¸»çº¿ç¨‹ä¸­å¯åŠ¨ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)startSession &#123;</span><br><span class="line">	<span class="keyword">if</span> (![<span class="keyword">self</span>.captureSession isRunning]) &#123;                                 <span class="comment">// 1</span></span><br><span class="line">		<span class="built_in">dispatch_async</span>([<span class="keyword">self</span> globalQueue], ^&#123;</span><br><span class="line">			[<span class="keyword">self</span>.captureSession startRunning];</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopSession &#123;</span><br><span class="line">	<span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession isRunning]) &#123;                                  <span class="comment">// 2</span></span><br><span class="line">		<span class="built_in">dispatch_async</span>([<span class="keyword">self</span> globalQueue], ^&#123;</span><br><span class="line">			[<span class="keyword">self</span>.captureSession stopRunning];</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éšç§è®¿é—®æƒé™"><a href="#éšç§è®¿é—®æƒé™" class="headerlink" title="éšç§è®¿é—®æƒé™"></a>éšç§è®¿é—®æƒé™</h3><blockquote>
<p>xcode8 iOS10ä¸­åä¸æ·»åŠ æƒé™ä¼šå‡ºé”™</p>
</blockquote>
<p>åœ¨info.plistæ–‡ä»¶æ·»åŠ å¯¹åº”çš„Key-Value:</p>
<p><img src="/res/AVFoundation/iOS10æƒé™.png" alt></p>
<h2 id="èšç„¦-è‡ªåŠ¨èšç„¦ï¼Œæ‰‹åŠ¨èšç„¦"><a href="#èšç„¦-è‡ªåŠ¨èšç„¦ï¼Œæ‰‹åŠ¨èšç„¦" class="headerlink" title="èšç„¦(è‡ªåŠ¨èšç„¦ï¼Œæ‰‹åŠ¨èšç„¦)"></a>èšç„¦(è‡ªåŠ¨èšç„¦ï¼Œæ‰‹åŠ¨èšç„¦)</h2><h3 id="åæ ‡ç©ºé—´è½¬æ¢"><a href="#åæ ‡ç©ºé—´è½¬æ¢" class="headerlink" title="åæ ‡ç©ºé—´è½¬æ¢"></a>åæ ‡ç©ºé—´è½¬æ¢</h3><blockquote>
<p>å¦‚iPhone5å±å¹•åæ ‡ç³»å·¦ä¸Šè§’ä¸ºï¼ˆ0ï¼Œ0ï¼‰å‚ç›´æ—¶å³ä¸‹è§’ä¸ºï¼ˆ320ï¼Œ568ï¼‰ï¼Œæ°´å¹³æ—¶å³ä¸‹è§’ï¼ˆ568ï¼Œ320ï¼‰ã€‚<br>è€Œè®¾å¤‡åæ ‡ç³»åŸºäºæ‘„åƒå¤´çš„æœ¬åœ°è®¾ç½®ï¼Œå·¦ä¸Šè§’ä¸ºï¼ˆ0ï¼Œ0ï¼‰å³ä¸‹è§’ä¸ºï¼ˆ1ï¼Œ1ï¼‰ã€‚</p>
</blockquote>
<p><strong>AVCaptureVideoPreviewLayer</strong>å®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•ç”¨äºè½¬æ¢ä¸¤è€…é—´çš„åæ ‡ï¼š</p>
<ul>
<li><code>- (CGPoint)captureDevicePointOfInterestForPoint:(CGPoint)pointInLayer NS_AVAILABLE_IOS(6_0);</code> <ul>
<li>å°†å±å¹•åæ ‡ç³»è½¬æ¢ä¸ºè®¾å¤‡åæ ‡ç³»</li>
</ul>
</li>
<li><code>- (CGPoint)pointForCaptureDevicePointOfInterest:(CGPoint)captureDevicePointOfInterest NS_AVAILABLE_IOS(6_0);</code>  <ul>
<li>å°†è®¾å¤‡åæ ‡ç³»è½¬æ¢ä¸ºå±å¹•åæ ‡ç³»</li>
</ul>
</li>
</ul>
<h3 id="è®¾ç½®å¯¹ç„¦æ¨¡å¼"><a href="#è®¾ç½®å¯¹ç„¦æ¨¡å¼" class="headerlink" title="è®¾ç½®å¯¹ç„¦æ¨¡å¼"></a>è®¾ç½®å¯¹ç„¦æ¨¡å¼</h3><blockquote>
<p>å¯¹ç„¦æ¨¡å¼<code>AVCaptureFlashMode</code>æœ‰ ä¸‰ç§ <strong>AVCaptureFlashModeOff</strong> ã€<strong>AVCaptureFlashModeOn</strong> å’Œ <strong>AVCaptureFlashModeAuto</strong><br>é…ç½®è®¾å¤‡æ—¶ä¸€å®šè¦åˆ¤æ–­ä¸€ä¸‹è®¾å¤‡æ˜¯å¦æ”¯æŒï¼Œæ¯”å¦‚å‰ç½®æ‘„åƒå¤´ä¸æ”¯æŒå¯¹ç„¦æ“ä½œ<br>ä¿®æ”¹è®¾å¤‡é…ç½®æ—¶éœ€è¦å…ˆé”å®šé…ç½® <code>lockForConfiguration</code> æ‰§è¡Œæ‰€éœ€çš„ä¿®æ”¹ï¼Œæœ€åè§£é”è®¾å¤‡ <code>unlockForConfiguration</code></p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setFlashMode:(<span class="built_in">AVCaptureFlashMode</span>)flashMode &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *device = [<span class="keyword">self</span> activeCamera];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device.flashMode != flashMode &amp;&amp;</span><br><span class="line">        [device isFlashModeSupported:flashMode]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSError</span> *error;</span><br><span class="line">        <span class="keyword">if</span> ([device lockForConfiguration:&amp;error]) &#123;</span><br><span class="line">            device.flashMode = flashMode;</span><br><span class="line">            [device unlockForConfiguration];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç‚¹å‡»å¯¹ç„¦"><a href="#ç‚¹å‡»å¯¹ç„¦" class="headerlink" title="ç‚¹å‡»å¯¹ç„¦"></a>ç‚¹å‡»å¯¹ç„¦</h3><blockquote>
<p>å°†å±å¹•åæ ‡è½¬æ¢ä¸ºæ•æ‰è®¾å¤‡åæ ‡ï¼Œç„¶åå°† <strong>focusPointOfInterest</strong> è®¾ç½®ä¸ºè¯¥åæ ‡</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#pragma mark - Focus Methods</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)cameraSupportsTapToFocus &#123;                                          <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> activeCamera] isFocusPointOfInterestSupported];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)focusAtPoint:(<span class="built_in">CGPoint</span>)point &#123;                                       <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *device = [<span class="keyword">self</span> activeCamera];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device.isFocusPointOfInterestSupported &amp;&amp;                           <span class="comment">// 3</span></span><br><span class="line">        [device isFocusModeSupported:<span class="built_in">AVCaptureFocusModeAutoFocus</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSError</span> *error;</span><br><span class="line">        <span class="keyword">if</span> ([device lockForConfiguration:&amp;error]) &#123;                         <span class="comment">// 4</span></span><br><span class="line">            device.focusPointOfInterest = point;</span><br><span class="line">            device.focusMode = <span class="built_in">AVCaptureFocusModeAutoFocus</span>;</span><br><span class="line">            [device unlockForConfiguration];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è°ƒæ•´æ›å…‰æ¨¡å¼"><a href="#è°ƒæ•´æ›å…‰æ¨¡å¼" class="headerlink" title="è°ƒæ•´æ›å…‰æ¨¡å¼"></a>è°ƒæ•´æ›å…‰æ¨¡å¼</h2><blockquote>
<p>ä¸è°ƒæ•´å¯¹ç„¦æ¨¡å¼ç±»ä¼¼ï¼Œå¯ä»¥è°ƒæ•´æ›å…‰æ¨¡å¼ <code>device.exposureMode</code><br><strong>AVCaptureExposureModeLocked</strong> é”å®šæ›å…‰ <strong>AVCaptureExposureModeAutoExpose</strong> è‡ªåŠ¨æ›å…‰ <strong>AVCaptureExposureModeContinuousAutoExposure</strong> è‡ªåŠ¨æŒç»­æ›å…‰ <strong>AVCaptureExposureModeCustom</strong> è‡ªå®šä¹‰æ›å…‰ å››ä¸ªå€¼</p>
</blockquote>
<h2 id="è°ƒæ•´é—ªå…‰ç¯æ¨¡å¼"><a href="#è°ƒæ•´é—ªå…‰ç¯æ¨¡å¼" class="headerlink" title="è°ƒæ•´é—ªå…‰ç¯æ¨¡å¼"></a>è°ƒæ•´é—ªå…‰ç¯æ¨¡å¼</h2><blockquote>
<p>ä¸ä¹‹å‰çš„ä¸¤ä¸ªç±»ä¼¼</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)cameraHasTorch &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> activeCamera] hasTorch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">AVCaptureTorchMode</span>)torchMode &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> activeCamera] torchMode];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTorchMode:(<span class="built_in">AVCaptureTorchMode</span>)torchMode &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *device = [<span class="keyword">self</span> activeCamera];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (device.torchMode != torchMode &amp;&amp;</span><br><span class="line">        [device isTorchModeSupported:torchMode]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSError</span> *error;</span><br><span class="line">        <span class="keyword">if</span> ([device lockForConfiguration:&amp;error]) &#123;</span><br><span class="line">            device.torchMode = torchMode;</span><br><span class="line">            [device unlockForConfiguration];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åˆ‡æ¢æ‘„åƒå¤´"><a href="#åˆ‡æ¢æ‘„åƒå¤´" class="headerlink" title="åˆ‡æ¢æ‘„åƒå¤´"></a>åˆ‡æ¢æ‘„åƒå¤´</h2><blockquote>
<p>åˆ‡æ¢æ‘„åƒå¤´æ—¶æ‹…å¿ƒåœæ­¢ä¼šè¯å’Œé‡å¯ä¼šè¯å¸¦æ¥çš„å¼€é”€ï¼Œä½†æ˜¯å¯¹ä¼šè¯è¿›è¡Œæ”¹å˜æ—¶ï¼Œè¦é€šè¿‡ <code>beginConfiguration</code> å’Œ <code>commitConfiguration</code> è¿›è¡Œå•ç‹¬çš„åŸå­æ€§çš„å˜åŒ–ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#pragma mark - Device Configuration</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›æŒ‡å®šä½ç½®çš„AVCaptureDevice **AVCaptureDevicePositionBack** å’Œ **AVCaptureDevicePositionFront**</span></span><br><span class="line">- (<span class="built_in">AVCaptureDevice</span> *)cameraWithPosition:(<span class="built_in">AVCaptureDevicePosition</span>)position &#123; <span class="comment">// 1</span></span><br><span class="line">	<span class="built_in">NSArray</span> *devices = [<span class="built_in">AVCaptureDevice</span> devicesWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">AVCaptureDevice</span> *device <span class="keyword">in</span> devices) &#123;                              <span class="comment">// 2</span></span><br><span class="line">		<span class="keyword">if</span> (device.position == position) &#123;</span><br><span class="line">			<span class="keyword">return</span> device;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å½“å‰æ•æ‰ä¼šè¯å¯¹åº”çš„æ‘„åƒå¤´</span></span><br><span class="line">- (<span class="built_in">AVCaptureDevice</span> *)activeCamera &#123;                                         <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.activeVideoInput.device;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å½“å‰ä¸ºæ¿€æ´»çš„æ‘„åƒå¤´</span></span><br><span class="line">- (<span class="built_in">AVCaptureDevice</span> *)inactiveCamera &#123;                                       <span class="comment">// 4</span></span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *device = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.cameraCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> activeCamera].position == <span class="built_in">AVCaptureDevicePositionBack</span>) &#123;  <span class="comment">// 5</span></span><br><span class="line">            device = [<span class="keyword">self</span> cameraWithPosition:<span class="built_in">AVCaptureDevicePositionFront</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            device = [<span class="keyword">self</span> cameraWithPosition:<span class="built_in">AVCaptureDevicePositionBack</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> device;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ˜¯å¦è¶…è¿‡ä¸€ä¸ªæ‘„åƒå¤´å¯ç”¨</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)canSwitchCameras &#123;                                                  <span class="comment">// 6</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.cameraCount &gt; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¯ç”¨çš„è§†é¢‘æ•æ‰è®¾å¤‡çš„æ•°é‡</span></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)cameraCount &#123;                                                 <span class="comment">// 7</span></span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">AVCaptureDevice</span> devicesWithMediaType:<span class="built_in">AVMediaTypeVideo</span>] count];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)switchCameras &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> canSwitchCameras]) &#123;                                         <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">AVCaptureDevice</span> *videoDevice = [<span class="keyword">self</span> inactiveCamera];                   <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureDeviceInput</span> *videoInput =</span><br><span class="line">    [<span class="built_in">AVCaptureDeviceInput</span> deviceInputWithDevice:videoDevice error:&amp;error];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (videoInput) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.captureSession beginConfiguration];                           <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span>.captureSession removeInput:<span class="keyword">self</span>.activeVideoInput];            <span class="comment">// 4</span></span><br><span class="line">       </span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddInput:videoInput]) &#123;                 <span class="comment">// 5</span></span><br><span class="line">            [<span class="keyword">self</span>.captureSession addInput:videoInput];</span><br><span class="line">            <span class="keyword">self</span>.activeVideoInput = videoInput;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//è‹¥ä¸èƒ½æ·»åŠ æ–°è¾“å…¥åˆ™é‡æ–°æ·»åŠ ä¹‹å‰çš„è¾“å…¥</span></span><br><span class="line">            [<span class="keyword">self</span>.captureSession addInput:<span class="keyword">self</span>.activeVideoInput];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span>.captureSession commitConfiguration];                          <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];           <span class="comment">// 7</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ‹ç…§ï¼Œè·å–é™æ€å›¾ç‰‡"><a href="#æ‹ç…§ï¼Œè·å–é™æ€å›¾ç‰‡" class="headerlink" title="æ‹ç…§ï¼Œè·å–é™æ€å›¾ç‰‡"></a>æ‹ç…§ï¼Œè·å–é™æ€å›¾ç‰‡</h2><blockquote>
<p><code>AVCaptureStillImageOutput</code> ç”¨äºæ•æ‰é™æ€å›¾ç‰‡ï¼Œæ‰§è¡Œ<code>- (void)captureStillImageAsynchronouslyFromConnection:(AVCaptureConnection *)connection completionHandler:(void (^)(CMSampleBufferRef imageDataSampleBuffer, NSError *error))handler;</code>æ–¹æ³•æ¥è·å–å›¾ç‰‡<br>ä½¿ç”¨ <code>ALAssetsLibrary</code>æ¥å°†å›¾ç‰‡å‚¨å­˜åœ¨ç…§ç‰‡ä¸­</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ‹ç…§</span></span><br><span class="line">- (<span class="keyword">void</span>)captureStillImage &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureConnection</span> *connection =                                   </span><br><span class="line">        [<span class="keyword">self</span>.imageOutput connectionWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connection.isVideoOrientationSupported) &#123;                       </span><br><span class="line">        connection.videoOrientation = [<span class="keyword">self</span> currentVideoOrientation];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">id</span> handler = ^(<span class="built_in">CMSampleBufferRef</span> sampleBuffer, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sampleBuffer != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSData</span> *imageData =</span><br><span class="line">                [<span class="built_in">AVCaptureStillImageOutput</span></span><br><span class="line">                    jpegStillImageNSDataRepresentation:sampleBuffer];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">UIImage</span> *image = [[<span class="built_in">UIImage</span> alloc] initWithData:imageData];</span><br><span class="line">            [<span class="keyword">self</span> writeImageToAssetsLibrary:image];                         <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"NULL sampleBuffer: %@"</span>, [error localizedDescription]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// Capture still image</span></span><br><span class="line">    [<span class="keyword">self</span>.imageOutput captureStillImageAsynchronouslyFromConnection:connection</span><br><span class="line">                                                  completionHandler:handler];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¿å­˜åœ¨æœ¬åœ°ç…§ç‰‡</span></span><br><span class="line">- (<span class="keyword">void</span>)writeImageToAssetsLibrary:(<span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line"></span><br><span class="line">    ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];              <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    [library writeImageToSavedPhotosAlbum:image.CGImage                     <span class="comment">// 3</span></span><br><span class="line">                              orientation:(<span class="built_in">NSInteger</span>)image.imageOrientation <span class="comment">// 4</span></span><br><span class="line">                          completionBlock:^(<span class="built_in">NSURL</span> *assetURL, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                              <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">                                  [<span class="keyword">self</span> postThumbnailNotifification:image]; <span class="comment">// 5</span></span><br><span class="line">                              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                  <span class="keyword">id</span> message = [error localizedDescription];</span><br><span class="line">                                  <span class="built_in">NSLog</span>(<span class="string">@"Error: %@"</span>, message);</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)postThumbnailNotifification:(<span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="built_in">NSNotificationCenter</span> *nc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">        [nc postNotificationName:THThumbnailCreatedNotification object:image];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è§†é¢‘æ•æ‰"><a href="#è§†é¢‘æ•æ‰" class="headerlink" title="è§†é¢‘æ•æ‰"></a>è§†é¢‘æ•æ‰</h2><blockquote>
<p>ä½¿ç”¨<code>AVCaptureMovieFileOutput</code> æ¥æ•æ‰è§†é¢‘<br>åœ¨å½•åˆ¶å¼€å§‹æ—¶ï¼Œåœ¨æ–‡ä»¶çš„æœ€å‰é¢ä¼šå†™å…¥ä¸€ä¸ªæœ€å°åŒ–çš„å¤´ä¿¡æ¯ï¼Œéšç€å½•åˆ¶çš„è¿›è¡Œï¼Œç‰‡æ®µæŒ‰ç…§ä¸€å®šå‘¨æœŸå†™å…¥ï¼Œåˆ›å»ºå®Œæ•´çš„å¤´ä¿¡æ¯ï¼Œè¿™æ ·å°±ç¡®ä¿äº†å½“ç¨‹åºé‡åˆ°å´©æºƒæˆ–è€…ä¸­æ–­æ—¶ï¼Œå½±ç‰‡ä»ç„¶ä¼šä»¥æœ€åä¸€ä¸ªå†™å…¥çš„ç‰‡æ®µä¸ºé‡ç‚¹è¿›è¡Œä¿å­˜ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#pragma mark - Video Capture Methods</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isRecording &#123;                                                       <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.movieOutput.isRecording;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è·å–å¤„ç†å½“å‰è§†é¢‘æ•æ‰è¿æ¥çš„ä¿¡æ¯ï¼Œå¯¹æ•æ‰çš„è§†é¢‘æ•°æ®é…ç½®ä¸€äº›æ ¸å¿ƒå±æ€§</span></span><br><span class="line">- (<span class="keyword">void</span>)startRecording &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> isRecording]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">AVCaptureConnection</span> *videoConnection =                              <span class="comment">// 2</span></span><br><span class="line">            [<span class="keyword">self</span>.movieOutput connectionWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line">        <span class="comment">//è§†é¢‘æ–¹å‘</span></span><br><span class="line">		<span class="keyword">if</span> ([videoConnection isVideoOrientationSupported]) &#123;                <span class="comment">// 3</span></span><br><span class="line">			videoConnection.videoOrientation = <span class="keyword">self</span>.currentVideoOrientation;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//æ”¯æŒè§†é¢‘ç¨³å®š</span></span><br><span class="line">		<span class="keyword">if</span> ([videoConnection isVideoStabilizationSupported]) &#123;              <span class="comment">// 4</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ([[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] floatValue] &lt; <span class="number">8.0</span>) &#123;</span><br><span class="line">                videoConnection.enablesVideoStabilizationWhenAvailable = <span class="literal">YES</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                videoConnection.preferredVideoStabilizationMode = <span class="built_in">AVCaptureVideoStabilizationModeAuto</span>;</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">AVCaptureDevice</span> *device = [<span class="keyword">self</span> activeCamera];</span><br><span class="line">        <span class="comment">//æ”¯æŒå¹³æ»‘å¯¹ç„¦ï¼Œå³å‡æ…¢æ‘„åƒå¤´é•œå¤´å¯¹ç„¦çš„é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">if</span> (device.isSmoothAutoFocusSupported) &#123;                            <span class="comment">// 5</span></span><br><span class="line">            <span class="built_in">NSError</span> *error;</span><br><span class="line">            <span class="keyword">if</span> ([device lockForConfiguration:&amp;error]) &#123;</span><br><span class="line">                device.smoothAutoFocusEnabled = <span class="literal">NO</span>;</span><br><span class="line">                [device unlockForConfiguration];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.outputURL = [<span class="keyword">self</span> uniqueURL];                                  <span class="comment">// 6</span></span><br><span class="line">        <span class="comment">//å¼€å§‹å½•åˆ¶</span></span><br><span class="line">		[<span class="keyword">self</span>.movieOutput startRecordingToOutputFileURL:<span class="keyword">self</span>.outputURL      <span class="comment">// 8</span></span><br><span class="line">                                      recordingDelegate:<span class="keyword">self</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">CMTime</span>)recordedDuration &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.movieOutput.recordedDuration;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§†é¢‘æ–‡ä»¶å†™å…¥ç›®å½•</span></span><br><span class="line">- (<span class="built_in">NSURL</span> *)uniqueURL &#123;                                                      <span class="comment">// 7</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSString</span> *dirPath =</span><br><span class="line">        [fileManager temporaryDirectoryWithTemplateString:<span class="string">@"kamera.XXXXXX"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dirPath) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *filePath =</span><br><span class="line">            [dirPath stringByAppendingPathComponent:<span class="string">@"kamera_movie.mov"</span>];</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSURL</span> fileURLWithPath:filePath];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)stopRecording &#123;                                                     <span class="comment">// 9</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isRecording]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.movieOutput stopRecording];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - AVCaptureFileOutputRecordingDelegate</span></span><br><span class="line"><span class="comment">//åœ¨AVCaptureFileOutputRecordingDelegate å®ç°ä¸­è·å–æœ€ç»ˆæ–‡ä»¶å¹¶å†™å…¥</span></span><br><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureFileOutput</span> *)captureOutput</span><br><span class="line">didFinishRecordingToOutputFileAtURL:(<span class="built_in">NSURL</span> *)outputFileURL</span><br><span class="line">      fromConnections:(<span class="built_in">NSArray</span> *)connections</span><br><span class="line">                error:(<span class="built_in">NSError</span> *)error &#123;</span><br><span class="line">	<span class="keyword">if</span> (error) &#123;                                                            <span class="comment">// 1</span></span><br><span class="line">        [<span class="keyword">self</span>.delegate mediaCaptureFailedWithError:error];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> writeVideoToAssetsLibrary:[<span class="keyword">self</span>.outputURL <span class="keyword">copy</span>]];</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">self</span>.outputURL = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)writeVideoToAssetsLibrary:(<span class="built_in">NSURL</span> *)videoURL &#123;</span><br><span class="line"></span><br><span class="line">    ALAssetsLibrary *library = [[ALAssetsLibrary alloc] init];              <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([library videoAtPathIsCompatibleWithSavedPhotosAlbum:videoURL]) &#123;   <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">        ALAssetsLibraryWriteVideoCompletionBlock completionBlock;</span><br><span class="line"></span><br><span class="line">        completionBlock = ^(<span class="built_in">NSURL</span> *assetURL, <span class="built_in">NSError</span> *error)&#123;               <span class="comment">// 4</span></span><br><span class="line">            <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                [<span class="keyword">self</span>.delegate assetLibraryWriteFailedWithError:error];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span> generateThumbnailForVideoAtURL:videoURL];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        [library writeVideoAtPathToSavedPhotosAlbum:videoURL                <span class="comment">// 8</span></span><br><span class="line">                                    completionBlock:completionBlock];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è§†é¢‘ç¼©ç•¥å›¾</span></span><br><span class="line">- (<span class="keyword">void</span>)generateThumbnailForVideoAtURL:(<span class="built_in">NSURL</span> *)videoURL &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>([<span class="keyword">self</span> globalQueue], ^&#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">AVAsset</span> *asset = [<span class="built_in">AVAsset</span> assetWithURL:videoURL];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">AVAssetImageGenerator</span> *imageGenerator =                             <span class="comment">// 5</span></span><br><span class="line">            [<span class="built_in">AVAssetImageGenerator</span> assetImageGeneratorWithAsset:asset];</span><br><span class="line">        imageGenerator.maximumSize = <span class="built_in">CGSizeMake</span>(<span class="number">100.0</span>f, <span class="number">0.0</span>f);</span><br><span class="line">        imageGenerator.appliesPreferredTrackTransform = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">CGImageRef</span> imageRef = [imageGenerator copyCGImageAtTime:kCMTimeZero <span class="comment">// 6</span></span><br><span class="line">                                                     actualTime:<span class="literal">NULL</span></span><br><span class="line">                                                          error:<span class="literal">nil</span>];</span><br><span class="line">        <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithCGImage:imageRef];</span><br><span class="line">        <span class="built_in">CGImageRelease</span>(imageRef);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;                        <span class="comment">// 7</span></span><br><span class="line">            [<span class="keyword">self</span> postThumbnailNotifification:image];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Recoding Destination URL</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">AVCaptureVideoOrientation</span>)currentVideoOrientation &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureVideoOrientation</span> orientation;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> ([<span class="built_in">UIDevice</span> currentDevice].orientation) &#123;                         <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIDeviceOrientationPortrait</span>:</span><br><span class="line">            orientation = <span class="built_in">AVCaptureVideoOrientationPortrait</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIDeviceOrientationLandscapeRight</span>:</span><br><span class="line">            orientation = <span class="built_in">AVCaptureVideoOrientationLandscapeLeft</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIDeviceOrientationPortraitUpsideDown</span>:</span><br><span class="line">            orientation = <span class="built_in">AVCaptureVideoOrientationPortraitUpsideDown</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            orientation = <span class="built_in">AVCaptureVideoOrientationLandscapeRight</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> orientation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-æ¡ç è¯†åˆ«</title>
    <url>/essay/AVFoundation/AVFoundation-%E6%9D%A1%E7%A0%81%E8%AF%86%E5%88%AB/</url>
    <content><![CDATA[<blockquote>
<p>AVFoundationå¯ä»¥è¯†åˆ«ä¸€ç»´æ¡ç å’ŒäºŒç»´ç </p>
</blockquote>
<p>ä¸€ç»´æ¡ç æ”¯æŒçš„ç±»å‹æœ‰ï¼š<strong>UPC-E</strong> <strong>EAN-8</strong> <strong>EAN-13</strong> <strong>Code 39</strong> <strong>Code 93</strong> <strong>Code 128</strong> äº¤é”™å¼2of5ç ï¼ˆiOS8ä»¥ä¸Šï¼‰ ITF ï¼ˆiOS8ä»¥ä¸Šï¼‰ï¼›</p>
<p>äºŒç»´ç æ”¯æŒçš„ç±»å‹æœ‰ï¼š <strong>QR</strong> <strong>Axtec</strong> <strong>PDF-417</strong> Data matrix(iOS8ä»¥ä¸Š)</p>
<p>åŒæ ·ä½¿ç”¨<strong>AVCaptureMetadataOutput</strong> ï¼Œå’Œå®ç°AVCaptureMetadataOutputObjectsDelegateä»£ç†</p>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¿®æ”¹è¾“å‡ºé…ç½®</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)setupSessionOutputs:(<span class="built_in">NSError</span> **)error &#123;</span><br><span class="line">    <span class="keyword">self</span>.metadataOutput = [[<span class="built_in">AVCaptureMetadataOutput</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddOutput:<span class="keyword">self</span>.metadataOutput]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.captureSession addOutput:<span class="keyword">self</span>.metadataOutput];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</span><br><span class="line">        [<span class="keyword">self</span>.metadataOutput setMetadataObjectsDelegate:<span class="keyword">self</span></span><br><span class="line">                                                  queue:mainQueue];</span><br><span class="line">        <span class="comment">//æ„Ÿå…´è¶£çš„æ‰«æå¯¹è±¡æ˜¯ QR Code Azte Code ä»¥åŠ UPC-E Code</span></span><br><span class="line">        <span class="built_in">NSArray</span> *types = @[<span class="built_in">AVMetadataObjectTypeQRCode</span>,                      <span class="comment">// 1</span></span><br><span class="line">                           <span class="built_in">AVMetadataObjectTypeAztecCode</span>,</span><br><span class="line">                           <span class="built_in">AVMetadataObjectTypeUPCECode</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.metadataOutput.metadataObjectTypes = types;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedDescriptionKey</span>:</span><br><span class="line">                                       <span class="string">@"Failed to still image output."</span>&#125;;</span><br><span class="line">        *error = [<span class="built_in">NSError</span> errorWithDomain:THCameraErrorDomain</span><br><span class="line">                                     code:THCameraErrorFailedToAddOutput</span><br><span class="line">                                 userInfo:userInfo];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput</span><br><span class="line">didOutputMetadataObjects:(<span class="built_in">NSArray</span> *)metadataObjects</span><br><span class="line">       fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//metadataObjectsæä¾›äº†bounds å’Œ corners å±æ€§</span></span><br><span class="line">    <span class="comment">//boundsæä¾›äº†è¯†åˆ«ç çš„æŒ‰åæ ‡è½´å¯¹é½çš„çŸ©å½¢è¾¹ç•Œ</span></span><br><span class="line">    <span class="comment">//cornersæä¾›è§’ç‚¹å­—å…¸è¡¨ç¤ºçš„æ•°ç»„</span></span><br><span class="line">	<span class="comment">//    [self.codeDetectionDelegate didDetectCodes:metadataObjects];            // 2</span></span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (metadataObjects.count&gt;<span class="number">0</span>) &#123;        </span><br><span class="line">	        [<span class="keyword">self</span>.session stopRunning];        </span><br><span class="line">	        <span class="built_in">AVMetadataMachineReadableCodeObject</span> *metadataObject = metadataObjects.firstObject;</span><br><span class="line">   		     <span class="comment">//è¾“å‡ºæ‰«æå­—ç¬¦ä¸²        </span></span><br><span class="line">	        <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:metadataObject.stringValue message:<span class="string">@""</span> delegate:<span class="keyword">self</span> cancelButtonTitle:<span class="string">@"ok"</span> otherButtonTitles: <span class="literal">nil</span>];        </span><br><span class="line">	        [alert show];</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>rectOfInterest</p>
</blockquote>
<p>å¦‚æœä¸è®¾ç½®çš„è¯ï¼Œå°±æ˜¯AVCaptureVideoPreviewLayerä¸­é—´åŒºåŸŸï¼ˆæµ‹è¯•ä¹‹åå°±æ˜¯previewä¸­é—´çš„æ¨ªçº¿ï¼‰</p>
<p>è®¾ç½®rectOfInterest</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGSize</span> size = <span class="keyword">self</span>.view.bounds.size;</span><br><span class="line"><span class="built_in">CGRect</span> cropRect = scanBg.frame;</span><br><span class="line"><span class="keyword">self</span>.output.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y/size.height,cropRect.origin.x/size.width,cropRect.size.height/size.height,cropRect.size.width/size.width);</span><br></pre></td></tr></table></figure>
<p>æ•æ‰è®¾å¤‡åæ ‡ç³»ç›¸å¯¹äºå±å¹•åæ ‡ç³»æ—‹è½¬90Â°ã€‚å³ å³ä¸Šè§’ä¸ºï¼ˆ0ï¼Œ0ï¼‰å·¦ä¸‹è§’ä¸ºï¼ˆ1ï¼Œ1ï¼‰ã€‚</p>
<blockquote>
<p>rectOfInterest ä¸ sessionPreset</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGSize</span> size = <span class="keyword">self</span>.view.bounds.size;</span><br><span class="line"><span class="built_in">CGRect</span> cropRect = <span class="built_in">CGRectMake</span>(<span class="number">40</span>, <span class="number">100</span>, <span class="number">240</span>, <span class="number">240</span>);</span><br><span class="line"><span class="built_in">CGFloat</span> p1 = size.height/size.width;</span><br><span class="line"><span class="built_in">CGFloat</span> p2 = <span class="number">1920.</span>/<span class="number">1080.</span>;  <span class="comment">//ä½¿ç”¨äº†1920x1080çš„å›¾åƒè¾“å‡º</span></span><br><span class="line"><span class="keyword">if</span> (p1 &lt; p2) &#123;</span><br><span class="line">  <span class="built_in">CGFloat</span> fixHeight = bounds.size.width * <span class="number">1920.</span> / <span class="number">1080.</span>;</span><br><span class="line">  <span class="built_in">CGFloat</span> fixPadding = (fixHeight - size.height)/<span class="number">2</span>;</span><br><span class="line">  captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>((cropRect.origin.y + fixPadding)/fixHeight,</span><br><span class="line">                                              cropRect.origin.x/size.width,</span><br><span class="line">                                              cropRect.size.height/fixHeight,</span><br><span class="line">                                              cropRect.size.width/size.width);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">CGFloat</span> fixWidth = bounds.size.height * <span class="number">1080.</span> / <span class="number">1920.</span>;</span><br><span class="line">    <span class="built_in">CGFloat</span> fixPadding = (fixWidth - size.width)/<span class="number">2</span>;</span><br><span class="line">    captureOutput.rectOfInterest = <span class="built_in">CGRectMake</span>(cropRect.origin.y/size.height,</span><br><span class="line">                                              (cropRect.origin.x + fixPadding)/fixWidth,</span><br><span class="line">                                              cropRect.size.height/size.height,</span><br><span class="line">                                              cropRect.size.width/fixWidth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯•äº†æ”¯ä»˜å®çš„æ‰«æï¼Œå‘ç°å‡ ä¹æ•´ä¸ªå±å¹•éƒ½æ˜¯æ‰«æçµæ•åŒºåŸŸã€‚ã€‚ä¸çŸ¥é“å®ƒæ˜¯ä¸æ˜¯ä¹Ÿç”¨AVFoundationå®ç°çš„ã€‚ã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-è§†é¢‘å¤„ç†</title>
    <url>/essay/AVFoundation/AVFoundation-%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<blockquote>
<p>ä¹‹å‰åœ¨ <a href="../AVFoundationæ‹ç…§å’Œå½•åƒ/">AVFoundationæ‹ç…§å’Œå½•åƒ</a> ä¸­ä½¿ç”¨ <strong>AVCaptureMovieFileOutput</strong>ç±»æ¥æ•æ‰ QuickTimeå½±ç‰‡ï¼Œè¿™ä¸ªç±»å®šä¹‰äº†æ•æ‰è§†é¢‘æ•°æ®çš„ç®€å•æ–¹æ³•ã€‚å½“å¯¹æ•æ‰åˆ°çš„è§†é¢‘æ•°æ®è¿›è¡Œæ›´åº•å±‚çš„æ“ä½œæ—¶ï¼Œå°±éœ€è¦ç”¨åˆ° <strong>AVCaptureVideoDataOutput</strong></p>
</blockquote>
<h2 id="AVCaptureVideoDataOutputSampleBufferDelegate"><a href="#AVCaptureVideoDataOutputSampleBufferDelegate" class="headerlink" title="AVCaptureVideoDataOutputSampleBufferDelegate"></a>AVCaptureVideoDataOutputSampleBufferDelegate</h2><blockquote>
<p>ä¸AVCaptureMovieFileOutputçš„å§”æ‰˜å›è°ƒä¸åŒï¼ŒAVCaptureVideoDataOutputçš„å§”æ‰˜å›è°ƒä¸ºAVCaptureVideoDataOutputSampleBufferDelegate</p>
</blockquote>
<p>å®ƒå®šä¹‰äº†ä¸€ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>- (void)captureOutput:(AVCaptureOutput *)captureOutput didOutputSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection;</code><ul>
<li>æ¯å½“æœ‰ä¸€ä¸ªè§†é¢‘å¸§å†™å…¥è¯¥æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨</li>
</ul>
</li>
<li><code>- (void)captureOutput:(AVCaptureOutput *)captureOutput didDropSampleBuffer:(CMSampleBufferRef)sampleBuffer fromConnection:(AVCaptureConnection *)connection NS_AVAILABLE(10_7, 6_0);</code><ul>
<li>æ¯å½“ä¸€ä¸ªè¿Ÿåˆ°çš„è§†é¢‘å¸§è¢«ä¸¢å¼ƒæ—¶ï¼Œå°±ä¼šè¢«è°ƒç”¨ã€‚é€šå¸¸æ˜¯å› ä¸º åœ¨didOutputSampleBufferä¸­è°ƒç”¨äº†è€—æ—¶çš„æ“ä½œã€‚</li>
</ul>
</li>
</ul>
<h3 id="CMSampleBufferRef"><a href="#CMSampleBufferRef" class="headerlink" title="CMSampleBufferRef"></a>CMSampleBufferRef</h3><blockquote>
<p>CMSampleBufferRefå°†åŸºæœ¬çš„æ ·æœ¬æ•°æ®è¿›è¡Œå°è£…å¹¶æä¾›æ ¼å¼å’Œæ—¶é—´ä¿¡æ¯ï¼Œè¿˜ä¼šå®¶ä¼™æ˜¯å“ªä¸ªæ‰€æœ‰åœ¨è½¬æ¢å’Œå¤„ç†æ•°æ®æ—¶ç”¨åˆ°çš„å…ƒæ•°æ®ã€‚</p>
</blockquote>
<a id="more"></a>
<ul>
<li>æ ·æœ¬æ•°æ® <strong>CVImageBufferRef</strong><ul>
<li><code>CVImageBufferRef  pixelBuffer = CMSampleBufferGetImageBuffer(sampleBuffer)</code> </li>
</ul>
</li>
<li>æ ¼å¼ä¿¡æ¯ <strong>CMFormatDescriptionRef</strong> <ul>
<li><code>CMFormatDescriptionRef formatDescription = CMSampleBufferGetFormatDescription(sampleBuffer);</code> </li>
</ul>
</li>
<li>æ—¶é—´ä¿¡æ¯ <strong>CMTime</strong> </li>
<li>é™„åŠ å…ƒæ•°æ® <code>CMGetAttachment è·å–</code></li>
</ul>
<h2 id="AVCaptureVideoDataOutput"><a href="#AVCaptureVideoDataOutput" class="headerlink" title="AVCaptureVideoDataOutput"></a>AVCaptureVideoDataOutput</h2><blockquote>
<p>é…ç½®</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)setupSessionOutputs:(<span class="built_in">NSError</span> **)error &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">self</span>.videoDataOutput = [[<span class="built_in">AVCaptureVideoDataOutput</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.videoDataOutput.alwaysDiscardsLateVideoFrames = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">self</span>.videoDataOutput.videoSettings =</span><br><span class="line">    <span class="comment">//è‰²åº¦å­æŠ½æ ·åˆå§‹æ ¼å¼ä¸º 420vï¼Œä¸è¿‡openGL ESä¸€èˆ¬ä¼šä½¿ç”¨bgra</span></span><br><span class="line">    @&#123;(<span class="keyword">id</span>)kCVPixelBufferPixelFormatTypeKey : @(kCVPixelFormatType_32BGRA)&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	[<span class="keyword">self</span>.videoDataOutput setSampleBufferDelegate:<span class="keyword">self</span></span><br><span class="line">                                            queue:dispatch_get_main_queue()];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.captureSession canAddOutput:<span class="keyword">self</span>.videoDataOutput]) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.captureSession addOutput:<span class="keyword">self</span>.videoDataOutput];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput</span><br><span class="line">didOutputSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)sampleBuffer</span><br><span class="line">       fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="OpenGL-ESå¤„ç†æ•°æ®ï¼Œå°†è§†é¢‘æ•°æ®è´´åœ¨ç«‹æ–¹ä½“ä¸Š"><a href="#OpenGL-ESå¤„ç†æ•°æ®ï¼Œå°†è§†é¢‘æ•°æ®è´´åœ¨ç«‹æ–¹ä½“ä¸Š" class="headerlink" title="OpenGL ESå¤„ç†æ•°æ®ï¼Œå°†è§†é¢‘æ•°æ®è´´åœ¨ç«‹æ–¹ä½“ä¸Š"></a>OpenGL ESå¤„ç†æ•°æ®ï¼Œå°†è§†é¢‘æ•°æ®è´´åœ¨ç«‹æ–¹ä½“ä¸Š</h2><p>OpenGL ES å‚è€ƒ<br><a href="https://developer.apple.com/library/content/documentation/3DDrawing/Conceptual/OpenGLES_ProgrammingGuide/Introduction/Introduction.html" target="_blank" rel="noopener">Apple guide - About OpenGl ES</a><br><a href="https://www.raywenderlich.com/3664/opengl-tutorial-for-ios-opengl-es-2-0" target="_blank" rel="noopener">OpenGL Tutorial for iOS: OpenGL ES 2.0</a><br><a href="http://blog.csdn.net/column/details/opengl-es2-ios.html" target="_blank" rel="noopener">OpenGL ES 2.0 iOSæ•™ç¨‹</a></p>
<h3 id="åˆ›å»ºCVOpenGLESTextureCacheCreate"><a href="#åˆ›å»ºCVOpenGLESTextureCacheCreate" class="headerlink" title="åˆ›å»ºCVOpenGLESTextureCacheCreate"></a>åˆ›å»ºCVOpenGLESTextureCacheCreate</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"THCameraController.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AVFoundation/AVFoundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;OpenGLES/ES2/gl.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;OpenGLES/ES2/glext.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">THCameraController</span> () &lt;<span class="title">AVCaptureVideoDataOutputSampleBufferDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) EAGLContext *context;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">AVCaptureVideoDataOutput</span> *videoDataOutput;</span><br><span class="line"><span class="comment">//Core Video æä¾›äº†CVOpenGLESTextureCacheRef ä½œä¸ºCore Videåƒç´ bufferå’ŒOpenGL ESè´´å›¾ä¹‹é—´çš„æ¡¥æ¢ã€‚</span></span><br><span class="line"><span class="comment">//ç¼“å­˜çš„ç›®çš„æ˜¯å‡å°‘æ•°æ®ä»CPUä½•GPUä¹‹é—´è½¬ç§»çš„æ¶ˆè€—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) CVOpenGLESTextureCacheRef textureCache;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) CVOpenGLESTextureRef cameraTexture;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">THCameraController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithContext:(EAGLContext *)context &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _context = context;</span><br><span class="line">        <span class="comment">//è¿™ä¸ªå‡½æ•°å…³é”®æ˜¯åå¤‡EAGLContextå’ŒtextureCacheæŒ‡é’ˆ</span></span><br><span class="line">        CVReturn err = CVOpenGLESTextureCacheCreate(kCFAllocatorDefault,</span><br><span class="line">                                                    <span class="literal">NULL</span>,</span><br><span class="line">                                                    _context,</span><br><span class="line">                                                    <span class="literal">NULL</span>,</span><br><span class="line">                                                    &amp;_textureCache);</span><br><span class="line">        <span class="keyword">if</span> (err != kCVReturnSuccess) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"Error creating texture cache. %d"</span>, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºOpenGL-ESè´´å›¾"><a href="#åˆ›å»ºOpenGL-ESè´´å›¾" class="headerlink" title="åˆ›å»ºOpenGL ESè´´å›¾"></a>åˆ›å»ºOpenGL ESè´´å›¾</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)captureOutput:(<span class="built_in">AVCaptureOutput</span> *)captureOutput</span><br><span class="line">didOutputSampleBuffer:(<span class="built_in">CMSampleBufferRef</span>)sampleBuffer</span><br><span class="line">       fromConnection:(<span class="built_in">AVCaptureConnection</span> *)connection &#123;</span><br><span class="line"></span><br><span class="line">    CVReturn err;</span><br><span class="line">    <span class="comment">//ä»sampleBufferä¸­è·å–æ•°æ®</span></span><br><span class="line">	CVImageBufferRef pixelBuffer =                                          <span class="comment">// 1</span></span><br><span class="line">        <span class="built_in">CMSampleBufferGetImageBuffer</span>(sampleBuffer);</span><br><span class="line">    <span class="comment">//è·å–è§†é¢‘å¸§ç»´åº¦ è¿”å›å¸¦æœ‰å®½é«˜çš„CMVideoDimensions</span></span><br><span class="line">    <span class="built_in">CMFormatDescriptionRef</span> formatDescription =                              <span class="comment">// 2</span></span><br><span class="line">        <span class="built_in">CMSampleBufferGetFormatDescription</span>(sampleBuffer);</span><br><span class="line">    <span class="built_in">CMVideoDimensions</span> dimensions =</span><br><span class="line">        <span class="built_in">CMVideoFormatDescriptionGetDimensions</span>(formatDescription);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//CVOpenGLESTextureCacheCreateTextureFromImageåˆ›å»ºè´´å›¾</span></span><br><span class="line">    err = CVOpenGLESTextureCacheCreateTextureFromImage(kCFAllocatorDefault, <span class="comment">// 3</span></span><br><span class="line">                                                       _textureCache,</span><br><span class="line">                                                       pixelBuffer,</span><br><span class="line">                                                       <span class="literal">NULL</span>,</span><br><span class="line">                                                       GL_TEXTURE_2D,</span><br><span class="line">                                                       GL_RGBA,</span><br><span class="line">                                                       dimensions.height,</span><br><span class="line">                                                       dimensions.height,</span><br><span class="line">                                                       GL_BGRA,</span><br><span class="line">                                                       GL_UNSIGNED_BYTE,</span><br><span class="line">                                                       <span class="number">0</span>,</span><br><span class="line">                                                       &amp;_cameraTexture);</span><br><span class="line">    <span class="comment">//GLenum GLuint ç”¨äºå°†è´´å›¾å¯¹è±¡ä¸æ—‹è½¬çš„å°æ–¹å—è¡¨é¢è¿›è¡Œæ ¸å®çš„ç»‘å®š</span></span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">        GLenum target = CVOpenGLESTextureGetTarget(_cameraTexture);         <span class="comment">// 4</span></span><br><span class="line">        GLuint name = CVOpenGLESTextureGetName(_cameraTexture);</span><br><span class="line">        [<span class="keyword">self</span>.textureDelegate textureCreatedWithTarget:target name:name];   <span class="comment">// 5</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Error at CVOpenGLESTextureCacheCreateTextureFromImage %d"</span>, err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> cleanupTextures];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡Šæ”¾è´´å›¾å¹¶åˆ·æ–°è´´å›¾ç¼“å­˜</span></span><br><span class="line">- (<span class="keyword">void</span>)cleanupTextures &#123;                                                   <span class="comment">// 6</span></span><br><span class="line">    <span class="keyword">if</span> (_cameraTexture) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(_cameraTexture);</span><br><span class="line">        _cameraTexture = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CVOpenGLESTextureCacheFlush(_textureCache, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-ç»˜åˆ¶éŸ³é¢‘æ³¢å½¢å›¾AVAssetReader</title>
    <url>/essay/AVFoundation/AVFoundation-%E7%BB%98%E5%88%B6%E9%9F%B3%E9%A2%91%E6%B3%A2%E5%BD%A2%E5%9B%BEAVAssetReader/</url>
    <content><![CDATA[<blockquote>
<p>AVAssetReader å’Œ AVAssetWriterç±»æä¾›çš„ä½çº§åŠŸèƒ½ï¼Œèƒ½å¤„ç†æ›´å¤æ‚çš„åª’ä½“æ ·æœ¬ã€‚</p>
</blockquote>
<h2 id="AVAssetReader-å’Œ-AVAssetWriter"><a href="#AVAssetReader-å’Œ-AVAssetWriter" class="headerlink" title="AVAssetReader å’Œ AVAssetWriter"></a>AVAssetReader å’Œ AVAssetWriter</h2><blockquote>
<p>AVAssetReader</p>
</blockquote>
<p>AVAssetReader ç”¨äºä» AVAssetç¤ºä¾‹ä¸­è¯»å–åª’ä½“æ ·æœ¬ã€‚</p>
<p>é€šå¸¸ä¼šé…ç½®ä¸€ä¸ªæˆ–å¤šä¸ª<strong>AVAssetReaderOutput</strong>å®ä¾‹ï¼Œå¹¶é€šè¿‡ <strong>copyNextSampleBuffer</strong> æ–¹æ³•è®¿é—®éŸ³é¢‘å’Œè§†é¢‘å¸§ã€‚</p>
<p>ä¸€ä¸ªèµ„æºè¯»å–å™¨çš„å†…éƒ¨é€šé“éƒ½æ˜¯ä»¥å¤šçº¿ç¨‹çš„æ–¹å¼ä¸æ–­æå–ä¸‹ä¸€ä¸ªå¯ç”¨æ ·æœ¬çš„ã€‚è¿™æ ·å¯ä»¥åœ¨ç³»ç»Ÿè¯·æ±‚èµ„æºæ—¶æœ€å°åŒ–æ—¶å»¶ã€‚</p>
<a id="more"></a>
<blockquote>
<p>AVAssetWriter</p>
</blockquote>
<p>AVAssetWriter ç”¨äºå¯¹åª’ä½“èµ„æºè¿›è¡Œç¼–ç å¹¶å°†å…¶å†™å…¥åˆ°å®¹å™¨æ–‡ä»¶ä¸­ï¼ˆå¦‚MPEG-4ï¼‰ã€‚</p>
<p>é€šå¸¸ç”±ä¸€ä¸ªæˆ–å¤šä¸ª<strong>AVAssetWriterInput</strong>å¯¹è±¡é…ç½®ï¼Œç”¨äºé™„åŠ å°†åŒ…å«è¦å†™å…¥å®¹å™¨çš„åª’ä½“æ ·æœ¬çš„<strong>CMSampleBuffer</strong>å¯¹è±¡ã€‚</p>
<p>AVAssetWriterå¯ç”¨äºå®æ—¶æ“ä½œå’Œç¦»çº¿æ“ä½œä¸¤ç§ï¼š</p>
<ul>
<li>å®æ—¶ã€‚å½“å¤„ç†å®æ—¶èµ„æºæ—¶ï¼Œæ¯”å¦‚ä»AVCaptureVideoDataOutputå†™å…¥æ•æ‰æ ·æœ¬æ—¶ï¼ŒAVAssetWriterInputåº”è¯¥ä»¤<strong>expectsMediaDataInRealTime</strong>å±æ€§ä¸ºYESç±»ç¡®ä¿<strong>readyForMoreMediaData</strong>ï¼ˆæŒ‡ç¤ºä¿æŒæ•°æ®æ ·æœ¬äº¤é”™çš„æƒ…å†µä¸‹æ˜¯å¦å¯ä»¥é™„åŠ æ›´å¤šä¿¡æ¯ï¼‰å€¼è¢«æ­£ç¡®è®¡ç®—ã€‚</li>
<li>ç¦»çº¿ã€‚å½“ä»ç¦»çº¿èµ„æºä¸­è¯»å–åª’ä½“èµ„æºæ—¶ï¼Œæ¯”å¦‚ä»AVAssetReaderè¯»å–æ ·æœ¬bufferï¼Œä»ç„¶éœ€è¦<strong>readyForMoreMediaData</strong>ï¼Œå†å¯ä»¥ä½¿ç”¨<strong>requestMediaDataWhenReadyOnQueue:usingBlock</strong>æ–¹æ³•æ¥æ§åˆ¶æ•°æ®çš„æä¾›ã€‚</li>
</ul>
<h2 id="åˆ›å»ºæ³¢å½¢å›¾"><a href="#åˆ›å»ºæ³¢å½¢å›¾" class="headerlink" title="åˆ›å»ºæ³¢å½¢å›¾"></a>åˆ›å»ºæ³¢å½¢å›¾</h2><blockquote>
<p>åˆ›å»ºæ³¢å½¢éœ€è¦<br><strong>è¯»å–</strong>:è¯»å–éŸ³é¢‘æ ·æœ¬è¿›è¡Œæ¸²æŸ“ï¼Œéœ€è¦è¯»å–æˆ–è€…è§£å‹éŸ³é¢‘æ•°æ®ã€‚<br><strong>ç¼©å‡</strong>:è¯»å–åˆ°çš„æ ·æœ¬è¿œæ¯”æˆ‘ä»¬éœ€è¦çš„å¤šï¼Œå¯ä»¥å°†æ ·æœ¬åˆ†æˆå°çš„æ ·æœ¬å—ï¼Œå¹¶åœ¨æ¯ä¸ªæ ·æœ¬å—ä¸Šæ‰¾åˆ°æœ€å¤§å€¼æœ€å°å€¼å’Œå¹³å‡å€¼ã€‚<br><strong>æ¸²æŸ“</strong>:å°†ç¼©å‡åçš„æ ·æœ¬å‘ˆç°åœ¨å±å¹•ä¸Šã€‚</p>
</blockquote>
<h3 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h3><blockquote>
<p>ä½¿ç”¨AVAssetReaderå®ä¾‹ä»AVAssetä¸­è¯»å–éŸ³é¢‘æ ·æœ¬å¹¶è¿”å›ä¸€ä¸ªNSDataå¯¹è±¡</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è½½å…¥èµ„æºï¼Œè¯»å–assetæ ·æœ¬</span></span><br><span class="line">+ (<span class="keyword">void</span>)loadAudioSamplesFromAsset:(<span class="built_in">AVAsset</span> *)asset</span><br><span class="line">                  completionBlock:(THSampleDataCompletionBlock)completionBlock &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *tracks = <span class="string">@"tracks"</span>;</span><br><span class="line">    <span class="comment">//å¼‚æ­¥è½½å…¥é”®å¯¹åº”çš„èµ„æº</span></span><br><span class="line">    [asset loadValuesAsynchronouslyForKeys:@[tracks] completionHandler:^&#123;   <span class="comment">// 1</span></span><br><span class="line">        <span class="comment">//è·å–tracksé”®è½½å…¥çŠ¶æ€</span></span><br><span class="line">        <span class="built_in">AVKeyValueStatus</span> status = [asset statusOfValueForKey:tracks error:<span class="literal">nil</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSData</span> *sampleData = <span class="literal">nil</span>;</span><br><span class="line">        <span class="comment">//å¦‚æœè½½å…¥æˆåŠŸï¼Œåˆ™ä»èµ„æºéŸ³é¢‘è½¨é“ä¸­è¯»å–æ ·æœ¬</span></span><br><span class="line">        <span class="keyword">if</span> (status == <span class="built_in">AVKeyValueStatusLoaded</span>) &#123;                             <span class="comment">// 2</span></span><br><span class="line">            sampleData = [<span class="keyword">self</span> readAudioSamplesFromAsset:asset];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;                        <span class="comment">// 3</span></span><br><span class="line">            completionBlock(sampleData);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">NSData</span> *)readAudioSamplesFromAsset:(<span class="built_in">AVAsset</span> *)asset &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºAVAssetReaderå®ä¾‹</span></span><br><span class="line">    <span class="built_in">AVAssetReader</span> *assetReader =                                            <span class="comment">// 1</span></span><br><span class="line">        [[<span class="built_in">AVAssetReader</span> alloc] initWithAsset:asset error:&amp;error];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!assetReader) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Error creating asset reader: %@"</span>, [error localizedDescription]);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–èµ„æºä¸­ç¬¬ä¸€ä¸ªéŸ³é¢‘è½¨é“ï¼ˆæœ€å¥½æ˜¯æ ¹æ®éœ€æ±‚çš„åª’ä½“ç±»å‹æ¥è·å–è½¨é“ï¼‰</span></span><br><span class="line">    <span class="built_in">AVAssetTrack</span> *track =                                                   <span class="comment">// 2</span></span><br><span class="line">        [[asset tracksWithMediaType:<span class="built_in">AVMediaTypeAudio</span>] firstObject];</span><br><span class="line">    <span class="comment">//è®¾ç½®ä»èµ„æºè½¨é“è¯»å–éŸ³é¢‘æ ·æœ¬çš„è§£å‹è®¾ç½®ï¼Œå¯ä»¥åœ¨AVAudioSettings.hæ–‡ä»¶ä¸­æ‰¾åˆ°æ›´å¤šçš„é”®å€¼</span></span><br><span class="line">    <span class="built_in">NSDictionary</span> *outputSettings = @&#123;                                       <span class="comment">// 3</span></span><br><span class="line">        <span class="built_in">AVFormatIDKey</span>               : @(kAudioFormatLinearPCM),</span><br><span class="line">        <span class="built_in">AVLinearPCMIsBigEndianKey</span>   : @NO,</span><br><span class="line">		<span class="built_in">AVLinearPCMIsFloatKey</span>		: @NO,</span><br><span class="line">		<span class="built_in">AVLinearPCMBitDepthKey</span>		: @(<span class="number">16</span>)</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºAVAssetReaderTrackOutput ä½œä¸ºAVAssetReaderçš„è¾“å‡ºï¼Œå¹¶è°ƒç”¨startReadingæ¥å…è®¸èµ„æºç®¡ç†å™¨å¼€å¯é¢„æ”¶å–æ ·æœ¬æ•°æ®</span></span><br><span class="line">    <span class="built_in">AVAssetReaderTrackOutput</span> *trackOutput =                                 <span class="comment">// 4</span></span><br><span class="line">        [[<span class="built_in">AVAssetReaderTrackOutput</span> alloc] initWithTrack:track</span><br><span class="line">                                         outputSettings:outputSettings];</span><br><span class="line">    </span><br><span class="line">    [assetReader addOutput:trackOutput];</span><br><span class="line">    </span><br><span class="line">    [assetReader startReading];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableData</span> *sampleData = [<span class="built_in">NSMutableData</span> data];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (assetReader.status == <span class="built_in">AVAssetReaderStatusReading</span>) &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨è·Ÿè¸ªè¾“å‡ºçš„copyNextSampleBufferå¼€å§‹æ¯ä¸ªè¿­ä»£ï¼Œæ¯æ¬¡éƒ½è¿”å›ä¸€ä¸ªåŒ…å«éŸ³é¢‘æ ·æœ¬çš„ä¸‹ä¸€ä¸ªå¯ç”¨æ ·æœ¬buffer</span></span><br><span class="line">        <span class="built_in">CMSampleBufferRef</span> sampleBuffer = [trackOutput copyNextSampleBuffer];<span class="comment">// 5</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (sampleBuffer) &#123;</span><br><span class="line">            <span class="comment">//CMSampleBufferRefçš„éŸ³é¢‘æ ·æœ¬è¢«åŒ…å«åœ¨CMBlockBufferRefç±»å‹ä¸­</span></span><br><span class="line">            <span class="built_in">CMBlockBufferRef</span> blockBufferRef =                               <span class="comment">// 6</span></span><br><span class="line">                <span class="built_in">CMSampleBufferGetDataBuffer</span>(sampleBuffer);</span><br><span class="line">            <span class="comment">//ä½¿ç”¨CMBlockBufferGetDataLengthæ¥ç¡®å®šblockBufferRefçš„é•¿åº¦ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª16ä½å¸¦ç¬¦å·çš„æ•´å‹æ•°ç»„æ¥ä¿å­˜è¿™å†™éŸ³é¢‘æ ·æœ¬</span></span><br><span class="line">            size_t length = <span class="built_in">CMBlockBufferGetDataLength</span>(blockBufferRef);</span><br><span class="line">            SInt16 sampleBytes[length];</span><br><span class="line">            <span class="comment">//ä½¿ç”¨CMBlockBufferCopyDataBytesç”Ÿæˆä¸€ä¸ªæ•°ç»„ï¼Œå†…å®¹æ¥è‡ªCMBlockBufferRefåŒ…å«çš„æ•°æ®</span></span><br><span class="line">            <span class="built_in">CMBlockBufferCopyDataBytes</span>(blockBufferRef,                      <span class="comment">// 7</span></span><br><span class="line">                                       <span class="number">0</span>,</span><br><span class="line">                                       length,</span><br><span class="line">                                       sampleBytes);</span><br><span class="line">            <span class="comment">//å°†æ•°ç»„çš„å†…å®¹é™„åŠ åˆ°NSDataå®ä¾‹å</span></span><br><span class="line">            [sampleData appendBytes:sampleBytes length:length];</span><br><span class="line">            <span class="comment">//CMSampleBufferInvalidateå‡½æ•°æ¥æŒ‡å®šæ ·æœ¬bufferå·²ç»å¤„ç†å’Œä¸å¯å†ç»§ç»­ä½¿ç”¨ï¼Œ</span></span><br><span class="line">            <span class="built_in">CMSampleBufferInvalidate</span>(sampleBuffer);                         <span class="comment">// 8</span></span><br><span class="line">            <span class="comment">//ç„¶åç”¨CFReleaseé‡Šæ”¾CMSampleBufferRefå‰¯æœ¬</span></span><br><span class="line">            <span class="built_in">CFRelease</span>(sampleBuffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœèµ„æºè¯»å–å™¨çš„çŠ¶æ€ä¸ºAVAssetReaderStatusCompletedè¡¨ç¤ºæ•°æ®è¢«æˆåŠŸè¯»å–</span></span><br><span class="line">    <span class="keyword">if</span> (assetReader.status == <span class="built_in">AVAssetReaderStatusCompleted</span>) &#123;               <span class="comment">// 9</span></span><br><span class="line">        <span class="keyword">return</span> sampleData;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Failed to read audio samples from asset"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼©å‡éŸ³é¢‘æ ·æœ¬"><a href="#ç¼©å‡éŸ³é¢‘æ ·æœ¬" class="headerlink" title="ç¼©å‡éŸ³é¢‘æ ·æœ¬"></a>ç¼©å‡éŸ³é¢‘æ ·æœ¬</h3><blockquote>
<p>å¤„ç†å¸¦æœ‰éŸ³é¢‘ä¿¡æ¯çš„NSDataå¯¹è±¡ï¼Œæ ¹æ®æŒ‡å®šçš„å¤§å°ï¼Œå°†æ ·æœ¬åˆ†æˆä¸€ä¸ªä¸ªæ ·æœ¬å—ï¼Œæ‰¾åˆ°æ ·æœ¬å—ä¸­çš„æœ€å¤§æ ·æœ¬ï¼Œå¾—åˆ°ç­›é€‰ç»“æœã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSArray</span> *)filteredSamplesForSize:(<span class="built_in">CGSize</span>)size &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//filteredSamplesä¿å­˜ç­›é€‰çš„æ ·æœ¬æ•°ç»„</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *filteredSamples = [[<span class="built_in">NSMutableArray</span> alloc] init];        <span class="comment">// 1</span></span><br><span class="line">    <span class="comment">//sampleCountè¡¨ç¤ºæ ·æœ¬æ€»æ•°</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> sampleCount = <span class="keyword">self</span>.sampleData.length / <span class="keyword">sizeof</span>(SInt16);</span><br><span class="line">    <span class="comment">//binSizeè¡¨ç¤ºæ¯ä¸ªæ ·æœ¬å—çš„å¤§å°</span></span><br><span class="line">    <span class="built_in">NSUInteger</span> binSize = sampleCount / size.width;</span><br><span class="line"></span><br><span class="line">    SInt16 *bytes = (SInt16 *) <span class="keyword">self</span>.sampleData.bytes;</span><br><span class="line">    </span><br><span class="line">    SInt16 maxSample = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//è¿­ä»£å…¨éƒ¨éŸ³é¢‘æ ·æœ¬é›†åˆ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; sampleCount; i += binSize) &#123;</span><br><span class="line">        <span class="comment">//æ ·æœ¬å—</span></span><br><span class="line">        SInt16 sampleBin[binSize];</span><br><span class="line">        <span class="comment">//ä½¿ç”¨CFSwapInt16LittleToHostå‡½æ•°ç¡®ä¿æ ·æœ¬æ˜¯æŒ‰ä¸»æœºå†…ç½®çš„å­—èŠ‚é¡ºåºå¤„ç†çš„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> j = <span class="number">0</span>; j &lt; binSize; j++) &#123;                          <span class="comment">// 2</span></span><br><span class="line">			sampleBin[j] = <span class="built_in">CFSwapInt16LittleToHost</span>(bytes[i + j]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ‰¾åˆ°æ ·æœ¬å—ä¸­çš„æœ€å¤§ç»å¯¹å€¼,å¹¶å­˜å…¥ç­›é€‰ç»“æœ</span></span><br><span class="line">        SInt16 value = [<span class="keyword">self</span> maxValueInArray:sampleBin ofSize:binSize];     <span class="comment">// 3</span></span><br><span class="line">        [filteredSamples addObject:@(value)];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (value &gt; maxSample) &#123;                                            <span class="comment">// 4</span></span><br><span class="line">            maxSample = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çº¦æŸç­›é€‰æ ·æœ¬</span></span><br><span class="line">    <span class="built_in">CGFloat</span> scaleFactor = (size.height / <span class="number">2</span>) / maxSample;                    <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; filteredSamples.count; i++) &#123;                <span class="comment">// 6</span></span><br><span class="line">        filteredSamples[i] = @([filteredSamples[i] integerValue] * scaleFactor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> filteredSamples;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ‰¾åˆ°æ ·æœ¬å—ä¸­çš„æœ€å¤§ç»å¯¹å€¼</span></span><br><span class="line">- (SInt16)maxValueInArray:(SInt16[])values ofSize:(<span class="built_in">NSUInteger</span>)size &#123;</span><br><span class="line">    SInt16 maxValue = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (abs(values[i]) &gt; maxValue) &#123;</span><br><span class="line">            maxValue = abs(values[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maxValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¸²æŸ“éŸ³é¢‘æ ·æœ¬"><a href="#æ¸²æŸ“éŸ³é¢‘æ ·æœ¬" class="headerlink" title="æ¸²æŸ“éŸ³é¢‘æ ·æœ¬"></a>æ¸²æŸ“éŸ³é¢‘æ ·æœ¬</h3><blockquote>
<p>åˆ›å»ºUIViewå­ç±», ä½¿ç”¨<strong>QuartzCore</strong>æ¸²æŸ“ç­›é€‰åçš„ç»“æœ</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="comment">//é€‚å½“ç¼©æ”¾ä¸Šä¸‹æ–‡</span></span><br><span class="line">	<span class="built_in">CGContextScaleCTM</span>(context, THWidthScaling, THHeightScaling);            <span class="comment">// 1</span></span><br><span class="line">    <span class="comment">//é€‚å½“åœ¨x y è½´ä¸Šåç§»</span></span><br><span class="line">	<span class="built_in">CGFloat</span> xOffset = <span class="keyword">self</span>.bounds.size.width -</span><br><span class="line">                     (<span class="keyword">self</span>.bounds.size.width * THWidthScaling);</span><br><span class="line">	</span><br><span class="line">    <span class="built_in">CGFloat</span> yOffset = <span class="keyword">self</span>.bounds.size.height -</span><br><span class="line">                     (<span class="keyword">self</span>.bounds.size.height * THHeightScaling);</span><br><span class="line">	</span><br><span class="line">    <span class="built_in">CGContextTranslateCTM</span>(context, xOffset / <span class="number">2</span>, yOffset / <span class="number">2</span>);</span><br><span class="line">    <span class="comment">//è·å–ç­›é€‰åçš„éŸ³é¢‘æ ·æœ¬</span></span><br><span class="line">	<span class="built_in">NSArray</span> *filteredSamples =                                              <span class="comment">// 2</span></span><br><span class="line">        [<span class="keyword">self</span>.filter filteredSamplesForSize:<span class="keyword">self</span>.bounds.size];</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CGFloat</span> midY = <span class="built_in">CGRectGetMidY</span>(rect);</span><br><span class="line">    <span class="comment">//åˆ›å»ºCGMutablePathRefå¯¹è±¡ ç”¨æ¥ç»˜åˆ¶Bezierè·¯å¾„çš„ä¸ŠåŠéƒ¨</span></span><br><span class="line">	<span class="built_in">CGMutablePathRef</span> halfPath = <span class="built_in">CGPathCreateMutable</span>();                      <span class="comment">// 3</span></span><br><span class="line">	<span class="built_in">CGPathMoveToPoint</span>(halfPath, <span class="literal">NULL</span>, <span class="number">0.0</span>f, midY);</span><br><span class="line">    <span class="comment">//è¿­ä»£æ ·æœ¬ æ¯æ¬¡å‘è·¯å¾„ä¸­æ·»åŠ ä¸€ä¸ªç‚¹</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; filteredSamples.count; i++) &#123;</span><br><span class="line">		<span class="keyword">float</span> sample = [filteredSamples[i] floatValue];</span><br><span class="line">		<span class="built_in">CGPathAddLineToPoint</span>(halfPath, <span class="literal">NULL</span>, i, midY - sample);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CGPathAddLineToPoint</span>(halfPath, <span class="literal">NULL</span>, filteredSamples.count, midY);</span><br><span class="line">    <span class="comment">//ç»˜åˆ¶å®Œæ•´æ³¢å½¢</span></span><br><span class="line">	<span class="built_in">CGMutablePathRef</span> fullPath = <span class="built_in">CGPathCreateMutable</span>();                      <span class="comment">// 4</span></span><br><span class="line">	<span class="built_in">CGPathAddPath</span>(fullPath, <span class="literal">NULL</span>, halfPath);</span><br><span class="line">w</span><br><span class="line">	<span class="built_in">CGAffineTransform</span> transform = <span class="built_in">CGAffineTransformIdentity</span>;                <span class="comment">// 5</span></span><br><span class="line">	transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="number">0</span>, <span class="built_in">CGRectGetHeight</span>(rect));</span><br><span class="line">	transform = <span class="built_in">CGAffineTransformScale</span>(transform, <span class="number">1.0</span>, <span class="number">-1.0</span>);</span><br><span class="line">	<span class="built_in">CGPathAddPath</span>(fullPath, &amp;transform, halfPath);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">CGContextAddPath</span>(context, fullPath);                                    <span class="comment">// 6</span></span><br><span class="line">    <span class="built_in">CGContextSetFillColorWithColor</span>(context, <span class="keyword">self</span>.waveColor.CGColor);</span><br><span class="line">    <span class="built_in">CGContextDrawPath</span>(context, kCGPathFill);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGPathRelease</span>(halfPath);                                                <span class="comment">// 7</span></span><br><span class="line">    <span class="built_in">CGPathRelease</span>(fullPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-é«˜å¸§ç‡æ•æ‰</title>
    <url>/essay/AVFoundation/AVFoundation-%E9%AB%98%E5%B8%A7%E7%8E%87%E6%8D%95%E6%8D%89/</url>
    <content><![CDATA[<blockquote>
<p>ä»¥é«˜å¸§ç‡ï¼ˆFPSï¼‰æ•æ‰è§†é¢‘å†…å®¹å¸¦æ¥å¾ˆå¤šå¥½å¤„</p>
</blockquote>
<p><strong>AVCaptureDeviceFormat</strong>å®ä¾‹å…·æœ‰ <code>videoSupportedFrameRateRanges</code> å±æ€§ï¼Œå®ƒåŒ…å«ä¸€ä¸ª<strong>AVFrameRateRange</strong>å¯¹è±¡æ•°ç»„ï¼Œå…¶ä¸­å¸¦æœ‰æ ¼å¼æ‰€æ”¯æŒçš„æœ€å°å¸§ç‡ã€æœ€å¤§å¸§ç‡å’Œæ—¶é•¿ä¿¡æ¯ã€‚</p>
<blockquote>
<p>ç¡®å®šæ˜¯å¦æ”¯æŒé«˜å¸§ç‡</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AVCaptureDevice</span> (<span class="title">THAdditions</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ˜¯å¦æ”¯æŒé«˜å¸§ç‡</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)supportsHighFrameRateCapture &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> hasMediaType:<span class="built_in">AVMediaTypeVideo</span>]) &#123;                            <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> findHighestQualityOfService].isHighFrameRate;              <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŸ¥æ‰¾è®¾å¤‡æ‰€æ”¯æŒçš„å¸§ç‡ç­‰ä¿¡æ¯</span></span><br><span class="line">- (THQualityOfService *)findHighestQualityOfService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVCaptureDeviceFormat</span> *maxFormat = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">AVFrameRateRange</span> *maxFrameRateRange = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">AVCaptureDeviceFormat</span> *format <span class="keyword">in</span> <span class="keyword">self</span>.formats) &#123;</span><br><span class="line"></span><br><span class="line">        FourCharCode codecType =                                            <span class="comment">// 3</span></span><br><span class="line">            <span class="built_in">CMVideoFormatDescriptionGetCodecType</span>(format.formatDescription);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (codecType == kCVPixelFormatType_420YpCbCr8BiPlanarVideoRange) &#123; <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSArray</span> *frameRateRanges = format.videoSupportedFrameRateRanges;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">AVFrameRateRange</span> *range <span class="keyword">in</span> frameRateRanges) &#123;              <span class="comment">// 5</span></span><br><span class="line">                <span class="keyword">if</span> (range.maxFrameRate &gt; maxFrameRateRange.maxFrameRate) &#123;</span><br><span class="line">                    maxFormat = format;</span><br><span class="line">                    maxFrameRateRange = range;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [THQualityOfService qosWithFormat:maxFormat                      <span class="comment">// 6</span></span><br><span class="line">                              frameRateRange:maxFrameRateRange];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¼€å¯é«˜å¸§ç‡</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)enableMaxFrameRateCapture:(<span class="built_in">NSError</span> **)error &#123;</span><br><span class="line"></span><br><span class="line">    THQualityOfService *qos = [<span class="keyword">self</span> findHighestQualityOfService];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!qos.isHighFrameRate) &#123;                                             <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *message = <span class="string">@"Device does not support high FPS capture"</span>;</span><br><span class="line">            <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedDescriptionKey</span> : message&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">NSUInteger</span> code = THCameraErrorHighFrameRateCaptureNotSupported;</span><br><span class="line"></span><br><span class="line">            *error = [<span class="built_in">NSError</span> errorWithDomain:THCameraErrorDomain</span><br><span class="line">                                         code:code</span><br><span class="line">                                     userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> lockForConfiguration:error]) &#123;                                <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">CMTime</span> minFrameDuration = qos.frameRateRange.minFrameDuration;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.activeFormat = qos.format;                                     <span class="comment">// 3</span></span><br><span class="line">        <span class="keyword">self</span>.activeVideoMinFrameDuration = minFrameDuration;                <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">self</span>.activeVideoMaxFrameDuration = minFrameDuration;</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span> unlockForConfiguration];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<blockquote>
<p>è¾…åŠ©ç±»</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">THQualityOfService</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)qosWithFormat:(<span class="built_in">AVCaptureDeviceFormat</span> *)format</span><br><span class="line">               frameRateRange:(<span class="built_in">AVFrameRateRange</span> *)frameRateRange &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] initWithFormat:format frameRateRange:frameRateRange];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithFormat:(<span class="built_in">AVCaptureDeviceFormat</span> *)format</span><br><span class="line">                frameRateRange:(<span class="built_in">AVFrameRateRange</span> *)frameRateRange &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _format = format;</span><br><span class="line">        _frameRateRange = frameRateRange;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¤§äº30å°±çœ‹æˆé«˜å¸§ç‡</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isHighFrameRate &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.frameRateRange.maxFrameRate &gt; <span class="number">30.0</span>f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>AVFoundation-ç¼©æ”¾</title>
    <url>/essay/AVFoundation/AVFoundation-%E7%BC%A9%E6%94%BE/</url>
    <content><![CDATA[<h2 id="iOS7ä»¥å‰ä½¿ç”¨AVCaptureConnection"><a href="#iOS7ä»¥å‰ä½¿ç”¨AVCaptureConnection" class="headerlink" title="iOS7ä»¥å‰ä½¿ç”¨AVCaptureConnection"></a>iOS7ä»¥å‰ä½¿ç”¨AVCaptureConnection</h2><blockquote>
<p>é€šè¿‡ <strong>AVCaptureConnection</strong> çš„å±æ€§å¯¹æ‘„åƒå¤´ç¼©æ”¾è¿›è¡Œæœ‰é™åˆ¶çš„æ”¯æŒï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è°ƒæ•´è¿æ¥ç¼©æ”¾çš„å€¼ä»é»˜è®¤çš„1.0å¢åŠ åˆ° <code>videoMaxScaleAndCropFactor</code>å±æ€§å®šä¹‰çš„æœ€å¤§å€¼</p>
</blockquote>
<p>éœ€è¦ç”¨åˆ°AVCaptureConnectionçš„ä¸¤ä¸ªå±æ€§</p>
<ul>
<li>@property(nonatomic) CGFloat videoScaleAndCropFactor</li>
<li>@property(nonatomic, readonly) CGFloat videoMaxScaleAndCropFactor</li>
</ul>
<p>videoScaleAndCropFactorè¿™ä¸ªå±æ€§å–å€¼èŒƒå›´æ˜¯1.0-videoMaxScaleAndCropFactor</p>
<a id="more"></a>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">AVCaptureStillImageOutput</span>* output = (<span class="built_in">AVCaptureStillImageOutput</span>*)[<span class="keyword">self</span>.captureSession.outputs objectAtIndex:<span class="number">0</span>];</span><br><span class="line"> <span class="built_in">AVCaptureConnection</span> *videoConnection = [output connectionWithMediaType:<span class="built_in">AVMediaTypeVideo</span>];</span><br><span class="line"> <span class="built_in">CGFloat</span> maxScale = videoConnection.videoMaxScaleAndCropFactor;</span><br><span class="line"> <span class="built_in">CGFloat</span> zoom = maxScale / <span class="number">50</span>;</span><br><span class="line"> <span class="keyword">if</span> (zoom &lt; <span class="number">1.0</span>f || zoom &gt; maxScale)</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> videoConnection.videoScaleAndCropFactor += zoom;</span><br><span class="line"> <span class="keyword">self</span>.preVideoView.transform = <span class="built_in">CGAffineTransformScale</span>(<span class="keyword">self</span>.preVideoView.transform, zoom, zoom);</span><br></pre></td></tr></table></figure>
<h2 id="iOS7ä»¥å-ä½¿ç”¨-AVCaptureDevice"><a href="#iOS7ä»¥å-ä½¿ç”¨-AVCaptureDevice" class="headerlink" title="iOS7ä»¥å ä½¿ç”¨ AVCaptureDevice"></a>iOS7ä»¥å ä½¿ç”¨ AVCaptureDevice</h2><blockquote>
<p><strong>AVCaptureDevice</strong> æä¾›äº†å±æ€§ videoZoomFactorç”¨äºæ§åˆ¶æ•æ‰è®¾å¤‡çš„ç¼©æ”¾ç­‰çº§ï¼Œè¿™ä¸ªå€¼æœ€å°ä¸º1.0ï¼Œæœ€å¤§å€¼ç”±æ•æ‰è®¾å¤‡çš„ activeFormat å€¼ç¡®å®š</p>
</blockquote>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//videoMaxZoomFactorå€¼å¤§äº1.0ï¼Œåˆ™æ•æ‰è®¾å¤‡æ”¯æŒç¼©æ”¾åŠŸèƒ½</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)cameraSupportsZoom &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>.activeCamera.activeFormat.videoMaxZoomFactor &gt; <span class="number">1.0</span>f;        <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç¡®å®šæœ€å¤§ç¼©æ”¾å› å­ï¼Œ4.0fæ˜¯éšæ„è®¾ç½®çš„</span></span><br><span class="line">- (<span class="built_in">CGFloat</span>)maxZoomFactor &#123;</span><br><span class="line">	<span class="keyword">return</span> MIN(<span class="keyword">self</span>.activeCamera.activeFormat.videoMaxZoomFactor, <span class="number">4.0</span>f);    <span class="comment">// 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setZoomValue:(<span class="built_in">CGFloat</span>)zoomValue &#123;                                   <span class="comment">// 3</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">self</span>.activeCamera.isRampingVideoZoom) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSError</span> *error;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.activeCamera lockForConfiguration:&amp;error]) &#123;              <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Provide linear feel to zoom slider</span></span><br><span class="line">			<span class="built_in">CGFloat</span> zoomFactor = pow([<span class="keyword">self</span> maxZoomFactor], zoomValue);      <span class="comment">// 5</span></span><br><span class="line">            <span class="comment">//åº”ç”¨ç¨‹åºæä¾›çš„ç¼©æ”¾èŒƒå›´1Xåˆ°4X æ˜¯æŒ‡æ•°å½¢å¼çš„ï¼Œæ‰€ä»¥è¦æä¾›èŒƒå›´çº¿æ€§å¢é•¿çš„æ„Ÿè§‰</span></span><br><span class="line">            <span class="keyword">self</span>.activeCamera.videoZoomFactor = zoomFactor;</span><br><span class="line"></span><br><span class="line">            [<span class="keyword">self</span>.activeCamera unlockForConfiguration];                     <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.delegate deviceConfigurationFailedWithError:error];</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ·»åŠ ç›‘å¬ç¼©æ”¾"><a href="#æ·»åŠ ç›‘å¬ç¼©æ”¾" class="headerlink" title="æ·»åŠ ç›‘å¬ç¼©æ”¾"></a>æ·»åŠ ç›‘å¬ç¼©æ”¾</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)setupSessionInputs:(<span class="built_in">NSError</span> **)error &#123;</span><br><span class="line">	<span class="built_in">BOOL</span> success = [<span class="keyword">super</span> setupSessionInputs:error];                        <span class="comment">// 1</span></span><br><span class="line">	<span class="keyword">if</span> (success) &#123;</span><br><span class="line">		[<span class="keyword">self</span>.activeCamera addObserver:<span class="keyword">self</span>                                 <span class="comment">// 2</span></span><br><span class="line">							forKeyPath:<span class="string">@"videoZoomFactor"</span></span><br><span class="line">							   options:<span class="number">0</span></span><br><span class="line">							   context:&amp;THRampingVideoZoomFactorContext];</span><br><span class="line">		[<span class="keyword">self</span>.activeCamera addObserver:<span class="keyword">self</span>                                 <span class="comment">// 3</span></span><br><span class="line">							forKeyPath:<span class="string">@"rampingVideoZoom"</span></span><br><span class="line">							   options:<span class="number">0</span></span><br><span class="line">							   context:&amp;THRampingVideoZoomContext];</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">					  ofObject:(<span class="keyword">id</span>)object</span><br><span class="line">						change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">					   context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (context == &amp;THRampingVideoZoomContext) &#123;</span><br><span class="line">        [<span class="keyword">self</span> updateZoomingDelegate];                                       <span class="comment">// 4</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (context == &amp;THRampingVideoZoomFactorContext) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">self</span>.activeCamera.isRampingVideoZoom) &#123;</span><br><span class="line">			[<span class="keyword">self</span> updateZoomingDelegate];                                   <span class="comment">// 5</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		[<span class="keyword">super</span> observeValueForKeyPath:keyPath</span><br><span class="line">							 ofObject:object</span><br><span class="line">							   change:change</span><br><span class="line">							  context:context];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>Mach-Oåº”ç”¨ fishhookåŠ¨æ€ä¿®æ”¹Cå‡½æ•°</title>
    <url>/essay/LLDB/Mach-O_fishhook/</url>
    <content><![CDATA[<h2 id="fishhookç®€ä»‹"><a href="#fishhookç®€ä»‹" class="headerlink" title="fishhookç®€ä»‹"></a>fishhookç®€ä»‹</h2><p>C è¯­è¨€å¾€å¾€ä¼šç»™æˆ‘ä»¬ç•™ä¸‹ä¸å¯ä¿®æ”¹çš„è¿™ä¸€å°è±¡,è€Œ <a href="https://github.com/facebook/fishhook" target="_blank" rel="noopener">fishhook</a> æ˜¯ä¸€ä¸ªç”± facebook å¼€æºçš„ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯<strong>åŠ¨æ€ä¿®æ”¹ C è¯­è¨€å‡½æ•°å®ç°</strong>ã€‚</p>
<p>è¿™ä¸ªæ¡†æ¶çš„ä»£ç å…¶å®éå¸¸çš„ç®€å•ï¼ŒåªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼šfishhook.c ä»¥åŠ fishhook.hï¼›ä¸¤ä¸ªæ–‡ä»¶æ‰€æœ‰çš„ä»£ç åŠ èµ·æ¥ä¹Ÿä¸è¶…è¿‡ 300 è¡Œã€‚ä¸è¿‡å®ƒçš„å®ç°åŸç†æ˜¯éå¸¸æœ‰æ„æ€å¹¶ä¸”ç²¾å¦™çš„</p>
<p>fishhook æä¾›éå¸¸ç®€å•çš„ä¸¤ä¸ªæ¥å£ä»¥åŠä¸€ä¸ªç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">void</span> *replacement;</span><br><span class="line">	<span class="keyword">void</span> **replaced;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols_image</span><span class="params">(<span class="keyword">void</span> *header,<span class="keyword">intptr_t</span> slide,</span></span></span><br><span class="line"><span class="function"><span class="params">struct rebinding rebindings[],</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥ä» fishhook æä¾›çš„demoä¸­ä¸Šæ‰‹å®è·µä¸€ä¸‹,è¿™é‡Œçš„demoå¯¹ <code>close</code> è¿›è¡Œä¿®æ”¹:</p>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"dlfcn.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"fishhook.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜ä¸€ä¸ªä¸åŸå‡½æ•°ç­¾åç›¸åŒçš„å‡½æ•°æŒ‡é’ˆ,ç”¨ä¿å­˜åŸå§‹çš„å‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*orig_close)(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ–°çš„close</span></span><br><span class="line"><span class="keyword">int</span> my_close(<span class="keyword">int</span> fd) &#123;</span><br><span class="line">    printf(<span class="string">"åšä¸€äº›é¢å¤–æ“ä½œ\n"</span>);</span><br><span class="line">    printf(<span class="string">"è°ƒç”¨åŸ close(%d)\n"</span>, fd);</span><br><span class="line">    <span class="comment">//è°ƒç”¨çš„ orig_close å…¶å®ç›¸å½“äºæ‰§è¡ŒåŸ close</span></span><br><span class="line">    <span class="keyword">return</span> orig_close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[]) &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">struct</span> rebinding closeBind;</span><br><span class="line">        <span class="comment">//å‡½æ•°çš„åç§°</span></span><br><span class="line">        closeBind.name = <span class="string">"close"</span>;</span><br><span class="line">        <span class="comment">//æ–°çš„å‡½æ•°åœ°å€</span></span><br><span class="line">        closeBind.replacement = my_close;</span><br><span class="line">        <span class="comment">//ä¿å­˜åŸå§‹å‡½æ•°åœ°å€çš„å˜é‡çš„æŒ‡é’ˆ</span></span><br><span class="line">        closeBind.replaced = (<span class="keyword">void</span> *)&amp;orig_close;</span><br><span class="line">        <span class="comment">//å®šä¹‰æ•°ç»„</span></span><br><span class="line">        <span class="keyword">struct</span> rebinding rebs[] = &#123;closeBind&#125;;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         å¯¹ç¬¦å·è¿›è¡Œé‡ç»‘å®š arg1 : å­˜æ”¾rebindingç»“æ„ä½“çš„æ•°ç»„ arg2 : æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rebind_symbols(rebs, <span class="number">1</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¼€å§‹æµ‹è¯•:</span></span><br><span class="line">        <span class="keyword">int</span> fd = open(argv[<span class="number">0</span>], O_RDONLY);</span><br><span class="line">        uint32_t magic_number = <span class="number">0</span>;</span><br><span class="line">        read(fd, &amp;magic_number, <span class="number">4</span>);</span><br><span class="line">        printf(<span class="string">"Mach-O Magic Number: %x \n"</span>, magic_number);</span><br><span class="line">        close(fd);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>([AppDelegate <span class="keyword">class</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åæŸ¥çœ‹è¾“å‡ºçš„ä¿¡æ¯å¯ä»¥çœ‹åˆ° åœ¨å¯¹ç¬¦å·è¿›è¡Œé‡ç»‘å®šä¹‹åï¼Œæ‰€æœ‰è°ƒç”¨ <code>close</code> å‡½æ•°çš„åœ°æ–¹å®é™…ä¸Šéƒ½ä¼šæ‰§è¡Œ <code>my_close</code> çš„å®ç°ï¼Œä¹Ÿå°±å®Œæˆäº†å¯¹ <code>close</code> çš„ä¿®æ”¹ã€‚</p>
<p>é‚£ä¹ˆ fishhook æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p>
<h2 id="fishhook-åŸç†"><a href="#fishhook-åŸç†" class="headerlink" title="fishhook åŸç†"></a>fishhook åŸç†</h2><p>fishhook æ˜¯ FaceBook å¼€æºçš„å¯ä»¥åŠ¨æ€ä¿®æ”¹ MachO ç¬¦å·è¡¨çš„å·¥å…·ã€‚fishhook çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒå¯ä»¥ HOOK ç³»ç»Ÿçš„é™æ€ C å‡½æ•°ã€‚</p>
<p>å¤§å®¶éƒ½çŸ¥é“ OC çš„æ–¹æ³•ä¹‹æ‰€ä»¥å¯ä»¥ HOOK æ˜¯å› ä¸ºå®ƒçš„è¿è¡Œæ—¶ç‰¹æ€§ï¼ŒOC çš„æ–¹æ³•è°ƒç”¨åœ¨åº•å±‚éƒ½æ˜¯ msg_sendï¼ˆid,SELï¼‰çš„å½¢å¼ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†äº¤æ¢æ–¹æ³•å®ç°ï¼ˆIMPï¼‰çš„æœºä¼šï¼Œä½† C å‡½æ•°åœ¨ç¼–è¯‘é“¾æ¥æ—¶å°±ç¡®å®šäº†å‡½æ•°æŒ‡é’ˆçš„åœ°å€åç§»é‡ï¼ˆOffsetï¼‰ï¼Œè¿™ä¸ªåç§»é‡åœ¨ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ˜¯å›ºå®šçš„ã€‚æ—¢ç„¶ C å‡½æ•°çš„æŒ‡é’ˆåœ°å€æ˜¯ç›¸å¯¹å›ºå®šä¸”ä¸å¯ä¿®æ”¹çš„ï¼Œé‚£ä¹ˆ fishhook åˆæ˜¯æ€ä¹ˆå®ç° å¯¹ C å‡½æ•°çš„ HOOK å‘¢ï¼Ÿ<strong>å…¶å®å†…éƒ¨/è‡ªå®šä¹‰çš„ C å‡½æ•° fishhook ä¹Ÿ HOOK ä¸äº†ï¼Œå®ƒåªèƒ½HOOK Mach-O å¤–éƒ¨ï¼ˆå…±äº«ç¼“å­˜åº“ä¸­ï¼‰çš„å‡½æ•°</strong>ã€‚</p>
<p>ç°åœ¨å…ˆæ¥çœ‹ä¸€ä¸‹ä»¥ä¸‹è¿™å‡ ä¸ªçŸ¥è¯†ç‚¹:</p>
<h3 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h3><p>åŠ¨æ€é“¾æ¥å°±æ˜¯è´Ÿè´£å°†å„ç§å„æ ·ç¨‹åºéœ€è¦çš„é•œåƒåŠ è½½åˆ°ç¨‹åºè¿è¡Œçš„å†…å­˜ç©ºé—´ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿçš„æ—¶é—´éå¸¸æ—©ï¼š <em>åœ¨ objc è¿è¡Œæ—¶åˆå§‹åŒ–ä¹‹å‰</em> ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸ªç®€å•çš„demoä¸ºä¾‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// helloFishhook.m</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Hello, World!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Hello, World!\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æˆ‘ä»¬åœ¨ <a href="/essay/LLDB/iOS_Compiler/">iOSç¼–è¯‘è¿‡ç¨‹</a> ä¸­å®è·µçš„ä¸€æ · ï¼Œå…ˆç”¨clangç¼–è¯‘ä¸€ä¸‹ï¼Œå†ç”¨<code>nm</code>å‘½ä»¤æŸ¥çœ‹ç¬¦å·:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#clang helloFishhook.m</span></span><br><span class="line"><span class="comment">#nm -nm a.out </span></span><br><span class="line">                 (undefined) external _printf (from libSystem)</span><br><span class="line">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class="line">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class="line">0000000100000f30 (__TEXT,__text) external _hello_world</span><br><span class="line">0000000100000f50 (__TEXT,__text) external _main</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è‡ªå·±å†™çš„æ–¹æ³• <code>_hello_world</code> ,å®ƒåŒ…å«ä¸€ä¸ªå†…å­˜åœ°å€ä»¥åŠ __TEXT æ®µã€‚ä¹Ÿå°±æ˜¯è¯´æ‰‹å†™çš„ä¸€äº›å‡½æ•°ï¼Œåœ¨ç¼–è¯‘ä¹‹åï¼Œå…¶åœ°å€å¹¶ä¸æ˜¯æœªå®šä¹‰çš„</p>
<p>ä¸ä¹‹å¯¹æ¯”çš„æ˜¯çœ‹åˆ° <code>_printf</code> è¿™ä¸ªç¬¦å·æ˜¯æœªå®šä¹‰çš„(undefined),<code>dyld_stub_binder</code> ä¼šåœ¨ç›®æ ‡ç¬¦å·ï¼ˆä¾‹å¦‚ printfï¼‰è¢«è°ƒç”¨æ—¶ï¼Œå°†å…¶é“¾æ¥åˆ°æŒ‡å®šçš„åŠ¨æ€é“¾æ¥åº“ libSystemï¼Œå†æ‰§è¡Œ printf çš„å®ç°</p>
<p>æ¯ä¸€ä¸ªé•œåƒä¸­çš„ <strong>DATA ç«¯éƒ½åŒ…å«ä¸¤ä¸ªä¸åŠ¨æ€é“¾æ¥æœ‰å…³çš„è¡¨ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ </strong>nl_symbol_ptrï¼Œå¦ä¸€ä¸ªæ˜¯ <code>__la_symbol_ptr</code>ï¼š</p>
<ul>
<li><code>__nl_symbol_ptr</code> ä¸­çš„ non-lazy ç¬¦å·æ˜¯åœ¨åŠ¨æ€é“¾æ¥åº“ç»‘å®šçš„æ—¶å€™è¿›è¡ŒåŠ è½½çš„</li>
<li><code>__la_symbol_ptr</code> ä¸­çš„ç¬¦å·ä¼šåœ¨è¯¥ç¬¦å·è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œé€šè¿‡ dyld ä¸­çš„ dyld_stub_binder è¿‡ç¨‹æ¥è¿›è¡ŒåŠ è½½</li>
</ul>
<p>äº†è§£è¿™ä¸¤ç‚¹çš„åŒºåˆ«ï¼Œä½ ä¹Ÿå¤§æ¦‚å¯ä»¥çŒœå‡º fishhook ä¸ºä»€ä¹ˆèƒ½æ›¿æ¢åŸCå‡½æ•°äº†ã€‚</p>
<h3 id="PICï¼ˆPosition-independent-code"><a href="#PICï¼ˆPosition-independent-code" class="headerlink" title="PICï¼ˆPosition-independent code)"></a>PICï¼ˆPosition-independent code)</h3><p>ä¸ºä»€ä¹ˆ printf æ˜¯æœªå®šä¹‰çš„ï¼Ÿ</p>
<p>ASLRæŠ€æœ¯ï¼šæ˜¯ä¸€ç§é’ˆå¯¹ç¼“å†²åŒºæº¢å‡ºçš„å®‰å…¨ä¿æŠ¤æŠ€æœ¯ï¼Œé€šè¿‡å¯¹å †ã€æ ˆã€å…±äº«åº“æ˜ å°„ç­‰çº¿æ€§åŒºå¸ƒå±€çš„éšæœºåŒ–ï¼Œé€šè¿‡å¢åŠ æ”»å‡»è€…é¢„æµ‹ç›®çš„åœ°å€çš„éš¾åº¦ã€‚å¯¹äºæˆ‘ä»¬APPè€Œè¨€ï¼Œå®ƒä¿è¯æ¯æ¬¡MachOæ–‡ä»¶åŠ è½½çš„æ—¶å€™æ˜¯éšæœºåœ°å€  <strong>è¿™ä¸ªæˆ‘ä»¬å¯ä»¥é€šè¿‡LLDBæŒ‡ä»¤çš„image listå»æŸ¥çœ‹</strong></p>
<p>è‹¹æœé‡‡ç”¨äº†PICï¼ˆPosition-independent codeï¼‰æŠ€æœ¯æˆåŠŸè®© C çš„åº•å±‚ä¹Ÿèƒ½æœ‰åŠ¨æ€çš„è¡¨ç°ï¼š</p>
<ul>
<li>ç¼–è¯‘æ—¶åœ¨ Mach-O æ–‡ä»¶ _DATA æ®µçš„ç¬¦å·è¡¨ä¸­ä¸ºæ¯ä¸€ä¸ªè¢«å¼•ç”¨çš„ç³»ç»Ÿ C å‡½æ•°å»ºç«‹ä¸€ä¸ªæŒ‡é’ˆï¼ˆ8å­—èŠ‚çš„æ•°æ®ï¼Œæ”¾çš„å…¨æ˜¯0ï¼‰ï¼Œè¿™ä¸ªæŒ‡é’ˆç”¨äºåŠ¨æ€ç»‘å®šæ—¶é‡å®šä½åˆ°å…±äº«åº“ä¸­çš„å‡½æ•°å®ç°ã€‚</li>
<li>åœ¨è¿è¡Œæ—¶å½“ç³»ç»Ÿ C å‡½æ•°è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šåŠ¨æ€ç»‘å®šä¸€æ¬¡ï¼Œç„¶åå°† Mach-O ä¸­çš„ _DATA æ®µç¬¦å·è¡¨ä¸­å¯¹åº”çš„æŒ‡é’ˆï¼ŒæŒ‡å‘å¤–éƒ¨å‡½æ•°ï¼ˆå…¶åœ¨å…±äº«åº“ä¸­çš„å®é™…å†…å­˜åœ°å€ï¼‰ã€‚</li>
</ul>
<p>fishhook æ­£æ˜¯åˆ©ç”¨äº† PIC æŠ€æœ¯åšäº†è¿™ä¹ˆä¸¤ä¸ªæ“ä½œï¼š</p>
<ul>
<li>å°†æŒ‡å‘ç³»ç»Ÿæ–¹æ³•ï¼ˆå¤–éƒ¨å‡½æ•°ï¼‰çš„æŒ‡é’ˆé‡æ–°è¿›è¡Œç»‘å®šæŒ‡å‘å†…éƒ¨å‡½æ•°/è‡ªå®šä¹‰ C å‡½æ•°ã€‚</li>
<li>å°†å†…éƒ¨å‡½æ•°çš„æŒ‡é’ˆåœ¨åŠ¨æ€é“¾æ¥æ—¶æŒ‡å‘ç³»ç»Ÿæ–¹æ³•çš„åœ°å€ã€‚</li>
</ul>
<p>è¿™æ ·å°±æŠŠç³»ç»Ÿæ–¹æ³•ä¸è‡ªå·±å®šä¹‰çš„æ–¹æ³•è¿›è¡Œäº†äº¤æ¢ï¼Œè¾¾åˆ° HOOK ç³»ç»Ÿ C å‡½æ•°ï¼ˆå…±äº«åº“ä¸­çš„ï¼‰çš„ç›®çš„ã€‚</p>
<h3 id="dyld-åŠ è½½å›è°ƒ"><a href="#dyld-åŠ è½½å›è°ƒ" class="headerlink" title="dyld åŠ è½½å›è°ƒ"></a>dyld åŠ è½½å›è°ƒ</h3><p>åœ¨ dyld åŠ è½½é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°; å¯¹äºæ¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é•œåƒï¼Œå½“å®ƒè¢«åŠ¨æ€é“¾æ¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒ </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> (*func)(<span class="keyword">const</span> struct mach_header* mh, <span class="keyword">intptr_t</span> vmaddr_slide)</span><br></pre></td></tr></table></figure>
<p>ä¼ å…¥æ–‡ä»¶çš„ <code>mach_header</code> ä»¥åŠä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ <code>intptr_t</code>ã€‚</p>
<p>dyld é€šè¿‡æ›´æ–° Mach-O äºŒè¿›åˆ¶æ–‡ä»¶ __DATA æ®µä¸­çš„ä¸€äº›æŒ‡é’ˆæ¥ç»‘å®š lazy å’Œ non-lazy çš„ç¬¦å·ï¼›</p>
<p>è€Œ fishhook å…ˆç¡®å®šæŸä¸€ä¸ªç¬¦å·åœ¨ __DATA æ®µä¸­çš„ä½ç½®ï¼Œ<strong>ç„¶åä¿å­˜åŸç¬¦å·å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨æ–°çš„å‡½æ•°æŒ‡é’ˆè¦†ç›–åŸæœ‰ç¬¦å·çš„å‡½æ•°æŒ‡é’ˆï¼Œå®ç°é‡ç»‘å®šã€‚</strong></p>
<h2 id="fishhook-æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„"><a href="#fishhook-æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„" class="headerlink" title="fishhook æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„"></a>fishhook æ˜¯å¦‚ä½•æ ¹æ®å­—ç¬¦ä¸²æ‰¾åˆ°å¯¹åº”æŒ‡é’ˆåœ¨ç¬¦å·è¡¨ä¸­çš„åç§»å€¼çš„</h2><p>ç›´æ¥ä¸Šfishhook çš„ README ä¸­çš„æµç¨‹å›¾ï¼š</p>
<p><img src="/res/MachO/fishhook1.png" width="60%"></p>
<p>è¿™å¼ å›¾åˆçœ‹å¾ˆå¤æ‚ï¼Œä¸è¿‡å®ƒæ¼”ç¤ºçš„æ˜¯å¯»æ‰¾ç¬¦å·çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ ¹æ®è¿™å¼ å›¾æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>ä» __DATA æ®µä¸­çš„ lazy ç¬¦å·æŒ‡é’ˆè¡¨ä¸­æŸ¥æ‰¾æŸä¸ªç¬¦å·ï¼Œè·å¾—è¿™ä¸ªç¬¦å·çš„åç§»é‡ 1061ï¼Œç„¶ååœ¨æ¯ä¸€ä¸ª section_64 ä¸­æŸ¥æ‰¾ reserved1ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå€¼æ‰¾åˆ° Indirect Symbol Table ä¸­ç¬¦å·å¯¹åº”çš„æ¡ç›®</li>
<li>åœ¨ Indirect Symbol Table æ‰¾åˆ°ç¬¦å·è¡¨æŒ‡é’ˆä»¥åŠå¯¹åº”çš„ç´¢å¼• 16343 ä¹‹åï¼Œå°±éœ€è¦è®¿é—®ç¬¦å·è¡¨</li>
<li>ç„¶åé€šè¿‡ç¬¦å·è¡¨ä¸­çš„åç§»é‡ï¼Œè·å–å­—ç¬¦ä¸²è¡¨ä¸­çš„ç¬¦å· <code>_close</code></li>
</ol>
<p>å›¾ç¤ºä¸­ï¼Œ1061 æ˜¯é—´æ¥ç¬¦å·è¡¨çš„åç§»é‡ï¼Œ*ï¼ˆåç§»é‡+é—´æ¥ç¬¦å·åœ°å€ï¼‰=16343ï¼Œå³ç¬¦å·è¡¨åç§»é‡ã€‚ç¬¦å·è¡¨ä¸­æ¯ä¸€ä¸ªç»“æ„éƒ½æ˜¯ä¸€ä¸ª nlist ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«å­—ç¬¦è¡¨åç§»é‡ã€‚é€šè¿‡å­—ç¬¦è¡¨åç§»é‡æœ€ç»ˆç¡®å®šå‡½æ•°æŒ‡é’ˆã€‚</p>
<p>fishhook å°±æ˜¯å¯¹é—´æ¥ç¬¦å·è¡¨çš„åç§»é‡åŠ¨çš„æ‰‹è„šï¼Œæä¾›ä¸€ä¸ªå‡çš„ nlist ç»“æ„ä½“ï¼Œä»è€Œè¾¾åˆ° hook çš„ç›®çš„ã€‚</p>
<p>ä¸Šé¢çš„æµç¨‹å›¾å…¶å®å·²ç»æ˜¾ç¤ºçš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œæˆ‘ä»¬é‡æ–°æ¥èµ°ä¸€éï¼Œä¸€æ­¥æ­¥æ‰¾åˆ°å…¶åœ¨ MachO æ–‡ä»¶é‡Œå¯¹åº”æŒ‡é’ˆçš„åç§»å€¼ï¼Œå¤§è‡´æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p><strong>1.åœ¨ String Table ä¸­æ‰¾åˆ°è¯¥å­—ç¬¦ä¸²åœ¨ Symbols Table -&gt; Symbols ä¸­çš„ä½ç½®ï¼š</strong></p>
<p><img src="/res/MachO/fishhook2.png" alt></p>
<p>ç”¨ 0x9832 - 0x9780 = 0xB2</p>
<p><strong>2.åœ¨ Symbols Table -&gt; Symbols ä¸­æ‰¾åˆ°Data = 0xB2 çš„ç¬¦å·ï¼Œå…¶å¯¹åº”çš„ offset å€¼ 0x16F å°±æ˜¯è¯¥ç¬¦å·åœ¨ Dynamic Symbols Table -&gt; Indirect Symbols è¡¨ä¸­çš„ Data å€¼</strong></p>
<p><img src="/res/MachO/fishhook3.png" alt></p>
<p><strong>3.åœ¨ Dynamic Symbols Table -&gt; Indirect Symbols è¡¨ä¸­æ‰¾åˆ° Data å€¼ä¸º 0x16F çš„ç¬¦å·ï¼Œå…¶ä½äºè¯¥è¡¨ä¸­çš„ä½ç½®ï¼ˆç¬¬ä¸€ä¸ªï¼‰å°±æ˜¯å®ƒåœ¨æ‡’åŠ è½½è¡¨ä¸­å¯¹åº”çš„ä½ç½®ã€‚</strong></p>
<p><img src="/res/MachO/fishhook4.png" alt></p>
<p><strong>4.æ‡’åŠ è½½è¡¨ä¸­å¯¹åº”ä½ç½®çš„ Offset å€¼å°±æ˜¯è¯¥æŒ‡é’ˆæœ€ç»ˆçš„åç§»é‡ï¼š</strong></p>
<p><img src="/res/MachO/fishhook5.png" alt></p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>fishhook</tag>
      </tags>
  </entry>
  <entry>
    <title>AudioToolbox-æ’­æ”¾å’Œå½•åˆ¶éŸ³é¢‘</title>
    <url>/essay/AVFoundation/AudioToolbox-%E6%92%AD%E6%94%BE%E5%92%8C%E5%BD%95%E5%88%B6%E9%9F%B3%E9%A2%91/</url>
    <content><![CDATA[<h1 id="ä½¿ç”¨System-Sound-Serviceæ’­æ”¾éŸ³æ•ˆ"><a href="#ä½¿ç”¨System-Sound-Serviceæ’­æ”¾éŸ³æ•ˆ" class="headerlink" title="ä½¿ç”¨System Sound Serviceæ’­æ”¾éŸ³æ•ˆ"></a>ä½¿ç”¨System Sound Serviceæ’­æ”¾éŸ³æ•ˆ</h1><p>å‚è€ƒ <a href="http://www.cnblogs.com/kenshincui/p/4186022.html" target="_blank" rel="noopener">http://www.cnblogs.com/kenshincui/p/4186022.html</a></p>
<blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<ol>
<li>è°ƒç”¨<code>AudioServicesCreateSystemSoundID(   CFURLRef  inFileURL, SystemSoundID*   outSystemSoundID)</code>å‡½æ•°è·å¾—ç³»ç»Ÿå£°éŸ³IDã€‚</li>
<li>å¦‚æœéœ€è¦ç›‘å¬æ’­æ”¾å®Œæˆæ“ä½œï¼Œåˆ™ä½¿ç”¨<code>AudioServicesAddSystemSoundCompletion(  SystemSoundID inSystemSoundID,
 CFRunLoopRef  inRunLoop, CFStringRef  inRunLoopMode, AudioServicesSystemSoundCompletionProc  inCompletionRoutine, void*  inClientData)</code>æ–¹æ³•æ³¨å†Œå›è°ƒå‡½æ•°ã€‚</li>
<li>è°ƒç”¨<code>AudioServicesPlaySystemSound(SystemSoundID inSystemSoundID)</code>æˆ–è€…<code>AudioServicesPlayAlertSound(SystemSoundID inSystemSoundID)</code> æ–¹æ³•æ’­æ”¾éŸ³æ•ˆï¼ˆåè€…å¸¦æœ‰éœ‡åŠ¨æ•ˆæœï¼‰ã€‚</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;AudioToolbox/AudioToolbox.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ’­æ”¾å®Œæˆå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param soundID    ç³»ç»Ÿå£°éŸ³ID</span></span><br><span class="line"><span class="comment"> *  @param clientData å›è°ƒæ—¶ä¼ é€’çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> soundCompleteCallback(SystemSoundID soundID,<span class="keyword">void</span> * clientData)&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"æ’­æ”¾å®Œæˆ..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ’­æ”¾éŸ³æ•ˆæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param name éŸ³é¢‘æ–‡ä»¶åç§°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(<span class="keyword">void</span>)playSoundEffect:(<span class="built_in">NSString</span> *)name&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *audioFile=[[<span class="built_in">NSBundle</span> mainBundle] pathForResource:name ofType:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSURL</span> *fileUrl=[<span class="built_in">NSURL</span> fileURLWithPath:audioFile];</span><br><span class="line">    <span class="comment">//1.è·å¾—ç³»ç»Ÿå£°éŸ³ID</span></span><br><span class="line">    SystemSoundID soundID=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * inFileUrl:éŸ³é¢‘æ–‡ä»¶url</span></span><br><span class="line"><span class="comment">     * outSystemSoundID:å£°éŸ³idï¼ˆæ­¤å‡½æ•°ä¼šå°†éŸ³æ•ˆæ–‡ä»¶åŠ å…¥åˆ°ç³»ç»ŸéŸ³é¢‘æœåŠ¡ä¸­å¹¶è¿”å›ä¸€ä¸ªé•¿æ•´å½¢IDï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AudioServicesCreateSystemSoundID((__bridge <span class="built_in">CFURLRef</span>)(fileUrl), &amp;soundID);</span><br><span class="line">    <span class="comment">//å¦‚æœéœ€è¦åœ¨æ’­æ”¾å®Œä¹‹åæ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¯ä»¥è°ƒç”¨å¦‚ä¸‹æ–¹æ³•æ³¨å†Œä¸€ä¸ªæ’­æ”¾å®Œæˆå›è°ƒå‡½æ•°</span></span><br><span class="line">    AudioServicesAddSystemSoundCompletion(soundID, <span class="literal">NULL</span>, <span class="literal">NULL</span>, soundCompleteCallback, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//2.æ’­æ”¾éŸ³é¢‘</span></span><br><span class="line">    AudioServicesPlaySystemSound(soundID);<span class="comment">//æ’­æ”¾éŸ³æ•ˆ</span></span><br><span class="line"><span class="comment">//    AudioServicesPlayAlertSound(soundID);//æ’­æ”¾éŸ³æ•ˆå¹¶éœ‡åŠ¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="AVAudioPlayeræ’­æ”¾éŸ³é¢‘"><a href="#AVAudioPlayeræ’­æ”¾éŸ³é¢‘" class="headerlink" title="AVAudioPlayeræ’­æ”¾éŸ³é¢‘"></a>AVAudioPlayeræ’­æ”¾éŸ³é¢‘</h1><h2 id="AVAudioPlayer-ç®€ä»‹"><a href="#AVAudioPlayer-ç®€ä»‹" class="headerlink" title="AVAudioPlayer ç®€ä»‹"></a>AVAudioPlayer ç®€ä»‹</h2><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p><em>ä¸€èˆ¬é€šè¿‡ ä½¿ç”¨æœ¬åœ°éŸ³é¢‘æ–‡ä»¶çš„ NSURL æˆ–è€…åŒ…å«éŸ³é¢‘çš„å†…å­˜çš„ NSDataã€‚</em></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithContentsOfURL:(<span class="built_in">NSURL</span> *)url error:(<span class="built_in">NSError</span> **)outError;</span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithData:(<span class="built_in">NSData</span> *)data error:(<span class="built_in">NSError</span> **)outError;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ <strong>prepareToPlay</strong> æ–¹æ³• å¯ä»¥å–å¾—éœ€è¦çš„éŸ³é¢‘ç¡¬ä»¶å¹¶é¢„åŠ è½½ Audio Queue çš„ç¼“å†²åŒºã€‚åœ¨åˆ›å»ºçš„æ—¶å€™è°ƒç”¨å¯ä»¥é™ä½è°ƒç”¨ <strong>play</strong> æ–¹æ³•å’Œå¬åˆ°å£°éŸ³è¾“å‡ºä¹‹é—´çš„å»¶è¿Ÿã€‚</p>
<h3 id="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"><a href="#å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶" class="headerlink" title="å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶"></a>å¯¹æ’­æ”¾è¿›è¡Œæ§åˆ¶</h3><blockquote>
<p>å¸¸è§çš„ <code>play</code>ã€<code>stop</code>å’Œ <code>pause</code>çš„æ’­æ”¾æš‚åœåŠŸèƒ½ã€‚<br>å…¶ä¸­ stop å’Œ pause çš„åŒºåˆ«æ˜¯ stop æ–¹æ³•ä¼šæ’¤é”€è°ƒç”¨ prepareToPlayæ—¶æ‰€åšçš„è®¾ç½®ï¼Œè€Œ pause æ–¹æ³•ä¸ä¼šã€‚</p>
</blockquote>
<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ï¼š</p>
<ul>
<li><strong>ä¿®æ”¹æ’­æ”¾å™¨çš„éŸ³é‡</strong> ï¼ˆvolumeï¼‰ï¼šä»0.0ï¼ˆé™éŸ³ï¼‰åˆ°1.0ï¼ˆæœ€å¤§éŸ³é‡ä¹‹é—´ï¼‰ã€‚</li>
<li><strong>ä¿®æ”¹æ’­æ”¾å™¨çš„ pan å€¼</strong>ï¼šå…è®¸ä½¿ç”¨ç«‹ä½“å£°æ’­æ”¾å£°éŸ³ï¼Œä» -1.0ï¼ˆæå·¦ï¼‰åˆ° 1.0ï¼ˆæå³ï¼‰ã€‚é»˜è®¤ 0.0ï¼ˆå±…ä¸­ï¼‰ã€‚</li>
<li><strong>è°ƒæ•´æ’­æ”¾ç‡</strong> ï¼ˆrateï¼‰ï¼šéœ€è¦é…åˆ enableRate ä½¿ç”¨ã€‚èŒƒå›´ä» 0.5ï¼ˆåŠæ•°ï¼‰åˆ°2.0ï¼ˆ2å€æ•°ï¼‰ã€‚</li>
<li><strong>æ— ç¼å¾ªç¯</strong> (numberOfLoops): æ’­æ”¾ n+1æ¬¡ï¼Œè‹¥ n&lt;-1 åˆ™æ’­æ”¾æ— é™æ¬¡ç›´åˆ°è¢«åœæ­¢ã€‚</li>
<li><strong>éŸ³é¢‘è®¡é‡</strong>ï¼š å¯ä»¥è¯»å–éŸ³é‡åŠ›åº¦çš„å¹³å‡å€¼å’Œå³°å€¼ã€‚</li>
</ul>
<h3 id="é…ç½®éŸ³é¢‘ä¼šè¯-åå°æ’­æ”¾"><a href="#é…ç½®éŸ³é¢‘ä¼šè¯-åå°æ’­æ”¾" class="headerlink" title="é…ç½®éŸ³é¢‘ä¼šè¯,åå°æ’­æ”¾"></a>é…ç½®éŸ³é¢‘ä¼šè¯,åå°æ’­æ”¾</h3><p><em>é»˜è®¤ä¼šè¯ç±»å‹ä¸º <code>AVAudioSessionCategorySoloAmbient</code> è¿™ä¸ªç±»å‹ä¸èƒ½åå°æ’­æ”¾</em></p>
<blockquote>
<p>æ·»åŠ åå°æ’­æ”¾ -è®¾ç½®ä¼šè¯ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">   <span class="built_in">AVAudioSession</span> *session = [<span class="built_in">AVAudioSession</span> sharedInstance];</span><br><span class="line">   <span class="built_in">NSError</span> *error;</span><br><span class="line">   <span class="comment">//è®¾ç½®ä¼šè¯</span></span><br><span class="line">   <span class="keyword">if</span> (![session setCategory:<span class="built_in">AVAudioSessionCategoryPlayback</span> error:&amp;error]) &#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"Category Error: %@"</span>, [error localizedDescription]);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//æ¿€æ´»ä¼šè¯</span></span><br><span class="line">   <span class="keyword">if</span> (![session setActive:<span class="literal">YES</span> error:&amp;error]) &#123;</span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"Activation Error: %@"</span>, [error localizedDescription]);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ·»åŠ åå°æ’­æ”¾ -ä¿®æ”¹info.plist ï¼š</p>
</blockquote>
<p>è®¾ç½®åå°è¿è¡Œæ¨¡å¼ï¼šåœ¨plistæ–‡ä»¶ä¸­æ·»åŠ Required background modesï¼Œå¹¶ä¸”è®¾ç½®item 0=App plays audio or streams audio/video using AirPlayï¼ˆå…¶å®å¯ä»¥ç›´æ¥é€šè¿‡Xcodeåœ¨Project Targets-Capabilities-Background Modesä¸­è®¾ç½®ï¼‰</p>
<h2 id="å¤„ç†ä¸­æ–­"><a href="#å¤„ç†ä¸­æ–­" class="headerlink" title="å¤„ç†ä¸­æ–­"></a>å¤„ç†ä¸­æ–­</h2><p><em>ä½¿ç”¨è®¾å¤‡çš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šå‡ºç°ç”µè¯å‘¼å…¥ç­‰æƒ…å†µï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸­æ–­å‘ç”Ÿæ—¶éŸ³é¢‘ä¼šæ…¢æ…¢æ¶ˆå¤±æš‚åœï¼Œä½†æ˜¯å½“ä¸­æ–­ç»“æŸæ—¶ï¼ŒéŸ³é¢‘ä¸ä¼šè‡ªåŠ¨å¼€å§‹ã€‚</em></p>
<blockquote>
<p>æ¥æ”¶ä¸­æ–­äº‹ä»¶ï¼Œå¹¶ä½œå‡ºå¤„ç†</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">		<span class="comment">//æ¥æ”¶ä¸­æ–­</span></span><br><span class="line">        <span class="built_in">NSNotificationCenter</span> *nsnc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">        [nsnc addObserver:<span class="keyword">self</span></span><br><span class="line">                 selector:<span class="keyword">@selector</span>(handleInterrruption:)</span><br><span class="line">                     name:<span class="built_in">AVAudioSessionInterruptionNotification</span></span><br><span class="line">                   object:[<span class="built_in">AVAudioSession</span> sharedInstance]];</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¤„ç†ä¸­æ–­</span></span><br><span class="line">-(<span class="keyword">void</span>)handleInterrruption:(<span class="built_in">NSNotification</span>*)noti&#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span>* info = noti.userInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">AVAudioSessionInterruptionType</span> type= [[info objectForKey:<span class="string">@"AVAudioSessionInterruptionOptionKey"</span>] unsignedIntegerValue];</span><br><span class="line">    <span class="keyword">if</span>(type == <span class="built_in">AVAudioSessionInterruptionTypeBegan</span>)&#123;</span><br><span class="line">        <span class="comment">//ä¸­æ–­å¼€å§‹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//ä¸­æ–­ç»“æŸ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å¯¹çº¿è·¯æ”¹å˜çš„å“åº”"><a href="#å¯¹çº¿è·¯æ”¹å˜çš„å“åº”" class="headerlink" title="å¯¹çº¿è·¯æ”¹å˜çš„å“åº”"></a>å¯¹çº¿è·¯æ”¹å˜çš„å“åº”</h2><p><em>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’­æ”¾éŸ³é¢‘æ—¶æ’å…¥è€³æœºï¼ŒéŸ³é¢‘è¾“å‡ºå˜ä¸ºè€³æœºå¹¶æ’­æ”¾ï¼›æ–­å¼€è€³æœºæ—¶ï¼ŒéŸ³é¢‘è¾“å‡ºå˜ä¸ºæ‰¬å£°å™¨å¹¶æ’­æ”¾ã€‚ å¸Œæœ›æ”¹ä¸ºæ–­å¼€è€³æœºçš„æ—¶å€™åœæ­¢æ’­æ”¾</em></p>
<blockquote>
<p>æ¥æ”¶çº¿è·¯å˜åŒ–é€šçŸ¥ï¼Œå¹¶ä½œå‡ºå¤„ç†</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">		<span class="comment">//æ³¨å†Œé€šçŸ¥</span></span><br><span class="line">        <span class="built_in">NSNotificationCenter</span> *nsnc = [<span class="built_in">NSNotificationCenter</span> defaultCenter];</span><br><span class="line">        [nsnc addObserver:<span class="keyword">self</span></span><br><span class="line">                 selector:<span class="keyword">@selector</span>(handleRouteChange:)</span><br><span class="line">                     name:<span class="built_in">AVAudioSessionRouteChangeNotification</span></span><br><span class="line">                   object:[<span class="built_in">AVAudioSession</span> sharedInstance]];</span><br><span class="line">                   </span><br><span class="line"><span class="comment">//å¤„ç†é€šçŸ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)handleRouteChange:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSDictionary</span> *info = notification.userInfo;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">AVAudioSessionRouteChangeReason</span> reason =</span><br><span class="line">        [info[<span class="built_in">AVAudioSessionRouteChangeReasonKey</span>] unsignedIntValue];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (reason == <span class="built_in">AVAudioSessionRouteChangeReasonOldDeviceUnavailable</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">AVAudioSessionRouteDescription</span> *previousRoute =</span><br><span class="line">            info[<span class="built_in">AVAudioSessionRouteChangePreviousRouteKey</span>];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">AVAudioSessionPortDescription</span> *previousOutput = previousRoute.outputs[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">NSString</span> *portType = previousOutput.portType;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åŸè®¾å¤‡ä¸ºè€³æœºåˆ™æš‚åœæ’­æ”¾</span></span><br><span class="line">        <span class="keyword">if</span> ([portType isEqualToString:<span class="built_in">AVAudioSessionPortHeadphones</span>]) &#123;</span><br><span class="line"> 				<span class="comment">//åœæ­¢æ’­æ”¾</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="AVAudioRecorder-å½•åˆ¶éŸ³é¢‘"><a href="#AVAudioRecorder-å½•åˆ¶éŸ³é¢‘" class="headerlink" title="AVAudioRecorder å½•åˆ¶éŸ³é¢‘"></a>AVAudioRecorder å½•åˆ¶éŸ³é¢‘</h1><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithURL:(<span class="built_in">NSURL</span> *)url settings:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)settings error:(<span class="built_in">NSError</span> **)outError;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°åˆ†åˆ«è¡¨ç¤º</p>
<ul>
<li>urlï¼Œç”¨äºè¡¨ç¤ºéŸ³é¢‘æµå†™å…¥æ–‡ä»¶çš„æœ¬åœ°æ–‡ä»¶URL</li>
<li>settingï¼ŒåŒ…å«å½•éŸ³ä¼šè¯é”®å€¼ä¿¡æ¯çš„NSDictionaryå¯¹è±¡<ul>
<li>AVFormatIDKey:å†™å…¥çš„éŸ³é¢‘æ ¼å¼ </li>
<li>AVSampleRateKeyï¼šé‡‡æ ·ç‡ ã€‚ä¸€èˆ¬ä½¿ç”¨8000ã€16000ã€22050æˆ–44100</li>
<li>AVNumberOfChannelsKeyï¼šé€šé“æ•°ï¼Œ1ä¸ºå•å£°é“ï¼Œ2è¡¨ç¤ºç«‹ä½“å£°</li>
</ul>
</li>
<li>outErrorï¼Œæ•æ‰åˆå§‹åŒ–é˜¶æ®µå„ç§é”™è¯¯çš„NSErroræŒ‡é’ˆ</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *tmpDir = <span class="built_in">NSTemporaryDirectory</span>();</span><br><span class="line"><span class="built_in">NSString</span> *filePath = [tmpDir stringByAppendingPathComponent:<span class="string">@"memo.caf"</span>];</span><br><span class="line"><span class="built_in">NSURL</span> *fileURL = [<span class="built_in">NSURL</span> fileURLWithPath:filePath];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSDictionary</span> *settings = @&#123;</span><br><span class="line">                           <span class="built_in">AVFormatIDKey</span> : @(kAudioFormatAppleIMA4),</span><br><span class="line">                           <span class="built_in">AVSampleRateKey</span> : @<span class="number">44100.0</span>f,</span><br><span class="line">                           <span class="built_in">AVNumberOfChannelsKey</span> : @<span class="number">1</span>,</span><br><span class="line">                           <span class="built_in">AVEncoderBitDepthHintKey</span> : @<span class="number">16</span>,</span><br><span class="line">                           <span class="built_in">AVEncoderAudioQualityKey</span> : @(<span class="built_in">AVAudioQualityMedium</span>)</span><br><span class="line">                           &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSError</span> *error;</span><br><span class="line"><span class="keyword">self</span>.recorder = [[<span class="built_in">AVAudioRecorder</span> alloc] initWithURL:fileURL settings:settings error:&amp;error];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.recorder) &#123;</span><br><span class="line">    <span class="keyword">self</span>.recorder.delegate = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">self</span>.recorder.meteringEnabled = <span class="literal">YES</span>;</span><br><span class="line">    [<span class="keyword">self</span>.recorder prepareToRecord];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Error: %@"</span>, [error localizedDescription]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="é…ç½®éŸ³é¢‘ä¼šè¯"><a href="#é…ç½®éŸ³é¢‘ä¼šè¯" class="headerlink" title="é…ç½®éŸ³é¢‘ä¼šè¯"></a>é…ç½®éŸ³é¢‘ä¼šè¯</h3><blockquote>
<p>é»˜è®¤AVAudioSessionCategorySoloAmbient ä¸æ”¯æŒéŸ³é¢‘è¾“å…¥ï¼Œæ”¹ä¸ºAVAudioSessionCategoryPlayAndRecord</p>
</blockquote>
<h3 id="å¯¹å½•åˆ¶è¿›è¡Œæ§åˆ¶"><a href="#å¯¹å½•åˆ¶è¿›è¡Œæ§åˆ¶" class="headerlink" title="å¯¹å½•åˆ¶è¿›è¡Œæ§åˆ¶"></a>å¯¹å½•åˆ¶è¿›è¡Œæ§åˆ¶</h3><ul>
<li>å½•åˆ¶æš‚åœåœæ­¢ï¼šrecordï¼Œpauseï¼Œstopï¼›</li>
<li>æ¢å¤å½•åˆ¶ï¼špauseä¹‹åè°ƒç”¨recordï¼ŒAVAudioSessionä¼šå¸®ä½ è®°å½•ä¸Šæ¬¡å½•éŸ³çš„åœ°æ–¹å¹¶è¿½åŠ å½•éŸ³</li>
<li>è·å–æ—¶é—´ï¼šcurrentTimeå½•åˆ¶æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œä¸èƒ½ä½¿ç”¨kvoç›‘æµ‹</li>
</ul>
<h2 id="Audio-Meteringæµ‹é‡éŸ³é¢‘"><a href="#Audio-Meteringæµ‹é‡éŸ³é¢‘" class="headerlink" title="Audio Meteringæµ‹é‡éŸ³é¢‘"></a>Audio Meteringæµ‹é‡éŸ³é¢‘</h2><p><em>AVAudioRecoder å’Œ AVAudioPlayer å¯ä»¥å¯¹éŸ³é¢‘è¿›è¡Œæµ‹é‡ã€‚Audio Meteringå¯ä»¥è®©å¼€å‘è€…è¯»å–éŸ³é¢‘çš„å¹³å‡åˆ†è´å’Œå³°å€¼åˆ†è´</em></p>
<blockquote>
<p>è·å–éŸ³é¢‘åˆ†è´æ•°æ®</p>
</blockquote>
<ul>
<li>è®¾ç½®å½•éŸ³å™¨çš„ meteringEnabledå±æ€§ä¸ºtrue</li>
<li>æ¯æ¬¡è·å–çš„æ—¶å€™ è°ƒç”¨ updateMeters æ–¹æ³•è·å–æœ€æ–°çš„å€¼</li>
<li><code>- (float)peakPowerForChannel:(NSUInteger)channelNumber;</code> è·å–å³°å€¼åˆ†è´ï¼ˆå¯¹æ•°å½¢å¼çš„ -160 åˆ° 0ï¼‰</li>
<li><code>- (float)averagePowerForChannel:(NSUInteger)channelNumber;</code> è·å–å¹³å‡åˆ†è´ï¼ˆå¯¹æ•°å½¢å¼çš„ -160 åˆ° 0ï¼‰</li>
</ul>
]]></content>
      <categories>
        <category>essay</category>
        <category>AVFoundation</category>
      </categories>
      <tags>
        <tag>AVFoundation</tag>
      </tags>
  </entry>
  <entry>
    <title>Mach-Oæ–‡ä»¶æ ¼å¼å­—æ®µç®€ä»‹</title>
    <url>/essay/LLDB/Mach-O_file/</url>
    <content><![CDATA[<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>æœ¬æ¬¡æ¥å­¦ä¹ ä¸‹Mach-Oæ–‡ä»¶çš„æ ¼å¼,Mach-Oï¼ˆMach Object File Formatï¼‰ æ˜¯é’ˆå¯¹ä¸åŒè¿è¡Œæ—¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹ã€‚</p>
<p>æ–‡ä»¶ç±»å‹ï¼š</p>
<p>Executableï¼š åº”ç”¨çš„ä¸»è¦äºŒè¿›åˆ¶<br>Dylibï¼š åŠ¨æ€é“¾æ¥åº“ï¼ˆåˆç§° DSO æˆ– DLLï¼‰<br>Bundleï¼š ä¸èƒ½è¢«é“¾æ¥çš„ Dylibï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶ä½¿ç”¨ dlopen() åŠ è½½ï¼Œå¯å½“åš macOS çš„æ’ä»¶ã€‚</p>
<p>Mach-O æ–‡ä»¶æ ¼å¼å¦‚ä¸‹:</p>
<p><img src="/res/MachO/macho_struct.png" width="70%"><br><a id="more"></a></p>
<p><strong>å¦‚ä½•æŸ¥çœ‹æ–‡ä»¶æ ¼å¼:</strong></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡fileæŒ‡ä»¤æŸ¥çœ‹æ–‡ä»¶çš„å…·ä½“æ ¼å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ file asdasd</span><br><span class="line">asdasd: Mach-O 64-bit executable x86_64</span><br></pre></td></tr></table></figure>
<p>ç›®å‰å·²çŸ¥çš„æ¶æ„åˆ†ä¸ºarmv7,armv7s,arm64,i386,x86_64ç­‰ç­‰ï¼ŒMachOä¸­å…¶å®ä¹Ÿæ˜¯è¿™äº›æ¶æ„çš„é›†åˆã€‚MachOå¯ä»¥æ˜¯å¤šæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç§°ä¹‹ä¸ºã€Œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€</p>
<p><strong>æ‹†åˆ†ã€é‡ç»„MachO</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨lipo -info å¯ä»¥æŸ¥çœ‹MachOæ–‡ä»¶åŒ…å«çš„æ¶æ„</span></span><br><span class="line">$ lipo -info MachOæ–‡ä»¶</span><br><span class="line"><span class="comment">#  ä½¿ç”¨lipo â€“thin æ‹†åˆ†æŸç§æ¶æ„</span></span><br><span class="line">$ lipo MachOæ–‡ä»¶ â€“thin æ¶æ„ â€“output è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br><span class="line"><span class="comment">#  ä½¿ç”¨lipo -create Â åˆå¹¶å¤šç§æ¶æ„</span></span><br><span class="line">$ lipo -create MachO1 Â MachO2 Â -output è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br></pre></td></tr></table></figure>
<h2 id="Mach-Oæ–‡ä»¶æ ¼å¼"><a href="#Mach-Oæ–‡ä»¶æ ¼å¼" class="headerlink" title="Mach-Oæ–‡ä»¶æ ¼å¼"></a>Mach-Oæ–‡ä»¶æ ¼å¼</h2><p>æ–°å»ºä¸€ä¸ªå•é¡µé¢å·¥ç¨‹ ä½¿ç”¨ <a href="https://sourceforge.net/projects/machoview/" target="_blank" rel="noopener">MachOView</a> æ¥æŸ¥çœ‹.appåŒ…å†…çš„mach-oæ–‡ä»¶:</p>
<p><img src="/res/MachO/macho1.png" alt></p>
<p>ç»“åˆå¯çŸ¥ Mach-O æ–‡ä»¶åŒ…å«äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼š</p>
<ul>
<li>Headerï¼ˆå¤´éƒ¨ï¼‰ï¼ŒæŒ‡æ˜äº† cpu æ¶æ„ã€å¤§å°ç«¯åºã€æ–‡ä»¶ç±»å‹ã€Load Commands ä¸ªæ•°ç­‰ä¸€äº›åŸºæœ¬ä¿¡æ¯</li>
<li>Load Commandsï¼ˆåŠ è½½å‘½ä»¤)ï¼Œæ­£å¦‚å®˜æ–¹çš„å›¾æ‰€ç¤ºï¼Œæè¿°äº†æ€æ ·åŠ è½½æ¯ä¸ª Segment çš„ä¿¡æ¯ã€‚åœ¨ Mach-O æ–‡ä»¶ä¸­å¯ä»¥æœ‰å¤šä¸ª Segmentï¼Œæ¯ä¸ª Segment å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Sectionã€‚</li>
<li>Dataï¼ˆæ•°æ®åŒºï¼‰ï¼ŒSegment çš„å…·ä½“æ•°æ®ï¼ŒåŒ…å«äº†ä»£ç å’Œæ•°æ®ç­‰ã€‚</li>
</ul>
<p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ä»…ä»…æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ˜¯Macho-Oï¼Œç›®æ ‡æ–‡ä»¶(.o)ä»¥åŠåŠ¨æ€åº“ï¼Œé™æ€åº“éƒ½æ˜¯Mach-Oæ ¼å¼ã€‚</em></p>
<h3 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h3><p>Mach-O æ–‡ä»¶çš„å¤´éƒ¨å®šä¹‰å¦‚ä¸‹ <a href="https://opensource.apple.com/source/xnu/xnu-1456.1.26/EXTERNAL_HEADERS/mach-o/loader.h.auto.html" target="_blank" rel="noopener">loader.h</a>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mach_header_64</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	magic;		<span class="comment">/* æ ‡å¿—ç¬¦ 0xfeedface æ˜¯ 32 ä½ï¼Œ 0xfeedfacf æ˜¯ 64 ä½ã€‚*/</span></span><br><span class="line">	<span class="keyword">cpu_type_t</span>	cputype;	<span class="comment">/* cpu ç±»å‹ã€å¹³å° */</span></span><br><span class="line">	<span class="keyword">cpu_subtype_t</span>	cpusubtype;	<span class="comment">/* cpu ç±»å‹ã€å¹³å° */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	filetype;	<span class="comment">/* æ–‡ä»¶ç±»å‹ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ã€ç¬¦å·æ–‡ä»¶ï¼ˆDSYMï¼‰ã€å†…æ ¸æ‰©å±•ç­‰ */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	ncmds;		<span class="comment">/* åŠ è½½ Load Commands çš„æ•°é‡ */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	sizeofcmds;	<span class="comment">/* åŠ è½½ Load Commands çš„å¤§å° */</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	flags;		<span class="comment">/* dyld åŠ¨æ€é“¾æ¥å™¨ åŠ è½½çš„æ ‡å¿—*/</span></span><br><span class="line">	<span class="keyword">uint32_t</span>	reserved;	<span class="comment">/* 64 ä½çš„ä¿ç•™å­—æ®µ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šå›¾ä¸­çœ‹å‡º<code>asdasd</code>è¿™ä¸ªæ–‡ä»¶headerå¯¹åº”çš„æ˜¯ <code>MH_MAGIC_64</code> ã€<code>CPU_TYPE_X86_64_ALL</code> ã€<code>MH_EXECUTE</code>â€¦ç­‰</p>
<p>filetypeçš„å®šä¹‰æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_OBJECT    0x1        <span class="comment">/* Target æ–‡ä»¶ï¼šç¼–è¯‘å™¨å¯¹æºç ç¼–è¯‘åå¾—åˆ°çš„ä¸­é—´ç»“æœ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_EXECUTE    0x2        <span class="comment">/* å¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_FVMLIB    0x3        <span class="comment">/* VM å…±äº«åº“æ–‡ä»¶ï¼ˆè¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_CORE        0x4        <span class="comment">/* Core æ–‡ä»¶ï¼Œä¸€èˆ¬åœ¨ App Crash äº§ç”Ÿ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_PRELOAD    0x5        <span class="comment">/* preloaded executable file */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLIB    0x6        <span class="comment">/* åŠ¨æ€åº“ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLINKER    0x7        <span class="comment">/* åŠ¨æ€è¿æ¥å™¨ /usr/lib/dyld */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_BUNDLE    0x8        <span class="comment">/* éç‹¬ç«‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¾€å¾€é€šè¿‡ gcc-bundle ç”Ÿæˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DYLIB_STUB    0x9        <span class="comment">/* é™æ€é“¾æ¥æ–‡ä»¶ï¼ˆè¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_DSYM        0xa        <span class="comment">/* ç¬¦å·æ–‡ä»¶ä»¥åŠè°ƒè¯•ä¿¡æ¯ï¼Œåœ¨è§£æå †æ ˆç¬¦å·ä¸­å¸¸ç”¨ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_KEXT_BUNDLE    0xb        <span class="comment">/* x86_64 å†…æ ¸æ‰©å±• */</span></span></span><br></pre></td></tr></table></figure>
<p>å’Œéƒ¨åˆ†flagså®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_NOUNDEFS    0x1        <span class="comment">/* Target æ–‡ä»¶ä¸­æ²¡æœ‰å¸¦æœªå®šä¹‰çš„ç¬¦å·ï¼Œå¸¸ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_SPLIT_SEGS    0x20  <span class="comment">/* Target æ–‡ä»¶ä¸­çš„åªè¯» Segment å’Œå¯è¯»å†™ Segment åˆ†å¼€  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_TWOLEVEL    0x80        <span class="comment">/* è¯¥ Image ä½¿ç”¨äºŒçº§å‘½åç©ºé—´(two name space binding)ç»‘å®šæ–¹æ¡ˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_FORCE_FLAT    0x100 <span class="comment">/* ä½¿ç”¨æ‰å¹³å‘½åç©ºé—´(flat name space binding)ç»‘å®šï¼ˆä¸ MH_TWOLEVEL äº’æ–¥ï¼‰ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_WEAK_DEFINES    0x8000 <span class="comment">/* äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨äº†å¼±ç¬¦å· */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_BINDS_TO_WEAK 0x10000 <span class="comment">/* äºŒè¿›åˆ¶æ–‡ä»¶é“¾æ¥äº†å¼±ç¬¦å· */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_ALLOW_STACK_EXECUTION 0x20000<span class="comment">/* å…è®¸ Stack å¯æ‰§è¡Œ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_PIE 0x200000  <span class="comment">/* å¯¹å¯æ‰§è¡Œçš„æ–‡ä»¶ç±»å‹å¯ç”¨åœ°å€ç©ºé—´ layout éšæœºåŒ– */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MH_NO_HEAP_EXECUTION 0x1000000 <span class="comment">/* å°† Heap æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œï¼Œå¯é˜²æ­¢ heap spray æ”»å‡» */</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Mach-O æ–‡ä»¶å¤´ä¸»è¦ç›®çš„æ˜¯ä¸ºåŠ è½½å‘½ä»¤æä¾›ä¿¡æ¯ã€‚åŠ è½½å‘½ä»¤è¿‡ç¨‹ç´§è·Ÿåœ¨å¤´ä¹‹åï¼Œå¹¶ä¸” ncmds å’Œ sizeofcmds æ¥èƒ½ä¸ªå­—æ®µå°†ä¼šç”¨åœ¨åŠ è½½å‘½ä»¤çš„è¿‡ç¨‹ä¸­ã€‚</p>
<h3 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h3><p>Headersä¹‹åå°±æ˜¯Load Commands,å…¶å ç”¨çš„å†…å­˜å’ŒåŠ è½½å‘½ä»¤æ€»æ•°å·²ç»åœ¨Headerä¸­ ncmds/sizeofcmds ä¸­æŒ‡å‡ºã€‚</p>
<p><img src="/res/MachO/loadcommand1.png" alt></p>
<p>load commandsçš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">load_command</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> cmd;		<span class="comment">/*  load command ç±»å‹*/</span></span><br><span class="line">	<span class="keyword">uint32_t</span> cmdsize;	<span class="comment">/* commandå¤§å° ç”¨äºè®¡ç®—å‡ºåˆ°ä¸‹ä¸€ä¸ª command çš„åç§»é‡*/</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>cmd å­—æ®µæŒ‡å‡ºäº† command ç±»å‹,ä¸»è¦æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line">LC_SEGMENTã€LC_SEGMENT_64 å°† segment æ˜ å°„åˆ°è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œ</span><br><span class="line">LC_UUID äºŒè¿›åˆ¶æ–‡ä»¶ idï¼Œä¸ç¬¦å·è¡¨ uuid å¯¹åº”ï¼Œå¯ç”¨ä½œç¬¦å·è¡¨åŒ¹é…ï¼Œ</span><br><span class="line">LC_LOAD_DYLINKER å¯åŠ¨åŠ¨æ€åŠ è½½å™¨ï¼Œ</span><br><span class="line">LC_SYMTAB æè¿°åœ¨ __LINKEDIT æ®µçš„å“ªæ‰¾å­—ç¬¦ä¸²è¡¨ã€ç¬¦å·è¡¨ï¼Œ</span><br><span class="line">LC_CODE_SIGNATURE ä»£ç ç­¾åç­‰</span><br></pre></td></tr></table></figure>
<p>LC_SEGMENT_64å’ŒLC_SEGMENTæ˜¯åŠ è½½çš„ä¸»è¦å‘½ä»¤ï¼Œå®ƒè´Ÿè´£æŒ‡å¯¼å†…æ ¸æ¥è®¾ç½®è¿›ç¨‹çš„å†…å­˜ç©ºé—´ã€‚ä¸€èˆ¬Mach-Oæ–‡ä»¶æœ‰å¤šä¸ªæ®µ(Segement)ï¼Œæ®µæ¯ä¸ªæ®µæœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œä¸€èˆ¬åŒ…æ‹¬ï¼š</p>
<ol>
<li>__PAGEZERO: ç©ºæŒ‡é’ˆé™·é˜±æ®µï¼Œæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´çš„ç¬¬ä¸€é¡µï¼Œç”¨äºæ•æ‰å¯¹NULLæŒ‡é’ˆçš„å¼•ç”¨ï¼›</li>
<li>__TEXT: åŒ…å«äº†æ‰§è¡Œä»£ç ä»¥åŠå…¶ä»–åªè¯»æ•°æ®ã€‚è¯¥æ®µæ•°æ®çš„ä¿æŠ¤çº§åˆ«ä¸ºï¼šVM_PROT_READï¼ˆè¯»ï¼‰ã€VM_PROT_EXECUTE(æ‰§è¡Œ)ï¼Œé˜²æ­¢åœ¨å†…å­˜ä¸­è¢«ä¿®æ”¹ï¼›</li>
<li>__DATA: åŒ…å«äº†ç¨‹åºæ•°æ®ï¼Œè¯¥æ®µå¯å†™ï¼›</li>
<li>__LINKEDIT: é“¾æ¥å™¨ä½¿ç”¨çš„ç¬¦å·ä»¥åŠå…¶ä»–è¡¨</li>
</ol>
<h3 id="Segment-amp-Section"><a href="#Segment-amp-Section" class="headerlink" title="Segment &amp; Section"></a>Segment &amp; Section</h3><p>Segmentå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">segment_command_64</span> &#123;</span> </span><br><span class="line">    <span class="keyword">uint32_t</span>    cmd;        <span class="comment">/* LC_SEGMENT_64 */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    cmdsize;    <span class="comment">/* section_64 ç»“æ„ä½“æ‰€éœ€è¦çš„ç©ºé—´ */</span></span><br><span class="line">    <span class="keyword">char</span>        segname[<span class="number">16</span>];    <span class="comment">/* segment åå­—ï¼Œä¸Šè¿°å®ä¸­çš„å®šä¹‰ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    vmaddr;        <span class="comment">/* æ‰€æè¿°æ®µçš„è™šæ‹Ÿå†…å­˜åœ°å€ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    vmsize;        <span class="comment">/* ä¸ºå½“å‰æ®µåˆ†é…çš„è™šæ‹Ÿå†…å­˜å¤§å° */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    fileoff;    <span class="comment">/* å½“å‰æ®µåœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    filesize;    <span class="comment">/* å½“å‰æ®µåœ¨æ–‡ä»¶ä¸­å ç”¨çš„å­—èŠ‚ */</span></span><br><span class="line">    <span class="keyword">vm_prot_t</span>    maxprot;    <span class="comment">/* æ®µæ‰€åœ¨é¡µæ‰€éœ€è¦çš„æœ€é«˜å†…å­˜ä¿æŠ¤ï¼Œç”¨å…«è¿›åˆ¶è¡¨ç¤º */</span></span><br><span class="line">    <span class="keyword">vm_prot_t</span>    initprot;    <span class="comment">/* æ®µæ‰€åœ¨é¡µåŸå§‹å†…å­˜ä¿æŠ¤ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    nsects;        <span class="comment">/* æ®µä¸­ Section æ•°é‡ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    flags;        <span class="comment">/* æ ‡è¯†ç¬¦ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ segname åœ¨æºç ä¸­å®šä¹‰çš„å®ï¼Œæœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_PAGEZERO    <span class="meta-string">"__PAGEZERO"</span> <span class="comment">/* å½“æ—¶ MH_EXECUTE æ–‡ä»¶æ—¶ï¼Œæ•è·åˆ°ç©ºæŒ‡é’ˆ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_TEXT    <span class="meta-string">"__TEXT"</span> <span class="comment">/* ä»£ç /åªè¯»æ•°æ®æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_DATA    <span class="meta-string">"__DATA"</span> <span class="comment">/* æ•°æ®æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_OBJC    <span class="meta-string">"__OBJC"</span> <span class="comment">/* Objective-C runtime æ®µ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    SEG_LINKEDIT    <span class="meta-string">"__LINKEDIT"</span> <span class="comment">/* åŒ…å«éœ€è¦è¢«åŠ¨æ€é“¾æ¥å™¨ä½¿ç”¨çš„ç¬¦å·å’Œå…¶ä»–è¡¨ï¼ŒåŒ…æ‹¬ç¬¦å·è¡¨ã€å­—ç¬¦ä¸²è¡¨ç­‰ */</span></span></span><br></pre></td></tr></table></figure>
<p>éƒ¨åˆ†çš„ Segment ï¼ˆä¸»è¦æŒ‡çš„ <code>__TEXT</code> å’Œ <code>__DATA</code>ï¼‰å¯ä»¥è¿›ä¸€æ­¥åˆ†è§£ä¸º Sectionã€‚ä¹‹æ‰€ä»¥æŒ‰ç…§ Segment -&gt; Section çš„ç»“æ„ç»„ç»‡æ–¹å¼ï¼Œæ˜¯å› ä¸ºåœ¨åŒä¸€ä¸ª Segment ä¸‹çš„ Sectionï¼Œå¯ä»¥æ§åˆ¶ç›¸åŒçš„æƒé™ï¼Œä¹Ÿå¯ä»¥ä¸å®Œå…¨æŒ‰ç…§ Page çš„å¤§å°è¿›è¡Œå†…å­˜å¯¹å…¶ï¼ŒèŠ‚çœå†…å­˜çš„ç©ºé—´ã€‚è€Œ Segment å¯¹å¤–æ•´ä½“æš´éœ²ï¼Œåœ¨ç¨‹åºè½½å…¥é˜¶æ®µæ˜ å°„æˆä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿå†…å­˜ï¼Œæ›´å¥½çš„åšåˆ°å†…å­˜å¯¹é½ï¼ˆå¯ä»¥ç»§ç»­å‚è€ƒ OS X &amp; iOS Kernel Programming ä¸€ä¹¦çš„ç¬¬ä¸€ç« å†…å®¹)</p>
<p>Sectionå®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// user/include / mach-o / loader.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">section_64</span> &#123;</span> </span><br><span class="line">    <span class="keyword">char</span>        sectname[<span class="number">16</span>];    <span class="comment">/* Section åå­— */</span></span><br><span class="line">    <span class="keyword">char</span>        segname[<span class="number">16</span>];    <span class="comment">/* Section æ‰€åœ¨çš„ Segment åç§° */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    addr;        <span class="comment">/* Section æ‰€åœ¨çš„å†…å­˜åœ°å€ */</span></span><br><span class="line">    <span class="keyword">uint64_t</span>    size;        <span class="comment">/* Section çš„å¤§å° */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    offset;        <span class="comment">/* Section æ‰€åœ¨çš„æ–‡ä»¶åç§» */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    align;        <span class="comment">/* Section çš„å†…å­˜å¯¹é½è¾¹ç•Œ (2 çš„æ¬¡å¹‚) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reloff;        <span class="comment">/* é‡å®šä½ä¿¡æ¯çš„æ–‡ä»¶åç§» */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    nreloc;        <span class="comment">/* é‡å®šä½æ¡ç›®çš„æ•°ç›® */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    flags;        <span class="comment">/* æ ‡å¿—å±æ€§ */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved1;    <span class="comment">/* ä¿ç•™å­—æ®µ1 (for offset or index) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved2;    <span class="comment">/* ä¿ç•™å­—æ®µ2 (for count or sizeof) */</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    reserved3;    <span class="comment">/* ä¿ç•™å­—æ®µ3 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸è§çš„ Sectionã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:left">Section</th>
<th style="text-align:center">ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>__TEXT.__text</code></td>
<td style="text-align:center">ä¸»ç¨‹åºä»£ç </td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__cstring</code></td>
<td style="text-align:center">C è¯­è¨€å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__const</code></td>
<td style="text-align:center">const å…³é”®å­—ä¿®é¥°çš„å¸¸é‡</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__stubs</code></td>
<td style="text-align:center">ç”¨äº Stub çš„å ä½ä»£ç ï¼Œå¾ˆå¤šåœ°æ–¹ç§°ä¹‹ä¸ºæ¡©ä»£ç ã€‚</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__stubs_helper</code></td>
<td style="text-align:center">å½“ Stub æ— æ³•æ‰¾åˆ°çœŸæ­£çš„ç¬¦å·åœ°å€åçš„æœ€ç»ˆæŒ‡å‘</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__objc_methname</code></td>
<td style="text-align:center">Objective-C æ–¹æ³•åç§°</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__objc_methtype</code></td>
<td style="text-align:center">Objective-C æ–¹æ³•ç±»å‹</td>
</tr>
<tr>
<td style="text-align:left"><code>__TEXT.__objc_classname</code></td>
<td style="text-align:center">Objective-C ç±»åç§°</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__data</code></td>
<td style="text-align:center">åˆå§‹åŒ–è¿‡çš„å¯å˜æ•°æ®</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__la_symbol_ptr</code></td>
<td style="text-align:center">lazy binding çš„æŒ‡é’ˆè¡¨ï¼Œè¡¨ä¸­çš„æŒ‡é’ˆä¸€å¼€å§‹éƒ½æŒ‡å‘ __stub_helper</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__nl_symbol_ptr</code></td>
<td style="text-align:center">é lazy binding çš„æŒ‡é’ˆè¡¨ï¼Œæ¯ä¸ªè¡¨é¡¹ä¸­çš„æŒ‡é’ˆéƒ½æŒ‡å‘ä¸€ä¸ªåœ¨è£…è½½è¿‡ç¨‹ä¸­ï¼Œè¢«åŠ¨æ€é“¾æœºå™¨æœç´¢å®Œæˆçš„ç¬¦å·</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__const</code></td>
<td style="text-align:center">æ²¡æœ‰åˆå§‹åŒ–è¿‡çš„å¸¸é‡</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__cfstring</code></td>
<td style="text-align:center">ç¨‹åºä¸­ä½¿ç”¨çš„ Core Foundation å­—ç¬¦ä¸²ï¼ˆCFStringRefsï¼‰</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__bss</code></td>
<td style="text-align:center">BSSï¼Œå­˜æ”¾ä¸ºåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå³å¸¸è¯´çš„é™æ€å†…å­˜åˆ†é…</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__common</code></td>
<td style="text-align:center">æ²¡æœ‰åˆå§‹åŒ–è¿‡çš„ç¬¦å·å£°æ˜</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_classlist</code></td>
<td style="text-align:center">Objective-C ç±»åˆ—è¡¨</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_protolist</code></td>
<td style="text-align:center">Objective-C åŸå‹</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_imginfo</code></td>
<td style="text-align:center">Objective-C é•œåƒä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_selfrefs</code></td>
<td style="text-align:center">Objective-C self å¼•ç”¨</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_protorefs</code></td>
<td style="text-align:center">Objective-C åŸå‹å¼•ç”¨</td>
</tr>
<tr>
<td style="text-align:left"><code>__DATA.__objc_superrefs</code></td>
<td style="text-align:center">Objective-C è¶…ç±»å¼•ç”¨</td>
</tr>
</tbody>
</table>
<p><code>__TEXT.__text</code> è¿™é‡Œå­˜æ”¾çš„æ˜¯æ±‡ç¼–åçš„ä»£ç ï¼Œå½“æˆ‘ä»¬è¿›è¡Œç¼–è¯‘æ—¶ï¼Œæ¯ä¸ª.mæ–‡ä»¶ä¼šç»è¿‡é¢„ç¼–è¯‘-&gt;ç¼–è¯‘-&gt;æ±‡ç¼–å½¢æˆ.oæ–‡ä»¶ï¼Œç§°ä¹‹ä¸ºç›®æ ‡æ–‡ä»¶ã€‚æ±‡ç¼–åï¼Œæ‰€æœ‰çš„ä»£ç ä¼šå½¢æˆæ±‡ç¼–æŒ‡ä»¤å­˜å‚¨åœ¨.oæ–‡ä»¶çš„(<strong>TEXT,</strong>text)åŒºï¼ˆï¼ˆ<strong>DATA,</strong>dataï¼‰ä¹Ÿæ˜¯ç±»ä¼¼ï¼‰ã€‚é“¾æ¥åï¼Œæ‰€æœ‰çš„.oæ–‡ä»¶ä¼šåˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€æœ‰.oæ–‡ä»¶çš„(<strong>TEXT,</strong>text)æ•°æ®éƒ½ä¼šæŒ‰é“¾æ¥é¡ºåºå­˜æ”¾åˆ°åº”ç”¨æ–‡ä»¶çš„(<strong>TEXT,</strong>text)ä¸­ã€‚</p>
<p><code>__DATA.__data</code> å­˜å‚¨æ•°æ®çš„sectionï¼Œstaticåœ¨è¿›è¡Œéé›¶èµ‹å€¼åä¼šå­˜å‚¨åœ¨è¿™é‡Œï¼Œå¦‚æœstatic å˜é‡æ²¡æœ‰èµ‹å€¼æˆ–è€…èµ‹å€¼ä¸º0ï¼Œé‚£ä¹ˆå®ƒä¼šå­˜å‚¨åœ¨<code>__DATA.__bss</code>ä¸­ã€‚</p>
<p>å¦å¤–è¿˜æœ‰ <code>Symbol Table</code>ç¬¦å·è¡¨ï¼Œè¿™ä¸ªæ˜¯é‡ç‚¹ä¸­çš„é‡ç‚¹ï¼Œç¬¦å·è¡¨æ˜¯å°†åœ°å€å’Œç¬¦å·è”ç³»èµ·æ¥çš„æ¡¥æ¢ã€‚ç¬¦å·è¡¨å¹¶ä¸èƒ½ç›´æ¥å­˜å‚¨ç¬¦å·ï¼Œè€Œæ˜¯å­˜å‚¨ç¬¦å·ä½äºå­—ç¬¦ä¸²è¡¨çš„ä½ç½®ã€‚</p>
<p><code>String Table</code>å­—ç¬¦ä¸²è¡¨æ‰€æœ‰çš„å˜é‡åã€å‡½æ•°åç­‰ï¼Œéƒ½ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å­˜å‚¨åœ¨å­—ç¬¦ä¸²è¡¨ä¸­ã€‚</p>
<h3 id="å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å"><a href="#å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å" class="headerlink" title="å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å"></a>å®è·µï¼šå…³è”ç±»çš„æ–¹æ³•å</h3><p>ä¸Šé¢è¯´äº†ä¸€å¤§å †å®šä¹‰ï¼Œæ¥æŸ¥çœ‹ä½¿ç”¨Mach-Oæ–‡ä»¶å‘¢ã€‚è¿™é‡Œæ¥çœ‹ä¸€ä¸‹å¦‚ä½•ç”¨ MachO æ–‡ä»¶å…³è”ç±»çš„æ–¹æ³•åã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹ <code>Load Commands</code>é‡Œçš„è¡¨ç¤ºç±»åçš„ <code>__objc_classname</code> :</p>
<p><img src="/res/MachO/macho-find.png" alt></p>
<p>æ ¹æ® offsetå­—æ®µ <code>0000425F</code> å€¼å¯ä»¥æ‰¾åˆ° sectionä¸­å¯¹åº”çš„ <code>__TEXT,__objc_classname</code> ä¿¡æ¯:</p>
<p><img src="/res/MachO/macho-find2.png" alt></p>
<p>åŒç†å¯ä»¥æ‰¾åˆ°å¯¹åº”æ–¹æ³•åçš„ <code>__objc_methname</code> å’Œ è¡¨ç¤ºç±»è™šæ‹Ÿåœ°å€çš„ <code>__objc_classlist</code> :</p>
<p><img src="/res/MachO/macho-find3.png" alt></p>
<p>å…¶ä¸­æˆ‘ä»¬éœ€è¦æŸ¥çœ‹ç±»çš„æ–¹æ³•åä¿¡æ¯å°±åœ¨<code>__objc_classlist</code>ä¸­ï¼Œæ ¹æ®ä¸Šå›¾ä¸­ <code>_OBJC_CLASS_$_ViewController</code> å¯¹åº”çš„data : <code>00000001000060E8</code>,å¯ä»¥åœ¨<code>__DATA,__objc_data</code>ä¸­æ‰¾åˆ°ç±»ç»“æ„ä¿¡æ¯ï¼š</p>
<p><img src="/res/MachO/macho-find4.png" alt></p>
<p>å…¶ä¸­data æ˜¯æˆ‘ä»¬æ„Ÿå…´è¶£çš„ï¼Œå®ƒæŒ‡å‘ class_ro_tï¼Œ class_ro_t å­˜å‚¨äº†ç±»åœ¨ç¼–è¯‘å™¨å°±ç¡®å®šçš„å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰ã€‚æ ¹æ®dataçš„å€¼ <code>0x100005370</code>å°±æ‰¾åˆ°äº†<code>__DATA,__objc_const</code>ä¸­ï¼š</p>
<p><img src="/res/MachO/macho-find5.png" alt></p>
<p>å…¶ä¸­baseMethods <code>0x100005350</code> æŒ‡å‘äº†ç¬¬ä¸€ä¸ªæ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬å°±å°±æ‰¾åˆ°äº†ç±»çš„æ–¹æ³•åã€‚</p>
<h2 id="ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯"><a href="#ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯" class="headerlink" title="ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯"></a>ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹Mach-Oä¿¡æ¯</h2><p>ä¸Šæ–‡æ˜¯å€ŸåŠ© MachOView è¿™ä¸ªå·¥å…· å’Œ <code>loader.h</code> æ¥äº†è§£Mach-Oæ–‡ä»¶çš„å¤§æ¦‚å®šä¹‰ï¼Œç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨<code>size</code>å’Œ<code>otool</code> æŸ¥çœ‹ä¸€ä¸‹Mach-Oæ–‡ä»¶ã€‚</p>
<p>å¦‚ä¸‹è¿™æ ·ä¸€ä¸ª hello.cæ–‡ä»¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello world\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨clangç”ŸæˆMach-Oæ–‡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç”Ÿæˆ hello.out çš„ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">xcrun clang hello.c -o hello.out</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡ <code>file</code> å‘½ä»¤æ¥æŸ¥çœ‹ç®€è¦çš„æ¶æ„ä¿¡æ¯:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">file hello.out </span><br><span class="line"><span class="comment">#è¾“å‡ºï¼š</span></span><br><span class="line">hello.out: Mach-O 64-bit executable x86_64</span><br></pre></td></tr></table></figure>
<h3 id="ä¸€ã€-Section"><a href="#ä¸€ã€-Section" class="headerlink" title="ä¸€ã€ Section"></a>ä¸€ã€ Section</h3><p>å°±åƒæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ä¸€æ ·ï¼Œè¿™é‡Œæœ‰äº›ä¸œè¥¿å«åš sectionã€‚ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åŒ…å«å¤šä¸ªæ®µï¼Œä¹Ÿå°±æ˜¯å¤šä¸ª sectionã€‚å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒçš„éƒ¨åˆ†å°†åŠ è½½è¿›ä¸åŒçš„ sectionï¼Œå¹¶ä¸”æ¯ä¸ª section ä¼šè½¬æ¢è¿›æŸä¸ª segment é‡Œã€‚è¿™ä¸ªæ¦‚å¿µå¯¹äºæ‰€æœ‰çš„å¯æ‰§è¡Œæ–‡ä»¶éƒ½æ˜¯æˆç«‹çš„ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ hello.out äºŒè¿›åˆ¶ä¸­çš„ sectionã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ size å·¥å…·æ¥è§‚å¯Ÿ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">size -x -l -m hello.out </span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">Segment __PAGEZERO: 0x100000000 (vmaddr 0x0 fileoff 0)</span><br><span class="line">Segment __TEXT: 0x1000 (vmaddr 0x100000000 fileoff 0)</span><br><span class="line">	Section __text: 0x2a (addr 0x100000f60 offset 3936)</span><br><span class="line">	Section __stubs: 0x6 (addr 0x100000f8a offset 3978)</span><br><span class="line">	Section __stub_helper: 0x1a (addr 0x100000f90 offset 3984)</span><br><span class="line">	Section __cstring: 0xd (addr 0x100000faa offset 4010)</span><br><span class="line">	Section __unwind_info: 0x48 (addr 0x100000fb8 offset 4024)</span><br><span class="line">	total 0x9f</span><br><span class="line">Segment __DATA: 0x1000 (vmaddr 0x100001000 fileoff 4096)</span><br><span class="line">	Section __nl_symbol_ptr: 0x10 (addr 0x100001000 offset 4096)</span><br><span class="line">	Section __la_symbol_ptr: 0x8 (addr 0x100001010 offset 4112)</span><br><span class="line">	total 0x18</span><br><span class="line">Segment __LINKEDIT: 0x1000 (vmaddr 0x100002000 fileoff 8192)</span><br><span class="line">total 0x100003000</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬çš„ <code>hello.out</code> æ–‡ä»¶æœ‰ 4 ä¸ª segmentã€‚æœ‰äº› segment ä¸­æœ‰å¤šä¸ª sectionã€‚</p>
<p>å½“è¿è¡Œä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œè™šæ‹Ÿå†…å­˜ (VM - virtual memory) ç³»ç»Ÿå°† segment æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸Šã€‚æ˜ å°„å®Œå…¨ä¸åŒäºæˆ‘ä»¬ä¸€èˆ¬çš„è®¤è¯†ï¼Œå¦‚æœä½ å¯¹è™šæ‹Ÿå†…å­˜ç³»ç»Ÿä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥ç®€å•çš„æƒ³è±¡è™šæ‹Ÿå†…å­˜ç³»ç»Ÿå°†æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶åŠ è½½è¿›å†…å­˜ â€“ è™½ç„¶åœ¨å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚VM ä½¿ç”¨äº†ä¸€äº›æŠ€å·§æ¥é¿å…å…¨éƒ¨åŠ è½½ã€‚</p>
<p>å½“è™šæ‹Ÿå†…å­˜ç³»ç»Ÿè¿›è¡Œæ˜ å°„æ—¶ï¼Œsegment å’Œ section ä¼šä»¥ä¸åŒçš„å‚æ•°å’Œæƒé™è¢«æ˜ å°„ã€‚</p>
<p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ__TEXT segment åŒ…å«äº†è¢«æ‰§è¡Œçš„ä»£ç ã€‚å®ƒè¢«ä»¥åªè¯»å’Œå¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚è¿›ç¨‹è¢«å…è®¸æ‰§è¡Œè¿™äº›ä»£ç ï¼Œä½†æ˜¯ä¸èƒ½ä¿®æ”¹ã€‚è¿™äº›ä»£ç ä¹Ÿä¸èƒ½å¯¹è‡ªå·±åšå‡ºä¿®æ”¹ï¼Œå› æ­¤è¿™äº›è¢«æ˜ å°„çš„é¡µä»æ¥ä¸ä¼šè¢«æ”¹å˜ã€‚</p>
<p>__DATA segment ä»¥å¯è¯»å†™å’Œä¸å¯æ‰§è¡Œçš„æ–¹å¼æ˜ å°„ã€‚å®ƒåŒ…å«äº†å°†ä¼šè¢«æ›´æ”¹çš„æ•°æ®ã€‚</p>
<p>ç¬¬ä¸€ä¸ª segment æ˜¯ __PAGEZEROã€‚å®ƒçš„å¤§å°ä¸º 4GBã€‚è¿™ 4GB å¹¶ä¸æ˜¯æ–‡ä»¶çš„çœŸå®å¤§å°ï¼Œä½†æ˜¯è§„å®šäº†è¿›ç¨‹åœ°å€ç©ºé—´çš„å‰ 4GB è¢«æ˜ å°„ä¸º ä¸å¯æ‰§è¡Œã€ä¸å¯å†™å’Œä¸å¯è¯»ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“è¯»å†™ä¸€ä¸ª NULL æŒ‡é’ˆæˆ–æ›´å°çš„å€¼æ—¶ä¼šå¾—åˆ°ä¸€ä¸ª EXC_BAD_ACCESS é”™è¯¯ã€‚è¿™æ˜¯æ“ä½œç³»ç»Ÿåœ¨å°è¯•é˜²æ­¢å¼•èµ·ç³»ç»Ÿå´©æºƒã€‚</p>
<p>åœ¨ segmentä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šæœ‰å¤šä¸ª sectionã€‚å®ƒä»¬åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸åŒéƒ¨åˆ†ã€‚åœ¨ <strong>TEXT segment ä¸­ï¼Œ</strong>text section åŒ…å«äº†ç¼–è¯‘æ‰€å¾—åˆ°çš„æœºå™¨ç ã€‚<strong>stubs å’Œ </strong>stub_helper æ˜¯ç»™åŠ¨æ€é“¾æ¥å™¨ (dyld) ä½¿ç”¨çš„ã€‚é€šè¿‡è¿™ä¸¤ä¸ª sectionï¼Œåœ¨åŠ¨æ€é“¾æ¥ä»£ç ä¸­ï¼Œå¯ä»¥å…è®¸å»¶è¿Ÿé“¾æ¥ã€‚<strong>const (åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ²¡æœ‰) æ˜¯å¸¸é‡ï¼Œä¸å¯å˜çš„ï¼Œå°±åƒ </strong>cstring (åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡ â€“ åœ¨æºç ä¸­è¢«åŒå¼•å·åŒ…å«çš„å­—ç¬¦ä¸²) å¸¸é‡ä¸€æ ·ã€‚</p>
<p><strong>DATA segment ä¸­åŒ…å«äº†å¯è¯»å†™æ•°æ®ã€‚åœ¨æˆ‘ä»¬çš„ç¨‹åºä¸­åªæœ‰ </strong>nl_symbol_ptr å’Œ __la_symbol_ptrï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ non-lazy å’Œ lazy ç¬¦å·æŒ‡é’ˆã€‚å»¶è¿Ÿç¬¦å·æŒ‡é’ˆç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ä¸­è°ƒç”¨æœªå®šä¹‰çš„å‡½æ•°ï¼Œä¾‹å¦‚ä¸åŒ…å«åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å‡½æ•°ï¼Œå®ƒä»¬å°†ä¼šå»¶è¿ŸåŠ è½½ã€‚è€Œé’ˆå¯¹éå»¶è¿Ÿç¬¦å·æŒ‡é’ˆï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½åŒæ—¶ï¼Œä¹Ÿä¼šè¢«åŠ è½½ã€‚</p>
<p>åœ¨ _DATA segment ä¸­çš„å…¶å®ƒå¸¸è§ section åŒ…æ‹¬ <strong>constï¼Œåœ¨è¿™é‡Œé¢ä¼šåŒ…å«ä¸€äº›éœ€è¦é‡å®šå‘çš„å¸¸é‡æ•°æ®ã€‚ä¾‹å¦‚ char * const p = â€œfooâ€; â€“ p æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®æ˜¯å¯å˜çš„ã€‚</strong>bss section æ²¡æœ‰è¢«åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œä¾‹å¦‚ static int a; â€“ ANSI C æ ‡å‡†è§„å®šé™æ€å˜é‡å¿…é¡»è®¾ç½®ä¸º 0ã€‚å¹¶ä¸”åœ¨è¿è¡Œæ—¶é™æ€å˜é‡çš„å€¼æ˜¯å¯ä»¥ä¿®æ”¹çš„ã€‚<strong>common section åŒ…å«æœªåˆå§‹åŒ–çš„å¤–éƒ¨å…¨å±€å˜é‡ï¼Œè·Ÿ static å˜é‡ç±»ä¼¼ã€‚ä¾‹å¦‚åœ¨å‡½æ•°å¤–é¢å®šä¹‰çš„ int a;ã€‚æœ€åï¼Œ</strong>dyld æ˜¯ä¸€ä¸ª section å ä½ç¬¦ï¼Œè¢«ç”¨äºåŠ¨æ€é“¾æ¥å™¨ã€‚</p>
<h3 id="äºŒã€Section-ä¸­çš„å†…å®¹"><a href="#äºŒã€Section-ä¸­çš„å†…å®¹" class="headerlink" title="äºŒã€Section ä¸­çš„å†…å®¹"></a>äºŒã€Section ä¸­çš„å†…å®¹</h3><p>å¯ä»¥é€šè¿‡ <code>otool</code> æ¥äº†è§£sectionä¸­çš„å†…å®¹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">otool -s  __TEXT __text  hello.out </span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">hello.out:</span><br><span class="line">Contents of (__TEXT,__text) section</span><br><span class="line">0000000100000f60	55 48 89 e5 48 83 ec 10 c7 45 <span class="built_in">fc</span> 00 00 00 00 48 </span><br><span class="line">0000000100000f70	8d 3d 34 00 00 00 b0 00 e8 0d 00 00 00 31 c9 89 </span><br><span class="line">0000000100000f80	45 f8 89 c8 48 83 c4 10 5d c3</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æ·»åŠ  -v æ¥æŸ¥çœ‹åæ±‡ç¼–ä»£ç  , ç”±äº -s <strong>TEXT </strong>text å¾ˆå¸¸è§ï¼Œotool å¯¹å…¶è®¾ç½®äº†ä¸€ä¸ªç¼©å†™ -t ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">otool -v -t  hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º </span></span><br><span class="line">hello.out:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line">_main:</span><br><span class="line">0000000100000f60	pushq	%rbp</span><br><span class="line">0000000100000f61	movq	%rsp, %rbp</span><br><span class="line">0000000100000f64	subq	<span class="variable">$0x10</span>, %rsp</span><br><span class="line">0000000100000f68	movl	<span class="variable">$0x0</span>, -0x4(%rbp)</span><br><span class="line">0000000100000f6f	leaq	0x34(%rip), %rdi</span><br><span class="line">0000000100000f76	movb	<span class="variable">$0x0</span>, %al</span><br><span class="line">0000000100000f78	callq	0x100000f8a</span><br><span class="line">0000000100000f7d	xorl	%ecx, %ecx</span><br><span class="line">0000000100000f7f	movl	%eax, -0x8(%rbp)</span><br><span class="line">0000000100000f82	movl	%ecx, %eax</span><br><span class="line">0000000100000f84	addq	<span class="variable">$0x10</span>, %rsp</span><br><span class="line">0000000100000f88	popq	%rbp</span><br><span class="line">0000000100000f89	retq</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å†…å®¹æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡ä»¥åæ±‡ç¼–å½¢å¼æ˜¾ç¤ºå‡ºæ¥ã€‚ä½ åº”è¯¥æ„Ÿè§‰å¾ˆç†Ÿæ‚‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢ç¼–è¯‘æ—¶å€™çš„ä»£ç ã€‚å”¯ä¸€çš„ä¸åŒå°±æ˜¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½•çš„æ±‡ç¼–æŒ‡ä»¤åœ¨é‡Œé¢ã€‚è¿™æ˜¯çº¯ç²¹çš„äºŒè¿›åˆ¶æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<!-- ## åº”ç”¨

äº†è§£Mach-Oæ–‡ä»¶çš„ä¸»è¦åº”ç”¨ä¹‹ä¸€æ˜¯ä»£ç å¤§å°æ€§èƒ½ä¼˜åŒ–ã€‚


### å¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº«

__objc_classlist å’Œ __objc_classrefs

### è·å–è°ƒç”¨å †æ ˆ -->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>Mach-O</tag>
      </tags>
  </entry>
  <entry>
    <title>LLDBæ•™ç¨‹-å‘½ä»¤ç¯‡</title>
    <url>/essay/LLDB/LLDB_tutorial/</url>
    <content><![CDATA[<p>ä½ æ˜¯å¦æ›¾ç»è‹¦æ¼äºç†è§£é¡¹ç›®çš„ä»£ç ï¼Œè€Œå»å°è¯•æ‰“å°ä¸€ä¸ªå˜é‡çš„å€¼ï¼Ÿç„¶åä½¿ç”¨NSLog å¹¶ä¸”æ¯æ¬¡å¿…é¡»é‡æ–°ç¼–è¯‘ï¼Œä»å¤´å¼€å§‹ï¼Ÿä½†æ˜¯ä¸ä¸€å®šè¦è¿™ä¹ˆåšã€‚ä½ å¯ä»¥ä½¿ç”¨è°ƒè¯•å™¨ã€‚è€Œä¸”å³ä½¿ä½ å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨è°ƒè¯•å™¨æ£€æŸ¥å˜é‡ï¼Œå®ƒå¯ä»¥åšçš„è¿˜æœ‰å¾ˆå¤šã€‚</p>
<h2 id="LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#LLDB-æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="LLDB æ˜¯ä»€ä¹ˆï¼Ÿ"></a>LLDB æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><a href="http://lldb.llvm.org/" target="_blank" rel="noopener">LLDB</a>æ˜¯Mac OS Xä¸ŠXcodeçš„é»˜è®¤è°ƒè¯•å™¨ï¼Œæ”¯æŒå†æ¡Œé¢å’ŒiOSè®¾å¤‡å’Œæ¨¡æ‹Ÿå™¨ä¸Šè°ƒè¯•C ï¼ŒObjective-Cå’ŒC++ã€‚å®ƒæ˜¯æ–°ä¸€ä»£é«˜æ€§èƒ½è°ƒè¯•å™¨ï¼Œå®ƒå¯ä»¥é«˜æ•ˆåˆ©ç”¨LLVMé¡¹ç›®ä¸­çš„ç°æœ‰åº“ï¼Œä¾‹å¦‚Clangè¡¨è¾¾å¼è§£æå™¨å’ŒLLVMåæ±‡ç¼–ç¨‹åºã€‚</p>
<p>éšç€Xcode 5çš„å‘å¸ƒï¼ŒLLDBè°ƒè¯•å™¨å·²ç»å–ä»£äº†GDBï¼Œæˆä¸ºäº†Xcodeå·¥ç¨‹ä¸­é»˜è®¤çš„è°ƒè¯•å™¨ã€‚å®ƒä¸LLVMç¼–è¯‘å™¨ä¸€èµ·ï¼Œå¸¦ç»™æˆ‘ä»¬æ›´ä¸°å¯Œçš„æµç¨‹æ§åˆ¶å’Œæ•°æ®æ£€æµ‹çš„è°ƒè¯•åŠŸèƒ½ã€‚LLDBä¸ºXcodeæä¾›äº†åº•å±‚è°ƒè¯•ç¯å¢ƒï¼Œå…¶ä¸­åŒ…æ‹¬å†…åµŒåœ¨Xcode IDEä¸­çš„ä½äºè°ƒè¯•åŒºåŸŸçš„æ§åˆ¶é¢æ¿ã€‚</p>
<p><a href="https://github.com/facebook/chisel" target="_blank" rel="noopener">Chisel</a> æ˜¯facebookä¸‹ä¸€ä¸ªå¼€æºLLDBå‘½ä»¤é›†åˆã€‚</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œè®©æˆ‘ä»¬ä»¥åœ¨è°ƒè¯•å™¨ä¸­æ‰“å°å˜é‡æ¥å¼€å§‹æˆ‘ä»¬çš„æ—…ç¨‹å§ã€‚</p>
<a id="more"></a>
<h2 id="åŸºç¡€å‘½ä»¤"><a href="#åŸºç¡€å‘½ä»¤" class="headerlink" title="åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h2><p><img src="/res/LLDB/1.png" alt></p>
<p>è¿™æ˜¯ä¸€ä¸ªç®€å•åŠ äº†æ–­ç‚¹çš„ç¨‹åºï¼Œç¨‹åºä¼šåœ¨è¿™ä¸€è¡Œåœæ­¢è¿è¡Œï¼Œå¹¶ä¸”æ§åˆ¶å°ä¼šè¢«æ‰“å¼€ï¼Œå…è®¸æˆ‘ä»¬å’Œè°ƒè¯•å™¨äº¤äº’ã€‚è¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥æ‰“äº›ä»€ä¹ˆå‘½ä»¤å‘¢ï¼Ÿ</p>
<p><strong><em>å¸®åŠ© help</em></strong></p>
<p>æœ€ç®€å•å‘½ä»¤æ˜¯ <code>help</code>ï¼Œå®ƒä¼šåˆ—ä¸¾å‡ºæ‰€æœ‰çš„å‘½ä»¤ã€‚å¦‚æœä½ å¿˜è®°äº†ä¸€ä¸ªå‘½ä»¤æ˜¯åšä»€ä¹ˆçš„ï¼Œæˆ–è€…æƒ³çŸ¥é“æ›´å¤šçš„è¯ï¼Œä½ å¯ä»¥é€šè¿‡ <code>help &lt;command-name&gt;</code> æ¥äº†è§£æ›´å¤šç»†èŠ‚ï¼Œä¾‹å¦‚ <code>help print</code> æˆ–è€… <code>help thread</code>ã€‚åªéœ€è¦åœ¨æ§åˆ¶å° ä¸Šå›¾lldbå­—æ ·çš„åœ°æ–¹é”®å…¥ helpå³å¯ã€‚</p>
<p><img src="/res/LLDB/2.png" alt></p>
<p><strong><em>æ‰“å°å¯¹è±¡ print</em></strong><br>æ‰“å°å€¼å¾ˆç®€å•ï¼›åªè¦è¯•è¯• print å‘½ä»¤:</p>
<p><img src="/res/LLDB/3.png" alt></p>
<p>LLDB å®é™…ä¸Šä¼šä½œå‰ç¼€åŒ¹é…ã€‚æ‰€ä»¥ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ prinï¼Œpriï¼Œæˆ–è€… pã€‚ä½†ä½ ä¸èƒ½ä½¿ç”¨ prï¼Œå› ä¸º LLDB ä¸èƒ½æ¶ˆé™¤å’Œ process çš„æ­§ä¹‰ (å¹¸è¿çš„æ˜¯ p å¹¶æ²¡æœ‰æ­§ä¹‰)ã€‚è€Œprint åˆ™æ˜¯<code>expression --</code>çš„ç®€å†™æ–¹å¼ã€‚</p>
<p>ä½ å¯èƒ½è¿˜æ³¨æ„åˆ°äº†ï¼Œç»“æœä¸­æœ‰ä¸ª $0ã€‚å®é™…ä¸Šä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥æŒ‡å‘è¿™ä¸ªç»“æœã€‚è¯•è¯• print $0 + 7ï¼Œä½ ä¼šçœ‹åˆ° 130ã€‚ä»»ä½•ä»¥$ç¬¦å¼€å¤´çš„ä¸œè¥¿éƒ½æ˜¯å­˜åœ¨äº LLDB çš„å‘½åç©ºé—´çš„ï¼Œå®ƒä»¬æ˜¯ä¸ºäº†å¸®åŠ©ä½ è¿›è¡Œè°ƒè¯•è€Œå­˜åœ¨çš„ã€‚</p>
<p>æ‰“å°å¤æ‚å¯¹è±¡æ—¶ï¼Œprintå¯èƒ½æ˜¾å¾—åŠ›ä¸ä»å¿ƒ ï¼Œæˆ‘ä»¬æƒ³çœ‹çš„æ˜¯å¯¹è±¡çš„ description æ–¹æ³•çš„ç»“æœï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨ <code>po</code> ï¼Œpo å…¶å®æ˜¯ <code>e -o --</code>çš„åˆ«åã€‚</p>
<p>ç”šè‡³å¯ä»¥ç»™print æŒ‡å®šä¸åŒçš„æ‰“å°æ ¼å¼ã€‚å®ƒä»¬éƒ½æ˜¯ä»¥ <code>print/&lt;fmt&gt;</code> æˆ–è€…ç®€åŒ–çš„ <code>p/&lt;fmt&gt;</code> æ ¼å¼ä¹¦å†™ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤çš„æ ¼å¼</span></span><br><span class="line">(lldb) p <span class="number">16</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="comment">//åå…­è¿›åˆ¶:</span></span><br><span class="line">(lldb) p/x <span class="number">16</span></span><br><span class="line"><span class="number">0x10</span></span><br><span class="line"><span class="comment">//äºŒè¿›åˆ¶ (t ä»£è¡¨ two)ï¼š</span></span><br><span class="line">(lldb) p/t <span class="number">16</span></span><br><span class="line"><span class="number">0</span>b00000000000000000000000000010000</span><br><span class="line">(lldb) p/t (<span class="keyword">char</span>)<span class="number">16</span></span><br><span class="line"><span class="number">0</span>b00010000</span><br></pre></td></tr></table></figure>
<p><a href="https://sourceware.org/gdb/onlinedocs/gdb/Output-Formats.html" target="_blank" rel="noopener">è¿™é‡Œæ˜¯æ ¼å¼çš„å®Œæ•´æ¸…å•</a></p>
<p><strong><em>ä¿®æ”¹å¯¹è±¡ expression</em></strong></p>
<p>å¦‚æœæƒ³æ”¹å˜ä¸€ä¸ªå€¼æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯ <code>expression</code> è¿™ä¸ªæ–¹ä¾¿çš„å‘½ä»¤ã€‚</p>
<p><img src="/res/LLDB/4.png" alt></p>
<p>ä¸Šå›¾ä¸­ä¿®æ”¹äº†numçš„å€¼ï¼Œæ–­ç‚¹æ­¥è¿›åå¯ä»¥çœ‹åˆ°NSLogçš„å¯¹åº”å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚</p>
<h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>ç°åœ¨ä½ å·²ç»å¯ä»¥æ‰“å°å¯¹è±¡å’Œç®€å•ç±»å‹ï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•ä½¿ç”¨ expression å‘½ä»¤åœ¨è°ƒè¯•å™¨ä¸­ä¿®æ”¹å®ƒä»¬äº†ã€‚ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨ä¸€äº›å˜é‡æ¥å‡å°‘è¾“å…¥é‡ã€‚å°±åƒä½ å¯ä»¥åœ¨ C è¯­è¨€ä¸­ç”¨ int a = 0 æ¥å£°æ˜ä¸€ä¸ªå˜é‡ä¸€æ ·ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ LLDB ä¸­åšåŒæ ·çš„äº‹æƒ…ã€‚ä¸è¿‡ä¸ºäº†èƒ½ä½¿ç”¨å£°æ˜çš„å˜é‡ï¼Œå˜é‡å¿…é¡»ä»¥$ç¬¦å¼€å¤´ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) e <span class="keyword">int</span> $a = <span class="number">2</span></span><br><span class="line">(lldb) p $a * <span class="number">19</span></span><br><span class="line"><span class="number">38</span></span><br><span class="line">(lldb) e <span class="built_in">NSArray</span> *$array = @[ <span class="string">@"Saturday"</span>, <span class="string">@"Sunday"</span>, <span class="string">@"Monday"</span> ]</span><br><span class="line">(lldb) p [$array count]</span><br><span class="line"><span class="number">2</span></span><br><span class="line">(lldb) po [[$array objectAtIndex:<span class="number">0</span>] uppercaseString]</span><br><span class="line">SATURDAY</span><br><span class="line">(lldb) p (<span class="keyword">char</span>)[[$array objectAtIndex:$a] characterAtIndex:<span class="number">0</span>]</span><br><span class="line"><span class="string">'M'</span></span><br><span class="line">(lldb) p/d (<span class="keyword">char</span>)[[$array objectAtIndex:$a] characterAtIndex:<span class="number">0</span>]</span><br><span class="line"><span class="number">77</span></span><br></pre></td></tr></table></figure>
<h3 id="UIè°ƒè¯•"><a href="#UIè°ƒè¯•" class="headerlink" title="UIè°ƒè¯•"></a>UIè°ƒè¯•</h3><p>å› ä¸ºå…¨å±€å˜é‡æ˜¯å¯è®¿é—®çš„,å¯ä»¥åƒè¿™æ ·æ‰“å°æ•´ä¸ªè§†å›¾å±‚çº§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) po [[[UIApplication sharedApplication] keyWindow] recursiveDescription]</span><br><span class="line">&lt;UIWindow: 0x7fe5ac70c6a0; frame = (0 0; 375 812); gestureRecognizers = &lt;NSArray: 0x6000034cb780&gt;; layer = &lt;UIWindowLayer: 0x600003a84680&gt;&gt;</span><br><span class="line">   | &lt;UIView: 0x7fe5ac5069b0; frame = (0 0; 375 812); autoresize = W+H; layer = &lt;CALayer: 0x600003ad3620&gt;&gt;</span><br></pre></td></tr></table></figure>
<p><strong><em>1ã€æ›´æ–°UI</em></strong></p>
<p>å°±åƒä¸Šæ–‡å˜é‡ä¸­æåˆ°é‚£æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™ä¸ªview:</p>
<p><code>(lldb) expression id $myView = (id)0x7fe5ac5069b0</code></p>
<p>å°è¯•åšä¸€äº›ä¿®æ”¹ï¼š</p>
<p><code>(lldb) expression (void)[$myView setBackgroundColor:[UIColor redColor]]</code></p>
<p>ä½†æ˜¯åªæœ‰ç¨‹åºç»§ç»­è¿è¡Œä¹‹åæ‰ä¼šçœ‹åˆ°ç•Œé¢çš„å˜åŒ–ã€‚å› ä¸ºæ”¹å˜çš„å†…å®¹å¿…é¡»è¢«å‘é€åˆ°æ¸²æŸ“æœåŠ¡ä¸­ï¼Œç„¶åæ˜¾ç¤ºæ‰ä¼šè¢«æ›´æ–°ã€‚</p>
<p>æ¸²æŸ“æœåŠ¡å®é™…ä¸Šæ˜¯ä¸€ä¸ªå¦å¤–çš„è¿›ç¨‹ (è¢«ç§°ä½œ backboardd)ã€‚è¿™å°±æ˜¯è¯´å³ä½¿æˆ‘ä»¬æ­£åœ¨è°ƒè¯•çš„å†…å®¹æ‰€åœ¨çš„è¿›ç¨‹è¢«æ‰“æ–­äº†ï¼Œbackboardd ä¹Ÿè¿˜æ˜¯ç»§ç»­è¿è¡Œç€çš„ã€‚</p>
<p>è¿™æ„å‘³ç€ä½ å¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œè€Œä¸ç”¨ç»§ç»­è¿è¡Œç¨‹åºï¼š</p>
<p><code>(lldb) expression (void)[CATransaction flush]</code></p>
<p>è¿™ä¸ªæ—¶å€™å°±èƒ½çœ‹åˆ°èƒŒæ™¯é¢œè‰²çš„æ”¹å˜äº†ã€‚</p>
<h2 id="æµç¨‹æ§åˆ¶"><a href="#æµç¨‹æ§åˆ¶" class="headerlink" title="æµç¨‹æ§åˆ¶"></a>æµç¨‹æ§åˆ¶</h2><p>é€šè¿‡xcodeåŠ æ–­ç‚¹è°ƒè¯•æ—¶ï¼Œè°ƒè¯•æ¡ä¸Šå›å‡ºç°å››ä¸ªå¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œæµç¨‹çš„æŒ‰é’®ï¼š<br><img src="/res/LLDB/5.png" alt></p>
<p>ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ continue program execution ã€ step over ã€ step into å’Œ step outã€‚</p>
<p><strong><em>1ã€ continue program execution</em></strong> æŒ‰é’®ï¼Œä¼šå–æ¶ˆç¨‹åºçš„æš‚åœï¼Œå…è®¸ç¨‹åºæ­£å¸¸æ‰§è¡Œ (è¦ä¹ˆä¸€ç›´æ‰§è¡Œä¸‹å»ï¼Œè¦ä¹ˆåˆ°è¾¾ä¸‹ä¸€ä¸ªæ–­ç‚¹)ã€‚<br>åœ¨ LLDB ä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>process continue</code> æˆ–è€… <code>thread continue</code> å‘½ä»¤æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p>
<p><strong><em>2ã€ step over</em></strong> æŒ‰é’®ï¼Œä¼šä»¥é»‘ç›’çš„æ–¹å¼æ‰§è¡Œä¸€è¡Œä»£ç ã€‚å¦‚æœæ‰€åœ¨è¿™è¡Œä»£ç æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè·³è¿›è¿™ä¸ªå‡½æ•°ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œç„¶åç»§ç»­ã€‚<br>LLDB åˆ™å¯ä»¥ä½¿ç”¨ <code>thread step-over</code>ï¼Œ<code>next</code>ï¼Œæˆ–è€… <code>n</code> å‘½ä»¤ã€‚</p>
<p><strong><em>3ã€ step in</em></strong>æŒ‰é’®ï¼Œå¯ä»¥è·³è¿›ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥è°ƒè¯•æˆ–è€…æ£€æŸ¥ç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚<br>åœ¨LLDBä¸­ä½¿ç”¨ <code>thread step-in</code>ï¼Œ<code>step</code>ï¼Œæˆ–è€… s å‘½ä»¤ã€‚æ³¨æ„ï¼Œå½“å‰è¡Œä¸æ˜¯å‡½æ•°è°ƒç”¨æ—¶ï¼Œnext å’Œ step æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<p><strong><em>4ã€step out</em></strong>æŒ‰é’® ï¼Œå¦‚æœä½ æ›¾ç»ä¸å°å¿ƒè·³è¿›ä¸€ä¸ªå‡½æ•°ï¼Œä½†å®é™…ä¸Šä½ æƒ³è·³è¿‡å®ƒï¼Œå¸¸è§çš„ååº”æ˜¯é‡å¤çš„è¿è¡Œ n ç›´åˆ°å‡½æ•°è¿”å›ã€‚å…¶å®è¿™ç§æƒ…å†µï¼Œstep out æŒ‰é’®æ˜¯ä½ çš„æ•‘ä¸–ä¸»ã€‚å®ƒä¼šç»§ç»­æ‰§è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿”å›è¯­å¥ (ç›´åˆ°ä¸€ä¸ªå †æ ˆå¸§ç»“æŸ) ç„¶åå†æ¬¡åœæ­¢ã€‚<br>åœ¨LLDBä¸­ä½¿ç”¨ <code>thread step-out</code>ï¼Œ</p>
<p><strong><em>thread return</em></strong> ä½¿ç”¨<code>help thread</code>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ¯”è¾ƒå®ç”¨çš„å‡½æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œåœ¨æ‰§è¡Œæ—¶å®ƒä¼šæŠŠå¯é€‰å‚æ•°åŠ è½½è¿›è¿”å›å¯„å­˜å™¨é‡Œï¼Œç„¶åç«‹åˆ»æ‰§è¡Œè¿”å›å‘½ä»¤ï¼Œè·³å‡ºå½“å‰æ ˆå¸§ã€‚è¿™æ„å‘³è¿™å‡½æ•°å‰©ä½™çš„éƒ¨åˆ†ä¸ä¼šè¢«æ‰§è¡Œã€‚è¿™ä¼šç»™ ARC çš„å¼•ç”¨è®¡æ•°é€ æˆä¸€äº›é—®é¢˜ï¼Œæˆ–è€…ä¼šä½¿å‡½æ•°å†…çš„æ¸…ç†éƒ¨åˆ†å¤±æ•ˆã€‚ä½†æ˜¯åœ¨å‡½æ•°çš„å¼€å¤´æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œæ˜¯ä¸ªéå¸¸å¥½çš„éš”ç¦»è¿™ä¸ªå‡½æ•°ï¼Œä¼ªé€ è¿”å›å€¼çš„æ–¹å¼ ã€‚</p>
<h2 id="æ–­ç‚¹"><a href="#æ–­ç‚¹" class="headerlink" title="æ–­ç‚¹"></a>æ–­ç‚¹</h2><p>Xcodeåœ¨æ–­ç‚¹å¯¼èˆªä¸­æä¾›äº†ä¸€ç³»åˆ—å·¥å…·åˆ›å»ºå’Œç®¡ç†æ–­ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹LLDBä¸­ç­‰ä»·çš„å‘½ä»¤,ä¸»è¦æ˜¯<code>breakpoint</code>å‘½ä»¤ã€‚</p>
<p><strong><em>1ã€æŸ¥çœ‹ å¯ç”¨/ç¦ç”¨</em></strong></p>
<p><img src="/res/LLDB/6.png" alt></p>
<p>ä¸Šå›¾æ˜¯xcodeæŸ¥çœ‹æ–­ç‚¹çš„åœ°æ–¹ï¼Œç‚¹å‡»æ–­ç‚¹ä¼šå¼€å¯æˆ–å…³é—­æ–­ç‚¹ã€‚å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æŸ¥çœ‹æ–­ç‚¹ å‘½ä»¤è¾“å‡ºåˆ—è¡¨æ˜¾ç¤ºæ¯ä¸ªé€»è¾‘æ–­ç‚¹éƒ½æœ‰ä¸€ä¸ªæ•´æ•°æ ‡è¯†</span></span><br><span class="line"><span class="comment">//è¾“å‡ºåˆ—è¡¨ä¸­å¦ä¸€ä¸ªä¿¡æ¯æ˜¯æ–­ç‚¹ä½ç½®æ˜¯å¦æ˜¯å·²è§£æçš„(resolved)ã€‚è¿™ä¸ªæ ‡è¯†è¡¨ç¤ºå½“ä¸ä¹‹ç›¸å…³çš„æ–‡ä»¶åœ°å€è¢«åŠ è½½åˆ°ç¨‹åºè¿›è¡Œè°ƒè¯•æ—¶ï¼Œå…¶ä½ç½®æ˜¯å·²è§£æçš„ã€‚</span></span><br><span class="line">  <span class="comment">//ä¾‹å¦‚ï¼Œå¦‚æœåœ¨å…±äº«åº“ä¸­è®¾ç½®çš„æ–­ç‚¹ä¹‹åè¢«å¸è½½äº†ï¼Œåˆ™æ–­ç‚¹çš„ä½ç½®è¿˜ä¼šä¿ç•™ï¼Œä½†å…¶ä¸èƒ½å†è¢«è§£æã€‚</span></span><br><span class="line">(lldb) breakpoint list</span><br><span class="line">Current breakpoints:</span><br><span class="line">1: file = '/Users/suntongsheng/Desktop/tmp/asdasd/asdasd/main.m', line = 23, exact_match = 0, locations = 1, resolved = 1, hit count = 1</span><br><span class="line"></span><br><span class="line">  <span class="number">1.1</span>: where = asdasd`main + <span class="number">51</span> at main.m:<span class="number">23</span>, address = <span class="number">0x00000001070195d3</span>, resolved, hit count = <span class="number">1</span> </span><br><span class="line"><span class="comment">//ç¦ç”¨æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint disable <span class="number">1</span></span><br><span class="line"><span class="number">1</span> breakpoints disabled.</span><br><span class="line"><span class="comment">//å¯ç”¨æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint enable <span class="number">1</span></span><br><span class="line"><span class="number">1</span> breakpoints enabled.</span><br></pre></td></tr></table></figure>
<p><strong><em>2ã€ åˆ›å»º/åˆ é™¤</em></strong></p>
<p>åœ¨Xcodeåˆ›å»ºæ–­ç‚¹çš„æ–¹å¼ä¸€ç§æ˜¯ ç›´æ¥åœ¨ä»£ç å·¦è¾¹çš„è¡Œæ•°å‡ºç‚¹å‡» å³å¯åˆ›å»ºæ–­ç‚¹ã€‚å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨main.mçš„ç¬¬24è¡Œåˆ›å»ºæ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint set -f main.m -l <span class="number">24</span></span><br><span class="line">Breakpoint <span class="number">3</span>: where = asdasd`main + <span class="number">59</span> at main.m:<span class="number">24</span>, address = <span class="number">0x00000001070195db</span></span><br><span class="line"><span class="comment">//åˆ é™¤åˆšæ‰çš„æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint delete <span class="number">3</span></span><br><span class="line"><span class="number">1</span> breakpoints deleted; <span class="number">0</span> breakpoint locations disabled.</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰ä¸€ç§æ˜¯åœ¨æ–­ç‚¹å¯¼èˆªï¼Œç‚¹å‡»å·¦ä¸‹è§’çš„åŠ å·æŒ‰é’®ï¼Œé€‰æ‹©Symbolic BreakPointä¼šå‡ºç°ï¼š</p>
<p><img src="/res/LLDB/7.png" alt></p>
<p>å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨ä¸€ä¸ªç¬¦å· (C è¯­è¨€å‡½æ•°) ä¸Šåˆ›å»ºæ–­ç‚¹ï¼Œè€Œå®Œå…¨ä¸ç”¨æŒ‡å®šå“ªä¸€è¡Œ</span></span><br><span class="line">(lldb) breakpoint set  -F isEven</span><br><span class="line">Breakpoint <span class="number">6</span>: where = asdasd`isEven + <span class="number">16</span> at main.m:<span class="number">13</span>, address = <span class="number">0x0000000107019750</span></span><br><span class="line"><span class="comment">//Objective-C çš„æ–¹æ³•ä¹Ÿå®Œå…¨å¯ä»¥</span></span><br><span class="line">(lldb) breakpoint set -F <span class="string">"-[NSArray objectAtIndex:]"</span></span><br><span class="line">Breakpoint <span class="number">5</span>: where = CoreFoundation`-[<span class="built_in">NSArray</span> objectAtIndex:], address = <span class="number">0x000000010ac7a950</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>[NSArray objectAtIndex:]</code>è¿™ä¸ªæ–­ç‚¹ä¸Šï¼Œæˆ‘ä»¬æ€ä¹ˆèƒ½çŸ¥é“è®¾ç½®äº†ä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ç”¨$arg1ã€$arg2ç­‰å‘½ä»¤æ¥æ‰“å°å‡ºæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ã€‚<br>åœ¨è¿™é‡Œ$arg1æ˜¯æŒ‡å¯¹è±¡æœ¬èº«ï¼Œ$arg2æ˜¯å¯¹è±¡è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œpoå‘½ä»¤æ— æ³•ç›´æ¥è¾“å‡ºå‡½æ•°åï¼Œéœ€è¦åŠ ä¸Š(SEL)ï¼Œ$arg3æ˜¯è¢«èµ‹ç»™å‡½æ•°çš„å‚æ•°ã€‚</p>
<p><strong><em>3ã€ æ–­ç‚¹è¡Œä¸º</em></strong></p>
<p>åœ¨Xcodeä¸­é‚®ä»¶æ–­ç‚¹å¯ä»¥ç¼–è¾‘æ·»åŠ actionä¿¡æ¯ï¼Œä½ å¯ä»¥æ·»åŠ å¤šä¸ªè¡Œä¸ºï¼š</p>
<p><img src="/res/LLDB/8.png" alt></p>
<p>å¯¹åº”çš„LLDBå¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) breakpoint set -f main.m -l <span class="number">31</span></span><br><span class="line">Breakpoint <span class="number">2</span>: where = asdasd`main + <span class="number">205</span> at main.m:<span class="number">31</span>, address = <span class="number">0x000000010ab2166d</span></span><br><span class="line"><span class="comment">//æ·»åŠ æ¡ä»¶</span></span><br><span class="line">(lldb) breakpoint modify -c 'i == 80' 2</span><br><span class="line"><span class="comment">//æ·»åŠ è¡Œä¸º</span></span><br><span class="line">(lldb) breakpoint command add <span class="number">2</span></span><br><span class="line">Enter your debugger command(s).  Type 'DONE' to end.</span><br><span class="line">&gt; po i</span><br><span class="line">&gt; DONE</span><br><span class="line"><span class="comment">//æ˜¾ç¤ºåˆšæ‰çš„æ–­ç‚¹</span></span><br><span class="line">(lldb) breakpoint list <span class="number">2</span></span><br><span class="line">2: file = 'main.m', line = 31, exact_match = 0, locations = 1, resolved = 1, hit count = 0</span><br><span class="line">    Breakpoint commands:</span><br><span class="line">      po i</span><br><span class="line"></span><br><span class="line">Condition: i == <span class="number">80</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2.1</span>: where = asdasd`main + <span class="number">205</span> at main.m:<span class="number">31</span>, address = <span class="number">0x000000010ab2166d</span>, resolved, hit count = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œæ–­ç‚¹åè‡ªåŠ¨ç»§ç»­è¿è¡Œï¼Œå…è®¸ä½ å®Œå…¨é€šè¿‡æ–­ç‚¹æ¥ä¿®æ”¹ç¨‹åºï¼ä½ å¯ä»¥åœ¨æŸä¸€è¡Œåœæ­¢ï¼Œè¿è¡Œä¸€ä¸ª expression å‘½ä»¤æ¥æ”¹å˜å˜é‡ï¼Œç„¶åç»§ç»­è¿è¡Œã€‚</p>
<h2 id="æŸ¥çœ‹-çº¿ç¨‹-è°ƒç”¨æ ˆ-çŠ¶æ€"><a href="#æŸ¥çœ‹-çº¿ç¨‹-è°ƒç”¨æ ˆ-çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹ çº¿ç¨‹/è°ƒç”¨æ ˆ çŠ¶æ€"></a>æŸ¥çœ‹ çº¿ç¨‹/è°ƒç”¨æ ˆ çŠ¶æ€</h2><p>åœ¨è¿›ç¨‹åœæ­¢åï¼ŒLLDBä¼šé€‰æ‹©ä¸€ä¸ªå½“å‰çº¿ç¨‹å’Œçº¿ç¨‹ä¸­å½“å‰å¸§(frame)ã€‚å¾ˆå¤šæ£€æµ‹çŠ¶æ€çš„å‘½ä»¤å¯ä»¥ç”¨äºè¿™ä¸ªçº¿ç¨‹æˆ–å¸§ã€‚</p>
<p>ä¸ºäº†æ£€æµ‹è¿›ç¨‹çš„å½“å‰çŠ¶æ€ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‘½ä»¤<code>thread list</code>å¼€å§‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) thread list</span><br><span class="line">Process <span class="number">48541</span> stopped</span><br><span class="line">* thread <span class="meta">#1: tid = 0x3bd1d2, 0x000000010eae0b66 libsystem_kernel.dylib`__pthread_kill + 10, queue = 'com.apple.main-thread', stop reason = signal SIGABRT</span></span><br><span class="line">  thread <span class="meta">#2: tid = 0x3bd24c, 0x000000010eae128a libsystem_kernel.dylib`__workq_kernreturn + 10</span></span><br></pre></td></tr></table></figure>
<p>æ˜Ÿå·(*)è¡¨ç¤ºthread #1ä¸ºå½“å‰çº¿ç¨‹ã€‚ä¸ºäº†è·å–çº¿ç¨‹çš„è·Ÿè¸ªæ ˆï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤<code>thread backtrace</code>ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤ä¸ºå½“å‰çº¿ç¨‹ ä¹Ÿå¯ä»¥æŒ‡å®šçº¿ç¨‹ : thread backtrace 2</span></span><br><span class="line">(lldb) thread backtrace</span><br><span class="line">thread <span class="meta">#1: tid = 0x2c03, stop reason = breakpoint 1.1, queue = com.apple.main-thread</span></span><br><span class="line"> frame <span class="meta">#0: 0x0000000100010d5b, where = Sketch`-[SKTGraphicView alignLeftEdges:] + 33 at /Projects/Sketch/SKTGraphicView.m:1405</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹çš„è°ƒç”¨æ ˆï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š<code>(lldb) thread backtrace all</code></p>
<p>æ£€æŸ¥å¸§å‚æ•°å’Œæœ¬åœ°å˜é‡çš„æœ€ç®€ä¾¿çš„æ–¹å¼æ˜¯ä½¿ç”¨<code>frame variable</code>å‘½ä»¤ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">int</span>) argc = <span class="number">1</span></span><br><span class="line">(<span class="keyword">char</span> **) argv = <span class="number">0x00007ffee4150ff0</span></span><br><span class="line">(<span class="built_in">NSUInteger</span>) num = <span class="number">123</span></span><br><span class="line">(__NSCFConstantString *) str = <span class="number">0x000000010bab00d8</span> <span class="string">@"learning LLDB"</span></span><br><span class="line">(__NSArrayI *) arr = <span class="number">0x0000600002982fa0</span> <span class="string">@"2 elements"</span></span><br><span class="line">(<span class="keyword">int</span>) i = <span class="number">80</span></span><br><span class="line">(<span class="built_in">BOOL</span>) result0 = <span class="literal">YES</span></span><br><span class="line">(<span class="built_in">BOOL</span>) result1 = <span class="literal">NO</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ²¡æœ‰æŒ‡å®šä»»ä½•å˜é‡åï¼Œåˆ™ä¼šæ˜¾ç¤ºæ‰€æœ‰å‚æ•°å’Œæœ¬åœ°å˜é‡ã€‚å¦‚æœæŒ‡å®šå‚æ•°åæˆ–å˜é‡åï¼Œåˆ™åªæ‰“å°æŒ‡å®šçš„å€¼ã€‚å¦‚ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) frame variable <span class="keyword">self</span></span><br><span class="line">(<span class="built_in">SKTGraphicView</span> *) <span class="keyword">self</span> = <span class="number">0x0000000100208b40</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæƒ³æŸ¥çœ‹å¦å¤–ä¸€å¸§ï¼Œå¯ä»¥ä½¿ç”¨<code>frame select</code>å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) frame select <span class="number">2</span></span><br><span class="line">frame <span class="meta">#2: 0x000000010e88dc45 libsystem_c.dylib`abort + 127</span></span><br></pre></td></tr></table></figure>
<h2 id="image"><a href="#image" class="headerlink" title="image"></a>image</h2><p>imageæŒ‡ä»¤æ˜¯target moduleæŒ‡ä»¤çš„ç¼©å†™ï¼Œå€ŸåŠ©å®ƒæˆ‘ä»¬èƒ½å¤ŸæŸ¥çœ‹å½“å‰çš„Binary Imagesç›¸å…³çš„ä¿¡æ¯ã€‚æ—¥å¸¸å¼€å‘æˆ‘ä»¬ä¸»è¦åˆ©ç”¨å®ƒå¯»å€ã€‚<code>image</code>å‘½ä»¤çš„ç”¨æ³•ä¹ŸæŒºå¤šï¼Œé¦–å…ˆå¯ä»¥ç”¨å®ƒæ¥æŸ¥çœ‹å·¥ç¨‹ä¸­ä½¿ç”¨çš„åº“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) image list</span><br><span class="line">[  <span class="number">0</span>] <span class="number">9E11</span>F0C7<span class="number">-9</span>AB1<span class="number">-36</span>A8<span class="number">-8</span>FE4<span class="number">-8821</span>DBA05A2F <span class="number">0x000000010baad000</span> /Users/suntongsheng/Library/Developer/Xcode/DerivedData/asdasd-dufvhftdhjomdkcnrilgxlwykarv/Build/Products/Debug-iphonesimulator/asdasd.app/asdasd </span><br><span class="line">[  <span class="number">1</span>] <span class="number">8</span>A72DE9C-A136<span class="number">-3506</span>-AA02<span class="number">-4</span>BA2B82DCAF3 <span class="number">0x0000000115aa8000</span> /usr/lib/dyld</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“çš„åŸå§‹åœ°å€ï¼Œè¿™ä¸€ç‚¹è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå½“æˆ‘ä»¬çš„ç¨‹åºå´©æºƒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™æ¡å‘½ä»¤æ¥æŸ¥æ‰¾å´©æºƒæ‰€åœ¨çš„å…·ä½“ä½ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *array = @[@<span class="number">1</span>, @<span class="number">2</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"array 3: %@"</span>, array[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">//è¿™æ®µä»£ç ä¼šæŠ›å‡º</span></span><br><span class="line">2019-03-19 16:10:32.841204+0800 asdasd[49351:4010863] *** Terminating app due to uncaught exception 'NSRangeException', reason: '*** -[__NSArrayI objectAtIndexedSubscript:]: index 2 beyond bounds [0 .. 1]'</span><br><span class="line">*** First throw call stack:</span><br><span class="line">(</span><br><span class="line">	<span class="number">0</span>   CoreFoundation                      <span class="number">0x0000000102c7f1bb</span> __exceptionPreprocess + <span class="number">331</span></span><br><span class="line">	<span class="number">1</span>   libobjc.A.dylib                     <span class="number">0x000000010221d735</span> objc_exception_throw + <span class="number">48</span></span><br><span class="line">	<span class="number">2</span>   CoreFoundation                      <span class="number">0x0000000102bcb4ec</span> _CFThrowFormattedException + <span class="number">194</span></span><br><span class="line">	<span class="number">3</span>   CoreFoundation                      <span class="number">0x0000000102d01b00</span> +[__NSArrayI allocWithZone:] + <span class="number">0</span></span><br><span class="line">	<span class="number">4</span>   asdasd                              <span class="number">0x00000001019004ff</span> -[ViewController viewDidLoad] + <span class="number">287</span></span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å´©æºƒä½ç½®æ˜¯åœ¨ViewControllerä¸­ï¼Œè¦æƒ³çŸ¥é“å…·ä½“åœ¨å“ªä¸€è¡Œï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤<code>image lookup --address</code>ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">(lldb) image lookup --address <span class="number">0x00000001019004ff</span></span><br><span class="line">      Address: asdasd[<span class="number">0x00000001000014ff</span>] (asdasd.__TEXT.__text + <span class="number">287</span>)</span><br><span class="line">      Summary: asdasd`-[ViewController viewDidLoad] + <span class="number">287</span> at ViewController.m:<span class="number">23</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åå®šä½åˆ°äº†ViewController.m:23è¡Œï¼Œæ­£æ˜¯æˆ‘ä»¬ä»£ç æ‰€åœ¨çš„ä½ç½®ã€‚</p>
<p>imageæ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒï¼š <a href="https://developer.apple.com/library/archive/documentation/IDEs/Conceptual/gdb_to_lldb_transition_guide/document/lldb-command-examples.html#//apple_ref/doc/uid/TP40012917-CH3-SW5" target="_blank" rel="noopener">Executable and Shared Library Query Commandsã€‚</a></p>
<!-- http://southpeak.github.io/2015/01/25/tool-lldb/ -->
<!-- https://juejin.im/post/5b1cd870e51d4506dc0ac76c -->
<!-- https://www.jianshu.com/p/67f08a4d8cf2 -->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>LLDB</tag>
      </tags>
  </entry>
  <entry>
    <title>fishhookæºç å­¦ä¹ </title>
    <url>/essay/LLDB/fishhook_code_analyze/</url>
    <content><![CDATA[<p>ä¸Šä¸€ç¯‡ <a href="/essay/LLDB/Mach-O_fishhook/">Mach-Oåº”ç”¨ fishhookåŠ¨æ€ä¿®æ”¹Cå‡½æ•°</a> äº†è§£äº†fishhookçš„åŸç†ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹å®ƒçš„ä»£ç ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ›¿æ¢åŸæœ‰å‡½æ•°å®ç°çš„ã€‚</p>
<a id="more"></a>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹rebind_symbolsè¿™ä¸ªå¯¹å¤–çš„æ¥å£ï¼Œå…¶ä¸­åº”ç”¨åˆ°çš„Cå‡½æ•°ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>_dyld_image_count(void)</code> å½“å‰dyldè£…è½½çš„imageæ•°é‡</li>
<li><code>_dyld_get_image_header(unit32_t image_index)</code> è¿”å›imageå¯¹åº”çš„Mach Headeråœ°å€</li>
<li><code>_dyld_get_image_vmaddr_slide(unit32_t image_index)</code> è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€åç§»é‡</li>
</ul>
<p>å¯¹å®ç°çš„åˆ†æä¼š rebind_symbols å‡½æ•°ä¸ºå…¥å£ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹å‡½æ•°çš„è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br><span class="line">â””â”€â”€ <span class="keyword">extern</span> <span class="keyword">void</span> _dyld_register_func_for_add_image(<span class="keyword">void</span> (*func)(<span class="keyword">const</span> struct mach_header* mh, <span class="keyword">intptr_t</span> vmaddr_slide));</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span><br><span class="line">â””â”€â”€ <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span></span></span><br><span class="line">	â””â”€â”€ static void perform_rebinding_with_section(struct rebindings_entry *rebindings, section_t *section, intptr_t slide, nlist_t *symtab, char *strtab, uint32_t *indirect_symtab)</span><br></pre></td></tr></table></figure>
<p>å…¶å®å‡½æ•°è°ƒç”¨æ ˆéå¸¸ç®€å•ï¼Œå› ä¸ºæ•´ä¸ªåº“ä¸­ä¹Ÿæ²¡æœ‰å‡ ä¸ªå‡½æ•°ï¼Œrebind_symbols ä½œä¸ºæ¥å£ï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯æ³¨å†Œä¸€ä¸ªå‡½æ•°å¹¶åœ¨é•œåƒåŠ è½½æ—¶å›è°ƒï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> retval = prepend_rebindings(&amp;_rebindings_head, rebindings, rebindings_nel);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) <span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!_rebindings_head-&gt;next) &#123;</span><br><span class="line">		_dyld_register_func_for_add_image(_rebind_symbols_for_image);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> c = _dyld_image_count();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; c; i++) &#123;</span><br><span class="line">			_rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ rebind_symbols æœ€å¼€å§‹æ‰§è¡Œæ—¶ï¼Œä¼šå…ˆè°ƒç”¨ä¸€ä¸ª prepend_rebindings çš„å‡½æ•°ï¼Œå°†æ•´ä¸ª rebindings æ•°ç»„æ·»åŠ åˆ° _rebindings_head è¿™ä¸ªç§æœ‰æ•°æ®ç»“æ„çš„å¤´éƒ¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">prepend_rebindings</span><span class="params">(struct rebindings_entry **rebindings_head,</span></span></span><br><span class="line"><span class="function"><span class="params">							  struct rebinding rebindings[],</span></span></span><br><span class="line"><span class="function"><span class="params">							  <span class="keyword">size_t</span> nel)</span> </span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">new_entry</span> = <span class="title">malloc</span>(<span class="title">sizeof</span>(<span class="title">struct</span> <span class="title">rebindings_entry</span>));</span></span><br><span class="line">	<span class="keyword">if</span> (!new_entry) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	new_entry-&gt;rebindings = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct rebinding) * nel);</span><br><span class="line">	<span class="keyword">if</span> (!new_entry-&gt;rebindings) &#123;</span><br><span class="line">		<span class="built_in">free</span>(new_entry);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">memcpy</span>(new_entry-&gt;rebindings, rebindings, <span class="keyword">sizeof</span>(struct rebinding) * nel);</span><br><span class="line">	new_entry-&gt;rebindings_nel = nel;</span><br><span class="line">	new_entry-&gt;next = *rebindings_head;</span><br><span class="line">	*rebindings_head = new_entry;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨çš„ rebind_symbols æ–¹æ³•ä¼ å…¥çš„ rebindings æ•°ç»„ä»¥åŠæ•°ç»„çš„é•¿åº¦éƒ½ä¼šä»¥ rebindings_entry çš„å½¢å¼æ·»åŠ åˆ° _rebindings_head è¿™ä¸ªç§æœ‰é“¾è¡¨çš„é¦–éƒ¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> *<span class="title">rebindings</span>;</span></span><br><span class="line">	<span class="keyword">size_t</span> rebindings_nel;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *_<span class="title">rebindings_head</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å¯ä»¥é€šè¿‡åˆ¤æ–­ _rebindings_head-&gt;next çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œç„¶åä½¿ç”¨ _dyld_register_func_for_add_image å°† _rebind_symbols_for_image æ³¨å†Œä¸ºå›è°ƒæˆ–è€…ä¸ºæ‰€æœ‰å­˜åœ¨çš„é•œåƒå•ç‹¬è°ƒç”¨ _rebind_symbols_for_imageï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _rebind_symbols_for_image(<span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide) &#123;</span><br><span class="line">	rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_rebind_symbols_for_image åªæ˜¯å¯¹å¦ä¸€ä¸ªåå­—éå¸¸ç›¸ä¼¼çš„å‡½æ•° rebind_symbols_for_image çš„å°è£…ï¼Œä»è¿™ä¸ªå‡½æ•°å¼€å§‹ï¼Œå°±åˆ°äº†é‡ç»‘å®šç¬¦å·çš„è¿‡ç¨‹ï¼›ä¸è¿‡ç”±äºè¿™ä¸ªæ–¹æ³•çš„å®ç°æ¯”è¾ƒé•¿ï¼Œå…·ä½“åˆ†æä¼šåˆ†æˆä¸‰ä¸ªéƒ¨åˆ†å¹¶çœç•¥ä¸€äº›ä¸å½±å“ç†è§£çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings,</span></span></span><br><span class="line"><span class="function"><span class="params">									 <span class="keyword">const</span> struct mach_header *header,</span></span></span><br><span class="line"><span class="function"><span class="params">									 <span class="keyword">intptr_t</span> slide)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">segment_command_t</span> *cur_seg_cmd;</span><br><span class="line">	<span class="keyword">segment_command_t</span> *linkedit_segment = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span>* <span class="title">symtab_cmd</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span>* <span class="title">dysymtab_cmd</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span> cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>);</span><br><span class="line">	<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">		cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line">		<span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">				linkedit_segment = cur_seg_cmd;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">			symtab_cmd = (struct symtab_command*)cur_seg_cmd;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">			dysymtab_cmd = (struct dysymtab_command*)cur_seg_cmd;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™éƒ¨åˆ†çš„ä»£ç ä¸»è¦åŠŸèƒ½æ˜¯ä»é•œåƒä¸­æŸ¥æ‰¾ linkedit_segment symtab_command å’Œ dysymtab_commandï¼›åœ¨å¼€å§‹æŸ¥æ‰¾ä¹‹å‰ï¼Œè¦å…ˆè·³è¿‡ mach_header_t é•¿åº¦çš„ä½ç½®ï¼Œç„¶åå°†å½“å‰æŒ‡é’ˆå¼ºè½¬æˆ segment_command_tï¼Œé€šè¿‡å¯¹æ¯” cmd çš„å€¼ï¼Œæ¥æ‰¾åˆ°éœ€è¦çš„ segment_command_tã€‚</p>
<p>åœ¨æŸ¥æ‰¾äº†å‡ ä¸ªå…³é”®çš„ segment ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å‡ ä¸ª segment è·å–å¯¹åº”è¡¨çš„å†…å­˜åœ°å€ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rebind_symbols_for_image</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">const</span> struct mach_header *header, <span class="keyword">intptr_t</span> slide)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span> linkedit_base = (<span class="keyword">uintptr_t</span>)slide + linkedit_segment-&gt;vmaddr - linkedit_segment-&gt;fileoff;</span><br><span class="line">	<span class="keyword">nlist_t</span> *symtab = (<span class="keyword">nlist_t</span> *)(linkedit_base + symtab_cmd-&gt;symoff);</span><br><span class="line">	<span class="keyword">char</span> *strtab = (<span class="keyword">char</span> *)(linkedit_base + symtab_cmd-&gt;stroff);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint32_t</span> *indirect_symtab = (<span class="keyword">uint32_t</span> *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ linkedit_segment ç»“æ„ä½“ä¸­è·å¾—å…¶è™šæ‹Ÿåœ°å€ä»¥åŠæ–‡ä»¶åç§»é‡ï¼Œç„¶åé€šè¿‡ä¸€ä¸‹å…¬å¼æ¥è®¡ç®—å½“å‰ __LINKEDIT æ®µçš„ä½ç½®ï¼š</p>
<p><code>slide + vmaffr - fileoff</code></p>
<p>ç±»ä¼¼åœ°ï¼Œåœ¨ symtab_command ä¸­è·å–ç¬¦å·è¡¨åç§»é‡å’Œå­—ç¬¦ä¸²è¡¨åç§»é‡ï¼Œä» dysymtab_command ä¸­è·å–é—´æ¥ç¬¦å·è¡¨ï¼ˆindirect symbol tableï¼‰åç§»é‡ï¼Œå°±èƒ½å¤Ÿè·å¾—<em>ç¬¦å·è¡¨</em>ã€<em>å­—ç¬¦ä¸²è¡¨</em>ä»¥åŠ<em>é—´æ¥ç¬¦å·è¡¨</em>çš„å¼•ç”¨äº†ã€‚</p>
<ul>
<li>é—´æ¥ç¬¦å·è¡¨ä¸­çš„å…ƒç´ éƒ½æ˜¯ uint32_t *ï¼ŒæŒ‡é’ˆçš„å€¼æ˜¯å¯¹åº”æ¡ç›® n_list åœ¨ç¬¦å·è¡¨ä¸­çš„ä½ç½®</li>
<li><p>ç¬¦å·è¡¨ä¸­çš„å…ƒç´ éƒ½æ˜¯ nlist_t ç»“æ„ä½“ï¼Œå…¶ä¸­åŒ…å«äº†å½“å‰ç¬¦å·åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„ä¸‹æ ‡</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">nlist_64</span> &#123;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">    	<span class="keyword">uint32_t</span>  n_strx; <span class="comment">/* index into the string table */</span></span><br><span class="line">	&#125; n_un;</span><br><span class="line">	<span class="keyword">uint8_t</span> n_type;        <span class="comment">/* type flag, see below */</span></span><br><span class="line">	<span class="keyword">uint8_t</span> n_sect;        <span class="comment">/* section number or NO_SECT */</span></span><br><span class="line">	<span class="keyword">uint16_t</span> n_desc;       <span class="comment">/* see &lt;mach-o/stab.h&gt; */</span></span><br><span class="line">	<span class="keyword">uint64_t</span> n_value;      <span class="comment">/* value of this symbol (or stab offset) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å­—ç¬¦ä¸²è¡¨ä¸­çš„å…ƒç´ æ˜¯ char å­—ç¬¦</p>
</li>
</ul>
<p>è¯¥å‡½æ•°çš„æœ€åä¸€éƒ¨åˆ†å°±å¼€å¯äº†éå†æ¨¡å¼ï¼ŒæŸ¥æ‰¾æ•´ä¸ªé•œåƒä¸­çš„ SECTION_TYPE ä¸º S_LAZY_SYMBOL_POINTERS æˆ–è€… S_NON_LAZY_SYMBOL_POINTERS çš„ sectionï¼Œç„¶åè°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•° perform_rebinding_with_section æ¥å¯¹ section ä¸­çš„ç¬¦å·è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">perform_rebinding_with_section</span><span class="params">(struct rebindings_entry *rebindings, <span class="keyword">section_t</span> *section, <span class="keyword">intptr_t</span> slide, <span class="keyword">nlist_t</span> *symtab, <span class="keyword">char</span> *strtab, <span class="keyword">uint32_t</span> *indirect_symtab)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">	<span class="keyword">void</span> **indirect_symbol_bindings = (<span class="keyword">void</span> **)((<span class="keyword">uintptr_t</span>)slide + section-&gt;addr);</span><br><span class="line">	<span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *); i++) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line">		<span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">		<span class="keyword">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line"></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">cur</span> = <span class="title">rebindings</span>;</span></span><br><span class="line">		<span class="keyword">while</span> (cur) &#123;</span><br><span class="line">			<span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">						indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">						*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">					&#125;</span><br><span class="line">					indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">					<span class="keyword">goto</span> symbol_loop;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cur = cur-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">	symbol_loop:;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°çš„å®ç°çš„æ ¸å¿ƒå†…å®¹å°±æ˜¯å°†ç¬¦å·è¡¨ä¸­çš„ symbol_name ä¸ rebinding ä¸­çš„åå­— name è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‡ºç°äº†åŒ¹é…ï¼Œå°±ä¼šå°†åŸå‡½æ•°çš„å®ç°ä¼ å…¥ origian_open å‡½æ•°æŒ‡é’ˆçš„åœ°å€ï¼Œå¹¶ä½¿ç”¨æ–°çš„å‡½æ•°å®ç° new_open ä»£æ›¿åŸå®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">	indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">	*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i]; <span class="comment">// å°†åŸå‡½æ•°çš„å®ç°ä¼ å…¥ original_open å‡½æ•°æŒ‡é’ˆçš„åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement; // ä½¿ç”¨æ–°çš„å‡½æ•°å®ç° new_open æ›¿æ¢åŸå®ç°<br>å¦‚æœä½ ç†è§£äº†ä¸Šé¢çš„å®ç°ä»£ç ï¼Œè¯¥å‡½æ•°çš„å…¶å®ƒä»£ç å°±å¾ˆå¥½ç†è§£äº†ï¼š</p>
<ol>
<li>é€šè¿‡ indirect_symtab + section-&gt;reserved1 è·å– indirect_symbol_indices *ï¼Œä¹Ÿå°±æ˜¯ç¬¦å·è¡¨çš„æ•°ç»„</li>
<li>é€šè¿‡ (void **)((uintptr_t)slide + section-&gt;addr) è·å–å‡½æ•°æŒ‡é’ˆåˆ—è¡¨ indirect_symbol_bindings</li>
<li>éå†ç¬¦å·è¡¨æ•°ç»„ indirect_symbol_indices * ä¸­çš„æ‰€æœ‰ç¬¦å·è¡¨ä¸­ï¼Œè·å–å…¶ä¸­çš„ç¬¦å·è¡¨ç´¢å¼• symtab_index</li>
<li>é€šè¿‡ç¬¦å·è¡¨ç´¢å¼• symtab_index è·å–ç¬¦å·è¡¨ä¸­æŸä¸€ä¸ª n_list ç»“æ„ä½“ï¼Œå¾—åˆ°å­—ç¬¦ä¸²è¡¨ä¸­çš„ç´¢å¼• symtab[symtab_index].n_un.n_strx</li>
<li>æœ€ååœ¨å­—ç¬¦ä¸²è¡¨ä¸­è·å¾—ç¬¦å·çš„åå­— char *symbol_name</li>
</ol>
<p>åˆ°è¿™é‡Œæ¯”è¾ƒå‰çš„å‡†å¤‡å·¥ä½œå°±å®Œæˆäº†ï¼Œå‰©ä¸‹çš„ä»£ç ä¼šéå†æ•´ä¸ª rebindings_entry æ•°ç»„ï¼Œåœ¨å…¶ä¸­æŸ¥æ‰¾åŒ¹é…çš„ç¬¦å·ï¼Œå®Œæˆå‡½æ•°å®ç°çš„æ›¿æ¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (cur) &#123;</span><br><span class="line">	<span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">				indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">				*(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">			&#125;</span><br><span class="line">			indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">			<span class="keyword">goto</span> symbol_loop;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	cur = cur-&gt;next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¹‹åå¯¹æŸä¸€å‡½æ•°çš„è°ƒç”¨ï¼ˆä¾‹å¦‚ openï¼‰ï¼Œå½“æŸ¥æ‰¾å…¶å‡½æ•°å®ç°æ—¶ï¼Œéƒ½ä¼šæŸ¥æ‰¾åˆ° new_open çš„å‡½æ•°æŒ‡é’ˆï¼›åœ¨ new_open è°ƒç”¨ origianl_open æ—¶ï¼ŒåŒæ ·ä¹Ÿä¼šæ‰§è¡ŒåŸæœ‰çš„å‡½æ•°å®ç°ï¼Œå› ä¸ºæˆ‘ä»¬é€šè¿‡ *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i] å°†åŸå‡½æ•°å®ç°ç»‘å®šåˆ°äº†æ–°çš„å‡½æ•°æŒ‡é’ˆä¸Šã€‚</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>fishhook</tag>
      </tags>
  </entry>
  <entry>
    <title>Instrumentsä»‹ç»</title>
    <url>/essay/Instruments/Instruments1/</url>
    <content><![CDATA[<p><img src="/res/Instrument/instrument1.png" width="80%"></p>
<h2 id="Instruments-æ˜¯ä»€ä¹ˆ"><a href="#Instruments-æ˜¯ä»€ä¹ˆ" class="headerlink" title="Instruments æ˜¯ä»€ä¹ˆ"></a>Instruments æ˜¯ä»€ä¹ˆ</h2><p><a href="https://help.apple.com/instruments/mac/current/" target="_blank" rel="noopener">Instruments</a> æ˜¯ Xcode çš„ä¸€ä¸ªå·¥å…·é›†ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„ç¨‹åºæ€§èƒ½åˆ†æåŠæµ‹è¯•èƒ½åŠ›ã€‚ä½¿ç”¨ Instruments ä½ å¯ä»¥åšä¸‹é¢è¿™äº›äº‹ï¼š<br><a id="more"></a></p>
<ol>
<li>æ£€æŸ¥ä¸€ä¸ªæˆ–å¤šä¸ªåº”ç”¨æˆ–è¿›ç¨‹çš„è¡Œä¸ºã€‚</li>
<li>æ£€æŸ¥è®¾å¤‡ç›¸å…³çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šWi-Fiã€è“ç‰™ç­‰ã€‚</li>
<li>åœ¨çœŸæœºæˆ–æ¨¡æ‹Ÿå™¨ä¸Šè¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚</li>
<li>åˆ›å»ºè‡ªå®šä¹‰çš„ DTrace æ¥åˆ†æç³»ç»Ÿä»¥åŠåº”ç”¨çš„å„ç§è¡Œä¸ºã€‚</li>
<li>è·Ÿè¸ªæºç ä¸­çš„é—®é¢˜ã€‚</li>
<li>å¯¹ App è¿›è¡Œæ€§èƒ½åˆ†æã€‚</li>
<li>æŸ¥æ‰¾ App ä¸­çš„å†…å­˜é—®é¢˜ï¼Œæ¯”å¦‚ï¼šå†…å­˜æ³„éœ²(Leaked memory)ã€åºŸå¼ƒå†…å­˜(Abandoned memory)ã€åƒµå°¸(zombies)ç­‰ã€‚</li>
<li>ç»™å‡ºç¨‹åºä¼˜åŒ–çš„å»ºè®®ã€‚</li>
<li>è¿›è¡Œç³»ç»Ÿçº§åˆ«çš„é—®é¢˜å®šä½ã€‚</li>
<li>é€šè¿‡è„šæœ¬è®°å½•ä¸€ä¸ªç”¨æˆ·è¡Œä¸ºåºåˆ—ï¼Œä»è€Œå¯ä»¥é€šè¿‡è¿è¡Œè„šæœ¬å¯¹ä½ çš„ iOS åº”ç”¨è¿›è¡Œå¯é‡å¤å¤šæ¬¡çš„è‡ªåŠ¨åŒ–æµ‹è¯•ã€‚</li>
<li>ä¿å­˜æµ‹è¯•é…ç½®æ¨¡æ¿ä»¥ä¾›å¤ç”¨ã€‚</li>
</ol>
<h2 id="æˆ‘ä»¬çœ‹ä¸€ä¸‹å¼€å§‹æ¨¡æ¿ã€‚"><a href="#æˆ‘ä»¬çœ‹ä¸€ä¸‹å¼€å§‹æ¨¡æ¿ã€‚" class="headerlink" title="æˆ‘ä»¬çœ‹ä¸€ä¸‹å¼€å§‹æ¨¡æ¿ã€‚"></a>æˆ‘ä»¬çœ‹ä¸€ä¸‹å¼€å§‹æ¨¡æ¿ã€‚</h2><table>
<thead>
<tr>
<th>é¡¹ç›®           æ¨¡æ¿</th>
<th>è¯¦æƒ…</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.Blank</td>
<td>åˆ›å»ºä¸€ä¸ªç©ºçš„æ¨¡æ¿ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰çš„æ·»åŠ å„ç§å·¥å…·ã€‚</td>
</tr>
<tr>
<td>2.Activity Monitor</td>
<td>å¯ä»¥åªç”¨è¿™ä¸ªæ¨¡æ¿ï¼Œç ”ç©¶ç³»ç»Ÿå·¥ä½œè´Ÿè½½å’Œè™šæ‹Ÿå†…å­˜å¤§å°çš„å…³ç³»</td>
</tr>
<tr>
<td>3.Allocations</td>
<td>å°†Allocationså’ŒVMè·Ÿè¸ªå™¨åŠ åˆ°è·Ÿè¸ªæ–‡æ¡£ä¸­ï¼Œä½¿ç”¨è¯¥å·¥å…·å¯ä»¥ç›‘è§†å†…å­˜å’Œå¯¹è±¡çš„å†…å­˜åˆ†é…æ–¹å¼å’Œæƒ…å†µã€‚</td>
</tr>
<tr>
<td>4.CocoaLayout</td>
<td>æ˜¯ä¸€ç§Cocoaå¸ƒå±€å·¥å…· ï¼Œå¯ä»¥åº”ç”¨äºiOSæ¨¡æ‹Ÿå™¨å’ŒCocoaæ¡Œé¢åº”ç”¨ï¼Œä½†æ˜¯ä¸èƒ½å’Œè¿æ¥çš„iOSè®¾å¤‡ä¸€èµ·ä½¿ç”¨ã€‚è§‚å¯ŸNSLayoutConstraintå¯¹è±¡çš„æ”¹å˜ï¼Œå¸®åŠ©æˆ‘ä»¬åˆ¤æ–­ä»€ä¹ˆæ—¶é—´ä»€ä¹ˆåœ°ç‚¹çš„constraintæ˜¯å¦åˆç†</td>
</tr>
<tr>
<td>5.Core Animation</td>
<td>å°†CoreAnimationåŠ å…¥åˆ°è·Ÿè¸ªæ–‡æ¡£ä¸­ï¼Œå¯ä»¥æµ‹é‡iosè®¾å¤‡ä¸Šæ¯ç§’çš„CoreAnimationå¸§æ•°ï¼Œè¿™å¯ä»¥å¸®åŠ©ä½ ç†è§£å†…å®¹æ˜¯å¦‚ä½•æ¸²æŸ“åˆ°å±å¹•ä¸Šçš„ï¼Œï¼ˆå›¾å½¢æ€§èƒ½ï¼‰è¿™ä¸ªæ¨¡å—æ˜¾ç¤ºç¨‹åºæ˜¾å¡æ€§èƒ½ä»¥åŠCPUä½¿ç”¨æƒ…å†µã€‚</td>
</tr>
<tr>
<td>6.CoreData</td>
<td>å°†CoreDataæ•°æ®æå–ã€ç¼“å­˜ç¼ºå¤±å’Œå­˜å‚¨åŠ å…¥åˆ°è·Ÿè¸ªæ–‡æ¡£ä¸­ï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å¯ä»¥æ£€æµ‹åº”ç”¨ç¨‹åºä¸­æ•°æ®çš„å­˜å‚¨äº¤äº’ã€‚</td>
</tr>
<tr>
<td>7.Counters</td>
<td>æ”¶é›†ä½¿ç”¨æ—¶é—´æˆ–åŸºäºäº‹ä»¶çš„æŠ½æ ·æ–¹æ³•çš„æ€§èƒ½ç›‘æ§è®¡æ•°å™¨ï¼ˆPMCï¼‰äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>8.Energy Log</td>
<td>è€—ç”µé‡ç›‘æ§ï¼Œå°†Energy Diagnostics, CPU Activity, Display Brightness, Sleep/Wake, Bluetooth, WiFi, and GPS instrumentsåŠ å…¥åˆ°è·Ÿè¸ªæ–‡æ¡£ä¸­è¿›è¡Œæ£€æµ‹ã€‚</td>
</tr>
<tr>
<td>9.File Activity</td>
<td>å°†File Activity, Reads/Writes, File Attributes, and Directory I/O instruments åŠ å…¥åˆ°è·Ÿè¸ªæ–‡æ¡£ä¸­ï¼Œåªç”¨è¿™ä¸ªæ¨¡æ¿å¯ä»¥è®©ä½ æ£€æŸ¥ç³»ç»Ÿæ–‡ä»¶çš„ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥æ£€æŸ¥æ–‡ä»¶çš„æ‰“å¼€ã€å…³é—­ã€è¯»å’Œå†™æ“ä½œï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ£€æµ‹æ–‡ä»¶ç³»ç»Ÿæœ¬èº«çš„æ”¹å˜ï¼ŒåŒ…æ‹¬æƒé™å’Œæ‰€æœ‰æƒå‘ç”Ÿçš„æ”¹å˜ã€‚</td>
</tr>
<tr>
<td>10.Leaks</td>
<td>å°†the Allocations and Leaks instrumentsåŠ å…¥åˆ°æ¨¡æ¿ä¸­ï¼Œä½¿ç”¨è¿™ä¸ªæ¨¡æ¿å¯ä»¥å¸®åŠ©ä½ æ£€æµ‹å†…å­˜çš„æ³„æ¼ã€‚</td>
</tr>
<tr>
<td>11.Metal System Trace</td>
<td>å®ƒæ˜¯æ˜¯apple 2014å¹´åœ¨ioså¹³å°ä¸Šæ¨å‡ºçš„é«˜æ•ˆåº•å±‚çš„3Då›¾å½¢APIï¼Œå®ƒé€šè¿‡å‡å°‘é©±åŠ¨å±‚çš„APIè°ƒç”¨CPUçš„æ¶ˆè€—æé«˜æ¸²æŸ“æ•ˆç‡ã€‚</td>
</tr>
<tr>
<td>12.Network</td>
<td>ç”¨é“¾æ¥å·¥å…·åˆ†æä½ çš„ç¨‹åºå¦‚ä½•ä½¿ç”¨TCP/IPå’ŒUDP/IPé“¾æ¥ã€‚</td>
</tr>
<tr>
<td>13.OpenGL ES Analysis</td>
<td>å°†OpenGL ES Analyzer and OpenGL ES DriveråŠ å…¥åˆ°æ¨¡æ¿ä¸­ï¼Œè¿™ä¸ªæ¨¡å—æµ‹é‡åˆ†æOpenGL ESæ´»åŠ¨æ­£ç¡®æ€§æ£€æµ‹ä»¥åŠè¡¨ç°é—®é¢˜ï¼Œæä¾›è§£å†³å»ºè®®ã€‚</td>
</tr>
<tr>
<td>14.System Trace</td>
<td>ç³»ç»Ÿè·Ÿè¸ªï¼Œé€šè¿‡æ˜¾ç¤ºå½“å‰è¢«è°ƒåº¦çº¿ç¨‹æä¾›ç»¼åˆçš„ç³»ç»Ÿè¡¨ç°ï¼Œæ˜¾ç¤ºä»ç”¨æˆ·åˆ°ç³»ç»Ÿçš„è½¬æ¢ä»£ç é€šè¿‡ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æˆ–å†…å­˜æ“ä½œã€‚</td>
</tr>
<tr>
<td>15.System Usage</td>
<td>è¿™ä¸ªæ¨¡æ¿è®°å½•å…³äºæ–‡ä»¶è¯»å†™ï¼Œsocketsï¼ŒI/Oç³»ç»Ÿæ´»åŠ¨ï¼Œ è¾“å…¥è¾“å‡ºã€‚</td>
</tr>
<tr>
<td>16.Time Profile</td>
<td>æ‰§è¡Œå¯¹ç³»ç»Ÿçš„CPUä¸Šè¿è¡Œçš„è¿›ç¨‹ä½è´Ÿè½½æ—¶é—´ä¸ºåŸºç¡€é‡‡æ ·ã€‚</td>
</tr>
<tr>
<td>17. Zombies</td>
<td>æµ‹é‡ä¸€èˆ¬çš„å†…å­˜ä½¿ç”¨ï¼Œä¸“æ³¨äºæ£€æµ‹è¿‡åº¦é‡Šæ”¾çš„é‡æŒ‡é’ˆå¯¹è±¡ï¼Œä¹Ÿæä¾›å¯¹è±¡åˆ†é…ç»Ÿè®¡ï¼Œä»¥åŠä¸»åŠ¨åˆ†é…çš„å†…å­˜åœ°å€å†å²ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="ä¸‹é¢çœ‹ä¸€ä¸‹è¿™äº›å·¥å…·æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚"><a href="#ä¸‹é¢çœ‹ä¸€ä¸‹è¿™äº›å·¥å…·æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚" class="headerlink" title="ä¸‹é¢çœ‹ä¸€ä¸‹è¿™äº›å·¥å…·æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚"></a>ä¸‹é¢çœ‹ä¸€ä¸‹è¿™äº›å·¥å…·æ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚</h2><p><strong><em>å®šä½å†…å­˜é—®é¢˜</em></strong></p>
<ul>
<li>å†…å­˜ä¸åˆç†å¼•ç”¨ï¼Œæ£€æµ‹é‡å¤æ“ä½œå†…å­˜æ˜¯å¦æŒç»­å¢é•¿ Allocationsæ¯æ¬¡æ“ä½œåï¼Œç‚¹å‡»mark generations buttonï¼Œä¼šè®¾ç½®ä¸€ä¸ªflagï¼Œç„¶åæŸ¥çœ‹æ¯ä¸ªè¿­ä»£çš„è¯¦ç»†æ•°æ®ã€‚</li>
<li>å†…å­˜æ³„æ¼Leaksï¼Œå†…å­˜æ³„æ¼ä½¿ç”¨Leaksæ£€æµ‹ï¼Œå¦‚æœå¯¹è±¡å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œdetail panel ä¸­ä¼šçœ‹åˆ°å¯¹è±¡çš„retain releaseå†å²è®°å½•ï¼Œå¦‚æœéå¯¹è±¡å‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œå°±ä¼šçœ‹åˆ°mallocå’Œfreeçš„è°ƒç”¨å†å²ã€‚</li>
<li>é‡æŒ‡é’ˆZombiesï¼ŒZombieé—®é¢˜ï¼Œå¼•ç”¨retaincountä¸º0çš„å¯¹è±¡ï¼Œä½¿ç”¨Debugæ¨¡å¼ï¼Œå°†ç¯å¢ƒå˜é‡NSZombieEnabledè®¾ä¸ºtrueã€‚</li>
</ul>
<p><strong><em>æ£€æµ‹I/Oæ´»åŠ¨</em></strong></p>
<p>æ£€æµ‹iOS appå¦‚ä½•ä½¿ç”¨TCP/IPå’ŒUDP/IPï¼Œä¸connections Instrumentsä¸€èµ·ä½¿ç”¨ï¼Œæ£€æµ‹appå‘é€å’Œæ¥æ”¶çš„åŒ…æ•°ç›®ã€‚</p>
<p><strong><em>å›¾åƒæ€§èƒ½æ£€æµ‹</em></strong></p>
<ul>
<li>core animation graphics ç”¨æ¥æ£€æµ‹å¸§é¢‘ç‡</li>
<li>OpenGL activity</li>
<li>GPU Driver</li>
</ul>
<p><strong><em>CPUä½¿ç”¨</em></strong></p>
<ul>
<li>Performance Monitor Countersã€‚</li>
<li>ç”µé‡ï¼šEnergry è·Ÿè¸ªç”µé‡ã€CPUã€ç½‘ç»œã€æ˜¾ç¤ºäº®åº¦ã€ç¡çœ /å”¤é†’ã€è“ç‰™ã€wifiã€GPSã€‚å¯ä»¥å…¨å¤©å¼€å¯Energry Diagnostics Logæ¨¡å¼ï¼Œåœ¨å¼€å‘æ‰‹æœºè®¾å¤‡ä¸­ï¼Œï¼ˆé‡å¯æˆ–å…³æœºä¼šä¸¢å¤±è¯¥æ•°æ®ï¼‰ï¼Œæ•°æ®æ”¶é›†ç»“æŸåï¼Œå°†logæ•°æ®ä¼ åˆ°PCä¸Šã€‚</li>
<li>çº¿ç¨‹ä½¿ç”¨Multicore Trace Templateï¼Œåˆ†æå¤šæ ¸æ€§èƒ½ï¼Œçº¿ç¨‹çŠ¶æ€ã€è°ƒåº¦é˜Ÿåˆ—ã€å—ä½¿ç”¨æƒ…å†µã€‚Multicore Trace TemplateåŒ…å«Thread stateså’Œdispatch Instrumentsã€‚</li>
<li>Timer Profiler Trace Templateæ£€æµ‹å†…æ ¸ä½¿ç”¨æƒ…å†µã€‚</li>
</ul>
<p><strong><em>è‡ªåŠ¨åŒ–æµ‹è¯•</em></strong></p>
<p>UI automation Automation instrument å·¥å…·å…è®¸ä½ è®© iOS åº”ç”¨çš„ç”¨æˆ·ç•Œé¢æµ‹è¯•è‡ªåŠ¨åŒ–ã€‚è‡ªåŠ¨åŒ–ç•Œé¢æµ‹è¯•å¯ä»¥è®©ä½ ï¼š</p>
<ul>
<li>çœå»å…³é”®äººå‘˜å’Œé‡Šæ”¾å…¶ä»–å·¥ä½œèµ„æº</li>
<li>æ‰§è¡Œæ›´å¤šç»¼åˆæµ‹è¯•</li>
<li>å¼€å‘å¯é‡å¤çš„å›å½’æµ‹è¯•</li>
<li>å‡å°‘ç¨‹åºé”™è¯¯</li>
<li>æé«˜å¼€å‘å‘¨æœŸï¼Œäº§å“æ›´æ–°</li>
</ul>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Instruments</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Instrumentsä½¿ç”¨</title>
    <url>/essay/Instruments/Instruments2/</url>
    <content><![CDATA[<p>ä»‹ç»ä¸€ä¸‹ä½¿ç”¨<code>æŸ¥çœ‹ CPU æ€§èƒ½</code> ã€<code>å›¾å½¢æ€§èƒ½</code>å’Œ<code>å†…å­˜æ€§èƒ½</code>,è¦æ‰§è¡ŒInstrumentséœ€è¦å…ˆåœ¨Xcode ä¸­å¯¹å½“å‰çš„é¡¹ç›®åš Profile (Command-I ï¼š</p>
<p><img src="/res/Instrument/2.png" width="80%"><br><a id="more"></a><br>è¿™æ—¶å°±ä¼šæ‰“å¼€ Profiling Template é€‰é¡¹å¯¹è¯æ¡†ï¼š<br><img src="/res/Instrument/3.png" width="80%"></p>
<h2 id="æŸ¥çœ‹-CPU-æ€§èƒ½"><a href="#æŸ¥çœ‹-CPU-æ€§èƒ½" class="headerlink" title="æŸ¥çœ‹ CPU æ€§èƒ½"></a>æŸ¥çœ‹ CPU æ€§èƒ½</h2><p><strong>1ã€</strong> é€‰æ‹© Time Profiler è¿™ä¸ªæ¨¡æ¿ï¼Œå¹¶ç‚¹å‡» Choose æŒ‰é’®ã€‚<br><img src="/res/Instrument/4.png" width="20%"></p>
<p><strong>2ã€</strong> è¿›å…¥ Instruments åï¼Œé€‰æ‹©æ­£ç¡®çš„è®¾å¤‡å’Œåº”ç”¨ç¨‹åºï¼š<br><img src="/res/Instrument/5.png" width="80%"></p>
<p><strong>3ã€</strong>ç‚¹å‡»çº¢è‰²æŒ‰é’®è¿è¡Œåï¼Œå°±èƒ½å¾—åˆ° CPU æ€§èƒ½çš„ç»“æœäº†ï¼š<br><img src="/res/Instrument/6.png" width="80%"></p>
<p><strong>4ã€</strong>æˆ‘ä»¬è¿˜èƒ½åœ¨æ—¶é—´è½´é¢æ¿é‡Œé¢å»é€‰æ‹©ä¸€æ®µæ—¶é—´æ¥æŸ¥çœ‹è¯¥æ—¶é—´æ®µé‡Œæ›´ä¸ºç»†èŠ‚çš„ CPU æ€§èƒ½<br><img src="/res/Instrument/7.png" width="80%"></p>
<p>ä»è¿™ä¸ªç»“æœä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸åŒçš„çº¿ç¨‹ä»¥åŠæ–¹æ³•è°ƒç”¨å ç”¨çš„æ—¶é—´ï¼Œä»è€Œå¯ä»¥è¯„ä¼°å‡º CPU æ€§èƒ½çš„ç“¶é¢ˆå’Œä¼˜åŒ–æ–¹å‘ã€‚</p>
<p><strong>5ã€</strong>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜èƒ½åœ¨ Instruments é€‰æ‹©ä½¿ç”¨ Countersã€Activity Monitorã€System Trace ç­‰ Profiling Template å¯¹ç¨‹åºåš CPU æ€§èƒ½è€ƒé‡ã€‚</p>
<p><strong>6ã€</strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰æ—¶å€™å¦‚æœä½ ä½¿ç”¨ Instruments æŸ¥çœ‹è°ƒç”¨å †æ ˆæ—¶å¯èƒ½çœ‹åˆ°çš„éƒ½æ˜¯åœ°å€è€Œä¸æ˜¯å‡½æ•°åï¼Œè¿™æ ·å°±ä¸å¤ªå¥½å®šä½é—®é¢˜äº†ã€‚è¿™æ—¶å€™ä½ å¯ä»¥æŠŠç›¸å…³é¡¹ç›®çš„ Build Settings - Debug Information Format çš„ Debug å’Œ Release éƒ½è®¾ç½®ä¸º DWARF with dSYM Fileï¼Œè¿™æ ·å°±èƒ½å°†å¯¹åº”çš„å †æ ˆä¿¡æ¯ç¬¦å·åŒ–æ˜¾ç¤ºäº†ã€‚</p>
<h2 id="å›¾å½¢æ€§èƒ½"><a href="#å›¾å½¢æ€§èƒ½" class="headerlink" title="å›¾å½¢æ€§èƒ½"></a>å›¾å½¢æ€§èƒ½</h2><p>å…³äºå›¾å½¢æ€§èƒ½æ–¹é¢ï¼Œæˆ‘ä»¬å¹³æ—¶æœ€å…³æ³¨çš„åº”è¯¥å°±æ˜¯ã€Œå¸§ç‡ã€è¿™ä¸ªæ¦‚å¿µäº†ã€‚åœ¨ Instruments ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>Core Animation</code> + <code>Time Profiler</code> æ¥è¯„ä¼°å›¾å½¢æ€§èƒ½ã€‚ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<p><strong>1ã€</strong>åŒã€ŒCPU å ç”¨æ€§èƒ½æµ‹è¯•ã€ä¸€æ ·ï¼Œå…ˆåœ¨ Xcode ä¸­å¯¹å½“å‰çš„é¡¹ç›®æ‰§è¡Œ Profile (Command-I ï¼Œå¹¶åœ¨æ‰“å¼€çš„å¯¹è¯æ¡†ä¸­é€‰æ‹© Core Animaiton è¿™ä¸ªæ¨¡æ¿ï¼š<br><img src="/res/Instrument/8.png" width="20%"><br><strong>2ã€</strong>è¿›å…¥ Instruments åï¼Œé€‰æ‹©æ­£ç¡®çš„è®¾å¤‡å’Œåº”ç”¨ç¨‹åºã€‚</p>
<p><strong>3ã€</strong>ç‚¹å‡»çº¢è‰²æŒ‰é’®è¿è¡Œåº”ç”¨ç¨‹åºï¼Œéšç€æˆ‘ä»¬æ“ä½œ App ç•Œé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°å¸§ç‡çš„å˜åŒ–å’Œæ•°æ®äº†ï¼š</p>
<p><img src="/res/Instrument/9.png" width="80%"><br>åœ¨æ»‘åŠ¨å±å¹•æ—¶ï¼Œå¸§ç‡è¶Šé«˜è¡¨ç¤ºæ€§èƒ½è¶Šå¥½ï¼Œå¸§ç‡è¿‡ä½åˆ™æ„å‘³ç€å±å¹•å¯èƒ½ä¼šå‡ºç°å¡é¡¿ã€‚</p>
<p><strong>4ã€</strong>åœ¨å³ä¸‹è§’é¢æ¿çš„ Display Settings åŒºåŸŸï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤šä¸ª Debug Optionsï¼š</p>
<ul>
<li><code>Color Blended Layers</code>ï¼Œè¿™ä¸ªé€‰é¡¹é€‰é¡¹åŸºäºæ¸²æŸ“ç¨‹åº¦å¯¹å±å¹•ä¸­çš„æ··åˆåŒºåŸŸè¿›è¡Œç»¿åˆ°çº¢çš„é«˜äº®æ˜¾ç¤ºï¼Œ<strong>è¶Šçº¢è¡¨ç¤ºæ€§èƒ½è¶Šå·®</strong>ï¼Œä¼šå¯¹å¸§ç‡ç­‰æŒ‡æ ‡é€ æˆè¾ƒå¤§çš„å½±å“ã€‚çº¢è‰²é€šå¸¸æ˜¯ç”±äºå¤šä¸ªåŠé€æ˜å›¾å±‚å åŠ å¼•èµ·ã€‚</li>
<li><code>Color Hits Green and Misses Red</code>ï¼Œå½“ UIView.layer.shouldRasterize = YES æ—¶ï¼Œè€—æ—¶çš„å›¾ç‰‡ç»˜åˆ¶ä¼šè¢«ç¼“å­˜ï¼Œå¹¶å½“åšä¸€ä¸ªç®€å•çš„æ‰å¹³å›¾ç‰‡æ¥å‘ˆç°ã€‚è¿™æ—¶å€™ï¼Œå¦‚æœé¡µé¢çš„å…¶ä»–åŒºå—(æ¯”å¦‚ UITableViewCell çš„å¤ç”¨â€™ width=â€™80%â€™/&gt;ä½¿ç”¨ç¼“å­˜ç›´æ¥å‘½ä¸­ï¼Œå°±æ˜¾ç¤ºç»¿è‰²ï¼Œåä¹‹ï¼Œå¦‚æœä¸å‘½ä¸­ï¼Œè¿™æ—¶å°±æ˜¾ç¤ºçº¢è‰²ã€‚<strong>çº¢è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®</strong>ã€‚å› ä¸ºæ …æ ¼åŒ–ç”Ÿæˆç¼“å­˜çš„è¿‡ç¨‹æ˜¯æœ‰å¼€é”€çš„ï¼Œå¦‚æœç¼“å­˜èƒ½è¢«å¤§é‡å‘½ä¸­å’Œæœ‰æ•ˆä½¿ç”¨ï¼Œåˆ™æ€»ä½“ä¸Šä¼šé™ä½å¼€é”€ï¼Œåä¹‹åˆ™æ„å‘³ç€è¦é¢‘ç¹ç”Ÿæˆæ–°çš„ç¼“å­˜ï¼Œè¿™ä¼šè®©æ€§èƒ½é—®é¢˜é›ªä¸ŠåŠ éœœã€‚</li>
<li><code>Color Copied Images</code>ï¼Œå¯¹äº GPU ä¸æ”¯æŒçš„è‰²å½©æ ¼å¼çš„å›¾ç‰‡åªèƒ½ç”± CPU æ¥å¤„ç†ï¼ŒæŠŠè¿™æ ·çš„å›¾ç‰‡æ ‡ä¸ºè“è‰²ã€‚<strong>è“è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®</strong>ã€‚å› ä¸ºï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åœ¨æ»šåŠ¨è§†å›¾çš„æ—¶å€™ï¼Œç”± CPU æ¥å¤„ç†å›¾ç‰‡ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¹ä¸»çº¿ç¨‹é€ æˆé˜»å¡ã€‚</li>
<li><code>Color Immediately</code>ï¼Œé€šå¸¸ Core Animation Instruments ä»¥æ¯æ¯«ç§’ 10 æ¬¡çš„é¢‘ç‡æ›´æ–°å›¾å±‚è°ƒè¯•é¢œè‰²ã€‚å¯¹æŸäº›æ•ˆæœæ¥è¯´ï¼Œè¿™æ˜¾ç„¶å¤ªæ…¢äº†ã€‚è¿™ä¸ªé€‰é¡¹å°±å¯ä»¥ç”¨æ¥è®¾ç½®æ¯å¸§éƒ½æ›´æ–°ï¼ˆå¯èƒ½ä¼šå½±å“åˆ°æ¸²æŸ“æ€§èƒ½ï¼Œè€Œä¸”ä¼šå¯¼è‡´å¸§ç‡æµ‹é‡ä¸å‡†ï¼Œæ‰€ä»¥ä¸è¦ä¸€ç›´éƒ½è®¾ç½®å®ƒï¼‰ã€‚</li>
<li><code>Color Misaligned Images</code>ï¼Œè¿™ä¸ªé€‰é¡¹æ£€æŸ¥äº†å›¾ç‰‡æ˜¯å¦è¢«ç¼©æ”¾ï¼Œä»¥åŠåƒç´ æ˜¯å¦å¯¹é½ã€‚è¢«æ”¾ç¼©çš„å›¾ç‰‡ä¼šè¢«æ ‡è®°ä¸ºé»„è‰²ï¼Œåƒç´ ä¸å¯¹é½åˆ™ä¼šæ ‡æ³¨ä¸ºç´«è‰²ã€‚<strong>é»„è‰²ã€ç´«è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®ã€‚</strong></li>
<li><code>Color Offscreen-Rendered Yellow</code>ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šæŠŠé‚£äº›ç¦»å±æ¸²æŸ“çš„å›¾å±‚æ˜¾ç¤ºä¸ºé»„è‰²ã€‚<strong>é»„è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®</strong>ã€‚è¿™äº›æ˜¾ç¤ºä¸ºé»„è‰²çš„å›¾å±‚å¾ˆå¯èƒ½éœ€è¦ç”¨ shadowPath æˆ–è€… shouldRasterize æ¥ä¼˜åŒ–ã€‚</li>
<li><code>Color OpenGL Fast Path Blue</code>ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šæŠŠä»»ä½•ç›´æ¥ä½¿ç”¨ OpenGL ç»˜åˆ¶çš„å›¾å±‚æ˜¾ç¤ºä¸ºè“è‰²ã€‚<strong>è“è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå¥½</strong>ã€‚å¦‚æœä»…ä»…ä½¿ç”¨ UIKit æˆ–è€… Core Animation çš„ APIï¼Œé‚£ä¹ˆä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚å¦‚æœä½¿ç”¨ GLKView æˆ–è€… CAEAGLLayer`ï¼Œé‚£å¦‚æœä¸æ˜¾ç¤ºè“è‰²å—çš„è¯å°±æ„å‘³ç€ä½ æ­£åœ¨å¼ºåˆ¶ CPU æ¸²æŸ“é¢å¤–çš„çº¹ç†ï¼Œè€Œä¸æ˜¯ç»˜åˆ¶åˆ°å±å¹•ã€‚</li>
<li><code>Flash Updated Regions</code>ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šæŠŠé‡ç»˜çš„å†…å®¹æ˜¾ç¤ºä¸ºé»„è‰²ã€‚ä¸è¯¥å‡ºç°çš„<strong>é»„è‰²è¶Šå¤šï¼Œæ€§èƒ½è¶Šå·®</strong>ã€‚é€šå¸¸æˆ‘ä»¬å¸Œæœ›åªæ˜¯æ›´æ–°çš„éƒ¨åˆ†è¢«æ ‡è®°å®Œé»„è‰²ã€‚</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›é€‰é¡¹ï¼Œæ¥ç›‘æµ‹æ›´åŠ å…·ä½“çš„å›¾å½¢æ€§èƒ½ã€‚</p>
<p><strong>5ã€</strong>æˆ‘ä»¬è¿˜å¯ä»¥é€‰æ‹©ä½¿ç”¨ OpenGL ES Analysisã€GPU Driver ç­‰æ¨¡æ¿æ¥ç›‘æµ‹å›¾å½¢ç›¸å…³æ€§èƒ½ã€‚</p>
<h2 id="å†…å­˜æ€§èƒ½"><a href="#å†…å­˜æ€§èƒ½" class="headerlink" title="å†…å­˜æ€§èƒ½"></a>å†…å­˜æ€§èƒ½</h2><p>Instruments å¯ä»¥å¸®æˆ‘ä»¬äº†è§£åˆ°åº”ç”¨ç¨‹åºä½¿ç”¨å†…å­˜çš„å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li><strong>å…¨å±€å†…å­˜ä½¿ç”¨æƒ…å†µ(Overall Memory Use</strong>: ä»å…¨å±€çš„è§’åº¦ç›‘æµ‹åº”ç”¨ç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæ•æ‰éé¢„æœŸçš„æˆ–å¤§å¹…åº¦çš„å†…å­˜å¢é•¿ã€‚</li>
<li><strong>å†…å­˜æ³„éœ²(Leaked memory </strong>: æœªè¢«ä½ çš„ç¨‹åºå¼•ç”¨ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½è¢«ä½¿ç”¨æˆ–é‡Šæ”¾çš„å†…å­˜ã€‚</li>
<li><strong>åºŸå¼ƒå†…å­˜(Abandoned memory </strong>: è¢«ä½ çš„ç¨‹åºå¼•ç”¨ï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆåµç”¨çš„å†…å­˜ã€‚<br>åƒµå°¸å¯¹è±¡(Zombiesâ€™ width=â€™80%â€™/&gt;: åƒµå°¸å¯¹è±¡æŒ‡çš„æ˜¯å¯¹åº”çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾å¹¶ä¸”ä¸å†ä¼šä½¿ç”¨åˆ°ï¼Œä½†æ˜¯ä½ çš„ç¨‹åºå´åœ¨æŸå¤„ä¾ç„¶æœ‰æŒ‡å‘å®ƒçš„å¼•ç”¨ã€‚åœ¨ iOS ä¸­æœ‰ä¸€ä¸ª NSZombie æœºåˆ¶ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†å†…å­˜è°ƒè¯•çš„ç›®çš„è€Œè®¾è®¡çš„ä¸€ç§æœºåˆ¶ã€‚åœ¨è¿™ä¸ªæœºåˆ¶ä¸‹ï¼Œå½“ä½  NSZombieEnabled ä¸º YES æ—¶ï¼Œå½“ä¸€ä¸ªå¯¹åº”çš„å¼•ç”¨è®¡æ•°å‡ä¸º 0 æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡ä¸ä¼šè¢«é‡Šæ”¾ï¼Œå½“è¿™ä¸ªå¯¹è±¡å†æ”¶åˆ°ä»»ä½•æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šè®°å½•ä¸€æ¡ warningï¼Œè€Œä¸æ˜¯ç›´æ¥å´©æºƒï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œç¨‹åºè°ƒè¯•ã€‚<br>è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸‹æŸ¥æ‰¾å†…å­˜æ³„éœ²çš„è¿‡ç¨‹ï¼š</li>
</ul>
<p><strong>1ã€</strong>åŒã€ŒCPU å ç”¨æ€§èƒ½æµ‹è¯•ã€ä¸€æ ·ï¼Œå…ˆåœ¨ Xcode ä¸­å¯¹å½“å‰çš„é¡¹ç›®æ‰§è¡Œ Profile (Command-I ï¼Œå¹¶åœ¨æ‰“å¼€çš„å¯¹è¯æ¡†ä¸­é€‰æ‹© Leaks è¿™ä¸ªæ¨¡æ¿ï¼š<br><img src="/res/Instrument/10.png" width="20%"></p>
<p><strong>2ã€</strong>è¿›å…¥ Instruments åï¼Œé€‰æ‹©æ­£ç¡®çš„è®¾å¤‡å’Œåº”ç”¨ç¨‹åºã€‚</p>
<p><strong>3ã€</strong>ç‚¹å‡»çº¢è‰²æŒ‰é’®è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š<br><img src="/res/Instrument/11.png" width="80%"></p>
<p><strong>4ã€</strong>åœ¨ Display Settings ä¸­å‹¾é€‰ <code>Invert Call Tree</code> å’Œ <code>Hide System Libraries</code> æˆ–å…¶ä»–é€‰é¡¹å¯ä»¥è¿‡æ»¤æ˜¾ç¤ºçš„æ•°æ®ã€‚<br><img src="/res/Instrument/12.png" width="80%"></p>
<p><strong>5ã€</strong>åœ¨å¯¼èˆªæ çš„ç­›é€‰æ¡†ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥å…³é”®å­—æ¥ç­›é€‰æ•°æ®ã€‚<br><img src="/res/Instrument/13.png" width="80%"></p>
<p><strong>6ã€</strong>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬è¿›å…¥ä¸€ä¸ªé¡µé¢åå†é€€å‡ºï¼Œå‘ç°ç›¸å…³çš„å†…å­˜åˆ†é…æ²¡æœ‰æ¸…ç©ºï¼Œè¿™æ—¶å€™å°±å‘ç”Ÿå†…å­˜æ³„éœ²äº†ã€‚æˆ‘ä»¬æŸ¥çœ‹æ›´ç»†èŠ‚çš„è°ƒç”¨ä¿¡æ¯ï¼Œè¿½è¸ªåˆ°å¯èƒ½é€ æˆå†…å­˜æ³„éœ²çš„ä»£ç ä½ç½®ï¼š<br><img src="/res/Instrument/14.png" width="80%"><br><strong>7ã€</strong>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ Activity Monitorã€Allocationsã€Zombies ç­‰æ¨¡æ¿æ¥é’ˆå¯¹æ€§åœ°åšå†…å­˜ç›‘æµ‹ã€‚</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Instruments</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -å</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-%E5%8F%81/</url>
    <content><![CDATA[<p>åœ¨<a href="../SDWebImage375æºç -è´°/">SDWebImage3.7.5æºç é˜…è¯»äºŒ</a>ä¸­çœ‹å®Œåï¼Œå·²ç»çŸ¥é“SDWebImageCombinedOperationç±»çš„åœ¨cacheOperationæœç´¢å®Œç¼“å­˜ä¹‹åï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryDiskCacheForKey:key done:^(<span class="built_in">UIImage</span> *image, SDImageCacheType cacheType) &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryDiskCacheForKey:key done:^(<span class="built_in">UIImage</span> *image, SDImageCacheType cacheType) &#123;</span><br><span class="line"></span><br><span class="line">...<span class="comment">//ä¸€å¤§ä¸² optionsçš„æ“ä½œ æš‚æ—¶ä¸ç®¡å®ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç»ˆäºè§åˆ°äº†ä¸‹è½½æ“ä½œï¼</span></span><br><span class="line"><span class="keyword">id</span> &lt;SDWebImageOperation&gt; subOperation = [<span class="keyword">self</span>.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å…¶ä¸­<code>self.imageDownloader</code>ä¹Ÿæ˜¯SDWebImageManager initçš„æ—¶å€™ç”Ÿæˆçš„ï¼Œæ˜¯<code>SDWebImageDownloader</code>å¯¹è±¡ï¼Œè·³è½¬åˆ°<code>downloadImageWithURL</code>ä¸­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url options:(SDWebImageDownloaderOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line"></span><br><span class="line">__block SDWebImageDownloaderOperation *operation;</span><br><span class="line">   __<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)wself = <span class="keyword">self</span>;</span><br><span class="line">   </span><br><span class="line">[<span class="keyword">self</span> addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”Ÿæˆå¯¹åº”çš„URL</span></span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request = ...</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹è½½è¿›åº¦ ä¸‹è½½å®Œæˆ å–æ¶ˆç­‰æ“ä½œ</span></span><br><span class="line">operation = [[wself.operationClass alloc] initWithRequest ...</span><br><span class="line"></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//å¼€å§‹ä¸‹è½½</span></span><br><span class="line">[wself.downloadQueue addOperation:operation];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæŸ¥çœ‹<code>SDWebImageDownloaderOperation</code> å¯ä»¥çœ‹åˆ°ä¸‹è½½å®ç°æ˜¯é  <code>NSURLConnection</code>å®Œæˆçš„ï¼Œä¸‹è½½è¿›åº¦ä»€ä¹ˆçš„å½“ç„¶å°±æ˜¯<code>NSURLConnectionDataDelegate</code>é‡Œå®Œæˆçš„ã€‚</p>
<p>å›¾ç‰‡ä¸‹è½½å®Œåæœ‰ä¸ªdecodeæ“ä½œï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">image = [<span class="built_in">UIImage</span> decodedImageWithImage:image];</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œæ•´ç†ä¸€ä¸‹ä¸»è¦çš„æµç¨‹ï¼š</p>
<p><img src="/res/SDWebImage/sdwebimg.png" alt></p>
<ol>
<li>å…¥å£ setImageWithURL:placeholderImage:options: ä¼šå…ˆæŠŠ placeholderImage æ˜¾ç¤ºï¼Œç„¶å SDWebImageManager æ ¹æ® URL å¼€å§‹å¤„ç†å›¾ç‰‡ã€‚</li>
<li>è¿›å…¥ SDWebImageManager-downloadWithURL:delegate:options:userInfo:ï¼Œäº¤ç»™ SDImageCache ä»ç¼“å­˜æŸ¥æ‰¾å›¾ç‰‡æ˜¯å¦å·²ç»ä¸‹è½½ queryDiskCacheForKey:key done:.</li>
<li>å…ˆä»å†…å­˜å›¾ç‰‡ç¼“å­˜æŸ¥æ‰¾æ˜¯å¦æœ‰å›¾ç‰‡ï¼Œå¦‚æœå†…å­˜ä¸­å·²ç»æœ‰å›¾ç‰‡ç¼“å­˜ SDWebImageQueryCompletedBlock å—è¿”å›å›¾ç‰‡ åˆ°å‰ç«¯å±•ç¤ºå›¾ç‰‡ã€‚</li>
<li>å¦‚æœå†…å­˜ç¼“å­˜ä¸­æ²¡æœ‰ï¼ŒGCD å¼‚æ­¥å¼€å§‹ä»ç¡¬ç›˜æŸ¥æ‰¾å›¾ç‰‡æ˜¯å¦å·²ç»ç¼“å­˜ã€‚</li>
<li>æ ¹æ® URLKey åœ¨ç¡¬ç›˜ç¼“å­˜ç›®å½•ä¸‹å°è¯•è¯»å–å›¾ç‰‡æ–‡ä»¶ã€‚ å®Œæˆååœ¨SDWebImageQueryCompletedBlockå›è°ƒ</li>
<li>å¦‚æœä¸Šä¸€æ“ä½œä»ç¡¬ç›˜è¯»å–åˆ°äº†å›¾ç‰‡ï¼Œå›¾ç‰‡å¯èƒ½å…ˆç¼©æ”¾å†è½¬ç ï¼Œå°†å›¾ç‰‡æ·»åŠ åˆ°å†…å­˜ç¼“å­˜ä¸­</li>
<li>å¦‚æœä»ç¡¬ç›˜ç¼“å­˜ç›®å½•è¯»å–ä¸åˆ°å›¾ç‰‡ï¼Œè¯´æ˜æ‰€æœ‰ç¼“å­˜éƒ½ä¸å­˜åœ¨è¯¥å›¾ç‰‡ï¼Œéœ€è¦ä¸‹è½½å›¾ç‰‡ï¼Œ<br>å…±äº«æˆ–é‡æ–°ç”Ÿæˆä¸€ä¸ªä¸‹è½½å™¨ SDWebImageDownloader å¼€å§‹ä¸‹è½½å›¾ç‰‡ã€‚</li>
<li>å›¾ç‰‡ä¸‹è½½ç”± NSURLConnection æ¥åšï¼Œå®ç°ç›¸å…³ delegate æ¥åˆ¤æ–­å›¾ç‰‡ä¸‹è½½ä¸­ã€ä¸‹è½½å®Œæˆå’Œä¸‹è½½å¤±è´¥ã€‚<ul>
<li>connection:didReceiveData: ä¸­åˆ©ç”¨ SDWebImageQueryCompletedBlock åšäº†æŒ‰å›¾ç‰‡ä¸‹è½½è¿›åº¦åŠ è½½æ•ˆæœã€‚</li>
<li>connectionDidFinishLoading: æ•°æ®ä¸‹è½½å®Œæˆåäº¤ç»™ SDWebImageDecoder åšå›¾ç‰‡è§£ç å¤„ç†ã€‚</li>
</ul>
</li>
<li>ä¸‹è½½å®Œæˆåæœ‰ç¼“å­˜ï¼Œäº¤ç»™ SDWebImageDecoder åšå›¾ç‰‡è§£ç æ“ä½œã€‚</li>
</ol>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSç¼–è¯‘è¿‡ç¨‹</title>
    <url>/essay/LLDB/iOS_Compiler/</url>
    <content><![CDATA[<h2 id="ç¼–è¯‘å™¨"><a href="#ç¼–è¯‘å™¨" class="headerlink" title="ç¼–è¯‘å™¨"></a>ç¼–è¯‘å™¨</h2><blockquote>
<p>æŠŠä¸€ç§ç¼–ç¨‹è¯­è¨€(åŸå§‹è¯­è¨€)è½¬æ¢ä¸ºå¦ä¸€ç§ç¼–ç¨‹è¯­è¨€(ç›®æ ‡è¯­è¨€)çš„ç¨‹åºå«åšç¼–è¯‘å™¨</p>
</blockquote>
<p>å¤§å¤šæ•°ç¼–è¯‘å™¨ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå‰ç«¯å’Œåç«¯ã€‚</p>
<ul>
<li>å‰ç«¯è´Ÿè´£è¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ï¼›</li>
<li>åç«¯ä»¥ä¸­é—´ä»£ç ä½œä¸ºè¾“å…¥ï¼Œè¿›è¡Œè¡Œæ¶æ„æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ¥ç€é’ˆå¯¹ä¸åŒæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚</li>
</ul>
<p>Objective C/C/C++ä½¿ç”¨çš„ç¼–è¯‘å™¨å‰ç«¯æ˜¯clangï¼Œswiftæ˜¯swiftï¼Œåç«¯éƒ½æ˜¯LLVMã€‚</p>
<h3 id="llvmä»‹ç»"><a href="#llvmä»‹ç»" class="headerlink" title="llvmä»‹ç»"></a>llvmä»‹ç»</h3><p>LLVMæ˜¯ä»€ä¹ˆï¼Œæ˜¯low level virtual machineçš„ç®€ç§°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ¡†æ¶ã€‚LLVM çš„ä¼˜ç‚¹ä¸»è¦å¾—ç›Šäºå®ƒçš„ä¸‰å±‚å¼æ¶æ„ â€“ ç¬¬ä¸€å±‚æ”¯æŒå¤šç§è¯­è¨€ä½œä¸ºè¾“å…¥(ä¾‹å¦‚ C, ObjectiveC, C++ å’Œ Haskell)ï¼Œç¬¬äºŒå±‚æ˜¯ä¸€ä¸ªå…±äº«å¼çš„ä¼˜åŒ–å™¨(å¯¹ LLVM IR åšä¼˜åŒ–å¤„ç†)ï¼Œç¬¬ä¸‰å±‚æ˜¯è®¸å¤šä¸åŒçš„ç›®æ ‡å¹³å°(ä¾‹å¦‚ Intel, ARM å’Œ PowerPC)ã€‚ç¼–è¯‘å™¨å‰ç«¯ä¸»è¦è¿›è¡Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œç”Ÿæˆä¸­é—´ä»£ç ã€‚ç¼–è¯‘å™¨åç«¯ä¼šè¿›è¡Œæœºå™¨æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ï¼Œæ ¹æ®ä¸åŒçš„ç³»ç»Ÿæ¶æ„ç”Ÿæˆä¸åŒçš„æœºå™¨ç ã€‚</p>
<p><img src="/res/LLVM/LLVMCompiler1.png" alt></p>
<p>ç°åœ¨ï¼ŒXcode çš„é»˜è®¤ç¼–è¯‘å™¨æ˜¯ clangã€‚æœ¬æ–‡ä¸­æˆ‘ä»¬æåˆ°çš„ç¼–è¯‘å™¨éƒ½è¡¨ç¤º clangã€‚clang çš„åŠŸèƒ½æ˜¯é¦–å…ˆå¯¹ Objective-C ä»£ç åšåˆ†ææ£€æŸ¥ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºä½çº§çš„ç±»æ±‡ç¼–ä»£ç ï¼šLLVM Intermediate Representation(LLVM ä¸­é—´è¡¨è¾¾ç )ã€‚æ¥ç€ LLVM ä¼šæ‰§è¡Œç›¸å…³æŒ‡ä»¤å°† LLVM IR ç¼–è¯‘æˆç›®æ ‡å¹³å°ä¸Šçš„æœ¬åœ°å­—èŠ‚ç ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„å®Œæˆæ–¹å¼å¯ä»¥æ˜¯å³æ—¶ç¼–è¯‘ (Just-in-time)ï¼Œæˆ–åœ¨ç¼–è¯‘çš„æ—¶å€™å®Œæˆã€‚è€ŒClang æ˜¯ä¸€ä¸ªCã€C++ã€Objective-Cå’ŒObjective-C++ç¼–ç¨‹è¯­è¨€çš„ç¼–è¯‘å™¨å‰ç«¯ã€‚å®ƒé‡‡ç”¨äº†åº•å±‚è™šæ‹Ÿæœºï¼ˆLLVMï¼‰ä½œä¸ºå…¶åç«¯ã€‚å®ƒçš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªGNUç¼–è¯‘å™¨å¥—è£…ï¼ˆGCCï¼‰çš„æ›¿ä»£å“ã€‚Clangé¡¹ç›®åŒ…æ‹¬Clangå‰ç«¯å’ŒClangé™æ€åˆ†æå™¨ç­‰ã€‚</p>
<p>ä¸‹å›¾æ˜¯iOSç¼–è¯‘è¿‡ç¨‹ï¼š<br><img src="/res/LLVM/iOSCompiler.png" alt></p>
<a id="more"></a>
<h2 id="ä½¿ç”¨llvmå‘½ä»¤"><a href="#ä½¿ç”¨llvmå‘½ä»¤" class="headerlink" title="ä½¿ç”¨llvmå‘½ä»¤"></a>ä½¿ç”¨llvmå‘½ä»¤</h2><p><strong><em>ä¸€ã€ä½¿ç”¨xcodeè‡ªå¸¦</em></strong></p>
<p>ä½¿ç”¨xcrunæ¥è°ƒç”¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">xcrun clang -v</span><br><span class="line"><span class="comment">#Apple LLVM version 10.0.0 (clang-1000.11.45.5)</span></span><br><span class="line"><span class="comment">#Target: x86_64-apple-darwin17.7.0</span></span><br><span class="line"><span class="comment">#Thread model: posix</span></span><br><span class="line"><span class="comment">#InstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin</span></span><br></pre></td></tr></table></figure>
<p><strong><em>äºŒã€ä½¿ç”¨HomeBrewå®‰è£…</em></strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1.ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…llvm</span></span><br><span class="line">brew install --with-toolchain llvm</span><br><span class="line"><span class="comment"># è‹¥å®‰è£…é‡åˆ°é—®é¢˜ å¯ä»¥å…ˆå‡çº§brewè¯•è¯•</span></span><br><span class="line"><span class="comment">#   brew update è¿™ä¼šæ›´æ–° Homebrew è‡ªå·±</span></span><br><span class="line"><span class="comment">#   brew upgrade å‡çº§æ‰€æœ‰å¯ä»¥å‡çº§çš„è½¯ä»¶ä»¬</span></span><br></pre></td></tr></table></figure>
<p>å®‰è£…åå¯ä»¥ä½¿ç”¨ <code>brew info llvm</code> æ£€æŸ¥ä¿¡æ¯ã€‚brewå®‰è£…llvmåï¼Œä¸ä¼šç›´æ¥æ·»åŠ å‘½ä»¤çš„å¿«æ·å¼•ç”¨ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨æ¥å®Œæˆã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹llvmçš„å®‰è£…è·¯å¾„</span></span><br><span class="line">brew --prefix llvm</span><br><span class="line"><span class="comment"># æ·»åŠ å¼•ç”¨ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/opt/llvm/bin:$PATH"'</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>
<!-- https://embeddedartistry.com/blog/2017/2/20/installing-clangllvm-on-osx -->
<p>è¿™æ ·ä¹‹åå°±å¯ä»¥ç›´æ¥è°ƒç”¨è‡ªå·±å®‰è£…çš„llvmäº†ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">clang -v</span><br><span class="line"><span class="comment">#clang version 8.0.0 (tags/RELEASE_800/final)</span></span><br><span class="line"><span class="comment">#Target: x86_64-apple-darwin17.7.0</span></span><br><span class="line"><span class="comment">#Thread model: posix</span></span><br><span class="line"><span class="comment">#InstalledDir: /usr/local/opt/llvm/bin</span></span><br></pre></td></tr></table></figure>
<h2 id="ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹"><a href="#ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹" class="headerlink" title="ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹"></a>ç¼–è¯‘å™¨å¤„ç†è¿‡ç¨‹</h2><p>åœ¨ç¼–è¯‘ä¸€ä¸ªæºæ–‡ä»¶æ—¶ï¼Œç¼–è¯‘å™¨çš„å¤„ç†è¿‡ç¨‹åˆ†ä¸ºå‡ ä¸ªé˜¶æ®µã€‚è¦æƒ³æŸ¥çœ‹ç¼–è¯‘ hello.m æºæ–‡ä»¶éœ€è¦å‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œä¸Šæ–‡ä¸­å®‰è£…llvmåï¼Œæˆ‘ä»¬å¯ä»¥è®©é€šè¿‡ clang å‘½ä»¤è§‚å¯Ÿï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sunTongShengdeMacBook-Pro:asdasd suntongsheng$ clang -ccc-print-phases ViewController.m</span><br><span class="line">0: input, &quot;ViewController.m&quot;, objective-c</span><br><span class="line">1: preprocessor, &#123;0&#125;, objective-c-cpp-output</span><br><span class="line">2: compiler, &#123;1&#125;, ir</span><br><span class="line">3: backend, &#123;2&#125;, assembler</span><br><span class="line">4: assembler, &#123;3&#125;, object</span><br><span class="line">5: linker, &#123;4&#125;, image</span><br><span class="line">6: bind-arch, &quot;x86_64&quot;, &#123;5&#125;, image</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°clangå°†å…¶åˆ†ä¸º inputã€preprocessor ã€compilerã€backendã€assemblerã€linkerã€bind-archå‡ ä¸ªé˜¶æ®µã€‚</p>
<ul>
<li>é¢„å¤„ç†é˜¶æ®µï¼šç¬¦å·åŒ–ã€å®å®šä¹‰å±•å¼€å¤´æ–‡ä»¶å±•å¼€</li>
<li>è¯­æ³•å’Œè¯­ä¹‰åˆ†æé˜¶æ®µï¼šå°†ç¬¦å·åŒ–åçš„å†…å®¹è½¬åŒ–ä¸ºä¸€æ£µè§£ææ ‘ã€è§£ææ ‘åšè¯­ä¹‰åˆ†æ è¾“å‡ºä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘</li>
<li>ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µï¼šå°† AST è½¬æ¢ä¸ºæ›´ä½çº§çš„ä¸­é—´ç  (LLVM IR)ã€å¯¹ç”Ÿæˆçš„ä¸­é—´ç åšä¼˜åŒ–ã€ç”Ÿæˆç‰¹å®šç›®æ ‡ä»£ç ã€è¾“å‡ºæ±‡ç¼–ä»£ç </li>
<li>æ±‡ç¼–å™¨é˜¶æ®µï¼šå°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºç›®æ ‡å¯¹è±¡æ–‡ä»¶ã€‚</li>
<li>é“¾æ¥å™¨ï¼šå°†å¤šä¸ªç›®æ ‡å¯¹è±¡æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ (æˆ–è€…ä¸€ä¸ªåŠ¨æ€åº“)</li>
</ul>
<h3 id="preprocessor-é¢„å¤„ç†"><a href="#preprocessor-é¢„å¤„ç†" class="headerlink" title="preprocessor é¢„å¤„ç†"></a>preprocessor é¢„å¤„ç†</h3><p>æ¯å½“ç¼–æºè¯‘æ–‡ä»¶çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨é¦–å…ˆåšçš„æ˜¯ä¸€äº›é¢„å¤„ç†å·¥ä½œã€‚å…·ä½“è¡¨ç°ä¸ºimportå¤´æ–‡ä»¶æ›¿æ¢ã€macroå®å±•å¼€ã€å…¶ä»–é¢„ç¼–è¯‘æŒ‡ä»¤ï¼Œ`#è¿™ä¸ªç¬¦å·æ˜¯ç¼–è¯‘å™¨é¢„å¤„ç†çš„æ ‡å¿—ã€‚</p>
<p><strong><em>ä¸€. å¯¹å¤´æ–‡ä»¶çš„å¤„ç†ï¼š</em></strong></p>
<p>ä¾‹å¦‚ï¼Œå¦‚æœåœ¨æºæ–‡ä»¶ä¸­å‡ºç°ä¸‹è¿°ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>é¢„å¤„ç†å™¨å¯¹è¿™è¡Œä»£ç çš„å¤„ç†æ˜¯ç”¨ Foundation.h æ–‡ä»¶ä¸­çš„å†…å®¹å»æ›¿æ¢è¿™è¡Œä»£ç ï¼Œå¦‚æœ Foundation.h ä¸­ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„å®å¼•å…¥ï¼Œåˆ™ä¼šæŒ‰ç…§åŒæ ·çš„å¤„ç†æ–¹å¼ç”¨å„ä¸ªå®å¯¹åº”çš„çœŸæ­£ä»£ç è¿›è¡Œé€çº§æ›¿ä»£ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆäººä»¬ä¸»å¼ å¤´æ–‡ä»¶æœ€å¥½å°½é‡å°‘çš„å»å¼•å…¥å…¶ä»–çš„ç±»æˆ–åº“ï¼Œå› ä¸ºå¼•å…¥çš„ä¸œè¥¿è¶Šå¤šï¼Œç¼–è¯‘å™¨éœ€è¦åšçš„å¤„ç†å°±è¶Šå¤š</p>
<p><strong>ç¤ºä¾‹</strong>ï¼šå‡è®¾æˆ‘ä»¬å†™äº†ä¸€ä¸ªç®€å•çš„ C ç¨‹åº hello.c:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello llvm\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åç»™ä¸Šé¢çš„ä»£ç æ‰§è¡Œä»¥ä¸‹é¢„å¤„ç†å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  -E  Only run the preprocessor</span></span><br><span class="line">clang -E hello.c &gt;&gt; hello.o</span><br></pre></td></tr></table></figure>
<p>æ‰“å¼€ hello.o ï¼Œå‘ç°æœ‰542è¡Œã€‚ä½†æ˜¯å¦‚æœåœ¨ä¸Šè¿°ä»£ç ä¸ŠåŠ ä¸Š <code>#import &lt;Foundation/Foundation.h&gt;</code> ï¼Œhello.o çš„è¡Œæ•°æš´å¢åˆ°9ä¸‡å¤šè¡Œã€‚ï¼ˆå½“ç„¶å¯¹äºè¿™ç§æƒ…å†µå¼•å…¥äº†<a href="http://clang.llvm.org/docs/Modules.html" target="_blank" rel="noopener">æ¨¡å— - modules</a>åŠŸèƒ½ï¼‰</p>
<p>æ‰“å¼€æ¨¡å—åŠŸèƒ½å†è¯•è¯•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#-fmodules å…è®¸modulesçš„è¯­è¨€ç‰¹æ€§</span></span><br><span class="line">clang  -fmodules -E  hello.c &gt;&gt; hello.1o</span><br><span class="line"></span><br><span class="line"><span class="comment">#hello.1oçš„å†…å®¹ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 "hello.c"</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 1</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 3</span></span><br><span class="line"><span class="comment"># 361 "&lt;built-in&gt;" 3</span></span><br><span class="line"><span class="comment"># 1 "&lt;command line&gt;" 1</span></span><br><span class="line"><span class="comment"># 1 "&lt;built-in&gt;" 2</span></span><br><span class="line"><span class="comment"># 1 "hello.c" 2</span></span><br><span class="line"><span class="comment">#pragma clang module import Darwin.C.stdio /* clang -E: implicit import for #include &lt;stdio.h&gt; */</span></span><br><span class="line"></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello llvm\n"</span>);</span><br><span class="line">  <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>äºŒã€å¯¹äºå®çš„å¤„ç†</em></strong></p>
<p>å‡è®¾ä¸€æ®µè¿™æ ·çš„ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(a,b) a &gt; b ? a : b</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">200</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"largest: %d\n"</span>, MAX(i++,<span class="number">100</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"i: %d\n"</span>, i);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ <code>clang -E hello.c</code> è¿›è¡Œå®å±•å¼€çš„é¢„å¤„ç†ç»“æœæ˜¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">200</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"largest: %d\n"</span>, i++ &gt; <span class="number">100</span> ? i++ : <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"i: %d\n"</span>, i);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>i++</code>è¢«æ›¿æ¢åˆ°äº†<code>a</code>ä¸­ï¼Œè€Œä¸æ˜¯é¢„æƒ³çš„ i++çš„å€¼ã€‚</p>
<h3 id="compiler-è¯æ³•åˆ†æè§£ææ ‡è®°"><a href="#compiler-è¯æ³•åˆ†æè§£ææ ‡è®°" class="headerlink" title="compiler è¯æ³•åˆ†æè§£ææ ‡è®°"></a>compiler è¯æ³•åˆ†æè§£ææ ‡è®°</h3><h4 id="ä¸€ã€è¯æ³•åˆ†æ-Lexical-Analysis"><a href="#ä¸€ã€è¯æ³•åˆ†æ-Lexical-Analysis" class="headerlink" title="ä¸€ã€è¯æ³•åˆ†æ-Lexical Analysis"></a>ä¸€ã€è¯æ³•åˆ†æ-Lexical Analysis</h4><p>åœ¨compileré˜¶æ®µï¼Œé¦–å…ˆä»£ç æ–‡æœ¬éƒ½ä¼šä» string è½¬åŒ–æˆç‰¹æ®Šçš„æ ‡è®°æµã€‚å°†ä»£ç åˆ‡æˆä¸€ä¸ªä¸ª tokenï¼Œæ¯”å¦‚å¤§å°æ‹¬å·ï¼Œç­‰äºå·è¿˜æœ‰å­—ç¬¦ä¸²ç­‰ã€‚æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­å°†å­—ç¬¦åºåˆ—è½¬æ¢ä¸ºæ ‡è®°åºåˆ—çš„è¿‡ç¨‹ã€‚ ä¾‹å¦‚ï¼Œä¸‹é¢è¿™æ®µç¨‹åºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// hello.c</span></span><br><span class="line"><span class="keyword">int</span> main() &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@"hello, %@"</span>, <span class="string">@"world"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨ clang å‘½ä»¤ clang -Xclang -dump-tokens hello.m æ¥å°†ä¸Šé¢ä»£ç çš„æ ‡è®°æµå¯¼å‡ºï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#clang -Xclang -dump-tokens hello.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ§åˆ¶å°è¾“å‡ºï¼š</span></span><br><span class="line">int <span class="string">'int'</span>	 [StartOfLine]	Loc=&lt;hello.c:1:1&gt;</span><br><span class="line">identifier <span class="string">'main'</span>	 [LeadingSpace]	Loc=&lt;hello.c:1:5&gt;</span><br><span class="line">l_paren <span class="string">'('</span>		Loc=&lt;hello.c:1:9&gt;</span><br><span class="line">r_paren <span class="string">')'</span>		Loc=&lt;hello.c:1:10&gt;</span><br><span class="line">l_brace <span class="string">'&#123;'</span>	 [LeadingSpace]	Loc=&lt;hello.c:1:12&gt;</span><br><span class="line">identifier <span class="string">'NSLog'</span>	 [StartOfLine] [LeadingSpace]	Loc=&lt;hello.c:2:3&gt;</span><br><span class="line">l_paren <span class="string">'('</span>		Loc=&lt;hello.c:2:8&gt;</span><br><span class="line">unknown <span class="string">'@'</span>		Loc=&lt;hello.c:2:9&gt;</span><br><span class="line">string_literal <span class="string">'"hello, %@"'</span>		Loc=&lt;hello.c:2:10&gt;</span><br><span class="line">comma <span class="string">','</span>		Loc=&lt;hello.c:2:21&gt;</span><br><span class="line">unknown <span class="string">'@'</span>	 [LeadingSpace]	Loc=&lt;hello.c:2:23&gt;</span><br><span class="line">string_literal <span class="string">'"world"'</span>		Loc=&lt;hello.c:2:24&gt;</span><br><span class="line">r_paren <span class="string">')'</span>		Loc=&lt;hello.c:2:31&gt;</span><br><span class="line">semi <span class="string">';'</span>		Loc=&lt;hello.c:2:32&gt;</span><br><span class="line"><span class="built_in">return</span> <span class="string">'return'</span>	 [StartOfLine] [LeadingSpace]	Loc=&lt;hello.c:3:3&gt;</span><br><span class="line">numeric_constant <span class="string">'0'</span>	 [LeadingSpace]	Loc=&lt;hello.c:3:10&gt;</span><br><span class="line">semi <span class="string">';'</span>		Loc=&lt;hello.c:3:11&gt;</span><br><span class="line">r_brace <span class="string">'&#125;'</span>	 [StartOfLine]	Loc=&lt;hello.c:4:1&gt;</span><br><span class="line">eof <span class="string">''</span>		Loc=&lt;hello.c:4:2&gt;</span><br></pre></td></tr></table></figure>
<p>æ¯ä¸€ä¸ªæ ‡è®°éƒ½åŒ…å«äº†å¯¹åº”çš„æºç å†…å®¹å’Œå…¶åœ¨æºç ä¸­çš„ä½ç½®,å¦‚æœç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œclang èƒ½å¤Ÿåœ¨æºç ä¸­æŒ‡å‡ºå‡ºé”™çš„å…·ä½“ä½ç½®ã€‚</p>
<h4 id="äºŒã€è¯­æ³•åˆ†æ-Semantic-Analysis"><a href="#äºŒã€è¯­æ³•åˆ†æ-Semantic-Analysis" class="headerlink" title="äºŒã€è¯­æ³•åˆ†æ - Semantic Analysis"></a>äºŒã€è¯­æ³•åˆ†æ - Semantic Analysis</h4><p>ä¹‹åä¸Šé¢çš„æ ‡è®°æµä¼šè§£æç”Ÿæˆ<a href="http://clang.llvm.org/docs/IntroductionToTheClangAST.html" target="_blank" rel="noopener">æŠ½è±¡è¯­æ³•æ ‘</a>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>clang -Xclang -ast-dump -fsyntax-only hello.c</code> æ¥å±•ç°è§£æè¿™ä¸ªè¿‡ç¨‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># clang -Xclang -ast-dump -fsyntax-only hello.c </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ§åˆ¶å°è¾“å‡ºï¼š</span></span><br><span class="line">hello.c:2:3: warning: implicit declaration of <span class="keyword">function</span> <span class="string">'NSLog'</span> is invalid <span class="keyword">in</span> C99 [-Wimplicit-function-declaration]</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">  ^</span><br><span class="line">hello.c:2:9: error: expected expression</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">        ^</span><br><span class="line">hello.c:2:23: error: expected expression</span><br><span class="line">  NSLog(@<span class="string">"hello, %@"</span>, @<span class="string">"world"</span>);</span><br><span class="line">                      ^</span><br><span class="line">TranslationUnitDecl 0x7fe1d2816c08 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt;</span><br><span class="line">|-TypedefDecl 0x7fe1d28174a0 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __int128_t <span class="string">'__int128'</span></span><br><span class="line">| `-BuiltinType 0x7fe1d28171a0 <span class="string">'__int128'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817508 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __uint128_t <span class="string">'unsigned __int128'</span></span><br><span class="line">| `-BuiltinType 0x7fe1d28171c0 <span class="string">'unsigned __int128'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d28177b8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __NSConstantString <span class="string">'struct __NSConstantString_tag'</span></span><br><span class="line">| `-RecordType 0x7fe1d28175d0 <span class="string">'struct __NSConstantString_tag'</span></span><br><span class="line">|   `-Record 0x7fe1d2817558 <span class="string">'__NSConstantString_tag'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817850 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_ms_va_list <span class="string">'char *'</span></span><br><span class="line">| `-PointerType 0x7fe1d2817810 <span class="string">'char *'</span></span><br><span class="line">|   `-BuiltinType 0x7fe1d2816ca0 <span class="string">'char'</span></span><br><span class="line">|-TypedefDecl 0x7fe1d2817af8 &lt;&lt;invalid sloc&gt;&gt; &lt;invalid sloc&gt; implicit __builtin_va_list <span class="string">'struct __va_list_tag [1]'</span></span><br><span class="line">| `-ConstantArrayType 0x7fe1d2817aa0 <span class="string">'struct __va_list_tag [1]'</span> 1 </span><br><span class="line">|   `-RecordType 0x7fe1d2817920 <span class="string">'struct __va_list_tag'</span></span><br><span class="line">|     `-Record 0x7fe1d28178a0 <span class="string">'__va_list_tag'</span></span><br><span class="line">`-FunctionDecl 0x7fe1d285d000 &lt;hello.c:1:1, line:4:1&gt; line:1:5 main <span class="string">'int ()'</span></span><br><span class="line">  `-CompoundStmt 0x7fe1d285d1f8 &lt;col:12, line:4:1&gt;</span><br><span class="line">    `-ReturnStmt 0x7fe1d285d1e8 &lt;line:3:3, col:10&gt;</span><br><span class="line">      `-IntegerLiteral 0x7fe1d285d1c8 &lt;col:10&gt; <span class="string">'int'</span> 0</span><br></pre></td></tr></table></figure>
<p>åœ¨æŠ½è±¡è¯­æ³•æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ ‡æ³¨äº†å…¶å¯¹åº”æºç ä¸­çš„ä½ç½®ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœäº§ç”Ÿäº†ä»€ä¹ˆé—®é¢˜ï¼Œclang å¯ä»¥å®šä½åˆ°é—®é¢˜æ‰€åœ¨å¤„çš„æºç ä½ç½®ã€‚</p>
<h4 id="ä¸‰ã€é™æ€åˆ†æ-Static-Analyzer"><a href="#ä¸‰ã€é™æ€åˆ†æ-Static-Analyzer" class="headerlink" title="ä¸‰ã€é™æ€åˆ†æ - Static Analyzer"></a>ä¸‰ã€é™æ€åˆ†æ - Static Analyzer</h4><p>ä¸€æ—¦ç¼–è¯‘å™¨æŠŠæºç ç”Ÿæˆäº†æŠ½è±¡è¯­æ³•æ ‘ï¼Œç¼–è¯‘å™¨å¯ä»¥å¯¹è¿™æ£µæ ‘åšåˆ†æå¤„ç†ï¼Œä»¥æ‰¾å‡ºä»£ç ä¸­çš„é”™è¯¯ï¼Œæ¯”å¦‚ç±»å‹æ£€æŸ¥ï¼šå³æ£€æŸ¥ç¨‹åºä¸­æ˜¯å¦æœ‰ç±»å‹é”™è¯¯ã€‚ä¾‹å¦‚ï¼šå¦‚æœä»£ç ä¸­ç»™æŸä¸ªå¯¹è±¡å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œç¼–è¯‘å™¨ä¼šæ£€æŸ¥è¿™ä¸ªå¯¹è±¡æ˜¯å¦å®ç°äº†è¿™ä¸ªæ¶ˆæ¯ï¼ˆå‡½æ•°ã€æ–¹æ³•ï¼‰ã€‚æ­¤å¤–ï¼Œclang å¯¹æ•´ä¸ªç¨‹åºè¿˜åšäº†å…¶å®ƒæ›´é«˜çº§çš„ä¸€äº›åˆ†æï¼Œä»¥ç¡®ä¿ç¨‹åºæ²¡æœ‰é”™è¯¯ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å‘½ä»¤è¡Œæ‰§è¡Œ é€šè¿‡clang -cc1 -analyzer-checker-helpå¯ä»¥åˆ—å‡ºèƒ½è°ƒç”¨çš„ checkerï¼Œä½†è¿™äº›checkerå¹¶ä¸æ˜¯æ‰€æœ‰éƒ½æ˜¯é»˜è®¤å¼€å¯çš„</span></span><br><span class="line">clang -cc1 -analyzer-checker-help</span><br><span class="line">OVERVIEW: Clang Static Analyzer Checkers List</span><br><span class="line"></span><br><span class="line">USAGE: -analyzer-checker &lt;CHECKER or PACKAGE,...&gt;</span><br><span class="line"></span><br><span class="line">CHECKERS:</span><br><span class="line">  alpha.clone.CloneChecker        Reports similar pieces of code.</span><br><span class="line">  alpha.core.BoolAssignment       Warn about assigning non-&#123;0,1&#125; values to Boolean variables</span><br><span class="line">  alpha.core.CallAndMessageUnInitRefArg</span><br><span class="line">                                  Check <span class="keyword">for</span> logical errors <span class="keyword">for</span> <span class="keyword">function</span> calls and Objective-C message expressions (e.g., uninitialized arguments, null <span class="keyword">function</span> pointers, and pointer to undefined variables)</span><br><span class="line">  alpha.core.CastSize             Check when castin</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<a href="http://clang-analyzer.llvm.org.cn/scan-build.html" target="_blank" rel="noopener">scan-build</a>å¯ä»¥ä»å‘½ä»¤è¡Œè¿è¡Œåˆ†æå™¨,ç±»ä¼¼å¦‚ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">scan-build xcodebuild -project asdasd.xcodeproj</span><br><span class="line">scan-build: Using <span class="string">'/usr/local/Cellar/llvm/8.0.0/bin/clang-8'</span> <span class="keyword">for</span> static analysis</span><br><span class="line">Build settings from <span class="built_in">command</span> line:</span><br><span class="line">    CLANG_ANALYZER_EXEC = /usr/<span class="built_in">local</span>/Cellar/llvm/8.0.0/bin/clang-8</span><br><span class="line">    CLANG_ANALYZER_OTHER_FLAGS = </span><br><span class="line">    CLANG_ANALYZER_OUTPUT = plist-html</span><br><span class="line">    CLANG_ANALYZER_OUTPUT_DIR = /var/folders/s6/5jq8fd4x12v9blzt68qbv18m0000gn/T/scan-build-2019-04-18-141047-45509-1</span><br><span class="line">    RUN_CLANG_STATIC_ANALYZER = YES</span><br><span class="line"></span><br><span class="line">note: Using new build system</span><br><span class="line">note: Planning build</span><br><span class="line">note: Constructing build description</span><br><span class="line">Build system information</span><br><span class="line">error: Signing <span class="keyword">for</span> <span class="string">"asdasd"</span> requires a development team. Select a development team <span class="keyword">in</span> the project editor. (<span class="keyword">in</span> target <span class="string">'asdasd'</span>)</span><br><span class="line"></span><br><span class="line">** BUILD FAILED **</span><br><span class="line"></span><br><span class="line">scan-build: Removing directory <span class="string">'/var/folders/s6/5jq8fd4x12v9blzt68qbv18m0000gn/T/scan-build-2019-04-18-141047-45509-1'</span> because it contains no reports.</span><br><span class="line">scan-build: No bugs found.</span><br></pre></td></tr></table></figure>
<p>å…³äºé™æ€åˆ†ææ›´å¤šå¯ä»¥æŸ¥çœ‹ ï¼š<a href="http://clang-analyzer.llvm.org.cn/" target="_blank" rel="noopener">Clang é™æ€åˆ†æå™¨</a></p>
<!-- https://juejin.im/post/5a30ea0ff265da43094526f9 -->
<h3 id="ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ"><a href="#ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ" class="headerlink" title="ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ"></a>ç”Ÿæˆä»£ç å’Œä¼˜åŒ–é˜¶æ®µ</h3><p><strong><em>ä¸€ã€ç”Ÿæˆ LLVM ä»£ç </em></strong></p>
<p>clang å®Œæˆä»£ç çš„æ ‡è®°ï¼Œè§£æå’Œåˆ†æåï¼Œæ¥ç€å°±ä¼šç”Ÿæˆ LLVM ä»£ç ã€‚ä¸‹é¢ç»§ç»­çœ‹çœ‹hello.cï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"hello world\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦æŠŠè¿™æ®µä»£ç ç¼–è¯‘æˆ LLVM å­—èŠ‚ç ï¼ˆç»å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯äºŒè¿›åˆ¶ç æ ¼å¼ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<p><code>clang  -emit-llvm hello.c -c -o hello.bc</code></p>
<p>æ¥ç€ç”¨å¦ä¸€ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹åˆšåˆšç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š</p>
<p><code>llvm-dis &lt; hello.bc | less</code></p>
<p>éƒ¨åˆ†è¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">; ModuleID = '&lt;stdin&gt;'</span><br><span class="line">source_filename = <span class="string">"hello.c"</span></span><br><span class="line">target datalayout = <span class="string">"e-m:o-i64:64-f80:128-n8:16:32:64-S128"</span></span><br><span class="line">target triple = <span class="string">"x86_64-apple-macosx10.13.0"</span></span><br><span class="line"></span><br><span class="line">@.str = <span class="keyword">private</span> unnamed_addr constant [<span class="number">13</span> x i8] c<span class="string">"hello world\0A\00"</span>, align <span class="number">1</span></span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone ssp uwtable</span><br><span class="line">define i32 @main() #<span class="number">0</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* %<span class="number">1</span>, align <span class="number">4</span></span><br><span class="line">  %<span class="number">2</span> = call i32 (i8*, ...) @<span class="built_in">printf</span>(i8* getelementptr inbounds ([<span class="number">13</span> x i8], [<span class="number">13</span> x i8]* @.str, i32 <span class="number">0</span>, i32 <span class="number">0</span>))</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare i32 @<span class="built_in">printf</span>(i8*, ...) #<span class="number">1</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong><em>äºŒã€ä¼˜åŒ– LLVM ä»£ç </em></strong></p>
<p>LLVM ä¼šå»åšäº›ä¼˜åŒ–å·¥ä½œï¼Œåœ¨ Xcode çš„ç¼–è¯‘è®¾ç½®é‡Œä¹Ÿå¯ä»¥è®¾ç½®ä¼˜åŒ–çº§åˆ«-01ï¼Œ-03ï¼Œ-0sï¼Œè¿˜å¯ä»¥å†™äº›è‡ªå·±çš„ Passï¼ŒPasså°±æ˜¯LLVMç³»ç»Ÿè½¬åŒ–å’Œä¼˜åŒ–çš„å·¥ä½œçš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹åšä¸€äº›å·¥ä½œï¼Œè¿™äº›å·¥ä½œåŠ èµ·æ¥å°±æ„æˆäº†LLVMæ•´ä¸ªç³»ç»Ÿçš„ä¼˜åŒ–å’Œè½¬åŒ–ã€‚å®˜æ–¹æœ‰æ¯”è¾ƒå®Œæ•´çš„ Pass æ•™ç¨‹ï¼š <a href="https://releases.llvm.org/5.0.2/docs/WritingAnLLVMPass.html" target="_blank" rel="noopener">Writing an LLVM Pass â€” LLVM 5 documentation</a> ã€‚å¦‚æœå¼€å¯äº† bitcode è‹¹æœä¼šåšè¿›ä¸€æ­¥çš„ä¼˜åŒ–</p>
<p><img src="/res/LLVM/xcode-optimize.png" alt></p>
<p><strong><em>ä¸‰ã€è¾“å‡ºæ±‡ç¼–ä»£ç </em></strong></p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è®©clangè¾“å‡ºæ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¾“å…¥</span></span><br><span class="line"> clang -S -o - hello.c</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">	.section	__TEXT,__text,regular,pure_instructions <span class="comment"># .section æŒ‡ä»¤æŒ‡å®šæ¥ä¸‹æ¥ä¼šæ‰§è¡Œå“ªä¸€ä¸ªæ®µ</span></span><br><span class="line">	.macosx_version_min 10, 13</span><br><span class="line">	.globl	_main           <span class="comment"># .globl æŒ‡ä»¤è¯´æ˜ _main æ˜¯ä¸€ä¸ªå¤–éƒ¨ç¬¦å·</span></span><br><span class="line">	.p2align	4, 0x90     <span class="comment"># .align æŒ‡ä»¤æŒ‡å‡ºäº†åé¢ä»£ç çš„å¯¹é½æ–¹å¼ å¦‚æœéœ€è¦çš„è¯ï¼Œç”¨ 0x90 è¡¥é½</span></span><br><span class="line">_main:                                  <span class="comment">## æ¥ä¸‹æ¥æ˜¯ main å‡½æ•°çš„å¤´éƒ¨ï¼š</span></span><br><span class="line">	.cfi_startproc          <span class="comment"># .cfi_startproc æŒ‡ä»¤é€šå¸¸ç”¨äºå‡½æ•°çš„å¼€å§‹å¤„</span></span><br><span class="line"><span class="comment">## %bb.0:</span></span><br><span class="line">	pushq	%rbp    <span class="comment"># rbp å¯„å­˜å™¨ (åŸºç¡€æŒ‡é’ˆå¯„å­˜å™¨ base pointer register)</span></span><br><span class="line">	.cfi_def_cfa_offset 16</span><br><span class="line">	.cfi_offset %rbp, -16</span><br><span class="line">	movq	%rsp, %rbp</span><br><span class="line">	.cfi_def_cfa_register %rbp</span><br><span class="line">	subq	<span class="variable">$16</span>, %rsp</span><br><span class="line">	movl	<span class="variable">$0</span>, -4(%rbp)</span><br><span class="line">	leaq	L_.str(%rip), %rdi</span><br><span class="line">	movb	<span class="variable">$0</span>, %al</span><br><span class="line">	callq	_printf <span class="comment">#è°ƒç”¨äº† printf</span></span><br><span class="line">	xorl	%ecx, %ecx</span><br><span class="line">	movl	%eax, -8(%rbp)          <span class="comment">## 4-byte Spill</span></span><br><span class="line">	movl	%ecx, %eax</span><br><span class="line">	addq	<span class="variable">$16</span>, %rsp</span><br><span class="line">	popq	%rbp <span class="comment"># ä¸pushqå¯¹åº”</span></span><br><span class="line">	retq</span><br><span class="line">	.cfi_endproc <span class="comment"># ä¸ .cfi_startproc ç›¸åŒ¹é…ï¼Œä»¥æ­¤æ ‡è®°å‡º main() å‡½æ•°ç»“æŸ</span></span><br><span class="line">                                        <span class="comment">## -- End function</span></span><br><span class="line">	.section	__TEXT,__cstring,cstring_literals <span class="comment"># __TEXT __cstring å¼€å¯äº†ä¸€ä¸ªæ–°çš„æ®µã€‚</span></span><br><span class="line">L_.str:       <span class="comment">#L_.str æ ‡è®°è¿è¡Œåœ¨å®é™…çš„ä»£ç ä¸­è·å–åˆ°å­—ç¬¦ä¸²çš„ä¸€ä¸ªæŒ‡é’ˆ                          ## @.str</span></span><br><span class="line">	.asciz	<span class="string">"hello world\n"</span> <span class="comment">#.asciz æŒ‡ä»¤å‘Šè¯‰ç¼–è¯‘å™¨è¾“å‡ºä¸€ä¸ªä»¥ â€˜\0â€™ (null) ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.subsections_via_symbolsv <span class="comment"># .subsections_via_symbols æŒ‡ä»¤æ˜¯é™æ€é“¾æ¥ç¼–è¾‘å™¨ä½¿ç”¨çš„ã€‚</span></span><br></pre></td></tr></table></figure>
<p>å…·ä½“çš„ä»£ç è§£è¯»ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åˆ°<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Reference/Assembler/000-Introduction/introduction.html" target="_blank" rel="noopener">è‹¹æœçš„ OS X Assembler Reference </a> äº†è§£è¯¦ç»†ã€‚</p>
<!-- https://objccn.io/issue-6-3/ -->
<h3 id="æ±‡ç¼–å™¨"><a href="#æ±‡ç¼–å™¨" class="headerlink" title="æ±‡ç¼–å™¨"></a>æ±‡ç¼–å™¨</h3><p>æ±‡ç¼–å™¨å°†å¯è¯»çš„æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨ä»£ç ã€‚å®ƒä¼šåˆ›å»ºä¸€ä¸ªç›®æ ‡å¯¹è±¡æ–‡ä»¶ï¼Œä¸€èˆ¬ç®€ç§°ä¸º å¯¹è±¡æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶ä»¥ .o ç»“å°¾ã€‚å¦‚æœç”¨ Xcode æ„å»ºåº”ç”¨ç¨‹åºï¼Œå¯ä»¥åœ¨å·¥ç¨‹çš„ derived data ç›®å½•ä¸­ï¼ŒObjects-normal æ–‡ä»¶å¤¹ä¸‹æ‰¾åˆ°è¿™äº›æ–‡ä»¶ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä¾‹å¦‚ ç”Ÿæˆ main.oæ–‡ä»¶</span></span><br><span class="line">clang -fmodules -c main.c -o main.o</span><br></pre></td></tr></table></figure>
<h3 id="é“¾æ¥å™¨"><a href="#é“¾æ¥å™¨" class="headerlink" title="é“¾æ¥å™¨"></a>é“¾æ¥å™¨</h3><p>é“¾æ¥å™¨è§£å†³äº†ç›®æ ‡æ–‡ä»¶å’Œåº“ä¹‹é—´çš„é“¾æ¥ã€‚ä¾‹å¦‚ä¸Šé¢æ±‡ç¼–ä»£ç ä¸­ <code>callq   _printf</code>ï¼Œ <code>printf()</code> æ˜¯ libc åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚æ— è®ºæ€æ ·ï¼Œæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶éœ€è¦èƒ½éœ€è¦çŸ¥é“ printf() åœ¨å†…å­˜ä¸­çš„å…·ä½“ä½ç½®ï¼šä¾‹å¦‚ï¼Œ_printf çš„åœ°å€ç¬¦å·æ˜¯ä»€ä¹ˆã€‚é“¾æ¥å™¨ä¼šè¯»å–æ‰€æœ‰çš„ç›®æ ‡æ–‡ä»¶ (æ­¤å¤„åªæœ‰ä¸€ä¸ª) å’Œåº“ (æ­¤å¤„æ˜¯ libc)ï¼Œå¹¶è§£å†³æ‰€æœ‰æœªçŸ¥ç¬¦å· (æ­¤å¤„æ˜¯ _printf) çš„é—®é¢˜ã€‚ç„¶åå°†å®ƒä»¬ç¼–ç è¿›æœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ ï¼ˆå¯ä»¥åœ¨ libc ä¸­æ‰¾åˆ°ç¬¦å· _printfï¼‰ï¼Œæ¥ç€é“¾æ¥å™¨ä¼šè¾“å‡ºå¯ä»¥è¿è¡Œçš„æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç”Ÿæˆ hello.out çš„ Mach-O äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">clang hello.c -o hello.out</span><br></pre></td></tr></table></figure>
<p>å…³äº<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" target="_blank" rel="noopener">Mach-Oæ–‡ä»¶æ ¼å¼</a>æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥é€šè¿‡appleæ–‡æ¡£æ¥äº†è§£ã€‚</p>
<p>è¿™é‡Œè¯´ hello.out æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡<code>file</code>æ¥åˆ¤æ–­:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">file hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º</span></span><br><span class="line">hello.out: Mach-O 64-bit executable x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ‰§è¡Œhello.out</span></span><br><span class="line">./hello.out</span><br><span class="line"><span class="comment">#è¾“å‡º </span></span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<h2 id="ç¼–è¯‘å¤šä¸ªæ–‡ä»¶"><a href="#ç¼–è¯‘å¤šä¸ªæ–‡ä»¶" class="headerlink" title="ç¼–è¯‘å¤šä¸ªæ–‡ä»¶"></a>ç¼–è¯‘å¤šä¸ªæ–‡ä»¶</h2><p>ä¹‹å‰ä¸Šé¢æˆ‘ä»¬çš„å®éªŒéƒ½æ˜¯ä½¿ç”¨å•ä¸ªhello.cæ–‡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬é€šè¿‡å¤šä¸ªæ–‡ä»¶æƒ…å†µ äº†è§£ä¸‹æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨ ,å¦‚ä¸‹ä¸‰ä¸ªæ–‡ä»¶ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//File1.h:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Foo</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//File1.m:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"File1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Foo</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="built_in">NSFullUserName</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//File2.m:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"File1.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        Foo *foo = [[Foo alloc] init];</span><br><span class="line">        [foo run];</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œéœ€è¦æˆ‘ä»¬ç¼–è¯‘å¤šä¸ªæ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦è®©clangå¯¹è¾“å…¥æ¯ä¸ªæ–‡ä»¶ç”Ÿæˆå¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># clang  -c Only run preprocess, compile, and assemble steps</span></span><br><span class="line"></span><br><span class="line">clang -c File1.m <span class="comment">#ç”Ÿæˆ File1.o</span></span><br><span class="line">clang -c File2.m <span class="comment">#ç”Ÿæˆ File2.o</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬åŠ äº†<code>-c</code> å¹¶æ²¡æœ‰ç¼–è¯‘å¤´æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬æ¥å®Œæˆ<code>é“¾æ¥å™¨</code>è¿™ä¸€æ­¥,å°†ä¸¤ä¸ª .o æ–‡ä»¶ä¸Foundationåº“é“¾æ¥èµ·æ¥ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  -Wl,&lt;arg&gt;               Pass the comma separated arguments in &lt;arg&gt; to the linker</span></span><br><span class="line">clang File1.o File2.o -Wl,`xcrun --show-sdk-path`/System/Library/Frameworks/Foundation.framework/Foundation</span><br><span class="line"><span class="comment"># è¾“å‡º a.out</span></span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œ <code>a.out</code> äº†ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./a.out </span><br><span class="line">2019-04-16 20:49:35.070 a.out[71207:10299638] sunTongSheng</span><br></pre></td></tr></table></figure>
<h3 id="ç¬¦å·è¡¨å’Œé“¾æ¥"><a href="#ç¬¦å·è¡¨å’Œé“¾æ¥" class="headerlink" title="ç¬¦å·è¡¨å’Œé“¾æ¥"></a>ç¬¦å·è¡¨å’Œé“¾æ¥</h3><p>File1 å’Œ File2 éƒ½ä½¿ç”¨äº† Foundation frameworkã€‚ File2.o ç›®æ ‡æ–‡ä»¶ä½¿ç”¨äº†å®ƒçš„ autorelease poolï¼Œå¹¶é—´æ¥çš„ä½¿ç”¨äº† libobjc.dylib ä¸­çš„ Objective-C è¿è¡Œæ—¶ã€‚å®ƒéœ€è¦è¿è¡Œæ—¶å‡½æ•°æ¥è¿›è¡Œæ¶ˆæ¯çš„è°ƒç”¨ã€‚æ‰€æœ‰çš„è¿™äº›å…³è”çš„ä¸œè¥¿éƒ½è¢«å½¢è±¡çš„ç§°ä¹‹ä¸ºç¬¦å·ã€‚</p>
<p>æ¯ä¸ªå‡½æ•°ã€å…¨å±€å˜é‡å’Œç±»ç­‰éƒ½æ˜¯é€šè¿‡ç¬¦å·çš„å½¢å¼æ¥å®šä¹‰å’Œä½¿ç”¨çš„ã€‚å½“æˆ‘ä»¬å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé“¾æ¥å™¨åœ¨ç›®æ ‡æ–‡ä»¶å’ŒåŠ¨æ€åº“ä¹‹é—´å¯¹ç¬¦å·åšäº†è§£æå¤„ç†ã€‚</p>
<p>å¯æ‰§è¡Œæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼Œè¿™ä¸ªç¬¦å·è¡¨è§„å®šäº†å®ƒä»¬çš„ç¬¦å·ã€‚å¦‚æœæˆ‘ä»¬ç”¨ nm å·¥å…·è§‚å¯Ÿä¸€ä¸‹ File2.o ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#nm : llvm symbol table dumper</span></span><br><span class="line">nm -nm File2.o</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br><span class="line">                 (undefined) external _objc_alloc</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPop</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPush</span><br><span class="line">                 (undefined) external _objc_msgSend</span><br><span class="line">0000000000000000 (__TEXT,__text) external _main</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å°±æ˜¯é‚£ä¸ªç›®æ ‡æ–‡ä»¶çš„æ‰€æœ‰ç¬¦å·ã€‚_OBJC_CLASS_$_Foo æ˜¯ Foo Objective-C ç±»çš„ç¬¦å·ã€‚è¯¥ç¬¦å·æ˜¯ undefined, external ã€‚External çš„æ„æ€æ˜¯æŒ‡å¯¹äºè¿™ä¸ªç›®æ ‡æ–‡ä»¶è¯¥ç±»å¹¶ä¸æ˜¯ç§æœ‰çš„ï¼Œç›¸åï¼Œnon-external çš„ç¬¦å·åˆ™è¡¨ç¤ºå¯¹äºç›®æ ‡æ–‡ä»¶æ˜¯ç§æœ‰çš„ã€‚æˆ‘ä»¬çš„ File2.o ç›®æ ‡æ–‡ä»¶å¼•ç”¨äº†ç±» Fooï¼Œä¸è¿‡è¿™å¹¶æ²¡æœ‰å®ç°å®ƒã€‚å› æ­¤ç¬¦å·è¡¨ä¸­å°†å…¶æ ‡ç¤ºä¸º undefinedã€‚æ¥ç€æ˜¯ 4 ä¸ª Objective-C è¿è¡Œæ—¶å‡½æ•°ã€‚å®ƒä»¬åŒæ ·æ˜¯ undefinedçš„ï¼Œéœ€è¦é“¾æ¥å™¨è¿›è¡Œç¬¦å·è§£æã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯ _main ç¬¦å·ï¼Œå®ƒæ˜¯è¡¨ç¤º main() å‡½æ•°ï¼ŒåŒæ ·ä¸º externalï¼Œè¿™æ˜¯å› ä¸ºè¯¥å‡½æ•°éœ€è¦è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åº”è¯¥ä¸ºå¯è§çš„ã€‚ç”±äºåœ¨ helloworld.o æ–‡ä»¶ä¸­å®ç°äº† è¿™ä¸ª main å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åœ°å€ä½äº 0å¤„ï¼Œå¹¶ä¸”éœ€è¦è½¬å…¥åˆ° <strong>TEXT,</strong>text sectionã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ä¸‹ <code>File1.o</code>,çœ‹çœ‹æœ‰ä»€ä¹ˆè¾“å‡ºï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nm -nm File1.o</span><br><span class="line">                 (undefined) external _NSFullUserName</span><br><span class="line">                 (undefined) external _NSLog</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_NSObject</span></span><br><span class="line">                 (undefined) external _OBJC_METACLASS_<span class="variable">$_NSObject</span></span><br><span class="line">                 (undefined) external ___CFConstantStringClassReference</span><br><span class="line">                 (undefined) external __objc_empty_cache</span><br><span class="line">0000000000000000 (__TEXT,__text) non-external -[Foo run]</span><br><span class="line">0000000000000060 (__DATA,__objc_const) non-external l_OBJC_METACLASS_RO_<span class="variable">$_Foo</span></span><br><span class="line">00000000000000a8 (__DATA,__objc_const) non-external l_OBJC_<span class="variable">$_INSTANCE_METHODS_Foo</span></span><br><span class="line">00000000000000c8 (__DATA,__objc_const) non-external l_OBJC_CLASS_RO_<span class="variable">$_Foo</span></span><br><span class="line">0000000000000110 (__DATA,__objc_data) external _OBJC_METACLASS_<span class="variable">$_Foo</span></span><br><span class="line">0000000000000138 (__DATA,__objc_data) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br></pre></td></tr></table></figure>
<p>File1.o åŒæ ·æœ‰ undefined çš„ç¬¦å·ã€‚é¦–å…ˆæ˜¯ä½¿ç”¨äº†ç¬¦å· <code>NSFullUserName()</code>ï¼Œ<code>NSLog()</code>å’Œ <code>NSObject</code>ã€‚æ¥ç€æ˜¾ç¤ºäº† <code>_OBJC_CLASS_$_Foo</code> å·²ç»å®šä¹‰äº†ï¼Œå¹¶ä¸”å¯¹äº File1.o æ˜¯ä¸€ä¸ªå¤–éƒ¨ç¬¦å· , <code>File1.o</code> åŒ…å«äº†è¿™ä¸ªç±»çš„å®ç°ã€‚</p>
<p>æœ€åå…ˆæ¥åŒæ ·çœ‹ä¸‹ a.out çš„è¾“å‡ºï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nm -nm a.out </span><br><span class="line">                 (undefined) external _NSFullUserName (from Foundation)</span><br><span class="line">                 (undefined) external _NSLog (from Foundation)</span><br><span class="line">                 (undefined) external _OBJC_CLASS_<span class="variable">$_NSObject</span> (from CoreFoundation)</span><br><span class="line">                 (undefined) external _OBJC_METACLASS_<span class="variable">$_NSObject</span> (from CoreFoundation)</span><br><span class="line">                 (undefined) external ___CFConstantStringClassReference (from CoreFoundation)</span><br><span class="line">                 (undefined) external __objc_empty_cache (from libobjc)</span><br><span class="line">                 (undefined) external _objc_alloc (from libobjc)</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPop (from libobjc)</span><br><span class="line">                 (undefined) external _objc_autoreleasePoolPush (from libobjc)</span><br><span class="line">                 (undefined) external _objc_msgSend (from libobjc)</span><br><span class="line">                 (undefined) external dyld_stub_binder (from libSystem)</span><br><span class="line">0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header</span><br><span class="line">0000000100000e90 (__TEXT,__text) non-external -[Foo run]</span><br><span class="line">0000000100000ec0 (__TEXT,__text) external _main</span><br><span class="line">0000000100001138 (__DATA,__objc_data) external _OBJC_METACLASS_<span class="variable">$_Foo</span></span><br><span class="line">0000000100001160 (__DATA,__objc_data) external _OBJC_CLASS_<span class="variable">$_Foo</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>a.out</code>çš„ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿé“¾æ¥å™¨æ˜¯å¦‚ä½•è§£ææ‰€æœ‰ç¬¦å·è¡¨çš„ã€‚å½“æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªç›®æ ‡æ–‡ä»¶å’Œ Foundation framework (æ˜¯ä¸€ä¸ªåŠ¨æ€åº“) è¿›è¡Œé“¾æ¥å¤„ç†æ—¶ï¼Œé“¾æ¥å™¨ä¼šå°è¯•è§£ææ‰€æœ‰çš„ undefined ç¬¦å·ã€‚å®ƒå¯ä»¥è§£æ _OBJC_CLASS_$_Fooã€‚å¦å¤–ï¼Œå®ƒå°†ä½¿ç”¨ Foundation frameworkã€‚å½“é“¾æ¥å™¨é€šè¿‡åŠ¨æ€åº“ (æ­¤å¤„æ˜¯ Foundation framework) è§£ææˆåŠŸä¸€ä¸ªç¬¦å·æ—¶ï¼Œå®ƒä¼šåœ¨æœ€ç»ˆçš„é“¾æ¥å›¾ä¸­è®°å½•è¿™ä¸ªç¬¦å·æ˜¯é€šè¿‡åŠ¨æ€åº“è¿›è¡Œè§£æçš„ã€‚é“¾æ¥å™¨ä¼šè®°å½•è¾“å‡ºæ–‡ä»¶æ˜¯ä¾èµ–äºå“ªä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œå¹¶è¿åŒå…¶è·¯å¾„ä¸€èµ·è¿›è¡Œè®°å½•ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ_NSFullUserNameï¼Œ_NSLogï¼Œ_OBJC_CLASS_$_NSObjectï¼Œ_objc_autoreleasePoolPop ç­‰ç¬¦å·éƒ½æ˜¯éµå¾ªè¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>è™½ç„¶æ‰€æœ‰çš„ Foundation å’Œ Objective-C è¿è¡Œæ—¶ç¬¦å·ä¾æ—§æ˜¯ undefinedï¼Œä¸è¿‡ç°åœ¨çš„ç¬¦å·è¡¨ä¸­å·²ç»å¤šäº†å¦‚ä½•è§£æå®ƒä»¬çš„ä¿¡æ¯ï¼Œä¾‹å¦‚åœ¨å“ªä¸ªåŠ¨æ€åº“ä¸­å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·ã€‚</p>
<p>å¯æ‰§è¡Œæ–‡ä»¶åŒæ ·çŸ¥é“å»å“ªé‡Œæ‰¾åˆ°æ‰€éœ€åº“ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">otool -L a.out </span><br><span class="line">a.out:</span><br><span class="line">	/System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 1560.12.0)</span><br><span class="line">	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.50.4)</span><br><span class="line">	/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 1454.90.0)</span><br><span class="line">	/usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)</span><br></pre></td></tr></table></figure>
<h3 id="åŠ¨æ€é“¾æ¥å™¨"><a href="#åŠ¨æ€é“¾æ¥å™¨" class="headerlink" title="åŠ¨æ€é“¾æ¥å™¨"></a>åŠ¨æ€é“¾æ¥å™¨</h3><p>åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨dyldå¯ä»¥è§£æè¿™äº› <code>undefined</code> ç¬¦å·ï¼Œdyldå°†ä¼šç¡®å®šå¥½ <code>_NSFullUserName</code> ç­‰ç¬¦å·ï¼Œå¹¶æŒ‡å‘å®ƒä»¬åœ¨ <code>Foundation</code> ä¸­çš„å®ç°ç­‰ã€‚<br>ä¸Šé¢æåˆ°æ–‡ä»¶ç¬¦å·è¡¨æŒ‡å‘äº†éœ€è¦çš„åº“ï¼Œæ·»åŠ <code>DYLD_PRINT_LIBRARIES</code>ç¯å¢ƒå˜é‡å¯ä»¥æ‰“å°å‡ºä»€ä¹ˆåº“è¢«åŠ è½½äº†ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">export</span> DYLD_PRINT_LIBRARIES=; ./a.out )</span><br><span class="line">dyld: loaded: /Users/suntongsheng/Desktop/tmp/asdasd/Test/./a.out</span><br><span class="line">dyld: loaded: /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation</span><br><span class="line">dyld: loaded: /usr/lib/libSystem.B.dylib</span><br><span class="line">dyld: loaded: /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚å¯ä»¥é’ˆå¯¹ Foundation è¿è¡Œ <code>nm</code>ï¼Œå¹¶æ£€æŸ¥è¿™äº›ç¬¦å·çš„å®šä¹‰æƒ…å†µï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nm -nm /System/Library/Frameworks/Foundation.framework/Foundation | grep NSFullUserName</span><br><span class="line">00000000000bb1be (__TEXT,__text) external _NSFullUserName</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å°†ä¼šæ˜¾ç¤ºå‡ºåœ¨åŠ è½½ Foundation æ—¶ï¼ŒåŒæ—¶ä¼šåŠ è½½çš„ 70 ä¸ªåŠ¨æ€åº“ã€‚è¿™æ˜¯ç”±äº Foundation ä¾èµ–äºå¦å¤–ä¸€äº›åŠ¨æ€åº“ã€‚è¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">xcrun otool -L /System/Library/Frameworks/Foundation.framework/Foundation</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ° Foundation å…³è”çš„åº“ã€‚</p>
<p><strong><em>åŠ¨æ€é“¾æ¥å™¨dyld çš„å…±äº«ç¼“å­˜</em></strong></p>
<p>å½“ä½ æ„å»ºä¸€ä¸ªçœŸæ­£çš„ç¨‹åºæ—¶ï¼Œå°†ä¼šé“¾æ¥å„ç§å„æ ·çš„åº“ã€‚å®ƒä»¬åˆä¼šä¾èµ–å…¶ä»–ä¸€äº› framework å’Œ åŠ¨æ€åº“ã€‚éœ€è¦åŠ è½½çš„åŠ¨æ€åº“ä¼šéå¸¸å¤šã€‚è€Œå¯¹äºç›¸äº’ä¾èµ–çš„ç¬¦å·å°±æ›´å¤šäº†ã€‚å¯èƒ½å°†ä¼šæœ‰ä¸Šåƒä¸ªç¬¦å·éœ€è¦è§£æå¤„ç†ï¼Œè¿™å°†èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ï¼šä¸€èˆ¬æ˜¯å¥½å‡ ç§’é’Ÿã€‚</p>
<p>ä¸ºäº†ç¼©çŸ­è¿™ä¸ªå¤„ç†è¿‡ç¨‹æ‰€èŠ±è´¹æ—¶é—´ï¼Œåœ¨ OS X å’Œ iOS ä¸Šçš„åŠ¨æ€é“¾æ¥å™¨ä½¿ç”¨äº†å…±äº«ç¼“å­˜ï¼Œå…±äº«ç¼“å­˜å­˜äº /var/db/dyld/ã€‚å¯¹äºæ¯ä¸€ç§æ¶æ„ï¼Œæ“ä½œç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­åŒ…å«äº†ç»å¤§å¤šæ•°çš„åŠ¨æ€åº“ï¼Œè¿™äº›åº“éƒ½å·²ç»é“¾æ¥ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶ä¸”å·²ç»å¤„ç†å¥½äº†å®ƒä»¬ä¹‹é—´çš„ç¬¦å·å…³ç³»ã€‚å½“åŠ è½½ä¸€ä¸ª Mach-O æ–‡ä»¶ (ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶æˆ–è€…ä¸€ä¸ªåº“) æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨é¦–å…ˆä¼šæ£€æŸ¥ å…±äº«ç¼“å­˜ çœ‹çœ‹æ˜¯å¦å­˜åœ¨å…¶ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå°±ç›´æ¥ä»å…±äº«ç¼“å­˜ä¸­æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æŠŠè¿™ä¸ªå…±äº«ç¼“å­˜æ˜ å°„åˆ°äº†è‡ªå·±çš„åœ°å€ç©ºé—´ä¸­ã€‚è¿™ä¸ªæ–¹æ³•å¤§å¤§ä¼˜åŒ–äº† OS X å’Œ iOS ä¸Šç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€‚</p>
<h2 id="æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š"><a href="#æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š" class="headerlink" title="æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š"></a>æœ€åæ€»ç»“ä¸€ä¸‹å°±æ˜¯ä»¥ä¸‹ç¼–è¯‘è¿‡ç¨‹ï¼š</h2><p><img src="/res/LLVM/llvm1.png" alt></p>
<h2 id="Xcode-ç¼–è¯‘"><a href="#Xcode-ç¼–è¯‘" class="headerlink" title="Xcode ç¼–è¯‘"></a>Xcode ç¼–è¯‘</h2><p>ä»¥ä¸Šè¯´çš„æ˜¯Clangå¦‚ä½•ç¼–è¯‘Cè¯­è¨€æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆåœ¨Xcodeé‡Œä¼šç»è¿‡å“ªäº›è¿‡ç¨‹å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬å¯ä»¥ç®€å•æ–°å»ºä¸€ä¸ªå•é¡µé¢å·¥ç¨‹ï¼ŒBuildååœ¨Report Navigationè§†å›¾ä¸­æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š</p>
<p><img src="/res/LLVM/xcode.png" alt></p>
<p>è¯¦ç»†çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºæ–‡ä»¶å¤¹</li>
<li>æŠŠEntitlements.plistå†™å…¥åˆ°DerivedDataé‡Œï¼Œå¤„ç†æ‰“åŒ…çš„æ—¶å€™éœ€è¦çš„ä¿¡æ¯ï¼ˆæ¯”å¦‚application-identifierï¼‰ã€‚</li>
<li>åˆ›å»ºä¸€äº›è¾…åŠ©æ–‡ä»¶ï¼Œæ¯”å¦‚å„ç§.hmap (headermapæ˜¯å¸®åŠ©ç¼–è¯‘å™¨æ‰¾åˆ°å¤´æ–‡ä»¶çš„è¾…åŠ©æ–‡ä»¶ï¼šå­˜å‚¨è¿™å¤´æ–‡ä»¶åˆ°å…¶ç‰©ç†è·¯å¾„çš„æ˜ å°„å…³ç³»)</li>
<li>ç¼–è¯‘.mæ–‡ä»¶ï¼Œç”Ÿæˆ.oæ–‡ä»¶ã€‚</li>
<li>é“¾æ¥åŠ¨æ€åº“ï¼Œoæ–‡ä»¶ï¼Œç”Ÿæˆä¸€ä¸ªmach oæ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li>
<li>ç¼–è¯‘assetsï¼Œç¼–è¯‘storyboardï¼Œé“¾æ¥storyboard</li>
<li>å¯¹Appç­¾å</li>
<li>ç”Ÿæˆ .app</li>
</ol>
<p>åœ¨ build å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½ä¼šå‡ºç°ç±»ä¼¼ä¸Šé¢çš„è¿™äº› log ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±é€šè¿‡ä¸Šé¢çš„ log ä¿¡æ¯è¿›ä¸€æ­¥äº†è§£è¯¦æƒ…ã€‚</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>LLVM</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -SDWebImageDecoder</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-SDWebImageDecoder/</url>
    <content><![CDATA[<p>ç”±äºUIImageçš„imageWithDataå‡½æ•°æ˜¯æ¯æ¬¡ç”»å›¾çš„æ—¶å€™æ‰å°†Dataè§£å‹æˆARGBçš„å›¾åƒï¼Œ</p>
<p>æ‰€ä»¥åœ¨æ¯æ¬¡ç”»å›¾çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€ä¸ªè§£å‹æ“ä½œï¼Œè¿™æ ·æ•ˆç‡å¾ˆä½ï¼Œä½†æ˜¯åªæœ‰ç¬æ—¶çš„å†…å­˜éœ€æ±‚ã€‚</p>
<p>ä¸ºäº†æé«˜æ•ˆç‡é€šè¿‡SDWebImageDecoderå°†åŒ…è£…åœ¨Dataä¸‹çš„èµ„æºè§£å‹ï¼Œç„¶åç”»åœ¨å¦å¤–ä¸€å¼ å›¾ç‰‡ä¸Šï¼Œè¿™æ ·è¿™å¼ æ–°å›¾ç‰‡å°±ä¸å†éœ€è¦é‡å¤è§£å‹äº†ã€‚</p>
<p>è¿™ç§åšæ³•æ˜¯å…¸å‹çš„ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ã€‚</p>
<p>é¦–å…ˆNSURLCacheæ˜¯ç¼“å­˜åŸå§‹æ•°æ®(raw data)åˆ°ç£ç›˜æˆ–å†…å­˜ï¼Œå› æ­¤æ¯æ¬¡ä½¿ç”¨çš„æ—¶å€™éœ€è¦å°†åŸå§‹æ•°æ®è½¬æ¢æˆå…·ä½“çš„å¯¹è±¡ï¼Œå¦‚UIImageç­‰ï¼Œè¿™ä¼šå¯¼è‡´é¢å¤–çš„æ•°æ®è§£æä»¥åŠå†…å­˜å ç”¨ç­‰ï¼Œè€ŒSDWebImageåˆ™æ˜¯ç¼“å­˜UIImageå¯¹è±¡åœ¨å†…å­˜ï¼Œç¼“å­˜åœ¨NSCacheä¸­ï¼ŒåŒæ—¶ç›´æ¥ä¿å­˜å‹ç¼©è¿‡çš„å›¾ç‰‡åˆ°ç£ç›˜ä¸­ï¼›è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯å½“ä½ ç¬¬ä¸€æ¬¡åœ¨UIImageViewä¸­ä½¿ç”¨imageå¯¹è±¡çš„æ—¶å€™ï¼Œå›¾ç‰‡çš„è§£ç æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼è€ŒSDWebImageä¼šå¼ºåˆ¶å°†è§£ç æ“ä½œæ”¾åˆ°å­çº¿ç¨‹ä¸­ã€‚</p>
<p>ä»¥ä¸Šè®°å½•ä¸‹æ¥å¤‡å¿˜ è¿˜ä¸æ˜¯å¾ˆç†è§£æ€ä¹ˆå›äº‹</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>Instrumentså®è·µ-è§£å†³å¡é¡¿ ä½¿ä½ çš„ç•Œé¢ä¿æŒæµç•…</title>
    <url>/essay/Instruments/Instruments3/</url>
    <content><![CDATA[<p>ç»“åˆInstrument CoreAnimationåˆ†æå½±å“æ€§èƒ½çš„å› ç´ ï¼š <strong>å›¾å±‚æ··åˆ</strong>,<strong>å…‰æ …åŒ–</strong>,<strong>é¢œè‰²æ ¼å¼</strong>,<strong>å›¾ç‰‡å¤§å°</strong>,<strong>ç¦»å±æ¸²æŸ“</strong></p>
<p>åœ¨ä½¿ç”¨UIKitçš„è¿‡ç¨‹ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–æ˜¯æ°¸æ’çš„è¯é¢˜ã€‚å¾ˆå¤šäººéƒ½çœ‹è¿‡åˆ†æä¼˜åŒ–æ»‘åŠ¨æ€§èƒ½çš„æ–‡ç« ï¼Œä½†å…¶ä¸­ä¸å°‘æ–‡ç« åªä»‹ç»äº†ä¼˜åŒ–æ–¹æ³•å´å¯¹èƒŒåçš„åŸç†é¿è€Œä¸è°ˆï¼Œæˆ–è€…æ˜¯æ™¦æ¶©éš¾æ‡‚è€Œä¸”è¯»è€…ç¼ºä¹å®è·µä½“éªŒçš„æœºä¼šã€‚ä¸å¦¨æ€è€ƒä¸€ä¸‹ä¸‹é¢çš„é—®é¢˜è‡ªå·±æ˜¯å¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„è®¤è¯†ï¼š</p>
<ol>
<li>ä¸ºä»€ä¹ˆè¦æŠŠæ§ä»¶å°½é‡è®¾ç½®æˆä¸é€æ˜çš„ï¼Œå¦‚æœæ˜¯é€æ˜çš„ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆcellä¸­çš„å›¾ç‰‡ï¼Œå°½å¯èƒ½è¦ä½¿ç”¨æ­£ç¡®çš„å¤§å°ã€æ ¼å¼ï¼Œå¦‚æœé”™è¯¯ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œå¦‚ä½•æ£€æµ‹è¿™ç§å½±å“ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆè®¾ç½®é˜´å½±å’Œåœ†è§’æœ‰å¯èƒ½å½±å“æ»‘åŠ¨æ—¶æµç•…åº¦ï¼Ÿ</li>
<li>shouldRasterizeå’Œç¦»å±æ¸²æŸ“çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶åº”è¯¥ä½¿ç”¨ï¼Ÿ</li>
</ol>
<a id="more"></a>
<p><img src="/res/Instrument/9.png" width="80%"></p>
<p>æ‰“å¼€CoreAnimationå¯ä»¥çœ‹åˆ°ä¸»ä½“çš„PFSæ•°æ®å’Œå³è¾¹çš„Debug Optionsã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ä»»ä½•å±å¹•æ€»æ˜¯æœ‰ä¸€ä¸ªåˆ·æ–°ç‡ï¼Œæ¯”å¦‚iphoneæ¨èçš„åˆ·æ–°ç‡æ˜¯60Hzï¼Œä¹Ÿå°±æ˜¯è¯´GPUæ¯ç§’é’Ÿåˆ·æ–°å±å¹•60æ¬¡ï¼Œå› æ­¤ä¸¤æ¬¡åˆ·æ–°ä¹‹é—´çš„é—´éš”ä¸º16.67msã€‚è¿™æ®µæ—¶é—´å†…å±å¹•å†…å®¹ä¿æŒä¸å˜ï¼Œç§°ä¸ºä¸€å¸§(frame)ï¼Œfpsè¡¨ç¤ºframes per secondï¼Œä¹Ÿå°±æ˜¯æ¯ç§’é’Ÿæ˜¾ç¤ºå¤šå°‘å¸§ç”»é¢ã€‚å¯¹äºé™æ­¢ä¸å˜çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å®ƒçš„åˆ·æ–°ç‡ï¼Œä½†åœ¨æ‰§è¡ŒåŠ¨ç”»æˆ–æ»‘åŠ¨æ—¶ï¼Œfpsçš„å€¼ç›´æ¥åæ˜ å‡ºæ»‘åŠ¨çš„æµç•…ç¨‹åº¦ã€‚</p>
<h2 id="å›¾å±‚æ··åˆ"><a href="#å›¾å±‚æ··åˆ" class="headerlink" title="å›¾å±‚æ··åˆ"></a>å›¾å±‚æ··åˆ</h2><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½åƒç´ çš„æ¦‚å¿µï¼Œå±å¹•ä¸Šæ¯ä¸€ä¸ªç‚¹éƒ½æ˜¯ä¸€ä¸ªåƒç´ ï¼Œåƒç´ æœ‰Rã€Gã€Bä¸‰ç§é¢œè‰²æ„æˆ(æœ‰æ—¶å€™è¿˜å¸¦æœ‰alphaå€¼)ã€‚å¦‚æœæŸä¸€å—åŒºåŸŸä¸Šè¦†ç›–äº†å¤šä¸ªlayer,æœ€åçš„æ˜¾ç¤ºæ•ˆæœå—åˆ°è¿™äº›layerçš„å…±åŒå½±å“ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šå±‚æ˜¯è“è‰²(RGB=0,0,1),é€æ˜åº¦ä¸º50%ï¼Œä¸‹å±‚æ˜¯çº¢è‰²(RGB=1,0,0)ã€‚é‚£ä¹ˆæœ€ç»ˆçš„æ˜¾ç¤ºæ•ˆæœæ˜¯ç´«è‰²(RGB=0.5,0,0.5)ã€‚è¿™ç§é¢œè‰²çš„æ··åˆ(blending)éœ€è¦æ¶ˆè€—ä¸€å®šçš„GPUèµ„æºï¼Œå› ä¸ºå®é™…ä¸Šå¯èƒ½ä¸æ­¢åªæœ‰ä¸¤å±‚ã€‚å¦‚æœåªæƒ³æ˜¾ç¤ºæœ€ä¸Šå±‚çš„è“è‰²ï¼Œå¯ä»¥æŠŠå®ƒçš„é€æ˜åº¦è®¾ç½®ä¸º100%ï¼Œè¿™æ ·GPUä¼šå¿½ç•¥ä¸‹é¢æ‰€æœ‰çš„layerï¼Œä»è€ŒèŠ‚çº¦äº†å¾ˆå¤šä¸å¿…è¦çš„è¿ç®—ã€‚</p>
<p>ç¬¬ä¸€ä¸ªè°ƒè¯•é€‰é¡¹â€Color Blended Layersâ€æ­£æ˜¯ç”¨äºæ£€æµ‹å“ªé‡Œå‘ç”Ÿäº†å›¾å±‚æ··åˆï¼Œå¹¶ç”¨çº¢è‰²æ ‡è®°å‡ºæ¥ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å°½å¯èƒ½å‡å°‘çœ‹åˆ°çš„çº¢è‰²åŒºåŸŸã€‚ä¸€æ—¦å‘ç°åº”è¯¥æƒ³æ³•è®¾æ³•æ¶ˆé™¤å®ƒã€‚</p>
<p><img src="/res/Instrument/15.png" width="40%"></p>
<p>è§£å†³åŠæ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>é€æ˜åº¦è®¾ç½®ä¸º100%<ul>
<li>å¦‚æœæŸä¸€å—åŒºåŸŸä¸Šè¦†ç›–äº†å¤šä¸ªlayer,æœ€åçš„æ˜¾ç¤ºæ•ˆæœå—åˆ°è¿™äº›layerçš„å…±åŒå½±å“ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šå±‚æ˜¯è“è‰²(RGB=0,0,1),é€æ˜åº¦ä¸º50%ï¼Œä¸‹å±‚æ˜¯çº¢è‰²(RGB=1,0,0)ã€‚é‚£ä¹ˆæœ€ç»ˆçš„æ˜¾ç¤ºæ•ˆæœæ˜¯ç´«è‰²(RGB=0.5,0,0.5)ã€‚è¿™ç§é¢œè‰²çš„æ··åˆ(blending)éœ€è¦æ¶ˆè€—ä¸€å®šçš„GPUèµ„æºï¼Œå› ä¸ºå®é™…ä¸Šå¯èƒ½ä¸æ­¢åªæœ‰ä¸¤å±‚ã€‚å¦‚æœåªæƒ³æ˜¾ç¤ºæœ€ä¸Šå±‚çš„è“è‰²ï¼Œå¯ä»¥æŠŠå®ƒçš„é€æ˜åº¦è®¾ç½®ä¸º100%ï¼Œè¿™æ ·GPUä¼šå¿½ç•¥ä¸‹é¢æ‰€æœ‰çš„layerï¼Œä»è€ŒèŠ‚çº¦äº†å¾ˆå¤šä¸å¿…è¦çš„è¿ç®—ã€‚</li>
</ul>
</li>
<li>UIImageViewçš„å›¾ç‰‡ä¹Ÿä¸èƒ½å«æœ‰alphaé€šé“<ul>
<li>å›¾åƒè‡ªèº«çš„æ€§è´¨å¯èƒ½ä¼šå¯¹ç»“æœæœ‰å½±å“</li>
</ul>
</li>
<li>è®¾ç½® backgroundColor å±æ€§ï¼ˆå¦‚æœä¸è®¾ç½®èƒŒæ™¯é¢œè‰²ï¼Œæ§ä»¶ä¾ç„¶ä¼šè¢«è®¤ä¸ºæ˜¯é€æ˜çš„ï¼‰<ul>
<li>è™½ç„¶åœ¨ç™½è‰²èƒŒæ™¯ä¸‹ï¼Œæ— æ³•è‚‰çœ¼çœ‹åˆ°æ•ˆæœï¼Œä½†é‡æ–°è°ƒè¯•åæˆ‘ä»¬å¯ä»¥å‘ç°labelçš„çº¢è‰²æ¶ˆå¤±äº†ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºå¯¹èƒŒæ™¯é¢œè‰²çš„ä¸é‡è§†ï¼Œå®ƒæˆäº†å½±å“æ»‘åŠ¨æ€§èƒ½çš„ç¬¬ä¸€ä¸ªæ€æ‰‹ã€‚</li>
</ul>
</li>
<li>å¦‚æœlabelæ–‡å­—æœ‰ä¸­æ–‡ï¼Œä¾ç„¶ä¼šå‡ºç°å›¾å±‚æ··åˆï¼Œè¿™æ˜¯å› ä¸ºæ­¤æ—¶labelå¤šäº†ä¸€ä¸ªsublayer</li>
</ol>
<h2 id="å…‰æ …åŒ–"><a href="#å…‰æ …åŒ–" class="headerlink" title="å…‰æ …åŒ–"></a>å…‰æ …åŒ–</h2><p>ç¬¬äºŒä¸ªè°ƒè¯•é€‰é¡¹æ˜¯<strong>â€œColor Hits Green and Misses Red</strong>â€ï¼Œå®ƒè¡¨ç¤ºå¦‚æœå‘½ä¸­ç¼“å­˜åˆ™æ˜¾ç¤ºä¸ºç»¿è‰²ï¼Œå¦åˆ™æ˜¾ç¤ºä¸ºçº¢è‰²ï¼Œæ˜¾ç„¶ç»¿è‰²è¶Šå¤šè¶Šå¥½ï¼Œçº¢è‰²è¶Šå°‘è¶Šå¥½ã€‚å‹¾é€‰è¿™ä¸ªé€‰é¡¹åæˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹çš„åœºæ™¯ï¼š</p>
<p><img src="/res/Instrument/16.png" width="40%"></p>
<p>å…‰æ …åŒ–æ˜¯å°†ä¸€ä¸ªlayeré¢„å…ˆæ¸²æŸ“æˆä½å›¾(bitmap)ï¼Œç„¶ååŠ å…¥ç¼“å­˜ä¸­ã€‚å¦‚æœå¯¹äºé˜´å½±æ•ˆæœè¿™æ ·æ¯”è¾ƒæ¶ˆè€—èµ„æºçš„é™æ€å†…å®¹è¿›è¡Œç¼“å­˜ï¼Œå¯ä»¥å¾—åˆ°ä¸€å®šå¹…åº¦çš„æ€§èƒ½æå‡</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿™ä¸€è¡Œä»£ç è¡¨ç¤ºå°†labelçš„layerå…‰æ …åŒ–ï¼š</span></span><br><span class="line">label.layer.shouldRasterize = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºlayerè¿›è¡Œå…‰æ …åŒ–åæ¸²æŸ“æˆä½å›¾æ”¾åœ¨ç¼“å­˜ä¸­ã€‚ç¼“å­˜ä¸­çš„å¯¹è±¡æœ‰æ•ˆæœŸåªæœ‰100msï¼Œå³å¦‚æœåœ¨0.1så†…æ²¡æœ‰è¢«ä½¿ç”¨å°±ä¼šè‡ªåŠ¨ä»ç¼“å­˜ä¸­æ¸…ç†å‡ºå»ã€‚å…‰æ …åŒ–çš„ç¼“å­˜æœºåˆ¶æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå…ˆå†™å…¥ç¼“å­˜å†è¯»å–æœ‰å¯èƒ½æ¶ˆè€—è¾ƒå¤šçš„æ—¶é—´ã€‚å› æ­¤å…‰æ …åŒ–ä»…é€‚ç”¨äºè¾ƒå¤æ‚çš„ã€é™æ€çš„æ•ˆæœã€‚ å…‰æ …åŒ–ä¼šå¯¼è‡´ç¦»å±æ¸²æŸ“</p>
<p>æ‰€ä»¥æˆ‘ä»¬åšçš„ç¬¬äºŒä¸ªä¼˜åŒ–æ˜¯æ³¨é‡Šæ‰ä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//    label.layer.shouldRasterize = true</span></span><br></pre></td></tr></table></figure>
<h2 id="é¢œè‰²æ ¼å¼"><a href="#é¢œè‰²æ ¼å¼" class="headerlink" title="é¢œè‰²æ ¼å¼"></a>é¢œè‰²æ ¼å¼</h2><p>åƒç´ åœ¨å†…å­˜ä¸­çš„å¸ƒå±€å’Œå®ƒåœ¨ç£ç›˜ä¸­çš„å­˜å‚¨æ–¹å¼å¹¶ä¸ç›¸åŒã€‚è€ƒè™‘ä¸€ç§ç®€å•çš„æƒ…å†µï¼šæ¯ä¸ªåƒç´ æœ‰Rã€Gã€Bå’Œalphaå››ä¸ªå€¼ï¼Œæ¯ä¸ªå€¼å ç”¨1å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸ªåƒç´ å ç”¨4å­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚ä¸€å¼ 1920*1080çš„ç…§ç‰‡(iPhone6 Plusçš„åˆ†è¾¨ç‡)ä¸€å…±æœ‰2,073,600ä¸ªåƒç´ ï¼Œå› æ­¤å ç”¨äº†è¶…è¿‡8Mbçš„å†…å­˜ã€‚ä½†æ˜¯ä¸€å¼ åŒæ ·åˆ†è¾¨ç‡çš„PNGæ ¼å¼æˆ–JPEGæ ¼å¼çš„å›¾ç‰‡ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šæœ‰è¿™ä¹ˆå¤§ã€‚è¿™æ˜¯å› ä¸ºJPEGå°†åƒç´ æ•°æ®è¿›è¡Œäº†ä¸€ç§éå¸¸å¤æ‚ä¸”å¯é€†çš„è½¬åŒ–ã€‚</p>
<p>å½“æˆ‘ä»¬æ‰“å¼€JPEGæ ¼å¼çš„å›¾ç‰‡æ—¶ï¼ŒCPUä¼šè¿›è¡Œä¸€ç³»åˆ—è¿ç®—ï¼Œå°†JPEGå›¾ç‰‡è§£å‹æˆåƒç´ æ•°æ®ã€‚æ˜¾ç„¶è¿™ä¸ªå·¥ä½œä¼šæ¶ˆè€—ä¸å°‘æ—¶é—´ï¼Œæ‰€ä»¥ä¸åº”è¯¥åœ¨æ»‘åŠ¨æ—¶è¿›è¡Œï¼Œæˆ‘ä»¬åº”è¯¥é¢„å…ˆå¤„ç†å¥½å›¾ç‰‡ã€‚å€Ÿç”¨WWDCä¸Šçš„ä¸€é¡µPPTæ¥è¯´æ˜ï¼š</p>
<p><img src="/res/Instrument/t_UIKitæ€§èƒ½ä¼˜åŒ–22.png" alt></p>
<p>Commit Transactionå’ŒDecodeåœ¨åŒä¸€å¸§å†…è¿›è¡Œï¼Œå¦‚æœè¿™ä¸¤ä¸ªæ“ä½œçš„è€—æ—¶è¶…è¿‡16.67sï¼ŒDraw Callså°±ä¼šå»¶è¿Ÿåˆ°ä¸‹ä¸€å¸§ï¼Œä»è€Œå¯¼è‡´fpså€¼çš„é™ä½ã€‚ä¸‹é¢æ˜¯Commit Transactionçš„è¯¦ç»†æµç¨‹ï¼š</p>
<p><img src="/res/Instrument/t_UIKitæ€§èƒ½ä¼˜åŒ–23.png" alt></p>
<p>åœ¨ç¬¬ä¸‰æ­¥çš„Prepareä¸­ï¼ŒCPUä¸»è¦å¤„ç†ä¸¤ä»¶äº‹ï¼š</p>
<ol>
<li>æŠŠå›¾ç‰‡ä»PNGæˆ–JPEGç­‰æ ¼å¼ä¸­è§£å‹å‡ºæ¥ï¼Œå¾—åˆ°åƒç´ æ•°æ®</li>
<li>å¦‚æœGPUä¸æ”¯æŒè¿™ç§é¢œè‰²å„å¼ï¼ŒCPUéœ€è¦è¿›è¡Œæ ¼å¼è½¬æ¢</li>
</ol>
<p>ä½¿ç”¨core animation çš„ <strong>Color Copied Images</strong>æ£€æµ‹å›¾ç‰‡æ ¼å¼,ç¡®ä¿å›¾ç‰‡é¢œè‰²æ ¼å¼èƒ½è¢«GPUæ”¯æŒ</p>
<h2 id="å›¾ç‰‡å¤§å°"><a href="#å›¾ç‰‡å¤§å°" class="headerlink" title="å›¾ç‰‡å¤§å°"></a>å›¾ç‰‡å¤§å°</h2><p>ä½¿ç”¨core animation çš„ç¬¬äº”ä¸ªé€‰é¡¹â€œ<strong>Color Misaligned Imagesâ€</strong>ã€‚å®ƒè¡¨ç¤ºå¦‚æœå›¾ç‰‡éœ€è¦ç¼©æ”¾åˆ™æ ‡è®°ä¸ºé»„è‰²ï¼Œå¦‚æœæ²¡æœ‰åƒç´ å¯¹é½åˆ™æ ‡è®°ä¸ºç´«è‰²ã€‚å‹¾é€‰ä¸Šè¿™ä¸ªé€‰é¡¹å¹¶è¿›è¡Œè°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹åœºæ™¯ï¼š</p>
<p><img src="/res/Instrument/17.png" width="40%"></p>
<p>å›¾ç‰‡å¦‚æœéœ€è¦ç¼©æ”¾ä¼šå ç”¨ä¸€å®šæ—¶é—´ï¼Œç¡®ä¿å›¾ç‰‡å¤§å°ä¸frameä¸€è‡´ï¼Œä¸è¦åœ¨æ»‘åŠ¨çš„æ—¶å€™ç¼©æ”¾å›¾ç‰‡</p>
<h2 id="ç¦»å±æ¸²æŸ“"><a href="#ç¦»å±æ¸²æŸ“" class="headerlink" title="ç¦»å±æ¸²æŸ“"></a>ç¦»å±æ¸²æŸ“</h2><p>å¼€å§‹è°ƒè¯•å¹¶å‹¾é€‰â€œ<strong>Color Offscreen-Rendered Yellowâ€</strong>ï¼Œä¼šçœ‹åˆ°è¿™æ ·çš„åœºæ™¯ï¼š</p>
<p><img src="/res/Instrument/20.png" width="40%"></p>
<p>è¿™è¡¨ç¤ºäº§ç”Ÿäº†ç¦»å±æ¸²æŸ“ã€‚ç¦»å±æ¸²æŸ“è¡¨ç¤ºæ¸²æŸ“å‘ç”Ÿåœ¨å±å¹•ä¹‹å¤–ï¼Œä½ å¯èƒ½è®¤ä¸ºè¿™æ˜¯ä¸€å¥åºŸè¯ã€‚ä¸ºäº†çœŸæ­£è§£é‡Šæ¸…æ¥šä»€ä¹ˆæ˜¯ç¦»å±æ¸²æŸ“ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ­£å¸¸çš„æ¸²æŸ“é€šé“(Render-Pass)ï¼š</p>
<p><img src="/res/Instrument/18.png"> </p>
<p>é¦–å…ˆï¼ŒOpenGLæäº¤ä¸€ä¸ªå‘½ä»¤åˆ°Command Bufferï¼ŒéšåGPUå¼€å§‹æ¸²æŸ“ï¼Œæ¸²æŸ“ç»“æœæ”¾åˆ°Render Bufferä¸­ï¼Œè¿™æ˜¯æ­£å¸¸çš„æ¸²æŸ“æµç¨‹ã€‚ä½†æ˜¯æœ‰ä¸€äº›å¤æ‚çš„æ•ˆæœæ— æ³•ç›´æ¥æ¸²æŸ“å‡ºç»“æœï¼Œå®ƒéœ€è¦åˆ†æ­¥æ¸²æŸ“æœ€åå†ç»„åˆèµ·æ¥ï¼Œæ¯”å¦‚æ·»åŠ ä¸€ä¸ªè’™ç‰ˆ(mask)ï¼š</p>
<p><img src="/res/Instrument/19.png"> </p>
<p>åœ¨å‰ä¸¤ä¸ªæ¸²æŸ“é€šé“ä¸­ï¼ŒGPUåˆ†åˆ«å¾—åˆ°äº†çº¹ç†(textureï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ªç›¸æœºå›¾æ ‡)å’Œlayer(è“è‰²çš„è’™ç‰ˆ)çš„æ¸²æŸ“ç»“æœã€‚ä½†è¿™ä¸¤ä¸ªæ¸²æŸ“ç»“æœæ²¡æœ‰ç›´æ¥æ”¾å…¥Render Bufferä¸­ï¼Œä¹Ÿå°±è¡¨ç¤ºè¿™æ˜¯ç¦»å±æ¸²æŸ“ã€‚ç›´åˆ°ç¬¬ä¸‰ä¸ªæ¸²æŸ“é€šé“ï¼Œæ‰æŠŠä¸¤è€…ç»„åˆèµ·æ¥æ”¾å…¥Render Bufferä¸­ã€‚ç¦»å±æ¸²æŸ“æ„å‘³ç€æŠŠæ¸²æŸ“ç»“æœä¸´æ—¶ä¿å­˜ï¼Œç­‰ç”¨åˆ°æ—¶å†å–å‡ºï¼Œå› æ­¤ç›¸å¯¹äºæ™®é€šæ¸²æŸ“æ›´å ç”¨èµ„æºã€‚</p>
<p>ä»¥ä¸‹æƒ…å†µå¯èƒ½ä¼šå¯¼è‡´è§¦å‘ç¦»å±æ¸²æŸ“ï¼š</p>
<ol>
<li>é‡å†™drawRectæ–¹æ³•</li>
<li>æœ‰maskæˆ–è€…æ˜¯é˜´å½±(layer.masksToBounds, layer.shadow*)ï¼Œæ¨¡ç³Šæ•ˆæœä¹Ÿæ˜¯ä¸€ç§mask</li>
<li>layer.shouldRasterize = true</li>
</ol>
<h2 id="å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ"><a href="#å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ"></a>å¡é¡¿çš„è§£å†³æ–¹æ¡ˆ</h2><p>CPU å’Œ GPU ä¸è®ºå“ªä¸ªé˜»ç¢äº†æ˜¾ç¤ºæµç¨‹ï¼Œéƒ½ä¼šé€ æˆæ‰å¸§ç°è±¡ã€‚æ‰€ä»¥å¼€å‘æ—¶ï¼Œä¹Ÿéœ€è¦åˆ†åˆ«å¯¹ CPU å’Œ GPU å‹åŠ›è¿›è¡Œè¯„ä¼°å’Œä¼˜åŒ–ã€‚</p>
<h3 id="CPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"><a href="#CPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="CPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"></a>CPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ</h3><p><strong>1. å¯¹è±¡åˆ›å»ºï¼š</strong></p>
<p>å¯¹è±¡çš„åˆ›å»ºä¼šåˆ†é…å†…å­˜ã€è°ƒæ•´å±æ€§ã€ç”šè‡³è¿˜æœ‰è¯»å–æ–‡ä»¶ç­‰æ“ä½œï¼Œæ¯”è¾ƒæ¶ˆè€— CPU èµ„æºã€‚å°½é‡ç”¨è½»é‡çš„å¯¹è±¡ä»£æ›¿é‡é‡çš„å¯¹è±¡ï¼Œå¯ä»¥å¯¹æ€§èƒ½æœ‰æ‰€ä¼˜åŒ–ã€‚æ¯”å¦‚ CALayer æ¯” UIView è¦è½»é‡è®¸å¤šï¼Œé‚£ä¹ˆä¸éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶çš„æ§ä»¶ï¼Œç”¨ CALayer æ˜¾ç¤ºä¼šæ›´åŠ åˆé€‚ã€‚å¦‚æœå¯¹è±¡ä¸æ¶‰åŠ UI æ“ä½œï¼Œåˆ™å°½é‡æ”¾åˆ°åå°çº¿ç¨‹å»åˆ›å»ºï¼Œä½†å¯æƒœçš„æ˜¯åŒ…å«æœ‰ CALayer çš„æ§ä»¶ï¼Œéƒ½åªèƒ½åœ¨ä¸»çº¿ç¨‹åˆ›å»ºå’Œæ“ä½œã€‚é€šè¿‡ Storyboard åˆ›å»ºè§†å›¾å¯¹è±¡æ—¶ï¼Œå…¶èµ„æºæ¶ˆè€—ä¼šæ¯”ç›´æ¥é€šè¿‡ä»£ç åˆ›å»ºå¯¹è±¡è¦å¤§éå¸¸å¤šï¼Œåœ¨æ€§èƒ½æ•æ„Ÿçš„ç•Œé¢é‡Œï¼ŒStoryboard å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„æŠ€æœ¯é€‰æ‹©ã€‚</p>
<p>å°½é‡æ¨è¿Ÿå¯¹è±¡åˆ›å»ºçš„æ—¶é—´ï¼Œå¹¶æŠŠå¯¹è±¡çš„åˆ›å»ºåˆ†æ•£åˆ°å¤šä¸ªä»»åŠ¡ä¸­å»ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”å¸¦æ¥çš„ä¼˜åŠ¿å¹¶ä¸å¤šï¼Œä½†å¦‚æœæœ‰èƒ½åŠ›åšï¼Œè¿˜æ˜¯è¦å°½é‡å°è¯•ä¸€ä¸‹ã€‚å¦‚æœå¯¹è±¡å¯ä»¥å¤ç”¨ï¼Œå¹¶ä¸”å¤ç”¨çš„ä»£ä»·æ¯”é‡Šæ”¾ã€åˆ›å»ºæ–°å¯¹è±¡è¦å°ï¼Œé‚£ä¹ˆè¿™ç±»å¯¹è±¡åº”å½“å°½é‡æ”¾åˆ°ä¸€ä¸ªç¼“å­˜æ± é‡Œå¤ç”¨ã€‚</p>
<p><strong>2. å¯¹è±¡è°ƒæ•´: </strong></p>
<p>å¯¹è±¡çš„è°ƒæ•´ä¹Ÿç»å¸¸æ˜¯æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚è¿™é‡Œç‰¹åˆ«è¯´ä¸€ä¸‹ CALayerï¼šCALayer å†…éƒ¨å¹¶æ²¡æœ‰å±æ€§ï¼Œå½“è°ƒç”¨å±æ€§æ–¹æ³•æ—¶ï¼Œå®ƒå†…éƒ¨æ˜¯é€šè¿‡è¿è¡Œæ—¶ resolveInstanceMethod ä¸ºå¯¹è±¡ä¸´æ—¶æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå¹¶æŠŠå¯¹åº”å±æ€§å€¼ä¿å­˜åˆ°å†…éƒ¨çš„ä¸€ä¸ª Dictionary é‡Œï¼ŒåŒæ—¶è¿˜ä¼šé€šçŸ¥ delegateã€åˆ›å»ºåŠ¨ç”»ç­‰ç­‰ï¼Œéå¸¸æ¶ˆè€—èµ„æºã€‚UIView çš„å…³äºæ˜¾ç¤ºç›¸å…³çš„å±æ€§ï¼ˆæ¯”å¦‚ frame/bounds/transformï¼‰ç­‰å®é™…ä¸Šéƒ½æ˜¯ CALayer å±æ€§æ˜ å°„æ¥çš„ï¼Œæ‰€ä»¥å¯¹ UIView çš„è¿™äº›å±æ€§è¿›è¡Œè°ƒæ•´æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºè¦è¿œå¤§äºä¸€èˆ¬çš„å±æ€§ã€‚å¯¹æ­¤ä½ åœ¨åº”ç”¨ä¸­ï¼Œåº”è¯¥å°½é‡å‡å°‘ä¸å¿…è¦çš„å±æ€§ä¿®æ”¹ã€‚</p>
<p>å½“è§†å›¾å±‚æ¬¡è°ƒæ•´æ—¶ï¼ŒUIViewã€CALayer ä¹‹é—´ä¼šå‡ºç°å¾ˆå¤šæ–¹æ³•è°ƒç”¨ä¸é€šçŸ¥ï¼Œæ‰€ä»¥åœ¨ä¼˜åŒ–æ€§èƒ½æ—¶ï¼Œåº”è¯¥å°½é‡é¿å…è°ƒæ•´è§†å›¾å±‚æ¬¡ã€æ·»åŠ å’Œç§»é™¤è§†å›¾ã€‚</p>
<p><strong>3. å¯¹è±¡é”€æ¯: </strong></p>
<p>å¯¹è±¡çš„é”€æ¯è™½ç„¶æ¶ˆè€—èµ„æºä¸å¤šï¼Œä½†ç´¯ç§¯èµ·æ¥ä¹Ÿæ˜¯ä¸å®¹å¿½è§†çš„ã€‚é€šå¸¸å½“å®¹å™¨ç±»æŒæœ‰å¤§é‡å¯¹è±¡æ—¶ï¼Œå…¶é”€æ¯æ—¶çš„èµ„æºæ¶ˆè€—å°±éå¸¸æ˜æ˜¾ã€‚åŒæ ·çš„ï¼Œå¦‚æœå¯¹è±¡å¯ä»¥æ”¾åˆ°åå°çº¿ç¨‹å»é‡Šæ”¾ï¼Œé‚£å°±æŒªåˆ°åå°çº¿ç¨‹å»ã€‚è¿™é‡Œæœ‰ä¸ªå° Tipï¼šæŠŠå¯¹è±¡æ•è·åˆ° block ä¸­ï¼Œç„¶åæ‰”åˆ°åå°é˜Ÿåˆ—å»éšä¾¿å‘é€ä¸ªæ¶ˆæ¯ä»¥é¿å…ç¼–è¯‘å™¨è­¦å‘Šï¼Œå°±å¯ä»¥è®©å¯¹è±¡åœ¨åå°çº¿ç¨‹é”€æ¯äº†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *tmp = <span class="keyword">self</span>.array;</span><br><span class="line"><span class="keyword">self</span>.array = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    [tmp <span class="keyword">class</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>4. å¸ƒå±€è®¡ç®—: </strong></p>
<p>è§†å›¾å¸ƒå±€çš„è®¡ç®—æ˜¯ App ä¸­æœ€ä¸ºå¸¸è§çš„æ¶ˆè€— CPU èµ„æºçš„åœ°æ–¹ã€‚å¦‚æœèƒ½åœ¨åå°çº¿ç¨‹æå‰è®¡ç®—å¥½è§†å›¾å¸ƒå±€ã€å¹¶ä¸”å¯¹è§†å›¾å¸ƒå±€è¿›è¡Œç¼“å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹åŸºæœ¬å°±ä¸ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜äº†ã€‚</p>
<p>ä¸è®ºé€šè¿‡ä½•ç§æŠ€æœ¯å¯¹è§†å›¾è¿›è¡Œå¸ƒå±€ï¼Œå…¶æœ€ç»ˆéƒ½ä¼šè½åˆ°å¯¹ UIView.frame/bounds/center ç­‰å±æ€§çš„è°ƒæ•´ä¸Šã€‚ä¸Šé¢ä¹Ÿè¯´è¿‡ï¼Œå¯¹è¿™äº›å±æ€§çš„è°ƒæ•´éå¸¸æ¶ˆè€—èµ„æºï¼Œæ‰€ä»¥å°½é‡æå‰è®¡ç®—å¥½å¸ƒå±€ï¼Œåœ¨éœ€è¦æ—¶ä¸€æ¬¡æ€§è°ƒæ•´å¥½å¯¹åº”å±æ€§ï¼Œè€Œä¸è¦å¤šæ¬¡ã€é¢‘ç¹çš„è®¡ç®—å’Œè°ƒæ•´è¿™äº›å±æ€§ã€‚</p>
<p><strong>5. Autolayout: </strong></p>
<p>Autolayout æ˜¯è‹¹æœæœ¬èº«æå€¡çš„æŠ€æœ¯ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¹Ÿèƒ½å¾ˆå¥½çš„æå‡å¼€å‘æ•ˆç‡ï¼Œä½†æ˜¯ Autolayout å¯¹äºå¤æ‚è§†å›¾æ¥è¯´å¸¸å¸¸ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚éšç€è§†å›¾æ•°é‡çš„å¢é•¿ï¼ŒAutolayout å¸¦æ¥çš„ CPU æ¶ˆè€—ä¼šå‘ˆæŒ‡æ•°çº§ä¸Šå‡ã€‚å…·ä½“æ•°æ®å¯ä»¥çœ‹è¿™ä¸ªæ–‡ç« ï¼š<a href="http://pilky.me/36/" target="_blank" rel="noopener">http://pilky.me/36/</a>ã€‚ å¦‚æœä½ ä¸æƒ³æ‰‹åŠ¨è°ƒæ•´ frame ç­‰å±æ€§ï¼Œä½ å¯ä»¥ç”¨ä¸€äº›å·¥å…·æ–¹æ³•æ›¿ä»£ï¼ˆæ¯”å¦‚å¸¸è§çš„ left/right/top/bottom/width/height å¿«æ·å±æ€§ï¼‰ï¼Œæˆ–è€…ä½¿ç”¨ ComponentKitã€AsyncDisplayKit ç­‰æ¡†æ¶ã€‚</p>
<p><strong>6. æ–‡æœ¬è®¡ç®—: </strong></p>
<p>å¦‚æœä¸€ä¸ªç•Œé¢ä¸­åŒ…å«å¤§é‡æ–‡æœ¬ï¼ˆæ¯”å¦‚å¾®åšå¾®ä¿¡æœ‹å‹åœˆç­‰ï¼‰ï¼Œæ–‡æœ¬çš„å®½é«˜è®¡ç®—ä¼šå ç”¨å¾ˆå¤§ä¸€éƒ¨åˆ†èµ„æºï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœä½ å¯¹æ–‡æœ¬æ˜¾ç¤ºæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œå¯ä»¥å‚è€ƒä¸‹ UILabel å†…éƒ¨çš„å®ç°æ–¹å¼ï¼šç”¨ [NSAttributedString boundingRectWithSize:options:context:] æ¥è®¡ç®—æ–‡æœ¬å®½é«˜ï¼Œç”¨ -[NSAttributedString drawWithRect:options:context:] æ¥ç»˜åˆ¶æ–‡æœ¬ã€‚å°½ç®¡è¿™ä¸¤ä¸ªæ–¹æ³•æ€§èƒ½ä¸é”™ï¼Œä½†ä»æ—§éœ€è¦æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚</p>
<p>å¦‚æœä½ ç”¨ CoreText ç»˜åˆ¶æ–‡æœ¬ï¼Œé‚£å°±å¯ä»¥å…ˆç”Ÿæˆ CoreText æ’ç‰ˆå¯¹è±¡ï¼Œç„¶åè‡ªå·±è®¡ç®—äº†ï¼Œå¹¶ä¸” CoreText å¯¹è±¡è¿˜èƒ½ä¿ç•™ä»¥ä¾›ç¨åç»˜åˆ¶ä½¿ç”¨ã€‚</p>
<p><strong>7. æ–‡æœ¬æ¸²æŸ“:</strong></p>
<p>å±å¹•ä¸Šèƒ½çœ‹åˆ°çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹æ§ä»¶ï¼ŒåŒ…æ‹¬ UIWebViewï¼Œåœ¨åº•å±‚éƒ½æ˜¯é€šè¿‡ CoreText æ’ç‰ˆã€ç»˜åˆ¶ä¸º Bitmap æ˜¾ç¤ºçš„ã€‚å¸¸è§çš„æ–‡æœ¬æ§ä»¶ ï¼ˆUILabelã€UITextView ç­‰ï¼‰ï¼Œå…¶æ’ç‰ˆå’Œç»˜åˆ¶éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå½“æ˜¾ç¤ºå¤§é‡æ–‡æœ¬æ—¶ï¼ŒCPU çš„å‹åŠ›ä¼šéå¸¸å¤§ã€‚å¯¹æ­¤è§£å†³æ–¹æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯è‡ªå®šä¹‰æ–‡æœ¬æ§ä»¶ï¼Œç”¨ TextKit æˆ–æœ€åº•å±‚çš„ CoreText å¯¹æ–‡æœ¬å¼‚æ­¥ç»˜åˆ¶ã€‚å°½ç®¡è¿™å®ç°èµ·æ¥éå¸¸éº»çƒ¦ï¼Œä½†å…¶å¸¦æ¥çš„ä¼˜åŠ¿ä¹Ÿéå¸¸å¤§ï¼ŒCoreText å¯¹è±¡åˆ›å»ºå¥½åï¼Œèƒ½ç›´æ¥è·å–æ–‡æœ¬çš„å®½é«˜ç­‰ä¿¡æ¯ï¼Œé¿å…äº†å¤šæ¬¡è®¡ç®—ï¼ˆè°ƒæ•´ UILabel å¤§å°æ—¶ç®—ä¸€éã€UILabel ç»˜åˆ¶æ—¶å†…éƒ¨å†ç®—ä¸€éï¼‰ï¼›CoreText å¯¹è±¡å ç”¨å†…å­˜è¾ƒå°‘ï¼Œå¯ä»¥ç¼“å­˜ä¸‹æ¥ä»¥å¤‡ç¨åå¤šæ¬¡æ¸²æŸ“ã€‚</p>
<p><strong>8. å›¾ç‰‡çš„è§£ç :</strong></p>
<p>å½“ä½ ç”¨ UIImage æˆ– CGImageSource çš„é‚£å‡ ä¸ªæ–¹æ³•åˆ›å»ºå›¾ç‰‡æ—¶ï¼Œå›¾ç‰‡æ•°æ®å¹¶ä¸ä¼šç«‹åˆ»è§£ç ã€‚å›¾ç‰‡è®¾ç½®åˆ° UIImageView æˆ–è€… CALayer.contents ä¸­å»ï¼Œå¹¶ä¸” CALayer è¢«æäº¤åˆ° GPU å‰ï¼ŒCGImage ä¸­çš„æ•°æ®æ‰ä¼šå¾—åˆ°è§£ç ã€‚è¿™ä¸€æ­¥æ˜¯å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå¹¶ä¸”ä¸å¯é¿å…ã€‚å¦‚æœæƒ³è¦ç»•å¼€è¿™ä¸ªæœºåˆ¶ï¼Œå¸¸è§çš„åšæ³•æ˜¯åœ¨åå°çº¿ç¨‹å…ˆæŠŠå›¾ç‰‡ç»˜åˆ¶åˆ° CGBitmapContext ä¸­ï¼Œç„¶åä» Bitmap ç›´æ¥åˆ›å»ºå›¾ç‰‡ã€‚ç›®å‰å¸¸è§çš„ç½‘ç»œå›¾ç‰‡åº“éƒ½è‡ªå¸¦è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p><strong>9. å›¾åƒçš„ç»˜åˆ¶:</strong></p>
<p>å›¾åƒçš„ç»˜åˆ¶é€šå¸¸æ˜¯æŒ‡ç”¨é‚£äº›ä»¥ CG å¼€å¤´çš„æ–¹æ³•æŠŠå›¾åƒç»˜åˆ¶åˆ°ç”»å¸ƒä¸­ï¼Œç„¶åä»ç”»å¸ƒåˆ›å»ºå›¾ç‰‡å¹¶æ˜¾ç¤ºè¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚è¿™ä¸ªæœ€å¸¸è§çš„åœ°æ–¹å°±æ˜¯ [UIView drawRect:] é‡Œé¢äº†ã€‚ç”±äº CoreGraphic æ–¹æ³•é€šå¸¸éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å›¾åƒçš„ç»˜åˆ¶å¯ä»¥å¾ˆå®¹æ˜“çš„æ”¾åˆ°åå°çº¿ç¨‹è¿›è¡Œã€‚ä¸€ä¸ªç®€å•å¼‚æ­¥ç»˜åˆ¶çš„è¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼ˆå®é™…æƒ…å†µä¼šæ¯”è¿™ä¸ªå¤æ‚å¾—å¤šï¼Œä½†åŸç†åŸºæœ¬ä¸€è‡´ï¼‰ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)display &#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(backgroundQueue, ^&#123;</span><br><span class="line">        <span class="built_in">CGContextRef</span> ctx = <span class="built_in">CGBitmapContextCreate</span>(...);</span><br><span class="line">        <span class="comment">// draw in context...</span></span><br><span class="line">        <span class="built_in">CGImageRef</span> img = <span class="built_in">CGBitmapContextCreateImage</span>(ctx);</span><br><span class="line">        <span class="built_in">CFRelease</span>(ctx);</span><br><span class="line">        <span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</span><br><span class="line">            layer.contents = img;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="GPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"><a href="#GPU-èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ" class="headerlink" title="GPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ"></a>GPU èµ„æºæ¶ˆè€—åŸå› å’Œè§£å†³æ–¹æ¡ˆ</h3><p>ç›¸å¯¹äº CPU æ¥è¯´ï¼ŒGPU èƒ½å¹²çš„äº‹æƒ…æ¯”è¾ƒå•ä¸€ï¼šæ¥æ”¶æäº¤çš„çº¹ç†ï¼ˆTextureï¼‰å’Œé¡¶ç‚¹æè¿°ï¼ˆä¸‰è§’å½¢ï¼‰ï¼Œåº”ç”¨å˜æ¢ï¼ˆtransformï¼‰ã€æ··åˆå¹¶æ¸²æŸ“ï¼Œç„¶åè¾“å‡ºåˆ°å±å¹•ä¸Šã€‚é€šå¸¸ä½ æ‰€èƒ½çœ‹åˆ°çš„å†…å®¹ï¼Œä¸»è¦ä¹Ÿå°±æ˜¯çº¹ç†ï¼ˆå›¾ç‰‡ï¼‰å’Œå½¢çŠ¶ï¼ˆä¸‰è§’æ¨¡æ‹Ÿçš„çŸ¢é‡å›¾å½¢ï¼‰ä¸¤ç±»ã€‚</p>
<p><strong>1. çº¹ç†çš„æ¸²æŸ“</strong></p>
<p>æ‰€æœ‰çš„ Bitmapï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€æ–‡æœ¬ã€æ …æ ¼åŒ–çš„å†…å®¹ï¼Œæœ€ç»ˆéƒ½è¦ç”±å†…å­˜æäº¤åˆ°æ˜¾å­˜ï¼Œç»‘å®šä¸º GPU Textureã€‚ä¸è®ºæ˜¯æäº¤åˆ°æ˜¾å­˜çš„è¿‡ç¨‹ï¼Œè¿˜æ˜¯ GPU è°ƒæ•´å’Œæ¸²æŸ“ Texture çš„è¿‡ç¨‹ï¼Œéƒ½è¦æ¶ˆè€—ä¸å°‘ GPU èµ„æºã€‚å½“åœ¨è¾ƒçŸ­æ—¶é—´æ˜¾ç¤ºå¤§é‡å›¾ç‰‡æ—¶ï¼ˆæ¯”å¦‚ TableView å­˜åœ¨éå¸¸å¤šçš„å›¾ç‰‡å¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼‰ï¼ŒCPU å ç”¨ç‡å¾ˆä½ï¼ŒGPU å ç”¨éå¸¸é«˜ï¼Œç•Œé¢ä»ç„¶ä¼šæ‰å¸§ã€‚é¿å…è¿™ç§æƒ…å†µçš„æ–¹æ³•åªèƒ½æ˜¯å°½é‡å‡å°‘åœ¨çŸ­æ—¶é—´å†…å¤§é‡å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå°½å¯èƒ½å°†å¤šå¼ å›¾ç‰‡åˆæˆä¸ºä¸€å¼ è¿›è¡Œæ˜¾ç¤ºã€‚</p>
<p>å½“å›¾ç‰‡è¿‡å¤§ï¼Œè¶…è¿‡ GPU çš„æœ€å¤§çº¹ç†å°ºå¯¸æ—¶ï¼Œå›¾ç‰‡éœ€è¦å…ˆç”± CPU è¿›è¡Œé¢„å¤„ç†ï¼Œè¿™å¯¹ CPU å’Œ GPU éƒ½ä¼šå¸¦æ¥é¢å¤–çš„èµ„æºæ¶ˆè€—ã€‚ç›®å‰æ¥è¯´ï¼ŒiPhone 4S ä»¥ä¸Šæœºå‹ï¼Œçº¹ç†å°ºå¯¸ä¸Šé™éƒ½æ˜¯ 4096Ã—4096ï¼Œæ›´è¯¦ç»†çš„èµ„æ–™å¯ä»¥çœ‹è¿™é‡Œï¼šiosres.comã€‚æ‰€ä»¥ï¼Œå°½é‡ä¸è¦è®©å›¾ç‰‡å’Œè§†å›¾çš„å¤§å°è¶…è¿‡è¿™ä¸ªå€¼ã€‚</p>
<p><strong>2. è§†å›¾çš„æ··åˆ (Composing)</strong></p>
<p>å½“å¤šä¸ªè§†å›¾ï¼ˆæˆ–è€…è¯´ CALayerï¼‰é‡å åœ¨ä¸€èµ·æ˜¾ç¤ºæ—¶ï¼ŒGPU ä¼šé¦–å…ˆæŠŠä»–ä»¬æ··åˆåˆ°ä¸€èµ·ã€‚å¦‚æœè§†å›¾ç»“æ„è¿‡äºå¤æ‚ï¼Œæ··åˆçš„è¿‡ç¨‹ä¹Ÿä¼šæ¶ˆè€—å¾ˆå¤š GPU èµ„æºã€‚ä¸ºäº†å‡è½»è¿™ç§æƒ…å†µçš„ GPU æ¶ˆè€—ï¼Œåº”ç”¨åº”å½“å°½é‡å‡å°‘è§†å›¾æ•°é‡å’Œå±‚æ¬¡ï¼Œå¹¶åœ¨ä¸é€æ˜çš„è§†å›¾é‡Œæ ‡æ˜ opaque å±æ€§ä»¥é¿å…æ— ç”¨çš„ Alpha é€šé“åˆæˆã€‚å½“ç„¶ï¼Œè¿™ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„æ–¹æ³•ï¼ŒæŠŠå¤šä¸ªè§†å›¾é¢„å…ˆæ¸²æŸ“ä¸ºä¸€å¼ å›¾ç‰‡æ¥æ˜¾ç¤ºã€‚</p>
<p><strong>3. å›¾å½¢çš„ç”Ÿæˆ</strong></p>
<p>CALayer çš„ borderã€åœ†è§’ã€é˜´å½±ã€é®ç½©ï¼ˆmaskï¼‰ï¼ŒCASharpLayer çš„çŸ¢é‡å›¾å½¢æ˜¾ç¤ºï¼Œé€šå¸¸ä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼ˆoffscreen renderingï¼‰ï¼Œè€Œç¦»å±æ¸²æŸ“é€šå¸¸å‘ç”Ÿåœ¨ GPU ä¸­ã€‚å½“ä¸€ä¸ªåˆ—è¡¨è§†å›¾ä¸­å‡ºç°å¤§é‡åœ†è§’çš„ CALayerï¼Œå¹¶ä¸”å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œå¯ä»¥è§‚å¯Ÿåˆ° GPU èµ„æºå·²ç»å æ»¡ï¼Œè€Œ CPU èµ„æºæ¶ˆè€—å¾ˆå°‘ã€‚è¿™æ—¶ç•Œé¢ä»ç„¶èƒ½æ­£å¸¸æ»‘åŠ¨ï¼Œä½†å¹³å‡å¸§æ•°ä¼šé™åˆ°å¾ˆä½ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥å°è¯•å¼€å¯ CALayer.shouldRasterize å±æ€§ï¼Œä½†è¿™ä¼šæŠŠåŸæœ¬ç¦»å±æ¸²æŸ“çš„æ“ä½œè½¬å«åˆ° CPU ä¸Šå»ã€‚å¯¹äºåªéœ€è¦åœ†è§’çš„æŸäº›åœºåˆï¼Œä¹Ÿå¯ä»¥ç”¨ä¸€å¼ å·²ç»ç»˜åˆ¶å¥½çš„åœ†è§’å›¾ç‰‡è¦†ç›–åˆ°åŸæœ¬è§†å›¾ä¸Šé¢æ¥æ¨¡æ‹Ÿç›¸åŒçš„è§†è§‰æ•ˆæœã€‚æœ€å½»åº•çš„è§£å†³åŠæ³•ï¼Œå°±æ˜¯æŠŠéœ€è¦æ˜¾ç¤ºçš„å›¾å½¢åœ¨åå°çº¿ç¨‹ç»˜åˆ¶ä¸ºå›¾ç‰‡ï¼Œé¿å…ä½¿ç”¨åœ†è§’ã€é˜´å½±ã€é®ç½©ç­‰å±æ€§ã€‚</p>
<!--iOS ä¿æŒç•Œé¢æµç•…çš„æŠ€å·§ https://blog.ibireme.com/2015/11/12/smooth_user_interfaces_for_ios/ -->
<!--å†…å­˜æ¶é¬¼drawRect https://bihongbo.com/2016/01/03/memoryGhostdrawRect/ -->
<!-- UIKitæ€§èƒ½è°ƒè¯• https://bestswifter.com/uikitxing-neng-diao-you-shi-zhan-jiang-jie/-->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Instruments</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -å£¹</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-%E5%A3%B9/</url>
    <content><![CDATA[<h3 id="0-å›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½"><a href="#0-å›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½" class="headerlink" title="0. å›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½"></a>0. å›¾ç‰‡çš„å¼‚æ­¥ä¸‹è½½</h3><p>æ¯”å¦‚åœ¨tableviewä¸­ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath&#123;</span><br><span class="line">   </span><br><span class="line">   static NSString* cellID  = @&quot;cellID&quot;;</span><br><span class="line">   </span><br><span class="line">   UITableViewCell* cell = [tableView dequeueReusableCellWithIdentifier:cellID];</span><br><span class="line">   if (cell == nil) &#123;</span><br><span class="line">       cell = [[UITableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:cellID];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   [cell.imageView sd_setImageWithURL:[NSURL URLWithString:@&quot;http://www.domain.com/path/to/image.jpg&quot;] placeholderImage:[UIImage imageNamed:@&quot;1.jpg&quot;]];</span><br><span class="line">   cell.textLabel.text = @&quot; text &quot;;</span><br><span class="line">   </span><br><span class="line">   return cell;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ä»–è¿™é‡Œç›¸å…³çš„ä»£ç å°±æ˜¯è°ƒç”¨äº†<code>UIImageView+WebCache</code>è¿™ä¸ªåˆ†ç±»ä¸­çš„ <code>sd_setImageWithURL:placeholderImage:</code>æ–¹æ³•</p>
<h2 id="1-å¼€å§‹çœ‹ä»£ç "><a href="#1-å¼€å§‹çœ‹ä»£ç " class="headerlink" title="1. å¼€å§‹çœ‹ä»£ç "></a>1. å¼€å§‹çœ‹ä»£ç </h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="built_in">NSURL</span> *)url placeholderImage:(<span class="built_in">UIImage</span> *)placeholder &#123;</span><br><span class="line">   [<span class="keyword">self</span> sd_setImageWithURL:url placeholderImage:placeholder options:<span class="number">0</span> progress:<span class="literal">nil</span> completed:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°åŸå…ˆæ–¹æ³•è°ƒç”¨äº†å¦ä¸€ä¸ªå‚æ•°æ›´å¤šçš„æ–¹æ³• <code>sd_setImageWithURL:url placeholderImage:nil options:0 progress:nil completed:nil</code></p>
<p>å…¶ä¸­urlæ˜¯å›¾ç‰‡çš„urlåœ°å€ï¼ŒplaceholderImagæ˜¯å ä½å›¾ï¼Œoptionsæ˜¯æŸä¸ªé€‰é¡¹ï¼Ÿï¼Œprogressæ˜¯è¿›åº¦completedè‚¯å®šå°±æ˜¯å®Œæˆåçš„æ“ä½œå—</p>
<blockquote>
<p>é—®é¢˜1 ï¼š å…¶ä¸­options:0 è¿™ä¸ªoptionså€¼æ˜¯å…·ä½“æ˜¯ä»€ä¹ˆ</p>
</blockquote>
<h3 id="1-1-SDWebImageOptionså…·ä½“å†…å®¹"><a href="#1-1-SDWebImageOptionså…·ä½“å†…å®¹" class="headerlink" title="1.1 SDWebImageOptionså…·ä½“å†…å®¹"></a>1.1 <code>SDWebImageOptions</code>å…·ä½“å†…å®¹</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_OPTIONS</span>(<span class="built_in">NSUInteger</span>, SDWebImageOptions) &#123;</span><br><span class="line">   <span class="comment">//é»˜è®¤æƒ…å†µä¸‹ urlä¸‹è½½å¤±è´¥ï¼Œurlä¼šè¢«ç§»å…¥é»‘åå•</span></span><br><span class="line">   <span class="comment">//è¿™ä¸ªflagå°†urlä»é»‘åå•ä¸­ç§»é™¤</span></span><br><span class="line">   <span class="comment">//ç®€å•æ¥è¯´å°±æ˜¯å¤±è´¥åé‡æ–°ä¸‹è½½</span></span><br><span class="line">   SDWebImageRetryFailed = <span class="number">1</span> &lt;&lt; <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é»˜è®¤å›¾ç‰‡ä¸‹è½½åœ¨UIäº¤äº’çš„æ—¶å€™å¼€å§‹</span></span><br><span class="line">    <span class="comment">//å»¶è¿Ÿä¸‹è½½</span></span><br><span class="line">   SDWebImageLowPriority = <span class="number">1</span> &lt;&lt; <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åªè¿›è¡Œå†…å­˜ç¼“å­˜</span></span><br><span class="line">   SDWebImageCacheMemoryOnly = <span class="number">1</span> &lt;&lt; <span class="number">2</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é»˜è®¤å›¾ç‰‡åªä¼šåœ¨å®Œå…¨ä¸‹è½½å®Œæ˜¾ç¤º</span></span><br><span class="line">    <span class="comment">//è¿™ä¸ªflagå¯ä»¥ä½¿å›¾ç‰‡æ¸è¿›å¼ä¸‹è½½ï¼Œå›¾ç‰‡ä¹Ÿä¼šé€æ­¥æ˜¾ç¤º</span></span><br><span class="line">   SDWebImageProgressiveDownload = <span class="number">1</span> &lt;&lt; <span class="number">3</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åˆ·æ–°ç¼“å­˜</span></span><br><span class="line">   SDWebImageRefreshCached = <span class="number">1</span> &lt;&lt; <span class="number">4</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åå°ä¸‹è½½</span></span><br><span class="line">   SDWebImageContinueInBackground = <span class="number">1</span> &lt;&lt; <span class="number">5</span>,</span><br><span class="line"></span><br><span class="line">   SDWebImageHandleCookies = <span class="number">1</span> &lt;&lt; <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//å…è®¸ä½¿ç”¨æ— æ•ˆçš„SSLè¯ä¹¦</span></span><br><span class="line">   SDWebImageAllowInvalidSSLCertificates = <span class="number">1</span> &lt;&lt; <span class="number">7</span>,</span><br><span class="line"></span><br><span class="line">   <span class="comment">//æœ‰é™åŠ è½½</span></span><br><span class="line">   SDWebImageHighPriority = <span class="number">1</span> &lt;&lt; <span class="number">8</span>,</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//å»¶è¿Ÿå ä½å›¾</span></span><br><span class="line">   SDWebImageDelayPlaceholder = <span class="number">1</span> &lt;&lt; <span class="number">9</span>,</span><br><span class="line"></span><br><span class="line">   SDWebImageTransformAnimatedImage = <span class="number">1</span> &lt;&lt; <span class="number">10</span>,</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//å›¾ç‰‡ä¸‹è½½å æ‰‹åŠ¨åŠ è½½å›¾ç‰‡</span></span><br><span class="line">   SDWebImageAvoidAutoSetImage = <span class="number">1</span> &lt;&lt; <span class="number">11</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œoptionsä½¿ç”¨0ï¼Œè¡¨ç¤ºä¸ä½¿ç”¨ä»»ä½•é€‰é¡¹ </p>
<h2 id="2-sd-setImageWithURLå…·ä½“å®ç°ï¼š"><a href="#2-sd-setImageWithURLå…·ä½“å®ç°ï¼š" class="headerlink" title="2. sd_setImageWithURLå…·ä½“å®ç°ï¼š"></a>2. <code>sd_setImageWithURL</code>å…·ä½“å®ç°ï¼š</h2><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageWithURL:(<span class="built_in">NSURL</span> *)url placeholderImage:(<span class="built_in">UIImage</span> *)placeholder options:(SDWebImageOptions)options progress:(SDWebImageDownloaderProgressBlock)progressBlock completed:(SDWebImageCompletionBlock)completedBlock &#123;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//çœ‹åå­—çŒœæµ‹æ˜¯å–æ¶ˆå½“å‰å›¾ç‰‡åŠ è½½ï¼ˆä»»åŠ¡ï¼‰ </span></span><br><span class="line">   [<span class="keyword">self</span> sd_cancelCurrentImageLoad];</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">//ä½¿ç”¨placeholderå›¾ç‰‡å…ˆå ä½</span></span><br><span class="line">   <span class="keyword">if</span> (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">       dispatch_main_async_safe(^&#123;</span><br><span class="line">           <span class="keyword">self</span>.image = placeholder;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">   </span><br><span class="line">       <span class="comment">//è¿™é‡Œå°±åº”è¯¥æ˜¯ä¸»è¦çš„æ–¹æ³• ä¸‹è½½å›¾ç‰‡äº†</span></span><br><span class="line">       <span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation = [SDWebImageManager.sharedManager downloadImageWithURL:url options:options progress:progressBlock completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">            ...</span><br><span class="line">                   wself.image = image;</span><br><span class="line">                   ...</span><br><span class="line">       &#125;];</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//çœ‹åå­—çŒœæµ‹å°†è¿™ä¸ªå›¾ç‰‡ä¸‹è½½ä»»åŠ¡ä»¥UIImageViewImageLoadä½œä¸ºå…³é”®å­—å‚¨å­˜èµ·æ¥</span></span><br><span class="line">       [<span class="keyword">self</span> sd_setImageLoadOperation:operation forKey:<span class="string">@"UIImageViewImageLoad"</span>];</span><br><span class="line">       </span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-å…ˆçœ‹-self-sd-cancelCurrentImageLoad-ï¼Œ"><a href="#2-1-å…ˆçœ‹-self-sd-cancelCurrentImageLoad-ï¼Œ" class="headerlink" title="2.1 å…ˆçœ‹[self sd_cancelCurrentImageLoad]ï¼Œ"></a>2.1 å…ˆçœ‹<code>[self sd_cancelCurrentImageLoad]</code>ï¼Œ</h3><p>å®ƒæ˜¯è°ƒç”¨äº†ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">	- (<span class="keyword">void</span>)sd_cancelCurrentImageLoad &#123;</span><br><span class="line">    [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:<span class="string">@"UIImageViewImageLoad"</span>];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">`sd_cancelImageLoadOperationWithKey`è¿™ä¸ªæ–¹æ³•åœ¨ `<span class="built_in">UIView</span>+WebCacheOperation`è¿™ä¸ªåˆ†ç±»ä¸­ï¼š</span><br><span class="line">	</span><br><span class="line">	- (<span class="keyword">void</span>)sd_cancelImageLoadOperationWithKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="comment">// Cancel in progress downloader from queue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¼šå°†operation éƒ½å‚¨å­˜åœ¨operationDictionaryï¼Ÿ</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *operationDictionary = [<span class="keyword">self</span> operationDictionary];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å–å‡ºkeyå¯¹åº”çš„operation(s) ï¼Œå¹¶æ‰§è¡Œcancelæ“ä½œï¼Œç„¶åå°†operation(s)ä»operationDictionaryä¸­åˆ é™¤</span></span><br><span class="line">    <span class="keyword">id</span> operations = [operationDictionary objectForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (operations) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([operations isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> &lt;SDWebImageOperation&gt; operation <span class="keyword">in</span> operations) &#123;</span><br><span class="line">                <span class="keyword">if</span> (operation) &#123;</span><br><span class="line">                    [operation cancel];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([operations conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">SDWebImageOperation</span>)])</span>&#123;</span><br><span class="line">            [(<span class="keyword">id</span>&lt;SDWebImageOperation&gt;) operations cancel];</span><br><span class="line">        &#125;</span><br><span class="line">        [operationDictionary removeObjectForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯å°†keyä¸ºUIImageViewImageLoadçš„æ“ä½œéƒ½æ‰§è¡Œcancelæ“ä½œï¼Œæœ€åå°†keyå¯¹åº”çš„å¯¹è±¡å…¨éƒ¨ä»operationDictionaryä¸­åˆ é™¤</p>
<blockquote>
<p>çœ‹åˆ°è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜</p>
</blockquote>
<blockquote>
<p>UIImageViewImageLoadå¯¹åº”çš„æ“ä½œæ˜¯å›¾ç‰‡æ­£åœ¨ä¸‹è½½ä¸­ï¼Œè¿˜æ˜¯ä¸‹è½½å®Œå‘¢ï¼Ÿåº”è¯¥æ˜¯ä¸‹è½½å®Œçš„æ“ä½œï¼Œå› ä¸ºè¦æ˜¯ä¸‹è½½ä¸­æ“ä½œéƒ½è¢«å–æ¶ˆå¹¶ä»operationDictionaryä¸­ç§»é™¤ï¼Œå›¾ç‰‡ä¹Ÿä¸‹ä¸æˆåŠŸäº†ã€‚ä½†æ˜¯è¦æ˜¯å¯¹åº”ä¸‹è½½å®Œï¼Œoperationå·²ç»è¢«ç§»é™¤ï¼Œå®ƒæ˜¯ä¾æ®ä»€ä¹ˆåšåˆ°åŒä¸€urlä¸é‡å¤ä¸‹è½½ï¼Ÿï¼Ÿurlï¼ˆæˆ–è€…urå¯¹åº”çš„ç‰¹å¾ç ï¼‰ä¸å‚¨å­˜åœ¨operationï¼ˆä½†æ˜¯SDWebImageOperationåªæ˜¯ä¸€ä¸ªåè®® åªå£°æ˜äº†cancelæ“ä½œï¼‰ä¸­å—ï¼Ÿè¿˜æœ‰operationDictionaryçš„å†…éƒ¨å‚¨å­˜æ•°æ®çš„ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆä¸€ä¸ªkeyåˆå¯èƒ½æ˜¯æ•°ç»„æœ‰å¯èƒ½æ˜¯å•ä¸ªå¯¹è±¡ï¼Œè¿™æ ·åšä¸æ˜¯éº»çƒ¦ä¸€ç‚¹å—ï¼Ÿå…¨æ”¹æˆä¸€ä¸ªkeyå¯¹åº”ä¸€ä¸ªoperationæ•°ç»„ä¸æ˜¯æ›´æ–¹ä¾¿ï¼Ÿæ‰€ä»¥é—®é¢˜å°±è¿™å‡ ä¸ªï¼š</p>
</blockquote>
<ul>
<li><p>é—®é¢˜2:UIImageViewImageLoadå¯¹åº”çš„æ˜¯ä»€ä¹ˆæ“ä½œ</p>
</li>
<li><p>é—®é¢˜3:operationçš„å®ç°ï¼ˆSDWebImageOperationä¸­çš„cancelæ–¹æ³•å®ç° å’Œ å†…éƒ¨çš„å±æ€§ç­‰ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">SDWebImageOperation</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line">- (<span class="keyword">void</span>)cancel;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é—®é¢˜4ï¼šä¸é‡å¤ä¸‹è½½ç›¸åŒurl æ˜¯æ ¹æ®operationåšçš„ï¼Œè¿˜æ˜¯æ ¹æ®å…¶ä»–å¯¹è±¡å®ç°çš„</p>
</li>
<li><p>é—®é¢˜5ï¼šoperationDictionaryçš„å†…éƒ¨å‚¨å­˜æ•°æ®ï¼ˆèƒ½å­˜ä»€ä¹ˆkeyï¼Œkeyå¯¹åº”çš„å¯¹è±¡æ˜¯æ•°ç»„è¿˜æ˜¯å…¶ä»–ï¼‰</p>
<ul>
<li>ç›®å‰çŸ¥é“æœ‰ä¸ªkey ä¸ºUIImageViewImageLoad ï¼Œçœ‹ä»£ç çŒœæµ‹å½“Operationæ•°é‡ä¸ºå¤šä¸ªæ—¶ï¼Œkeyå¯¹åº”çš„æ˜¯<code>NSArray&lt;SDWebImageOperation*&gt;</code> å¯¹è±¡ï¼Œå½“æ•°é‡ä¸ºå•ä¸ªæ—¶keyå¯¹åº”çš„æ˜¯ <code>SDWebImageOperation*</code>å¯¹è±¡ï¼ˆæˆ–è€…æ˜¯è€ƒè™‘åˆ°å…¼å®¹é—®é¢˜ï¼Ÿï¼‰</li>
</ul>
</li>
</ul>
<p>æ„Ÿè§‰è¿™å‡ ä¸ªé—®é¢˜éƒ½å¯ä»¥åœ¨ä¸‹è½½çš„å…·ä½“æ­¥éª¤ä¸­è§£å†³æ‰ã€‚ã€‚</p>
<h3 id="2-2-æ¥ä¸‹æ¥çœ‹-dispatch-main-async-safe"><a href="#2-2-æ¥ä¸‹æ¥çœ‹-dispatch-main-async-safe" class="headerlink" title="2.2 æ¥ä¸‹æ¥çœ‹ dispatch_main_async_safe"></a>2.2 æ¥ä¸‹æ¥çœ‹ <code>dispatch_main_async_safe</code></h3><p>å®ƒçš„å®ç°å°±æ˜¯ä¸€ä¸ªå®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#define dispatch_main_async_safe(block)\</span></span><br><span class="line">   <span class="keyword">if</span> ([<span class="built_in">NSThread</span> isMainThread]) &#123;\</span><br><span class="line">       block();\</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;\</span><br><span class="line">       <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), block);\</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™ä¸ªæˆ‘æœ‰ä¸ªè ¢é—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿï¼Ÿå°±ç®—æ˜¯å·²ç»åœ¨ä¸»çº¿ç¨‹ ä½†æ˜¯å†æ‰§è¡Œdispatch_async(dispatch_get_main_queue(), block)ä¹Ÿä¸ä¼šé”™å§ï¼Ÿï¼Ÿè™½ç„¶æ˜¯ä¼šæ„Ÿè§‰å¤šæ­¤ä¸€ä¸¾ï¼Œä½†æ˜¯è¿™æ ·åšå…¶ä»–çš„å½±å“å‘¢ï¼Œä¼šå½±å“æ€§èƒ½å—ã€‚ã€‚    </p>
</blockquote>
<h3 id="2-3-self-showActivityIndicatorView"><a href="#2-3-self-showActivityIndicatorView" class="headerlink" title="2.3 [self showActivityIndicatorView]"></a>2.3 <code>[self showActivityIndicatorView]</code></h3><p>æˆ‘åŠ ä¸Š [cell.imageView setShowActivityIndicatorView:true];ä¹Ÿæ²¡æœ‰çœ‹åˆ°ç­‰å¾…æŒ‡ç¤ºå™¨ã€‚ã€‚æ˜¯ç½‘é€Ÿå¤ªå¿«äº†è¿˜æ˜¯éœ€è¦å…¶ä»–è®¾ç½®ã€‚ã€‚ä¸ç®¡äº†</p>
<h3 id="2-4-self-sd-setImageLoadOperation-operation-forKey-quot-UIImageViewImageLoad-quot"><a href="#2-4-self-sd-setImageLoadOperation-operation-forKey-quot-UIImageViewImageLoad-quot" class="headerlink" title="2.4 [self sd_setImageLoadOperation:operation forKey:@&quot;UIImageViewImageLoad&quot;];"></a>2.4 <code>[self sd_setImageLoadOperation:operation forKey:@&quot;UIImageViewImageLoad&quot;];</code></h3><p>çœ‹ä¸‹å®ƒçš„ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)sd_setImageLoadOperation:(<span class="keyword">id</span>)operation forKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">   [<span class="keyword">self</span> sd_cancelImageLoadOperationWithKey:key];</span><br><span class="line">   <span class="built_in">NSMutableDictionary</span> *operationDictionary = [<span class="keyword">self</span> operationDictionary];</span><br><span class="line">   [operationDictionary setObject:operation forKey:key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒå°†Operationä»¥keyä¸º UIImageViewImageLoad å­˜å…¥operationDictionaryï¼Œè€Œè¿™æ—¶Operationå¯¹åº”çš„ä¸‹è½½è‚¯å®šæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥UIImageViewImageLoadå¯¹åº”çš„æ˜¯å›¾ç‰‡æ­£åœ¨ä¸‹è½½ä¸­çš„æ“ä½œã€‚</p>
<ul>
<li>å›ç­”é—®é¢˜2ï¼šUIImageViewImageLoadå¯¹åº”çš„æ˜¯å›¾ç‰‡æ­£åœ¨ä¸‹è½½ä¸­çš„æ“ä½œã€‚</li>
<li>å›ç­”é—®é¢˜5ï¼ˆéƒ¨åˆ†ï¼‰ï¼šoperationDictionaryä¸­ä»¥ key-operation æ–¹å¼å‚¨å­˜ï¼ˆkey-nsarrayæ–¹å¼æš‚æ—¶æ²¡çœ‹åˆ°ï¼‰</li>
</ul>
<p>è‹¥æ˜¯å½“ç¬¬ä¸€ä¸ªå›¾ç‰‡æ²¡ä¸‹è½½å®Œï¼Œç¬¬äºŒå›¾ç‰‡ä¸‹è½½ä»»åŠ¡è¿›æ¥ä¸å°±å–æ¶ˆä¹‹å‰æ‰€æœ‰çš„UIImageViewImageLoadçš„operationäº†ï¼Ÿï¼Ÿé‚£ä¹‹å‰çš„å›¾ç‰‡æ€ä¹ˆä¸‹è½½å®Œï¼Ÿéš¾é“cancelä¹‹åä¼šè‡ªåŠ¨resumeå—ï¼Ÿ</p>
<ul>
<li>é—®é¢˜6ï¼šUIImageViewImageLoadçš„operationæ‰§è¡Œ cancelåï¼Œåœ¨å“ªé‡Œä¼šç»§ç»­ä¸‹è½½ï¼Ÿ</li>
</ul>
<h2 id="3-æ¥ä¸‹æ¥å°±æ˜¯å†…å®¹æœ€å¤šçš„ä¸‹è½½åŠŸèƒ½äº†"><a href="#3-æ¥ä¸‹æ¥å°±æ˜¯å†…å®¹æœ€å¤šçš„ä¸‹è½½åŠŸèƒ½äº†" class="headerlink" title="3 æ¥ä¸‹æ¥å°±æ˜¯å†…å®¹æœ€å¤šçš„ä¸‹è½½åŠŸèƒ½äº†"></a>3 æ¥ä¸‹æ¥å°±æ˜¯å†…å®¹æœ€å¤šçš„ä¸‹è½½åŠŸèƒ½äº†</h2><p><code>[SDWebImageManager.sharedManager downloadImageWithURL: l options:  progress:  completed:</code></p>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -ç®€ä»‹</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h2 id="SDWebImage-3-7-5ç®€ä»‹"><a href="#SDWebImage-3-7-5ç®€ä»‹" class="headerlink" title="SDWebImage 3.7.5ç®€ä»‹"></a>SDWebImage 3.7.5ç®€ä»‹</h2><p>githubåœ°å€ï¼š <a href="https://github.com/rs/SDWebImage" target="_blank" rel="noopener">https://github.com/rs/SDWebImage</a></p>
<blockquote>
<p>åŠŸèƒ½</p>
</blockquote>
<ul>
<li>å¼‚æ­¥å›¾ç‰‡ä¸‹è½½</li>
<li>å¼‚æ­¥å›¾ç‰‡ç¼“å­˜</li>
<li>GIFæ”¯æŒ</li>
<li>WebPå›¾ç‰‡æ ¼å¼æ”¯æŒ</li>
<li>åå°å›¾ç‰‡è§£æ</li>
<li>ç›¸åŒURLä¸ä¼šè¢«å¤šæ¬¡ä¸‹è½½</li>
<li>æ— æ•ˆURLä¸ä¼šå¤šæ¬¡å°è¯•é“¾æ¥</li>
</ul>
<a id="more"></a> 
<h2 id="TableViewåŠ è½½å›¾ç‰‡ä½¿ç”¨UIImageView-WebCacheåˆ†ç±»"><a href="#TableViewåŠ è½½å›¾ç‰‡ä½¿ç”¨UIImageView-WebCacheåˆ†ç±»" class="headerlink" title="TableViewåŠ è½½å›¾ç‰‡ä½¿ç”¨UIImageView+WebCacheåˆ†ç±»"></a>TableViewåŠ è½½å›¾ç‰‡ä½¿ç”¨UIImageView+WebCacheåˆ†ç±»</h2><ol>
<li>æ·»åŠ UIImageView+WebCache.hå¤´æ–‡ä»¶</li>
<li>åœ¨tableViewçš„æ•°æ®æºæ–¹æ³•tableView:cellForRowAtIndexPath: ä¸­è°ƒç”¨sd_setImageWithURL:placeholderImage:æ–¹æ³•</li>
</ol>
<p>ç¤ºä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;SDWebImage/UIImageView+WebCache.h&gt;</span></span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="built_in">NSString</span> *MyIdentifier = <span class="string">@"MyIdentifier"</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:MyIdentifier];</span><br><span class="line">   <span class="keyword">if</span> (cell == <span class="literal">nil</span>) &#123;</span><br><span class="line">       cell = [[[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleDefault</span></span><br><span class="line">                                      reuseIdentifier:MyIdentifier] autorelease];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Here we use the new provided sd_setImageWithURL: method to load the web image</span></span><br><span class="line">   [cell.imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.domain.com/path/to/image.jpg"</span>]</span><br><span class="line">                     placeholderImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"placeholder.png"</span>]];</span><br><span class="line"></span><br><span class="line">   cell.textLabel.text = <span class="string">@"My Text"</span>;</span><br><span class="line">   <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ä½¿ç”¨Blocks"><a href="#ä½¿ç”¨Blocks" class="headerlink" title="ä½¿ç”¨Blocks"></a>ä½¿ç”¨Blocks</h2><p>ä½¿ç”¨blockï¼Œä½ å°†èƒ½å¤Ÿå¾—åˆ°å›¾ç‰‡çš„ä¸‹è½½è¿›åº¦å¹¶è·çŸ¥å›¾ç‰‡æ˜¯å¦ä¸‹è½½æˆåŠŸæˆ–è€…å¤±è´¥ï¼š</p>
<blockquote>
<p>æ³¨æ„ï¼šå¦‚æœå›¾åƒè¯·æ±‚åœ¨å®Œæˆå‰è¢«å–æ¶ˆäº†ï¼Œé‚£ä¹ˆæˆåŠŸå’Œå¤±è´¥çš„blockå—å°†éƒ½ä¸ä¼šè¢«è°ƒç”¨ã€‚</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Here we use the new provided sd_setImageWithURL: method to load the web image</span></span><br><span class="line">[cell.imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"http://www.domain.com/path/to/image.jpg"</span>]</span><br><span class="line">                     placeholderImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"placeholder.png"</span>]</span><br><span class="line">                            completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">                               ... completion code here ...</span><br><span class="line">                            &#125;];</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ä½¿ç”¨SDWebImageManager"><a href="#ä½¿ç”¨SDWebImageManager" class="headerlink" title="ä½¿ç”¨SDWebImageManager"></a>ä½¿ç”¨SDWebImageManager</h2><blockquote>
<p>UIImageView+WebCacheåˆ†ç±»èƒŒåè°ƒç”¨çš„æ˜¯SDWebImageManagerç±»çš„æ–¹æ³•ï¼Œè´Ÿè´£å›¾åƒçš„å¼‚æ­¥ä¸‹è½½å’Œç¼“å­˜å¤„ç†ã€‚ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»æ¥ä¸‹è½½å›¾ç‰‡å’Œè¿›è¡Œç¼“å­˜å¤„ç†ã€‚</p>
</blockquote>
<p>è¿™æœ‰ä¸€ä¸ªå¦‚ä½•ä½¿ç”¨SDWebImageManagerçš„ç®€å•ç¤ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SDWebImageManager *manager = [SDWebImageManager sharedManager];</span><br><span class="line">[manager downloadImageWithURL:imageURL</span><br><span class="line">                     options:<span class="number">0</span></span><br><span class="line">                    progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</span><br><span class="line">                        <span class="comment">// progression tracking code</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (image) &#123;</span><br><span class="line">                            <span class="comment">// do something with image</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;];</span><br></pre></td></tr></table></figure>
<h2 id="å•ç‹¬å¼‚æ­¥ä¸‹è½½å›¾ç‰‡"><a href="#å•ç‹¬å¼‚æ­¥ä¸‹è½½å›¾ç‰‡" class="headerlink" title="å•ç‹¬å¼‚æ­¥ä¸‹è½½å›¾ç‰‡"></a>å•ç‹¬å¼‚æ­¥ä¸‹è½½å›¾ç‰‡</h2><p>å®ƒä¹Ÿå¯ä»¥ç‹¬ç«‹ä½¿ç”¨å¼‚æ­¥å›¾ç‰‡ä¸‹è½½ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SDWebImageDownloader *downloader = [SDWebImageDownloader sharedDownloader];</span><br><span class="line">[downloader downloadImageWithURL:imageURL</span><br><span class="line">                        options:<span class="number">0</span></span><br><span class="line">                       progress:^(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize) &#123;</span><br><span class="line">                           <span class="comment">// progression tracking code</span></span><br><span class="line">                       &#125;</span><br><span class="line">                      completed:^(<span class="built_in">UIImage</span> *image, <span class="built_in">NSData</span> *data, <span class="built_in">NSError</span> *error, <span class="built_in">BOOL</span> finished) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (image &amp;&amp; finished) &#123;</span><br><span class="line">                               <span class="comment">// do something with image</span></span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;];</span><br></pre></td></tr></table></figure>
<h2 id="å•ç‹¬å¼‚æ­¥ç¼“å­˜å›¾ç‰‡"><a href="#å•ç‹¬å¼‚æ­¥ç¼“å­˜å›¾ç‰‡" class="headerlink" title="å•ç‹¬å¼‚æ­¥ç¼“å­˜å›¾ç‰‡"></a>å•ç‹¬å¼‚æ­¥ç¼“å­˜å›¾ç‰‡</h2><p>ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨åŸºäºå›¾åƒçš„é«˜é€Ÿå¼‚æ­¥ç¼“å­˜å¤„ç†ã€‚SDImagecacheæä¾›å†…å­˜é«˜é€Ÿç¼“å­˜å’Œå¯é€‰çš„ç£ç›˜é«˜é€Ÿç¼“å­˜ã€‚ç£ç›˜é«˜é€Ÿç¼“å­˜å†™å…¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨ç”¨æˆ·ç•Œé¢æ·»åŠ ä¸å¿…è¦çš„å»¶è¿Ÿã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼ŒSDImageCacheç±»æä¾›äº†ä¸€ä¸ªå•ä¸€çš„å®ä¾‹ï¼Œä½†å¦‚æœä½ æƒ³è‡ªå®šä¹‰ç¼“å­˜ç©ºé—´ï¼Œé‚£ä¹ˆå¯ä»¥åˆ›å»ºè‡ªå·±çš„å®ä¾‹ã€‚</p>
<p>æ‚¨å¯ä»¥ä½¿ç”¨queryDiskCacheForKeyï¼šdoneï¼šæ–¹æ³•æŸ¥æ‰¾ç¼“å­˜ã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å›nilï¼Œåˆ™è¯´æ˜å½“å‰imageæ²¡æœ‰ç¼“å­˜ã€‚ä½ éœ€è¦è´Ÿè´£ä¸‹è½½å’Œè¿›è¡Œç¼“å­˜å¤„ç†ã€‚å›¾åƒç¼“å­˜çš„keyé€šå¸¸ä¸ºè¯¥å›¾åƒçš„URLã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">SDImageCache *imageCache = [[SDImageCache alloc] initWithNamespace:<span class="string">@"myNamespace"</span>];</span><br><span class="line">[imageCache queryDiskCacheForKey:myCacheKey done:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">   <span class="comment">// image is not nil if image was found</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœå¯¹åº”å›¾ç‰‡çš„å†…å­˜ç¼“å­˜ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆSDImageCacheå°†æŸ¥æ‰¾ç£ç›˜ç¼“å­˜ã€‚å¯ä»¥é€šè¿‡è°ƒç”¨imageFromMemoryCacheForKeyï¼šæ–¹æ³•æ¥é˜»æ­¢ã€‚</p>
<p>ä½ å¯ä»¥è°ƒç”¨storeImage:forKey: method:æ–¹æ³•ä¿å­˜å›¾ç‰‡åˆ°ç¼“å­˜ã€‚<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[[SDImageCache sharedImageCache] storeImage:myImage forKey:myCacheKey];</span><br></pre></td></tr></table></figure></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå›¾åƒå°†è¢«è¿›è¡Œå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ï¼ˆå¼‚æ­¥ï¼‰ã€‚å¦‚æœä½ åªæƒ³è¦å†…å­˜ç¼“å­˜ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨storeImage:forKey:toDisk:æ–¹æ³•ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¼ NOå³å¯ã€‚</p>
<h2 id="ä½¿ç”¨ç¼“å­˜keyç­›é€‰å™¨"><a href="#ä½¿ç”¨ç¼“å­˜keyç­›é€‰å™¨" class="headerlink" title="ä½¿ç”¨ç¼“å­˜keyç­›é€‰å™¨"></a>ä½¿ç”¨ç¼“å­˜keyç­›é€‰å™¨</h2><p>æœ‰æ—¶ï¼Œä½ å¯èƒ½ä¼šå› ä¸ºURLçš„ä¸€éƒ¨åˆ†æ˜¯åŠ¨æ€çš„è€Œä¸å¸Œæœ›ä½¿ç”¨URLä½œä¸ºå›¾åƒç¼“å­˜çš„keyã€‚ SDWebImageManageræä¾›äº†ä¸€ç§æ–¹å¼æ¥è®¾ç½®ï¼Œè¾“å…¥URLè¾“å‡ºå¯¹åº”çš„å­—ç¬¦ä¸²ã€‚<br>ä¸‹é¢çš„ç¤ºä¾‹åœ¨åº”ç”¨ç¨‹åºçš„å§”æ‰˜ä¸­è®¾ç½®ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨ä½¿ç”¨å®ƒçš„ç¼“å­˜é”®ä¹‹å‰å°†ä»URLä¸­åˆ é™¤ä»»ä½•æŸ¥è¯¢å­—ç¬¦ä¸²</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">   SDWebImageManager.sharedManager.cacheKeyFilter = ^(<span class="built_in">NSURL</span> *url) &#123;</span><br><span class="line">       url = [[<span class="built_in">NSURL</span> alloc] initWithScheme:url.scheme host:url.host path:url.path];</span><br><span class="line">       <span class="keyword">return</span> [url absoluteString];</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Your app init code...</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨åŠ¨æ€å›¾åƒå¤§å°çš„UITableViewCell"><a href="#ä½¿ç”¨åŠ¨æ€å›¾åƒå¤§å°çš„UITableViewCell" class="headerlink" title="ä½¿ç”¨åŠ¨æ€å›¾åƒå¤§å°çš„UITableViewCell"></a>ä½¿ç”¨åŠ¨æ€å›¾åƒå¤§å°çš„UITableViewCell</h2><p>UITableViewCellé€šè¿‡ç¬¬ä¸€ä¸ªå•å…ƒæ ¼è®¾ç½®çš„å›¾åƒå†³å®šå›¾åƒçš„å°ºå¯¸ã€‚å¦‚æœä½ åŠ è½½çš„ç½‘ç»œå›¾ç‰‡å’Œå ä½ç¬¦å›¾åƒå°ºå¯¸ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½ä¼šé‡åˆ°å¥‡æ€ªçš„å˜å½¢æ¯”ä¾‹é—®é¢˜ã€‚ä¸‹é¢çš„æ–‡ç« ç»™å‡ºäº†è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•ï¼š</p>
<p><a href="http://www.wrichards.com/blog/2011/11/sdwebimage-fixed-width-cell-images/" target="_blank" rel="noopener">sdwebimage-fixed-width-cell-images</a></p>
<h2 id="å¤„ç†å›¾åƒåˆ·æ–°"><a href="#å¤„ç†å›¾åƒåˆ·æ–°" class="headerlink" title="å¤„ç†å›¾åƒåˆ·æ–°"></a>å¤„ç†å›¾åƒåˆ·æ–°</h2><p>SDWebimageé»˜è®¤æƒ…å†µä¸‹åšäº†å¾ˆå¥½çš„ç¼“å­˜å¤„ç†ã€‚å®ƒå¿½ç•¥é€šè¿‡HTTPæœåŠ¡å™¨è¿”å›çš„æ‰€æœ‰ç±»å‹çš„ç¼“å­˜æ§åˆ¶å¤´ï¼Œå¹¶ä¸”æ²¡æœ‰æ—¶é—´é™åˆ¶åœ°ç¼“å­˜è¿”å›çš„å›¾åƒ<br>å®ƒæ„å‘³ç€ä½ çš„urlæŒ‡å‘çš„å›¾ç‰‡æ˜¯ä¸€æˆä¸å˜çš„ã€‚æ›´å¥½çš„åšæ³•æ˜¯å¦‚æœurlæŒ‡å‘çš„å›¾ç‰‡å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£ä¹ˆå›¾ç‰‡ä¹Ÿåº”è¯¥å˜åŒ–ã€‚<br>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨SDWebImageRefreshCachedæ ‡å¿—ã€‚è¿™å°†ç•¥å¾®é™ä½æ€§èƒ½ï¼Œä½†ä¼šå°Šé‡HTTPç¼“å­˜æ§åˆ¶å¤´ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[imageView sd_setImageWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://graph.facebook.com/olivier.poitrey/picture"</span>]</span><br><span class="line">                placeholderImage:[<span class="built_in">UIImage</span> imageNamed:<span class="string">@"avatar-placeholder.png"</span>]</span><br><span class="line">                         options:SDWebImageRefreshCached];</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨"><a href="#æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨" class="headerlink" title="æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨"></a>æ·»åŠ è¿›åº¦æŒ‡ç¤ºå™¨</h2><p>å‚è€ƒï¼š<a href="https://github.com/JJSaccolo/UIActivityIndicator-for-SDWebImage" target="_blank" rel="noopener">UIActivityIndicator-for-SDWebImage</a></p>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -è´°</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-%E8%B4%B0/</url>
    <content><![CDATA[<h3 id="3-downloadImageWithURLä¸‹è½½æ–¹æ³•çš„å…·ä½“å®ç°"><a href="#3-downloadImageWithURLä¸‹è½½æ–¹æ³•çš„å…·ä½“å®ç°" class="headerlink" title="3. downloadImageWithURLä¸‹è½½æ–¹æ³•çš„å…·ä½“å®ç°"></a>3. downloadImageWithURLä¸‹è½½æ–¹æ³•çš„å…·ä½“å®ç°</h3><p>æ–¹æ³•åœ¨SDWebImageManager.mä¸­</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> &lt;SDWebImageOperation&gt;)downloadImageWithURL:(<span class="built_in">NSURL</span> *)url 	</span><br><span class="line">	options:(SDWebImageOptions)options </span><br><span class="line">	progress:(SDWebImageDownloaderProgressBlock)progressBlock </span><br><span class="line">	completed:(SDWebImageCompletionWithFinishedBlock)completedBlock</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å‚æ•°ï¼š    </p>
</blockquote>
<ul>
<li>url</li>
<li>options<ul>
<li>ä¹‹å‰å·²ç»ä»‹ç»äº† SDWebImageOptions</li>
</ul>
</li>
<li><p>progressBlock</p>
<ul>
<li>SDWebImageDownloaderProgressBlock å®šä¹‰åœ¨ SDWebImageDownloader.h ä¸­å…·ä½“å®ç°ä¸ºï¼š   <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»åå­—å¯ä»¥çœ‹å‡ºæ¥ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å·²ç»æ¥å—äº†æ•°æ®çš„å¤§å°</span></span><br><span class="line"><span class="comment">//å¦ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ€»æ•°æ®çš„å¤§å°</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageDownloaderProgressBlock)(<span class="built_in">NSInteger</span> receivedSize, <span class="built_in">NSInteger</span> expectedSize);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>completedBlock</p>
<ul>
<li>å›¾ç‰‡ä¸‹è½½å®Œè¦åšçš„å— å…·ä½“å®ç°ä¸ºï¼š                   <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">		</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^SDWebImageCompletionWithFinishedBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>ç„¶åä¸€çœ‹è¿™ä¸ªæ–¹æ³•å®ç°â€¦â€¦éº»è›‹ å¥½é•¿ï¼    </p>
<a id="more"></a>
<h3 id="3-1-ä¸€äº›åˆ¤æ–­"><a href="#3-1-ä¸€äº›åˆ¤æ–­" class="headerlink" title="3.1 ä¸€äº›åˆ¤æ–­"></a>3.1 ä¸€äº›åˆ¤æ–­</h3><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="built_in">NSAssert</span>(completedBlock != <span class="literal">nil</span>, <span class="string">@"If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> ([url isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">    url = [<span class="built_in">NSURL</span> URLWithString:(<span class="built_in">NSString</span> *)url];</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (![url isKindOfClass:<span class="built_in">NSURL</span>.class]) &#123;</span><br><span class="line">    url = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-SDWebImageCombinedOperation"><a href="#3-2-SDWebImageCombinedOperation" class="headerlink" title="3.2 SDWebImageCombinedOperation"></a>3.2 <code>SDWebImageCombinedOperation</code></h3><p>ä¸‹æ¥çœ‹åˆ°äº†ä¸€ä¸ªç±» SDWebImageCombinedOperation</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">__block SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</span><br><span class="line">   __<span class="keyword">weak</span> SDWebImageCombinedOperation *weakOperation = operation;</span><br></pre></td></tr></table></figure>
<p>å®ƒçš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å¤´</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">SDWebImageCombinedOperation</span> : <span class="title">NSObject</span> &lt;<span class="title">SDWebImageOperation</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">assign</span>, <span class="keyword">nonatomic</span>, <span class="keyword">getter</span> = isCancelled) <span class="built_in">BOOL</span> cancelled;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>, <span class="keyword">nonatomic</span>) SDWebImageNoParamsBlock cancelBlock;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSOperation</span> *cacheOperation;</span><br><span class="line"><span class="keyword">@end</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">//å®ç°</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SDWebImageCombinedOperation</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCancelBlock:(SDWebImageNoParamsBlock)cancelBlock &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">       <span class="keyword">if</span> (cancelBlock) &#123;</span><br><span class="line">           cancelBlock();</span><br><span class="line">       &#125;</span><br><span class="line">       _cancelBlock = <span class="literal">nil</span>; </span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       _cancelBlock = [cancelBlock <span class="keyword">copy</span>];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cacheOperation å¯¹åº”çš„åˆ°åº•æ˜¯ ä¸‹è½½æ“ä½œè¿˜æ˜¯ ç¼“å­˜ç›¸å…³çš„æ“ä½œã€‚ã€‚</span></span><br><span class="line">- (<span class="keyword">void</span>)cancel &#123;</span><br><span class="line">   <span class="keyword">self</span>.cancelled = <span class="literal">YES</span>;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.cacheOperation) &#123;</span><br><span class="line">       [<span class="keyword">self</span>.cacheOperation cancel];</span><br><span class="line">       <span class="keyword">self</span>.cacheOperation = <span class="literal">nil</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.cancelBlock) &#123;</span><br><span class="line">       <span class="keyword">self</span>.cancelBlock();</span><br><span class="line"></span><br><span class="line">       _cancelBlock = <span class="literal">nil</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å®ƒå®ç°äº†    SDWebImageOperationå¥½æ­¹æ˜¯å›ç­”äº†ä¹‹å‰çš„é—®é¢˜3</p>
<ul>
<li>å›ç­”é—®é¢˜3ï¼ˆéƒ¨åˆ†ï¼‰ï¼šSDWebImageOperationçš„å®ç°ä¹‹ä¸€æ˜¯SDWebImageCombinedOperation</li>
</ul>
<p>ä½†æ˜¯è¿™ä¸ªcacheOperation å‘½åä»¤æˆ‘å¾ˆå›°æƒ‘ã€‚ã€‚å› ä¸ºåˆ°ç°åœ¨è¿˜ä¸çŸ¥é“ä¸‹è½½æ“ä½œä¼šæ”¾åœ¨é‚£é‡Œã€‚ã€‚</p>
<ul>
<li>é—®é¢˜7 ï¼š SDWebImageCombinedOperationçš„cacheOperationæ‰§è¡Œä»€ä¹ˆæ“ä½œ</li>
</ul>
<p>ç„¶åå®ƒçš„å±æ€§cancelBlockæ˜¯ é•¿è¿™æ ·çš„ <code>typedef void(^SDWebImageNoParamsBlock)();</code>å¥½åƒæ²¡ä»€ä¹ˆç”¨çš„æ ·å­ã€‚ã€‚</p>
<h3 id="3-3-isFailedUrl"><a href="#3-3-isFailedUrl" class="headerlink" title="3.3 isFailedUrl"></a>3.3 <code>isFailedUrl</code></h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯å·²ç»ä¸‹è½½å¤±è´¥çš„url</span></span><br><span class="line"><span class="built_in">BOOL</span> isFailedUrl = <span class="literal">NO</span>;</span><br><span class="line">   <span class="keyword">@synchronized</span> (<span class="keyword">self</span>.failedURLs) &#123;</span><br><span class="line">       isFailedUrl = [<span class="keyword">self</span>.failedURLs containsObject:url];</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//å½“urlæ˜¯å¤±è´¥è¿‡çš„urlå¹¶ä¸”optionsä¸æ˜¯SDWebImageRetryFailed æ—¶ç›´æ¥æŠ¥é”™    </span></span><br><span class="line">   <span class="keyword">if</span> (url.absoluteString.length == <span class="number">0</span> || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</span><br><span class="line">       dispatch_main_sync_safe(^&#123;</span><br><span class="line">           <span class="built_in">NSError</span> *error = [<span class="built_in">NSError</span> errorWithDomain:<span class="built_in">NSURLErrorDomain</span> code:<span class="built_in">NSURLErrorFileDoesNotExist</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">           completedBlock(<span class="literal">nil</span>, error, SDImageCacheTypeNone, <span class="literal">YES</span>, url);</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> operation;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ ç»ˆäºè§£å†³äº†ä¹‹å‰çš„ç¬¬å››ä¸ªé—®é¢˜ï¼ŒfailedURLså°±å‚¨å­˜äº†å¤±æ•ˆçš„urlï¼Œä¹Ÿå°±æ˜¯ä¾æ®è¿™ä¸ªåšå‡ºä¸é‡å¤ä¸‹è½½çš„åŠŸèƒ½</p>
<ul>
<li>å›ç­”é—®é¢˜4ï¼š ä¸é‡å¤ä¸‹è½½ç›¸åŒurl æ˜¯æ ¹æ®SDWebImageManager.failedURLsæ¥å®ç°çš„</li>
</ul>
<p>çœ‹åˆ°è¿™é‡Œ è¿˜æ²¡æœ‰çœ‹è§ä¸‹è½½çš„åŠŸèƒ½ã€‚ã€‚åˆ¤æ–­äº†è¿™ä¹ˆå¤šæ¡ä»¶ çœŸæ˜¯å€¼å¾—å­¦ä¹ å•Šã€‚ã€‚</p>
<h3 id="3-4-å‚¨å­˜operationï¼Œç”ŸæˆcacheOperationå®ä¾‹"><a href="#3-4-å‚¨å­˜operationï¼Œç”ŸæˆcacheOperationå®ä¾‹" class="headerlink" title="3.4 å‚¨å­˜operationï¼Œç”ŸæˆcacheOperationå®ä¾‹"></a>3.4 å‚¨å­˜operationï¼Œç”ŸæˆcacheOperationå®ä¾‹</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//å°†ä¹‹å‰ç”Ÿæˆçš„ SDWebImageCombinedOperation *operation</span></span><br><span class="line"><span class="comment">//å­˜å…¥ runningOperations</span></span><br><span class="line"><span class="keyword">@synchronized</span> (<span class="keyword">self</span>.runningOperations) &#123;</span><br><span class="line">	[<span class="keyword">self</span>.runningOperations addObject:operation];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰ä¸æ˜¯çŒœæµ‹ SDWebImageCombinedOperationä¸­çš„ cacheOperationæ˜¯ç¼“å­˜è¿˜æ˜¯ä¸‹è½½çš„æ“ä½œå—ï¼Œåˆ°è¿™é‡Œå°±å¯ä»¥çŒœå‡ºæ¥ï¼Œåº”è¯¥æ˜¯ç¼“å­˜å’Œä¸‹è½½æ“ä½œéƒ½æœ‰ï¼Œå› ä¸ºè¦æ˜¯åªæ˜¯ç¼“å­˜æ“ä½œçš„è¯ï¼Œè¿™ä¸ªæ“ä½œä¸ä¼šè¿›è¡Œå¾ˆä¹…ï¼Œä¸€èˆ¬ä¹Ÿä¸éœ€è¦å‚¨å­˜èµ·æ¥ç®¡ç†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//åº”è¯¥æ˜¯ç”Ÿæˆå›¾ç‰‡ç¼“å­˜è·¯å¾„å¯¹åº”çš„key</span></span><br><span class="line"><span class="built_in">NSString</span> *key = [<span class="keyword">self</span> cacheKeyForURL:url];</span><br></pre></td></tr></table></figure>
<p>æ¥çœ‹çœ‹å®ƒçš„å®ç°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)cacheKeyForURL:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.cacheKeyFilter) &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">self</span>.cacheKeyFilter(url);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> [url absoluteString];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­    cacheKeyFilteræ˜¯è¿‡æ»¤urlç”¨çš„ï¼Œå®ƒæ˜¯ä¸ªSDWebImageCacheKeyFilterBlockå—ï¼Œä½œè€…æ³¨è§£ä¸­å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œå®ƒå¯ä»¥ç”¨æ¥åˆ é™¤urlä¸­åŠ¨æ€ç”Ÿæˆçš„éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸€äº›â€œï¼Ÿâ€ä¹‹åçš„å‚æ•°ä»€ä¹ˆçš„ï¼Œä½†æ˜¯æˆ‘æ²¡ç”¨åˆ°ï¼Œè¿™é‡Œå°±ä¸è®¨è®ºå¦‚ä½•è‡ªå®šä¹‰è¿™ä¸ªSDWebImageCacheKeyFilterBlockå—äº†ã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹å§ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">operation.cacheOperation = [<span class="keyword">self</span>.imageCache queryDiskCacheForKey:key done:^(<span class="built_in">UIImage</span> *image, SDImageCacheType cacheType) &#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//ä¸€å¤§ä¸² å—å†…å®¹ï¼Œ</span></span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> operation;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç»ˆäºè¦å¼€å§‹å®ç°cacheoperationäº†ã€‚ã€‚</p>
<p>å…¶ä¸­self.imageCache æ˜¯åœ¨initæ–¹æ³•ä¸­ç”Ÿæˆçš„ å°±æ˜¯ç”Ÿæˆä¸€ä¸ªSDImageCacheçš„å•ä¾‹ï¼š<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (SDImageCache *)createCache &#123;</span><br><span class="line">   	<span class="keyword">return</span> [SDImageCache sharedImageCache];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æ¥ç€æ¥çœ‹<code>queryDiskCacheForKey:</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="built_in">NSOperation</span> *)queryDiskCacheForKey:(<span class="built_in">NSString</span> *)key done:(SDWebImageQueryCompletedBlock)doneBlock &#123;</span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">   <span class="comment">//åœ¨å†…å­˜ä¸­æŸ¥çœ‹æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">   <span class="comment">//å…¶å®å°±æ˜¯åœ¨NSCacheç±»çš„ä¸€ä¸ªmemCacheå¯¹è±¡ä¸­æŸ¥æ‰¾</span></span><br><span class="line">   <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span> imageFromMemoryCacheForKey:key];</span><br><span class="line">   <span class="keyword">if</span> (image) &#123;</span><br><span class="line">       doneBlock(image, SDImageCacheTypeMemory);</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">NSOperation</span> *operation = [<span class="built_in">NSOperation</span> new];</span><br><span class="line">   <span class="comment">//ioQueueå°±æ˜¯SDImageCacheåˆå§‹åŒ–æ—¶ç”Ÿæˆä¸€ä¸ªGCDå¹¶è¡Œé˜Ÿåˆ—</span></span><br><span class="line">   <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">       <span class="keyword">if</span> (operation.isCancelled) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">	<span class="comment">//åœ¨æœ¬åœ°ä¸­æŸ¥çœ‹å›¾ç‰‡æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">       <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">           <span class="built_in">UIImage</span> *diskImage = [<span class="keyword">self</span> diskImageForKey:key];</span><br><span class="line">           <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.shouldCacheImagesInMemory) &#123;</span><br><span class="line">               <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">               [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               doneBlock(diskImage, SDImageCacheTypeDisk);</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘è¿™æµç¨‹ä¸­ å›¾ç‰‡æ˜¯ç¬¬ä¸€æ¬¡ä¸‹è½½çš„ï¼Œæ‰€ä»¥å°±æŒ‰ç€ å†…å­˜å’Œæœ¬åœ°ä¸­éƒ½æ‰¾ä¸åˆ°æµç¨‹èµ°ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹å¥‡æ€ªä¸ºä»€ä¹ˆè¿™é‡Œè¦åŠ autorealeasepoolï¼Œçœ‹äº†ä¸‹èµ„æ–™ï¼Œè¯´æ˜¯å¯ä»¥ä¼˜åŒ–å†…å­˜ã€‚</p>
<p><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener">autorealeasepoolæœºåˆ¶å‚è€ƒé“¾æ¥</a></p>
<p><a href="http://tutuge.me/2015/03/17/what-is-autoreleasepool/" target="_blank" rel="noopener">autorealeasepoolæœºåˆ¶å‚è€ƒé“¾æ¥2</a></p>
<h3 id="3-5-å…³äºSDWebImageManagerçš„å•ä¾‹ï¼ˆæµç¨‹ä¹‹å¤–ï¼‰"><a href="#3-5-å…³äºSDWebImageManagerçš„å•ä¾‹ï¼ˆæµç¨‹ä¹‹å¤–ï¼‰" class="headerlink" title="3.5 å…³äºSDWebImageManagerçš„å•ä¾‹ï¼ˆæµç¨‹ä¹‹å¤–ï¼‰"></a>3.5 å…³äºSDWebImageManagerçš„å•ä¾‹ï¼ˆæµç¨‹ä¹‹å¤–ï¼‰</h3><p>ä¸€å¼€å§‹çœ‹è§å®ƒçš„å•ä¾‹æ˜¯è¿™ä¹ˆå†™ï¼Œè¿™ä¸ä¸€çœ‹å°±çŸ¥é“ä¸æ˜¯ä¸¥æ ¼çš„å•ä¾‹å—</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)sharedManager &#123;</span><br><span class="line">   <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> once;</span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">id</span> instance;</span><br><span class="line">   <span class="built_in">dispatch_once</span>(&amp;once, ^&#123;</span><br><span class="line">       instance = [<span class="keyword">self</span> new];</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">   <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> init])) &#123;</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹æˆ‘è¿˜ä»¥ä¸ºæ˜¯ç”¨äº†ä»€ä¹ˆé«˜çº§çš„Runtimeä½¿åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ä¸¥æ ¼ä¿æŒå•ä¾‹ï¼Œç»“æœå®éªŒäº†ä¸€ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> SDWebImageManager* m1 = [SDWebImageManager sharedManager];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@" m1 :%@  "</span>,m1);</span><br><span class="line"></span><br><span class="line">SDWebImageManager* m2 = [[SDWebImageManager alloc]init];</span><br><span class="line"> <span class="built_in">NSLog</span>(<span class="string">@" m2 :%@  "</span>,m2);</span><br></pre></td></tr></table></figure>
<p>æ‰“å°å‡ºæ¥ï¼š</p>
<pre><code class="objc">sdwebImageTest[<span class="number">4350</span>:<span class="number">1125408</span>]  m1 :&lt;SDWebImageManager: <span class="number">0x17550510</span>&gt;  
 sdwebImageTest[<span class="number">4350</span>:<span class="number">1125408</span>]  m2 :&lt;SDWebImageManager: <span class="number">0x175537e0</span>&gt;
</code></pre>
<p>æ‘”ï¼è¿™ä¸å°±æ˜¯ã€Šåªè¦ä½ ç¡®ä¿åªè°ƒç”¨sharedManagerå°±ç¡®ä¿å•ä¾‹ã€‹çš„åšæ³•å—ã€‚ã€‚ä½œè€…å¼€å¿ƒå°±å¥½ã€‚ã€‚åæ­£é‡Œé¢çš„å•ä¾‹æ¨¡å¼å¤§å®¶éƒ½åªè°ƒç”¨é»˜è®¤çš„sharedManageræ–¹æ³•å°±ä¸ä¼šé”™ã€‚ã€‚</p>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>SDWebImage375æºç -ç¼“å­˜æœºåˆ¶</title>
    <url>/essay/SDWebImage/SDWebImage375%E6%BA%90%E7%A0%81-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<blockquote>
<p>å­˜ å– åˆ  è·¯å¾„</p>
</blockquote>
<h2 id="1-1-å­˜"><a href="#1-1-å­˜" class="headerlink" title="1.1 å­˜"></a>1.1 å­˜</h2><p>æ˜¯åœ¨storeImageè¿™ä¸ªæ–¹æ³•é‡Œï¼š</p>
<p>å°†å›¾ç‰‡å‚¨å­˜åˆ°å†…å­˜å’Œç¡¬ç›˜ä¸Š</p>
<a id="more"></a>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)storeImage:(<span class="built_in">UIImage</span> *)image recalculateFromImage:(<span class="built_in">BOOL</span>)recalculate imageData:(<span class="built_in">NSData</span> *)imageData forKey:(<span class="built_in">NSString</span> *)key toDisk:(<span class="built_in">BOOL</span>)toDisk &#123;</span><br><span class="line">   <span class="keyword">if</span> (!image || !key) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// if memory cache is enabled</span></span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.shouldCacheImagesInMemory) &#123;</span><br><span class="line">       <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(image);</span><br><span class="line">       [<span class="keyword">self</span>.memCache setObject:image forKey:key cost:cost];</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (toDisk) &#123;</span><br><span class="line">       <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">           <span class="built_in">NSData</span> *data = imageData;</span><br><span class="line">           <span class="comment">// å¦‚æœimageå­˜åœ¨ï¼Œä½†æ˜¯éœ€è¦é‡æ–°è®¡ç®—(recalculate)æˆ–è€…dataä¸ºç©º</span></span><br><span class="line">           <span class="comment">// é‚£å°±è¦æ ¹æ®imageé‡æ–°ç”Ÿæˆæ–°çš„data</span></span><br><span class="line">           <span class="comment">// ä¸è¿‡è¦æ˜¯è¿imageä¹Ÿä¸ºç©ºçš„è¯ï¼Œé‚£å°±åˆ«å­˜äº†</span></span><br><span class="line">           <span class="keyword">if</span> (image &amp;&amp; (recalculate || !data)) &#123;</span><br><span class="line"><span class="meta">#if TARGET_OS_IPHONE</span></span><br><span class="line">               <span class="comment">// æˆ‘ä»¬éœ€è¦åˆ¤æ–­imageæ˜¯PNGè¿˜æ˜¯JPEG</span></span><br><span class="line">               <span class="comment">// PNGçš„å›¾ç‰‡å¾ˆå®¹æ˜“æ£€æµ‹å‡ºæ¥ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸€ä¸ªç‰¹å®šçš„æ ‡ç¤º (http://www.w3.org/TR/PNG-Structure.html)</span></span><br><span class="line">               <span class="comment">// PNGå›¾ç‰‡çš„å‰8ä¸ªå­—èŠ‚ä¸è®¸ç¬¦åˆä¸‹é¢è¿™äº›å€¼(åè¿›åˆ¶è¡¨ç¤º)</span></span><br><span class="line">               <span class="comment">// 137 80 78 71 13 10 26 10</span></span><br><span class="line">               </span><br><span class="line">               <span class="comment">// å¦‚æœimageDataä¸ºç©ºl (ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚imageåœ¨ä¸‹è½½åéœ€è¦transformï¼Œé‚£ä¹ˆå°±imageDataå°±ä¼šä¸ºç©º)</span></span><br><span class="line">               <span class="comment">// å¹¶ä¸”imageæœ‰ä¸€ä¸ªalphaé€šé“, æˆ‘ä»¬å°†è¯¥imageçœ‹åšPNGä»¥é¿å…é€æ˜åº¦(alpha)çš„ä¸¢å¤±ï¼ˆå› ä¸ºJPEGæ²¡æœ‰é€æ˜è‰²ï¼‰</span></span><br><span class="line">               <span class="keyword">int</span> alphaInfo = <span class="built_in">CGImageGetAlphaInfo</span>(image.CGImage);<span class="comment">// è·å–imageä¸­çš„é€æ˜ä¿¡æ¯</span></span><br><span class="line">               <span class="comment">// è¯¥imageä¸­ç¡®å®æœ‰é€æ˜ä¿¡æ¯ï¼Œå°±è®¤ä¸ºimageä¸ºPNG</span></span><br><span class="line">               <span class="built_in">BOOL</span> hasAlpha = !(alphaInfo == kCGImageAlphaNone ||</span><br><span class="line">                                 alphaInfo == kCGImageAlphaNoneSkipFirst ||</span><br><span class="line">                                 alphaInfo == kCGImageAlphaNoneSkipLast);</span><br><span class="line">               <span class="built_in">BOOL</span> imageIsPng = hasAlpha;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// ä½†æ˜¯å¦‚æœæˆ‘ä»¬å·²ç»æœ‰äº†imageDataï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ ¹æ®dataä¸­å‰å‡ ä¸ªå­—èŠ‚åˆ¤æ–­æ˜¯ä¸æ˜¯PNG</span></span><br><span class="line">               <span class="keyword">if</span> ([imageData length] &gt;= [kPNGSignatureData length]) &#123;</span><br><span class="line">                   <span class="comment">// ImageDataHasPNGPreffixå°±æ˜¯ä¸ºäº†åˆ¤æ–­imageDataå‰8ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯ç¬¦åˆPNGæ ‡å¿—</span></span><br><span class="line">                   imageIsPng = ImageDataHasPNGPreffix(imageData);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// å¦‚æœimageæ˜¯PNGæ ¼å¼ï¼Œå°±æ˜¯ç”¨UIImagePNGRepresentationå°†å…¶è½¬åŒ–ä¸ºNSDataï¼Œå¦åˆ™æŒ‰ç…§JPEGæ ¼å¼è½¬åŒ–ï¼Œå¹¶ä¸”å‹ç¼©è´¨é‡ä¸º1ï¼Œå³æ— å‹ç¼©</span></span><br><span class="line">               <span class="keyword">if</span> (imageIsPng) &#123;</span><br><span class="line">                   data = <span class="built_in">UIImagePNGRepresentation</span>(image);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   data = <span class="built_in">UIImageJPEGRepresentation</span>(image, (<span class="built_in">CGFloat</span>)<span class="number">1.0</span>);</span><br><span class="line">               &#125;</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">               <span class="comment">// å½“ç„¶ï¼Œå¦‚æœä¸æ˜¯åœ¨iPhoneå¹³å°ä¸Šï¼Œå°±ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•ã€‚ä¸è¿‡ä¸åœ¨æˆ‘ä»¬ç ”ç©¶èŒƒå›´ä¹‹å†…</span></span><br><span class="line">               data = [<span class="built_in">NSBitmapImageRep</span> representationOfImageRepsInArray:image.representations usingType: <span class="built_in">NSJPEGFileType</span> properties:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// è·å–åˆ°éœ€è¦å­˜å‚¨çš„dataåï¼Œä¸‹é¢å°±è¦ç”¨fileManagerè¿›è¡Œå­˜å‚¨äº†</span></span><br><span class="line">           <span class="keyword">if</span> (data) &#123;</span><br><span class="line">               <span class="comment">// é¦–å…ˆåˆ¤æ–­disk cacheçš„æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯å°±åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">               <span class="comment">// disk cacheçš„æ–‡ä»¶è·¯å¾„æ˜¯å­˜å‚¨åœ¨_diskCachePathä¸­çš„</span></span><br><span class="line">               <span class="keyword">if</span> (![_fileManager fileExistsAtPath:_diskCachePath]) &#123;</span><br><span class="line">                   [_fileManager createDirectoryAtPath:_diskCachePath withIntermediateDirectories:<span class="literal">YES</span> attributes:<span class="literal">nil</span> error:<span class="literal">NULL</span>];</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// æ ¹æ®imageçš„key(ä¸€èˆ¬æƒ…å†µä¸‹ç†è§£ä¸ºimageçš„url)ç»„åˆæˆæœ€ç»ˆçš„æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">               <span class="comment">// ä¸Šé¢é‚£ä¸ªç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„åªæ˜¯ä¸€ä¸ªæ–‡ä»¶ç›®å½•ï¼Œå°±è·Ÿ/cache/images/img1.pngå’Œcache/images/çš„åŒºåˆ«ä¸€æ ·</span></span><br><span class="line">               <span class="built_in">NSString</span> *cachePathForKey = [<span class="keyword">self</span> defaultCachePathForKey:key];</span><br><span class="line">               <span class="comment">// è¿™ä¸ªurlå¯ä¸æ˜¯ç½‘ç»œç«¯çš„urlï¼Œè€Œæ˜¯fileåœ¨ç³»ç»Ÿè·¯å¾„ä¸‹çš„url</span></span><br><span class="line">               <span class="comment">// æ¯”å¦‚/foo/bar/baz --------&gt; file:///foo/bar/baz</span></span><br><span class="line">               <span class="built_in">NSURL</span> *fileURL = [<span class="built_in">NSURL</span> fileURLWithPath:cachePathForKey];</span><br><span class="line"></span><br><span class="line">               <span class="comment">// æ ¹æ®å­˜å‚¨çš„è·¯å¾„(cachePathForKey)å’Œå­˜å‚¨çš„æ•°æ®(data)å°†å…¶å­˜æ”¾åˆ°iOSçš„æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">               [_fileManager createFileAtPath:cachePathForKey contents:data attributes:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">               <span class="comment">// disable iCloud backup</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="keyword">self</span>.shouldDisableiCloud) &#123;</span><br><span class="line">                   [fileURL setResourceValue:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>] forKey:<span class="built_in">NSURLIsExcludedFromBackupKey</span> error:<span class="literal">nil</span>];</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-å–"><a href="#1-2-å–" class="headerlink" title="1.2 å–"></a>1.2 å–</h3><p> å†…å­˜ç¼“å­˜ä½¿ç”¨NSCacheçš„objectForKeyå–æ•°æ®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">	- (<span class="built_in">UIImage</span> *)imageFromMemoryCacheForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    	<span class="keyword">return</span> [<span class="keyword">self</span>.memCache objectForKey:key];</span><br><span class="line">	&#125;</span><br><span class="line">ç£ç›˜å–æ•°æ® ä¸æ–­ç”¨ dataWithContentsOfFileæ¥è¯•æ•°æ®æ˜¯å¦åœ¨keyå¯¹åº”çš„è·¯å¾„ä¸­</span><br><span class="line"></span><br><span class="line">	- (<span class="built_in">UIImage</span> *)imageFromDiskCacheForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// First check the in-memory cache...</span></span><br><span class="line">    <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span> imageFromMemoryCacheForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (image) &#123;</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Second check the disk cache...</span></span><br><span class="line">    <span class="built_in">UIImage</span> *diskImage = [<span class="keyword">self</span> diskImageForKey:key];</span><br><span class="line">    <span class="keyword">if</span> (diskImage &amp;&amp; <span class="keyword">self</span>.shouldCacheImagesInMemory) &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> cost = SDCacheCostForImage(diskImage);</span><br><span class="line">        [<span class="keyword">self</span>.memCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> diskImage;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-åˆ "><a href="#1-3-åˆ " class="headerlink" title="1.3 åˆ "></a>1.3 åˆ </h3><ol>
<li>removeImageForKeyfromDisk:withCompletion: // å¼‚æ­¥åœ°å°†imageä»ç¼“å­˜(å†…å­˜ç¼“å­˜ä»¥åŠå¯é€‰çš„ç£ç›˜ç¼“å­˜)ä¸­ç§»é™¤</li>
<li>clearMemory // æ¸…æ¥šå†…å­˜ç¼“å­˜ä¸Šçš„æ‰€æœ‰image</li>
<li>clearDisk // æ¸…é™¤ç£ç›˜ç¼“å­˜ä¸Šçš„æ‰€æœ‰image</li>
<li>cleanDisk // æ¸…é™¤ç£ç›˜ç¼“å­˜ä¸Šè¿‡æœŸçš„image</li>
</ol>
<p>çœ‹å…¶ä¸­æœ€é•¿çš„ä¸€ä¸ªï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å®ç°äº†ä¸€ä¸ªç®€å•çš„ç¼“å­˜æ¸…é™¤ç­–ç•¥ï¼šæ¸…é™¤ä¿®æ”¹æ—¶é—´æœ€æ—©çš„file</span></span><br><span class="line">- (<span class="keyword">void</span>)cleanDiskWithCompletionBlock:(SDWebImageNoParamsBlock)completionBlock &#123;</span><br><span class="line">   <span class="built_in">dispatch_async</span>(<span class="keyword">self</span>.ioQueue, ^&#123;</span><br><span class="line">       <span class="comment">// è¿™ä¸¤ä¸ªå˜é‡ä¸»è¦æ˜¯ä¸ºäº†ä¸‹é¢ç”ŸæˆNSDirectoryEnumeratorå‡†å¤‡çš„</span></span><br><span class="line">       <span class="comment">// ä¸€ä¸ªæ˜¯è®°å½•éå†çš„æ–‡ä»¶ç›®å½•ï¼Œä¸€ä¸ªæ˜¯è®°å½•éå†éœ€è¦é¢„å…ˆè·å–æ–‡ä»¶çš„å“ªäº›å±æ€§</span></span><br><span class="line">       <span class="built_in">NSURL</span> *diskCacheURL = [<span class="built_in">NSURL</span> fileURLWithPath:<span class="keyword">self</span>.diskCachePath isDirectory:<span class="literal">YES</span>];</span><br><span class="line">       <span class="built_in">NSArray</span> *resourceKeys = @[<span class="built_in">NSURLIsDirectoryKey</span>, <span class="built_in">NSURLContentModificationDateKey</span>, <span class="built_in">NSURLTotalFileAllocatedSizeKey</span>];</span><br><span class="line"></span><br><span class="line">       <span class="comment">// é€’å½’åœ°éå†diskCachePathè¿™ä¸ªæ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ç›®å½•ï¼Œæ­¤å¤„ä¸æ˜¯ç›´æ¥ä½¿ç”¨diskCachePathï¼Œè€Œæ˜¯ä½¿ç”¨å…¶ç”Ÿæˆçš„NSURL</span></span><br><span class="line">       <span class="comment">// æ­¤å¤„ä½¿ç”¨includingPropertiesForKeys:resourceKeysï¼Œè¿™æ ·æ¯ä¸ªfileçš„resourceKeyså¯¹åº”çš„å±æ€§ä¹Ÿä¼šåœ¨éå†æ—¶é¢„å…ˆè·å–åˆ°</span></span><br><span class="line">       <span class="comment">// NSDirectoryEnumerationSkipsHiddenFilesè¡¨ç¤ºä¸éå†éšè—æ–‡ä»¶</span></span><br><span class="line">       <span class="built_in">NSDirectoryEnumerator</span> *fileEnumerator = [_fileManager enumeratorAtURL:diskCacheURL</span><br><span class="line">                                                  includingPropertiesForKeys:resourceKeys</span><br><span class="line">                                                                     options:<span class="built_in">NSDirectoryEnumerationSkipsHiddenFiles</span></span><br><span class="line">                                                                errorHandler:<span class="literal">NULL</span>];</span><br><span class="line">       <span class="comment">// è·å–æ–‡ä»¶çš„è¿‡æœŸæ—¶é—´ï¼ŒSDWebImageä¸­é»˜è®¤æ˜¯ä¸€ä¸ªæ˜ŸæœŸ</span></span><br><span class="line">       <span class="comment">// ä¸è¿‡è¿™é‡Œè™½ç„¶ç§°*expirationDateä¸ºè¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯å®è´¨ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ã€‚</span></span><br><span class="line">       <span class="comment">// å…¶å®æ˜¯è¿™æ ·çš„ï¼Œæ¯”å¦‚åœ¨2015/12/12/00:00:00æœ€åä¸€æ¬¡ä¿®æ”¹æ–‡ä»¶ï¼Œå¯¹åº”çš„è¿‡æœŸæ—¶é—´åº”è¯¥æ˜¯</span></span><br><span class="line">       <span class="comment">// 2015/12/19/00:00:00ï¼Œä¸è¿‡ç°åœ¨æ—¶é—´æ˜¯2015/12/27/00:00:00ï¼Œæˆ‘å…ˆå°†å½“å‰æ—¶é—´å‡å»1ä¸ªæ˜ŸæœŸï¼Œå¾—åˆ°</span></span><br><span class="line">       <span class="comment">// 2015/12/20/00:00:00ï¼Œè¿™ä¸ªæ—¶é—´æ‰æ˜¯æˆ‘ä»¬å‡½æ•°ä¸­çš„expirationDateã€‚</span></span><br><span class="line">       <span class="comment">// ç”¨è¿™ä¸ªexpirationDateå’Œæœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´modificationDateæ¯”è¾ƒçœ‹è°æ›´æ™šå°±è¡Œã€‚</span></span><br><span class="line">       <span class="built_in">NSDate</span> *expirationDate = [<span class="built_in">NSDate</span> dateWithTimeIntervalSinceNow:-<span class="keyword">self</span>.maxCacheAge];</span><br><span class="line">       <span class="comment">// ç”¨æ¥å­˜å‚¨å¯¹åº”æ–‡ä»¶çš„ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚æ–‡ä»¶æ‰€éœ€ç£ç›˜ç©ºé—´</span></span><br><span class="line">       <span class="built_in">NSMutableDictionary</span> *cacheFiles = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">       <span class="comment">// è®°å½•å½“å‰å·²ç»ä½¿ç”¨çš„ç£ç›˜ç¼“å­˜å¤§å°</span></span><br><span class="line">       <span class="built_in">NSUInteger</span> currentCacheSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// åœ¨ç¼“å­˜çš„ç›®å½•å¼€å§‹éå†æ–‡ä»¶.  æ­¤æ¬¡éå†æœ‰ä¸¤ä¸ªç›®çš„:</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">//  1. ç§»é™¤è¿‡æœŸçš„æ–‡ä»¶</span></span><br><span class="line">       <span class="comment">//  2. åŒæ—¶å­˜å‚¨æ¯ä¸ªæ–‡ä»¶çš„å±æ€§ï¼ˆæ¯”å¦‚è¯¥fileæ˜¯å¦æ˜¯æ–‡ä»¶å¤¹ã€è¯¥fileæ‰€éœ€ç£ç›˜å¤§å°ï¼Œä¿®æ”¹æ—¶é—´ï¼‰</span></span><br><span class="line">       <span class="built_in">NSMutableArray</span> *urlsToDelete = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">NSURL</span> *fileURL <span class="keyword">in</span> fileEnumerator) &#123;</span><br><span class="line">           <span class="built_in">NSDictionary</span> *resourceValues = [fileURL resourceValuesForKeys:resourceKeys error:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line">           <span class="comment">// å½“å‰æ‰«æçš„æ˜¯ç›®å½•ï¼Œå°±è·³è¿‡</span></span><br><span class="line">           <span class="keyword">if</span> ([resourceValues[<span class="built_in">NSURLIsDirectoryKey</span>] boolValue]) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// ç§»é™¤è¿‡æœŸæ–‡ä»¶</span></span><br><span class="line">           <span class="comment">// è¿™é‡Œåˆ¤æ–­è¿‡æœŸçš„æ–¹å¼ï¼šå¯¹æ¯”æ–‡ä»¶çš„æœ€åä¸€æ¬¡ä¿®æ”¹æ—¥æœŸå’ŒexpirationDateè°æ›´æ™šï¼Œå¦‚æœexpirationDateæ›´æ™šï¼Œå°±è®¤ä¸ºè¯¥æ–‡ä»¶å·²ç»è¿‡æœŸï¼Œå…·ä½“è§£é‡Šè§ä¸Šé¢</span></span><br><span class="line">           <span class="built_in">NSDate</span> *modificationDate = resourceValues[<span class="built_in">NSURLContentModificationDateKey</span>];</span><br><span class="line">           <span class="keyword">if</span> ([[modificationDate laterDate:expirationDate] isEqualToDate:expirationDate]) &#123;</span><br><span class="line">               [urlsToDelete addObject:fileURL];</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// è®¡ç®—å½“å‰å·²ç»ä½¿ç”¨çš„cacheå¤§å°ï¼Œ</span></span><br><span class="line">           <span class="comment">// å¹¶å°†å¯¹åº”fileçš„å±æ€§å­˜åˆ°cacheFilesä¸­</span></span><br><span class="line">           <span class="built_in">NSNumber</span> *totalAllocatedSize = resourceValues[<span class="built_in">NSURLTotalFileAllocatedSizeKey</span>];</span><br><span class="line">           currentCacheSize += [totalAllocatedSize unsignedIntegerValue];</span><br><span class="line">           [cacheFiles setObject:resourceValues forKey:fileURL];</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">NSURL</span> *fileURL <span class="keyword">in</span> urlsToDelete) &#123;</span><br><span class="line">           <span class="comment">// æ ¹æ®éœ€è¦ç§»é™¤æ–‡ä»¶çš„urlæ¥ç§»é™¤å¯¹åº”file</span></span><br><span class="line">           [_fileManager removeItemAtURL:fileURL error:<span class="literal">nil</span>];</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// å¦‚æœæˆ‘ä»¬å½“å‰cacheçš„å¤§å°å·²ç»è¶…è¿‡äº†å…è®¸é…ç½®çš„ç¼“å­˜å¤§å°ï¼Œé‚£å°±åˆ é™¤å·²ç»ç¼“å­˜çš„æ–‡ä»¶ã€‚</span></span><br><span class="line">       <span class="comment">// åˆ é™¤ç­–ç•¥å°±æ˜¯ï¼Œé¦–å…ˆåˆ é™¤ä¿®æ”¹æ—¶é—´æ›´æ—©çš„ç¼“å­˜æ–‡ä»¶</span></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">self</span>.maxCacheSize &gt; <span class="number">0</span> &amp;&amp; currentCacheSize &gt; <span class="keyword">self</span>.maxCacheSize) &#123;</span><br><span class="line">           <span class="comment">// ç›´æ¥å°†å½“å‰cacheå¤§å°é™åˆ°å…è®¸æœ€å¤§çš„cacheå¤§å°çš„ä¸€èˆ¬</span></span><br><span class="line">           <span class="keyword">const</span> <span class="built_in">NSUInteger</span> desiredCacheSize = <span class="keyword">self</span>.maxCacheSize / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// æ ¹æ®æ–‡ä»¶ä¿®æ”¹æ—¶é—´æ¥ç»™æ‰€æœ‰ç¼“å­˜æ–‡ä»¶æ’åºï¼ŒæŒ‰ç…§ä¿®æ”¹æ—¶é—´è¶Šæ—©è¶Šåœ¨å‰çš„è§„åˆ™æ’åº</span></span><br><span class="line">           <span class="built_in">NSArray</span> *sortedFiles = [cacheFiles keysSortedByValueWithOptions:<span class="built_in">NSSortConcurrent</span></span><br><span class="line">                                                           usingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span> obj1, <span class="keyword">id</span> obj2) &#123;</span><br><span class="line">                                                               <span class="keyword">return</span> [obj1[<span class="built_in">NSURLContentModificationDateKey</span>] compare:obj2[<span class="built_in">NSURLContentModificationDateKey</span>]];</span><br><span class="line">                                                           &#125;];</span><br><span class="line"></span><br><span class="line">           <span class="comment">// æ¯æ¬¡åˆ é™¤fileåï¼Œå°±è®¡ç®—æ­¤æ—¶çš„cacheçš„å¤§å°</span></span><br><span class="line">           <span class="comment">// å¦‚æœæ­¤æ—¶çš„cacheå¤§å°å·²ç»é™åˆ°æœŸæœ›çš„å¤§å°äº†ï¼Œå°±åœæ­¢åˆ é™¤æ–‡ä»¶äº†</span></span><br><span class="line">           <span class="keyword">for</span> (<span class="built_in">NSURL</span> *fileURL <span class="keyword">in</span> sortedFiles) &#123;</span><br><span class="line">               <span class="keyword">if</span> ([_fileManager removeItemAtURL:fileURL error:<span class="literal">nil</span>]) &#123;</span><br><span class="line">                   <span class="comment">// è·å–è¯¥æ–‡ä»¶å¯¹åº”çš„å±æ€§</span></span><br><span class="line">                   <span class="built_in">NSDictionary</span> *resourceValues = cacheFiles[fileURL];</span><br><span class="line">       <span class="comment">// æ ¹æ®resourceValuesè·å–è¯¥æ–‡ä»¶æ‰€éœ€ç£ç›˜ç©ºé—´å¤§å°</span></span><br><span class="line">                   <span class="built_in">NSNumber</span> *totalAllocatedSize = resourceValues[<span class="built_in">NSURLTotalFileAllocatedSizeKey</span>];</span><br><span class="line">       <span class="comment">// è®¡ç®—å½“å‰cacheå¤§å°</span></span><br><span class="line">                   currentCacheSize -= [totalAllocatedSize unsignedIntegerValue];</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (currentCacheSize &lt; desiredCacheSize) &#123;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// å¦‚æœæœ‰completionBlockï¼Œå°±åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨</span></span><br><span class="line">       <span class="keyword">if</span> (completionBlock) &#123;</span><br><span class="line">           <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">               completionBlock();</span><br><span class="line">           &#125;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-å›¾ç‰‡å‚¨å­˜è·¯å¾„"><a href="#1-4-å›¾ç‰‡å‚¨å­˜è·¯å¾„" class="headerlink" title="1.4 å›¾ç‰‡å‚¨å­˜è·¯å¾„"></a>1.4 å›¾ç‰‡å‚¨å­˜è·¯å¾„</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ç®€å•å°è£…äº†cachePathForKey:inPath</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)defaultCachePathForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">   	<span class="keyword">return</span> [<span class="keyword">self</span> cachePathForKey:key inPath:<span class="keyword">self</span>.diskCachePath];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cachePathForKey:inPath</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)cachePathForKey:(<span class="built_in">NSString</span> *)key inPath:(<span class="built_in">NSString</span> *)path &#123;</span><br><span class="line">   <span class="comment">// æ ¹æ®ä¼ å…¥çš„keyåˆ›å»ºæœ€ç»ˆè¦å­˜å‚¨æ—¶çš„æ–‡ä»¶å</span></span><br><span class="line">   <span class="built_in">NSString</span> *filename = [<span class="keyword">self</span> cachedFileNameForKey:key];</span><br><span class="line">   <span class="comment">// å°†å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åç»‘å®šåœ¨ä¸€èµ·ï¼Œä½œä¸ºæœ€ç»ˆçš„å­˜å‚¨è·¯å¾„</span></span><br><span class="line">   <span class="keyword">return</span> [path stringByAppendingPathComponent:filename];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cachedFileNameForKey:</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)cachedFileNameForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *str = [key UTF8String];</span><br><span class="line">   <span class="keyword">if</span> (str == <span class="literal">NULL</span>) &#123;</span><br><span class="line">       str = <span class="string">""</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// ä½¿ç”¨äº†MD5è¿›è¡ŒåŠ å¯†å¤„ç†</span></span><br><span class="line">   <span class="comment">// å¼€è¾Ÿä¸€ä¸ª16å­—èŠ‚ï¼ˆ128ä½ï¼šmd5åŠ å¯†å‡ºæ¥å°±æ˜¯128bitï¼‰çš„ç©ºé—´</span></span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">char</span> r[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">   <span class="comment">// å®˜æ–¹å°è£…å¥½çš„åŠ å¯†æ–¹æ³•</span></span><br><span class="line">   <span class="comment">// æŠŠstrå­—ç¬¦ä¸²è½¬æ¢æˆäº†32ä½çš„16è¿›åˆ¶æ•°åˆ—ï¼ˆè¿™ä¸ªè¿‡ç¨‹ä¸å¯é€†è½¬ï¼‰ å­˜å‚¨åˆ°äº†rè¿™ä¸ªç©ºé—´ä¸­</span></span><br><span class="line">   CC_MD5(str, (CC_LONG)strlen(str), r);</span><br><span class="line">   <span class="comment">// æœ€ç»ˆç”Ÿæˆçš„æ–‡ä»¶åå°±æ˜¯ "md5ç "+".æ–‡ä»¶ç±»å‹"</span></span><br><span class="line">   <span class="built_in">NSString</span> *filename = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%@"</span>,</span><br><span class="line">                         r[<span class="number">0</span>], r[<span class="number">1</span>], r[<span class="number">2</span>], r[<span class="number">3</span>], r[<span class="number">4</span>], r[<span class="number">5</span>], r[<span class="number">6</span>], r[<span class="number">7</span>], r[<span class="number">8</span>], r[<span class="number">9</span>], r[<span class="number">10</span>],</span><br><span class="line">                         r[<span class="number">11</span>], r[<span class="number">12</span>], r[<span class="number">13</span>], r[<span class="number">14</span>], r[<span class="number">15</span>], [[key pathExtension] isEqualToString:<span class="string">@""</span>] ? <span class="string">@""</span> : [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@".%@"</span>, [key pathExtension]]];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>essay</category>
        <category>SDWebImage</category>
      </categories>
      <tags>
        <tag>SDWebImage</tag>
      </tags>
  </entry>
  <entry>
    <title>Method-Swizzlingä½¿ç”¨</title>
    <url>/essay/Runtime/Method-Swizzling/</url>
    <content><![CDATA[<blockquote>
<p>   åœ¨æ²¡æœ‰ä¸€ä¸ªç±»çš„å®ç°æºç çš„æƒ…å†µä¸‹ï¼Œæƒ³æ”¹å˜å…¶ä¸­ä¸€ä¸ªæ–¹æ³•çš„å®ç°ï¼Œé™¤äº†ç»§æ‰¿å®ƒé‡å†™ã€å’Œå€ŸåŠ©ç±»åˆ«é‡åæ–¹æ³•æš´åŠ›æŠ¢å…ˆä¹‹å¤–,è¿˜èƒ½ä½¿ç”¨Method Swizzlingæ–¹æ³•</p>
</blockquote>
<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>åœ¨Objective-Cä¸­è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶å®æ˜¯å‘ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾æ¶ˆæ¯çš„å”¯ä¸€ä¾æ®æ˜¯selectorçš„åå­—ã€‚åˆ©ç”¨Objective-Cçš„åŠ¨æ€ç‰¹æ€§ï¼Œå¯ä»¥å®ç°åœ¨è¿è¡Œæ—¶å·æ¢selectorå¯¹åº”çš„æ–¹æ³•å®ç°ï¼Œè¾¾åˆ°ç»™æ–¹æ³•æŒ‚é’©çš„ç›®çš„ã€‚</p>
<p>æ¯ä¸ªç±»éƒ½æœ‰ä¸€ä¸ªæ–¹æ³•åˆ—è¡¨ï¼Œå­˜æ”¾ç€selectorçš„åå­—å’Œæ–¹æ³•å®ç°çš„æ˜ å°„å…³ç³»ã€‚IMPæœ‰ç‚¹ç±»ä¼¼å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å…·ä½“çš„Methodå®ç°ã€‚</p>
<a id="more"></a>
<p><img src="/res/runtime/o_methodSwizzling1.png" alt></p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ method_exchangeImplementations æ¥äº¤æ¢2ä¸ªæ–¹æ³•ä¸­çš„IMPï¼Œ</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ class_replaceMethod æ¥ä¿®æ”¹ç±»ï¼Œ</p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ method_setImplementation æ¥ç›´æ¥è®¾ç½®æŸä¸ªæ–¹æ³•çš„IMPï¼Œ</p>
<p>å½’æ ¹ç»“åº•ï¼Œéƒ½æ˜¯å·æ¢äº†selectorçš„IMPï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/res/runtime/o_methodSwizzling2.png" alt></p>
<h2 id="å®è·µ1"><a href="#å®è·µ1" class="headerlink" title="å®è·µ1"></a>å®è·µ1</h2><p>ä¸¾ä¸ªä¾‹å­å¥½äº†ï¼Œæˆ‘æƒ³é’©ä¸€ä¸‹NSArrayçš„lastObject æ–¹æ³•ï¼Œåªéœ€ä¸¤ä¸ªæ­¥éª¤ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šç»™NSArrayåŠ ä¸€ä¸ªæˆ‘è‡ªå·±çš„lastObject<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"NSArray+Swizzle.h"</span>  </span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSArray</span> (<span class="title">Swizzle</span>)  </span></span><br><span class="line">- (<span class="keyword">id</span>)myLastObject  </span><br><span class="line">&#123;  </span><br><span class="line">   <span class="keyword">id</span> ret = [<span class="keyword">self</span> myLastObject];  </span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@"**********  myLastObject *********** "</span>);  </span><br><span class="line">   <span class="keyword">return</span> ret;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>ä¹ä¸€çœ‹ï¼Œè¿™ä¸é€’å½’äº†ä¹ˆï¼Ÿåˆ«å¿˜è®°è¿™æ˜¯æˆ‘ä»¬å‡†å¤‡è°ƒæ¢IMPçš„selectorï¼Œ[self myLastObject] å°†ä¼šæ‰§è¡ŒçœŸçš„ [self lastObject] ã€‚</p>
<p>ç¬¬äºŒæ­¥ï¼šè°ƒæ¢IMP</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"NSArray+Swizzle.h"</span>  </span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])  </span><br><span class="line">&#123;  </span><br><span class="line">   <span class="keyword">@autoreleasepool</span> &#123;  </span><br><span class="line">         </span><br><span class="line">       Method ori_Method =  class_getInstanceMethod([<span class="built_in">NSArray</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(lastObject));  </span><br><span class="line">       Method my_Method = class_getInstanceMethod([<span class="built_in">NSArray</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(myLastObject));  </span><br><span class="line">       method_exchangeImplementations(ori_Method, my_Method);  </span><br><span class="line">         </span><br><span class="line">       <span class="built_in">NSArray</span> *array = @[<span class="string">@"0"</span>,<span class="string">@"1"</span>,<span class="string">@"2"</span>,<span class="string">@"3"</span>];  </span><br><span class="line">       <span class="built_in">NSString</span> *string = [array lastObject];  </span><br><span class="line">       <span class="built_in">NSLog</span>(<span class="string">@"TEST RESULT : %@"</span>,string);  </span><br><span class="line">         </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ§åˆ¶å°è¾“å‡ºLogï¼š    </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2013-07-18 16:26:12.585 Hook[1740:c07] **********  myLastObject ***********   </span><br><span class="line">2013-07-18 16:26:12.589 Hook[1740:c07] TEST RESULT : 3</span><br></pre></td></tr></table></figure>
<h3 id="å®è·µ2">å®è·µ2ï¼šæ‹¦æˆªç³»ç»Ÿæ–¹æ³•</h3>

<blockquote>
<p>éœ€æ±‚ï¼šæ¯”å¦‚iOS6 å‡çº§ iOS7 åéœ€è¦ç‰ˆæœ¬é€‚é…ï¼Œæ ¹æ®ä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒæ ·å¼å›¾ç‰‡ï¼ˆæ‹Ÿç‰©åŒ–å’Œæ‰å¹³åŒ–ï¼‰ï¼Œå¦‚ä½•é€šè¿‡ä¸å»æ‰‹åŠ¨ä¸€ä¸ªä¸ªä¿®æ”¹æ¯ä¸ªUIImageçš„imageNamedï¼šæ–¹æ³•å°±å¯ä»¥å®ç°ä¸ºè¯¥æ–¹æ³•ä¸­åŠ å…¥ç‰ˆæœ¬åˆ¤æ–­è¯­å¥ï¼Ÿ</p>
</blockquote>
<p>æ­¥éª¤ï¼š</p>
<ol>
<li>ä¸ºUIImageå»ºä¸€ä¸ªåˆ†ç±»ï¼ˆUIImage+Categoryï¼‰</li>
<li><p>åœ¨åˆ†ç±»ä¸­å®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ–¹æ³•ï¼Œæ–¹æ³•ä¸­å†™è¦åœ¨ç³»ç»Ÿæ–¹æ³•ä¸­åŠ å…¥çš„è¯­å¥ï¼Œæ¯”å¦‚ç‰ˆæœ¬åˆ¤æ–­</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+(<span class="built_in">UIImage</span> *)xh_imageNamed:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">   <span class="keyword">double</span> version = [[<span class="built_in">UIDevice</span> currentDevice].systemVersion doubleValue];</span><br><span class="line">   <span class="keyword">if</span> (version &gt;= <span class="number">7.0</span>) &#123;</span><br><span class="line">       <span class="comment">// å¦‚æœç³»ç»Ÿç‰ˆæœ¬æ˜¯7.0ä»¥ä¸Šï¼Œä½¿ç”¨å¦å¤–ä¸€å¥—æ–‡ä»¶åç»“å°¾æ˜¯â€˜_os7â€™çš„æ‰å¹³åŒ–å›¾ç‰‡</span></span><br><span class="line">       name = [name stringByAppendingString:<span class="string">@"_os7"</span>];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> [<span class="built_in">UIImage</span> xh_imageNamed:name];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ†ç±»ä¸­é‡å†™UIImageçš„loadæ–¹æ³•ï¼Œå®ç°æ–¹æ³•çš„äº¤æ¢ï¼ˆåªè¦èƒ½è®©å…¶æ‰§è¡Œä¸€æ¬¡æ–¹æ³•äº¤æ¢è¯­å¥ï¼Œloadå†åˆé€‚ä¸è¿‡äº†ï¼‰</p>
 <figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+(<span class="keyword">void</span>)load &#123;</span><br><span class="line">  	<span class="comment">// è·å–ä¸¤ä¸ªç±»çš„ç±»æ–¹æ³•</span></span><br><span class="line">  	Method m1 = class_getClassMethod([<span class="built_in">UIImage</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(imageNamed:));</span><br><span class="line">  	Method m2 = class_getClassMethod([<span class="built_in">UIImage</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(xh_imageNamed:));</span><br><span class="line">  	<span class="comment">// å¼€å§‹äº¤æ¢æ–¹æ³•å®ç°</span></span><br><span class="line">  	method_exchangeImplementations(m1, m2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>æ³¨æ„ï¼šè‡ªå®šä¹‰æ–¹æ³•ä¸­æœ€åä¸€å®šè¦å†è°ƒç”¨ä¸€ä¸‹ç³»ç»Ÿçš„æ–¹æ³•ï¼Œè®©å…¶æœ‰åŠ è½½å›¾ç‰‡çš„åŠŸèƒ½ï¼Œä½†æ˜¯ç”±äºæ–¹æ³•äº¤æ¢ï¼Œç³»ç»Ÿçš„æ–¹æ³•åå·²ç»å˜æˆäº†æˆ‘ä»¬è‡ªå®šä¹‰çš„æ–¹æ³•åï¼ˆæœ‰ç‚¹ç»•ï¼Œå°±æ˜¯ç”¨æˆ‘ä»¬çš„åå­—èƒ½è°ƒç”¨ç³»ç»Ÿçš„æ–¹æ³•ï¼Œç”¨ç³»ç»Ÿçš„åå­—èƒ½è°ƒç”¨æˆ‘ä»¬çš„æ–¹æ³•ï¼‰ï¼Œè¿™å°±å®ç°äº†ç³»ç»Ÿæ–¹æ³•çš„æ‹¦æˆªï¼</strong></p>
<p>åˆ©ç”¨ä»¥ä¸Šæ€è·¯ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»™ NSObject æ·»åŠ åˆ†ç±»ï¼Œç»Ÿè®¡åˆ›å»ºäº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œç»™æ§åˆ¶å™¨æ·»åŠ åˆ†ç±»ï¼Œç»Ÿè®¡æœ‰åˆ›å»ºäº†å¤šå°‘ä¸ªæ§åˆ¶å™¨</p>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Categoryç»“æ„ä¸åŸç†</title>
    <url>/essay/Runtime/runtime-%E5%88%86%E7%B1%BBCategory%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<blockquote>
<p>åˆ†ç±»çš„å®ç°åŸç†ï¼Œç¼–è¯‘æ—¶çš„è¡¨ç°ï¼Œè¿è¡Œæ—¶çš„åŠ è½½åŸç†<br>å‚è€ƒæ–‡æ¡£: <a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">objc4-723</a></p>
</blockquote>
<p>categoryçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•ã€‚å¯ä»¥æŠŠç±»çš„å®ç°åˆ†å¼€åœ¨å‡ ä¸ªä¸åŒçš„æ–‡ä»¶é‡Œé¢ã€‚</p>
<h3 id="Category-ç»“æ„ä½“"><a href="#Category-ç»“æ„ä½“" class="headerlink" title="Category ç»“æ„ä½“"></a>Category ç»“æ„ä½“</h3><p>Categoryç”¨Category_tç»“æ„ä½“å®šä¹‰ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> category_t &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;<span class="comment">//ç±»çš„åå­—</span></span><br><span class="line">    classref_t cls;<span class="comment">//ç±»</span></span><br><span class="line">    <span class="keyword">struct</span> method_list_t *instanceMethods;<span class="comment">//å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> method_list_t *classMethods;<span class="comment">//ç±»æ–¹æ³•çš„åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> protocol_list_t *protocols;<span class="comment">//æ‰€æœ‰åè®®çš„åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">struct</span> property_list_t *instanceProperties;<span class="comment">//æ·»åŠ çš„æ‰€æœ‰å±æ€§</span></span><br><span class="line">&#125; category_t;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ä»categoryçš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºcategoryçš„å¯ä¸ºï¼ˆå¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®ç°åè®®ï¼Œæ·»åŠ å±æ€§ï¼‰å’Œä¸å¯ä¸ºï¼ˆæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼‰ã€‚</p>
<h3 id="Category-ä¸-Extension"><a href="#Category-ä¸-Extension" class="headerlink" title="Category ä¸ Extension"></a>Category ä¸ Extension</h3><p><strong>extension</strong>çœ‹èµ·æ¥å¾ˆåƒä¸€ä¸ªåŒ¿åçš„categoryï¼Œä½†æ˜¯extensionå’Œæœ‰åå­—çš„categoryå‡ ä¹å®Œå…¨æ˜¯ä¸¤ä¸ªä¸œè¥¿ã€‚ extensionåœ¨ç¼–è¯‘æœŸå†³è®®ï¼Œå®ƒå°±æ˜¯ç±»çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç¼–è¯‘æœŸå’Œå¤´æ–‡ä»¶é‡Œçš„@interfaceä»¥åŠå®ç°æ–‡ä»¶é‡Œçš„@implementä¸€èµ·å½¢æˆä¸€ä¸ªå®Œæ•´çš„ç±»ï¼Œå®ƒä¼´éšç±»çš„äº§ç”Ÿè€Œäº§ç”Ÿï¼Œäº¦éšä¹‹ä¸€èµ·æ¶ˆäº¡ã€‚extensionä¸€èˆ¬ç”¨æ¥éšè—ç±»çš„ç§æœ‰ä¿¡æ¯ï¼Œä½ å¿…é¡»æœ‰ä¸€ä¸ªç±»çš„æºç æ‰èƒ½ä¸ºä¸€ä¸ªç±»æ·»åŠ extensionï¼Œæ‰€ä»¥ä½ æ— æ³•ä¸ºç³»ç»Ÿçš„ç±»æ¯”å¦‚NSStringæ·»åŠ extensionã€‚</p>
<p>ä½†æ˜¯<strong>category</strong>åˆ™å®Œå…¨ä¸ä¸€æ ·ï¼Œå®ƒæ˜¯åœ¨è¿è¡ŒæœŸå†³è®®çš„ã€‚<br>å°±categoryå’Œextensionçš„åŒºåˆ«æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼å‡ºä¸€ä¸ªæ˜æ˜¾çš„äº‹å®ï¼Œextensionå¯ä»¥æ·»åŠ å®ä¾‹å˜é‡ï¼Œè€Œcategoryæ˜¯æ— æ³•æ·»åŠ å®ä¾‹å˜é‡çš„ï¼ˆå› ä¸ºåœ¨è¿è¡ŒæœŸï¼Œå¯¹è±¡çš„å†…å­˜å¸ƒå±€å·²ç»ç¡®å®šï¼Œå¦‚æœæ·»åŠ å®ä¾‹å˜é‡å°±ä¼šç ´åç±»çš„å†…éƒ¨å¸ƒå±€ï¼Œè¿™å¯¹ç¼–è¯‘å‹è¯­è¨€æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ï¼‰ã€‚</p>
<h3 id="Categoryç¼–è¯‘æ—¶"><a href="#Categoryç¼–è¯‘æ—¶" class="headerlink" title="Categoryç¼–è¯‘æ—¶"></a>Categoryç¼–è¯‘æ—¶</h3><h4 id="å†™ä¸ªç®€å•çš„Categoryï¼š"><a href="#å†™ä¸ªç®€å•çš„Categoryï¼š" class="headerlink" title="å†™ä¸ªç®€å•çš„Categoryï¼š"></a>å†™ä¸ªç®€å•çš„Categoryï¼š</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//.h</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">OneClass</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)oneMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">OneClass</span>(<span class="title">OneCategory</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *oneCategoryProp;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)oneCategoryMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"OneClass.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OneClass</span></span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)oneMethod&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@" oneMethod "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OneClass</span>(<span class="title">OneCategory</span>)</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)oneCategoryMethod&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@" oneCategoryMethod "</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="ç„¶åä½¿ç”¨Clangå‘½ä»¤ç¼–è¯‘ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š"><a href="#ç„¶åä½¿ç”¨Clangå‘½ä»¤ç¼–è¯‘ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š" class="headerlink" title="ç„¶åä½¿ç”¨Clangå‘½ä»¤ç¼–è¯‘ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š"></a>ç„¶åä½¿ç”¨Clangå‘½ä»¤ç¼–è¯‘ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">clang -rewrite-objc OneClass.m</span><br></pre></td></tr></table></figure>
<p>ç„¶åå¾—åˆ°ä¸€ä¸ª3må¤šçš„OneClass.appæ–‡ä»¶â€¦â€¦</p>
<h4 id="åœ¨OneClass-appä¸­æ‰¾åˆ°ç›¸å…³çš„ä»£ç ç‰‡æ®µï¼š"><a href="#åœ¨OneClass-appä¸­æ‰¾åˆ°ç›¸å…³çš„ä»£ç ç‰‡æ®µï¼š" class="headerlink" title="åœ¨OneClass.appä¸­æ‰¾åˆ°ç›¸å…³çš„ä»£ç ç‰‡æ®µï¼š"></a>åœ¨OneClass.appä¸­æ‰¾åˆ°ç›¸å…³çš„ä»£ç ç‰‡æ®µï¼š</h4><blockquote>
<p>ç”Ÿæˆäº†å®ä¾‹æ–¹æ³•åˆ—è¡¨:</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">method_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _objc_method)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> method_count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">objc_method</span> <span class="title">method_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_OneClass_$_OneCategory __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(_objc_method),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;(struct objc_selector *)<span class="string">"oneCategoryMethod"</span>, <span class="string">"v16@0:8"</span>, (<span class="keyword">void</span> *)_I_OneClass_OneCategory_oneCategoryMethod&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç”Ÿæˆäº†å±æ€§åˆ—è¡¨ï¼š</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> /*_<span class="title">prop_list_t</span>*/ &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> entsize;  <span class="comment">// sizeof(struct _prop_t)</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count_of_properties;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">prop_t</span> <span class="title">prop_list</span>[1];</span></span><br><span class="line">&#125; _OBJC_$_PROP_LIST_OneClass_$_OneCategory __attribute__ ((used, section (<span class="string">"__DATA,__objc_const"</span>))) = &#123;</span><br><span class="line">	<span class="keyword">sizeof</span>(<span class="keyword">_prop_t</span>),</span><br><span class="line">	<span class="number">1</span>,</span><br><span class="line">	&#123;&#123;<span class="string">"oneCategoryProp"</span>,<span class="string">"T@\"NSString\",C,N"</span>&#125;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç”Ÿæˆäº†categoryæœ¬èº« ï¼Œå¹¶ç”¨å‰é¢çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨å’Œå±æ€§æ–¹æ³•åˆ—è¡¨åˆå§‹åŒ–</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">category_t</span> _<span class="title">OBJC_</span>$_<span class="title">CATEGORY_OneClass_</span>$_<span class="title">OneCategory</span> __<span class="title">attribute__</span> ((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>,__<span class="title">objc_const</span>"))) = </span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="string">"OneClass"</span>,</span><br><span class="line">	<span class="number">0</span>, <span class="comment">// &amp;OBJC_CLASS_$_OneClass,</span></span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_method_list_t</span> *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_OneClass_$_OneCategory,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	<span class="number">0</span>,</span><br><span class="line">	(<span class="keyword">const</span> struct <span class="keyword">_prop_list_t</span> *)&amp;_OBJC_$_PROP_LIST_OneClass_$_OneCategory,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æœ€åï¼Œç¼–è¯‘å™¨åœ¨DATAæ®µä¸‹çš„objc_catlist sectioné‡Œä¿å­˜äº†ä¸€ä¸ªå¤§å°ä¸º1çš„category_tçš„æ•°ç»„L_OBJC_LABELCATEGORY$ï¼ˆå½“ç„¶ï¼Œå¦‚æœæœ‰å¤šä¸ªcategoryï¼Œä¼šç”Ÿæˆå¯¹åº”é•¿åº¦çš„æ•°ç»„ï¼‰ï¼Œç”¨äºè¿è¡ŒæœŸcategoryçš„åŠ è½½ã€‚</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> _<span class="title">category_t</span> *<span class="title">L_OBJC_LABEL_CATEGORY_</span>$ [1] __<span class="title">attribute__</span>((<span class="title">used</span>, <span class="title">section</span> ("__<span class="title">DATA</span>, __<span class="title">objc_catlist</span>,<span class="title">regular</span>,<span class="title">no_dead_strip</span>")))= &#123;</span></span><br><span class="line">	&amp;_OBJC_$_CATEGORY_OneClass_$_OneCategory,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Categoryè¿è¡ŒæœŸåŠ è½½"><a href="#Categoryè¿è¡ŒæœŸåŠ è½½" class="headerlink" title="Categoryè¿è¡ŒæœŸåŠ è½½"></a>Categoryè¿è¡ŒæœŸåŠ è½½</h3><h4 id="objc-init-å’Œ-map-images"><a href="#objc-init-å’Œ-map-images" class="headerlink" title="objc_init å’Œ map_images"></a>objc_init å’Œ map_images</h4><p>åœ¨OCè¿è¡Œæ—¶å…¥å£æ–¹æ³•<code>_objc_init</code>ä¸­ï¼ˆï¼ˆåœ¨objc-os.mmæ–‡ä»¶ä¸­ï¼‰ï¼‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">â€¦â€¦</span><br><span class="line">	<span class="comment">//categoryè¢«é™„åŠ åˆ°ç±»ä¸Šé¢æ˜¯åœ¨map_imagesçš„æ—¶å€™å‘ç”Ÿçš„</span></span><br><span class="line">	_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…·ä½“ç‚¹å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªæµç¨‹:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">_objc_init  -&gt; map_images -&gt; map_images_nolock -&gt; _read_images</span><br></pre></td></tr></table></figure>
<h4 id="read-images"><a href="#read-images" class="headerlink" title="read_images"></a>read_images</h4><p><code>_objc_init</code>é‡Œé¢çš„è°ƒç”¨çš„map_imagesæœ€ç»ˆä¼šè°ƒç”¨<strong>objc-runtime-new.mm</strong>é‡Œé¢çš„<code>_read_images</code>æ–¹æ³•ï¼Œè€Œåœ¨<code>_read_images</code>æ–¹æ³•çš„ç»“å°¾ï¼Œæœ‰ä»¥ä¸‹çš„ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Discover categories. </span></span><br><span class="line"><span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">    <span class="comment">//catlistå°±æ˜¯ä¸ŠèŠ‚ä¸­è®²åˆ°çš„ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬å‡†å¤‡çš„category_tæ•°ç»„</span></span><br><span class="line">    <span class="keyword">category_t</span> **catlist = </span><br><span class="line">        _getObjc2CategoryList(hi, &amp;count);</span><br><span class="line">    <span class="keyword">bool</span> hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = catlist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!cls) &#123;</span><br><span class="line">            <span class="comment">// Category's target class is missing (probably weak-linked).</span></span><br><span class="line">            <span class="comment">// Disavow any knowledge of this category.</span></span><br><span class="line">            catlist[i] = nil;</span><br><span class="line">            ã€‚ã€‚ã€‚</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process this category. </span></span><br><span class="line">        <span class="comment">// First, register the category with its target class. </span></span><br><span class="line">        <span class="comment">// Then, rebuild the class's method lists (etc) if </span></span><br><span class="line">        <span class="comment">// the class is realized.</span></span><br><span class="line">        <span class="comment">// æŠŠcategoryçš„å®ä¾‹æ–¹æ³•ã€åè®®ä»¥åŠå±æ€§æ·»åŠ åˆ°ç±»ä¸Š</span></span><br><span class="line">        <span class="keyword">bool</span> classExists = NO;</span><br><span class="line">        <span class="keyword">if</span> (cat-&gt;instanceMethods ||  cat-&gt;protocols  </span><br><span class="line">            ||  cat-&gt;instanceProperties) </span><br><span class="line">        &#123;</span><br><span class="line">            addUnattachedCategoryForClass(cat, cls, hi);</span><br><span class="line">            <span class="keyword">if</span> (cls-&gt;isRealized()) &#123;</span><br><span class="line">                remethodizeClass(cls);</span><br><span class="line">                classExists = YES;</span><br><span class="line">            &#125;</span><br><span class="line">            ã€‚ã€‚ã€‚</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŠŠcategoryçš„ç±»æ–¹æ³•å’Œåè®®æ·»åŠ åˆ°ç±»çš„metaclassä¸Š</span></span><br><span class="line">        <span class="keyword">if</span> (cat-&gt;classMethods  ||  cat-&gt;protocols  </span><br><span class="line">            ||  (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) </span><br><span class="line">        &#123;</span><br><span class="line">            addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi);</span><br><span class="line">            <span class="keyword">if</span> (cls-&gt;ISA()-&gt;isRealized()) &#123;</span><br><span class="line">                remethodizeClass(cls-&gt;ISA());</span><br><span class="line">            &#125;</span><br><span class="line">            ã€‚ã€‚ã€‚</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°remethodizeClasså¤„ç†æ·»åŠ äº‹å®œæ–¹æ³•</p>
<h4 id="remethodizeClass-amp-amp-attachCategories"><a href="#remethodizeClass-amp-amp-attachCategories" class="headerlink" title="remethodizeClass &amp;&amp; attachCategories"></a>remethodizeClass &amp;&amp; attachCategories</h4><p>æ—¢ç„¶remethodizeClassæ‰æ˜¯çœŸæ­£å»å¤„ç†æ·»åŠ äº‹å®œæ–¹æ³•é‚£ä¹ˆç°åœ¨çœ‹ä¸€ä¸‹remethodizeClassï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remethodizeClass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    category_list *cats;</span><br><span class="line">    ã€‚ã€‚ã€‚</span><br><span class="line">    <span class="keyword">if</span> ((cats = unattachedCategoriesForClass(cls, <span class="literal">false</span><span class="comment">/*not realizing*/</span>))) &#123;</span><br><span class="line">    	ã€‚ã€‚ã€‚       </span><br><span class="line">        attachCategories(cls, cats, <span class="literal">true</span> <span class="comment">/*flush caches*/</span>);        </span><br><span class="line">        <span class="built_in">free</span>(cats);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>emmm å¥½åƒremethodizeClassä¹Ÿæ²¡å¹²ä»€ä¹ˆäº‹ï¼Œéƒ½äº¤ç»™äº†<code>attachCategories</code>æ–¹æ³•äº†å˜›ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹attachCategoriesï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static void </span><br><span class="line">attachCategories(Class cls, category_list *cats, bool flush_caches)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cats) return;</span><br><span class="line">    if (PrintReplacedMethods) printReplacements(cls, cats);</span><br><span class="line"></span><br><span class="line">    bool isMeta = cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    // fixme rearrange to remove these intermediate allocations</span><br><span class="line">    method_list_t **mlists = (method_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*mlists));</span><br><span class="line">    property_list_t **proplists = (property_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*proplists));</span><br><span class="line">    protocol_list_t **protolists = (protocol_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*protolists));</span><br><span class="line"></span><br><span class="line">    // Count backwards through cats to get newest categories first</span><br><span class="line">    int mcount = 0;</span><br><span class="line">    int propcount = 0;</span><br><span class="line">    int protocount = 0;</span><br><span class="line">    int i = cats-&gt;count;</span><br><span class="line">    bool fromBundle = NO;</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">        auto&amp; entry = cats-&gt;list[i];</span><br><span class="line"></span><br><span class="line">        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        if (mlist) &#123;</span><br><span class="line">            mlists[mcount++] = mlist;</span><br><span class="line">            fromBundle |= entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        property_list_t *proplist = </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        if (proplist) &#123;</span><br><span class="line">            proplists[propcount++] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protocol_list_t *protolist = entry.cat-&gt;protocols;</span><br><span class="line">        if (protolist) &#123;</span><br><span class="line">            protolists[protocount++] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    auto rw = cls-&gt;data();</span><br><span class="line"></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">    free(mlists);</span><br><span class="line">    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);</span><br><span class="line"></span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    free(proplists);</span><br><span class="line"></span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    free(protolists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯å°† Category ä¸­çš„æ–¹æ³•ã€å±æ€§å’Œåè®®æ•´åˆåˆ°ç±»ï¼ˆä¸»ç±»æˆ–å…ƒç±»ï¼‰ä¸­ï¼Œæ›´æ–°ç±»çš„æ•°æ®å­—æ®µ data() ä¸­ method_listsï¼ˆæˆ– method_listï¼‰ã€properties å’Œ protocols çš„å€¼ã€‚</p>
<ul>
<li>categoryçš„æ–¹æ³•æ²¡æœ‰æ›¿æ¢æ‰åŸæ¥ç±»å·²ç»æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœcategoryå’ŒåŸæ¥ç±»éƒ½æœ‰methodAï¼Œé‚£ä¹ˆcategoryé™„åŠ å®Œæˆä¹‹åï¼Œç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œä¼šæœ‰ä¸¤ä¸ªmethodA</li>
<li>categoryçš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€ŒåŸæ¥ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„åé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„categoryçš„æ–¹æ³•ä¼šâ€œè¦†ç›–â€æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¿è¡Œæ—¶åœ¨æŸ¥æ‰¾æ–¹æ³•çš„æ—¶å€™æ˜¯é¡ºç€æ–¹æ³•åˆ—è¡¨çš„é¡ºåºæŸ¥æ‰¾çš„ï¼Œå®ƒåªè¦ä¸€æ‰¾åˆ°å¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±ä¼šç½¢ä¼‘ã€‚</li>
<li><strong>æ€ä¹ˆè°ƒç”¨åˆ°åŸæ¥ç±»ä¸­è¢«categoryè¦†ç›–æ‰çš„æ–¹æ³•</strong>ï¼Ÿå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“categoryå…¶å®å¹¶ä¸æ˜¯å®Œå…¨æ›¿æ¢æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œåªæ˜¯categoryåœ¨æ–¹æ³•åˆ—è¡¨çš„å‰é¢è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦é¡ºç€æ–¹æ³•åˆ—è¡¨æ‰¾åˆ°æœ€åä¸€ä¸ªå¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±å¯ä»¥è°ƒç”¨åŸæ¥ç±»çš„æ–¹æ³•</li>
</ul>
<hr>
<ul>
<li>å‚è€ƒèµ„æ–™<ul>
<li><a href="http://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">Apple Open Source : objc4-646.tar.gz</a></li>
<li><a href="https://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="noopener">https://tech.meituan.com/DiveIntoCategory.html</a></li>
<li><a href="http://blog.leichunfeng.com/blog/2015/05/18/objective-c-category-implementation-principle/" target="_blank" rel="noopener">http://blog.leichunfeng.com/blog/2015/05/18/objective-c-category-implementation-principle/</a></li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>objc_msgSendç›¸å…³ç»“æ„ä½“ æ¶ˆæ¯å‘é€åŸç†</title>
    <url>/essay/Runtime/runtime-objc_msgSend/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»  æ¶ˆæ¯å‘é€ä»¥åŠç›¸å…³çš„ç»“æ„ä½“<br><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">apple open source</a></p>
</blockquote>
<h3 id="objc-msgSend"><a href="#objc-msgSend" class="headerlink" title="objc_msgSend"></a>objc_msgSend</h3><p>ç»™å¯¹è±¡å‘é€æ¶ˆæ¯å†™æ³•ï¼š</p>
<pre><code>`id returnValue = [somneObject messageName:parameter];`
</code></pre><p>ç¼–è¯‘å™¨ä¼šå°†ä¸Šè¯‰ä»£ç è½¬æ¢ä¸ºï¼š</p>
<pre><code>`id = returnValue = objc_msgSend(someObject,@selector(messageName:),parameter);`
</code></pre><p>å…¶ä¸­ someObjectå«åšâ€œæ¥å—è€…â€ï¼ˆreceiverï¼‰ï¼ŒmessageNameå«åšâ€œé€‰æ‹©å­â€ï¼ˆselectorï¼‰ï¼Œé€‰æ‹©å­å’Œå‚æ•°åˆç§°â€œæ¶ˆæ¯â€</p>
<p>objc_msgSend çš„å®šä¹‰ï¼š è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ª id ç±»å‹ï¼Œä¸€ä¸ª SEL ç±»å‹ã€‚</p>
<pre><code>`id objc_msgSend(id self, SEL op, ...)`;
</code></pre><a id="more"></a>
<h3 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h3><p> å…¶å®å®ƒå°±æ˜¯ä¸ªæ˜ å°„åˆ°æ–¹æ³•çš„Cå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥ç”¨ Objective-C ç¼–è¯‘å™¨å‘½ä»¤ @selector() æˆ–è€… Runtime ç³»ç»Ÿçš„ sel_registerName å‡½æ•°æ¥è·å¾—ä¸€ä¸ª SEL ç±»å‹çš„æ–¹æ³•é€‰æ‹©å™¨ã€‚å®šä¹‰åœ¨åœ¨ objc/objc.h ç›®å½•ä¸‹ï¼š</p>
<pre><code>`typedef struct objc_selector *SEL;`    
</code></pre><h3 id="id"><a href="#id" class="headerlink" title="id"></a>id</h3><p> id æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼Œå®ƒå¯ä»¥æŒ‡å‘ Objective-C ä¸­çš„ä»»ä½•å¯¹è±¡,id ä¹Ÿè¢«å®šä¹‰åœ¨ objc/objc.h ç›®å½•ä¸‹ï¼š</p>
<pre><code>`typedef struct objc_object *id;`
</code></pre><h3 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h3><p> Class ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆç±»å‹ï¼š</p>
<pre><code>`typedef struct objc_class *Class;`
</code></pre><p> objc_class ç»“æ„ä½“æ˜¯:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_class &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;<span class="comment">//æ¯ä¸ªClasséƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆ</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">#if !__OBJC2__</span></span><br><span class="line">    Class super_class                                        OBJC2_UNAVAILABLE;<span class="comment">//çˆ¶ç±»</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name                                         OBJC2_UNAVAILABLE;<span class="comment">//ç±»å</span></span><br><span class="line">    <span class="keyword">long</span> version                                             OBJC2_UNAVAILABLE;<span class="comment">//ç±»ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">long</span> info                                                OBJC2_UNAVAILABLE;<span class="comment">//!*!ä¾›è¿è¡ŒæœŸä½¿ç”¨çš„ä¸€äº›ä½æ ‡è¯†ã€‚å¦‚ï¼šCLS_CLASS (0x1L)è¡¨ç¤ºè¯¥ç±»ä¸ºæ™®é€šclass; CLS_META(0x2L)è¡¨ç¤ºè¯¥ç±»ä¸ºmetaclassç­‰(runtime.hä¸­æœ‰è¯¦ç»†åˆ—å‡º)</span></span><br><span class="line">    <span class="keyword">long</span> instance_size                                       OBJC2_UNAVAILABLE;<span class="comment">//å®ä¾‹å¤§å°</span></span><br><span class="line">    <span class="keyword">struct</span> objc_ivar_list *ivars                             OBJC2_UNAVAILABLE;<span class="comment">//å­˜å‚¨æ¯ä¸ªå®ä¾‹å˜é‡çš„å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method_list **methodLists                    OBJC2_UNAVAILABLE;<span class="comment">//!*!æ ¹æ®infoçš„ä¿¡æ¯ç¡®å®šæ˜¯ç±»è¿˜æ˜¯å®ä¾‹ï¼Œè¿è¡Œä»€ä¹ˆå‡½æ•°æ–¹æ³•ç­‰</span></span><br><span class="line">    <span class="keyword">struct</span> objc_cache *cache                                 OBJC2_UNAVAILABLE;<span class="comment">//ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">struct</span> objc_protocol_list *protocols                     OBJC2_UNAVAILABLE;<span class="comment">//åè®®</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure>
<h4 id="MetaClass"><a href="#MetaClass" class="headerlink" title="MetaClass"></a>MetaClass</h4><p>isaå’Œsuper_classæ˜¯æ‰¾åˆ°å®ç°å‡½æ•°çš„å…³é”®æ˜ å°„ï¼Œå†³å®šæ‰¾åˆ°å­˜æ”¾åœ¨å“ªä¸ªç±»çš„æ–¹æ³•å®ç°ã€‚ï¼ˆisaç”¨äºè‡ªçœç¡®å®šæ‰€å±ç±»ï¼Œsuper_classç¡®å®šç»§æ‰¿å…³ç³»ï¼‰ã€‚</p>
<p>å®ä¾‹å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘ç±»ï¼Œç±»çš„isaæŒ‡é’ˆæŒ‡å‘å…¶å…ƒç±»ï¼ˆmetaClassï¼‰ã€‚å¯¹è±¡å°±æ˜¯ä¸€ä¸ªå«isaæŒ‡é’ˆçš„ç»“æ„ä½“ã€‚ç±»å­˜å‚¨å®ä¾‹å¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ï¼Œå…ƒç±»å­˜å‚¨ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼Œå…ƒç±»ä¹Ÿæ˜¯ç±»å¯¹è±¡</p>
<p>æˆ‘ä»¬å‘ç° Class æœ¬èº«ä¹Ÿæœ‰ä¸€ä¸ª isa æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯å®ƒçš„ MetaClassã€‚</p>
<ul>
<li>å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªå®ä¾‹å‘é€æ¶ˆæ¯æ—¶ï¼ˆ-å¼€å¤´çš„æ–¹æ³•ï¼‰ï¼Œä¼šåœ¨è¯¥ instance å¯¹åº”çš„ç±»çš„ methodLists é‡ŒæŸ¥æ‰¾ã€‚</li>
<li>å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªç±»å‘é€æ¶ˆæ¯æ—¶ï¼ˆ+å¼€å¤´çš„æ–¹æ³•ï¼‰ï¼Œä¼šåœ¨è¯¥ç±»çš„ MetaClass çš„ methodLists é‡ŒæŸ¥æ‰¾ã€‚</li>
<li>æ¯ä¸ª Class éƒ½æœ‰ä¸€ä¸ª isa æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå”¯ä¸€çš„ Meta Class</li>
<li>æ¯ä¸€ä¸ª Meta Class çš„ isa æŒ‡é’ˆéƒ½æŒ‡å‘æœ€ä¸Šå±‚çš„ Meta Classï¼Œå³ NSObject çš„ MetaClassï¼Œè€Œæœ€ä¸Šå±‚çš„ MetaClass çš„ isa æŒ‡é’ˆåˆæŒ‡å‘è‡ªå·±</li>
</ul>
<p><img src="/res/runtime/metaClass.png" alt></p>
<h4 id="objc-method-list"><a href="#objc-method-list" class="headerlink" title="objc_method_list"></a>objc_method_list</h4><p>å…¶ä¸­objc_method_list:ç”¨æ¥å­˜å‚¨å½“å‰ç±»çš„æ–¹æ³•é“¾è¡¨ï¼Œobjc_methodå­˜å‚¨äº†ç±»çš„æŸä¸ªæ–¹æ³•çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_method_list &#123;</span><br><span class="line">    <span class="keyword">struct</span> objc_method_list *obsolete 	OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="keyword">int</span> method_count 	OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#ifdef __LP64__</span></span><br><span class="line">    <span class="keyword">int</span> space 	OBJC2_UNAVAILABLE;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="comment">/* variable length structure */</span></span><br><span class="line">    <span class="keyword">struct</span> objc_method method_list[<span class="number">1</span>] 	OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="objc-cache"><a href="#objc-cache" class="headerlink" title="objc_cache"></a>objc_cache</h4><p>objc_cache:æ–¹æ³•è°ƒç”¨æœ€å…ˆæ˜¯åœ¨æ–¹æ³•ç¼“å­˜é‡Œæ‰¾çš„ï¼Œæ–¹æ³•è°ƒç”¨æ˜¯æ‡’è°ƒç”¨ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åŠ è½½ååŠ åˆ°ç¼“å­˜æ± é‡Œã€‚ä¸€ä¸ªobjcç¨‹åºå¯åŠ¨åï¼Œéœ€è¦è¿›è¡Œç±»çš„åˆå§‹åŒ–ã€è°ƒç”¨æ–¹æ³•æ—¶çš„cacheåˆå§‹åŒ–ï¼Œå†å‘é€æ¶ˆæ¯çš„æ—¶å€™å°±ç›´æ¥èµ°ç¼“å­˜ï¼ˆå¼•ç”³ï¼š+loadæ–¹æ³•å’Œ+initializeæ–¹æ³•ã€‚loadæ–¹æ³•æ˜¯é¦–æ¬¡åŠ è½½ç±»æ—¶è°ƒç”¨ï¼Œç»å¯¹åªè°ƒç”¨ä¸€æ¬¡ï¼›initializeæ–¹æ³•æ˜¯é¦–æ¬¡ç»™ç±»å‘æ¶ˆæ¯æ—¶è°ƒç”¨ï¼Œé€šå¸¸åªè°ƒç”¨ä¸€æ¬¡ï¼Œä½†å¦‚æœå®ƒçš„å­ç±»åˆå§‹åŒ–æ—¶æœªå®šä¹‰initializeæ–¹æ³•ï¼Œåˆ™ä¼šå†è°ƒç”¨ä¸€æ¬¡å®ƒçš„initializeæ–¹æ³•ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_cache &#123;</span><br><span class="line">    <span class="comment">// ç¼“å­˜bucketçš„æ€»æ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mask <span class="comment">/* total = mask + 1 */</span>                 OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®é™…ç¼“å­˜bucketçš„æ€»æ•°</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> occupied                                    OBJC2_UNAVAILABLE;</span><br><span class="line">    <span class="comment">// æŒ‡å‘Methodæ•°æ®ç»“æ„æŒ‡é’ˆçš„æ•°ç»„</span></span><br><span class="line">    Method buckets[<span class="number">1</span>]                                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>Methodç±»å‹æ˜¯ä¸€ä¸ªobjc_methodç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œç»“æ„ä½“objc_methodæœ‰ä¸‰ä¸ªæˆå‘˜ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_method *Method;</span><br><span class="line"><span class="keyword">struct</span> objc_method &#123;</span><br><span class="line">   	SEL method_name;        <span class="comment">// æ–¹æ³•åç§°</span></span><br><span class="line">    	<span class="keyword">char</span> *method_typesE;    <span class="comment">// å‚æ•°å’Œè¿”å›ç±»å‹çš„æè¿°å­—ä¸²</span></span><br><span class="line">   		IMP method_imp;         <span class="comment">// æ–¹æ³•çš„å…·ä½“çš„å®ç°çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Methodç›¸å…³æ–¹æ³•"><a href="#Methodç›¸å…³æ–¹æ³•" class="headerlink" title="Methodç›¸å…³æ–¹æ³•"></a>Methodç›¸å…³æ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°è°ƒç”¨ï¼Œä½†æ˜¯ä¸æ¥æ”¶è¿”å›å€¼ç±»å‹ä¸ºç»“æ„ä½“</span></span><br><span class="line">method_invoke</span><br><span class="line"><span class="comment">// å‡½æ•°è°ƒç”¨ï¼Œä½†æ˜¯æ¥æ”¶è¿”å›å€¼ç±»å‹ä¸ºç»“æ„ä½“</span></span><br><span class="line">method_invoke_stret</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°å</span></span><br><span class="line">method_getName</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°å®ç°IMP</span></span><br><span class="line">method_getImplementation</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°type encoding</span></span><br><span class="line">method_getTypeEncoding</span><br><span class="line"><span class="comment">// å¤åˆ¶è¿”å›å€¼ç±»å‹</span></span><br><span class="line">method_copyReturnType</span><br><span class="line"><span class="comment">// å¤åˆ¶å‚æ•°ç±»å‹</span></span><br><span class="line">method_copyArgumentType</span><br><span class="line"><span class="comment">// è·å–è¿”å›å€¼ç±»å‹</span></span><br><span class="line">method_getReturnType</span><br><span class="line"><span class="comment">// è·å–å‚æ•°ä¸ªæ•°</span></span><br><span class="line">method_getNumberOfArguments</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°å‚æ•°ç±»å‹</span></span><br><span class="line">method_getArgumentType</span><br><span class="line"><span class="comment">// è·å–å‡½æ•°æè¿°</span></span><br><span class="line">method_getDescription</span><br><span class="line"><span class="comment">// è®¾ç½®å‡½æ•°å®ç°IMP</span></span><br><span class="line">method_setImplementation</span><br><span class="line"><span class="comment">// äº¤æ¢å‡½æ•°çš„å®ç°IMP</span></span><br><span class="line">method_exchangeImplementations</span><br></pre></td></tr></table></figure>
<h3 id="objc-property-t"><a href="#objc-property-t" class="headerlink" title="objc_property_t"></a>objc_property_t</h3><p>objc_property_tä»£è¡¨å±æ€§ï¼Œè€Œå®ƒåˆæ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼š</p>
<pre><code>`// An opaque type that represents an Objective-C declared property.
typedef struct objc_property *objc_property_t;`
</code></pre><p>objc_propertyæ˜¯å†…ç½®çš„ç±»å‹ï¼Œä¸ä¹‹å…³è”çš„è¿˜æœ‰ä¸€ä¸ªobjc_property_attribute_tï¼Œå®ƒæ˜¯å±æ€§çš„attributeï¼Œä¹Ÿå°±æ˜¯å…¶å®æ˜¯å¯¹å±æ€§çš„è¯¦ç»†æè¿°ï¼ŒåŒ…æ‹¬å±æ€§åç§°ã€å±æ€§ç¼–ç ç±»å‹ã€åŸå­ç±»å‹/éåŸå­ç±»å‹ç­‰ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// Defines a property attribute</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;           <span class="comment">/**&lt; The name of the attribute */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *value;          <span class="comment">/**&lt; The value of the attribute (usually empty) */</span></span><br><span class="line">&#125; objc_property_attribute_t;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œvalueé€šå¸¸æ˜¯ç©ºçš„ï¼Œä½†æ˜¯å¯¹äºç±»å‹æ˜¯æœ‰å€¼çš„ã€‚    </p>
<h3 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h3><p>æˆå‘˜å˜é‡é€šè¿‡Ivarè¡¨ç¤ºï¼Œå®ƒæ˜¯objc_ivarç»“æ„ä½“æŒ‡é’ˆï¼š</p>
<pre><code>`// An opaque type that represents an instance variable.
typedef struct objc_ivar *Ivar;`
</code></pre><p>è€Œobjc_ivarç»“æ„çš„å®šä¹‰ä¸ºï¼š    </p>
<pre><code><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_ivar &#123;</span><br><span class="line">	<span class="comment">// æˆå‘˜å˜é‡å</span></span><br><span class="line">	<span class="keyword">char</span> *ivar_name                 OBJC2_UNAVAILABLE;  </span><br><span class="line">	<span class="comment">// æˆå‘˜å˜é‡encodeç±»å‹</span></span><br><span class="line">	<span class="keyword">char</span> *ivar_type                 OBJC2_UNAVAILABLE;  </span><br><span class="line">	<span class="comment">// åŸºåœ°å€åç§»å­—èŠ‚</span></span><br><span class="line">	<span class="keyword">int</span> ivar_offset                 OBJC2_UNAVAILABLE;  </span><br><span class="line">	<span class="meta">#ifdef __LP64__</span></span><br><span class="line">	<span class="keyword">int</span> space                       OBJC2_UNAVAILABLE;</span><br><span class="line">	<span class="meta">#endif</span></span><br><span class="line">&#125;</span><br><span class="line">`</span><br></pre></td></tr></table></figure>
</code></pre><h2 id="æ¶ˆæ¯å‘é€è¿‡ç¨‹"><a href="#æ¶ˆæ¯å‘é€è¿‡ç¨‹" class="headerlink" title="æ¶ˆæ¯å‘é€è¿‡ç¨‹"></a>æ¶ˆæ¯å‘é€è¿‡ç¨‹</h2><p>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå…¶è¿è¡Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>Runtime ç³»ç»Ÿä¼šæŠŠæ–¹æ³•è°ƒç”¨è½¬åŒ–ä¸ºæ¶ˆæ¯å‘é€ï¼Œå³ objc_msgSendï¼Œå¹¶ä¸”æŠŠæ–¹æ³•çš„è°ƒç”¨è€…ï¼Œå’Œæ–¹æ³•é€‰æ‹©å™¨ï¼Œå½“åšå‚æ•°ä¼ é€’è¿‡å»</li>
<li>æ–¹æ³•çš„è°ƒç”¨è€…ä¼šé€šè¿‡ isa æŒ‡é’ˆæ¥æ‰¾åˆ°å…¶æ‰€å±çš„ç±»ï¼Œç„¶ååœ¨ cache æˆ–è€… methodLists ä¸­æŸ¥æ‰¾è¯¥æ–¹æ³•ï¼Œæ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„æ–¹æ³•å»æ‰§è¡Œ.ï¼ˆåŒæ—¶å°†åŒ¹é…ç»“æœç¼“å­˜åœ¨â€œå¿«é€Ÿæ˜ å°„è¡¨â€ ï¼ˆfast mapï¼‰ä¸­ã€‚ï¼‰<ul>
<li>methodLists æŒ‡å‘è¯¥ç±»çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨ï¼Œå®ä¾‹æ–¹æ³•å³-æ–¹æ³•ï¼Œé‚£ä¹ˆç±»æ–¹æ³•ï¼ˆ+æ–¹æ³•ï¼‰å­˜å‚¨åœ¨å“ªå„¿å‘¢ï¼Ÿç±»æ–¹æ³•è¢«å­˜å‚¨åœ¨å…ƒç±»ä¸­ï¼ŒClass é€šè¿‡ isa æŒ‡é’ˆå³å¯æ‰¾åˆ°å…¶æ‰€å±çš„å…ƒç±».</li>
</ul>
</li>
<li>å¦‚æœåœ¨ç±»ä¸­æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•ï¼Œåˆ™é€šè¿‡ super_class å¾€ä¸Šä¸€çº§è¶…ç±»æŸ¥æ‰¾ï¼ˆå¦‚æœä¸€ç›´æ‰¾åˆ° NSObject éƒ½æ²¡æœ‰æ‰¾åˆ°è¯¥æ–¹æ³•çš„è¯ï¼Œè¿™ç§æƒ…å†µï¼Œå¼€å§‹<a href="#åŠ¨æ€æ–¹æ³•è§£æ">åŠ¨æ€æ–¹æ³•è§£æ</a> <ul>
<li><img src="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Art/messaging1.gif" alt><ul>
<li>NSObject çš„è¶…ç±»ä¸º nilï¼Œä¹Ÿå°±æ˜¯å®ƒæ²¡æœ‰è¶…ç±»ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="åŠ¨æ€æ–¹æ³•è§£æ"><a href="#åŠ¨æ€æ–¹æ³•è§£æ" class="headerlink" title="åŠ¨æ€æ–¹æ³•è§£æ"></a>åŠ¨æ€æ–¹æ³•è§£æ</h3><p>å¦‚æœæŸä¸ªå¯¹è±¡è°ƒç”¨äº†ä¸å­˜åœ¨çš„æ–¹æ³•æ—¶ä¼šæ€ä¹ˆæ ·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç¨‹åºä¼šcrash</p>
<p>åœ¨ç¨‹åºcrashä¹‹å‰ï¼ŒRuntime ä¼šç»™æˆ‘ä»¬åŠ¨æ€æ–¹æ³•è§£æçš„æœºä¼šï¼Œæ¶ˆæ¯å‘é€çš„æ­¥éª¤å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ£€æµ‹è¿™ä¸ª selector æ˜¯ä¸æ˜¯è¦å¿½ç•¥çš„ã€‚æ¯”å¦‚ Mac OS X å¼€å‘ï¼Œæœ‰äº†åƒåœ¾å›æ”¶å°±ä¸ç†ä¼š retainï¼Œrelease è¿™äº›å‡½æ•°äº†.</li>
<li>æ£€æµ‹è¿™ä¸ª target æ˜¯ä¸æ˜¯ nil å¯¹è±¡ã€‚ObjC çš„ç‰¹æ€§æ˜¯å…è®¸å¯¹ä¸€ä¸ª nil å¯¹è±¡æ‰§è¡Œä»»ä½•ä¸€ä¸ªæ–¹æ³•ä¸ä¼š Crashï¼Œå› ä¸ºä¼šè¢«å¿½ç•¥æ‰.</li>
<li>å¦‚æœä¸Šé¢ä¸¤ä¸ªéƒ½è¿‡äº†ï¼Œé‚£å°±å¼€å§‹æŸ¥æ‰¾è¿™ä¸ªç±»çš„ IMPï¼Œå…ˆä» cache é‡Œé¢æ‰¾ï¼Œå®Œäº†æ‰¾å¾—åˆ°å°±è·³åˆ°å¯¹åº”çš„å‡½æ•°å»æ‰§è¡Œ.<br>å¦‚æœ cache æ‰¾ä¸åˆ°å°±æ‰¾ä¸€ä¸‹æ–¹æ³•åˆ†å‘è¡¨.</li>
<li>å¦‚æœåˆ†å‘è¡¨æ‰¾ä¸åˆ°å°±åˆ°è¶…ç±»çš„åˆ†å‘è¡¨å»æ‰¾ï¼Œä¸€ç›´æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°NSObjectç±»ä¸ºæ­¢.</li>
</ol>
<p>å¦‚æœè¿˜æ‰¾ä¸åˆ°å°±è¦å¼€å§‹è¿›å…¥<a href="#æ¶ˆæ¯è½¬å‘">æ¶ˆæ¯è½¬å‘</a></p>
<h3 id="æ¶ˆæ¯è½¬å‘æœºåˆ¶">æ¶ˆæ¯è½¬å‘æœºåˆ¶</h3>

<ol>
<li>è¿›å…¥ resolveInstanceMethod: æ–¹æ³•ï¼ŒæŒ‡å®šæ˜¯å¦åŠ¨æ€æ·»åŠ æ–¹æ³•ã€‚è‹¥è¿”å›NOï¼Œåˆ™è¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè‹¥è¿”å›YESï¼Œåˆ™é€šè¿‡ class_addMethod å‡½æ•°åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•ï¼Œæ¶ˆæ¯å¾—åˆ°å¤„ç†ï¼Œæ­¤æµç¨‹å®Œæ¯•.</li>
<li>resolveInstanceMethod: æ–¹æ³•è¿”å› NO æ—¶ï¼Œå°±ä¼šè¿›å…¥ forwardingTargetForSelector: æ–¹æ³•ï¼Œè¿™æ˜¯ Runtime ç»™æˆ‘ä»¬çš„ç¬¬äºŒæ¬¡æœºä¼šï¼Œç”¨äºæŒ‡å®šå“ªä¸ªå¯¹è±¡å“åº”è¿™ä¸ª selectorã€‚è¿”å›nilï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼Œè¿”å›æŸä¸ªå¯¹è±¡ï¼Œåˆ™ä¼šè°ƒç”¨è¯¥å¯¹è±¡çš„æ–¹æ³•.</li>
<li>è‹¥ forwardingTargetForSelector: è¿”å›çš„æ˜¯nilï¼Œåˆ™æˆ‘ä»¬é¦–å…ˆè¦é€šè¿‡ methodSignatureForSelector: æ¥æŒ‡å®šæ–¹æ³•ç­¾åï¼Œè¿”å›nilï¼Œè¡¨ç¤ºä¸å¤„ç†ï¼Œè‹¥è¿”å›æ–¹æ³•ç­¾åï¼Œåˆ™ä¼šè¿›å…¥ä¸‹ä¸€æ­¥.</li>
<li>å½“ç¬¬ methodSignatureForSelector: æ–¹æ³•è¿”å›æ–¹æ³•ç­¾ååï¼Œå°±ä¼šè°ƒç”¨ forwardInvocation: æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ anInvocation å¯¹è±¡åšå¾ˆå¤šå¤„ç†ï¼Œæ¯”å¦‚ä¿®æ”¹å®ç°æ–¹æ³•ï¼Œä¿®æ”¹å“åº”å¯¹è±¡ç­‰.<ul>
<li>å¦‚æœåˆ°æœ€åï¼Œæ¶ˆæ¯è¿˜æ˜¯æ²¡æœ‰å¾—åˆ°å“åº”ï¼Œç¨‹åºå°±ä¼šcrash</li>
<li><img src="/res/runtime/o_æ¶ˆæ¯è½¬å‘æµç¨‹å›¾.png" alt></li>
</ul>
</li>
</ol>
<!--## åŠ¨æ€åŠ è½½

### +(void)load; +(void)initializeï¼›æœ‰ä»€ä¹ˆç”¨å¤„ï¼Ÿ

åœ¨Objective-Cä¸­ï¼Œruntimeä¼šè‡ªåŠ¨è°ƒç”¨æ¯ä¸ªç±»çš„ä¸¤ä¸ªæ–¹æ³•ã€‚+loadä¼šåœ¨ç±»åˆå§‹åŠ è½½æ—¶è°ƒç”¨ï¼Œ+initializeä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ç±»çš„ç±»æ–¹æ³•æˆ–å®ä¾‹æ–¹æ³•ä¹‹å‰è¢«è°ƒç”¨ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯å¯é€‰çš„ï¼Œä¸”åªæœ‰åœ¨å®ç°äº†å®ƒä»¬æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚ 
å…±åŒç‚¹ï¼šä¸¤ä¸ªæ–¹æ³•éƒ½åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚

>è°ƒç”¨æ—¶é—´

* initialize()æ–¹æ³•çš„è°ƒç”¨æ˜¯åœ¨ä¸€ä¸ªç±»æˆ–è€…å…¶å­ç±»çš„åœ¨å‘é€ç¬¬ä¸€ä¸ªæ¶ˆæ¯ä¹‹å‰ï¼Œ
* +(void)load è¿™ä¸ªæ–¹æ³•è°ƒç”¨è¾ƒæ—©ï¼Œå½“ç±»åŠ è½½çš„æ—¶å€™è¯¥æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚
* çˆ¶ç±»(Superclass)çš„æ–¹æ³•ä¼˜å…ˆäºå­ç±»(Subclass)çš„æ–¹æ³•ï¼Œç±»ä¸­çš„æ–¹æ³•ä¼˜å…ˆäºç±»åˆ«(Category)ä¸­çš„æ–¹æ³•ã€‚ 

-->
<!-- 
* [runtimeå±æ€§ä¸æˆå‘˜å˜é‡](http://www.henishuo.com/runtime-property-ivar/)  
* [http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/#forwarding-%E4%B8%AD%E8%B7%AF%E6%BC%AB%E6%BC%AB%E7%9A%84%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91](http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/#forwarding-%E4%B8%AD%E8%B7%AF%E6%BC%AB%E6%BC%AB%E7%9A%84%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91) -->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå®‰è£…åŒ…ç˜¦èº«</title>
    <url>/essay/ios-business/ipa_size/</url>
    <content><![CDATA[<h3 id="ä¼˜åŒ–æŒ‡æ ‡"><a href="#ä¼˜åŒ–æŒ‡æ ‡" class="headerlink" title="ä¼˜åŒ–æŒ‡æ ‡"></a>ä¼˜åŒ–æŒ‡æ ‡</h3><p>itunes connectä¸Šæœ‰ä¸¤ç§åŒ…å¤§å°æ˜¾ç¤ºï¼šâ€œDownload Sizeâ€ï¼Œâ€œInstall Sizeâ€ã€‚â€œDownload Sizeâ€å³ä¸‹è½½åŒ…å¤§å°ï¼Œè¶…è¿‡150Méœ€è¦ä½¿ç”¨æ— çº¿ç½‘ä¸‹è½½çš„é™åˆ¶å°±æ˜¯è¿™ä¸ªå¤§å°ï¼ˆç°åœ¨å·²ç»æ”¾å®½åˆ°200Mï¼‰ï¼›â€œInstall Sizeâ€å³å®‰è£…åå ç”¨çš„ç£ç›˜ç©ºé—´å¤§å°ï¼Œåœ¨appstoreä¸Šæ˜¾ç¤ºçš„ä¹Ÿæ˜¯è¿™ä¸ªå¤§å°ï¼Œç”¨æˆ·å¾€å¾€ä¼šè¯¯è®¤ä¸ºè¿™æ˜¯ä¸‹è½½å®‰è£…åŒ…æ¶ˆè€—çš„æµé‡å¤§å°ã€‚æ‰€ä»¥ä¸€å¼€å§‹æˆ‘ä»¬å°±å°†â€œInstall Sizeâ€ä½œä¸ºäº†ä¼˜åŒ–æŒ‡æ ‡ã€‚â€œInstall Sizeâ€å‡å°åï¼Œâ€œDownload Sizeâ€è‡ªç„¶ä¹Ÿä¼šå‡å°ã€‚</p>
<a id="more"></a>
<h3 id="Asset-Catalogä¸­çš„æ–‡ä»¶å¤§å°è®¡ç®—"><a href="#Asset-Catalogä¸­çš„æ–‡ä»¶å¤§å°è®¡ç®—" class="headerlink" title="Asset Catalogä¸­çš„æ–‡ä»¶å¤§å°è®¡ç®—"></a>Asset Catalogä¸­çš„æ–‡ä»¶å¤§å°è®¡ç®—</h3><p>Assest.car åšä¸º Asset Catalog çš„ç¼–è¯‘äº§ç‰©ï¼Œæˆ‘ä»¬æ€ä¹ˆè·å–åˆ°caræ–‡ä»¶ä¸­çš„å›¾ç‰‡å¤§å°å‘¢ï¼Ÿåœ¨ä»¥å‰æŸ¥iOS9ï¼ŒP3æ ¼å¼å›¾ç‰‡é—®é¢˜çš„æ—¶å€™æˆ‘ä»¬ç”¨è¿‡è‹¹æœæä¾›çš„assetutilå·¥å…·ï¼Œä½¿ç”¨assetutilå°±èƒ½è·å–åˆ°å›¾ç‰‡ä¿¡æ¯æè¿°ï¼š</p>
<p><code>sudo xcrun --sdk iphoneos assetutil --info xxx/Assets.car &gt; xxx/Assets.json</code></p>
<p>Assets.json ä¸­çš„å›¾ç‰‡è¯¦ç»†æ•°æ®å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;AssetType&quot; : &quot;Image&quot;,</span><br><span class="line">    &quot;BitsPerComponent&quot; : 8,</span><br><span class="line">    &quot;ColorModel&quot; : &quot;RGB&quot;,</span><br><span class="line">    &quot;Colorspace&quot; : &quot;srgb&quot;,</span><br><span class="line">    &quot;Compression&quot; : &quot;lzvn&quot;,</span><br><span class="line">    &quot;Encoding&quot; : &quot;ARGB&quot;,</span><br><span class="line">    &quot;Idiom&quot; : &quot;universal&quot;,</span><br><span class="line">    &quot;Image Type&quot; : &quot;kCoreThemeOnePartScale&quot;,</span><br><span class="line">    &quot;Name&quot; : &quot;1001&quot;, //xxx.imageset çš„æ–‡ä»¶å</span><br><span class="line">    &quot;NameIdentifier&quot; : 11584,</span><br><span class="line">    &quot;Opaque&quot; : false,</span><br><span class="line">    &quot;PixelHeight&quot; : 48,</span><br><span class="line">    &quot;PixelWidth&quot; : 72,</span><br><span class="line">    &quot;RenditionName&quot; : &quot;1001@3x.png&quot;,//å·¥ç¨‹æ–‡ä»¶ä¸­çš„å®é™…å›¾ç‰‡å</span><br><span class="line">    &quot;Scale&quot; : 3,</span><br><span class="line">    &quot;SHA1Digest&quot; : &quot;E34FCAC314E26DE7FF30442AA33E436B242AA4BA&quot;,</span><br><span class="line">    &quot;SizeOnDisk&quot; : 800,//å ç”¨çš„ç£ç›˜å¤§å°ï¼ŒAsset Catalogä¸­çš„å›¾ç‰‡ç¼–è¯‘åçš„å¤§å°å–è¯¥å€¼ã€‚</span><br><span class="line">    &quot;Template Mode&quot; : &quot;automatic&quot;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæˆ‘ä»¬ä½¿ç”¨SizeOnDisk å­—æ®µæ¥è·å–å›¾ç‰‡å¤§å°ã€‚ä½¿ç”¨SizeOnDiskè®¡ç®—ç²¾åº¦å¾ˆé«˜ï¼ˆæ‰€æœ‰å›¾ç‰‡çš„SizeOnDiskç›¸åŠ å’Œcaræ–‡ä»¶å¤§å°è¯¯å·®åœ¨1Mä»¥å†…ï¼‰ã€‚</p>
<p>ä¸€ä¸ªAsset Catalogçš„å›¾ç‰‡åœ¨Assets.carä¸­å®é™…ä¸Šæ ¹æ®ä¸åŒè®¾å¤‡æœ‰4å¼ å¯¹åº”çš„å›¾ç‰‡ï¼Œå¤§å°ä¸åŒï¼Œä½†åå­—ç›¸åŒã€‚è€Œcartoolè§£å‹å‡ºçš„å›¾ç‰‡å¤§å°ä¸ºå…¶ä¸­æŸä¸€å¼ ï¼Œè¿™æ ·å¤§å°è®¡ç®—å°±ä¸å¤ªå‡†ç¡®äº†ã€‚æ‰€ä»¥æ”¾å¼ƒåŸå…ˆä½¿ç”¨cartoolï¼Œæ”¹ç”¨assetutilã€‚</p>
<h4 id="App-Slicing"><a href="#App-Slicing" class="headerlink" title="App Slicing"></a>App Slicing</h4><p>æ¯”å¦‚ä¼ä¸šåŒ…ä¸ç»è¿‡appslicingï¼š<br><img src="/res/ios-business/assets-img.png" alt><br>Appåœ¨æ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œä¼šå°†åŒä¸€å¼ å›¾ç‰‡é‡‡ç”¨é€‚åˆå„ä¸ªä¸åŒæ¶æ„çš„å‹ç¼©æ–¹å¼å°†å›¾ç‰‡å‹ç¼©,å¹¶å­˜å‚¨åˆ°asset.carä¸­.</p>
<p>App Slicingåªä¼šå¯¹åœ¨Asset Catalogçš„èµ„æºæ–‡ä»¶è¿›è¡Œåˆ†å‘ï¼Œè€Œæ”¾åœ¨æ ¹ç›®å½•ï¼Œbundleä¸­çš„èµ„æºæ–‡ä»¶ä¸ä¼šåˆ†å‘ï¼Œæ‰€ä»¥åœ¨ç»Ÿè®¡æ¨¡å—æ‰€ä½¿ç”¨èµ„æºæ–‡ä»¶ä¹‹å‰æˆ‘ä»¬éœ€è¦æ³¨æ„åˆ°è¿™ä¸ªç‰¹æ€§ã€‚å¦‚æœä»¥é€šç”¨åŒ…æ¥ç»Ÿè®¡æ¨¡å—ä½¿ç”¨çš„èµ„æºæ–‡ä»¶å¤§å°ã€æ•°é‡ï¼Œå…¶å®å¹¶ä¸èƒ½çœŸæ­£åæ˜ æ­¤æ¨¡å—å¯¹æ•´ä¸ªå®‰è£…åŒ…å¤§å°çš„å½±å“ã€‚æ‰€ä»¥æˆ‘ä»¬å†³å®šä½¿ç”¨å•ä¸ªè®¾å¤‡æ¥è¡¡é‡èµ„æºæ–‡ä»¶ä½¿ç”¨æƒ…å†µã€‚ç›®å‰æˆ‘ä»¬é€‰æ‹©iPhone Xï¼ŒiOS11è®¾å¤‡åšä¸ºå‚è€ƒæ ‡å‡†ã€‚ è¦ç»Ÿè®¡å•ä¸ªè®¾å¤‡çš„èµ„æºæ–‡ä»¶ä½¿ç”¨æƒ…å†µï¼Œä¸€ä¸ªæ–¹å¼æ˜¯ä½¿ç”¨adhocåŒ…å¯¼å‡ºæ”¯æŒå•ä¸ªè®¾å¤‡çš„å®‰è£…åŒ…ç»Ÿè®¡ï¼Œä¸è¿‡è¿™æ ·çš„æ–¹å¼éœ€è¦æ¯æ¬¡é›†æˆåéƒ½éœ€è¦å•ç‹¬æ‰“åŒ…ï¼Œå› ä¸ºç°åœ¨ciå¹¶ä¸ä¼šå‡ºæ”¯æŒå•ä¸ªè®¾å¤‡çš„åŒ…ã€‚åæ¥æˆ‘ä»¬å‘ç°assetutilé™¤äº†å¯ä»¥å¯¼å‡ºcaræ–‡ä»¶ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä»é€šç”¨åŒ…caræ–‡ä»¶å¯¼å‡ºæŒ‡å®šè®¾å¤‡çš„caræ–‡ä»¶ï¼Œå…¥å‚è¾ƒå¤šï¼Œç»è¿‡å°è¯•iPhone Xçš„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo xcrun --sdk iphoneos assetutil --idiom phone --subtype 570 --scale 3 --display-gamut srgb --graphicsclass MTL2,2 --graphicsclassfallbacks MTL1,2:GLES2,0 --memory 1 --hostedidioms car,watch xxx/Assets.car -o xxx/thinning_assets.car</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šæ–‡çŸ¥é“carä»¥å¤–çš„èµ„æºæ–‡ä»¶ä¸ä¼šåˆ†å‘ï¼Œè·å–æŒ‡å®šè®¾å¤‡çš„caræ–‡ä»¶åæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºæ¨¡å—æ‰€ç”¨èµ„æºæ–‡ä»¶å¤§å°ï¼Œæ•°é‡ã€‚</p>
<h3 id="å…¶ä»–çš„èµ„æºæ–‡ä»¶å¤§å°è®¡ç®—"><a href="#å…¶ä»–çš„èµ„æºæ–‡ä»¶å¤§å°è®¡ç®—" class="headerlink" title="å…¶ä»–çš„èµ„æºæ–‡ä»¶å¤§å°è®¡ç®—"></a>å…¶ä»–çš„èµ„æºæ–‡ä»¶å¤§å°è®¡ç®—</h3><p>å…¶ä»–çš„æ–‡ä»¶å¤§å°è®¡ç®—æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œè‹¹æœçš„APFSæ–‡ä»¶ç³»ç»Ÿçš„æœ€å°å­˜å‚¨å•å…ƒä¸º4KBï¼Œå³ä½¿åªæœ‰å‡ åå­—èŠ‚å¤§å°çš„æ–‡ä»¶ï¼Œå ç”¨çš„ç©ºé—´ä¹Ÿæ˜¯4KBã€‚å¯¹äºå®‰è£…åŒ…é‡Œé¢çš„ç‹¬ç«‹æ–‡ä»¶æˆ‘ä»¬ä½¿ç”¨4KBå¯¹é½çš„æ–¹å¼è¿›è¡Œå¤§å°è®¡ç®—ï¼Œæœ‰äº›å¤§ç‚¹çš„æ–‡ä»¶ç£ç›˜å ç”¨ç©ºé—´å¹¶ä¸æ˜¯4çš„æ•´æ•°å€ï¼Œä½†å¤§å°ç›¸è¿‘ï¼Œå½±å“ä¸å¤§ï¼š Math.ceil(size/4000.0)4ï¼Œsizeä¸ºæ–‡ä»¶å®é™…å¤§å°ï¼Œå•ä½å­—èŠ‚; åœ¨ MBã€KBã€Byte ä¹‹é—´çš„æ¢ä¹Ÿæ˜¯å¯¹é½ Apple ä½¿ç”¨çš„æ˜¯ 1000 è€Œä¸æ˜¯ 1024ï¼ˆå³1MB = 1000 KB = 10001000 Byteï¼‰ã€‚</p>
<h3 id="å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–"><a href="#å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–" class="headerlink" title="å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–"></a>å¯æ‰§è¡Œæ–‡ä»¶ä¼˜åŒ–</h3><ul>
<li>ä½¿ç”¨strip -xå‘½ä»¤å¤„ç†åŠ¨æ€åº“ã€‚</li>
<li>æ— ç”¨ç±»å’Œæ— ç”¨æ–¹æ³• ã€‚ç»“åˆ linkMapæ˜ å°„å‡ºæ— ç”¨çš„æ–¹æ³•å’Œç±»å½’å±çš„ç»„ä»¶ï¼Œå¹¶ä¸”åˆæ­¥é‡åŒ–å¤§å°ã€‚å› ä¸ºåŸºç¡€ç»„ä»¶ä¸­çš„æ— ç”¨æ–¹æ³•å’Œç±»ï¼Œä¸èƒ½ç¡®å®šæ˜¯å¦è¢«éå•†åŸçš„ App ä½¿ç”¨ï¼Œåªèƒ½å¯¹ä¸šåŠ¡ç»„ä»¶ä¼˜åŒ–ï¼Œè€ƒè™‘åˆ°æ¶‰åŠç»„ä»¶ä¼—å¤šï¼Œå¹¶ä¸”æ”¶ç›Šå’Œå·¥ç¨‹é‡ä¸æˆæ­£æ¯”ï¼Œå¹¶ä¸”åˆ é™¤æ–¹æ³•é£é™©æ¯”è¾ƒå¤§ï¼Œå°†æ— ç”¨æ–¹æ³•å’Œç±»ä¼˜åŒ–çš„ä¼˜å…ˆçº§é™ä½ã€‚</li>
<li>å†…ç½®çš„ReactNativeä¸šåŠ¡ JDReactæä¾›äº†é¢„ç½®å’Œåè£…ä¸¤ç§å‘å¸ƒæ–¹å¼ï¼Œè€Œä¸ºäº†ç”¨æˆ·ä½“éªŒï¼Œå¤§éƒ¨åˆ†ä¸šåŠ¡æ¨¡å—éƒ½é€‰æ‹©ä½¿ç”¨é¢„ç½®åŒ…çš„æ–¹å¼ã€‚æ—¶é—´ä¸€é•¿ï¼Œæ–‡ä»¶çš„æ•°é‡å°±è¶Šæ¥è¶Šå¤šã€‚ç”±äºæ–‡ä»¶ç³»ç»Ÿçš„4Kå¯¹é½ï¼Œå¯¹åŒ…å¤§å°çš„å½±å“ä¹Ÿæ˜¯éå¸¸å¤§ã€‚å¯¹å†…ç½®çš„ReactNativeä¸šåŠ¡ä¼˜åŒ–å¦‚ä¸‹ï¼š<ul>
<li>æ¨åŠ¨æµé‡ç›¸å¯¹è¾ƒä½çš„æ¨¡å—ï¼ˆä¸‰çº§åŠä¸‰çº§ä»¥ä¸Šé¡µé¢ï¼‰è½¬åè£…æ–¹å¼ï¼›</li>
<li>æ ¹æ®èµ„æºæ–‡ä»¶ä½¿ç”¨è§„èŒƒï¼Œæ¨åŠ¨ä¸šåŠ¡æ•´æ”¹ï¼› è¿™éƒ¨åˆ†çš„å·¥ä½œé‡ä¸»è¦åœ¨å’Œä¸šåŠ¡æ–¹çš„æ²Ÿé€šï¼Œç»è¿‡éƒ¨åˆ†æ¨¡å—è½¬åè£…åï¼Œç˜¦èº«æ•ˆæœä¹Ÿæ˜¯å¾ˆæ˜æ˜¾ã€‚</li>
</ul>
</li>
<li>extension åœ¨ipaåŒ…ä¸­æˆ‘ä»¬ä¹Ÿæ³¨æ„åˆ°äº†PlugInsç›®å½•,è¿™é‡Œä¸»è¦å­˜æ”¾ä¸€äº›æ’ä»¶ï¼Œæ¯”å¦‚today extensionï¼Œshare extensionç­‰ï¼Œè™½ç„¶è¿™äº›æ’ä»¶åœ¨æ•´ä¸ªipaåŒ…ä¸­çš„å¤§å°å æ¯”ä¸å¤§ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å†³å®šæ¢³ç†ä¸‹æœ‰æ²¡æœ‰ä¼˜åŒ–ç‚¹ã€‚æ¢³ç†åå‘ç°è¿™äº›æ’ä»¶å¯¹äºä¸€äº›åŸºç¡€ç±»åº“ï¼ˆç½‘ç»œæ¡†æ¶ï¼Œå›¾ç‰‡åŠ è½½æ¡†æ¶ç­‰ï¼‰çš„ä½¿ç”¨éƒ½æ˜¯ä»¥æ‹·è´ä»£ç çš„æ–¹å¼åŠ åˆ°å·¥ç¨‹ä¸­ã€‚æˆ‘ä»¬çŸ¥é“è¿™äº›ç±»åº“å®Œå…¨å¯ä»¥å’Œä¸»appå…±äº«ï¼Œå› ä¸ºä¸»appä¸­è¿™äº›åº“æ˜¯ä»¥åŠ¨æ€åº“çš„å½¢å¼ä½¿ç”¨çš„ã€‚ç»è¿‡ä¼˜åŒ–åï¼ŒæˆåŠŸçš„å°†today extensionçš„å¤§å°å‡å°‘äº†0.9Mï¼ˆå—¯~èšŠå­è™½å°â€¦ï¼‰ã€‚</li>
</ul>
<h4 id="å»é™¤ç¬¦å·ä¿¡æ¯"><a href="#å»é™¤ç¬¦å·ä¿¡æ¯" class="headerlink" title="å»é™¤ç¬¦å·ä¿¡æ¯"></a>å»é™¤ç¬¦å·ä¿¡æ¯</h4><ul>
<li>Strip Linked Product / Deployment Postprocessing / Symbols Hidden by Default åœ¨releaseç‰ˆæœ¬åº”è¯¥è®¾ä¸ºyesï¼Œå¯ä»¥å»é™¤ä¸å¿…è¦çš„è°ƒè¯•ç¬¦å·ã€‚Symbols Hidden by Defaultä¼šæŠŠæ‰€æœ‰ç¬¦å·éƒ½å®šä¹‰æˆâ€private externâ€ï¼Œè¯¦ç»†ä¿¡æ¯è§å®˜æ–¹æ–‡æ¡£ã€‚</li>
<li>è¿™äº›é€‰é¡¹ç›®å‰éƒ½æ˜¯XCodeé‡Œreleaseçš„é»˜è®¤é€‰é¡¹ï¼Œä½†æ—§ç‰ˆXCodeç”Ÿæˆçš„é¡¹ç›®å¯èƒ½ä¸æ˜¯ï¼Œå¯ä»¥æ£€æŸ¥ä¸€ä¸‹ã€‚å…¶ä»–ä¼˜åŒ–è¿˜å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£â€”<a href="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/CodeFootprint.html" target="_blank" rel="noopener">Introduction to Code Size Performance Guidelines</a></li>
</ul>
<h4 id="æ— ç”¨ç±»æ— ç”¨æ–¹æ³•"><a href="#æ— ç”¨ç±»æ— ç”¨æ–¹æ³•" class="headerlink" title="æ— ç”¨ç±»æ— ç”¨æ–¹æ³•"></a>æ— ç”¨ç±»æ— ç”¨æ–¹æ³•</h4><p>æ‰«ææ— ç”¨ä»£ç çš„åŸºæœ¬æ€è·¯éƒ½æ˜¯æŸ¥æ‰¾å·²ç»ä½¿ç”¨çš„æ–¹æ³•/ç±»å’Œæ‰€æœ‰çš„ç±»/æ–¹æ³•ï¼Œç„¶åä»æ‰€æœ‰çš„ç±»/æ–¹æ³•å½“ä¸­å‰”é™¤å·²ç»ä½¿ç”¨çš„æ–¹æ³•/ç±»å‰©ä¸‹çš„åŸºæœ¬éƒ½æ˜¯æ— ç”¨çš„ç±»/æ–¹æ³•ï¼Œä½†æ˜¯ç”±äº Objective-C æ˜¯åŠ¨æ€è¯­è¨€ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æ¥è°ƒç”¨ç±»å’Œæ–¹æ³•ï¼Œæ‰€ä»¥æ£€æŸ¥ç»“æœä¸€èˆ¬éƒ½ä¸æ˜¯ç‰¹åˆ«å‡†ç¡®ï¼Œéœ€è¦äºŒæ¬¡ç¡®è®¤ã€‚ç›®å‰å¸‚é¢ä¸Šçš„æ‰«æçš„æ€è·¯å¤§è‡´å¯ä»¥åˆ†ä¸º 3 ç§ï¼š</p>
<ul>
<li>åŸºäº Clang æ‰«æ</li>
<li>åŸºäºå¯æ‰§è¡Œæ–‡ä»¶æ‰«æ</li>
<li>åŸºäºæºç æ‰«æ</li>
</ul>
<blockquote>
<p>é‡æ„é‡å¤ä»£ç </p>
</blockquote>
<p>é‡å¤ä»£ç å †ç§¯å¤ªå¤šï¼Œä¸ä»…æ„å‘³ç€ Bad Code Smellï¼Œæˆ‘ä»¬çš„åŒ…å¤§å°ä¹Ÿä¼šå—åˆ°å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PMD æ¥æ£€æŸ¥é¡¹ç›®ä¸­çš„é‡å¤ä»£ç ï¼Œå¹¶ä¸”åšé€‰æ‹©æ€§çš„é‡æ„ã€‚</p>
<blockquote>
<p>jdåšæ³•</p>
</blockquote>
<p>æ— ç”¨ç±»é€šè¿‡ otool é€†å‘Mach-Oæ–‡ä»¶ <strong>DATA.</strong>objc_classlistæ®µå’Œ<strong>DATA.</strong>objc_classrefs æ®µè·å–æ‰€æœ‰ OC ç±»å’Œè¢«å¼•ç”¨çš„ç±»ï¼Œä¸¤ä¸ªé›†åˆå·®å€¼ä¸ºæ— ç”¨ç±»é›†åˆï¼Œ</p>
<ul>
<li>ç»“åˆ nm -nm å¾—åˆ°åœ°å€å’Œå¯¹åº”ç±»åç¬¦å·åŒ–æ— ç”¨ç±»ç±»åï¼›æ ¹æ®å•†åŸçš„é™åˆ¶åšè¿‡æ»¤ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</li>
<li>otool é€†å‘ <strong>DATA.</strong>objc_nlclslist è·å–å®ç° load æ–¹æ³•çš„ç±»è¿‡æ»¤ï¼ˆRNä¸åŸç”Ÿçš„æ¡¥æ¥ç±»ã€Swizzle Method ç±»ï¼‰ï¼›</li>
<li>é€šè¿‡ otool é€†å‘ <strong>TEXT.</strong>cstring è·å–æ‰€æœ‰å­—ç¬¦ä¸²å¸¸é‡ï¼Œè¿‡æ»¤é€šè¿‡ NSClassFromString è°ƒç”¨çš„ï¼›</li>
<li>å­ç±»å®ä¾‹åŒ–ï¼Œçˆ¶ç±»æ²¡æœ‰å®ä¾‹åŒ–ï¼Œçˆ¶ç±»ä¸ä¼šå‡ºç°åœ¨ä¸­ __objc_classrefsï¼Œé€šè¿‡ otool -oV é€†å‘å‡ºç±»çš„ç»§æ‰¿å…³ç³»ï¼Œè¿‡æ»¤å‡ºå­ç±»è¢«å®ä¾‹åŒ–ï¼ˆNSClassFromString è°ƒç”¨ï¼‰ï¼Œçˆ¶ç±»æ²¡æœ‰å®ä¾‹åŒ–ï¼ˆNSClassFromString è°ƒç”¨ï¼‰çš„ç±»ï¼›</li>
<li>è¿‡æ»¤ä½¿ç”¨ Plist æ–‡ä»¶å¼•ç”¨çš„ç±»ï¼›</li>
</ul>
<p>æ— ç”¨æ–¹æ³• é€šè¿‡ otool é€†å‘ <strong>DATA.</strong>objc_selrefs æ®µè·å–ä½¿ç”¨åˆ°çš„æ–¹æ³•ï¼Œé€šè¿‡ otool -oV è·å–å®ç°çš„æ‰€æœ‰æ–¹æ³•å–å·®å€¼ã€‚ç„¶åè¿‡æ»¤æ‰ setterã€getterã€ç³»ç»Ÿæ–¹æ³•å’Œåè®®ã€è‡ªå®šä¹‰çš„åè®®ã€sel è°ƒç”¨ã€‚</p>
<h4 id="é™æ€åº“ç»Ÿè®¡"><a href="#é™æ€åº“ç»Ÿè®¡" class="headerlink" title="é™æ€åº“ç»Ÿè®¡"></a>é™æ€åº“ç»Ÿè®¡</h4><p>é¡¹ç›®é‡Œä¼šå¼•å…¥å¾ˆå¤šç¬¬ä¸‰æ–¹é™æ€åº“ï¼Œå¦‚æœèƒ½çŸ¥é“è¿™äº›ç¬¬ä¸‰æ–¹åº“åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œå ç”¨çš„å¤§å°ï¼Œå°±å¯ä»¥è¯„ä¼°æ˜¯å¦å€¼å¾—å»æ‰¾æ›¿ä»£æ–¹æ¡ˆå»æ‰è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ã€‚æˆ‘ä»¬å¯ä»¥ä»linkmapä¸­ç»Ÿè®¡å‡ºè¿™ä¸ªä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡linkmapç»Ÿè®¡æ¯ä¸ª.oç›®æ ‡æ–‡ä»¶å ç”¨çš„ä½“ç§¯å’Œæ¯ä¸ª.aé™æ€åº“å ç”¨çš„ä½“ç§¯</p>
<h4 id="ARCè½¬MRC"><a href="#ARCè½¬MRC" class="headerlink" title="ARCè½¬MRC"></a>ARCè½¬MRC</h4><p>æœ‰äººæå‡ºç”¨ARCå†™çš„ä»£ç ç¼–è¯‘å‡ºæ¥çš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ä¼šæ¯”ç”¨MRCå¤§çš„ï¼ŒåŸå› å¤§è‡´æ˜¯ARCä»£ç ä¼šåœ¨æŸäº›æƒ…å†µå¤šå‡ºä¸€äº›retainå’Œreleaseçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒè¿”å›çš„å¯¹è±¡ä¼šè¢«retainï¼Œé€€å‡ºä½œç”¨åŸŸåä¼šè¢«releaseï¼ŒMRCå°±ä¸éœ€è¦ï¼Œæ±‡ç¼–æŒ‡ä»¤å˜å¤šï¼Œæœºå™¨ç å˜å¤šï¼Œå¯æ‰§è¡Œæ–‡ä»¶å°±å˜å¤§äº†ã€‚è¿˜æœ‰å…¶ä»–ç»†èŠ‚å®ç°çš„åŒºåˆ«ï¼Œå…ˆä¸çº ç»“äº†ã€‚</p>
<p>é‚£ç”¨ARCç©¶ç«Ÿä¼šå¢å¤§å¤šå°‘ä½“ç§¯ï¼Ÿæˆ‘è§‰å¾—ä»æ±‡ç¼–æŒ‡ä»¤çš„å¢å¤šå‡å°‘å»ç®—æ˜¯å¾ˆéš¾ç®—å‡†ç¡®çš„ï¼Œè¿™ä¸œè¥¿æ¶‰åŠç»†èŠ‚å¤ªå¤šï¼Œè¿˜æ˜¯å¾—ä»ç»Ÿè®¡çš„è§’åº¦è®¡ç®—ã€‚åšäº†å‡ ä¸ªå¯¹æ¯”è¯•éªŒï¼Œç»Ÿè®¡äº†å‡ ä¸ªåŒæ—¶æ”¯æŒARC/MRCçš„å¼€æºé¡¹ç›®åœ¨å¼€å¯/å…³é—­ARCçš„æƒ…å†µä¸‹<strong>TEXTä»£ç æ®µçš„å¤§å°å¯¹æ¯”ã€‚åªå¯¹æ¯”</strong>TEXTä»£ç æ®µæ˜¯å› ä¸ºï¼š</p>
<p>ARCå¯¹å¯æ‰§è¡Œæ–‡ä»¶å¤§å°çš„å½±å“å‡ ä¹éƒ½æ˜¯åœ¨ä»£ç æ®µARCå¤§æ¦‚ä¼šä½¿ä»£ç æ®µå¢åŠ 10%çš„sizeï¼Œè€ƒè™‘ä»£ç æ®µå å¯æ‰§è¡Œæ–‡ä»¶å¤§çº¦æœ‰80%ï¼Œä¼°è®¡å¯¹æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„å½±å“ä¼šæ˜¯8%ã€‚</p>
<p>å¯ä»¥è¯„ä¼°ä¸€ä¸‹8%çš„ä½“ç§¯ä¸‹é™æ˜¯ä¸æ˜¯å€¼å¾—æŠŠé¡¹ç›®é‡ŒæŸäº›æ¨¡å—æ”¹æˆMRCï¼Œè¿™æ ·ç¨‹åºçš„ç»´æŠ¤æˆæœ¬ä¸Šå‡äº†ï¼Œä¸€èˆ¬ä¸åˆ°ç‰¹æ®Šæƒ…å†µä¸å»ºè®®è¿™ä¹ˆåšã€‚</p>
<h4 id="ç±»-æ–¹æ³•åé•¿åº¦"><a href="#ç±»-æ–¹æ³•åé•¿åº¦" class="headerlink" title="ç±»/æ–¹æ³•åé•¿åº¦"></a>ç±»/æ–¹æ³•åé•¿åº¦</h4><p>è§‚å¯Ÿlinkmapå¯ä»¥å‘ç°æ¯ä¸ªç±»å’Œæ–¹æ³•åéƒ½åœ¨__cstringæ®µé‡Œéƒ½å­˜äº†ç›¸åº”çš„å­—ç¬¦ä¸²å€¼ï¼Œæ‰€ä»¥ç±»å’Œæ–¹æ³•åçš„é•¿çŸ­ä¹Ÿæ˜¯å¯¹å¯æ‰§è¡Œæ–‡ä»¶å¤§å°æ˜¯æœ‰å½±å“çš„ï¼ŒåŸå› è¿˜æ˜¯object-cçš„åŠ¨æ€ç‰¹æ€§ï¼Œå› ä¸ºéœ€è¦é€šè¿‡ç±»/æ–¹æ³•ååå°„æ‰¾åˆ°è¿™ä¸ªç±»/æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œobject-cå¯¹è±¡æ¨¡å‹ä¼šæŠŠç±»/æ–¹æ³•åå­—ç¬¦ä¸²éƒ½ä¿å­˜ä¸‹æ¥ã€‚</p>
<p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨ç¼–è¯‘å‰æŠŠæ‰€æœ‰ç±»å’Œæ–¹æ³•åè¿›è¡Œæ··æ·†ï¼Œè·Ÿå‹ç¼©jsä¸€æ ·ï¼ŒæŠŠé•¿åå­—æ›¿æ¢æˆçŸ­åå­—ï¼Œè¿™æ ·åšçš„å¥½å¤„é™¤äº†ç¼©å°ä½“ç§¯å¤–ï¼Œè¿˜å¯¹å®‰å…¨æ€§æœ‰å¾ˆå¤§æå‡ï¼Œåˆ«äººæ‹¿åˆ°å¯æ‰§è¡Œæ–‡ä»¶å¯¹å®ƒclass-dumpå‡ºæ¥çš„ç»“æœéƒ½æ˜¯æ··æ·†åçš„ç±»å’Œæ–¹æ³•åï¼Œå°±æ— æ³•ä»ç±»å’Œæ–¹æ³•åä¸­çŒœå‡ºæŸä¸ªæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Œå°±éš¾ä»¥æŒ‚é’©å­è¿›è¡Œhackã€‚ä¸è¿‡è¿™æ ·åšæœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯crashå †æ ˆåè§£å‡ºæ¥çš„å †æ ˆæ–¹æ³•åä¼šæ˜¯æ··æ·†åçš„ï¼Œéœ€è¦å†åŠ ä¸€å±‚æ··æ·†-&gt;åŸåçš„è½¬æ¢ï¼Œå®ç°å’Œä½¿ç”¨æˆæœ¬æœ‰ç‚¹é«˜ã€‚</p>
<p>å®é™…ä¸Šè¿™éƒ¨åˆ†å ç”¨çš„é•¿åº¦æ¯”è¾ƒå°ï¼Œä¸­å‹é¡¹ç›®ä¹Ÿå°±å‡ ç™¾Kï¼Œå¯¹å®‰å…¨æ€§è¦æ±‚é«˜çš„æƒ…å†µå¯ä»¥è¯•è¯•ã€‚</p>
<h3 id="èµ„æºæ–‡ä»¶ä¼˜åŒ–"><a href="#èµ„æºæ–‡ä»¶ä¼˜åŒ–" class="headerlink" title="èµ„æºæ–‡ä»¶ä¼˜åŒ–"></a>èµ„æºæ–‡ä»¶ä¼˜åŒ–</h3><p>è¿™ä¹Ÿæ˜¯ä¸€æœŸä¼˜åŒ–é€šè¿‡æ”¹é€  Assets.car ä¸­çš„ 183 å¼ å›¾ç‰‡èƒ½ä¼˜åŒ–äº†è¿‘ 30M åŸå› ï¼Œåƒä¸‡ä¸è¦å°†å¤§å›¾éšæ„æ‹–åˆ°å·¥ç¨‹ä¸­ã€‚ ç»“åˆä¸Šæ–‡ä¸­è´Ÿä¼˜åŒ–è§„å¾‹ï¼Œæ”¹é€ å¤„ç†æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>æ— ç”¨æ–‡ä»¶åˆ é™¤ <ul>
<li>ç°åœ¨åº”è¯¥æ²¡æœ‰APPéœ€è¦æ”¯æŒiPhone4ä»¥ä¸‹çš„æœºå‹äº†ï¼Œæ‰€ä»¥1Xçš„å›¾ç‰‡å¯ä»¥å…¨éƒ¨åˆ æ‰ã€‚3Xçš„å›¾ç‰‡æ˜¯ä¿ç•™è¿˜æ˜¯åˆ æ‰çœ‹å…·ä½“æƒ…å†µã€‚</li>
</ul>
</li>
<li>é‡å¤æ–‡ä»¶åˆ é™¤</li>
<li>å¤§æ–‡ä»¶å‹ç¼© apng<ul>
<li>ä¸èƒ½è½¬ä¸‹è½½çš„ä½¿ç”¨å‹ç¼©è¿‡çš„jpgæ ¼å¼å›¾ç‰‡ã€‚</li>
<li>ä¸èƒ½ä½¿ç”¨jpgçš„å›¾ç‰‡ç»è¿‡å‹ç¼©å( ä¸»è¦æ˜¯tinypngæœ‰æŸå‹ç¼©)åæ”¾åˆ° bundle ä¸­ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li>å›¾ç‰‡ç®¡ç†æ–¹å¼è§„èŒƒ<ul>
<li>ä¼˜å…ˆè½¬ç½‘ç»œä¸‹è½½ï¼Œä½¿ç”¨é»˜è®¤å›¾/çº¯è‰²å…œåº•ï¼Œå¦‚æ¥¼å±‚èƒŒæ™¯å›¾ï¼›</li>
</ul>
</li>
<li>èµ„æºå‹ç¼©<ul>
<li>é¦–å…ˆæ˜¯<em>å›¾ç‰‡å‹ç¼©</em>ï¼ŒImageOptim/TinyPNG/ImageAlapha å·¥å…·å¯ä»¥å®ç°æ— æŸå‹ç¼©ã€‚<ul>
<li>å…¶å®åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›å›¾ç‰‡çš„æ—¶å€™,æˆ‘ä»¬å…¶å®æ˜¯ç”¨çš„ä¸€äº›å›¾ç‰‡,ä½†æ˜¯åƒå›¾ç‰‡çš„åˆ›å»ºæ—¥æœŸ,åˆ›å»ºäººä¹‹ç±»çš„ä¿¡æ¯å…¶å®åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­æ˜¯æ²¡æœ‰ç”¨åˆ°çš„.è¿™äº›ä¿¡æ¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·è¿›è¡Œåˆ é™¤,è¿™é‡Œç»™å¤§å®¶æ¨èæ¬¾å·¥å…·ImageOptim.å¦å¤–å…³äºå›¾ç‰‡ï¼Œå»ºè®®ä½¿ç”¨Appleæ¨èçš„.xcassetsæ¥ç®¡ç†ï¼Œå®ƒä¼šæŠŠé‡Œè¾¹çš„æ‰€æœ‰pngæ ¼å¼çš„å›¾ç‰‡å‹ç¼©æˆä¸€ä¸ªAssets.caræ–‡ä»¶ï¼Œå‹ç¼©æ¯”ç‡æ¯”å…¶ä»–æ–¹å¼ç®¡ç†å›¾ç‰‡è¦é«˜ã€‚ä¸è¿‡æµ‹è¯•å‘ç°jpgå›¾ç‰‡ä¸ä¼šåœ¨Assets.caræ–‡ä»¶é‡Œã€‚</li>
</ul>
</li>
<li>å°½é‡ä½¿ç”¨<em>8-bitå›¾ç‰‡</em><ul>
<li>ä½¿ç”¨8-bitçš„PNGå›¾ç‰‡ï¼Œæ¯”32-bitçš„å›¾ç‰‡èƒ½å‡å°‘4å€çš„å‹ç¼©ç‡ã€‚ç”±äº8-bitçš„å›¾ç‰‡æ”¯æŒæœ€å¤š256ç§ä¸åŒçš„é¢œè‰²ï¼Œæ‰€ä»¥8-bitçš„å›¾ç‰‡ä¸€èˆ¬åªåº”è¯¥ç”¨äºä¸€å°éƒ¨åˆ†çš„é¢œseå›¾ç‰‡ã€‚ä¾‹å¦‚ç°åº¦å›¾ç‰‡æœ€å¥½ä½¿ç”¨8-bitã€‚</li>
</ul>
</li>
<li><em>éŸ³é¢‘çš„å‹ç¼©</em><ul>
<li>å‚è€ƒWWDCä¸­çš„<a href="https://developer.apple.com/videos/play/wwdc2011/404/" target="_blank" rel="noopener">Audio Development for Games</a>ï¼Œé‡Œé¢ä»‹ç»äº†å¦‚ä½•æœ‰æ•ˆçš„å¤„ç†éŸ³é¢‘ã€‚å¸¸è§„æ¥è¯´ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨AACæˆ–MP3æ¥å‹ç¼©éŸ³é¢‘ï¼Œå¹¶ä¸”å¯ä»¥å°è¯•é™ä½ä¸€ä¸‹éŸ³é¢‘çš„æ¯”ç‰¹ç‡ã€‚æœ‰æ—¶å€™44.1khzçš„é‡‡æ ·æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œç¨å¾®ä½ä¸€ç‚¹çš„æ¯”ç‰¹ç‡ä¹Ÿä¸ä¼šé™ä½éŸ³é¢‘çš„è´¨é‡ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="æ— ç”¨å›¾ç‰‡ç­›æŸ¥"><a href="#æ— ç”¨å›¾ç‰‡ç­›æŸ¥" class="headerlink" title="æ— ç”¨å›¾ç‰‡ç­›æŸ¥"></a>æ— ç”¨å›¾ç‰‡ç­›æŸ¥</h4><p>é€šè¿‡åˆ†æå®‰è£…åŒ…ä¸­ä½¿ç”¨å›¾ç‰‡å¯åˆ†ä¸ºä¸‰ç±»æ–‡ä»¶ï¼š</p>
<ul>
<li>å¯æ‰§è¡Œæ–‡ä»¶ï¼›</li>
<li>å¯è¯»æ–‡ä»¶ï¼ˆ.plistã€.jsã€.htmlï¼‰ï¼›</li>
<li>ä¸å¯è¯»æ–‡ä»¶ï¼ˆ.nibã€.storyboardcï¼‰ï¼›</li>
</ul>
<p>å¯æ‰§è¡Œæ–‡ä»¶é€šè¿‡ otool -v -s <strong>TEXT </strong>cstring è·å–å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„ <strong>TEXT.</strong>cstring æ®µã€‚__cstring åŒ…å«äº†å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„å­—ç¬¦ä¸²å¸¸é‡ï¼ˆæºç ä¸­çš„ @â€œxxxâ€ å­—ç¬¦ä¸²ï¼‰ï¼›</p>
<h4 id="iconfont"><a href="#iconfont" class="headerlink" title="iconfont"></a>iconfont</h4><p>å³ä½¿ç»è¿‡äº†å›¾ç‰‡è½¬ä¸‹è½½ï¼Œæ— ç”¨å›¾ç‰‡åˆ é™¤ï¼Œä½†æ˜¯å·¥ç¨‹ä¸­çš„å›¾ç‰‡æ•°é‡è¿˜æ˜¯æä¸ºå¯è§‚ï¼Œå…¶ä¸­å„ç§å„æ ·çš„iconå›¾æ ‡å äº†ä¸å°‘çš„æ•°é‡ã€‚ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘å›¾ç‰‡æ•°é‡ï¼Œæˆ‘ä»¬å¼•å…¥äº†iconfontæ–¹æ¡ˆï¼Œ iconfontä¼˜ç‚¹ï¼š</p>
<ul>
<li>çŸ¢é‡ï¼Œç¼©æ”¾ä¸å¤±çœŸã€‚</li>
<li>å¯ä»¥è®¾ç½®é¢œè‰²ã€‚</li>
<li>æ¥å…¥æˆæœ¬ä½ï¼Œä¸éœ€è¦å¼•å…¥é¢å¤–çš„ç±»åº“ã€‚</li>
</ul>
<p>iconfont å¯ä»¥è§£å†³å› ä¸ºiconå¤§å°ï¼Œé¢œè‰²ä¸åŒè€Œé‡æ–°åˆ‡å›¾çš„çª˜å¢ƒã€‚ä»äº¬ä¸œå†…éƒ¨çš„quarkå¹³å°äº†è§£åˆ°ç›®å‰å·²ç»å¯ä»¥å¾ˆå¥½çš„æ”¯æŒiconfontï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªæ¨¡å—å°±æ‰¾åˆ°äº†55ä¸ªiconå¹¶ä¸”æˆåŠŸè½¬æˆäº†iconfontã€‚ä¸éš¾çœ‹å‡ºiconfontæ˜¯ä¸€ä¸ªèƒ½å‡å°‘å›¾ç‰‡æ•°é‡çš„å¥½æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š Apple ä¸ºäº†åœ¨ä¼˜åŒ– iPhone è®¾å¤‡è¯»å– png å›¾ç‰‡é€Ÿåº¦ï¼Œå°† png è½¬æ¢æˆ CgBI éæ ‡å‡†çš„ png æ ¼å¼<br>Appleè‡ªåŠ¨ä¼˜åŒ–ï¼š â€¢ æ”¾åœ¨æ ¹ç›®å½•ä¸‹pngæ ¼å¼çš„å›¾ç‰‡ã€‚ â€¢ æ”¾åœ¨Asset Catalogä¸­çš„pngï¼Œjpgæ ¼å¼çš„å›¾ç‰‡ï¼Œå…¶ä¸­jpgä¼šè½¬æˆpngã€‚<br>ä¸ä¼šå¤„ç†ï¼š æ”¾åœ¨æ ¹ç›®å½•ä¸‹çš„jpgï¼Œ bundleä¸­çš„pngä¸ä¼šè¢«ä¼˜åŒ–</p>
</blockquote>
<h3 id="xcodeç¼–è¯‘å‚æ•°ä¼˜åŒ–"><a href="#xcodeç¼–è¯‘å‚æ•°ä¼˜åŒ–" class="headerlink" title="xcodeç¼–è¯‘å‚æ•°ä¼˜åŒ–"></a>xcodeç¼–è¯‘å‚æ•°ä¼˜åŒ–</h3><ul>
<li>Generate Debug Symbols</li>
<li>Asset Catalog Compiler</li>
<li>Dead Code Stripping</li>
<li>Apple Clang - Code Generation - Optimization Level</li>
<li>Strip Symbol Information</li>
<li>Exceptions - å»æ‰å¼‚å¸¸æ”¯æŒï¼ŒEnable C++ Exceptionså’ŒEnable Objective-C Exceptionsè®¾ä¸ºNO</li>
</ul>
<h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><p>æ— ç”¨ç‰©å“æ‰«æ <a href="https://github.com/tinymind/LSUnusedResources" target="_blank" rel="noopener">https://github.com/tinymind/LSUnusedResources</a></p>
<p>é‡å¤æ–‡ä»¶ï¼š<a href="https://github.com/arsenetar/dupeguru" target="_blank" rel="noopener">https://github.com/arsenetar/dupeguru</a></p>
<p>å›¾ç‰‡å‹ç¼© : <a href="https://github.com/ImageOptim/ImageOptim" target="_blank" rel="noopener">https://github.com/ImageOptim/ImageOptim</a></p>
<p>linkmap: <a href="https://github.com/huanxsd/LinkMap" target="_blank" rel="noopener">https://github.com/huanxsd/LinkMap</a></p>
<p>æŸ¥æ‰¾ç›¸ä¼¼ä»£ç  <a href="https://github.com/startry/SameCodeFinder" target="_blank" rel="noopener">https://github.com/startry/SameCodeFinder</a></p>
<p>æ— ç”¨ä»£ç  æ— ç”¨imoprt <a href="https://github.com/dblock/fui" target="_blank" rel="noopener">https://github.com/dblock/fui</a> </p>
<p><a href="http://blog.lessfun.com/blog/2015/09/02/find-unused-resources-in-xcode-project/" target="_blank" rel="noopener">æŸ¥æ‰¾XCodeå·¥ç¨‹ä¸­æ²¡è¢«ä½¿ç”¨çš„å›¾ç‰‡èµ„æº</a></p>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p>å¹²è´§ï¼äº¬ä¸œå•†åŸiOS Appç˜¦èº«å®è·µ<br>å¹²è´§|ä»Šæ—¥å¤´æ¡iOSç«¯å®‰è£…åŒ…å¤§å°ä¼˜åŒ–<br><a href="https://www.jianshu.com/p/c94dedef90b7" target="_blank" rel="noopener">https://www.jianshu.com/p/c94dedef90b7</a><br><a href="https://www.cnblogs.com/wdsunny/p/7486617.html" target="_blank" rel="noopener">https://www.cnblogs.com/wdsunny/p/7486617.html</a><br><a href="https://mp.weixin.qq.com/s/J_XYpIfDeeWJBlk9sRQMAA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/J_XYpIfDeeWJBlk9sRQMAA</a></p>
]]></content>
      <categories>
        <category>iOSå¼€å‘è¿›é˜¶</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Runtime å¯¹è±¡å…³è”åŸç†</title>
    <url>/essay/Runtime/runtime-%E5%AF%B9%E8%B1%A1%E5%85%B3%E8%81%94/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç» å¯¹è±¡å…³è”ï¼Œä»¥åŠå¦‚ä½•ä¸ºCategoryæ·»åŠ weakå±æ€§<br><a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">apple open source</a></p>
</blockquote>
<h2 id="å¯¹è±¡å…³è”åŸç†"><a href="#å¯¹è±¡å…³è”åŸç†" class="headerlink" title="å¯¹è±¡å…³è”åŸç†"></a>å¯¹è±¡å…³è”åŸç†</h2><p>åˆ›å»ºä¸€ä¸ªç±»çš„åˆ†ç±»<code>Category</code>ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå±æ€§<code>CategoryProperty</code>ï¼Œåˆ†ç±»ä¸­çš„@CategoryPropertyå¹¶æ²¡æœ‰å¸®æˆ‘ä»¬ç”Ÿæˆå®ä¾‹å˜é‡ä»¥åŠå­˜å–æ–¹æ³•ï¼Œè¦æ±‚æˆ‘ä»¬æ‰‹åŠ¨å®ç°ï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ°å¯¹è±¡å…³è”ã€‚</p>
<p>åœ¨åˆ†ç±»ä¸­ï¼Œå› ä¸ºç±»çš„å®ä¾‹å˜é‡çš„å¸ƒå±€å·²ç»å›ºå®šï¼Œä½¿ç”¨ @property å·²ç»æ— æ³•å‘å›ºå®šçš„å¸ƒå±€ä¸­æ·»åŠ æ–°çš„å®ä¾‹å˜é‡ï¼ˆè¿™æ ·åšå¯èƒ½ä¼šè¦†ç›–å­ç±»çš„å®ä¾‹å˜é‡ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ä»¥åŠä¸¤ä¸ªæ–¹æ³•æ¥æ¨¡æ‹Ÿæ„æˆå±æ€§çš„ä¸‰ä¸ªè¦ç´ ã€‚</p>
<p>å…³è”å¯¹è±¡åˆæ˜¯å¦‚ä½•å®ç°å¹¶ä¸”ç®¡ç†çš„å‘¢ï¼š<br><a id="more"></a></p>
<ul>
<li>å…³è”å¯¹è±¡å…¶å®å°±æ˜¯ ObjcAssociation å¯¹è±¡</li>
<li>å…³è”å¯¹è±¡ç”± AssociationsManager ç®¡ç†å¹¶åœ¨  AssociationsHashMap å­˜å‚¨</li>
<li>å¯¹è±¡çš„æŒ‡é’ˆä»¥åŠå…¶å¯¹åº” ObjectAssociationMap ä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨ AssociationsHashMap ä¸­<br>ObjectAssociationMap åˆ™æ˜¯ç”¨äºå­˜å‚¨å…³è”å¯¹è±¡çš„æ•°æ®ç»“æ„</li>
<li>æ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæ ‡è®°ä½ has_assoc æŒ‡ç¤ºå¯¹è±¡æ˜¯å¦å«æœ‰å…³è”å¯¹è±¡</li>
</ul>
<p>å¯¹è±¡å…³è”ä¼šç”¨åˆ°ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä»¥é”®å€¼å¯¹å½¢å¼æ·»åŠ å…³è”å¯¹è±¡</span></span><br><span class="line"><span class="keyword">void</span> objc_setAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">id</span> value, objc_AssociationPolicy policy);</span><br><span class="line"><span class="comment">//æ ¹æ® key è·å–å…³è”å¯¹è±¡</span></span><br><span class="line"><span class="keyword">id</span> objc_getAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line">ç§»é™¤æ‰€æœ‰å…³è”å¯¹è±¡</span><br><span class="line"><span class="keyword">void</span> objc_removeAssociatedObjects(<span class="keyword">id</span> object);</span><br></pre></td></tr></table></figure>
<p><em>objc_removeAssociatedObjects å‡½æ•°æˆ‘ä»¬ä¸€èˆ¬æ˜¯ç”¨ä¸ä¸Šçš„ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°ä¼šç§»é™¤ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å…³è”å¯¹è±¡ï¼Œå°†è¯¥å¯¹è±¡æ¢å¤æˆâ€œåŸå§‹â€çŠ¶æ€ã€‚è¿™æ ·åšå°±å¾ˆæœ‰å¯èƒ½æŠŠåˆ«äººæ·»åŠ çš„å…³è”å¯¹è±¡ä¹Ÿä¸€å¹¶ç§»é™¤ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€å¸Œæœ›çš„ã€‚æ‰€ä»¥ä¸€èˆ¬çš„åšæ³•æ˜¯é€šè¿‡ç»™ objc_setAssociatedObject å‡½æ•°ä¼ å…¥ nil æ¥ç§»é™¤æŸä¸ªå·²æœ‰çš„å…³è”å¯¹è±¡ã€‚</em></p>
<h3 id="objc-setAssociatedObject"><a href="#objc-setAssociatedObject" class="headerlink" title="objc_setAssociatedObject"></a>objc_setAssociatedObject</h3><p>objc_setAssociatedObject æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_setAssociatedObject(<span class="keyword">id</span> object, <span class="keyword">const</span> <span class="keyword">void</span> *key, <span class="keyword">id</span> value, objc_AssociationPolicy policy) &#123;</span><br><span class="line">    _object_set_associative_reference(object, (<span class="keyword">void</span> *)key, value, policy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>_object_set_associative_reference</code>æ–¹æ³•å®é™…å®Œæˆäº†è®¾ç½®å…³è”å¯¹è±¡çš„ä»»åŠ¡ï¼š</p>
<p>è¯¥æ–¹æ³•çš„æ‰§è¡Œæ˜¯ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _object_set_associative_reference(<span class="keyword">id</span> object, <span class="keyword">void</span> *key, <span class="keyword">id</span> value, uintptr_t policy) &#123;</span><br><span class="line">	 <span class="comment">//1.</span></span><br><span class="line">    ObjcAssociation old_association(<span class="number">0</span>, <span class="literal">nil</span>);</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="keyword">id</span> new_value = value ? acquireValue(value, policy) : <span class="literal">nil</span>;</span><br><span class="line">    &#123;</span><br><span class="line">    	  <span class="comment">//3.</span></span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        <span class="comment">//4.</span></span><br><span class="line">        disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">		  <span class="keyword">if</span>(new_value)&#123;</span><br><span class="line">		  	AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">		  	<span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">        	 	 <span class="comment">//6.</span></span><br><span class="line">           	 ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">           	 ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">           	 <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">           	     old_association = j-&gt;second;</span><br><span class="line">           	     j-&gt;second = ObjcAssociation(policy, new_value);</span><br><span class="line">           	 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             	   (*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">           	 &#125;</span><br><span class="line">        	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	  	<span class="comment">//5.</span></span><br><span class="line">            	ObjectAssociationMap *refs = new ObjectAssociationMap;</span><br><span class="line">            	associations[disguised_object] = refs;</span><br><span class="line">            	(*refs)[key] = ObjcAssociation(policy, new_value);</span><br><span class="line">           	 <span class="comment">//å®ƒä¼šå°† isa ç»“æ„ä½“ä¸­çš„æ ‡è®°ä½ has_assoc æ ‡è®°ä¸º true</span></span><br><span class="line">            	object-&gt;setHasAssociatedObjects();</span><br><span class="line">        		&#125;</span><br><span class="line">		  &#125;</span><br><span class="line">        </span><br><span class="line">    	<span class="keyword">else</span>&#123;</span><br><span class="line">        	AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">        	<span class="keyword">if</span> (i !=  associations.end()) &#123;</span><br><span class="line">           	 ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">           	 ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">           	 <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">           	     old_association = j-&gt;second;</span><br><span class="line">           	     <span class="comment">//è°ƒç”¨ erase æ–¹æ³•ï¼Œæ“¦é™¤ ObjectAssociationMap ä¸­ key å¯¹åº”çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line">          	      refs-&gt;erase(j);</span><br><span class="line">          	  &#125;</span><br><span class="line">       	 &#125;</span><br><span class="line">   		 &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//7.</span></span><br><span class="line">    <span class="keyword">if</span> (old_association.hasValue()) ReleaseValue()(old_association);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­è®¾ç½®å…³è”å¯¹è±¡çš„é€»è¾‘ï¼š</p>
<ol>
<li>ä½¿ç”¨ old_association(0, nil) åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ ObjcAssociation å¯¹è±¡ï¼ˆç”¨äºæŒæœ‰åŸæœ‰çš„å…³è”å¯¹è±¡ï¼Œæ–¹ä¾¿åœ¨æ–¹æ³•è°ƒç”¨çš„æœ€åé‡Šæ”¾å€¼ï¼‰</li>
<li>è°ƒç”¨ acquireValue å¯¹ new_value è¿›è¡Œ retain æˆ–è€… copy</li>
<li>åˆå§‹åŒ–ä¸€ä¸ª AssociationsManagerï¼Œå¹¶è·å–å”¯ä¸€çš„ä¿å­˜å…³è”å¯¹è±¡çš„å“ˆå¸Œè¡¨ AssociationsHashMap</li>
<li>å…ˆä½¿ç”¨ DISGUISE(object) ä½œä¸º key å¯»æ‰¾å¯¹åº”çš„ ObjectAssociationMap</li>
<li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆå§‹åŒ–ä¸€ä¸ª ObjectAssociationMapï¼Œå†å®ä¾‹åŒ– ObjcAssociation å¯¹è±¡æ·»åŠ åˆ° Map ä¸­ï¼Œå¹¶è°ƒç”¨ setHasAssociatedObjects æ–¹æ³•ï¼Œè¡¨æ˜å½“å‰å¯¹è±¡å«æœ‰å…³è”å¯¹è±¡</li>
<li>å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„ ObjectAssociationMapï¼Œå°±è¦çœ‹ key æ˜¯å¦å­˜åœ¨äº†ï¼Œç”±æ­¤æ¥å†³å®šæ˜¯æ›´æ–°åŸæœ‰çš„å…³è”å¯¹è±¡ï¼Œè¿˜æ˜¯å¢åŠ ä¸€ä¸ª</li>
<li>æœ€åï¼Œå¦‚æœåŸæ¥çš„å…³è”å¯¹è±¡æœ‰å€¼çš„è¯ï¼Œä¼šè°ƒç”¨ ReleaseValue() é‡Šæ”¾å…³è”å¯¹è±¡çš„å€¼</li>
</ol>
<p><img src="/res/runtime/objc_setAssociatedObject.png" alt></p>
<h3 id="objc-getAssociatedObject"><a href="#objc-getAssociatedObject" class="headerlink" title="objc_getAssociatedObject"></a>objc_getAssociatedObject</h3><p>objc_getAssociatedObjectæ–¹æ³•çš„è°ƒç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id objc_getAssociatedObject(id object, const void *key) &#123;</span><br><span class="line">    return _object_get_associative_reference(object, (void *)key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_object_get_associative_reference</code>æ–¹æ³•å®ç°äº†ç›¸åº”çš„ä»»åŠ¡ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">id</span> _object_get_associative_reference(<span class="keyword">id</span> object, <span class="keyword">void</span> *key) &#123;</span><br><span class="line">    <span class="keyword">id</span> value = <span class="literal">nil</span>;</span><br><span class="line">    uintptr_t policy = OBJC_ASSOCIATION_ASSIGN;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            ObjectAssociationMap::iterator j = refs-&gt;find(key);</span><br><span class="line">            <span class="keyword">if</span> (j != refs-&gt;end()) &#123;</span><br><span class="line">                ObjcAssociation &amp;entry = j-&gt;second;</span><br><span class="line">                value = entry.value();</span><br><span class="line">                policy = entry.policy();</span><br><span class="line">                <span class="keyword">if</span> (policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN) ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(value, SEL_retain);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value &amp;&amp; (policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) &#123;</span><br><span class="line">        ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(value, SEL_autorelease);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å¯»æ‰¾å…³è”å¯¹è±¡çš„é€»è¾‘ï¼š</p>
<ol>
<li>è·å–é™æ€å˜é‡ AssociationsHashMap</li>
<li>ä»¥ DISGUISE(object) ä¸º key æŸ¥æ‰¾ AssociationsHashMap</li>
<li>ä»¥ void *key ä¸º key æŸ¥æ‰¾ ObjcAssociation</li>
<li>æ ¹æ® policy è°ƒç”¨ç›¸åº”çš„æ–¹æ³•</li>
<li>è¿”å›å…³è”å¯¹è±¡ ObjcAssociation çš„å€¼</li>
</ol>
<h3 id="objc-removeAssociatedObjects"><a href="#objc-removeAssociatedObjects" class="headerlink" title="objc_removeAssociatedObjects"></a>objc_removeAssociatedObjects</h3><p><code>objc_removeAssociatedObjects</code>  çš„è°ƒç”¨ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> objc_removeAssociatedObjects(<span class="keyword">id</span> object) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (object &amp;&amp; object-&gt;hasAssociatedObjects()) &#123;</span><br><span class="line">        _object_remove_assocations(object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†åŠ é€Ÿç§»é™¤å¯¹è±¡çš„å…³è”å¯¹è±¡çš„é€Ÿåº¦ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡æ ‡è®°ä½ has_assoc æ¥é¿å…ä¸å¿…è¦çš„æ–¹æ³•è°ƒç”¨ï¼Œåœ¨ç¡®è®¤äº†å¯¹è±¡å’Œå…³è”å¯¹è±¡çš„å­˜åœ¨ä¹‹åï¼Œæ‰ä¼šè°ƒç”¨ _object_remove_assocations æ–¹æ³•ç§»é™¤å¯¹è±¡ä¸Šæ‰€æœ‰çš„å…³è”å¯¹è±¡,æ–¹æ³•ä¼šå°†å¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…³è”å¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ª vector ä¸­ï¼Œç„¶åå¯¹æ‰€æœ‰çš„ ObjcAssociation å¯¹è±¡è°ƒç”¨ ReleaseValue() æ–¹æ³•ï¼Œé‡Šæ”¾ä¸å†è¢«éœ€è¦çš„å€¼:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _object_remove_assocations(<span class="keyword">id</span> object) &#123;</span><br><span class="line">    vector&lt; ObjcAssociation,ObjcAllocator&lt;ObjcAssociation&gt; &gt; elements;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        <span class="keyword">if</span> (associations.size() == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">        disguised_ptr_t disguised_object = DISGUISE(object);</span><br><span class="line">        AssociationsHashMap::iterator i = associations.find(disguised_object);</span><br><span class="line">        <span class="keyword">if</span> (i != associations.end()) &#123;</span><br><span class="line">            ObjectAssociationMap *refs = i-&gt;second;</span><br><span class="line">            <span class="keyword">for</span> (ObjectAssociationMap::iterator j = refs-&gt;begin(), end = refs-&gt;end(); j != end; ++j) &#123;</span><br><span class="line">                elements.push_back(j-&gt;second);</span><br><span class="line">            &#125;</span><br><span class="line">            delete refs;</span><br><span class="line">            associations.erase(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    for_each(elements.begin(), elements.end(), ReleaseValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AssociationsManager"><a href="#AssociationsManager" class="headerlink" title="AssociationsManager"></a>AssociationsManager</h3><p>AssociationsManager åœ¨æºä»£ç ä¸­çš„å®šä¹‰æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> AssociationsManager &#123;</span><br><span class="line">    <span class="keyword">static</span> spinlock_t _lock;</span><br><span class="line">    <span class="keyword">static</span> AssociationsHashMap *_map;</span><br><span class="line">public:</span><br><span class="line">    AssociationsManager()   &#123; _lock.lock(); &#125;</span><br><span class="line">    ~AssociationsManager()  &#123; _lock.unlock(); &#125;</span><br><span class="line"></span><br><span class="line">    AssociationsHashMap &amp;associations() &#123;</span><br><span class="line">        <span class="keyword">if</span> (_map == <span class="literal">NULL</span>)</span><br><span class="line">            _map = new AssociationsHashMap();</span><br><span class="line">        <span class="keyword">return</span> *_map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">spinlock_t AssociationsManager::_lock;</span><br><span class="line">AssociationsHashMap *AssociationsManager::_map = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>AssociationsManageré‡Œé¢æ˜¯ç”±ä¸€ä¸ªé™æ€AssociationsHashMapæ¥å­˜å‚¨æ‰€æœ‰çš„å…³è”å¯¹è±¡çš„ã€‚è¿™ç›¸å½“äºæŠŠæ‰€æœ‰å¯¹è±¡çš„å…³è”å¯¹è±¡éƒ½å­˜åœ¨ä¸€ä¸ªå…¨å±€mapé‡Œé¢ã€‚è€Œmapçš„çš„keyæ˜¯è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ï¼ˆä»»æ„ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ä¸€å®šæ˜¯ä¸åŒçš„ï¼‰ï¼Œè€Œè¿™ä¸ªmapçš„valueåˆæ˜¯å¦å¤–ä¸€ä¸ªAssociationsHashMapï¼Œé‡Œé¢ä¿å­˜äº†å…³è”å¯¹è±¡çš„kvå¯¹ã€‚</p>
<p>å®ƒç»´æŠ¤äº† spinlock_t å’Œ <strong>AssociationsHashMap</strong> çš„å•ä¾‹ï¼Œåˆå§‹åŒ–å®ƒçš„æ—¶å€™ä¼šè°ƒç”¨ lock.lock() æ–¹æ³•ï¼Œåœ¨ææ„æ—¶ä¼šè°ƒç”¨ lock.unlock()ï¼Œè€Œ associations æ–¹æ³•ç”¨äºå–å¾—ä¸€ä¸ªå…¨å±€çš„ AssociationsHashMap å•ä¾‹ã€‚<br>ä¹Ÿå°±æ˜¯è¯´ AssociationsManager é€šè¿‡æŒæœ‰ä¸€ä¸ªè‡ªæ—‹é” spinlock_t ä¿è¯å¯¹ AssociationsHashMap çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³æ¯æ¬¡åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹ AssociationsHashMap è¿›è¡Œæ“ä½œã€‚</p>
<h3 id="AssociationsHashMap-ObjectAssociationMap"><a href="#AssociationsHashMap-ObjectAssociationMap" class="headerlink" title="AssociationsHashMap ObjectAssociationMap"></a>AssociationsHashMap ObjectAssociationMap</h3><p>AssociationsHashMap ç”¨ä¸ä¿å­˜ä»å¯¹è±¡çš„ disguised_ptr_t åˆ° <strong>ObjectAssociationMap</strong> çš„æ˜ å°„ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> AssociationsHashMap : public unordered_map&lt;disguised_ptr_t, ObjectAssociationMap *, DisguisedPointerHash, DisguisedPointerEqual, AssociationsHashMapAllocator&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">    <span class="keyword">void</span> *operator new(size_t n) &#123; <span class="keyword">return</span> ::malloc(n); &#125;</span><br><span class="line">    <span class="keyword">void</span> operator delete(<span class="keyword">void</span> *ptr) &#123; ::free(ptr); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ObjectAssociationMap åˆ™ä¿å­˜äº†ä» key åˆ°å…³è”å¯¹è±¡ ObjcAssociation çš„æ˜ å°„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„ä¿å­˜äº†å½“å‰å¯¹è±¡å¯¹åº”çš„æ‰€æœ‰å…³è”å¯¹è±¡:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> ObjectAssociationMap : public std::map&lt;<span class="keyword">void</span> *, ObjcAssociation, ObjectPointerLess, ObjectAssociationMapAllocator&gt; &#123;</span><br><span class="line">public:</span><br><span class="line">   <span class="keyword">void</span> *operator new(size_t n) &#123; <span class="keyword">return</span> ::malloc(n); &#125;</span><br><span class="line">   <span class="keyword">void</span> operator delete(<span class="keyword">void</span> *ptr) &#123; ::free(ptr); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="ObjcAssociation"><a href="#ObjcAssociation" class="headerlink" title="ObjcAssociation"></a>ObjcAssociation</h3><p>ObjcAssociation å°±æ˜¯çœŸæ­£çš„å…³è”å¯¹è±¡çš„ç±»ï¼Œä¸Šé¢çš„æ‰€æœ‰æ•°æ®ç»“æ„åªæ˜¯ä¸ºäº†æ›´å¥½çš„å­˜å‚¨å®ƒã€‚ObjcAssociation åŒ…å«äº† policy ä»¥åŠ valueï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> ObjcAssociation &#123;</span><br><span class="line">    uintptr_t _policy;</span><br><span class="line">    <span class="keyword">id</span> _value;</span><br><span class="line">public:</span><br><span class="line">    ObjcAssociation(uintptr_t policy, <span class="keyword">id</span> value) : _policy(policy), _value(value) &#123;&#125;</span><br><span class="line">    ObjcAssociation() : _policy(<span class="number">0</span>), _value(<span class="literal">nil</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    uintptr_t policy() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _policy; &#125;</span><br><span class="line">    <span class="keyword">id</span> value() <span class="keyword">const</span> &#123; <span class="keyword">return</span> _value; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> hasValue() &#123; <span class="keyword">return</span> _value != <span class="literal">nil</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸ºcategoryæ·»åŠ weakå±æ€§"><a href="#ä¸ºcategoryæ·»åŠ weakå±æ€§" class="headerlink" title="ä¸ºcategoryæ·»åŠ weakå±æ€§"></a>ä¸ºcategoryæ·»åŠ weakå±æ€§</h2><p><code>objc_AssociationPolicy</code>å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªç±»ä¼¼OBJC_ASSOCIATION_WEAK_NONATOMICçš„çš„ä¸œè¥¿ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªå·±åœ¨éœ€è¦çš„æ—¶å€™æ‰‹åŠ¨å°†å±æ€§è®¾ç½®ä¸ºnilã€‚</p>
<p>è¦å®ç° weak ï¼Œè¯´ç™½äº†å°±æ˜¯è¦åšåˆ°ä¸¤ç‚¹ï¼š1ã€å¼•ç”¨è®¡æ•°å™¨ä¸å˜ï¼›2ã€å¯¹è±¡é”€æ¯åè‡ªåŠ¨è®¾ç½®ä¸º nilã€‚è€Œåœ¨ runtime æ‰€æä¾›çš„æšä¸¾ä¸­ï¼ŒOBJC_ASSOCIATION_ASSIGN å°±å·²ç»åšåˆ°äº†ç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ç¬¬äºŒç‚¹å³å¯ã€‚ç¬¬äºŒç‚¹æ˜¯è¦åœ¨å¯¹è±¡é”€æ¯åï¼Œå°† weak å¼•ç”¨è®¾ç½®ä¸º nil ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ•è·è¿™ä¸ªå¯¹è±¡é”€æ¯çš„æ—¶æœºï¼Œæˆ–è€…æ¥æ”¶è¿™ä¸ªå¯¹è±¡é”€æ¯çš„äº‹ä»¶ã€‚åœ¨ ARC ä¸­ï¼Œå¯¹è±¡é”€æ¯æ—¶æœºå…¶å®å°±æ˜¯ dealloc æ–¹æ³•è°ƒç”¨çš„æ—¶æœºï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•é‡Œå°†è¿™ä¸ª weak å¼•ç”¨è®¾ç½®ä¸º nil</p>
<p>ä»¥ä¸‹ä¸ºè§£å†³æ€è·¯ï¼š</p>
<p><img src="/res/runtime/category-weak.png" alt></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^DeallocBlock)();</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">OriginalObject</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) DeallocBlock block;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBlock:(DeallocBlock)block;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="comment">// .m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OriginalObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBlock:(DeallocBlock)block</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">self</span>.block = block;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ¨è¢«é”€æ¯å å‘Šè¯‰å±æ€§åº”è¯¥è®¾ç½®ä¸ºnil</span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.block ? <span class="keyword">self</span>.block() : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>Categoryé‡Œ:</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// NSObject+property.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">property</span>)</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬çš„weakæŒ‡é’ˆ  </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">id</span> objc_weak_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSObject+property.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">property</span>)</span></span><br><span class="line">- (<span class="keyword">id</span>)objc_weak_id </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setObjc_weak_id:(<span class="keyword">id</span>)objc_weak_id </span><br><span class="line">&#123;</span><br><span class="line">    OriginalObject *ob = [[OriginalObject alloc] initWithBlock:^&#123;</span><br><span class="line">      <span class="comment">// è¯¥å°†å±æ€§è®¾ç½®ä¸ºniläº†</span></span><br><span class="line">      objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(objc_weak_id), <span class="literal">nil</span>, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    &#125;];</span><br><span class="line">    objc_setAssociatedObject(objc_weak_id, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> *)(ob.block), ob, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(objc_weak_id), objc_weak_id, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 <!-- [https://draveness.me/ao](https://draveness.me/ao) -->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Runtime å®è·µ</title>
    <url>/essay/Runtime/runtime%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<p>ä»‹ç»</p>
<ul>
<li>dynamicWebkitæ›¿æ¢ã€</li>
<li>åŠ¨æ€æ·»åŠ æ–¹æ³• + åŠ¨æ€äº¤æ¢æ–¹æ³• -&gt; UIButtoné˜²æ­¢å¤šæ¬¡ç‚¹å‡»ã€</li>
<li>éå†å˜é‡ -&gt; éšè—é”®ç›˜ã€</li>
<li>éå†å±æ€§ -&gt; è·å–å±æ€§å</li>
<li>éå†å±æ€§ -&gt; åˆ¤æ–­æ‰€æœ‰å˜é‡æ˜¯å¦å·²ç»å®ä¾‹åŒ–</li>
</ul>
<a id="more"></a>
<h3 id="dynamicWebkit"><a href="#dynamicWebkit" class="headerlink" title="dynamicWebkit"></a>dynamicWebkit</h3><blockquote>
<p>Apple ä» iOS8 å¼€å§‹ï¼Œæ¨å‡ºäº†æ›´æ–°ã€ä¼˜åŒ–æ›´å¥½çš„WKWebkitã€‚è¿™ä¸ªåº“æ˜¯UIWebViewçš„ç»§æ‰¿è€…ï¼Œåœ¨ç›¸åŒçš„æµè§ˆé¡µé¢ä¸‹ï¼ŒWKWebKitæä¾›çš„WKWebViewçš„å†…å­˜å ç”¨ç‡ç”šè‡³å¯ä»¥åªæœ‰UIWebViewçš„1/10ã€‚å¯æƒœçš„æ˜¯ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™ä¸ºäº†ä¿è¯ç”¨æˆ·çš„è¦†ç›–ç‡ï¼Œtarget iOS Versionéƒ½æ˜¯ iOS7ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨UIWebViewæ¥è¾¾åˆ°æ˜¾ç¤ºçš„ç›®çš„ã€‚<br>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•å®ç°æ ¹æ®iOSç‰ˆæœ¬æ¥è¾¾åˆ°åŠ¨æ€åŠ è½½çš„ç›®çš„å‘¢ï¼Ÿ</p>
</blockquote>
<p>å‚è€ƒ <a href="http://www.jianshu.com/p/3f71fb190fbe" target="_blank" rel="noopener">http://www.jianshu.com/p/3f71fb190fbe</a></p>
<p>æ„Ÿè§‰è¿™æ›´å¤šæ˜¯åå‘äºURL routeçš„æ„Ÿè§‰ï¼Œç±»ä¼¼çš„è¿˜æœ‰ï¼š<br><a href="http://www.jianshu.com/p/8b3a9155468d" target="_blank" rel="noopener">http://www.jianshu.com/p/8b3a9155468d</a></p>
<h3 id="åŠ¨æ€æ·»åŠ æ–¹æ³•-åŠ¨æ€äº¤æ¢æ–¹æ³•-gt-UIButtoné˜²æ­¢å¤šæ¬¡ç‚¹å‡»"><a href="#åŠ¨æ€æ·»åŠ æ–¹æ³•-åŠ¨æ€äº¤æ¢æ–¹æ³•-gt-UIButtoné˜²æ­¢å¤šæ¬¡ç‚¹å‡»" class="headerlink" title="åŠ¨æ€æ·»åŠ æ–¹æ³• + åŠ¨æ€äº¤æ¢æ–¹æ³• -&gt; UIButtoné˜²æ­¢å¤šæ¬¡ç‚¹å‡»"></a>åŠ¨æ€æ·»åŠ æ–¹æ³• + åŠ¨æ€äº¤æ¢æ–¹æ³• -&gt; UIButtoné˜²æ­¢å¤šæ¬¡ç‚¹å‡»</h3><blockquote>
<p>æ­¥éª¤ï¼š</p>
</blockquote>
<ul>
<li>æ–°å»ºUIButtonåˆ†ç±»ï¼Œåœ¨loadæ–¹æ³•ä¸­ ä½¿ç”¨è‡ªå®šä¹‰æ–¹æ³•æ›¿æ¢æ‰åŸå…ˆçš„ <code>- (void)sendAction:(SEL)action to:(nullable id)target forEvent:(nullable UIEvent *)event</code>æ–¹æ³•</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    SEL originSEL = <span class="keyword">@selector</span>(sendAction:to:forEvent:);</span><br><span class="line">    SEL mySEL = <span class="keyword">@selector</span>(my_sendAction:to:forEvent:);</span><br><span class="line">    </span><br><span class="line">    Method originM = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], originSEL);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *typeEncodinds = method_getTypeEncoding(originM);</span><br><span class="line">    </span><br><span class="line">    Method newM = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], mySEL);</span><br><span class="line">    IMP newIMP = method_getImplementation(newM);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (class_addMethod([<span class="keyword">self</span> <span class="keyword">class</span>], mySEL, newIMP, typeEncodinds)) &#123;</span><br><span class="line">        class_replaceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], originSEL, newIMP, typeEncodinds);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        method_exchangeImplementations(originM, newM);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å®ç°è‡ªå®šä¹‰æ–¹æ³•ï¼Œåœ¨æŸä¸ªæ—¶é—´é—´éš”ä¹‹å†…ï¼Œä¸å“åº”ç‚¹å‡»</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)my_sendAction:(SEL)action to:(<span class="keyword">id</span>)target forEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¿é™©èµ·è§ï¼Œåˆ¤æ–­ä¸‹Classç±»å‹</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> isKindOfClass:[<span class="built_in">UIButton</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1. æŒ‰é’®ç‚¹å‡»é—´éš”äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">self</span>.clickDurationTime = <span class="keyword">self</span>.clickDurationTime == <span class="number">0</span> ? defaultDuration : <span class="keyword">self</span>.clickDurationTime;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//2. æ˜¯å¦å¿½ç•¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (_isIgnoreEvent) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@" å¿½ç•¥æŒ‰é’®äº‹ä»¶ "</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">self</span>.clickDurationTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"//2.2 ä¸å¿½ç•¥æŒ‰é’®äº‹ä»¶"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// åç»­åœ¨é—´éš”æ—¶é—´å†…ç›´æ¥å¿½ç•¥æŒ‰é’®äº‹ä»¶</span></span><br><span class="line">            _isIgnoreEvent = <span class="literal">YES</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// é—´éš”äº‹ä»¶åï¼Œæ‰§è¡ŒæŒ‰é’®äº‹ä»¶</span></span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="keyword">self</span>.clickDurationTime * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                resetState();</span><br><span class="line">            &#125;);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å‘é€æŒ‰é’®ç‚¹å‡»æ¶ˆæ¯</span></span><br><span class="line">            [<span class="keyword">self</span> my_sendAction:action to:target forEvent:event];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> my_sendAction:action to:target forEvent:event];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éå†å˜é‡-gt-éšè—é”®ç›˜"><a href="#éå†å˜é‡-gt-éšè—é”®ç›˜" class="headerlink" title="éå†å˜é‡ -&gt; éšè—é”®ç›˜"></a>éå†å˜é‡ -&gt; éšè—é”®ç›˜</h3><blockquote>
<p>åœ¨viewcontrollerä¸­æœ‰äº›æ“ä½œéœ€è¦éšè—åŸå…ˆçš„é”®ç›˜</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ‰¾åˆ° obj å®ä¾‹ä¸­çš„ textfield å’Œ textViewï¼Œå¹¶å–æ¶ˆé”®ç›˜</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param obj ï¼ˆnot nilï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="keyword">void</span>)resignTFandTV:(<span class="keyword">id</span>)obj&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    Ivar *vars = class_copyIvarList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">        Ivar var = vars[i];</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line">        <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">id</span> value = [obj valueForKey:key];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">UITextField</span> <span class="keyword">class</span>]] || [value isKindOfClass:[<span class="built_in">UITextView</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            <span class="keyword">if</span>([value canResignFirstResponder])</span><br><span class="line">                [value resignFirstResponder];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éå†å±æ€§-gt-è·å–å±æ€§å"><a href="#éå†å±æ€§-gt-è·å–å±æ€§å" class="headerlink" title="éå†å±æ€§ -&gt; è·å–å±æ€§å"></a>éå†å±æ€§ -&gt; è·å–å±æ€§å</h3><blockquote>
<p>ä¸€äº›ç®€å•çš„model æˆ–è€…è‡ªå®šä¹‰ view ï¼Œå¯ä»¥è·å–å±æ€§åæ¥å®ä¾‹åŒ–å¯¹åº”çš„å±æ€§</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ‰¾åˆ°ç±»å®šä¹‰ ä¸­çš„ å±æ€§åï¼ˆå¦‚ _msStringï¼‰ æ•°ç»„</span></span><br><span class="line"><span class="comment">    ï¼ˆå¦‚ ç”¨æ¥ç”Ÿæˆç±»å‹çš„æˆå‘˜å˜é‡ï¼‰</span></span><br><span class="line"><span class="comment"> *  @param obj    ç±»çš„å®ä¾‹</span></span><br><span class="line"><span class="comment"> *  @param aClass éœ€è¦è·å–çš„ç‰¹å®šçš„ç±»å‹çš„å±æ€§å ï¼ˆè‹¥ä¸ºç©º åˆ™ å¯»æ‰¾æ‰€æœ‰çš„å±æ€§åï¼‰</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @return       å±æ€§åè¿”å›é¡ºåºå’Œobjä¸­å®šä¹‰çš„é¡ºåºä¸€è‡´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSString</span>*&gt;*)getIvarNamesFrom:(<span class="keyword">id</span>)obj specialCls:(Class)aClass&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSString</span>*&gt;* arr = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="number">0</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSString</span>* name = [<span class="keyword">self</span> getProertyIvarName:property];</span><br><span class="line">        <span class="built_in">NSString</span>* type = [<span class="keyword">self</span> getProertyTypeName:property];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(aClass)&#123;</span><br><span class="line">            <span class="keyword">if</span>(type)&#123;</span><br><span class="line">                Class someClass = <span class="built_in">NSClassFromString</span>(type);</span><br><span class="line">                <span class="keyword">if</span>(someClass &amp;&amp; someClass == aClass )&#123;</span><br><span class="line">                    <span class="keyword">if</span>(name) [arr addObject:name];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;<span class="comment">//è‹¥æ²¡æœ‰ç‰¹å®šaclass åˆ™å–æ‰€æœ‰ç±»å‹çš„å€¼</span></span><br><span class="line">            <span class="keyword">if</span>(name) [arr addObject:name];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    free(properties);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç”¨æ³•ï¼š</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> -(void)setupLabels&#123;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> NSMutableArray&lt;NSString*&gt;* labelNames = [LQUtils getIvarNamesFrom:self specialCls:[UILabel class]];</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> for(int i = 0 ; i &lt; labelNames.count; i++)&#123;</span></span><br><span class="line"><span class="comment"> UILabel* tf = [UILabel new];</span></span><br><span class="line"><span class="comment"> tf.font = [UIFont systemFontOfSize:14];</span></span><br><span class="line"><span class="comment"> tf.textColor = [UIColor lightGrayColor];</span></span><br><span class="line"><span class="comment"> tf.textAlignment = NSTextAlignmentLeft;</span></span><br><span class="line"><span class="comment"> [self.contentView addSubview:tf];</span></span><br><span class="line"><span class="comment"> [self setValue:tf forKeyPath:labelNames[i]];</span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> &#125;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ‰¾åˆ° objc_property_t ç»“æ„ä¸­ä¿å­˜çš„ å±æ€§å ï¼› å¦‚ _myString</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param property</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="built_in">NSString</span>*)getProertyIvarName:(objc_property_t)property&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    objc_property_attribute_t *attrbutes = property_copyAttributeList(property, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">        objc_property_attribute_t attribute = attrbutes[j];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = attribute.name;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *value = attribute.value;</span><br><span class="line">        <span class="built_in">NSString</span> *utfName = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">        <span class="built_in">NSString</span> *utfValue = [<span class="built_in">NSString</span> stringWithUTF8String:value];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>([utfName isEqualToString:<span class="string">@"V"</span>])&#123;</span><br><span class="line">            </span><br><span class="line">            utfValue = [utfValue stringByReplacingOccurrencesOfString:<span class="string">@"\""</span> withString:<span class="string">@""</span>];</span><br><span class="line">            utfValue = [utfValue stringByReplacingOccurrencesOfString:<span class="string">@"@"</span> withString:<span class="string">@""</span>];</span><br><span class="line">            <span class="keyword">return</span> utfValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(attrbutes);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æ‰¾åˆ° objc_property_t ç»“æ„ä¸­ä¿å­˜çš„ å±æ€§ç±»å‹å ï¼› å¦‚ NSString</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param property</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="built_in">NSString</span>*)getProertyTypeName:(objc_property_t)property&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    objc_property_attribute_t *attrbutes = property_copyAttributeList(property, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">        objc_property_attribute_t attribute = attrbutes[j];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = attribute.name;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *value = attribute.value;</span><br><span class="line">        <span class="built_in">NSString</span> *utfName = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">        <span class="built_in">NSString</span> *utfValue = [<span class="built_in">NSString</span> stringWithUTF8String:value];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>([utfName isEqualToString:<span class="string">@"T"</span>])&#123;</span><br><span class="line">            </span><br><span class="line">            utfValue = [utfValue stringByReplacingOccurrencesOfString:<span class="string">@"\""</span> withString:<span class="string">@""</span>];</span><br><span class="line">            utfValue = [utfValue stringByReplacingOccurrencesOfString:<span class="string">@"@"</span> withString:<span class="string">@""</span>];</span><br><span class="line">            <span class="keyword">return</span> utfValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    free(attrbutes);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éå†å±æ€§-gt-åˆ¤æ–­æ‰€æœ‰å˜é‡æ˜¯å¦å·²ç»å®ä¾‹åŒ–"><a href="#éå†å±æ€§-gt-åˆ¤æ–­æ‰€æœ‰å˜é‡æ˜¯å¦å·²ç»å®ä¾‹åŒ–" class="headerlink" title="éå†å±æ€§ -&gt; åˆ¤æ–­æ‰€æœ‰å˜é‡æ˜¯å¦å·²ç»å®ä¾‹åŒ–"></a>éå†å±æ€§ -&gt; åˆ¤æ–­æ‰€æœ‰å˜é‡æ˜¯å¦å·²ç»å®ä¾‹åŒ–</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æŸ¥çœ‹ç±»çš„å®ä¾‹ä¸­ æŸäº›ç‰¹å®šç±»å‹çš„ å±æ€§æ˜¯å¦å®ä¾‹åŒ–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @param obj</span></span><br><span class="line"><span class="comment"> *  @param aClass</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="built_in">BOOL</span>)isIvarsVaildOf:(<span class="keyword">id</span>)obj specialCls:(Class)aClass&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span>&lt;<span class="built_in">NSString</span>*&gt;* ivarNames = [<span class="keyword">self</span> getIvarNamesFrom:<span class="keyword">self</span> specialCls:aClass];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span> ; i &lt; ivarNames.count; i++)&#123;</span><br><span class="line">        <span class="built_in">NSString</span>* key = ivarNames[i];</span><br><span class="line">        <span class="keyword">id</span> value = [obj valueForKey:key];</span><br><span class="line">        <span class="keyword">if</span>(!value) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  æŸ¥çœ‹ç±»çš„å®ä¾‹ä¸­æ‰€æœ‰å±æ€§æ˜¯å¦å®ä¾‹åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="built_in">BOOL</span>)isIvarAllVaildOf:(<span class="keyword">id</span>)obj&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> isIvarsVaildOf:obj specialCls:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Runtime ä½¿ç”¨</title>
    <url>/essay/Runtime/runtime%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>ä¸»è¦åŒ…å« å­—å…¸ä¸æ¨¡å‹äº’è½¬ ã€å¯¹è±¡å…³è”ã€éå†å˜é‡ã€éå†æ–¹æ³•ã€éå†åè®®</p>
<a id="more"></a>
<h2 id="å­—å…¸ä¸æ¨¡å‹äº’è½¬">å­—å…¸ä¸æ¨¡å‹äº’è½¬</h2>

<p>å­—å…¸è½¬æ¨¡å‹çš„æ—¶å€™ï¼š</p>
<ol>
<li>æ ¹æ®å­—å…¸çš„ key ç”Ÿæˆ setter æ–¹æ³•.</li>
<li>ä½¿ç”¨ objc_msgSend è°ƒç”¨ setter æ–¹æ³•ä¸º Model çš„å±æ€§èµ‹å€¼ï¼ˆæˆ–è€… KVCï¼‰.</li>
</ol>
<p>æ¨¡å‹è½¬å­—å…¸çš„æ—¶å€™ï¼š</p>
<ol>
<li>è°ƒç”¨ class_copyPropertyList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰å±æ€§.</li>
<li>è°ƒç”¨ property_getName è·å–å±æ€§åç§°.</li>
<li>æ ¹æ®å±æ€§åç§°ç”Ÿæˆ getter æ–¹æ³•.</li>
<li>ä½¿ç”¨ objc_msgSend è°ƒç”¨ getter æ–¹æ³•è·å–å±æ€§å€¼ï¼ˆæˆ–è€… KVCï¼‰. </li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"NSObject+KeyValues.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">KeyValues</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å­—å…¸è½¬æ¨¡å‹</span></span><br><span class="line">+(<span class="keyword">id</span>)objectWithKeyValues:(<span class="built_in">NSDictionary</span> *)aDictionary&#123;</span><br><span class="line">   <span class="keyword">id</span> objc = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">   <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> aDictionary.allKeys) &#123;</span><br><span class="line">       <span class="keyword">id</span> value = aDictionary[key];</span><br><span class="line">       </span><br><span class="line">       <span class="comment">/*åˆ¤æ–­å½“å‰å±æ€§æ˜¯ä¸æ˜¯Model*/</span></span><br><span class="line">       objc_property_t property = class_getProperty(<span class="keyword">self</span>, key.UTF8String);</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">       objc_property_attribute_t *attributeList = property_copyAttributeList(property, &amp;outCount);</span><br><span class="line">       objc_property_attribute_t attribute = attributeList[<span class="number">0</span>];</span><br><span class="line">       <span class="built_in">NSString</span> *typeString = [<span class="built_in">NSString</span> stringWithUTF8String:attribute.value];</span><br><span class="line">       <span class="keyword">if</span> ([typeString isEqualToString:<span class="string">@"@\"TestModel\""</span>]) &#123;</span><br><span class="line">           value = [<span class="keyword">self</span> objectWithKeyValues:value];</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">/**********************/</span></span><br><span class="line">       </span><br><span class="line">       <span class="comment">//ç”Ÿæˆsetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨</span></span><br><span class="line">       <span class="built_in">NSString</span> *methodName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"set%@%@:"</span>,[key substringToIndex:<span class="number">1</span>].uppercaseString,[key substringFromIndex:<span class="number">1</span>]];</span><br><span class="line">       SEL <span class="keyword">setter</span> = sel_registerName(methodName.UTF8String);</span><br><span class="line">       <span class="keyword">if</span> ([objc respondsToSelector:<span class="keyword">setter</span>]) &#123;</span><br><span class="line">           ((<span class="keyword">void</span> (*) (<span class="keyword">id</span>,SEL,<span class="keyword">id</span>)) objc_msgSend) (objc,<span class="keyword">setter</span>,value);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> objc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¨¡å‹è½¬å­—å…¸</span></span><br><span class="line">-(<span class="built_in">NSDictionary</span> *)keyValuesWithObject&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   objc_property_t *propertyList = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="built_in">NSMutableDictionary</span> *dict = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       objc_property_t property = propertyList[i];</span><br><span class="line">       </span><br><span class="line">       <span class="comment">//ç”Ÿæˆgetteræ–¹æ³•ï¼Œå¹¶ç”¨objc_msgSendè°ƒç”¨</span></span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);</span><br><span class="line">       SEL <span class="keyword">getter</span> = sel_registerName(propertyName);</span><br><span class="line">       <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">getter</span>]) &#123;</span><br><span class="line">           <span class="keyword">id</span> value = ((<span class="keyword">id</span> (*) (<span class="keyword">id</span>,SEL)) objc_msgSend) (<span class="keyword">self</span>,<span class="keyword">getter</span>);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">/*åˆ¤æ–­å½“å‰å±æ€§æ˜¯ä¸æ˜¯Model*/</span></span><br><span class="line">           <span class="keyword">if</span> ([value isKindOfClass:[<span class="keyword">self</span> <span class="keyword">class</span>]] &amp;&amp; value) &#123;</span><br><span class="line">               value = [value keyValuesWithObject];</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/**********************/</span></span><br><span class="line">           </span><br><span class="line">           <span class="keyword">if</span> (value) &#123;</span><br><span class="line">               <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:propertyName];</span><br><span class="line">               [dict setObject:value forKey:key];</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> dict;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="å¯¹è±¡å…³è”">å¯¹è±¡å…³è”</h2>

<blockquote>
<p>å¯¹å·²ç»å­˜åœ¨çš„ç±»åœ¨ Category ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§ï¼š</p>
</blockquote>
<ul>
<li>è¦å–å‡ºè¢«å…³è”çš„å¯¹è±¡ä½¿ç”¨ objc_getAssociatedObject æ–¹æ³•å³å¯ï¼Œ</li>
<li>è¦åˆ é™¤ä¸€ä¸ªè¢«å…³è”çš„å¯¹è±¡ï¼Œä½¿ç”¨ objc_setAssociatedObject æ–¹æ³•å°†å¯¹åº”çš„ key è®¾ç½®æˆ nil å³å¯</li>
<li>objc_removeAssociatedObjects æ–¹æ³•å°†ä¼šç§»é™¤æºå¯¹è±¡ä¸­æ‰€æœ‰çš„å…³è”å¯¹è±¡.</li>
</ul>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<p>ä¸ºç±»åˆ«æ·»åŠ chineseNameå±æ€§<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"XiaoMing+MutipleName.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">XiaoMing</span> (<span class="title">MutipleName</span>)</span></span><br><span class="line"><span class="keyword">char</span> cName;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)setChineseName:(<span class="built_in">NSString</span> *) chineseName&#123;</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, &amp;cName, chineseName, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="built_in">NSString</span> *)chineseName&#123;</span><br><span class="line"><span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, &amp;cName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>ä¸¾ä¸ªæ —å­ï¼Œå‡å¦‚æˆ‘ä»¬è¦ç»™ UIButton æ·»åŠ ä¸€ä¸ªç›‘å¬å•å‡»äº‹ä»¶çš„ block å±æ€§ï¼Œæ–°å»º UIButton çš„ Categoryï¼Œå…¶.mæ–‡ä»¶å¦‚ä¸‹ï¼š<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"UIButton+ClickBlock.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> *associatedKey = <span class="string">"associatedKey"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIButton</span> (<span class="title">ClickBlock</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Categoryä¸­çš„å±æ€§ï¼Œåªä¼šç”Ÿæˆsetterå’Œgetteræ–¹æ³•ï¼Œä¸ä¼šç”Ÿæˆæˆå‘˜å˜é‡</span></span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)setClick:(clickBlock)click&#123;</span><br><span class="line">   objc_setAssociatedObject(<span class="keyword">self</span>, associatedKey, click, OBJC_ASSOCIATION_COPY_NONATOMIC);</span><br><span class="line">   [<span class="keyword">self</span> removeTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonClick) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">   <span class="keyword">if</span> (click) &#123;</span><br><span class="line">       [<span class="keyword">self</span> addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonClick) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(clickBlock)click&#123;</span><br><span class="line">   <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, associatedKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)buttonClick&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span>.click) &#123;</span><br><span class="line">       <span class="keyword">self</span>.click();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ç„¶ååœ¨ä»£ç ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ UIButton çš„å±æ€§æ¥ç›‘å¬å•å‡»äº‹ä»¶äº†ï¼š<br><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">UIButton</span> *button = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</span><br><span class="line">button.frame = <span class="keyword">self</span>.view.bounds;</span><br><span class="line">[<span class="keyword">self</span>.view addSubview:button];</span><br><span class="line">button.click = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"buttonClicked"</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h2 id="éå†å˜é‡">éå†å˜é‡</h2>

<ol>
<li>ä½¿ç”¨ class_copyIvarList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.</li>
<li>ä½¿ç”¨ ivar_getName æ–¹æ³•è·å–æˆå‘˜å˜é‡çš„åç§°.</li>
<li>é€šè¿‡ KVC æ¥è¯»å– Model çš„å±æ€§å€¼</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   Ivar *vars = class_copyIvarList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       Ivar var = vars[i];</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *type = ivar_getTypeEncoding(ivar);</span><br><span class="line">       <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// æ³¨æ„kvcçš„ç‰¹æ€§æ˜¯ï¼Œå¦‚æœèƒ½æ‰¾åˆ°keyè¿™ä¸ªå±æ€§çš„setteræ–¹æ³•ï¼Œåˆ™è°ƒç”¨setteræ–¹æ³•</span></span><br><span class="line">       <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°setteræ–¹æ³•ï¼Œåˆ™æŸ¥æ‰¾æˆå‘˜å˜é‡keyæˆ–è€…æˆå‘˜å˜é‡_keyï¼Œå¹¶ä¸”ä¸ºå…¶èµ‹å€¼</span></span><br><span class="line">       <span class="comment">// æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å¦å¤–å¤„ç†æˆå‘˜å˜é‡åç§°çš„â€œ_â€å‰ç¼€</span></span><br><span class="line">       <span class="keyword">id</span> value = [obj valueForKey:key];</span><br><span class="line">       <span class="comment">//å¯¹valueåšç›¸åº”æ“ä½œ</span></span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="è‡ªåŠ¨å½’æ¡£">è‡ªåŠ¨å½’æ¡£</h3>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"TestModel.h"</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TestModel</span></span></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder&#123;</span><br><span class="line">   <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   Ivar *vars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       Ivar var = vars[i];</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line">       <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// æ³¨æ„kvcçš„ç‰¹æ€§æ˜¯ï¼Œå¦‚æœèƒ½æ‰¾åˆ°keyè¿™ä¸ªå±æ€§çš„setteræ–¹æ³•ï¼Œåˆ™è°ƒç”¨setteræ–¹æ³•</span></span><br><span class="line">       <span class="comment">// å¦‚æœæ‰¾ä¸åˆ°setteræ–¹æ³•ï¼Œåˆ™æŸ¥æ‰¾æˆå‘˜å˜é‡keyæˆ–è€…æˆå‘˜å˜é‡_keyï¼Œå¹¶ä¸”ä¸ºå…¶èµ‹å€¼</span></span><br><span class="line">       <span class="comment">// æ‰€ä»¥è¿™é‡Œä¸éœ€è¦å†å¦å¤–å¤„ç†æˆå‘˜å˜é‡åç§°çš„â€œ_â€å‰ç¼€</span></span><br><span class="line">       <span class="keyword">id</span> value = [<span class="keyword">self</span> valueForKey:key];</span><br><span class="line">       [aCoder encodeObject:value forKey:key];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">       <span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">       Ivar *vars = class_copyIvarList([<span class="keyword">self</span> <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">           Ivar var = vars[i];</span><br><span class="line">           <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line">           <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">           <span class="keyword">id</span> value = [aDecoder decodeObjectForKey:key];</span><br><span class="line">           [<span class="keyword">self</span> setValue:value forKey:key];</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="ä¿®æ”¹å˜é‡å€¼">ä¿®æ”¹å˜é‡å€¼</h3>

<ol>
<li>ä½¿ç”¨ class_copyIvarList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.</li>
<li>ä½¿ç”¨ ivar_getName æ–¹æ³•è·å–æˆå‘˜å˜é‡çš„åç§°.</li>
<li>é€šè¿‡ KVC æ¥è¯»å– Model çš„å±æ€§å€¼</li>
<li>ä¿®æ”¹å¯¹åº”çš„å­—æ®µå€¼ object_setIvar(id obj, Ivar ivar, id value) </li>
</ol>
<blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   Ivar *vars = class_copyIvarList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       Ivar var = vars[i];</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *name = ivar_getName(var);</span><br><span class="line">       <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"_shuxingming"</span>]) &#123;</span><br><span class="line">       object_setIvar(<span class="keyword">self</span>, var, <span class="string">@"æ–°çš„å€¼"</span>);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">        </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="éå†å±æ€§">éå†å±æ€§</h2>


<ol>
<li>é€šè¿‡class_copyPropertyListå‡½æ•°æ¥è·å–å±æ€§åˆ—è¡¨ï¼Œå…¶ä¸­å±æ€§åˆ—è¡¨æ˜¯ä½¿ç”¨@propertyå£°æ˜çš„åˆ—è¡¨ï¼Œå¯¹äºç›´æ¥ä½¿ç”¨å£°æ˜ä¸ºæˆå‘˜å˜é‡çš„ï¼Œéƒ½ä¸ä¼šå‡ºç°åœ¨å±æ€§åˆ—è¡¨ä¸­ï¼Œè¿™ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚</li>
<li>æˆ‘ä»¬é€šè¿‡runtimeæä¾›çš„property_getNameå‡½æ•°æ¥è·å–å±æ€§åç§°ã€‚</li>
<li>è‹¥æœ‰è·å–å±æ€§çš„è¯¦ç»†æè¿°ï¼Œå¯é€šè¿‡runtimeæä¾›çš„property_getAttributeså‡½æ•°æ¥è·å–ã€‚</li>
<li>è‹¥æœ‰è·å–å±æ€§ä¸­çš„objc_property_attribute_tåˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡property_copyAttributeListå‡½æ•°æ¥è·å–ã€‚</li>
<li>è‹¥æœ‰è·å–å•ç‹¬çš„objc_property_attribute_tçš„nameæˆ–è€…valueï¼Œç›´æ¥ä½¿ç”¨ç‚¹è¯­æ³•å³å¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">objc_property_t *properties = class_copyPropertyList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">	objc_property_t property = properties[i];</span><br><span class="line">	<span class="comment">//è·å–å±æ€§åç§°</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(property);</span><br><span class="line">	<span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *propertyAttributes = property_getAttributes(property);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"%s  %s"</span>, propertyName, propertyAttributes);</span><br><span class="line">   </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">	objc_property_attribute_t *attrbutes = property_copyAttributeList(property, &amp;count);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; count; ++j) &#123;</span><br><span class="line">	objc_property_attribute_t attribute = attrbutes[j];</span><br><span class="line">     </span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name = attribute.name;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *value = attribute.value;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"name: %s   value: %s"</span>, name, value);</span><br><span class="line">   		&#125;</span><br><span class="line">   </span><br><span class="line">   	free(attrbutes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="éå†æ–¹æ³•">éå†æ–¹æ³•</h2>

<ol>
<li>ä½¿ç”¨ class_copyMethodList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.</li>
<li>ä½¿ç”¨ method_getName æ–¹æ³•è·å–æˆå‘˜å˜é‡çš„åç§°.</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   Method *methods = class_copyMethodList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       Method method = methods[i];</span><br><span class="line"><span class="comment">//è·å–æ–¹æ³•</span></span><br><span class="line">SEL methodSEL = method_getName(method);</span><br><span class="line">       	<span class="keyword">const</span> <span class="keyword">char</span> *name = sel_getName(methodSEL);</span><br><span class="line">       	<span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"><span class="comment">//è·å–æ–¹æ³•çš„å‚æ•°ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">int</span> arguments = method_getNumberOfArguments(method);</span><br><span class="line"><span class="comment">// è·å–æ–¹æ³•çš„å‚æ•°ç±»å‹</span></span><br><span class="line"><span class="keyword">char</span> argName[<span class="number">512</span>] = &#123;&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; arguments; ++j) &#123;</span><br><span class="line">	method_getArgumentType(method, j, argName, <span class="number">512</span>);</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@"ç¬¬%uä¸ªå‚æ•°ç±»å‹ä¸ºï¼š%s"</span>, j, argName);</span><br><span class="line">	memset(argName, <span class="string">'\0'</span>, strlen(argName));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">char</span> returnType[<span class="number">512</span>] = &#123;&#125;;</span><br><span class="line">   	method_getReturnType(method, returnType, <span class="number">512</span>);</span><br><span class="line">   	<span class="built_in">NSLog</span>(<span class="string">@"è¿”å›å€¼ç±»å‹ï¼š%s"</span>, returnType);</span><br><span class="line">   </span><br><span class="line">   	<span class="comment">// type encoding</span></span><br><span class="line">   	<span class="built_in">NSLog</span>(<span class="string">@"TypeEncoding: %s"</span>, method_getTypeEncoding(method));</span><br><span class="line">   	</span><br><span class="line">   &#125;</span><br><span class="line">   free(methods);</span><br></pre></td></tr></table></figure>
<h3 id="åŠ¨æ€äº¤æ¢æ–¹æ³•"><a href="#åŠ¨æ€äº¤æ¢æ–¹æ³•" class="headerlink" title="åŠ¨æ€äº¤æ¢æ–¹æ³•"></a>åŠ¨æ€äº¤æ¢æ–¹æ³•</h3><ol>
<li><code>Method class_getInstanceMethod(Class cls, SEL name)</code> æ‰¾åˆ°æ–¹æ³•å®ä¾‹</li>
<li><code>void method_exchangeImplementations(Method m1, Method m2)</code> äº¤æ¢æ–¹æ³•</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)answer&#123;</span><br><span class="line">Method m1 = class_getInstanceMethod([<span class="keyword">self</span>.xiaoMing <span class="keyword">class</span>], <span class="keyword">@selector</span>(firstSay));</span><br><span class="line">Method m2 = class_getInstanceMethod([<span class="keyword">self</span>.xiaoMing <span class="keyword">class</span>], <span class="keyword">@selector</span>(secondSay));</span><br><span class="line"></span><br><span class="line">method_exchangeImplementations(m1, m2);</span><br><span class="line"><span class="built_in">NSString</span> *secondName = [<span class="keyword">self</span>.xiaoMing firstSay];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.nameTf.text = secondName;</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"XiaoMing:My name is %@"</span>,secondName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Method-Swizzling-åŸç†"><a href="#Method-Swizzling-åŸç†" class="headerlink" title="Method Swizzling åŸç†"></a>Method Swizzling åŸç†</h3><p>å½’æ ¹ç»“åº•ï¼Œéƒ½æ˜¯å·æ¢äº†selectorçš„IMP</p>
<ul>
<li>method_exchangeImplementations æ¥äº¤æ¢2ä¸ªæ–¹æ³•ä¸­çš„IMPï¼Œ</li>
<li>åˆ©ç”¨ class_replaceMethod æ¥ä¿®æ”¹ç±»ï¼Œ</li>
<li>åˆ©ç”¨ method_setImplementation æ¥ç›´æ¥è®¾ç½®æŸä¸ªæ–¹æ³•çš„IMP</li>
</ul>
<h3 id="åŠ¨æ€æ·»åŠ æ–¹æ³•"><a href="#åŠ¨æ€æ·»åŠ æ–¹æ³•" class="headerlink" title="åŠ¨æ€æ·»åŠ æ–¹æ³•"></a>åŠ¨æ€æ·»åŠ æ–¹æ³•</h3><ol>
<li><code>void class_addMethods(Class, struct objc_method_list *)</code>æ·»åŠ å¤šä¸ªæ–¹æ³•</li>
<li><code>BOOL class_addMethod(Class cls, SEL name, IMP imp, const char *types)</code>æ·»åŠ æ–¹æ³•<ul>
<li>(IMP)guessAnswer æ„æ€æ˜¯guessAnswerçš„åœ°å€æŒ‡é’ˆ;</li>
<li>â€œv@:â€ æ„æ€æ˜¯ï¼Œvä»£è¡¨æ— è¿”å›å€¼voidï¼Œå¦‚æœæ˜¯iåˆ™ä»£è¡¨intï¼›@ä»£è¡¨ id sel; : ä»£è¡¨ SEL _cmd;â€œv@:@@â€ æ„æ€æ˜¯ï¼Œä¸¤ä¸ªå‚æ•°çš„æ²¡æœ‰è¿”å›å€¼ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<p>å‡è®¾XiaoMingçš„ä¸­æ²¡æœ‰guessè¿™ä¸ªæ–¹æ³•ï¼Œåæ¥è¢«Runtimeæ·»åŠ ä¸€ä¸ªåå­—å«guessçš„æ–¹æ³•ï¼Œæœ€ç»ˆå†è°ƒç”¨guessæ–¹æ³•åšå‡ºç›¸åº”ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">-(<span class="keyword">void</span>)answer&#123;</span><br><span class="line">class_addMethod([<span class="keyword">self</span>.xiaoMing <span class="keyword">class</span>], <span class="keyword">@selector</span>(guess), (IMP)guessAnswer, <span class="string">"v@:"</span>);</span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.xiaoMing respondsToSelector:<span class="keyword">@selector</span>(guess)]) &#123;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.xiaoMing performSelector:<span class="keyword">@selector</span>(guess)];</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Sorry,I don't know"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">self</span>.cityTf.text = <span class="string">@"GuangTong"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> guessAnswer(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd)&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"He is from GuangTong"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ï¼š</p>
<pre><code>`[self.xiaoMing performSelector:@selector(guess)];`
</code></pre><h2 id="éå†åè®®"><a href="#éå†åè®®" class="headerlink" title="éå†åè®®"></a>éå†åè®®</h2><ol>
<li>ä½¿ç”¨ class_copyProtocolList æ–¹æ³•è·å–å½“å‰ Model çš„æ‰€æœ‰æˆå‘˜å˜é‡.</li>
<li>ä½¿ç”¨ protocol_getName æ–¹æ³•è·å–æˆå‘˜å˜é‡çš„åç§°.</li>
</ol>
<blockquote>
<p>ç¤ºä¾‹ï¼š</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/message.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> outCount = <span class="number">0</span>;</span><br><span class="line">   _<span class="keyword">unsafe_unretained</span> Protocol **protocols = class_copyProtocolList([obj <span class="keyword">class</span>], &amp;outCount);</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outCount; i ++) &#123;</span><br><span class="line">       Protocol *protocol = protocols[i];</span><br><span class="line">       <span class="keyword">const</span> <span class="keyword">char</span> *name = protocol_getName(protocol);</span><br><span class="line">       <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<!-- *    [Runtimeå…¨æ–¹ä½è£…é€¼æŒ‡å—](http://www.jianshu.com/p/efeb33712445)
*    [è°ˆRuntimeæœºåˆ¶å’Œä½¿ç”¨çš„æ•´ä½“åŒ–æ¢³ç†](http://www.jianshu.com/p/8916ad5662a2)
* [runtimeå±æ€§ä¸æˆå‘˜å˜é‡](http://www.henishuo.com/runtime-property-ivar/) -->]]></content>
      <categories>
        <category>é‡å­¦iOS</category>
        <category>Runtime</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Babelå…¥é—¨æ•™ç¨‹</title>
    <url>/quick-start/Babel%E6%95%99%E7%A8%8B/Babel%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>å¤§å®¶éƒ½çŸ¥é“jsååˆ†ä¾èµ–æµè§ˆå™¨ï¼ˆæˆ–Nodeç¯å¢ƒï¼‰ï¼Œä¸åŒæµè§ˆå™¨å¯¹jsçš„æ”¯æŒä¸å°½ç›¸åŒã€‚ç°å¦‚ä»ŠECMAScripæ ‡å‡†çš„æ›´æ–°å·²ç»åˆ°äº†ä¸€å¹´ä¸€æ¬¡çš„èŠ‚å¥ï¼Œ<br>Babel å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ ï¼Œå®ƒå¯ä»¥å°†ä½¿ç”¨æ–°æ ‡å‡†çš„JavaScriptä»£ç è½¬æ¢ä¸ºæµè§ˆå™¨æ”¯æŒå¯ä»¥è¿è¡Œçš„JavsScript(ES5)ä»£ç ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¾‹å¦‚babelå°†è¿™æ®µä»£ç </span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].map(<span class="function"><span class="params">n</span> =&gt;</span> n ** <span class="number">2</span>);</span><br><span class="line"><span class="comment">//è½¬æ¢ä¸ºï¼š</span></span><br><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].map(<span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> n + <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="åœ¨webpackä¸­é…ç½®Babel"><a href="#åœ¨webpackä¸­é…ç½®Babel" class="headerlink" title="åœ¨webpackä¸­é…ç½®Babel"></a>åœ¨webpackä¸­é…ç½®Babel</h2><blockquote>
<p>å‡è®¾åœ¨reacté¡¹ç›®é…ç½®webpack:</p>
</blockquote>
<p><strong>ä¸€ã€å®‰è£…npmåŒ…ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install --save-dev babel-loader babel-core babel-plugin-transform-runtime babel-preset-es2015 babel-preset-react webpack-preset-babel-stage-0</span><br></pre></td></tr></table></figure>
<p><strong>äºŒã€åœ¨webpacké…ç½®æ–‡ä»¶ä¸­æ·»åŠ è§„åˆ™ï¼š</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123; <span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>, <span class="attr">loader</span>: <span class="string">"babel-loader"</span> &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¸‰ã€ åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºåä¸º<code>.babelrc</code>çš„æ–‡ä»¶ï¼Œè¿™æ˜¯Babelçš„é…ç½®æ–‡ä»¶ </strong></p>
<p>åœ¨é…ç½®æ–‡ä»¶ä¸­å®‰è£…æ’ä»¶ï¼ˆpluginsï¼‰æˆ–é¢„è®¾ï¼ˆpresetsï¼Œä¹Ÿå°±æ˜¯ä¸€ç»„æ’ä»¶ï¼‰æ¥æŒ‡ç¤º Babel å»åšä»€ä¹ˆäº‹æƒ…ã€‚åœ¨ä¸‹é¢é…ç½®ä¸­ï¼š</p>
<p><em>babel-preset-es2015</em> æ‰“åŒ…äº† es6 çš„ç‰¹æ€§ï¼›<br><em>babel-preset-stage-0</em> æ‰“åŒ…å¤„äº strawman é˜¶æ®µçš„è¯­æ³•ï¼›<br><em>babel-preset-react</em> æ‰“åŒ…reactå…¨å®¶æ¡¶è¯­æ³•ï¼›</p>
<p>Babel å‡ ä¹å¯ä»¥ç¼–è¯‘æ‰€æœ‰æ—¶æ–°çš„ JavaScript è¯­æ³•ï¼Œä½†å¯¹äº APIs æ¥è¯´å´å¹¶éå¦‚æ­¤ã€‚ä¾‹å¦‚ï¼š Promiseã€Setã€Map ç­‰æ–°å¢å¯¹è±¡ï¼ŒObject.assignã€Object.entriesç­‰é™æ€æ–¹æ³•ï¼Œ<em>babel-plugin-transform-runtime</em>ä¸ºäº†è¾¾æˆä½¿ç”¨è¿™äº›æ–°APIã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//.babelrcå†…å®¹</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"presets"</span>: [<span class="string">"es2015"</span>, <span class="string">"stage-0"</span>, <span class="string">"react"</span>],</span><br><span class="line">	<span class="string">"plugins"</span>: [<span class="string">"transform-runtime"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Babelæ¨¡å—"><a href="#Babelæ¨¡å—" class="headerlink" title="Babelæ¨¡å—"></a>Babelæ¨¡å—</h2><a id="more"></a>
<p>Babel6.0åå°†åŠŸèƒ½åˆ’åˆ†æˆäº†ä¸åŒçš„æ¨¡å—ï¼Œåœ¨ <a href="https://github.com/babel/babel/tree/master/packages" target="_blank" rel="noopener">Babel packages</a> ä»“åº“çœ‹åˆ°babelç°åœ¨æœ‰å“ªäº›æ¨¡å—ï¼š</p>
<p><img src="/res/Babel/babel_1.png" alt></p>
<h3 id="babel-core"><a href="#babel-core" class="headerlink" title="babel-core"></a>babel-core</h3><blockquote>
<p>å‚è€ƒ <a href="https://babeljs.io/docs/en/next/babel-core" target="_blank" rel="noopener">babel-core doc</a></p>
</blockquote>
<p>babel-coreæ˜¯ä½œä¸ºbabelçš„æ ¸å¿ƒå­˜åœ¨ï¼Œbabelçš„æ ¸å¿ƒapiéƒ½åœ¨è¿™ä¸ªæ¨¡å—é‡Œé¢ã€‚babel-coreæŠŠ js ä»£ç åˆ†ææˆ ast ï¼Œæ–¹ä¾¿å„ä¸ªæ’ä»¶åˆ†æè¯­æ³•è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æœ‰äº›æ–°è¯­æ³•åœ¨ä½ç‰ˆæœ¬ js ä¸­æ˜¯ä¸å­˜åœ¨çš„ï¼Œå¦‚ç®­å¤´å‡½æ•°ï¼Œrest å‚æ•°ï¼Œå‡½æ•°é»˜è®¤å€¼ç­‰ï¼Œè¿™ç§è¯­è¨€å±‚é¢çš„ä¸å…¼å®¹åªèƒ½é€šè¿‡å°†ä»£ç è½¬ä¸º astï¼Œåˆ†æå…¶è¯­æ³•åå†è½¬ä¸ºä½ç‰ˆæœ¬ jsã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// npm install babel-core</span></span><br><span class="line"><span class="comment">// var babel = require("babel-core");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç”¨æ³•ï¼š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//babel.transform(code: string, options?: Object, callback: Function)</span></span><br><span class="line"><span class="comment">//å­—ç¬¦ä¸²å½¢å¼çš„ JavaScript ä»£ç å¯ä»¥ç›´æ¥ä½¿ç”¨ babel.transform æ¥ç¼–è¯‘</span></span><br><span class="line">babel.transform(<span class="string">"code();"</span>, options, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  result.code;</span><br><span class="line">  result.map;</span><br><span class="line">  result.ast;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨æ„ ï¼šå¯ä»¥åœ¨optionsä¸­æŒ‡å®š preset å’Œ plugin</span></span><br><span class="line"><span class="comment">//      å†™æ³•ä¸ºï¼š babel.transform(</span></span><br><span class="line"><span class="comment">//                  "code();", </span></span><br><span class="line"><span class="comment">//                  &#123;presets: ["react"],&#125;, </span></span><br><span class="line"><span class="comment">//                  function(err, result)&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//babel.transformFile(filename: string, options?: Object, callback: Function)</span></span><br><span class="line"><span class="comment">//ç¼–è¯‘æ–‡ä»¶</span></span><br><span class="line">babel.transformFile(<span class="string">"filename.js"</span>, options, <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">  result; <span class="comment">// =&gt; &#123; code, map, ast &#125;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//babel.transformFromAst(ast: Object, code?: string, options?: Object, callback: Function): FileNode | null</span></span><br><span class="line"><span class="comment">//å°†astè¿›è¡Œè½¬è¯‘</span></span><br><span class="line"><span class="keyword">const</span> &#123; code, map, ast &#125; = babel.transformFromAst(ast, code, options);</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <a href="https://babeljs.io/docs/en/next/options" target="_blank" rel="noopener">options</a> å¯ä»¥é…ç½®å¤šé¡¹å†…å®¹ï¼ŒåŒ…æ‹¬Pluginå’ŒPreseté…ç½®ï¼ŒSourceMapé…ç½®ç­‰</p>
<h3 id="babel-cli"><a href="#babel-cli" class="headerlink" title="babel-cli"></a>babel-cli</h3><blockquote>
<p>å‚è€ƒ <a href="https://babeljs.io/docs/en/next/babel-cli" target="_blank" rel="noopener">babel-cli doc</a></p>
</blockquote>
<p>Babel çš„ CLI æ˜¯ä¸€ç§åœ¨å‘½ä»¤è¡Œä¸‹ä½¿ç”¨ Babel ç¼–è¯‘æ–‡ä»¶çš„ç®€å•æ–¹æ³•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åŸºæœ¬ä½¿ç”¨ ï¼ˆè¾“å‡ºåˆ°æ§åˆ¶å°ï¼‰</span></span><br><span class="line">npx babel script.js</span><br><span class="line"><span class="comment">//æŒ‡å®šè¾“å‡ºæ–‡ä»¶</span></span><br><span class="line">npx babel script.js --out-file script-compiled.js</span><br></pre></td></tr></table></figure>
<p>å‡è®¾script.jsé•¿å¦‚ä¸‹è¿™æ ·ï¼Œç›´æ¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ babel script.jsï¼Œå‘ç°è¾“å‡ºçš„ä»£ç å¥½åƒæ²¡æœ‰è½¬è¯‘â€¦â€¦</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//script.js</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].map(<span class="function"><span class="params">n</span> =&gt;</span> n ** <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> [a,,b] = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">"Guy Fieri"</span>;</span><br><span class="line"><span class="keyword">var</span> place = <span class="string">"Flavortown"</span>;</span><br><span class="line"><span class="string">`Hello <span class="subst">$&#123;name&#125;</span>, ready for <span class="subst">$&#123;place&#125;</span>?`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> yourTurn = <span class="string">"Type some code in here!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    shorthand,</span><br><span class="line">    method() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"ğŸ˜€"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>).reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å’Œå‰é¢ä¸€æ ·éœ€è¦ é…ç½® presets å’Œ plugins ä¿¡æ¯ã€‚</p>
<p>è¿™æ—¶å€™æœ‰ä¸¤ç§æ–¹å¼ä¸€ç§æ˜¯å’Œä¸Šæ–‡ä¸€æ ·ä½¿ç”¨ .babelrc é…ç½®æ–‡ä»¶</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1. è½¬æ¢ ES2015+ çš„ env preset</span></span><br><span class="line">npm install babel-preset-env --save-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. åˆ›å»ºä¸€ä¸ª .babelrc æ–‡ä»¶å¹¶å¯ç”¨ä¸€äº›æ’ä»¶</span></span><br><span class="line"><span class="comment">//.babelrc æ–‡ä»¶ä¿¡æ¯ï¼š</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"presets"</span>: [<span class="string">"env"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨äº†</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">npx babel script.js</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¾“å‡º å¯ä»¥çœ‹åˆ°ç®­å¤´å‡½æ•°ç­‰ä¸€äº›æ–°è¯­æ³•å·²ç»è¢«è½¬ä¹‰äº†ã€‚</span></span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>].map(<span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.pow(n, <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _ref = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>],</span><br><span class="line">    a = _ref[<span class="number">0</span>],</span><br><span class="line">    b = _ref[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> name = <span class="string">"Guy Fieri"</span>;</span><br><span class="line"><span class="keyword">var</span> place = <span class="string">"Flavortown"</span>;</span><br><span class="line"><span class="string">"Hello "</span> + name + <span class="string">", ready for "</span> + place + <span class="string">"?"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> yourTurn = <span class="string">"Type some code in here!"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  shorthand: shorthand,</span><br><span class="line">  method: <span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ğŸ˜€"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦ä¸€ç§æ–¹å¼æ˜¯ç›´æ¥åœ¨å‘½ä»¤ä¸­æŒ‡å®špresets</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1. è½¬æ¢ ES2015+ çš„ env preset</span></span><br><span class="line">npm install babel-preset-env --save-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.æŒ‡å®špresent </span></span><br><span class="line"><span class="comment">//è¾“å‡ºä¹Ÿå’Œä¸Šæ–‡ä¸€æ ·</span></span><br><span class="line">npx babel script.js --presets=env</span><br></pre></td></tr></table></figure>
<h3 id="babel-runtime-babel-plugin-transform-runtime"><a href="#babel-runtime-babel-plugin-transform-runtime" class="headerlink" title="babel-runtime / babel-plugin-transform-runtime"></a>babel-runtime / babel-plugin-transform-runtime</h3><p>Babel å‡ ä¹å¯ä»¥ç¼–è¯‘æ‰€æœ‰æ—¶æ–°çš„ JavaScript è¯­æ³•ï¼Œä½†å¯¹äº APIs æ¥è¯´å´å¹¶éå¦‚æ­¤ã€‚ä¾‹å¦‚ï¼š Promiseã€Setã€Map ç­‰æ–°å¢å¯¹è±¡ï¼ŒObject.assignã€Object.entriesç­‰é™æ€æ–¹æ³•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸‹åˆ—å«æœ‰ç®­å¤´å‡½æ•°çš„éœ€è¦ç¼–è¯‘çš„ä»£ç ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>).reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨ä¸Šæ–‡ä¸­è½¬ä¹‰ä¸ºï¼š</span></span><br><span class="line"><span class="comment">//ç„¶è€Œè¿™æ®µä»£ç åœ¨æµè§ˆå™¨ä¸­å¯èƒ½æŠ›å‡º Uncaught TypeError: Array.from is not a function</span></span><br><span class="line"><span class="comment">//å®ƒä¾ç„¶æ— æ³•éšå¤„å¯ç”¨å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„ JavaScript ç¯å¢ƒéƒ½æ”¯æŒ Array.from</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.from(<span class="built_in">arguments</span>).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®ç°æ–°çš„APIçš„åŸºç¡€ä¸Šæœ‰ä¸¤ç§æ–¹å¼ï¼š <em>babel-polyfill</em>å’Œ <strong>babel-runtime + babel-plugin-transform-runtime</strong>ã€‚</p>
<p>è¿™ä¸¤è€…è™½ç„¶éƒ½æ˜¯æ¨¡æ‹Ÿ es6 ç¯å¢ƒæ–°å¢APIï¼Œä½†å®ç°æ–¹æ³•å®Œå…¨ä¸åŒã€‚</p>
<ul>
<li><p>babel-polyfill çš„åšæ³•æ˜¯å°†å…¨å±€å¯¹è±¡é€šé€šæ±¡æŸ“ä¸€éï¼Œæ¯”å¦‚æƒ³åœ¨ node 0.10 ä¸Šç”¨ Promiseï¼Œè°ƒç”¨ babel-polyfill å°±ä¼šå¾€ global å¯¹è±¡æŒ‚ä¸Š Promise å¯¹è±¡ã€‚</p>
</li>
<li><p>babel-runtime çš„åšæ³•æ˜¯è‡ªå·±æ‰‹åŠ¨å¼•å…¥ helper å‡½æ•°ï¼Œ const Promise = require(â€˜babel-runtime/core-js/promiseâ€™) å°±å¯ä»¥å¼•å…¥ Promiseã€‚ä¸ºäº†è§£å†³æ‰‹åŠ¨å¼•å…¥Helperå‡½æ•°çš„éº»çƒ¦ï¼Œbabel åˆå¼€å‘äº† babel-plugin-transform-runtimeï¼Œè¿™ä¸ªæ¨¡å—ä¼šå°†æˆ‘ä»¬çš„ä»£ç é‡å†™ï¼Œå¦‚å°† Promise é‡å†™æˆ _Promiseï¼ˆåªæ˜¯æ‰“æ¯”æ–¹ï¼‰ï¼Œç„¶åå¼•å…¥_Promise helper å‡½æ•°ã€‚è¿™æ ·å°±é¿å…äº†é‡å¤æ‰“åŒ…ä»£ç å’Œæ‰‹åŠ¨å¼•å…¥æ¨¡å—çš„ç—›è‹¦ã€‚</p>
</li>
</ul>
<h3 id="babel-standalone-åœ¨æµè§ˆå™¨ç¯å¢ƒ-webå·¥ç¨‹ä¸­è¿è¡Œbabel"><a href="#babel-standalone-åœ¨æµè§ˆå™¨ç¯å¢ƒ-webå·¥ç¨‹ä¸­è¿è¡Œbabel" class="headerlink" title="@babel/standalone åœ¨æµè§ˆå™¨ç¯å¢ƒ/webå·¥ç¨‹ä¸­è¿è¡Œbabel"></a>@babel/standalone åœ¨æµè§ˆå™¨ç¯å¢ƒ/webå·¥ç¨‹ä¸­è¿è¡Œbabel</h3><p>ç”±äº Babel æœ¬èº«çš„è®¾è®¡æ˜¯åŸºäº node.js ç¯å¢ƒä¸‹è¿è¡Œä½¿ç”¨çš„ï¼Œ ä¸Šé¢çš„ä¾‹å­éƒ½æ˜¯åœ¨ Node.jsç¯å¢ƒä¸­è·‘çš„ï¼Œä½†æ˜¯ä½ å¤´é“ ä¸€å®šè¦åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è·‘babelæ€ä¹ˆåŠï¼Ÿ</p>
<p>ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ <code>@babel/standalone</code></p>
<p>å‚è€ƒ <a href="https://github.com/babel/babel/issues/5268" target="_blank" rel="noopener">https://github.com/babel/babel/issues/5268</a> <a href="https://babeljs.io/docs/en/next/babel-standalone.html" target="_blank" rel="noopener">https://babeljs.io/docs/en/next/babel-standalone.html</a></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//npm i @babel/standalone @babel/core @babel/preset-react @babel/preset-env @babel/plugin-transform-runtime</span></span><br><span class="line"><span class="comment">//ä¸ºä»€ä¹ˆå†™æˆè¿™ç§requireæ ·å¼å‘¢â€¦â€¦@babel/standaloneé›†æˆäº†å¾ˆå¤šæ’ä»¶ ä½†æ˜¯å¥½åƒå…¼å®¹æ€§ä¸å¥½â€¦â€¦</span></span><br><span class="line"><span class="keyword">const</span> babelCore = <span class="built_in">require</span>(<span class="string">'@babel/standalone'</span>);</span><br><span class="line"><span class="keyword">let</span> &#123;code&#125; = babelCore.transform(</span><br><span class="line">    <span class="string">'(&#123;item&#125;) =&gt; &lt;Text&gt;&#123;item.key&#125;&lt;/Text&gt;'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'presets'</span>: [<span class="built_in">require</span>(<span class="string">'@babel/preset-react'</span>),<span class="built_in">require</span>(<span class="string">'@babel/preset-env'</span>)],</span><br><span class="line">        <span class="string">'plugins'</span>: [<span class="built_in">require</span>(<span class="string">'@babel/plugin-transform-runtime'</span>)]</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'code:'</span>,code);</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//npm i @babel/standalone </span></span><br><span class="line"><span class="keyword">const</span> babelCore = <span class="built_in">require</span>(<span class="string">'@babel/standalone'</span>);</span><br><span class="line"><span class="keyword">let</span> &#123;code&#125; = babelCore.transform(</span><br><span class="line">    <span class="string">'(&#123;item&#125;) =&gt; &lt;Text&gt;&#123;item.key&#125;&lt;/Text&gt;'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">'presets'</span>: [<span class="string">'react'</span>],</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'code:'</span>,code);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>quick-start</category>
        <category>Babelæ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>å‰ç«¯å·¥ç¨‹åŒ–</tag>
        <tag>Babel</tag>
      </tags>
  </entry>
  <entry>
    <title>Electronå…¥é—¨æ•™ç¨‹</title>
    <url>/quick-start/Electron%E6%95%99%E7%A8%8B/Electron%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p><a href="https://electronjs.org/docs/tutorial/about" target="_blank" rel="noopener">Electron</a>æ˜¯ç”±Githubå¼€å‘ï¼Œç”¨HTMLï¼ŒCSSå’ŒJavaScriptæ¥æ„å»ºè·¨å¹³å°æ¡Œé¢åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªå¼€æºåº“ã€‚ Electroné€šè¿‡å°† <strong>Chromium</strong> å’Œ <strong>Node.js</strong>åˆå¹¶åˆ°åŒä¸€ä¸ªè¿è¡Œæ—¶ç¯å¢ƒä¸­ï¼Œå¹¶å°†å…¶æ‰“åŒ…ä¸ºMacï¼ŒWindowså’ŒLinuxç³»ç»Ÿä¸‹çš„åº”ç”¨æ¥å®ç°è¿™ä¸€ç›®çš„ã€‚</p>
<p>ç›¸ä¿¡å¤§éƒ¨åˆ†å‰ç«¯åŒå­¦éƒ½å¬è¯´æˆ–è€…äº†è§£è¿‡<a href="https://nodejs.org/zh-cn/" target="_blank" rel="noopener">NodeJs</a> å®ƒæ˜¯ä¸€ä¸ªåŸºäº<a href="https://v8.dev/" target="_blank" rel="noopener">Chrome V8 å¼•æ“</a>çš„JavaScriptè¿è¡Œæ—¶ï¼Œ è€Œ <a href="https://www.chromium.org/" target="_blank" rel="noopener">Chromium</a> æ˜¯Googleä¸ºå‘å±•è‡ªå®¶æµè§ˆå™¨Chromeè€Œå¼€å¯çš„å¼€æºæµè§ˆå™¨é¡¹ç›®ï¼Œå¯ä»¥çœ‹æˆæ˜¯æ˜¯Chromeçš„å…ˆè¡Œç‰ˆã€‚å¤§å®¶è¾ƒä¸ºç†Ÿæ‚‰çš„VS Code å’Œ Atomå°±æ˜¯ä½¿ç”¨Electronæ¥å®Œæˆçš„ã€‚</p>
<p>ä»å¼€å‘çš„è§’åº¦æ¥çœ‹, Electron application æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª Node. js åº”ç”¨ç¨‹åºã€‚å¯ä»¥è®©å‰ç«¯å¼€å‘è€…è®©ä½ ä½¿ç”¨çº¯ JavaScript è°ƒç”¨ä¸°å¯Œçš„åŸç”Ÿæ“ä½œç³»ç»ŸAPIsæ¥åˆ›é€ æ¡Œé¢åº”ç”¨~</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><blockquote>
<p>ç¡®è®¤ä½ çš„ç½‘ç»œå¯ä»¥è®¿é—®github , è‹¥è®¿é—®å—é™å‚è€ƒ <a href="https://electronjs.org/docs/tutorial/installation" target="_blank" rel="noopener">å®‰è£…æŒ‡å—</a> æ¥äº†è§£å¦‚ä½•ç”¨ä»£ç†ã€é•œåƒå’Œè‡ªå®šä¹‰ç¼“å­˜</p>
</blockquote>
<p>ä½ è‚¯å®šå·²ç»å·²ç»å®‰è£…å¥½gitå’Œnodeäº†ï¼Œé‚£ä¹ˆåªè¦ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®˜ç½‘å·²ç»æœ‰ electron-quick-start ä»“åº“å…‹éš†ä¸‹æ¥</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/electron/electron-quick-start</span><br><span class="line"><span class="comment"># è¿›å…¥æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="built_in">cd</span> electron-quick-start</span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–åŒ…å¹¶è¿è¡Œ</span></span><br><span class="line">npm install &amp;&amp; npm start</span><br></pre></td></tr></table></figure>
<p>ç„¶åä½ çš„ç¬¬ä¸€ä¸ªæ¡Œé¢åº”ç”¨å°±å¼€å¯äº†ï¼</p>
<p><img src="/res/Electron/Electron_1.png" alt></p>
<p>è‹¥ä½ è·Ÿç€ä¸€èµ·å®è·µåˆ°è¿™é‡Œï¼Œè‚¯å®šä¼šå‘ç°ç•Œé¢æœ‰äº›è®¸ä¸åŒï¼Ÿæˆ‘è¿™é‡Œå¤šäº†ä¸ªè°ƒè¯•ç•Œé¢ï¼Œé‚£ä¹ˆæ¥çœ‹ä¸‹ä»£ç çœ‹çœ‹ã€‚åœ¨Electronä¸­main.jsæ˜¯å…¥å£æ–‡ä»¶ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; app, BrowserWindow &#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Keep a global reference of the window object, if you don't, the window will</span></span><br><span class="line"><span class="comment">// be closed automatically when the JavaScript object is garbage collected.</span></span><br><span class="line"><span class="keyword">let</span> win</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWindow</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºæµè§ˆå™¨çª—å£ã€‚</span></span><br><span class="line">  win = <span class="keyword">new</span> BrowserWindow(&#123; <span class="attr">width</span>: <span class="number">800</span>, <span class="attr">height</span>: <span class="number">600</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç„¶ååŠ è½½åº”ç”¨çš„ index.htmlã€‚å¯¹åº”çš„index.html å°±æ˜¯åˆå§‹ç•Œé¢ã€‚</span></span><br><span class="line">  win.loadFile(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰“å¼€å¼€å‘è€…å·¥å…·</span></span><br><span class="line">  win.webContents.openDevTools()</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å…³äºwin çª—å£çš„ç”Ÿå‘½å‘¨æœŸæˆ‘ä»¬ä¹‹åå†ç ”ç©¶â€¦â€¦</span></span><br><span class="line">  <span class="comment">// å½“ window è¢«å…³é—­ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šè¢«è§¦å‘ã€‚</span></span><br><span class="line">  win.on(<span class="string">'closed'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// å–æ¶ˆå¼•ç”¨ window å¯¹è±¡ï¼Œå¦‚æœä½ çš„åº”ç”¨æ”¯æŒå¤šçª—å£çš„è¯ï¼Œ</span></span><br><span class="line">    <span class="comment">// é€šå¸¸ä¼šæŠŠå¤šä¸ª window å¯¹è±¡å­˜æ”¾åœ¨ä¸€ä¸ªæ•°ç»„é‡Œé¢ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¸æ­¤åŒæ—¶ï¼Œä½ åº”è¯¥åˆ é™¤ç›¸åº”çš„å…ƒç´ ã€‚</span></span><br><span class="line">    win = <span class="literal">null</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å…³äº app ä¸»è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæˆ‘ä»¬ä¹‹åå†ç ”ç©¶â€¦â€¦</span></span><br><span class="line"><span class="comment">// Electron ä¼šåœ¨åˆå§‹åŒ–åå¹¶å‡†å¤‡</span></span><br><span class="line"><span class="comment">// åˆ›å»ºæµè§ˆå™¨çª—å£æ—¶ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">// éƒ¨åˆ† API åœ¨ ready äº‹ä»¶è§¦å‘åæ‰èƒ½ä½¿ç”¨ã€‚</span></span><br><span class="line">app.on(<span class="string">'ready'</span>, createWindow)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å…¨éƒ¨çª—å£å…³é—­æ—¶é€€å‡ºã€‚</span></span><br><span class="line">app.on(<span class="string">'window-all-closed'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// åœ¨ macOS ä¸Šï¼Œé™¤éç”¨æˆ·ç”¨ Cmd + Q ç¡®å®šåœ°é€€å‡ºï¼Œ</span></span><br><span class="line">  <span class="comment">// å¦åˆ™ç»å¤§éƒ¨åˆ†åº”ç”¨åŠå…¶èœå•æ ä¼šä¿æŒæ¿€æ´»ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (process.platform !== <span class="string">'darwin'</span>) &#123;</span><br><span class="line">    app.quit()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'activate'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// åœ¨macOSä¸Šï¼Œå½“å•å‡»dockå›¾æ ‡å¹¶ä¸”æ²¡æœ‰å…¶ä»–çª—å£æ‰“å¼€æ—¶ï¼Œ</span></span><br><span class="line">  <span class="comment">// é€šå¸¸åœ¨åº”ç”¨ç¨‹åºä¸­é‡æ–°åˆ›å»ºä¸€ä¸ªçª—å£ã€‚</span></span><br><span class="line">  <span class="keyword">if</span> (win === <span class="literal">null</span>) &#123;</span><br><span class="line">    createWindow()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ç»­å†™åº”ç”¨å‰©ä¸‹ä¸»è¿›ç¨‹ä»£ç ã€‚</span></span><br><span class="line"><span class="comment">// ä¹Ÿå¯ä»¥æ‹†åˆ†æˆå‡ ä¸ªæ–‡ä»¶ï¼Œç„¶åç”¨ require å¯¼å…¥ã€‚</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¸ç°æœ‰Reactå·¥ç¨‹ç»“åˆ"><a href="#ä¸ç°æœ‰Reactå·¥ç¨‹ç»“åˆ" class="headerlink" title="ä¸ç°æœ‰Reactå·¥ç¨‹ç»“åˆ"></a>ä¸ç°æœ‰Reactå·¥ç¨‹ç»“åˆ</h2><p>è¿«äºä¸ä¼šVue ï¼Œåœ¨è¿™é‡Œä»‹ç»ä¸‹Reactå·¥ç¨‹å¦‚ä½•å’ŒElectronç»“åˆèµ·æ¥ã€‚<br><a id="more"></a><br>å·æ‡’å°±ç›´æ¥ä½¿ç”¨ create-react-app æ¥åˆ›å»ºreactå·¥ç¨‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è‹¥å·²å®‰è£… è¯·å¿½ç•¥</span></span><br><span class="line">npm install -g create-react-app</span><br><span class="line">create-react-app react-electron</span><br><span class="line"><span class="built_in">cd</span> react-electron</span><br><span class="line">npm start</span><br></pre></td></tr></table></figure>
<h3 id="æ·»åŠ -Electron-é…ç½®å¹¶å¯åŠ¨"><a href="#æ·»åŠ -Electron-é…ç½®å¹¶å¯åŠ¨" class="headerlink" title="æ·»åŠ  Electron é…ç½®å¹¶å¯åŠ¨"></a>æ·»åŠ  Electron é…ç½®å¹¶å¯åŠ¨</h3><p><strong>ä¸€ã€</strong> å®‰è£… ElectronåŒ…</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åœ¨ react-electron ç›®å½•ä¸‹å®‰è£… Electron åŒ…</span></span><br><span class="line">npm install -save electron</span><br></pre></td></tr></table></figure>
<p><strong>äºŒã€</strong> æ·»åŠ main.js</p>
<p>åœ¨ react-electron ç›®å½•ä¸‹æ·»åŠ main.js ,ç›´æ¥ä½¿ç”¨ä¸Šé¢ main.jsçš„å†…å®¹ ï¼Œç„¶å</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//win.loadFile('index.html') è¿™ä¸€è¡Œæ›¿æ¢ä¸ºï¼š</span></span><br><span class="line">win.loadFile(<span class="string">'http://localhost:3000/'</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å°†å…¥å£ç•Œé¢æŒ‡å®šåˆ°reactçš„åˆå§‹ç•Œé¢äº†ã€‚</p>
<p><strong>ä¸‰ã€</strong> å¯åŠ¨Electronï¼</p>
<p>ä¿®æ”¹ package.json ,æ·»åŠ  main homepageå­—æ®µï¼Œå¹¶æ·»åŠ electron-startå‘½ä»¤ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">  <span class="string">"main"</span>: <span class="string">"main.js"</span>,</span><br><span class="line">  <span class="string">"homepage"</span>:<span class="string">"."</span>,</span><br><span class="line"></span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"react-scripts start"</span>,</span><br><span class="line">    <span class="string">"build"</span>: <span class="string">"react-scriptsbuild"</span>,</span><br><span class="line">    <span class="string">"test"</span>: <span class="string">"react-scripts test --env=jsdom"</span>,</span><br><span class="line">    <span class="string">"eject"</span>: <span class="string">"react-scripts  eject"</span>,</span><br><span class="line">    <span class="string">"electron"</span>: <span class="string">"electron ."</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ Electronï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨reacté¡¹ç›®</span></span><br><span class="line">npm start</span><br><span class="line"><span class="comment"># å¯åŠ¨electron</span></span><br><span class="line">npm run electron</span><br></pre></td></tr></table></figure>
<p><img src="/res/Electron/Electron_2.png" alt></p>
<p>çœ‹åˆ°ä¸€ç¯‡ <a href="https://flaviocopes.com/react-electron/" target="_blank" rel="noopener">æ–‡ç«  CREATE AN APP WITH ELECTRON AND REACT</a> å†™create-react-appå’ŒElectronç»“åˆçš„ä¸é”™,å¤§å®¶ä¹Ÿå¯ä»¥å‚è€ƒè¿™ä¸ªã€‚</p>
<p><strong>å››ã€åœ¨reactä¸­ä½¿ç”¨electron</strong></p>
<p>ç›´æ¥åœ¨reactä¸­ä½¿ç”¨import electronä¼šäº§ç”Ÿé—®é¢˜ <a href="https://github.com/electron/electron/issues/7300#issuecomment-285885725" target="_blank" rel="noopener">issues/7300</a>ï¼Œå¯ä»¥å†™æˆè¿™ç§å½¢å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const electron = window.require(&apos;electron&apos;);</span><br><span class="line">const fs = electron.remote.require(&apos;fs&apos;);</span><br><span class="line">const ipcRenderer  = electron.ipcRenderer;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹"><a href="#ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹" class="headerlink" title="ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹"></a>ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹</h2><p>Electron ä¸webåº”ç”¨çš„åŒºåˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œåœ¨åŸwebåº”ç”¨çš„åŸºç¡€ä¸Šæ·»åŠ ä¸»çº¿ç¨‹äº¤äº’ä»£ç åï¼Œç”šè‡³å¯ä»¥å°†ä¸€ä¸ªçº¿ä¸Šwebåº”ç”¨è¿…é€Ÿçš„åŒ…è£…æˆä¸ºä¸€ä¸ªå®¢æˆ·ç«¯åº”ç”¨! Electronå¹¶ä¸”å†…é›†æˆäº† Nodejsï¼ŒNodejs åœ¨ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ä¸­éƒ½å¯ä»¥ä½¿ç”¨ï¼Œè¿™ä¸ºæˆ‘ä»¬æä¾›äº†npmæˆåƒä¸Šä¸‡çš„æ¨¡å—ã€‚</p>
<p>æ‰€ä»¥ä¸ªäººæ„Ÿè§‰åº”ç”¨Electronçš„é‡è¦åœ¨äºç†è§£ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ï¼Œå’Œè¿›ç¨‹é—´çš„äº¤äº’ã€‚å…¶ä»–APIå¯ä»¥è‡ªå·±èŠ±ç‚¹æ—¶é—´é˜…è¯»æ–‡æ¡£ã€‚</p>
<p>è¿è¡ŒElectronå…¥å£æ–‡ä»¶çš„è¿›ç¨‹ï¼ˆä¹Ÿå°±æ˜¯ä¸Šæ–‡è¿è¡Œmain.jsçš„è¿›ç¨‹ï¼‰è¢«ç§°ä¸ºä¸»è¿›ç¨‹ï¼Œå®ƒæ§åˆ¶ç€æ•´ä¸ª App çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»æ‰“å¼€åˆ°å…³é—­ã€‚ å®ƒä¹Ÿç®¡ç†ç€ç³»ç»ŸåŸç”Ÿå…ƒç´ æ¯”å¦‚èœå•ï¼Œèœå•æ ï¼ŒDock æ ï¼Œæ‰˜ç›˜ç­‰ã€‚ ä¸»è¿›ç¨‹è´Ÿè´£åˆ›å»º APP çš„æ¯ä¸ªæ¸²æŸ“è¿›ç¨‹ã€‚è€Œä¸”æ•´ä¸ª Node API éƒ½é›†æˆåœ¨é‡Œé¢ï¼›</p>
<p>è€Œåœ¨ä¸»è¿›ç¨‹åˆ›å»ºçš„ä¸€ä¸ªä¸ªwebé¡µé¢ï¼ˆå¯¹åº”ä¸Šæ–‡ä¸­çš„winçª—å£ï¼‰ä¹Ÿéƒ½è¿è¡Œç€è‡ªå·±çš„è¿›ç¨‹ï¼Œå³æ¸²æŸ“è¿›ç¨‹ï¼Œæ¸²æŸ“è¿›ç¨‹å„è‡ªç‹¬ç«‹ï¼Œå„è‡ªæ‹¥æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸ä¸»è¿›ç¨‹ä¸åŒçš„æ˜¯ï¼Œå®ƒèƒ½å¤ŸåŒæ—¶å­˜åœ¨å¤šä¸ªè€Œä¸”è¿è¡Œåœ¨ä¸ä¸€æ ·çš„è¿›ç¨‹ã€‚è€Œä¸”å®ƒä»¬ä¹Ÿèƒ½å¤Ÿè¢«éšè—ã€‚åœ¨é€šå¸¸çš„æµè§ˆå™¨å†…ï¼Œç½‘é¡µé€šå¸¸è¿è¡Œåœ¨ä¸€ä¸ªæ²™ç›’çš„ç¯å¢ƒæŒ¡ä½å¹¶ä¸”ä¸èƒ½å¤Ÿä½¿ç”¨åŸç”Ÿçš„èµ„æºã€‚ ç„¶è€Œ Electron çš„ç”¨æˆ·åœ¨ Node.js çš„ API æ”¯æŒä¸‹å¯ä»¥åœ¨é¡µé¢ä¸­å’Œæ“ä½œç³»ç»Ÿè¿›è¡Œä¸€äº›ä½çº§åˆ«çš„äº¤äº’ã€‚</p>
<h3 id="è¿›ç¨‹é—´é€šä¿¡"><a href="#è¿›ç¨‹é—´é€šä¿¡" class="headerlink" title="è¿›ç¨‹é—´é€šä¿¡"></a>è¿›ç¨‹é—´é€šä¿¡</h3><p>Electronæä¾›äº†å‡ ç§é€šä¿¡æ–¹å¼ï¼š</p>
<h4 id="ä¸€-ä½¿ç”¨ipc-renderer-å’Œ-ipc-main"><a href="#ä¸€-ä½¿ç”¨ipc-renderer-å’Œ-ipc-main" class="headerlink" title="ä¸€ ä½¿ç”¨ipc-renderer å’Œ ipc-main :"></a>ä¸€ ä½¿ç”¨<a href="https://electronjs.org/docs/api/ipc-renderer" target="_blank" rel="noopener">ipc-renderer</a> å’Œ <a href="https://electronjs.org/docs/api/ipc-main" target="_blank" rel="noopener">ipc-main</a> :</h4><p>ipc-renderer å’Œ ipc-main å¼‚æ­¥äº¤äº’ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ï¼š</span></span><br><span class="line"><span class="keyword">const</span> &#123;ipcRenderer&#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"><span class="comment">//å‘é€asynchronous-messageäº‹ä»¶åˆ°ä¸»è¿›ç¨‹</span></span><br><span class="line">ipcRenderer.send(<span class="string">'asynchronous-message'</span>, <span class="string">'ping'</span>)</span><br><span class="line"><span class="comment">//æ¥æ”¶ä¸»è¿›ç¨‹çš„asynchronous-replyé€šçŸ¥</span></span><br><span class="line">ipcRenderer.on(<span class="string">'asynchronous-reply'</span>, (event, arg) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'asynchronous-reply : args:'</span>,arg)</span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Asynchronous message reply: <span class="subst">$&#123;arg&#125;</span>`</span></span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'async-reply'</span>).innerHTML = message</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨ä¸»è¿›ç¨‹ä¸­ï¼š</span></span><br><span class="line"><span class="keyword">const</span> &#123;ipcMain&#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"><span class="comment">//æ¥æ”¶æ¸²æŸ“è¿›ç¨‹çš„asynchronous-messageé€šçŸ¥</span></span><br><span class="line">ipcMain.on(<span class="string">'asynchronous-message'</span>, (event, arg) =&gt; &#123;</span><br><span class="line">  <span class="comment">//å‘é€asynchronous-replyäº‹ä»¶åˆ°æ¸²æŸ“è¿›ç¨‹</span></span><br><span class="line">  event.sender.send(<span class="string">'asynchronous-reply'</span>, &#123;<span class="string">'ping'</span>:<span class="string">'pong'</span>,<span class="string">'num'</span>:<span class="string">'1'</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>ipc-renderer å’Œ ipc-main åŒæ­¥äº¤äº’ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨æ¸²æŸ“è¿›ç¨‹ä¸­ï¼š</span></span><br><span class="line"><span class="keyword">const</span> &#123;ipcRenderer&#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> syncMsgBtn = <span class="built_in">document</span>.getElementById(<span class="string">'sync-msg'</span>)</span><br><span class="line"></span><br><span class="line">syncMsgBtn.addEventListener(<span class="string">'click'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> reply = ipcRenderer.sendSync(<span class="string">'synchronous-message'</span>, <span class="string">'ping'</span>)</span><br><span class="line">  <span class="keyword">const</span> message = <span class="string">`Synchronous message reply: <span class="subst">$&#123;reply&#125;</span>`</span></span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'sync-reply'</span>).innerHTML = message</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//åœ¨ä¸»è¿›ç¨‹ä¸­ï¼š</span></span><br><span class="line"><span class="keyword">const</span> &#123;ipcMain&#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>)</span><br><span class="line"></span><br><span class="line">ipcMain.on(<span class="string">'synchronous-message'</span>, (event, arg) =&gt; &#123;</span><br><span class="line">  event.returnValue = <span class="string">'pong'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="äºŒ-åœ¨æ¸²æŸ“è¿›ç¨‹ä½¿ç”¨remoteæ¨¡å—"><a href="#äºŒ-åœ¨æ¸²æŸ“è¿›ç¨‹ä½¿ç”¨remoteæ¨¡å—" class="headerlink" title="äºŒ åœ¨æ¸²æŸ“è¿›ç¨‹ä½¿ç”¨remoteæ¨¡å—"></a>äºŒ åœ¨æ¸²æŸ“è¿›ç¨‹ä½¿ç”¨remoteæ¨¡å—</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ¸²æŸ“è¿›ç¨‹æ‰“å¼€æç¤ºå¯¹è¯æ¡†</span></span><br><span class="line"><span class="keyword">const</span> &#123;dialog&#125; = <span class="built_in">require</span>(<span class="string">'electron'</span>).remote</span><br><span class="line">dialog.showMessageBox(options, (index) =&gt; &#123;</span><br><span class="line">      ....</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="ä¸‰-åœ¨ä¸»è¿›ç¨‹å‘æ¸²æŸ“è¿›ç¨‹webContentså‘é€æ¶ˆæ¯"><a href="#ä¸‰-åœ¨ä¸»è¿›ç¨‹å‘æ¸²æŸ“è¿›ç¨‹webContentså‘é€æ¶ˆæ¯" class="headerlink" title="ä¸‰ åœ¨ä¸»è¿›ç¨‹å‘æ¸²æŸ“è¿›ç¨‹webContentså‘é€æ¶ˆæ¯"></a>ä¸‰ åœ¨ä¸»è¿›ç¨‹å‘æ¸²æŸ“è¿›ç¨‹webContentså‘é€æ¶ˆæ¯</h4><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">win.webContents.send(<span class="string">'ping'</span>, <span class="string">'whoooooooh!'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="å››-æ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"><a href="#å››-æ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡" class="headerlink" title="å›› æ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"></a>å›› æ¸²æŸ“è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</h4><p>åœ¨ä¸¤ä¸ªç½‘é¡µï¼ˆæ¸²æŸ“è¿›ç¨‹ï¼‰é—´å…±äº«æ•°æ®æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨æµè§ˆå™¨ä¸­å·²ç»å®ç°çš„ HTML5 APIã€‚ å…¶ä¸­æ¯”è¾ƒå¥½çš„æ–¹æ¡ˆæ˜¯ç”¨ Storage APIï¼Œ localStorageï¼ŒsessionStorage æˆ–è€… IndexedDBã€‚</p>
<p>ä½ è¿˜å¯ä»¥ç”¨ Electron å†…çš„ IPC æœºåˆ¶å®ç°ã€‚å°†æ•°æ®å­˜åœ¨ä¸»è¿›ç¨‹çš„æŸä¸ªå…¨å±€å˜é‡ä¸­ï¼Œç„¶ååœ¨å¤šä¸ªæ¸²æŸ“è¿›ç¨‹ä¸­ä½¿ç”¨ remote æ¨¡å—æ¥è®¿é—®å®ƒã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// åœ¨ä¸»è¿›ç¨‹ä¸­</span></span><br><span class="line">global.sharedObject = &#123;</span><br><span class="line">  someProperty: <span class="string">'default value'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åœ¨ç¬¬ä¸€ä¸ªé¡µé¢ä¸­</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">'electron'</span>).remote.getGlobal(<span class="string">'sharedObject'</span>).someProperty = <span class="string">'new value'</span></span><br><span class="line"><span class="comment">// åœ¨ç¬¬äºŒä¸ªé¡µé¢ä¸­</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">require</span>(<span class="string">'electron'</span>).remote.getGlobal(<span class="string">'sharedObject'</span>).someProperty)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>Electronæ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>è·¨å¹³å°å¼€å‘</tag>
        <tag>Electron</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS Appå¯åŠ¨ä¼˜åŒ–</title>
    <url>/essay/ios-business/App%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/</url>
    <content><![CDATA[<h3 id="å¯åŠ¨è¿‡ç¨‹"><a href="#å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å¯åŠ¨è¿‡ç¨‹"></a>å¯åŠ¨è¿‡ç¨‹</h3><p>iOSåº”ç”¨çš„å¯åŠ¨å¯åˆ†ä¸ºpre-mainé˜¶æ®µå’Œmain()é˜¶æ®µï¼Œpre-mainé˜¶æ®µä¸ºmainå‡½æ•°æ‰§è¡Œä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œmainé˜¶æ®µä¸ºmainå‡½æ•°åˆ°é¦–é¡µå±•ç¤ºé˜¶æ®µã€‚å…¶ä¸­ç³»ç»Ÿåšçš„äº‹æƒ…ä¸ºï¼š</p>
<ul>
<li>premain<ul>
<li>åŠ è½½æ‰€æœ‰ä¾èµ–çš„Mach-Oæ–‡ä»¶ï¼ˆé€’å½’è°ƒç”¨Mach-OåŠ è½½çš„æ–¹æ³•ï¼‰</li>
<li>åŠ è½½åŠ¨æ€é“¾æ¥åº“åŠ è½½å™¨dyldï¼ˆdynamic loaderï¼‰</li>
<li>å®šä½å†…éƒ¨ã€å¤–éƒ¨æŒ‡é’ˆå¼•ç”¨ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€å‡½æ•°ç­‰</li>
<li>åŠ è½½ç±»æ‰©å±•ï¼ˆCategoryï¼‰ä¸­çš„æ–¹æ³•</li>
<li>C++é™æ€å¯¹è±¡åŠ è½½ã€è°ƒç”¨ObjCçš„ +load å‡½æ•°</li>
<li>æ‰§è¡Œå£°æ˜ä¸º<strong>attribute</strong>((constructor))çš„Cå‡½æ•°</li>
</ul>
</li>
<li>main<ul>
<li>è°ƒç”¨main()</li>
<li>è°ƒç”¨UIApplicationMain()</li>
<li>è°ƒç”¨applicationWillFinishLaunching</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h3 id="ä¼˜åŒ–æ€è·¯"><a href="#ä¼˜åŒ–æ€è·¯" class="headerlink" title="ä¼˜åŒ–æ€è·¯"></a>ä¼˜åŒ–æ€è·¯</h3><ul>
<li>æœ€å¤šçš„ç”¨æ—¶è¿˜æ˜¯åœ¨imageåŠ è½½å’ŒOCç±»çš„åˆå§‹åŒ–ï¼Œå…±å ç”¨æ€»æ—¶é•¿çš„79.3%ï¼Œç²¾ç®€frameworkçš„å¼•å…¥å’ŒOCç±»æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚ä¼˜åŒ–ç‚¹ï¼š<ul>
<li>å‡å°‘ä¸å¿…è¦çš„frameworkï¼Œå› ä¸ºåŠ¨æ€é“¾æ¥æ¯”è¾ƒè€—æ—¶ | ä¸è¦è‡ªå·±ä½¿ç”¨dlopenæ–¹æ³•ï¼Œè®©ç³»ç»Ÿæ¥å¤„ç†æ¨¡å—åŠ è½½</li>
<li>åˆå¹¶æˆ–è€…åˆ å‡ä¸€äº›OCç±»ï¼Œå…³äºæ¸…ç†é¡¹ç›®ä¸­æ²¡ç”¨åˆ°çš„ç±»ï¼Œä½¿ç”¨å·¥å…·AppCodeä»£ç æ£€æŸ¥åŠŸèƒ½ï¼ŒæŸ¥åˆ°å½“å‰é¡¹ç›®ä¸­æ²¡æœ‰ç”¨åˆ°çš„ç±»å¦‚ä¸‹ï¼š</li>
<li>åˆ å‡ä¸€äº›æ— ç”¨çš„é™æ€å˜é‡ | åˆ å‡æ²¡æœ‰è¢«è°ƒç”¨åˆ°æˆ–è€…å·²ç»åºŸå¼ƒçš„æ–¹æ³•</li>
<li>å°†ä¸å¿…é¡»åœ¨+loadæ–¹æ³•ä¸­åšçš„äº‹æƒ…å»¶è¿Ÿ</li>
</ul>
</li>
<li>å¯¹äºmain()å‡½æ•°è°ƒç”¨ä¹‹å‰æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–çš„ç‚¹æœ‰ï¼š<ul>
<li>ä¸ä½¿ç”¨xibï¼Œç›´æ¥è§†ç”¨ä»£ç åŠ è½½é¦–é¡µè§†å›¾ | é¦–é¡µéª¨æ¶å± é»˜è®¤æ•°æ®</li>
<li>NSUserDefaultså®é™…ä¸Šæ˜¯åœ¨Libraryæ–‡ä»¶å¤¹ä¸‹ä¼šç”Ÿäº§ä¸€ä¸ªplistæ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å¤ªå¤§çš„è¯ä¸€æ¬¡èƒ½è¯»å–åˆ°å†…å­˜ä¸­å¯èƒ½å¾ˆè€—æ—¶ï¼Œè¿™ä¸ªå½±å“éœ€è¦è¯„ä¼°ï¼Œå¦‚æœè€—æ—¶å¾ˆå¤§çš„è¯éœ€è¦æ‹†åˆ†(éœ€è€ƒè™‘è€ç‰ˆæœ¬è¦†ç›–å®‰è£…å…¼å®¹é—®é¢˜)</li>
<li>æ¯æ¬¡ç”¨NSLogæ–¹å¼æ‰“å°ä¼šéšå¼çš„åˆ›å»ºä¸€ä¸ªCalendarï¼Œå› æ­¤éœ€è¦åˆ å‡å¯åŠ¨æ—¶å„ä¸šåŠ¡æ–¹æ‰“çš„logï¼Œæˆ–è€…ä»…ä»…é’ˆå¯¹å†…æµ‹ç‰ˆè¾“å‡ºlog</li>
<li>å¯¹didFinishLaunchingé‡Œçš„å‡½æ•°è€ƒè™‘èƒ½å¦æŒ–æ˜å¯ä»¥å»¶è¿ŸåŠ è½½æˆ–è€…æ‡’åŠ è½½ï¼Œéœ€è¦ä¸å„ä¸ªä¸šåŠ¡æ–¹pmå’Œrdå…±åŒcheck å¯¹äºä¸€äº›å·²ç»ä¸‹çº¿çš„ä¸šåŠ¡ï¼Œåˆ å‡å†—ä½™ä»£ç ã€‚ å¯¹äºä¸€äº›ä¸UIå±•ç¤ºæ— å…³çš„ä¸šåŠ¡ï¼Œå¦‚å¾®åšè®¤è¯è¿‡æœŸæ£€æŸ¥ã€å›¾ç‰‡æœ€å¤§ç¼“å­˜ç©ºé—´è®¾ç½®ç­‰åšå»¶è¿ŸåŠ è½½</li>
</ul>
</li>
</ul>
<h3 id="ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•"><a href="#ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•" class="headerlink" title="ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•"></a>ç»Ÿè®¡å¯åŠ¨æ—¶çš„è€—æ—¶æ–¹æ³•</h3><p>è¿™ä¸€é˜¶æ®µå°±æ˜¯éœ€è¦å¯¹å¯åŠ¨è¿‡ç¨‹çš„ä¸šåŠ¡é€»è¾‘è¿›è¡Œæ¢³ç†ï¼Œç¡®è®¤å“ªäº›æ˜¯å¯ä»¥å»¶è¿ŸåŠ è½½çš„ï¼Œå“ªäº›å¯ä»¥æ”¾åœ¨å­çº¿ç¨‹åŠ è½½ï¼Œä»¥åŠå“ªäº›æ˜¯å¯ä»¥æ‡’åŠ è½½å¤„ç†çš„ã€‚åŒæ—¶å¯¹è€—æ—¶æ¯”è¾ƒä¸¥é‡çš„æ–¹æ³•è¿›è¡Œreviewå¹¶æå‡ºä¼˜åŒ–ç­–ç•¥è¿›è¡Œä¼˜åŒ–ã€‚</p>
<blockquote>
<p>DYLD_PRINT_STATISTICS_DETAILS<br>instrument TimeProfile</p>
</blockquote>
<p>Instrumentsçš„TimeProfileæ¥ç»Ÿè®¡å¯åŠ¨æ—¶çš„ä¸»è¦æ–¹æ³•è€—æ—¶ï¼ŒCall Tree-&gt;Hide System Libraries</p>
<blockquote>
<p>æ‰“å°æ—¶é—´çš„æ–¹å¼æ¥ç»Ÿè®¡å„ä¸ªå‡½æ•°çš„è€—æ—¶</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">double</span> launchTime = <span class="built_in">CFAbsoluteTimeGetCurrent</span>();</span><br><span class="line">[SDWebImageManager sharedManager];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"launchTime = %fç§’"</span>, <span class="built_in">CFAbsoluteTimeGetCurrent</span>() - launchTime);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>+loadæ–¹æ³•ç»Ÿè®¡</p>
</blockquote>
<p>åŒæ ·çš„æˆ‘ä»¬å¯ä»¥é€šè¿‡Instrumentsæ¥ç»Ÿè®¡å¯åŠ¨æ—¶æ‰€æœ‰çš„+loadæ–¹æ³•ï¼Œä»¥åŠ+loadæ–¹æ³•æ‰€ç”¨è€—æ—¶</p>
<h3 id="loadä¼˜åŒ–-ä¸-attribute"><a href="#loadä¼˜åŒ–-ä¸-attribute" class="headerlink" title="+loadä¼˜åŒ– ä¸ attribute"></a>+loadä¼˜åŒ– ä¸ attribute</h3><p>ä½¿ç”¨__attributeä¼˜åŒ–+loadæ–¹æ³• ç”±äºåœ¨æˆ‘ä»¬çš„å·¥ç¨‹ä¸­å­˜åœ¨å¾ˆå¤šçš„+loadæ–¹æ³•ï¼Œè€Œå…¶ä¸­ä¸€å¤§éƒ¨åˆ†ä¸ºcellæ¨¡æ¿æ³¨å†Œçš„+loadæ–¹æ³•(æˆ‘ä»¬çš„æ¯ä¸€ä¸ªcellå¯¹åº”ä¸€ä¸ªæ¨¡æ¿ï¼Œç„¶åè¯¥æ¨¡æ¿å¯¹åº”ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨å¯åŠ¨æ—¶æ‰€æœ‰çš„æ¨¡æ¿æ–¹æ³•éƒ½åœ¨+loadä¸­æ³¨å†Œå¯¹åº”çš„å­—ç¬¦ä¸²å³åœ¨å­—å…¸ä¸­å­˜å‚¨å­—ç¬¦ä¸²å’Œå¯¹åº”çš„cellæ¨¡æ¿ï¼Œç„¶ååŠ¨æ€ä¸‹å‘å±•ç¤ºå¯¹åº”çš„cell)ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç¼–è¯‘å™¨æä¾›äº†æˆ‘ä»¬ä¸€ç§__attribute__((section(&quot;xxxæ®µï¼ŒxxxèŠ‚&quot;)çš„æ–¹å¼è®©æˆ‘ä»¬å°†ä¸€ä¸ªæŒ‡å®šçš„æ•°æ®å‚¨å­˜åˆ°æˆ‘ä»¬éœ€è¦çš„èŠ‚å½“ä¸­ã€‚</span><br><span class="line"></span><br><span class="line">åœ¨BeeHiveæ¡†æ¶ä¸­ï¼š</span><br><span class="line"></span><br><span class="line">```objc</span><br><span class="line">@class BeeHive; char * kShopModule_mod __attribute((used, section(&quot;__DATA,&quot;&quot;BeehiveMods&quot;&quot;&quot;))) = &quot;&quot;&quot;ShopModule&quot;&quot;&quot;;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä½¿ç”¨<strong>attribute</strong>((section(â€œnameâ€)))æ¥æŒ‡æ˜å“ªä¸ªæ®µã€‚æ•°æ®åˆ™ç”¨<strong>attribute</strong>((used))æ¥æ ‡è®°ï¼Œé˜²æ­¢é“¾æ¥å™¨ä¼šä¼˜åŒ–åˆ é™¤æœªè¢«ä½¿ç”¨çš„æ®µã€‚</p>
<p>è¯»å–sectionä¸­çš„å€¼ attribute((constructor))<br>constructor å’Œ +load éƒ½æ˜¯åœ¨ main å‡½æ•°æ‰§è¡Œå‰è°ƒç”¨ï¼Œä½† +load æ¯” constructor æ›´åŠ æ—©ä¸€ä¸¢ä¸¢ï¼Œå› ä¸º dyldï¼ˆåŠ¨æ€é“¾æ¥å™¨ï¼Œç¨‹åºçš„æœ€åˆèµ·ç‚¹ï¼‰åœ¨åŠ è½½ imageï¼ˆå¯ä»¥ç†è§£æˆ Mach-O æ–‡ä»¶ï¼‰æ—¶ä¼šå…ˆé€šçŸ¥ objc runtime å»åŠ è½½å…¶ä¸­æ‰€æœ‰çš„ç±»ï¼Œæ¯åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œå®ƒçš„ +load éšä¹‹è°ƒç”¨ï¼Œå…¨éƒ¨åŠ è½½å®Œæˆåï¼Œdyld æ‰ä¼šè°ƒç”¨è¿™ä¸ª image ä¸­æ‰€æœ‰çš„ constructor æ–¹æ³•ã€‚æ‰€ä»¥ constructor æ˜¯ä¸€ä¸ªå¹²åäº‹çš„ç»ä½³æ—¶æœºï¼š</p>
<ul>
<li>æ‰€æœ‰Classéƒ½å·²ç»åŠ è½½å®Œæˆ</li>
<li>main å‡½æ•°è¿˜æœªæ‰§è¡Œ</li>
<li>æ— éœ€åƒ +load è¿˜å¾—æŒ‚è½½åœ¨ä¸€ä¸ªClassä¸­</li>
</ul>
<p>åœ¨BeeHiveæºç ä¸­æœ‰ä¸‹é¢ä¸€æ®µä»£ç ï¼š</p>
<p><code>_dyld_register_func_for_add_image</code> :è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥æ³¨å†Œå›è°ƒï¼Œå½“dyldé“¾æ¥ç¬¦å·æ—¶ï¼Œè°ƒç”¨æ­¤å›è°ƒå‡½æ•°ã€‚åœ¨dyldåŠ è½½é•œåƒæ—¶ï¼Œä¼šæ‰§è¡Œæ³¨å†Œè¿‡çš„å›è°ƒå‡½æ•°</p>
<p>å¯¹äºæ¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„é•œåƒï¼Œå½“å®ƒè¢«åŠ¨æ€é“¾æ¥æ—¶ï¼Œéƒ½ä¼šæ‰§è¡Œå›è°ƒvoid (func)(const struct mach_header mh, intptr_t vmaddr_slide)ï¼Œä¼ å…¥æ–‡ä»¶çš„mach_headerä»¥åŠä¸€ä¸ªè™šæ‹Ÿå†…å­˜åœ°å€ intptr_tã€‚</p>
<p>é€šè¿‡è°ƒç”¨BHReadConfigurationå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°ä¹‹å‰æ³¨å†Œåˆ°BeehiveModsç‰¹æ®Šæ®µé‡Œé¢çš„å„ä¸ªModuleçš„ç±»åï¼Œè¯¥å‡½æ•°è¿”å›ç±»åå­—ç¬¦ä¸²çš„æ•°ç»„ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="keyword">void</span> initProphet() &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(dyld_callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> dyld_callback(<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mhp, intptr_t vmaddr_slide)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *mods = BHReadConfiguration(BeehiveModSectName, mhp);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *modName <span class="keyword">in</span> mods) &#123;</span><br><span class="line">        Class cls;</span><br><span class="line">        <span class="keyword">if</span> (modName) &#123;</span><br><span class="line">            cls = <span class="built_in">NSClassFromString</span>(modName);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (cls) &#123;</span><br><span class="line">                [[BHModuleManager sharedManager] registerDynamicModule:cls];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt;* BHReadConfiguration(<span class="keyword">char</span> *sectionName,<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mhp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *configs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#ifndef __LP64__</span></span><br><span class="line">    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &amp;size);</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *mhp64 = (<span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *)mhp;</span><br><span class="line">    uintptr_t *memory = (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &amp;size);</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> counter = size/<span class="keyword">sizeof</span>(<span class="keyword">void</span>*);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; counter; ++idx)&#123;</span><br><span class="line">        <span class="keyword">char</span> *string = (<span class="keyword">char</span>*)memory[idx];</span><br><span class="line">        <span class="built_in">NSString</span> *str = [<span class="built_in">NSString</span> stringWithUTF8String:string];</span><br><span class="line">        <span class="keyword">if</span>(!str)<span class="keyword">continue</span>;</span><br><span class="line">        </span><br><span class="line">        BHLog(<span class="string">@"config = %@"</span>, str);</span><br><span class="line">        <span class="keyword">if</span>(str) [configs addObject:str];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> configs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="äºŒè¿›åˆ¶é‡æ’-é™æ€æ’æ¡©"><a href="#äºŒè¿›åˆ¶é‡æ’-é™æ€æ’æ¡©" class="headerlink" title="äºŒè¿›åˆ¶é‡æ’ + é™æ€æ’æ¡©"></a>äºŒè¿›åˆ¶é‡æ’ + é™æ€æ’æ¡©</h3><p>é™æ€æ’æ¡©å®é™…ä¸Šæ˜¯åœ¨ç¼–è¯‘æœŸå°±åœ¨æ¯ä¸€ä¸ªå‡½æ•°å†…éƒ¨äºŒè¿›åˆ¶æºæ•°æ®æ·»åŠ  hook ä»£ç  ( æˆ‘ä»¬æ·»åŠ çš„ __sanitizer_cov_trace_pc_guard å‡½æ•° ) æ¥å®ç°å…¨å±€çš„æ–¹æ³• hook çš„æ•ˆæœ .</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> __sanitizer_cov_trace_pc_guard(uint32_t *guard) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!*guard) <span class="keyword">return</span>;  <span class="comment">// Duplicate the guard check.</span></span><br><span class="line">    <span class="comment">//å®ƒçš„ä½œç”¨å…¶å®å°±æ˜¯å»è¯»å– x30 ä¸­æ‰€å­˜å‚¨çš„è¦è¿”å›æ—¶ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ . æ‰€ä»¥ä»–åç§°å«åš __builtin_return_address . æ¢å¥è¯è¯´ , è¿™ä¸ªåœ°å€å°±æ˜¯æˆ‘å½“å‰è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæ¯•å , è¦è¿”å›åˆ°å“ªé‡Œå» .</span></span><br><span class="line">    <span class="keyword">void</span> *PC = __builtin_return_address(<span class="number">0</span>);</span><br><span class="line">    Dl_info info;</span><br><span class="line">    dladdr(PC, &amp;info);</span><br><span class="line">    </span><br><span class="line">    printf(<span class="string">"fname=%s \nfbase=%p \nsname=%s\nsaddr=%p \n"</span>,info.dli_fname,info.dli_fbase,info.dli_sname,info.dli_saddr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> PcDescr[<span class="number">1024</span>];</span><br><span class="line">    printf(<span class="string">"guard: %p %x PC %s\n"</span>, guard, *guard, PcDescr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>é—®é¢˜ç‚¹</p>
</blockquote>
<ul>
<li>å¤šçº¿ç¨‹é—®é¢˜<ul>
<li>è€ƒè™‘åˆ°è¿™ä¸ªæ–¹æ³•ä¼šæ¥ç‰¹åˆ«å¤šæ¬¡ , ä½¿ç”¨é”ä¼šå½±å“æ€§èƒ½ , è¿™é‡Œä½¿ç”¨è‹¹æœåº•å±‚çš„åŸå­é˜Ÿåˆ— ( åº•å±‚å®é™…ä¸Šæ˜¯ä¸ªæ ˆç»“æ„ , åˆ©ç”¨é˜Ÿåˆ—ç»“æ„ + åŸå­æ€§æ¥ä¿è¯é¡ºåº ) æ¥å®ç°</li>
</ul>
</li>
<li>å¾ªç¯å¼•ç”¨<ul>
<li>Other C Flags ä¿®æ”¹ä¸ºå¦‚ä¸‹ :-fsanitize-coverage=func,trace-pc-guard</li>
</ul>
</li>
<li>swift å·¥ç¨‹ / æ··ç¼–å·¥ç¨‹<pre><code>* Other Swift Flags , æ·»åŠ ä¸¤æ¡é…ç½®å³å¯ : -sanitize-coverage=func -sanitize=undefined
</code></pre></li>
</ul>
<h3 id="å‹ç¼©èµ„æºå›¾ç‰‡"><a href="#å‹ç¼©èµ„æºå›¾ç‰‡" class="headerlink" title="å‹ç¼©èµ„æºå›¾ç‰‡"></a>å‹ç¼©èµ„æºå›¾ç‰‡</h3><p>å‹ç¼©å›¾ç‰‡ä¸ºä»€ä¹ˆèƒ½åŠ å¿«å¯åŠ¨é€Ÿåº¦å‘¢ï¼Ÿå› ä¸ºå¯åŠ¨çš„æ—¶å€™å¤§å¤§å°å°çš„å›¾ç‰‡åŠ è½½ä¸ªåæ¥äºŒåä¸ªæ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå›¾ç‰‡å°äº†ï¼ŒIOæ“ä½œé‡å°±å°äº†ï¼Œå¯åŠ¨å½“ç„¶å°±ä¼šå¿«äº†ã€‚</p>
<p>äº‹å®ä¸Šï¼ŒXcodeåœ¨ç¼–è¯‘Appçš„æ—¶å€™ï¼Œå·²ç»è‡ªåŠ¨æŠŠéœ€è¦æ‰“åŒ…åˆ°Appé‡Œçš„èµ„æºå›¾ç‰‡å‹ç¼©è¿‡ä¸€éäº†ã€‚ç„¶è€ŒXcodeçš„å‹ç¼©ä¼šç›¸å¯¹æ¯”è¾ƒä¿å®ˆã€‚</p>
<p>è§£å†³å„ç§çŸ›ç›¾çš„æ–¹æ³•å°±æ˜¯è¦æ‰¾å‡ºä¸€ç§ç›¸å½“é è°±çš„å‹ç¼©æ–¹æ³•ï¼Œè€Œä¸”æœ€å¥½æ˜¯åŸºæœ¬æ— æŸçš„ï¼Œè€Œä¸”å‹ç¼©ç‡è¿˜è¦ç‰¹åˆ«é«˜ï¼Œè‡³å°‘è¦æ¯”Xcodeè‡ªåŠ¨å‹ç¼©çš„æ•ˆæœè¦æ›´å¥½æ‰æœ‰æ„ä¹‰ã€‚ç»è¿‡å„ç§è¯•éªŒï¼Œæœ€åå‘ç°å”¯ä¸€å¯é çš„å‹ç¼©ç®—æ³•æ˜¯TinyPNG</p>
<h3 id="å›¾ç‰‡é¢„åŠ è½½"><a href="#å›¾ç‰‡é¢„åŠ è½½" class="headerlink" title="å›¾ç‰‡é¢„åŠ è½½"></a>å›¾ç‰‡é¢„åŠ è½½</h3><blockquote>
<p>åœ¨çœ‹ [UIImage imageNamed:] æ–‡æ¡£æ—¶å‘ç°ä¸€å¥è¯<br>In iOS 9 and later, this method is thread safe.</p>
</blockquote>
<p>çœ‹åˆ°å®ƒä¹‹åç«‹åˆ»æƒ³åˆ°ï¼Œèƒ½å¦åœ¨è¿›ç¨‹å¯åŠ¨æ—©æœŸé€šè¿‡å­çº¿ç¨‹é¢„å…ˆåŠ è½½é¦–é¡µå›¾ç‰‡ã€‚ä¸ºä»€ä¹ˆåœ¨æ—©æœŸå‘¢ï¼Ÿé€šè¿‡ Instruments åˆ†æå¯çœ‹åˆ°åœ¨æ”¯ä»˜å®å¯åŠ¨æ—©æœŸï¼ŒCPU å ç”¨æ˜¯ä¸é‚£ä¹ˆæ»¡çš„ï¼Œä¸ºäº†è®©å¯åŠ¨è¿‡ç¨‹ä¸­å……åˆ†åˆ©ç”¨ CPUï¼Œå°±å°½é‡åœ¨æ—©æœŸå¯åŠ¨å­çº¿ç¨‹ã€‚</p>
<blockquote>
<p>é—®é¢˜ä¸è§£å†³</p>
</blockquote>
<p>åœ¨ä¼˜åŒ–ä¹‹åï¼Œä¹Ÿä¼´éšè€Œæ¥ä¸€äº›ä¸ç¨³å®šçš„é—®é¢˜ï¼š</p>
<p>App å¯åŠ¨ä¼šæœ‰å°æ¦‚ç‡çš„ Crashã€‚</p>
<p>æ ¹æ®åˆ†æï¼Œæˆ‘ä»¬å†³å®šæŠŠè¿™æ®µä»£ç ç§»åˆ° AppDelegate çš„ didFinishLaunching ä¸­ï¼Œå¹¶ä¸”å¢åŠ å¼€å…³ã€‚</p>
<p>iPhone7 ä¸éœ€è¦é¢„åŠ è½½</p>
<p>åœ¨ iPhone7 è®¾å¤‡å‡ºæ¥åï¼Œæˆ‘ä»¬å‘ç° iPhone7 çš„å¯åŠ¨æ€§èƒ½åè€Œä¸å¦‚ iPhone6Sã€‚åˆ†æåå‘ç°ï¼Œåœ¨æ€§èƒ½æ›´å¥½çš„ iPhone7 ä¸Šï¼Œç”±äºå¯åŠ¨å¾ˆå¿«ï¼Œå¯¼è‡´å­çº¿ç¨‹çš„ imageNamed ä¸ ä¸»çº¿ç¨‹çš„ imageNamed ç›¸äº’ç©¿æ’è°ƒç”¨ï¼Œè€Œ imageNamed å†…éƒ¨çš„çº¿ç¨‹å®‰å…¨é”çš„ç²’åº¦å¾ˆå°ï¼Œå¯¼è‡´é”çš„æ¶ˆè€—è¿‡å¤§ã€‚</p>
<h3 id="å¯åŠ¨ä»»åŠ¡åˆ†ç±»"><a href="#å¯åŠ¨ä»»åŠ¡åˆ†ç±»" class="headerlink" title="å¯åŠ¨ä»»åŠ¡åˆ†ç±»"></a>å¯åŠ¨ä»»åŠ¡åˆ†ç±»</h3><p>Appå¯åŠ¨ä¸­çš„ä»»åŠ¡å¯ä»¥ç®€å•åˆ†ä¸ºä¸‹é¢å‡ ç±»ï¼š</p>
<ul>
<li>å¿…é¡»æœ€æ—©åœ¨ä¸»çº¿ç¨‹åˆå§‹åŒ–çš„ä»»åŠ¡</li>
<li>å¯ä»¥å­çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡</li>
<li>å¯ä»¥ä¸2ä¸­çš„ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œçš„ä¸»çº¿ç¨‹ä»»åŠ¡</li>
<li>å¯ä»¥åœ¨é¦–é¡µæ˜¾ç¤ºåå­çº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<h3 id="Background-Fetch-ç®€ä»‹"><a href="#Background-Fetch-ç®€ä»‹" class="headerlink" title="Background Fetch ç®€ä»‹"></a>Background Fetch ç®€ä»‹</h3><p>Background Fetch ç±»ä¼¼ä¸€ç§æ™ºèƒ½çš„è½®è¯¢æœºåˆ¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ä½¿ç”¨ä¹ æƒ¯è¿›è¡Œé€‚åº”ï¼Œåœ¨ç”¨æˆ·çœŸæ­£å¯åŠ¨åº”ç”¨ä¹‹å‰ï¼Œè§¦å‘åå°æ›´æ–°ï¼Œæ¥è·å–æ•°æ®å¹¶ä¸”æ›´æ–°é¡µé¢ã€‚</p>
<p>é’ˆå¯¹è¿™æ ·çš„ç­–ç•¥ï¼Œå¤§å®¶å¯èƒ½ä¼šæœ‰ç–‘è™‘ï¼Œè¿™ç§é¢‘ç¹çš„åå°å¯åŠ¨ä¼šä¸ä¼šå¢åŠ è€—ç”µé‡ï¼Ÿ å½“ç„¶ä¸ä¼šï¼Œç³»ç»Ÿä¼šæ ¹æ®è®¾å¤‡çš„ç”µé‡å’Œæ•°æ®ä½¿ç”¨æƒ…å†µæ¥è°ƒç”¨é¢‘ç‡æ§åˆ¶ï¼Œé¿å…åœ¨éæ´»è·ƒæ—¶é—´é¢‘ç¹çš„è·å–æ•°æ®ã€‚è€Œä¸”ï¼Œè¿›ç¨‹å¯åŠ¨ååå­˜æ´»çš„æ—¶é—´å¾ˆçŸ­ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¼šç«‹å³ suspend</p>
<blockquote>
<p>å®è·µ</p>
</blockquote>
<ul>
<li>Info.plist ä¸­ UIBackgroundModes èŠ‚ç‚¹é…ç½® fetch æ•°å€¼</li>
<li>didFinishLaunching æ—¶é…ç½®[[UIApplication sharedApplication] setMinimumBackgroundFetchInterval:UIApplicationBackgroundFetchIntervalMinimum];<br>è¿™ä¸€æ­¥é…ç½®çš„minimum intervalï¼Œå•ä½æ˜¯ç§’ï¼Œåªæ˜¯ç»™ç³»ç»Ÿçš„å»ºè®®ï¼Œç³»ç»Ÿå¹¶ä¸ä¼šæŒ‰ç…§ç»™å®šçš„æ—¶é—´é—´éš”æŒ‰è§„å¾‹çš„å”¤é†’è¿›ç¨‹ã€‚</li>
<li>å®ç°ä¸‹é¢çš„å›è°ƒï¼Œå¹¶è°ƒç”¨ completionHandler- (void)application:(UIApplication *)application performFetchWithCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler</li>
</ul>
<p>ç”±äº Background Fetch æœºåˆ¶æ˜¯ä¸ºäº†è®©Appåœ¨åå°æ‹‰å–å‡†å¤‡æ•°æ®ï¼Œä½†æ”¯ä»˜å®åªæ˜¯ä¸ºäº†å®ç°â€ç§’èµ·â€œã€‚è°ƒç”¨ completionHandler åç³»ç»Ÿå°†æŠŠ App è¿›ç¨‹æŒ‚èµ·ã€‚ä¸”ç³»ç»Ÿå¿…é¡»åœ¨30ç§’å†…è°ƒç”¨ completionHandlerï¼Œå¦åˆ™è¿›ç¨‹å°†è¢«æ€æ­»ã€‚æ­¤å¤–æ ¹æ®æ–‡æ¡£ï¼Œç³»ç»Ÿä¼šæ ¹æ®åå°è°ƒç”¨ completionHandler çš„æ—¶é—´æ¥å†³å®šåå°å”¤èµ·Appçš„é¢‘ç‡ã€‚å› æ­¤ï¼Œè®¤ä¸ºå¯ä»¥â€œä¼ªé€ â€œ1ç§’çš„å»¶è¿Ÿæ—¶é—´ï¼Œå³1ç§’åè°ƒç”¨ completionHandlerã€‚ç±»ä¼¼ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application performFetchWithCompletionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIBackgroundFetchResult</span>))completionHandler&#123;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        completionHandler(<span class="built_in">UIBackgroundFetchResultNewData</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿›ç¨‹å¿«é€ŸæŒ‚èµ·å¯¼è‡´ Sync æˆåŠŸç‡ä¸‹é™<ul>
<li>ç°åº¦æœŸé—´ï¼Œå¼€å‘åŒå­¦å‘ç°åŒæ­¥æœåŠ¡ Sync æˆåŠŸç‡ä¸‹é™å¾ˆå¤šï¼Œæ‰¾æ¥æ‰¾å»å‘ç°åŸå› ï¼šç”±äºè¿›ç¨‹å”¤é†’åï¼Œç½‘ç»œé•¿è¿æ¥çº¿ç¨‹è¢«æ¿€æ´»å¹¶é©¬ä¸Šå»ºç«‹é•¿è¿æ¥ï¼Œè€Œ1ç§’åè°ƒç”¨completionHandlerï¼Œè¿›ç¨‹åˆè¢«æŒ‚èµ·ã€‚æœåŠ¡å™¨ç«¯çš„syncæ¶ˆæ¯åˆ™å‘é€è¶…æ—¶ã€‚</li>
</ul>
</li>
<li>è¿›ç¨‹é¢‘ç¹æŒ‚èµ·ã€å”¤é†’å¯¼è‡´ç½‘ç»œå»ºè¿æ¬¡æ•°å¢åŠ <ul>
<li>ç³»ç»Ÿé¢„æµ‹ç”¨æˆ·ä½¿ç”¨ App çš„æ—¶é—´ï¼Œå¹¶åœ¨ç”¨æˆ·å®ç° App å‰å”¤é†’ Appï¼Œç»™äºˆ App åå°å‡†å¤‡æ•°æ®çš„æœºä¼šã€‚å†åŠ ä¸Šé¢„æµ‹çš„å‡†ç¡®æ€§é—®é¢˜ï¼Œè¿™æ ·è¿›ç¨‹è¢«å”¤é†’çš„æ¬¡æ•°è¿œå¤§äºç”¨æˆ·ä½¿ç”¨çš„æ¬¡æ•°ã€‚è¿›ç¨‹å”¤é†’åï¼Œç½‘ç»œé•¿è¿æ¥ä¼šç«‹å³å»ºç«‹ã€‚å› æ­¤å¯¼è‡´ç½‘ç»œå»ºè¿æ¬¡æ•°å¤§å¢ï¼Œç”šè‡³ç¿»å€ã€‚</li>
</ul>
</li>
<li>ç”±äºè¿›ç¨‹æŒ‚èµ·ï¼Œå¯¼è‡´å®šæ—¶å™¨ã€å»¶è¿Ÿè°ƒç”¨ç­‰æ—¶é—´â€œä¸é¢„æƒ³çš„æ—¶é—´ä¸åŒâ€<ul>
<li>ä¾‹å¦‚ï¼Œä¸€ä¸ªé—´éš”é—´éš”æ—¶é—´ä¸º 60 ç§’çš„å®šæ—¶å™¨ï¼Œç”±äºè¿›ç¨‹æŒ‚èµ·æ—¶é—´è¶…è¿‡ 60 ç§’ï¼Œåˆ™ä¸‹æ¬¡è¿›ç¨‹å”¤é†’æ—¶ä¼šç«‹åˆ»è§¦å‘åˆ°æ—¶ã€‚ï¼ˆå»¶è¿Ÿè°ƒç”¨ dispatch_after ç­‰ç±»ä¼¼ï¼‰ã€‚å¯¹äºè¿›ç¨‹è‡ªèº«æ¥è¯´ï¼Œå¯èƒ½å®šæ—¶å™¨æœ‰ç‚¹ä¸æ­£å¸¸ï¼Œéœ€è¦æ’æŸ¥æ‰€æœ‰çš„å®šæ—¶å™¨é€»è¾‘ï¼Œæ˜¯å¦ä¼šå› ä¸ºæŒ‚èµ·å¯¼è‡´â€œä¸šåŠ¡å±‚é¢çš„å¼‚å¸¸â€ã€‚</li>
</ul>
</li>
<li>è·å–æ—¶é—´æˆ³<ul>
<li>ç”±äºè¿›ç¨‹æŒ‚èµ·ï¼Œå¯¼è‡´å‰åè·å–çš„æ—¶é—´æˆ³é—´éš”å¾ˆå¤§</li>
</ul>
</li>
</ul>
<p>ä¸ºè§£å†³ä»¥ä¸Šé‡åˆ°çš„ã€ä»¥åŠé¢„æµ‹åˆ°çš„é—®é¢˜ï¼Œç»è¿‡è®¨è®ºï¼Œå†³å®šåœ¨ Background Fetch åå°å”¤é†’çš„æ—¶å€™ï¼Œä¸å»ºç«‹é•¿è¿æ¥ã€‚</p>
<blockquote>
<p>è§£å†³</p>
</blockquote>
<ul>
<li>å»¶å 10 ç§’è°ƒç”¨ completionHandlerã€‚<ul>
<li>åå°å”¤é†’å­˜åœ¨ä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä»æ— åˆ°æœ‰ï¼Œè¿›ç¨‹ä»æŒ‚èµ·åˆ°æ¢å¤ã€‚å‰è€…éœ€è¦æœ‰å……è¶³çš„æ—¶é—´å®Œæˆ App çš„åå°å†·å¯åŠ¨è¿‡ç¨‹ï¼Œå› æ­¤å®šä¹‰äº† 10 ç§’çš„æ—¶é—´ã€‚</li>
</ul>
</li>
<li>åå° Background Fetch çš„æ—¶é—´å†…ä¸å»ºç«‹é•¿è¿æ¥ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>iOSå¼€å‘è¿›é˜¶</category>
      </categories>
      <tags>
        <tag>iOS</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonçˆ¬è™«æ•™ç¨‹-ä½¿ç”¨Scrapy</title>
    <url>/quick-start/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B-%E4%BD%BF%E7%94%A8Scrapy/</url>
    <content><![CDATA[<blockquote>
<p>scrapyåŸºç¡€å®ä¾‹ï¼Œçˆ¬å–zhipinç½‘ç«™ä¿¡æ¯</p>
<p>scarpyçš„æ–°å»º + scarpyæ¨¡æ‹Ÿç™»å½• + åœ¨pipelineä¸­å­˜å–ä¿¡æ¯åˆ°sqlite3 +xpathè§£æé¡µé¢</p>
</blockquote>
<ul>
<li>æ–‡æ¡£<ul>
<li><a href="https://docs.scrapy.org/en/latest/index.html" target="_blank" rel="noopener">Scrapy Documentation</a></li>
<li><a href="http://scrapy-chs.readthedocs.io/zh_CN/latest/" target="_blank" rel="noopener">Scrapy 0.25 ä¸­æ–‡ç¿»è¯‘</a></li>
</ul>
</li>
<li>ç¯å¢ƒ python3.5.2 + scrapy1.3</li>
</ul>
<h2 id="scrapyæ–°å»ºå·¥ç¨‹"><a href="#scrapyæ–°å»ºå·¥ç¨‹" class="headerlink" title="scrapyæ–°å»ºå·¥ç¨‹"></a>scrapyæ–°å»ºå·¥ç¨‹</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line">scrapy startproject projectName</span><br></pre></td></tr></table></figure>
<p>å…·ä½“å¯ä»¥æŸ¥çœ‹ <a href="../Pythonçˆ¬è™«æ•™ç¨‹-å…¥é—¨/">python3çˆ¬è™«å­¦ä¹ </a></p>
<p>å‘ç° <strong>parse</strong> æˆ–è€… <strong>start_requests</strong>æ˜¯çˆ¬è™«çš„å…¥å£</p>
<h2 id="è§£æhtml"><a href="#è§£æhtml" class="headerlink" title="è§£æhtml"></a>è§£æhtml</h2><a id="more"></a>
<p>scrapyæ”¯æŒxpath å’Œ css ä¸¤ç§é€‰æ‹©å™¨ã€‚è¿™é‡Œä½¿ç”¨xpathã€‚</p>
<p>æ¯”å¦‚ <a href="https://www.zhipin.com/job_detail/?query=iOS&amp;scity=101210100&amp;source=2" target="_blank" rel="noopener">è¿™ä¸ªé¡µé¢</a> æˆ‘ä»¬è¦è·å–é¡µé¢ä¸Šå¸–å­çš„é“¾æ¥ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse_page</span><span class="params">(self, response)</span>:</span></span><br><span class="line">       print(<span class="string">"\n å¼€å§‹ è§£æç‰ˆé¢ä¸Šçš„å…·ä½“æ‹›è˜å¸–å­çš„é“¾æ¥\n"</span>)</span><br><span class="line"></span><br><span class="line">       selector = scrapy.Selector(response)</span><br><span class="line">       job_list = selector.xpath(<span class="string">"//div[@class='job-list']/ul[1]/li/a"</span>)</span><br><span class="line">       <span class="keyword">for</span> job_list_content <span class="keyword">in</span> job_list:</span><br><span class="line">           url = self.host + job_list_content.xpath(<span class="string">"@href"</span>).extract_first()</span><br><span class="line">           print(<span class="string">"\nå¸–å­ é“¾æ¥æ˜¯:  "</span>+url+<span class="string">"\n"</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±æˆ–è·å–åˆ°å¸–å­çš„é“¾æ¥</p>
<h2 id="é€’å½’"><a href="#é€’å½’" class="headerlink" title="é€’å½’"></a>é€’å½’</h2><p>å¦‚ä½•è§£æå¸–å­é“¾æ¥çš„å†…å®¹ï¼Œå¹¶ä¸”é€’å½’åˆ°ä¸‹ä¸€é¡µå‘¢ï¼Ÿè¿™é‡Œéœ€è¦ä½¿ç”¨yieldï¼š<br><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">yield</span> scrapy.Request(url=url, callback=self.parse_page)</span><br></pre></td></tr></table></figure></p>
<p>scrapyä¼šè‡ªè¡Œè°ƒåº¦ï¼Œå¹¶è®¿é—®è¯¥urlç„¶åæŠŠå†…å®¹æ‹¿å›æ¥</p>
<p>å…·ä½“ä»£ç ï¼š<br><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestZhiPinSpider2</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">"TestZhiPinSpider2"</span></span><br><span class="line">    host = <span class="string">"https://www.zhipin.com"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¿™ä¸ªä¾‹å­ä¸­åªæŒ‡å®šäº†ä¸€ä¸ªé¡µé¢ä½œä¸ºçˆ¬å–çš„èµ·å§‹url</span></span><br><span class="line">    <span class="comment"># å½“ç„¶ä»æ•°æ®åº“æˆ–è€…æ–‡ä»¶æˆ–è€…ä»€ä¹ˆå…¶ä»–åœ°æ–¹è¯»å–èµ·å§‹urlä¹Ÿæ˜¯å¯ä»¥çš„</span></span><br><span class="line">    start_urls = [</span><br><span class="line">        <span class="string">"https://www.zhipin.com/job_detail/?query=iOS&amp;scity=101210100"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># çˆ¬è™«çš„å…¥å£ï¼Œå¯ä»¥åœ¨æ­¤è¿›è¡Œä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œæ¯”å¦‚ä»æŸä¸ªæ–‡ä»¶æˆ–è€…æ•°æ®åº“è¯»å…¥èµ·å§‹url</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">" å¼€å§‹è§£æurl ----------------------------------------------------------------------------------------"</span>)</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> self.start_urls:</span><br><span class="line">            <span class="comment"># æ­¤å¤„å°†èµ·å§‹urlåŠ å…¥scrapyçš„å¾…çˆ¬å–é˜Ÿåˆ—ï¼Œå¹¶æŒ‡å®šè§£æå‡½æ•°</span></span><br><span class="line">            <span class="comment"># scrapyä¼šè‡ªè¡Œè°ƒåº¦ï¼Œå¹¶è®¿é—®è¯¥urlç„¶åæŠŠå†…å®¹æ‹¿å›æ¥</span></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(url=url, callback=self.parse_page)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç‰ˆé¢è§£æå‡½æ•°ï¼Œè§£æä¸€ä¸ªç‰ˆé¢ä¸Šçš„å¸–å­çš„æ ‡é¢˜å’Œåœ°å€</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_page</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        print(<span class="string">"è§£æ  parse_page ----------------------------------------------------------------------------------------"</span>)</span><br><span class="line"></span><br><span class="line">        selector = scrapy.Selector(response)</span><br><span class="line">        job_list = selector.xpath(<span class="string">"//div[@class='job-list']/ul[1]/li/a"</span>)</span><br><span class="line">        <span class="keyword">for</span> job_list_content <span class="keyword">in</span> job_list:</span><br><span class="line">            url = self.host + job_list_content.xpath(<span class="string">"@href"</span>).extract_first()</span><br><span class="line">            print(<span class="string">"å¸–å­ é“¾æ¥æ˜¯:  "</span>+url)</span><br><span class="line">            <span class="comment"># æ­¤å¤„ï¼Œå°†è§£æå‡ºçš„å¸–å­åœ°å€åŠ å…¥å¾…çˆ¬å–é˜Ÿåˆ—ï¼Œå¹¶æŒ‡å®šè§£æå‡½æ•°</span></span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(url=url, callback=self.parse_job_detail)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># åœ¨æ­¤å¤„è§£æç¿»é¡µä¿¡æ¯ï¼Œä»è€Œå®ç°çˆ¬å–ç‰ˆåŒºçš„å¤šä¸ªé¡µé¢</span></span><br><span class="line">        next_page_url = selector.xpath(<span class="string">"//a[@ka='page-next']"</span>).xpath(<span class="string">"@href"</span>).extract_first()</span><br><span class="line">        next_page_class = selector.xpath(<span class="string">"//a[@ka='page-next']"</span>).xpath(<span class="string">"@class"</span>).extract_first()</span><br><span class="line">        <span class="keyword">if</span> next_page_class == <span class="string">"next"</span>:</span><br><span class="line">             next_page_full_url = self.host + next_page_url</span><br><span class="line">             <span class="keyword">yield</span> scrapy.Request(url=next_page_full_url, callback=self.parse_page)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">             print(<span class="string">"æ²¡æœ‰ä¸‹ä¸€é¡µäº†----------------------------------------------------------------------------"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å…·ä½“çš„æ‹›è˜ä¿¡æ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_job_detail</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        selector = scrapy.Selector(response)</span><br><span class="line"></span><br><span class="line">        job_url = response.request.url</span><br><span class="line">        print(<span class="string">" è§£æ å…·ä½“çš„æ‹›è˜ä¿¡æ¯  --------url:"</span>+job_url)</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªçˆ¬è™«ä¼šå°†zhipinç½‘ç«™iOSæ‹›è˜çš„ä¿¡æ¯éƒ½çˆ¬å–ä¸€é</p>
<h2 id="Pipelines"><a href="#Pipelines" class="headerlink" title="Pipelines"></a>Pipelines</h2><p>å¯ä»¥çœ‹åˆ°æ–°å»ºå·¥ç¨‹åä¼šç”Ÿæˆä¸€ä¸ªpipelines.pyçš„æ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†æŠ“å–çš„å†…å®¹ï¼Œå­˜å…¥æ•°æ®åº“ä»€ä¹ˆçš„ã€‚</p>
<h3 id="1-åœ¨items-pyä¸­å®šä¹‰æŠ“å–çš„å†…å®¹"><a href="#1-åœ¨items-pyä¸­å®šä¹‰æŠ“å–çš„å†…å®¹" class="headerlink" title="1.åœ¨items.pyä¸­å®šä¹‰æŠ“å–çš„å†…å®¹"></a>1.åœ¨items.pyä¸­å®šä¹‰æŠ“å–çš„å†…å®¹</h3><p>è¿™é‡Œç®€å•å†™ä¸€ä¸ª</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestJobDetailItem</span><span class="params">(Item)</span>:</span></span><br><span class="line">    url = Field()</span><br></pre></td></tr></table></figure>
<h3 id="2-åœ¨pipelinesä¸­å¤„ç†"><a href="#2-åœ¨pipelinesä¸­å¤„ç†" class="headerlink" title="2.åœ¨pipelinesä¸­å¤„ç†"></a>2.åœ¨pipelinesä¸­å¤„ç†</h3><p>åœ¨pipelines.pyä¸­æ–°å»ºSqlite3Pipelineæ–¹æ³•ï¼ŒåŸæ¥å¯èƒ½æœ‰ä¸ªFilePipelineä¸ç†å®ƒã€‚</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> jobSpider.items <span class="keyword">import</span> JobDetailItem</span><br><span class="line"><span class="keyword">from</span> jobSpider.items <span class="keyword">import</span> TestJobDetailItem</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sqlite3Pipeline</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, sqlite_file, sqlite_base_file, sqlite_ZhiPin_table, sqlite_Test_ZhiPin_table)</span>:</span></span><br><span class="line">        self.sqlite_file = sqlite_file</span><br><span class="line">        self.sqlite_base_file = sqlite_base_file</span><br><span class="line">        self.sqlite_ZhiPin_table = sqlite_ZhiPin_table</span><br><span class="line">        self.sqlite_Test_ZhiPin_table = sqlite_Test_ZhiPin_table</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls(</span><br><span class="line">            sqlite_file = crawler.settings.get(<span class="string">'SQLITE_FILE_PATH'</span>), <span class="comment"># ä» settings.py æå–</span></span><br><span class="line">            sqlite_base_file=crawler.settings.get(<span class="string">'SQLITE_BASE_FILE_PATH'</span>),</span><br><span class="line">            sqlite_ZhiPin_table = crawler.settings.get(<span class="string">'SQLITE_ZHI_PIN_ITEM_TABLE'</span>),</span><br><span class="line">            sqlite_Test_ZhiPin_table=crawler.settings.get(<span class="string">'SQLITE_TEST_ZHI_PIN_ITEM_TABLE'</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        print(<span class="string">"\n è¿æ¥æ•°æ®åº“ \n"</span>)</span><br><span class="line">        self.create_sql_db()</span><br><span class="line">        self.conn = sqlite3.connect(self.sqlite_file)</span><br><span class="line">        self.cur = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span><span class="params">(self, spider)</span>:</span></span><br><span class="line">        print(<span class="string">"\n  å…³é—­æ•°æ®åº“ \n"</span>)</span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span><span class="params">(self, item, spider)</span>:</span></span><br><span class="line">        print(<span class="string">"\n Sqlite3Pipeline process_item\n"</span>)</span><br><span class="line">        <span class="keyword">if</span> isinstance(item, TestJobDetailItem):</span><br><span class="line">            print(<span class="string">" sqlite3 å¤„ç† TestJobDetailItem "</span>)</span><br><span class="line"></span><br><span class="line">            orderedDict = OrderedDict(sorted(item.items(), key=<span class="keyword">lambda</span> t: t[<span class="number">0</span>]))</span><br><span class="line">            keys = list(orderedDict.keys())</span><br><span class="line">            values = list(orderedDict.values())</span><br><span class="line">            insert_sql = <span class="string">"insert into &#123;0&#125;(&#123;1&#125;) values (&#123;2&#125;)"</span>.format(self.sqlite_ZhiPin_table,</span><br><span class="line">                                                                <span class="string">', '</span>.join(keys),</span><br><span class="line">                                                                <span class="string">', '</span>.join([<span class="string">'?'</span>] * len(keys)))</span><br><span class="line"></span><br><span class="line">            self.cur.execute(insert_sql, values)</span><br><span class="line">            self.conn.commit()</span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">" item ç±»å‹ä¸å¯¹ sqlite3ä¸å¤„ç†"</span>)</span><br><span class="line">            <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_sql_db</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment">#å¤åˆ¶åŸå§‹æ•°æ®åº“ï¼Œï¼ˆä¹Ÿå¯ä»¥ç›´æ¥æ–°å»ºä¸€ä¸ªï¼Œåªä¸è¿‡æ‡’å¾—å†™SQLâ€¦â€¦</span></span><br><span class="line">        sql_db_path = os.path.abspath(self.sqlite_file)</span><br><span class="line">        sql_base_db_path = os.path.abspath(self.sqlite_base_file)</span><br><span class="line">        print(<span class="string">"\n create_sql_db  \n  "</span>, sql_db_path, sql_base_db_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(sql_db_path):</span><br><span class="line">            shutil.copyfile(sql_base_db_path, sql_db_path)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¾‹å­è¯¦ç»†å†™äº†å°†æŠ“å–æ•°æ®å†™å…¥æ•°æ®åº“ï¼Œè¿™é‡Œç”¨çš„æ˜¯sqlite3ã€‚å¯ä»¥æ¢æˆæ–‡ä»¶csvï¼Œmysqlä»€ä¹ˆçš„ã€‚</p>
<h3 id="3-åœ¨Settingä¸­é…ç½®ä¸€ä¸‹"><a href="#3-åœ¨Settingä¸­é…ç½®ä¸€ä¸‹" class="headerlink" title="3.åœ¨Settingä¸­é…ç½®ä¸€ä¸‹"></a>3.åœ¨Settingä¸­é…ç½®ä¸€ä¸‹</h3><p>æ‰¾åˆ°settings.py å†™å…¥ï¼š<br><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#æ•°æ®åº“ä¿¡æ¯</span></span><br><span class="line">SQLITE_FILE_PATH = <span class="string">'/Users/sts/Desktop/github/pythonWorkSapce/jobSpider/jobSpider/sqlite/Item_use.sqlite'</span></span><br><span class="line">SQLITE_BASE_FILE_PATH = <span class="string">'/Users/sts/Desktop/github/pythonWorkSapce/jobSpider/jobSpider/sqlite/Item_base.sqlite'</span></span><br><span class="line">SQLITE_ZHI_PIN_ITEM_TABLE = <span class="string">'ZhiPinJobDetail'</span></span><br><span class="line">SQLITE_TEST_ZHI_PIN_ITEM_TABLE = <span class="string">'TestZhiPin'</span></span><br></pre></td></tr></table></figure></p>
<p>å’Œ<br><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é…ç½®pipeline</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">'jobSpider.pipelines.Sqlite3Pipeline'</span>: <span class="number">400</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡Œå¯ä»¥é…ç½®å¤šä¸ªpipelineï¼Œåé¢çš„æ•°å­—è¡¨ç¤ºä¼˜å…ˆçº§ã€‚scrapyä¼šæ ¹æ®ä¼˜å…ˆçº§ï¼ŒæŠŠitemä¾æ¬¡äº¤ç»™å„ä¸ªpipelineæ¥å¤„ç†ã€‚</p>
<h3 id="4-åœ¨çˆ¬è™«ä¸­è°ƒç”¨è¿™ä¸ªpipeline"><a href="#4-åœ¨çˆ¬è™«ä¸­è°ƒç”¨è¿™ä¸ªpipeline" class="headerlink" title="4.åœ¨çˆ¬è™«ä¸­è°ƒç”¨è¿™ä¸ªpipeline"></a>4.åœ¨çˆ¬è™«ä¸­è°ƒç”¨è¿™ä¸ªpipeline</h3><p>åœ¨ä¸Šé¢é€’å½’ä¾‹å­ä¸­ï¼ŒåŠ å…¥ yield item</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> jobSpider.items <span class="keyword">import</span> JobDetailItem</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    <span class="comment">#å…·ä½“çš„æ‹›è˜ä¿¡æ¯</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_job_detail</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        selector = scrapy.Selector(response)</span><br><span class="line"></span><br><span class="line">        job_url = response.request.url</span><br><span class="line">        print(<span class="string">" è§£æ å…·ä½“çš„æ‹›è˜ä¿¡æ¯  --------url:"</span>+job_url)  </span><br><span class="line">        item = TestJobDetailItem()      </span><br><span class="line">        item[<span class="string">"url"</span>] = job_url</span><br><span class="line">        <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>
<p>scrapyä¼šæŠŠè¿™ä¸ªitemäº¤ç»™æˆ‘ä»¬åˆšåˆšå†™çš„FilePipelineæ¥å¤„ç†.</p>
<h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><blockquote>
<p>å¾ˆå¤šçˆ¬è™«ä¿¡æ¯éƒ½è¦ç™»å½•åæ‰èƒ½æŠ“å–ï¼Œè¿™é‡Œä¹Ÿå°†ç™»å½•æ¨¡æ‹Ÿä¸€éï¼Œè¿˜æ˜¯ç”¨ zhipin ç½‘ç«™ã€‚<br>ä½¿ç”¨zhipinç½‘ç«™çš„è´¦å·å¯†ç ç™»é™†æ¨¡å¼</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"> <span class="comment"># æµ‹è¯•ç™»å½•</span></span><br><span class="line">   login_url = <span class="string">"https://www.zhipin.com/user/login.html?ka=header-login"</span></span><br><span class="line">   login_post_url = <span class="string">"https://www.zhipin.com/login/account.json"</span></span><br><span class="line">   host = <span class="string">"https://www.zhipin.com"</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">yield</span> scrapy.Request(url=self.login_url,</span><br><span class="line">                            meta=&#123;<span class="string">'cookiejar'</span>: <span class="number">1</span>&#125;,</span><br><span class="line">                            callback=self.request_captcha)</span><br><span class="line"></span><br><span class="line">   <span class="comment">#è·å–éªŒè¯ç  è¿™é‡Œç®€å•ä½¿ç”¨æ‰‹åŠ¨è¾“éªŒè¯ç </span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">request_captcha</span><span class="params">(self, response)</span>:</span></span><br><span class="line">       selector = scrapy.Selector(response)</span><br><span class="line">       captcha_url = selector.xpath(<span class="string">"//img[@class='verifyimg']"</span>).xpath(<span class="string">"./@src"</span>).extract_first()</span><br><span class="line">       randomKey = selector.xpath(<span class="string">"//input[@class='randomkey']"</span>).xpath(<span class="string">"./@value"</span>).extract_first()</span><br><span class="line"></span><br><span class="line">       full_captcha_url = self.host + captcha_url</span><br><span class="line">       fileName = self.captcha_file_path()</span><br><span class="line">       urlretrieve(full_captcha_url, fileName)</span><br><span class="line"></span><br><span class="line">       open_image_command = <span class="string">"open "</span>+fileName</span><br><span class="line">       os.system(open_image_command)</span><br><span class="line"></span><br><span class="line">       captcha_str = input(<span class="string">"è¯·è¾“å…¥éªŒè¯ç :"</span>)</span><br><span class="line">       <span class="keyword">return</span> scrapy.FormRequest.from_response(</span><br><span class="line">           response,</span><br><span class="line">           formdata=&#123;<span class="string">"regionCode"</span>: <span class="string">"+86"</span>,</span><br><span class="line">                     <span class="string">"account"</span>: <span class="string">"æ‰‹æœºå·"</span>,</span><br><span class="line">                     <span class="string">"password"</span>: <span class="string">"å¯†ç "</span>,</span><br><span class="line">                     <span class="string">"captcha"</span>: captcha_str,</span><br><span class="line">                     <span class="string">"randomKey"</span>: randomKey&#125;,</span><br><span class="line">           meta=&#123;<span class="string">'cookiejar'</span>: response.meta[<span class="string">'cookiejar'</span>]&#125;,</span><br><span class="line">           callback=self.after_login</span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line"><span class="comment"># self.open_host_page å°±æ˜¯å¼€å§‹çˆ¬çš„æ–¹æ³•</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">after_login</span><span class="params">(self, response)</span>:</span></span><br><span class="line">       print(<span class="string">"after_login"</span>)</span><br><span class="line">       <span class="keyword">yield</span> scrapy.Request(url=self.host,</span><br><span class="line">                            meta=&#123;<span class="string">'cookiejar'</span>: response.meta[<span class="string">'cookiejar'</span>]&#125;,</span><br><span class="line">                            callback=self.open_host_page)</span><br><span class="line">                            </span><br><span class="line">   <span class="comment">#éªŒè¯ç å›¾ç‰‡ä¿å­˜è·¯å¾„</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">captcha_file_path</span><span class="params">(self)</span>:</span></span><br><span class="line">       captcha_file_name = <span class="string">"./image/captcha.jpg"</span></span><br><span class="line">       directory = os.path.dirname(captcha_file_name)</span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">           os.makedirs(directory)</span><br><span class="line">       <span class="keyword">return</span> captcha_file_name</span><br></pre></td></tr></table></figure>
<h2 id="settingçš„ä¸€äº›é…ç½®"><a href="#settingçš„ä¸€äº›é…ç½®" class="headerlink" title="settingçš„ä¸€äº›é…ç½®"></a>settingçš„ä¸€äº›é…ç½®</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é—´éš”æ—¶é—´ï¼Œå•ä½ç§’ã€‚æŒ‡æ˜scrapyæ¯ä¸¤ä¸ªè¯·æ±‚ä¹‹é—´çš„é—´éš”ã€‚</span></span><br><span class="line">DOWNLOAD_DELAY = <span class="number">5</span></span><br><span class="line"><span class="comment"># å¯¹ä¸€ä¸ªç½‘ç«™çš„æœ€å¤§å¹¶å‘æ•°</span></span><br><span class="line">CONCURRENT_REQUESTS_PER_DOMAIN = <span class="number">16</span></span><br><span class="line"><span class="comment"># å¯¹ä¸€ä¸ªIPçš„æœ€å¤§å¹¶å‘æ•°</span></span><br><span class="line">CONCURRENT_REQUESTS_PER_IP = <span class="number">16</span></span><br><span class="line"><span class="comment"># è¯·æ±‚å¤´</span></span><br><span class="line">DEFAULT_REQUEST_HEADERS = &#123;</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Accept-Language'</span>: <span class="string">'zh-CN,zh;q=0.8,en;q=0.6'</span>,</span><br><span class="line">    <span class="string">'Accept-Encoding'</span>:<span class="string">'gzip, deflate, sdch, br'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span>,</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/57.0.2987.133 Safari/537.36'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å°±å¯ä»¥çˆ¬å–åˆ°æ‰€éœ€è¦çš„æ‹›è˜ä¿¡æ¯äº†ï¼š<br><img src="/res/Python/pythonçˆ¬è™«.png" alt></p>
<p>å…·ä½“ä»£ç æŸ¥çœ‹ï¼š <a href="https://github.com/sunyanyan/jobSpider" target="_blank" rel="noopener">https://github.com/sunyanyan/jobSpider</a></p>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>Pythonçˆ¬è™«æ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonçˆ¬è™«æ•™ç¨‹-ä½¿ç”¨Scrapy(2)</title>
    <url>/quick-start/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B-%E4%BD%BF%E7%94%A8Scrapy(2)/</url>
    <content><![CDATA[<blockquote>
<p>æœ¬æ–‡ä¸»è¦è®²ä½¿ç”¨IPä»£ç†é˜²æ­¢çˆ¬è™«è¢«ç¦</p>
<p>åœ¨ <a href="../Pythonçˆ¬è™«æ•™ç¨‹-ä½¿ç”¨Scrapy/">pythonçˆ¬è™«</a>ä¸­çˆ¬å–åˆ°å¤§çº¦184æ¡æ•°æ®åï¼Œzhipinç½‘ç«™å°±ä¼šé‡‡å–é“¾æ¥é‡å®šå‘æ–¹å¼ é˜»æ­¢çˆ¬å–ã€‚å¦‚æœåœ¨ä»£ç ä¸­å–æ¶ˆç™»å½•æ“ä½œ ï¼Œ ç›´æ¥çˆ¬å–åˆ°å¤§çº¦92æ¡æ•°æ®ï¼Œä½ çš„ IP å°±ä¼šè¢«å°å•¦~ </p>
</blockquote>
<p><img src="/res/Python/zhipin_403.png" alt></p>
<p>ä¸ºäº†é˜²æ­¢è¿™ä¸ªæ‚²å‰§å‘ç”Ÿ æ ¹æ®Scarpy <a href="https://doc.scrapy.org/en/latest/topics/practices.html?highlight=banned#avoiding-getting-banned" target="_blank" rel="noopener">https://doc.scrapy.org/en/latest/topics/practices.html?highlight=banned#avoiding-getting-banned</a> æœ‰ä»¥ä¸‹å‡ ä¸ªå»ºè®®ï¼š</p>
<a id="more"></a>
<ul>
<li>åŠ¨æ€è®¾ç½®user agent</li>
<li>ç¦ç”¨cookies ï¼ˆ<strong>COOKIES_ENABLED</strong>ï¼‰</li>
<li>è®¾ç½®å»¶è¿Ÿä¸‹è½½ ï¼ˆ<strong>DOWNLOAD_DELAY</strong>ï¼‰</li>
<li>ä½¿ç”¨Google cache (<em>å›½å†…ä¸å¥½ç”¨</em>)</li>
<li>ä½¿ç”¨IPåœ°å€æ± ï¼ˆTor projectã€VPNå’Œä»£ç†IPï¼‰</li>
<li>ä½¿ç”¨Crawlera ï¼ˆ<em>æ”¶è´¹</em>ï¼‰</li>
</ul>
<p>åœ¨setting.pyä¸­è®¾ç½®å®Œ COOKIES_ENABLED å’Œ DOWNLOAD_DELAY ä¸‹é¢å°±æ¥çœ‹å¦‚ä½•ä½¿ç”¨ User Agent å’Œ IPä»£ç†</p>
<h2 id="è®¾ç½®-UAæ± å’Œ-IPæ± "><a href="#è®¾ç½®-UAæ± å’Œ-IPæ± " class="headerlink" title="è®¾ç½® UAæ± å’Œ IPæ± "></a>è®¾ç½® UAæ± å’Œ IPæ± </h2><p>scarpyè®¾ç½®ä»£ç†IP å’Œ User Agentçš„åˆ‡æ¢éƒ½æ˜¯ç”¨ ä¸‹è½½ä¸­é—´ä»¶ DOWNLOADER_MIDDLEWARES å®Œæˆã€‚</p>
<h3 id="åŠ¨æ€åˆ‡æ¢-User-Agent"><a href="#åŠ¨æ€åˆ‡æ¢-User-Agent" class="headerlink" title="åŠ¨æ€åˆ‡æ¢ User Agent"></a>åŠ¨æ€åˆ‡æ¢ User Agent</h3><p>åœ¨å·¥ç¨‹ä¸­ middleware.py(æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å°±åˆ›å»ºä¸€ä¸ªï¼Œè‹¥æ˜¯æœ‰è¿™ä¸ªæ–‡ä»¶ é‡Œé¢æœ‰å†…ç½®çš„ä¸­é—´ä»¶ä¹Ÿä¸ç”¨ç†ä¼šå®ƒ) ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">agents = [</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/532.5 (KHTML, like Gecko) Chrome/4.0.249.0 Safari/532.5"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US) AppleWebKit/532.9 (KHTML, like Gecko) Chrome/5.0.310.0 Safari/532.9"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/534.7 (KHTML, like Gecko) Chrome/7.0.514.0 Safari/534.7"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US) AppleWebKit/534.14 (KHTML, like Gecko) Chrome/9.0.601.0 Safari/534.14"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.14 (KHTML, like Gecko) Chrome/10.0.601.0 Safari/534.14"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.20 (KHTML, like Gecko) Chrome/11.0.672.2 Safari/534.20"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/534.27 (KHTML, like Gecko) Chrome/12.0.712.0 Safari/534.27"</span>,</span><br><span class="line">    <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/13.0.782.24 Safari/535.1"</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAgentMiddleware</span><span class="params">(object)</span>:</span> </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request, spider)</span>:</span></span><br><span class="line">        agent = random.choice(agents)</span><br><span class="line">        request.headers[<span class="string">"User-Agent"</span>] = agent</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨setting.pyä¸­ æ·»åŠ :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">   &apos;jobSpider.middlewares.UserAgentMiddleware&apos;: 401,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="IPä»£ç†"><a href="#IPä»£ç†" class="headerlink" title="IPä»£ç†"></a>IPä»£ç†</h3><p>ç®€å•æ¥ï¼Œæ¯”å¦‚æœ¬åœ°127.0.0.1å¼€å¯äº†ä¸€ä¸ª8888ç«¯å£çš„ä»£ç†ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡ä¸­é—´ä»¶é…ç½®è®©çˆ¬è™«é€šè¿‡è¿™ä¸ªä»£ç†æ¥å¯¹ç›®æ ‡ç½‘ç«™è¿›è¡Œçˆ¬å–ã€‚<br>åŒæ ·åœ¨middleware.pyä¸­åŠ å…¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class ProxyMiddleware(object):</span><br><span class="line"></span><br><span class="line">    def process_request(self, request, spider): </span><br><span class="line">        # æ­¤å¤„å¡«å†™ä½ è‡ªå·±çš„ä»£ç†</span><br><span class="line">        # å¦‚æœæ˜¯ä¹°çš„ä»£ç†çš„è¯å¯ä»¥å»ç”¨APIè·å–ä»£ç†åˆ—è¡¨ç„¶åéšæœºé€‰æ‹©ä¸€ä¸ª</span><br><span class="line">        proxy = &quot;http://127.0.0.1: 8888&quot;</span><br><span class="line">        request.meta[&quot;proxy&quot;] = proxy</span><br></pre></td></tr></table></figure>
<p>ç„¶åå’Œ user agentä¸­ä¸€æ · åœ¨setting.py çš„DOWNLOADER_MIDDLEWARESä¸­æ·»åŠ ProxyMiddlewareå°±å¯ä»¥äº†ã€‚</p>
<p>ä½†æ˜¯å½“ç„¶ç”¨ç¬¬ä¸‰æ–¹çš„ipä»£ç† æ‰èƒ½è¾¾åˆ°é˜²æ­¢çˆ¬è™«è¢«bannedçš„ç›®çš„å•¦~</p>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>Pythonçˆ¬è™«æ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonçˆ¬è™«æ•™ç¨‹-å…¥é—¨</title>
    <url>/quick-start/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B/Python%E7%88%AC%E8%99%AB%E6%95%99%E7%A8%8B-%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<ul>
<li>ä½¿ç”¨çš„IDE ï¼š <a href="https://www.jetbrains.com/pycharm/download/" target="_blank" rel="noopener">pycharm ce ç¤¾åŒºç‰ˆ</a></li>
<li>python libæ–‡æ¡£ : <a href="https://docs.python.org/3.5/library/index.html" target="_blank" rel="noopener">The Python Standard Library</a></li>
</ul>
<blockquote>
<p>python3 çˆ¬è™«</p>
</blockquote>
<h1 id="åˆ›å»ºçˆ¬è™«"><a href="#åˆ›å»ºçˆ¬è™«" class="headerlink" title="åˆ›å»ºçˆ¬è™«"></a>åˆ›å»ºçˆ¬è™«</h1><h2 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h2><blockquote>
<p>ç½‘ç»œè¿æ¥</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line">html = urlopen(<span class="string">"http://pythonscraping.com/pages/page1.html"</span>) print(html.read())</span><br></pre></td></tr></table></figure>
<blockquote>
<p>BeautifulSoup</p>
</blockquote>
<p>ä¸­æ–‡æ–‡æ¡£ <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/" target="_blank" rel="noopener">https://www.crummy.com/software/BeautifulSoup/bs4/doc.zh/</a></p>
<a id="more"></a>
<ol>
<li>å®‰è£…pip<ul>
<li>æ ¹æ® <a href="https://pip.pypa.io/en/latest/installing/" target="_blank" rel="noopener">https://pip.pypa.io/en/latest/installing/</a> å®‰è£…pip</li>
</ul>
</li>
<li><p>å®‰è£…beautifulsoup</p>
 <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">$pip3 install beautifulsoup4</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨</p>
 <figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/page1.html"</span>)</span><br><span class="line">bsObj = BeautifulSoup(html.read())</span><br><span class="line">print(bsObj.h1)</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™æ ·ä½¿ç”¨ä¼šè­¦å‘Š <code>BeautifulSoup([your markup], &quot;html.parser&quot;)</code>è¿™æ ·æ­£ç¡®çš„ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>å¤„ç†Httpå¼‚å¸¸</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/page1.html"</span>)</span><br><span class="line"><span class="keyword">except</span> HTTPError <span class="keyword">as</span> e: </span><br><span class="line">	print(e)</span><br><span class="line">	<span class="comment"># è¿”å›ç©ºå€¼ï¼Œä¸­æ–­ç¨‹åºï¼Œæˆ–è€…æ‰§è¡Œå¦ä¸€ä¸ªæ–¹æ¡ˆ </span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="comment"># ç¨‹åºç»§ç»­ã€‚æ³¨æ„:å¦‚æœä½ å·²ç»åœ¨ä¸Šé¢å¼‚å¸¸æ•æ‰é‚£ä¸€æ®µä»£ç é‡Œè¿”å›æˆ–ä¸­æ–­(break)ï¼Œ </span></span><br><span class="line">	<span class="comment"># é‚£ä¹ˆå°±ä¸éœ€è¦ä½¿ç”¨elseè¯­å¥äº†ï¼Œè¿™æ®µä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å¤„ç†beautifulSoupå¼‚å¸¸</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	badContent = bsObj.nonExistingTag.anotherTag</span><br><span class="line"><span class="keyword">except</span> AttributeError <span class="keyword">as</span> e: </span><br><span class="line">	print(<span class="string">"Tag was not found"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="keyword">if</span> badContent == <span class="keyword">None</span>:</span><br><span class="line">		<span class="keyword">print</span> (<span class="string">"Tag was not found"</span>) </span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		print(badContent)</span><br></pre></td></tr></table></figure>
<h2 id="å¤æ‚HTMLè§£æ"><a href="#å¤æ‚HTMLè§£æ" class="headerlink" title="å¤æ‚HTMLè§£æ"></a>å¤æ‚HTMLè§£æ</h2><blockquote>
<p>ä½¿ç”¨beautifulSoupæŠ“å–ç‰¹å®šcsså±æ€§</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/warandpeace.html"</span>)</span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line">nameList = bsObj.findAll(<span class="string">"span"</span>, &#123;<span class="string">"class"</span>:<span class="string">"green"</span>&#125;) </span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> nameList:</span><br><span class="line">    print(name.get_text())</span><br></pre></td></tr></table></figure>
<blockquote>
<p>ä½¿ç”¨beautifulSoupå¤„ç†htmlæ ‡ç­¾æ ‘</p>
</blockquote>
<ol>
<li><p>è·å–å­æ ‡ç­¾ <code>children()</code></p>
 <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/page3.html"</span>)</span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line"><span class="keyword">for</span> child <span class="keyword">in</span> bsObj.find(<span class="string">"table"</span>,&#123;<span class="string">"id"</span>:<span class="string">"giftList"</span>&#125;).children:</span><br><span class="line">	print(child)</span><br></pre></td></tr></table></figure>
</li>
<li><p>è·å–è‡ªèº«ä¹‹åçš„å…„å¼Ÿæ ‡ç­¾ <code>next_siblings()</code></p>
<ul>
<li><p>è·å–é™¤äº†è‡ªèº«ä»¥å¤–çš„å…„å¼Ÿæ ‡ç­¾ï¼ŒåŒæ—¶åªèƒ½è·å–è‡ªèº«ä¹‹åçš„å…„å¼Ÿæ ‡ç­¾ã€‚</p>
  <figure class="highlight py"><table><tr><td class="code"><pre><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/page3.html"</span>) </span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line"><span class="keyword">for</span> sibling <span class="keyword">in</span> bsObj.find(<span class="string">"table"</span>,&#123;<span class="string">"id"</span>:<span class="string">"giftList"</span>&#125;).tr.next_siblings: </span><br><span class="line">	print(sibling)</span><br></pre></td></tr></table></figure>
</li>
<li><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ è·å–è‡ªèº«ä¹‹å‰çš„å…„å¼Ÿæ ‡ç­¾ <code>previous_siblings()</code>ã€è·å–è‡ªèº«ä¹‹å‰çš„å•ä¸ªå…„å¼Ÿæ ‡ç­¾ <code>previous_sibling()</code>ã€è·å–è‡ªèº«ä¹‹åçš„å•ä¸ªå…„å¼Ÿæ ‡ç­¾ <code>next_sibling()</code>ã€‚</p>
</li>
</ul>
</li>
<li><p>è·å–çˆ¶æ ‡ç­¾</p>
<ul>
<li>parent å’Œ parents</li>
</ul>
</li>
</ol>
<blockquote>
<p>æ­£åˆ™è¡¨è¾¾å¼ ä¸ BeautifulSoup</p>
</blockquote>
<p>æŸ¥æ‰¾å›¾ç‰‡ç›¸å¯¹è·¯å¾„ä¸ºä»¥ ../img/gifts/img å¼€å¤´ï¼Œä»¥ .jpg ç»“å°¾çš„å›¾ç‰‡</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com/pages/page3.html"</span>)</span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line">images = bsObj.findAll(<span class="string">"img"</span>,&#123;<span class="string">"src"</span>:re.compile(<span class="string">"\.\.\/img\/gifts/img.*\.jpg"</span>)&#125;) <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">print(image[<span class="string">"src"</span>])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è·å–å±æ€§</p>
</blockquote>
<p>ç»å¸¸ä¸éœ€è¦æŸ¥æ‰¾æ ‡ç­¾çš„å†…å®¹ï¼Œ è€Œæ˜¯éœ€è¦æŸ¥æ‰¾æ ‡ç­¾å±æ€§<br><code>myTag.attrs</code>å¯ä»¥è·å–ä¸€ä¸ªæ ‡ç­¾å¯¹è±¡çš„å…¨éƒ¨å±æ€§ã€‚æ¯”å¦‚è·å–srcå±æ€§ï¼š<code>myImgTag.attrs[&quot;src&quot;]</code></p>
<h1 id="å¼€å§‹é‡‡é›†"><a href="#å¼€å§‹é‡‡é›†" class="headerlink" title="å¼€å§‹é‡‡é›†"></a>å¼€å§‹é‡‡é›†</h1><h2 id="éå†å•ä¸ªåŸŸå"><a href="#éå†å•ä¸ªåŸŸå" class="headerlink" title="éå†å•ä¸ªåŸŸå"></a>éå†å•ä¸ªåŸŸå</h2><blockquote>
<p>æ‰¾åˆ°URLé“¾æ¥ï¼Œè·å–ç½‘é¡µå†…å®¹ï¼Œä»ä¸­æ‰¾å‡ºå¦ä¸€ä¸ªé“¾æ¥ï¼Œç„¶åå†è·å–è¿™ä¸ªç½‘é¡µçš„å†…å®¹ï¼Œä¸æ–­å¾ªç¯è¿™ä¸€è¿‡ç¨‹ã€‚</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">random.seed(datetime.datetime.now())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLinks</span><span class="params">(articleUrl)</span>:</span></span><br><span class="line">    html = urlopen(<span class="string">"http://en.wikipedia.org"</span>+articleUrl)</span><br><span class="line">    bsObj = BeautifulSoup(html)</span><br><span class="line">    <span class="keyword">return</span> bsObj.find(<span class="string">"div"</span>, &#123;<span class="string">"id"</span>:<span class="string">"bodyContent"</span>&#125;).findAll(<span class="string">"a"</span>,href=re.compile(<span class="string">"^(/wiki/)((?!:).)*$"</span>))</span><br><span class="line"></span><br><span class="line">links = getLinks(<span class="string">"/wiki/Kevin_Bacon"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> len(links) &gt; <span class="number">0</span>:</span><br><span class="line">    newArticle = links[random.randint(<span class="number">0</span>, len(links)<span class="number">-1</span>)].attrs[<span class="string">"href"</span>]</span><br><span class="line">    print(newArticle)</span><br><span class="line">    links = getLinks(newArticle)</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰äº† getLinkså‡½æ•°ï¼Œè¿‡æ»¤å‡ºæŒ‡å‘å…¶ä»–è¯æ¡çš„é“¾æ¥ã€‚å†éšæœºé€‰æ‹©ä¸€æ¡é“¾æ¥ è·å–æ–°çš„é¡µé¢ï¼Œå¦‚æ­¤å¾ªç¯ã€‚</p>
<h2 id="é‡‡é›†æ•´ä¸ªç½‘ç«™"><a href="#é‡‡é›†æ•´ä¸ªç½‘ç«™" class="headerlink" title="é‡‡é›†æ•´ä¸ªç½‘ç«™"></a>é‡‡é›†æ•´ä¸ªç½‘ç«™</h2><blockquote>
<p>urlé“¾æ¥å»é‡ï¼Œæ‰“å°ï¼ˆæ”¶é›†ï¼‰éœ€è¦ä¿¡æ¯</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen </span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup </span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">pages = set()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLinks</span><span class="params">(pageUrl)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> pages</span><br><span class="line">    html = urlopen(<span class="string">"http://en.wikipedia.org"</span>+pageUrl) </span><br><span class="line">    bsObj = BeautifulSoup(html)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(bsObj.h1.get_text()) </span><br><span class="line">        print(bsObj.find(id=<span class="string">"mw-content-text"</span>).findAll(<span class="string">"p"</span>)[<span class="number">0</span>])</span><br><span class="line">        print(bsObj.find(id=<span class="string">"ca-edit"</span>).find(<span class="string">"span"</span>).find(<span class="string">"a"</span>).attrs[<span class="string">'href'</span>])</span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        print(<span class="string">"é¡µé¢ç¼ºå°‘ä¸€äº›å±æ€§!ä¸è¿‡ä¸ç”¨æ‹…å¿ƒ!"</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> link <span class="keyword">in</span> bsObj.findAll(<span class="string">"a"</span>, href=re.compile(<span class="string">"^(/wiki/)"</span>)):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'href'</span> <span class="keyword">in</span> link.attrs:</span><br><span class="line">        <span class="keyword">if</span> link.attrs[<span class="string">'href'</span>] <span class="keyword">not</span> <span class="keyword">in</span> pages:</span><br><span class="line">            <span class="comment"># æˆ‘ä»¬é‡åˆ°äº†æ–°é¡µé¢</span></span><br><span class="line">            newPage = link.attrs[<span class="string">'href'</span>] </span><br><span class="line">            print(<span class="string">"----------------\n"</span>+newPage) </span><br><span class="line">            pages.add(newPage) </span><br><span class="line">            getLinks(newPage)</span><br><span class="line">            </span><br><span class="line">getLinks(<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<h2 id="ä½¿ç”¨Scrapyé‡‡é›†"><a href="#ä½¿ç”¨Scrapyé‡‡é›†" class="headerlink" title="ä½¿ç”¨Scrapyé‡‡é›†"></a>ä½¿ç”¨Scrapyé‡‡é›†</h2><blockquote>
<p>Scrapy å°±æ˜¯ä¸€ä¸ªå¸®ä½ å¤§å¹…åº¦é™ä½ç½‘é¡µé“¾æ¥æŸ¥æ‰¾å’Œè¯†åˆ«å·¥ä½œå¤æ‚åº¦çš„ Python åº“ï¼Œå®ƒå¯ä»¥ è®©ä½ è½»æ¾åœ°é‡‡é›†ä¸€ä¸ªæˆ–å¤šä¸ªåŸŸåçš„ä¿¡æ¯ã€‚<br>Scrapy 1.3.0 å·²ç»æ”¯æŒ python3.3+äº†</p>
</blockquote>
<p>å®˜æ–¹æ–‡æ¡£ : <a href="https://docs.scrapy.org/en/latest/" target="_blank" rel="noopener">Scrapy 1.3 documentation</a><br>å®‰è£…ï¼š <code>pip3 install scrapy</code></p>
<blockquote>
<p>Scrapy åˆ›å»ºé¡¹ç›®</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">scrapy startproject wikiSpider</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œä¸Šé¢å‘½ä»¤åï¼šä¼šç”Ÿæˆç›®å½•:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- wikiSpider</span><br><span class="line">	* scrapy.cfg </span><br><span class="line">	- wikiSpider </span><br><span class="line">		- __pycache__</span><br><span class="line">		- spiders</span><br><span class="line">		* __init__.py</span><br><span class="line">		* items.py</span><br><span class="line">		* middlewares.py</span><br><span class="line">		* pipelines.py</span><br><span class="line">		* settings.py</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Scrapy åˆ›å»ºçˆ¬è™«</p>
</blockquote>
<p><strong>1.</strong> åœ¨items.pyä¸­æ·»åŠ ä¸€ä¸ªç±»</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(scrapy.Item)</span>:</span></span><br><span class="line">    title = scrapy.Field()</span><br></pre></td></tr></table></figure>
<p>Scrapy çš„æ¯ä¸ª Item(æ¡ç›®)å¯¹è±¡è¡¨ç¤ºç½‘ç«™ä¸Šçš„ä¸€ä¸ªé¡µé¢ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰ä¸åŒçš„æ¡ç›®(æ¯”å¦‚urlã€contentã€header imageç­‰)ï¼Œä½†æ˜¯ç°åœ¨æˆ‘åªæ¼”ç¤ºæ”¶é›†æ¯é¡µçš„titleå­—æ®µ (field)ã€‚</p>
<p><strong>2.</strong> wikiSpider/wikiSpider/spiders/ æ–‡ä»¶å¤¹é‡Œå¢åŠ ä¸€ä¸ª <strong>articleSpider.py</strong> æ–‡ä»¶</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.selector <span class="keyword">import</span> Selector</span><br><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Spider</span><br><span class="line"><span class="keyword">from</span> wikiSpider.items <span class="keyword">import</span> Article</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSpider</span><span class="params">(Spider)</span>:</span></span><br><span class="line">    name=<span class="string">"article"</span></span><br><span class="line">    allowed_domains = [<span class="string">"en.wikipedia.org"</span>]</span><br><span class="line">    start_urls = [<span class="string">"http://en.wikipedia.org/wiki/Main_Page"</span>,<span class="string">"http://en.wikipedia.org/wiki/Python_%28programming_language%29"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        item = Article()</span><br><span class="line">        title = response.xpath(<span class="string">'//h1/text()'</span>)[<span class="number">0</span>].extract()</span><br><span class="line">        print(<span class="string">"Title is: "</span>+title)</span><br><span class="line">        item[<span class="string">'title'</span>] = title</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è¿è¡Œ <code>scrapy crawl article</code> å¯ä»¥çœ‹åˆ°ä¸€å¤§å †æ—¥å¿—ä¿¡æ¯ å’Œï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Title is: Main Page</span><br><span class="line">Title is: Python (programming language)</span><br></pre></td></tr></table></figure>
<h2 id="è§£æJSON"><a href="#è§£æJSON" class="headerlink" title="è§£æJSON"></a>è§£æJSON</h2><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">jsonString = <span class="string">'&#123;"arrayOfNums":[&#123;"number":0&#125;,&#123;"number":1&#125;,&#123;"number":2&#125;],'</span> \</span><br><span class="line">             <span class="string">'"arrayOfFruits":[&#123;"fruit":"apple"&#125;,&#123;"fruit":"banana"&#125;,&#123;"fruit":"pear"&#125;]&#125;'</span></span><br><span class="line">jsonObj = json.loads(jsonString)</span><br><span class="line">print(jsonObj.get(<span class="string">"arrayOfNums"</span>)) </span><br><span class="line">print(jsonObj.get(<span class="string">"arrayOfNums"</span>)[<span class="number">1</span>]) </span><br><span class="line">print(jsonObj.get(<span class="string">"arrayOfNums"</span>)[<span class="number">1</span>].get(<span class="string">"number"</span>)+jsonObj.get(<span class="string">"arrayOfNums"</span>)[<span class="number">2</span>].get(<span class="string">"number"</span>)) </span><br><span class="line">print(jsonObj.get(<span class="string">"arrayOfFruits"</span>)[<span class="number">2</span>].get(<span class="string">"fruit"</span>))</span><br></pre></td></tr></table></figure>
<h2 id="å‚¨å­˜æ•°æ®"><a href="#å‚¨å­˜æ•°æ®" class="headerlink" title="å‚¨å­˜æ•°æ®"></a>å‚¨å­˜æ•°æ®</h2><blockquote>
<p>ä½¿ç”¨ <code>urlretrieve</code> å‚¨å­˜åˆ°æœ¬åœ°</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlretrieve</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">downloadDirectory = <span class="string">"downloaded"</span></span><br><span class="line">baseUrl = <span class="string">"http://pythonscraping.com"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAbsoluteURL</span><span class="params">(baseUrl, source)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> source.startswith(<span class="string">"http://www."</span>):</span><br><span class="line">        url = <span class="string">"http://"</span>+source[<span class="number">11</span>:]</span><br><span class="line">    <span class="keyword">elif</span> source.startswith(<span class="string">"http://"</span>):</span><br><span class="line">        url = source</span><br><span class="line">    <span class="keyword">elif</span> source.startswith(<span class="string">"www."</span>):</span><br><span class="line">        url = source[<span class="number">4</span>:]</span><br><span class="line">        url = <span class="string">"http://"</span>+source</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        url = baseUrl+<span class="string">"/"</span>+source</span><br><span class="line">    <span class="keyword">if</span> baseUrl <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDownloadPath</span><span class="params">(baseUrl, absoluteUrl, downloadDirectory)</span>:</span></span><br><span class="line">    path = absoluteUrl.replace(<span class="string">"www."</span>, <span class="string">""</span>)</span><br><span class="line">    path = path.replace(baseUrl, <span class="string">""</span>)</span><br><span class="line">    path = downloadDirectory+path</span><br><span class="line">    directory = os.path.dirname(path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(directory):</span><br><span class="line">        os.makedirs(directory)</span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line">html = urlopen(<span class="string">"http://www.pythonscraping.com"</span>)</span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line">downloadList = bsObj.findAll(src=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> download <span class="keyword">in</span> downloadList:</span><br><span class="line">    fileUrl = getAbsoluteURL(baseUrl, download[<span class="string">"src"</span>])</span><br><span class="line">    <span class="keyword">if</span> fileUrl <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        print(fileUrl)</span><br><span class="line"></span><br><span class="line">urlretrieve(fileUrl, getDownloadPath(baseUrl, fileUrl, downloadDirectory))</span><br></pre></td></tr></table></figure>
<p>é€‰æ‹©é¦–é¡µä¸Šæ‰€æœ‰å¸¦ src å±æ€§çš„æ ‡ç­¾ã€‚ç„¶ åå¯¹ URL é“¾æ¥è¿›è¡Œæ¸…ç†å’Œæ ‡å‡†åŒ–ï¼Œè·å¾—æ–‡ä»¶çš„ç»å¯¹è·¯å¾„(è€Œä¸”å»æ‰äº†å¤–é“¾)ã€‚æœ€åï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½ä¼šä¸‹è½½åˆ°ç¨‹åºæ‰€åœ¨æ–‡ä»¶å¤¹çš„ downloaded æ–‡ä»¶é‡Œã€‚</p>
<blockquote>
<p>å°†ç½‘é¡µä¸­çš„è¡¨å•ä¿å­˜ä¸ºCSVæ ¼å¼</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen </span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">html = urlopen(<span class="string">"http://en.wikipedia.org/wiki/Comparison_of_text_editors"</span>) </span><br><span class="line">bsObj = BeautifulSoup(html)</span><br><span class="line"><span class="comment"># ä¸»å¯¹æ¯”è¡¨æ ¼æ˜¯å½“å‰é¡µé¢ä¸Šçš„ç¬¬ä¸€ä¸ªè¡¨æ ¼</span></span><br><span class="line">table = bsObj.findAll(<span class="string">"table"</span>,&#123;<span class="string">"class"</span>:<span class="string">"wikitable"</span>&#125;)[<span class="number">0</span>]</span><br><span class="line">rows = table.findAll(<span class="string">"tr"</span>)</span><br><span class="line"></span><br><span class="line">csvFile = open(<span class="string">"../files/editors.csv"</span>, <span class="string">'wt'</span>, newline=<span class="string">''</span>, encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">writer = csv.writer(csvFile)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> rows:</span><br><span class="line">    csvRow = []</span><br><span class="line">    <span class="keyword">for</span> cell <span class="keyword">in</span> row.findAll([<span class="string">'td'</span>, <span class="string">'th'</span>]):</span><br><span class="line">        csvRow.append(cell.get_text())</span><br><span class="line">        writer.writerow(csvRow) </span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        csvFile.close()</span><br></pre></td></tr></table></figure>
<h1 id="é«˜çº§æ•°æ®é‡‡é›†"><a href="#é«˜çº§æ•°æ®é‡‡é›†" class="headerlink" title="é«˜çº§æ•°æ®é‡‡é›†"></a>é«˜çº§æ•°æ®é‡‡é›†</h1><h2 id="POST-ä¸-ç™»å½•"><a href="#POST-ä¸-ç™»å½•" class="headerlink" title="POST ä¸ ç™»å½•"></a>POST ä¸ ç™»å½•</h2><blockquote>
<p>ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ <a href="http://www.python-requests.org/" target="_blank" rel="noopener">Request</a><br>å®‰è£… <code>pip3 install requests</code></p>
</blockquote>
<p>ä½¿ç”¨ï¼š<br><figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">params = &#123;<span class="string">'firstname'</span>: <span class="string">'Ryan'</span>, <span class="string">'lastname'</span>: <span class="string">'Mitchell'</span>&#125;</span><br><span class="line">r = requests.post(<span class="string">"http://pythonscraping.com/files/processing.php"</span>, data=params)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure></p>
<h2 id="å¤„ç†Cookie"><a href="#å¤„ç†Cookie" class="headerlink" title="å¤„ç†Cookie"></a>å¤„ç†Cookie</h2><blockquote>
<p>ä½¿ç”¨ requestsåº“è·Ÿè¸ªcookie</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">params = &#123;<span class="string">'username'</span>: <span class="string">'Ryan'</span>, <span class="string">'password'</span>: <span class="string">'password'</span>&#125;</span><br><span class="line">r = requests.post(<span class="string">"http://pythonscraping.com/pages/cookies/welcome.php"</span>, params) </span><br><span class="line">print(<span class="string">"Cookie is set to:"</span>)</span><br><span class="line">print(r.cookies.get_dict())</span><br><span class="line">print(<span class="string">"-----------"</span>)</span><br><span class="line">print(<span class="string">"Going to profile page..."</span>)</span><br><span class="line">r = requests.get(<span class="string">"http://pythonscraping.com/pages/cookies/profile.php"</span>,cookies=r.cookies)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>
<h2 id="å¤„ç†Session"><a href="#å¤„ç†Session" class="headerlink" title="å¤„ç†Session"></a>å¤„ç†Session</h2><blockquote>
<p>ä½¿ç”¨ requestsåº“è·Ÿè¸ªsession</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">session = requests.Session()</span><br><span class="line">params = &#123;<span class="string">'username'</span>: <span class="string">'username'</span>, <span class="string">'password'</span>: <span class="string">'password'</span>&#125;</span><br><span class="line">s = session.post(<span class="string">"http://pythonscraping.com/pages/cookies/welcome.php"</span>, params) </span><br><span class="line">print(<span class="string">"Cookie is set to:"</span>)</span><br><span class="line">print(s.cookies.get_dict())</span><br><span class="line">print(<span class="string">"-----------"</span>)</span><br><span class="line">print(<span class="string">"Going to profile page..."</span>)</span><br><span class="line">s = session.get(<span class="string">"http://pythonscraping.com/pages/cookies/profile.php"</span>) </span><br><span class="line">print(s.text)</span><br></pre></td></tr></table></figure>
<h2 id="ä¿®æ”¹header"><a href="#ä¿®æ”¹header" class="headerlink" title="ä¿®æ”¹header"></a>ä¿®æ”¹header</h2><blockquote>
<p>ä¸ºäº†è®©è¯·æ±‚æ›´åƒæ˜¯æµè§ˆå™¨å‘å‡ºçš„ï¼Œéœ€è¦ä¿®æ”¹è¯·æ±‚å¤´</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">headers = &#123;<span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_5) AppleWebKit 537.36 (KHTML, like Gecko) Chrome"</span>,</span><br><span class="line">           <span class="string">"Accept"</span>:<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8"</span>&#125;</span><br><span class="line">url = <span class="string">"https://www.whatismybrowser.com/developers/what-http-headers-is-my-browser-sending"</span> </span><br><span class="line">req = session.get(url, headers=headers)</span><br><span class="line">bsObj = BeautifulSoup(req.text)</span><br><span class="line">print(bsObj.find(<span class="string">"table"</span>,&#123;<span class="string">"class"</span>:<span class="string">"table-striped"</span>&#125;).get_text)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>quick-start</category>
        <category>Pythonçˆ¬è™«æ•™ç¨‹</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç </title>
    <url>/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E4%BD%8D%E5%9B%BE%E4%BF%A1%E6%81%AF%E4%B8%8E%E5%9B%BE%E7%89%87%E8%A7%A3%E7%A0%81/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»ä¸‹å‡ ç§iOSä¸­ä½å›¾ä¿¡æ¯ ä¸ç›¸å…³è§£å‹ç¼©<br>ref <a href="http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/" target="_blank" rel="noopener">è°ˆè°ˆ iOS ä¸­å›¾ç‰‡çš„è§£å‹ç¼©</a><br>ref <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007533-SW1" target="_blank" rel="noopener">Quartz 2D Programming Guide</a></p>
</blockquote>
<p>æˆ‘ä»¬ä»ç½‘ç»œä¸‹è½½æˆ–è€…ä»æœ¬åœ°ç£ç›˜åŠ è½½ä¸€å¼ å›¾ç‰‡åˆ°å±å¹•ä¸Šæ˜¾ç¤ºï¼Œè¦ç»è¿‡å›¾ç‰‡çš„è§£ç è¿‡ç¨‹ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¸€èˆ¬çš„å›¾ç‰‡æ ¼å¼ä¾‹å¦‚ JPEGï¼ŒPNGéƒ½æ˜¯ç»è¿‡å‹ç¼©åçš„å›¾ç‰‡ï¼Œè€Œæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å›¾ç‰‡å«åšä½å›¾(bitmap)ï¼Œæ‰€è°“çš„è§£ç å°±æ˜¯æŠŠå‹ç¼©åçš„å›¾ç‰‡å˜æˆä½å›¾ã€‚</p>
<p>ä¸ºä»€ä¹ˆéè¦è§£ç æˆä½å›¾æ‰èƒ½æ˜¾ç¤ºå‘¢ï¼Ÿå› ä¸ºä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œå°±å¯ä»¥åœ¨å±å¹•ä¸Šæ¸²æŸ“æ•´å¼ å›¾ç‰‡äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¿˜éœ€è¦ä¸åŒæ ¼å¼çš„å„ç§å›¾ç‰‡å‘¢ï¼Ÿç›´æ¥å…¨éƒ¨ç”¨ä½å›¾ä¸å°±å¥½äº†ï¼Ÿé‚£ä¸å°±ä¸éœ€è¦æ¯æ¬¡è§£ç äº†ï¼Ÿé‚£äº›JPEGä»¥åŠPNGç­‰å…¶å®éƒ½æ˜¯å›¾åƒçš„å‹ç¼©æ ¼å¼ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å‹ç¼©çš„æ„æ€å°±æ˜¯å‡å°ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œä½¿ç”¨è¿™äº›æ ¼å¼çš„åŸå› å°±æ˜¯ä½å›¾å®åœ¨å¤ªå¤§äº†ã€‚</p>
<h2 id="å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–"><a href="#å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–" class="headerlink" title="å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–"></a>å›¾ç‰‡è§£å‹åçš„æ•°æ®å˜åŒ–</h2><a id="more"></a>
<p>æˆ‘ä»¬æ¥ä½¿ç”¨è¿™å¼ å›¾ç‰‡å’Œä»¥ä¸‹ä»£ç åšä¾‹å­ï¼š</p>
<p><img src="/res/iOSImg/testImg2.png" style="background-color: rgba(0,0,300,.5)"><br>è¯¥å›¾ç‰‡çš„äºŒè¿›åˆ¶ä¿¡æ¯ä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR</span><br><span class="line">00000010: 0000 0022 0000 0022 0803 0000 000d 99fb  ...&quot;...&quot;........</span><br><span class="line">00000020: f000 0000 5d50 4c54 4500 0000 ffff ffff  ....]PLTE.......</span><br><span class="line">00000030: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000040: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000050: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000060: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000070: ffff ffff ffff ffff ffff ffff ffff ffff  ................</span><br><span class="line">00000080: ffff ffff ffff 512a fbe5 0000 001e 7452  ......Q*......tR</span><br><span class="line">00000090: 4e53 001c b890 7103 faa9 580d f7c8 09f0  NS....q...X.....</span><br><span class="line">000000a0: be42 1685 78e2 d4c5 b1a1 604d 492d 1e0f  .B..x.....`MI-..</span><br><span class="line">000000b0: 5dbe 24b2 0000 0084 4944 4154 38cb edcf  ].$.....IDAT8...</span><br><span class="line">000000c0: cb0a c240 1044 d1d2 38ad 8e19 4de2 fb55  ...@.D..8...M..U</span><br><span class="line">000000d0: ffff 99d2 4d70 971a 5097 de5d c381 a630  ....Mp..P..]...0</span><br><span class="line">000000e0: d113 952e 7b96 be55 a2a1 b76d b538 981b  ....&#123;..U...m.8..</span><br><span class="line">000000f0: 2516 d865 374a 6034 428c a611 228c 3127  %..e7J`4B...&quot;.1&apos;</span><br><span class="line">00000100: 21bc 23f9 d062 4596 a485 9143 552c d35f  !.#..bE....CU,._</span><br><span class="line">00000110: 7c27 faaa 4856 1358 939b f7d1 e510 9298  |&apos;..HV.X........</span><br><span class="line">00000120: 0b49 70bf 2548 127d 4aca 7cba d335 46cb  .Ip.%H.&#125;J.|..5F.</span><br><span class="line">00000130: 0a80 4193 73bc 9a89 3afc a817 5dd5 1a7c  ..A.s...:...]..|</span><br><span class="line">00000140: 84ac 48f9 0000 0000 4945 4e44 ae42 6082  ..H.....IEND.B`.</span><br></pre></td></tr></table></figure>
<p>è·å–å›¾ç‰‡è§£å‹ä¿¡æ¯çš„ä»£ç ä¸ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * path = [[<span class="built_in">NSBundle</span> mainBundle]pathForResource:<span class="string">@"testImg2"</span> ofType:<span class="string">@"png"</span>];</span><br><span class="line"><span class="built_in">NSURL</span> * url = [<span class="built_in">NSURL</span> fileURLWithPath:path];</span><br><span class="line"><span class="built_in">CGImageSourceRef</span> myImageSource = <span class="built_in">CGImageSourceCreateWithURL</span>((<span class="built_in">CFURLRef</span>)url, <span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">CGImageRef</span> myImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(myImageSource,<span class="number">0</span>,<span class="literal">NULL</span>);</span><br><span class="line"><span class="built_in">CFRelease</span>(myImageSource);</span><br><span class="line"></span><br><span class="line"><span class="built_in">CFDataRef</span> rawData = <span class="built_in">CGDataProviderCopyData</span>(<span class="built_in">CGImageGetDataProvider</span>(myImage));</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"rawData %@"</span>,rawData);</span><br></pre></td></tr></table></figure>
<p>è¿™å¼ å›¾ç‰‡åƒç´ å°ºå¯¸ä¸º34x34,æ–‡ä»¶å¤§å°ä¸º 336Byte ï¼›è€Œè·å–åˆ°å›¾ç‰‡åŸå§‹åƒç´ æ•°æ®rawDataï¼Œå¤§å°ä¸º4624byteã€‚ä»¥ä¸‹ä¸ºrawDataä¿¡æ¯ :</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">00000000 ffffff90 ffffffff ffffffff ffffffff ffffff71 00000000 ffffff42 fffffff7 </span><br><span class="line">ffffffff ffffffff ffffffbe ffffff09 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 ffffff90 ffffffff </span><br><span class="line">ffffffff ffffffff ffffff71 00000000 00000000 00000000 ffffff42 fffffff7 ffffffff </span><br><span class="line">ffffffff ffffffbe ffffff09 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 ffffff90 ffffffff ffffffff ffffffff ffffff71 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 ffffff42 fffffff7 ffffffff ffffffff </span><br><span class="line">ffffff90 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™å¼ PNG å›¾ç‰‡è§£å‹ç¼©åçš„å¤§å°æ˜¯ 4624byte ï¼Œæ˜¯åŸå§‹æ–‡ä»¶å¤§å°çš„ 4.27 å€ã€‚é‚£ä¹ˆè¿™ä¸ª4624byteæ˜¯æ€ä¹ˆå¾—æ¥çš„å‘¢ï¼Ÿä¸å›¾ç‰‡çš„æ–‡ä»¶å¤§å°æˆ–è€…åƒç´ æœ‰ä»€ä¹ˆå¿…ç„¶çš„è”ç³»å—ï¼Ÿäº‹å®ä¸Šï¼Œè§£å‹ç¼©åçš„å›¾ç‰‡å¤§å°ä¸åŸå§‹æ–‡ä»¶å¤§å°ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œè€Œåªä¸å›¾ç‰‡çš„åƒç´ æœ‰å…³ï¼š</p>
<p><strong><em>è§£å‹ç¼©åçš„å›¾ç‰‡å¤§å° = å›¾ç‰‡çš„åƒç´ å®½ 34 </em> å›¾ç‰‡çš„åƒç´ é«˜ 34 <em> æ¯ä¸ªåƒç´ æ‰€å çš„å­—èŠ‚æ•° 4</em></strong></p>
<p>æˆ‘ä»¬å¸¸è§æ¥è§¦åˆ°çš„å›¾ç‰‡æ ¼å¼ï¼Œ JPEG è¿˜æ˜¯ PNG å›¾ç‰‡ï¼Œéƒ½æ˜¯ä¸€ç§å‹ç¼©çš„<a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html" target="_blank" rel="noopener">ä½å›¾å›¾å½¢æ ¼å¼</a>ã€‚åªä¸è¿‡ PNG å›¾ç‰‡æ˜¯æ— æŸå‹ç¼©ï¼Œå¹¶ä¸”æ”¯æŒ alpha é€šé“ï¼Œè€Œ JPEG å›¾ç‰‡åˆ™æ˜¯æœ‰æŸå‹ç¼©ï¼Œå¯ä»¥æŒ‡å®š 0-100% çš„å‹ç¼©æ¯”ã€‚åœ¨å°†ç£ç›˜ä¸­çš„å›¾ç‰‡æ¸²æŸ“åˆ°å±å¹•ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¦å¾—åˆ°å›¾ç‰‡çš„åŸå§‹åƒç´ æ•°æ®ï¼Œæ‰èƒ½æ‰§è¡Œåç»­çš„ç»˜åˆ¶æ“ä½œã€‚</p>
<h2 id="ä½å›¾ä¿¡æ¯"><a href="#ä½å›¾ä¿¡æ¯" class="headerlink" title="ä½å›¾ä¿¡æ¯"></a>ä½å›¾ä¿¡æ¯</h2><p>å…¶å®ï¼Œä½å›¾å°±æ˜¯ä¸€ä¸ªåƒç´ æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªåƒç´ å°±ä»£è¡¨ç€å›¾ç‰‡ä¸­çš„ä¸€ä¸ªç‚¹ã€‚<a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_images/dq_images.html" target="_blank" rel="noopener">Bitmap Images and Image Masks</a>ä¸­æ˜¯è¿™ä¹ˆå®šä¹‰çš„ï¼š</p>
<blockquote>
<p>A bitmap image (or sampled image) is an array of pixels (or samples). Each pixel represents a single point in the image. JPEG, TIFF, and PNG graphics files are examples of bitmap images.<br>Each sample in a bitmap contains one or more color components in a specified color space, plus one additional component that specifies the alpha value to indicate transparency. Each component can be from 1 to as many as 32 bits. In Mac OS X, Quartz also provides support for floating-point components. The supported formats in Mac OS X and iOS are described in â€œPixel formats supported for bitmap graphics contextsâ€. ColorSync provides color space support for bitmap images.</p>
</blockquote>
<p>Quartzåœ¨åˆ›å»ºä½å›¾å›¾åƒï¼ˆCGImageRefï¼‰æ—¶ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li><em>data source</em> ä½å›¾æ•°æ®æºï¼Œå¯ä»¥æ˜¯Quartzæ•°æ®æä¾›ç¨‹åºæˆ–Quartzå›¾åƒæºã€‚</li>
<li><em>Pixel Format</em> åƒç´ æ ¼å¼ï¼ŒåŒ…æ‹¬æ¯ä¸ªç»„ä»¶çš„ä½æ•°ï¼Œæ¯ä¸ªåƒç´ çš„ä½æ•°å’Œæ¯è¡Œçš„å­—èŠ‚æ•°ã€‚</li>
<li><em>Color Spaces and Bitmap Layout</em> å¯¹äºå›¾åƒï¼Œé¢œè‰²ç©ºé—´å’Œä½å›¾å¸ƒå±€ï¼ˆé¢œè‰²ç©ºé—´å’Œä½å›¾å¸ƒå±€ï¼‰ä¿¡æ¯ç”¨äºæè¿°alphaçš„ä½ç½®ä»¥åŠä½å›¾æ˜¯å¦ä½¿ç”¨æµ®ç‚¹å€¼ã€‚</li>
<li><em>Decode Array</em> å¯é€‰çš„è§£ç æ•°ç»„ã€‚</li>
<li>æ’å€¼è®¾ç½®ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå®ƒæŒ‡å®šåœ¨è°ƒæ•´å›¾åƒå¤§å°æ—¶ï¼ŒQuartzæ˜¯å¦åº”åº”ç”¨æ’å€¼ç®—æ³•ã€‚</li>
<li>ä¸€ä¸ªæ¸²æŸ“æ„å›¾ï¼ŒæŒ‡å®šå¦‚ä½•æ˜ å°„ä½äºå›¾å½¢ä¸Šä¸‹æ–‡çš„ç›®æ ‡é¢œè‰²ç©ºé—´å†…çš„é¢œè‰²ã€‚</li>
<li>å›¾åƒå°ºå¯¸ã€‚</li>
</ul>
<h3 id="è§£ç æ•°ç»„-Decode-Array"><a href="#è§£ç æ•°ç»„-Decode-Array" class="headerlink" title="è§£ç æ•°ç»„ Decode Array"></a>è§£ç æ•°ç»„ Decode Array</h3><p>è§£ç æ•°ç»„å°†å›¾åƒé¢œè‰²å€¼æ˜ å°„åˆ°å…¶ä»–é¢œè‰²å€¼ï¼Œè¿™å¯¹äºè¯¸å¦‚ä½¿å›¾åƒå»é¥±å’Œæˆ–åè½¬é¢œè‰²ä¹‹ç±»çš„ä»»åŠ¡å¾ˆæœ‰ç”¨ã€‚è¯¥æ•°ç»„åŒ…å«æ¯ä¸ªé¢œè‰²åˆ†é‡çš„ä¸€å¯¹æ•°å­—ã€‚Quartzæ¸²æŸ“å›¾åƒæ—¶ï¼Œå®ƒå°†åº”ç”¨çº¿æ€§å˜æ¢å°†åŸå§‹åˆ†é‡å€¼æ˜ å°„åˆ°é€‚åˆç›®æ ‡è‰²å½©ç©ºé—´çš„æŒ‡å®šèŒƒå›´å†…çš„ç›¸å¯¹æ•°å­—ã€‚ä¾‹å¦‚ï¼ŒRGBé¢œè‰²ç©ºé—´ä¸­å›¾åƒçš„è§£ç æ•°ç»„åŒ…å«å…­ä¸ªæ¡ç›®ï¼Œæ¯ä¸ªçº¢è‰²ï¼Œç»¿è‰²å’Œè“è‰²åˆ†é‡ä¸€å¯¹ã€‚</p>
<h3 id="åƒç´ æ ¼å¼Pixel-Format"><a href="#åƒç´ æ ¼å¼Pixel-Format" class="headerlink" title="åƒç´ æ ¼å¼Pixel Format"></a>åƒç´ æ ¼å¼Pixel Format</h3><p>åƒç´ æ ¼å¼åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li><em>Bits per component</em>æ¯ä¸ªåˆ†é‡çš„ä½æ•°ï¼Œå³åƒç´ ä¸­æ¯ä¸ªå•ç‹¬é¢œè‰²åˆ†é‡çš„ä½æ•°ã€‚å¯¹äºå›¾åƒæ©æ¨¡ï¼Œæ­¤å€¼æ˜¯æºåƒç´ ä¸­æœ‰æ•ˆæ©æ¨¡ä½çš„æ•°é‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæºå›¾åƒæ˜¯8ä½æ©ç ï¼Œåˆ™æ¯ä¸ªç»„ä»¶æŒ‡å®š8ä½ã€‚</li>
<li><em>Bits per pixel</em>æ¯ä¸ªåƒç´ çš„ä½æ•°ï¼Œå³æºåƒç´ çš„ä½æ•°ã€‚è¯¥å€¼å¿…é¡»è‡³å°‘æ˜¯æ¯ä¸ªç»„ä»¶çš„ä½æ•°ä¹˜ä»¥æ¯ä¸ªåƒç´ çš„ç»„ä»¶æ•°ã€‚</li>
<li><em>Bytes per row</em>æ¯è¡Œå­—èŠ‚æ•°ã€‚å›¾åƒä¸­æ¯æ°´å¹³è¡Œçš„å­—èŠ‚æ•°ã€‚</li>
</ul>
<h3 id="é¢œè‰²ä¸é¢œè‰²ç©ºé—´-Color-and-Color-Spaces"><a href="#é¢œè‰²ä¸é¢œè‰²ç©ºé—´-Color-and-Color-Spaces" class="headerlink" title="é¢œè‰²ä¸é¢œè‰²ç©ºé—´ Color and Color Spaces"></a>é¢œè‰²ä¸é¢œè‰²ç©ºé—´ Color and Color Spaces</h3><p><a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101" target="_blank" rel="noopener">Color and Color Spaces</a>ä¸­è¯´æ˜äº†Quartzä¸­çš„é¢œè‰²ç”±ä¸€ç»„å€¼è¡¨ç¤ºã€‚å¦‚æœæ²¡æœ‰é¢œè‰²ç©ºé—´æŒ‡ç¤ºå¦‚ä½•è§£é‡Šé¢œè‰²ä¿¡æ¯ï¼Œåˆ™è¿™äº›å€¼å°†æ¯«æ— æ„ä¹‰ã€‚ä¾‹å¦‚ï¼Œè¡¨4-1ä¸­çš„å€¼å…¨éƒ¨ä»£è¡¨å…¨å¼ºåº¦çš„è“è‰²ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸çŸ¥é“é¢œè‰²ç©ºé—´æˆ–æ¯ç§é¢œè‰²ç©ºé—´çš„å…è®¸å€¼èŒƒå›´ï¼Œå°±æ— æ³•çŸ¥é“æ¯ç»„å€¼ä»£è¡¨å“ªç§é¢œè‰²ã€‚</p>
<p>è¡¨4-1   ä¸åŒé¢œè‰²ç©ºé—´ä¸­çš„é¢œè‰²å€¼</p>
<table>
<thead>
<tr>
<th style="text-align:left">values</th>
<th style="text-align:center">color space</th>
<th style="text-align:right">compoents</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">240 degrees, 100%, 100%</td>
<td style="text-align:center">HSB</td>
<td style="text-align:right">Hue, saturation, brightness</td>
</tr>
<tr>
<td style="text-align:left">0, 0, 1</td>
<td style="text-align:center">RGB</td>
<td style="text-align:right">Red, green, blue</td>
</tr>
<tr>
<td style="text-align:left">1, 1, 0, 0</td>
<td style="text-align:center">CMYK</td>
<td style="text-align:right">Cyan, magenta, yellow, black</td>
</tr>
<tr>
<td style="text-align:left">1, 0, 0</td>
<td style="text-align:center">BGR</td>
<td style="text-align:right">Blue, green, red</td>
</tr>
</tbody>
</table>
<p>å¦‚æœæä¾›é”™è¯¯çš„è‰²å½©ç©ºé—´ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°å¾ˆå¤§çš„å·®å¼‚ï¼Œå¦‚å›¾4-1æ‰€ç¤ºã€‚å°½ç®¡ç»¿è‰²åœ¨BGRå’ŒRGBé¢œè‰²ç©ºé—´ä¸­çš„è§£é‡Šç›¸åŒï¼Œä½†æ˜¯çº¢è‰²å’Œè“è‰²å€¼å´è¢«ç¿»è½¬äº†ã€‚</p>
<p><img src="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Art/color_profiles.gif" alt></p>
<h3 id="ä½å›¾å¸ƒå±€-Bitmap-Layout"><a href="#ä½å›¾å¸ƒå±€-Bitmap-Layout" class="headerlink" title="ä½å›¾å¸ƒå±€ Bitmap Layout"></a>ä½å›¾å¸ƒå±€ Bitmap Layout</h3><p>æƒ³ç¡®ä¿ Quartz èƒ½å¤Ÿæ­£ç¡®åœ°è§£æåƒç´ æ ¼å¼ä¸­å„ä¸ªbitæ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›ä½å›¾çš„å¸ƒå±€ä¿¡æ¯ <code>CGBitmapInfo</code> ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_OPTIONS</span>(uint32_t, <span class="built_in">CGBitmapInfo</span>) &#123;</span><br><span class="line">    kCGBitmapAlphaInfoMask = <span class="number">0x1F</span>,</span><br><span class="line"></span><br><span class="line">    kCGBitmapFloatInfoMask = <span class="number">0xF00</span>,</span><br><span class="line">    kCGBitmapFloatComponents = (<span class="number">1</span> &lt;&lt; <span class="number">8</span>),</span><br><span class="line"></span><br><span class="line">    kCGBitmapByteOrderMask     = kCGImageByteOrderMask,</span><br><span class="line">    kCGBitmapByteOrderDefault  = kCGImageByteOrderDefault,</span><br><span class="line">    kCGBitmapByteOrder16Little = kCGImageByteOrder16Little,</span><br><span class="line">    kCGBitmapByteOrder32Little = kCGImageByteOrder32Little,</span><br><span class="line">    kCGBitmapByteOrder16Big    = kCGImageByteOrder16Big,</span><br><span class="line">    kCGBitmapByteOrder32Big    = kCGImageByteOrder32Big</span><br><span class="line">&#125; <span class="built_in">CG_AVAILABLE_STARTING</span>(<span class="number">10.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<p>å®ƒä¸»è¦æä¾›äº†ä¸‰ä¸ªæ–¹é¢çš„å¸ƒå±€ä¿¡æ¯ï¼š</p>
<ul>
<li>alpha çš„ä¿¡æ¯ CGImageAlphaInfoï¼›</li>
<li>é¢œè‰²åˆ†é‡æ˜¯å¦ä¸ºæµ®ç‚¹æ•°ï¼›</li>
<li>åƒç´ æ ¼å¼çš„å­—èŠ‚é¡ºåº Byte Orderingã€‚</li>
</ul>
<h4 id="é€æ˜ä¿¡æ¯-CGImageAlphaInfo"><a href="#é€æ˜ä¿¡æ¯-CGImageAlphaInfo" class="headerlink" title="é€æ˜ä¿¡æ¯ CGImageAlphaInfo"></a>é€æ˜ä¿¡æ¯ CGImageAlphaInfo</h4><p>å…¶ä¸­ï¼Œalpha çš„ä¿¡æ¯ç”±æšä¸¾å€¼ CGImageAlphaInfo æ¥è¡¨ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_ENUM</span>(uint32_t, <span class="built_in">CGImageAlphaInfo</span>) &#123;</span><br><span class="line">    kCGImageAlphaNone,               <span class="comment">/* For example, RGB. */</span></span><br><span class="line">    kCGImageAlphaPremultipliedLast,  <span class="comment">/* For example, premultiplied RGBA */</span></span><br><span class="line">    kCGImageAlphaPremultipliedFirst, <span class="comment">/* For example, premultiplied ARGB */</span></span><br><span class="line">    kCGImageAlphaLast,               <span class="comment">/* For example, non-premultiplied RGBA */</span></span><br><span class="line">    kCGImageAlphaFirst,              <span class="comment">/* For example, non-premultiplied ARGB */</span></span><br><span class="line">    kCGImageAlphaNoneSkipLast,       <span class="comment">/* For example, RBGX. */</span></span><br><span class="line">    kCGImageAlphaNoneSkipFirst,      <span class="comment">/* For example, XRGB. */</span></span><br><span class="line">    kCGImageAlphaOnly                <span class="comment">/* No color data, alpha data only */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ³¨é‡Šå…¶å®å·²ç»æ¯”è¾ƒæ¸…æ¥šäº†ï¼Œå®ƒåŒæ ·ä¹Ÿæä¾›äº†ä¸‰ä¸ªæ–¹é¢çš„ alpha ä¿¡æ¯ï¼š</p>
<ul>
<li>æ˜¯å¦åŒ…å« alpha ï¼›</li>
<li>å¦‚æœåŒ…å« alpha ï¼Œé‚£ä¹ˆ alpha ä¿¡æ¯æ‰€å¤„çš„ä½ç½®ï¼Œåœ¨åƒç´ çš„æœ€ä½æœ‰æ•ˆä½ï¼Œæ¯”å¦‚ RGBA ï¼Œè¿˜æ˜¯æœ€é«˜æœ‰æ•ˆä½ï¼Œæ¯”å¦‚ ARGB ï¼›</li>
<li>å¦‚æœåŒ…å« alpha ï¼Œé‚£ä¹ˆæ¯ä¸ªé¢œè‰²åˆ†é‡æ˜¯å¦å·²ç»ä¹˜ä»¥ alpha çš„å€¼ï¼Œè¿™ç§åšæ³•å¯ä»¥åŠ é€Ÿå›¾ç‰‡çš„æ¸²æŸ“æ—¶é—´ï¼Œå› ä¸ºå®ƒé¿å…äº†æ¸²æŸ“æ—¶çš„é¢å¤–ä¹˜æ³•è¿ç®—ã€‚æ¯”å¦‚ï¼Œå¯¹äº RGB é¢œè‰²ç©ºé—´ï¼Œç”¨å·²ç»ä¹˜ä»¥ alpha çš„æ•°æ®æ¥æ¸²æŸ“å›¾ç‰‡ï¼Œæ¯ä¸ªåƒç´ éƒ½å¯ä»¥é¿å… 3 æ¬¡ä¹˜æ³•è¿ç®—ï¼Œçº¢è‰²ä¹˜ä»¥ alpha ï¼Œç»¿è‰²ä¹˜ä»¥ alpha å’Œè“è‰²ä¹˜ä»¥ alpha ã€‚</li>
</ul>
<h4 id="å­—èŠ‚é¡ºåº-CGImageByteOrderInfo"><a href="#å­—èŠ‚é¡ºåº-CGImageByteOrderInfo" class="headerlink" title="å­—èŠ‚é¡ºåº CGImageByteOrderInfo"></a>å­—èŠ‚é¡ºåº CGImageByteOrderInfo</h4><p>å­—èŠ‚çš„æ’åˆ—æ–¹å¼æœ‰ä¸¤ä¸ªé€šç”¨è§„åˆ™ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤šä½çš„æ•´æ•°ï¼ŒæŒ‰ç…§å­˜å‚¨åœ°å€ä»ä½åˆ°é«˜æ’åºçš„å­—èŠ‚ä¸­ï¼Œå¦‚æœè¯¥æ•´æ•°çš„æœ€ä½æœ‰æ•ˆå­—èŠ‚ï¼ˆç±»ä¼¼äºæœ€ä½æœ‰æ•ˆä½ï¼‰åœ¨æœ€é«˜æœ‰æ•ˆå­—èŠ‚çš„å‰é¢ï¼Œåˆ™ç§°å°ç«¯åºï¼›åä¹‹åˆ™ç§°å¤§ç«¯åºã€‚</p>
<p><a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFMemoryMgmt/Concepts/ByteOrdering.html#//apple_ref/doc/uid/20001150-CJBEJBHH" target="_blank" rel="noopener">å­—èŠ‚é¡ºåº</a>çš„ä¿¡æ¯ç”±æšä¸¾å€¼ CGImageByteOrderInfo æ¥è¡¨ç¤ºï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">CF_ENUM</span>(uint32_t, <span class="built_in">CGImageByteOrderInfo</span>) &#123;</span><br><span class="line">    kCGImageByteOrderMask     = <span class="number">0x7000</span>,</span><br><span class="line">    kCGImageByteOrder16Little = (<span class="number">1</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder32Little = (<span class="number">2</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder16Big    = (<span class="number">3</span> &lt;&lt; <span class="number">12</span>),</span><br><span class="line">    kCGImageByteOrder32Big    = (<span class="number">4</span> &lt;&lt; <span class="number">12</span>)</span><br><span class="line">&#125; <span class="built_in">CG_AVAILABLE_STARTING</span>(__MAC_10_12, __IPHONE_10_0);</span><br></pre></td></tr></table></figure>
<p>å®ƒä¸»è¦æä¾›äº†ä¸¤ä¸ªæ–¹é¢çš„å­—èŠ‚é¡ºåºä¿¡æ¯ï¼š</p>
<ul>
<li>å°ç«¯åºè¿˜æ˜¯å¤§ç«¯åºï¼›</li>
<li>æ•°æ®ä»¥ 16 ä½è¿˜æ˜¯ 32 ä½ä¸ºå•ä½ã€‚</li>
</ul>
<p>ä¸‹å›¾è¡¨ç¤ºäº† Quartz 2Dä¸­CMYKå’ŒRGBé¢œè‰²ç©ºé—´çš„32ä½å’Œ16ä½åƒç´ æ ¼å¼<br><img src="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/Art/colorformatrgba32.gif" alt></p>
<h3 id="æ”¯æŒçš„åƒç´ æ ¼å¼"><a href="#æ”¯æŒçš„åƒç´ æ ¼å¼" class="headerlink" title="æ”¯æŒçš„åƒç´ æ ¼å¼"></a>æ”¯æŒçš„åƒç´ æ ¼å¼</h3><p>ä¸‹è¡¨è¡¨ç¤ºäº†ä½å›¾å›¾å½¢ä¸Šä¸‹æ–‡æ”¯æŒçš„åƒç´ æ ¼å¼ï¼Œå…³è”çš„è‰²å½©ç©ºé—´ <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB" target="_blank" rel="noopener">Supported Pixel Formats</a>ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">cs</th>
<th style="text-align:center">Pixel format and bitmap information constant</th>
<th style="text-align:right">Availability</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Null</td>
<td style="text-align:center">8 bpp, 8 bpc, kCGImageAlphaOnly</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">Gray</td>
<td style="text-align:center">8 bpp, 8 bpc,kCGImageAlphaNone</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">Gray</td>
<td style="text-align:center">8 bpp, 8 bpc,kCGImageAlphaOnly</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">Gray</td>
<td style="text-align:center">16 bpp, 16 bpc, kCGImageAlphaNone</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">Gray</td>
<td style="text-align:center">32 bpp, 32 bpc, kCGImageAlphaNoneæˆ–kCGBitmapFloatComponents`</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">16 bpp, 5 bpc, kCGImageAlphaNoneSkipFirst</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNoneSkipFirst</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNoneSkipLast</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaPremultipliedFirst</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaPremultipliedLast</td>
<td style="text-align:right">Mac OS X, iOS</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaPremultipliedLast</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaNoneSkipLast</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaNoneSkipLast æˆ–kCGBitmapFloatComponents</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">RGB</td>
<td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaPremultipliedLast æˆ–kCGBitmapFloatComponents</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">CMYK</td>
<td style="text-align:center">32 bpp, 8 bpc, kCGImageAlphaNone</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">CMYK</td>
<td style="text-align:center">64 bpp, 16 bpc, kCGImageAlphaNone</td>
<td style="text-align:right">Mac OS X</td>
</tr>
<tr>
<td style="text-align:left">CMYK</td>
<td style="text-align:center">128 bpp, 32 bpc, kCGImageAlphaNone æˆ–kCGBitmapFloatComponents</td>
<td style="text-align:right">Mac OS X</td>
</tr>
</tbody>
</table>
<p>å¯¹äº iOS æ¥è¯´ï¼Œåªæ”¯æŒ 8 ç§åƒç´ æ ¼å¼ã€‚å…¶ä¸­é¢œè‰²ç©ºé—´ä¸º Null çš„ 1 ç§ï¼ŒGray çš„ 2 ç§ï¼ŒRGB çš„ 5 ç§ï¼ŒCMYK çš„ 0 ç§ã€‚æ¢å¥è¯è¯´ï¼ŒiOS å¹¶ä¸æ”¯æŒ CMYK çš„é¢œè‰²ç©ºé—´</p>
<h2 id="CGBitmapContextCreate"><a href="#CGBitmapContextCreate" class="headerlink" title="CGBitmapContextCreate"></a>CGBitmapContextCreate</h2><p>ä¸Šé¢è¯´äº†è¿™ä¹ˆå¤šå‚æ•°ï¼Œé‚£ä¹ˆé‚£ä¸ªå‡½æ•°ä¼šç”¨åˆ°å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ <code>CGBitmapContextCreate</code> :</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Create a bitmap context. The context draws into a bitmap which is `width'</span></span><br><span class="line"><span class="comment">   pixels wide and `height' pixels high. The number of components for each</span></span><br><span class="line"><span class="comment">   pixel is specified by `space', which may also specify a destination color</span></span><br><span class="line"><span class="comment">   profile. The number of bits for each component of a pixel is specified by</span></span><br><span class="line"><span class="comment">   `bitsPerComponent'. The number of bytes per pixel is equal to</span></span><br><span class="line"><span class="comment">   `(bitsPerComponent * number of components + 7)/8'. Each row of the bitmap</span></span><br><span class="line"><span class="comment">   consists of `bytesPerRow' bytes, which must be at least `width * bytes</span></span><br><span class="line"><span class="comment">   per pixel' bytes; in addition, `bytesPerRow' must be an integer multiple</span></span><br><span class="line"><span class="comment">   of the number of bytes per pixel. `data', if non-NULL, points to a block</span></span><br><span class="line"><span class="comment">   of memory at least `bytesPerRow * height' bytes. If `data' is NULL, the</span></span><br><span class="line"><span class="comment">   data for context is allocated automatically and freed when the context is</span></span><br><span class="line"><span class="comment">   deallocated. `bitmapInfo' specifies whether the bitmap should contain an</span></span><br><span class="line"><span class="comment">   alpha channel and how it's to be generated, along with whether the</span></span><br><span class="line"><span class="comment">   components are floating-point or integer. */</span></span><br><span class="line"><span class="built_in">CG_EXTERN</span> <span class="built_in">CGContextRef</span> __<span class="keyword">nullable</span> <span class="built_in">CGBitmapContextCreate</span>(<span class="keyword">void</span> * __<span class="keyword">nullable</span> data,</span><br><span class="line">    size_t width, size_t height, size_t bitsPerComponent, size_t bytesPerRow,</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> cg_nullable space, uint32_t bitmapInfo)</span><br><span class="line">    <span class="built_in">CG_AVAILABLE_STARTING</span>(__MAC_10_0, __IPHONE_2_0);</span><br></pre></td></tr></table></figure>
<p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä½å›¾ä¸Šä¸‹æ–‡ï¼Œç”¨æ¥ç»˜åˆ¶ä¸€å¼ å®½ width åƒç´ ï¼Œé«˜ height åƒç´ çš„ä½å›¾ã€‚å„å‚æ•°ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<ul>
<li>data ï¼šå¦‚æœä¸ä¸º NULL ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æŒ‡å‘ä¸€å—å¤§å°è‡³å°‘ä¸º bytesPerRow * height å­—èŠ‚çš„å†…å­˜ï¼›å¦‚æœ ä¸º NULL ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾æ‰€éœ€çš„å†…å­˜ï¼Œæ‰€ä»¥ä¸€èˆ¬æŒ‡å®š NULL å³å¯ï¼›</li>
<li>width å’Œ height ï¼šä½å›¾çš„å®½åº¦å’Œé«˜åº¦ï¼Œåˆ†åˆ«èµ‹å€¼ä¸ºå›¾ç‰‡çš„åƒç´ å®½åº¦å’Œåƒç´ é«˜åº¦å³å¯ï¼›</li>
<li>bitsPerComponent ï¼šåƒç´ çš„æ¯ä¸ªé¢œè‰²åˆ†é‡ä½¿ç”¨çš„ bit æ•°ï¼Œåœ¨ RGB é¢œè‰²ç©ºé—´ä¸‹æŒ‡å®š 8 å³å¯ï¼›</li>
<li>bytesPerPixelï¼šè¡¨ç¤ºä¸€ä¸ªåƒç´ ç‚¹æœ‰å¤šå°‘ä¸ªå­—èŠ‚ç»„æˆï¼Œä¸Šé¢çš„æ–¹æ³•æ³¨é‡Šä¸­æåˆ°äº†ä¸€ä¸ªå…¬å¼ <code>(bitsPerComponent * number of components + 7)/8</code>ï¼Œå³ä¸€ä¸ªåƒç´ ç‚¹çš„å­—èŠ‚æ•°é‡ä¸è¡¨ç¤ºå½“å‰å›¾åƒçš„é¢œè‰²çš„é¢œè‰²åˆ†é‡æ•°é‡å’Œæ¯ä¸ªåˆ†é‡çš„ä½æ•°æœ‰å…³</li>
<li>bytesPerRow ï¼šä½å›¾çš„æ¯ä¸€è¡Œä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¤§å°è‡³å°‘ä¸º width * bytes per pixel å­—èŠ‚ã€‚æœ‰æ„æ€çš„æ˜¯ï¼Œå½“æˆ‘ä»¬æŒ‡å®š 0 æ—¶ï¼Œç³»ç»Ÿä¸ä»…ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨è®¡ç®—ï¼Œè€Œä¸”è¿˜ä¼šè¿›è¡Œ cache line alignment çš„ä¼˜åŒ–</li>
<li>space ï¼šå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„é¢œè‰²ç©ºé—´ï¼Œä¸€èˆ¬ä½¿ç”¨ RGB å³å¯ï¼›</li>
<li>bitmapInfo ï¼šå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„ä½å›¾çš„å¸ƒå±€ä¿¡æ¯ã€‚</li>
</ul>
<p>æ–‡ç« å¼€å¤´è¯´ <code>è§£å‹ç¼©åçš„å›¾ç‰‡å¤§å° = å›¾ç‰‡çš„åƒç´ å®½ 34 * å›¾ç‰‡çš„åƒç´ é«˜ 34 * æ¯ä¸ªåƒç´ æ‰€å çš„å­—èŠ‚æ•°4</code> ; æˆ‘ä»¬çš„æ‰‹æœºä¸€èˆ¬æ”¯æŒ RGB é¢œè‰²ç©ºé—´ï¼Œç°åœ¨å°±æ˜¯çŸ¥é“äº† RGB é¢œè‰²ç©ºé—´ä¸­ï¼Œå®é™…ä¸Šæ˜¯æœ‰ 4 ä¸ªåˆ†é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®—å‡º bytesPerPixel = (8 * 4 + 7)/8 = 4Bã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆæœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬è®¡ç®—ä½å›¾çš„å¤§å°çš„æ—¶å€™ï¼Œæ¯ä¸ªåƒç´ çš„å¤§å°æˆ‘ä»¬ä½¿ç”¨çš„å€¼æ˜¯ 4B äº†ã€‚äº‹å®ä¸Šä¸åŒçš„é¢œè‰²ç©ºé—´ä¸‹ï¼Œä¸Šé¢è¿™äº›å€¼éƒ½æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯ä¸€èˆ¬åœ¨æ‰‹æœºä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨ RGB é¢œè‰²ç©ºé—´ï¼Œæ‰€ä»¥å·®ä¸å¤šå°±æ˜¯ä¸Šé¢çš„å€¼ã€‚</p>
<h3 id="YYImageä¸­ä½¿ç”¨"><a href="#YYImageä¸­ä½¿ç”¨" class="headerlink" title="YYImageä¸­ä½¿ç”¨"></a>YYImageä¸­ä½¿ç”¨</h3><p>ç°åœ¨æ¥çœ‹ä¸‹YYImageä¸­çš„è§£ç ä»£ç  ï¼Œå…ˆä½¿ç”¨ <code>CGBitmapContextCreate</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªä½å›¾ä¸Šä¸‹æ–‡ï¼›å†ç”¨ <code>CGContextDrawImage</code> å‡½æ•°å°†åŸå§‹ä½å›¾ç»˜åˆ¶åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼›æœ€åä½¿ç”¨ <code>CGBitmapContextCreateImage</code> å‡½æ•°åˆ›å»ºä¸€å¼ æ–°çš„è§£å‹ç¼©åçš„ä½å›¾ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">CGImageRef</span> YYCGImageCreateDecodedCopy(<span class="built_in">CGImageRef</span> imageRef, <span class="built_in">BOOL</span> decodeForDisplay) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (decodeForDisplay) &#123; <span class="comment">//decode with redraw (may lose some precision)</span></span><br><span class="line">        <span class="built_in">CGImageAlphaInfo</span> alphaInfo = <span class="built_in">CGImageGetAlphaInfo</span>(imageRef) &amp; kCGBitmapAlphaInfoMask;</span><br><span class="line">        <span class="built_in">BOOL</span> hasAlpha = <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">if</span> (alphaInfo == kCGImageAlphaPremultipliedLast ||</span><br><span class="line">            alphaInfo == kCGImageAlphaPremultipliedFirst ||</span><br><span class="line">            alphaInfo == kCGImageAlphaLast ||</span><br><span class="line">            alphaInfo == kCGImageAlphaFirst) &#123;</span><br><span class="line">            hasAlpha = <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// BGRA8888 (premultiplied) or BGRX8888</span></span><br><span class="line">        <span class="comment">// same as UIGraphicsBeginImageContext() and -[UIView drawRect:]</span></span><br><span class="line">        <span class="built_in">CGBitmapInfo</span> bitmapInfo = kCGBitmapByteOrder32Host;</span><br><span class="line">        bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;</span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>, width, height, <span class="number">8</span>, <span class="number">0</span>, YYCGColorSpaceGetDeviceRGB(), bitmapInfo);</span><br><span class="line">        <span class="keyword">if</span> (!context) <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), imageRef); <span class="comment">// decode</span></span><br><span class="line">        <span class="built_in">CGImageRef</span> newImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">        <span class="built_in">CFRelease</span>(context);</span><br><span class="line">        <span class="keyword">return</span> newImage;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SDWebImageä¸­ä½¿ç”¨"><a href="#SDWebImageä¸­ä½¿ç”¨" class="headerlink" title="SDWebImageä¸­ä½¿ç”¨"></a>SDWebImageä¸­ä½¿ç”¨</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)decodedImageWithImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="keyword">if</span> (![<span class="built_in">UIImage</span> shouldDecodeImage:image]) &#123;</span><br><span class="line">        <span class="keyword">return</span> image;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// autorelease the bitmap context and all vars to help system to free memory when there are memory warning.</span></span><br><span class="line">    <span class="comment">// on iOS7, do not forget to call [[SDImageCache sharedImageCache] clearMemory];</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGImageRef</span> imageRef = image.CGImage;</span><br><span class="line">        <span class="built_in">CGColorSpaceRef</span> colorspaceRef = [<span class="built_in">UIImage</span> colorSpaceForImageRef:imageRef];</span><br><span class="line">        </span><br><span class="line">        size_t width = <span class="built_in">CGImageGetWidth</span>(imageRef);</span><br><span class="line">        size_t height = <span class="built_in">CGImageGetHeight</span>(imageRef);</span><br><span class="line">        size_t bytesPerRow = kBytesPerPixel * width;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// kCGImageAlphaNone is not supported in CGBitmapContextCreate.</span></span><br><span class="line">        <span class="comment">// Since the original image here has no alpha info, use kCGImageAlphaNoneSkipLast</span></span><br><span class="line">        <span class="comment">// to create bitmap graphics contexts without alpha info.</span></span><br><span class="line">        <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>,</span><br><span class="line">                                                     width,</span><br><span class="line">                                                     height,</span><br><span class="line">                                                     kBitsPerComponent,</span><br><span class="line">                                                     bytesPerRow,</span><br><span class="line">                                                     colorspaceRef,</span><br><span class="line">                                                     kCGBitmapByteOrderDefault|kCGImageAlphaNoneSkipLast);</span><br><span class="line">        <span class="keyword">if</span> (context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> image;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Draw the image into the context and retrieve the new bitmap image without alpha</span></span><br><span class="line">        <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, width, height), imageRef);</span><br><span class="line">        <span class="built_in">CGImageRef</span> imageRefWithoutAlpha = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">        <span class="built_in">UIImage</span> *imageWithoutAlpha = [<span class="built_in">UIImage</span> imageWithCGImage:imageRefWithoutAlpha</span><br><span class="line">                                                         scale:image.scale</span><br><span class="line">                                                   orientation:image.imageOrientation];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">        <span class="built_in">CGImageRelease</span>(imageRefWithoutAlpha);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> imageWithoutAlpha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)shouldDecodeImage:(<span class="keyword">nullable</span> <span class="built_in">UIImage</span> *)image &#123;</span><br><span class="line">    <span class="comment">// Prevent "CGBitmapContextCreateImage: invalid context 0x0" error</span></span><br><span class="line">    <span class="keyword">if</span> (image == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// do not decode animated images</span></span><br><span class="line">    <span class="keyword">if</span> (image.images != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRef</span> imageRef = image.CGImage;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageAlphaInfo</span> alpha = <span class="built_in">CGImageGetAlphaInfo</span>(imageRef);</span><br><span class="line">    <span class="built_in">BOOL</span> anyAlpha = (alpha == kCGImageAlphaFirst ||</span><br><span class="line">                     alpha == kCGImageAlphaLast ||</span><br><span class="line">                     alpha == kCGImageAlphaPremultipliedFirst ||</span><br><span class="line">                     alpha == kCGImageAlphaPremultipliedLast);</span><br><span class="line">    <span class="comment">// do not decode images with alpha</span></span><br><span class="line">    <span class="keyword">if</span> (anyAlpha) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SDWebImage ä¸­å’Œå…¶ä»–ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œå°±æ˜¯å¦‚æœä¸€å¼ å›¾ç‰‡æœ‰ alpha åˆ†é‡ï¼Œé‚£å°±ç›´æ¥è¿”å›åŸå§‹å›¾ç‰‡ï¼Œä¸å†è¿›è¡Œè§£ç æ“ä½œã€‚æˆ‘çŒœæµ‹ä½œè€…è¿™æ ·å†™ï¼Œæ˜¯ä¸æ˜¯å› ä¸ºè§‰å¾—å¯¹äºæœ‰ alpha åˆ†é‡çš„å›¾ç‰‡ï¼Œå› ä¸ºä¸Šä¸‹æ–‡åˆ›å»ºä¸­é‚£äº›å‚æ•°çš„ç¼˜æ•…ï¼Œè§£ç ä¹‹åå¯èƒ½ä¼šä¸åŸå§‹å›¾åƒæœ‰åå·®ï¼Œå¹²è„†å°±ä¸è§£ç äº†ã€‚</p>
<p>SDWebImage åœ¨è§£ç æ“ä½œå¤–é¢åŒ…äº† autoreleasepoolï¼Œè¿™æ ·åœ¨å¤§é‡å›¾ç‰‡éœ€è¦è§£ç çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿å¾—å±€éƒ¨å˜é‡å°½æ—©é‡Šæ”¾æ‰ï¼Œä¸ä¼šé€ æˆå†…å­˜å³°å€¼è¿‡é«˜ã€‚å…¶ä»–åˆ›å»ºä¸Šä¸‹æ–‡ï¼Œç„¶åè°ƒç”¨ CGContextDrawImageï¼Œå†è°ƒç”¨CGBitmapContextCreateImageè·å–åˆ›å»ºåçš„ä½å›¾ï¼Œå’Œ YYImage åŸºæœ¬ä¸€æ ·ï¼Œå°±æ˜¯ä¸ªåˆ«å‚æ•°è®¾ç½®ä¸åŒã€‚</p>
]]></content>
      <categories>
        <category>iOSå›¾ç‰‡</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>å›¾ç‰‡</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•</title>
    <url>/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E5%9B%BE%E7%89%87%E7%BC%A9%E7%95%A5%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»ä¸‹åœ¨iOSä¸­çš„å¤šç§å›¾ç‰‡ç¼©ç•¥æ–¹å¼<br>ref <a href="https://nshipster.com/image-resizing/" target="_blank" rel="noopener">https://nshipster.com/image-resizing/</a></p>
</blockquote>
<p>åœ¨<code>UIKit CoreGraphics ImageIO CoreImage vImage</code>å¤šç§ç¼©ç•¥æ–¹æ³•ä¸­ Core Imageè¡¨ç°æœ€å·®ã€‚Core Graphics å’Œ Image I/Oæœ€å¥½ã€‚</p>
<p>å®é™…ä¸Šï¼Œåœ¨è‹¹æœå®˜æ–¹åœ¨ <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_performance/ci_performance.html#//apple_ref/doc/uid/TP30001185-CH10-SW1" target="_blank" rel="noopener">Performance Best Practices section of the Core Image Programming Guide</a> éƒ¨åˆ†ä¸­ç‰¹åˆ«æ¨èä½¿ç”¨Core Graphicsæˆ–Image I / OåŠŸèƒ½é¢„å…ˆè£å‰ªæˆ–ç¼©å°å›¾åƒã€‚</p>
<a id="more"></a>
<h3 id="UIKit"><a href="#UIKit" class="headerlink" title="UIKit"></a>UIKit</h3><p>UIGraphicsBeginImageContextWithOptions &amp; UIImage -drawInRect:</p>
<p>ç”¨äºå›¾åƒå¤§å°è°ƒæ•´çš„æœ€é«˜çº§APIå¯ä»¥åœ¨UIKitæ¡†æ¶ä¸­æ‰¾åˆ°ã€‚ç»™å®šä¸€ä¸ªUIImageï¼Œå¯ä»¥ä½¿ç”¨ä¸´æ—¶å›¾å½¢ä¸Šä¸‹æ–‡æ¥æ¸²æŸ“ç¼©æ”¾ç‰ˆæœ¬ã€‚è¿™ç§æ–¹å¼æœ€ç®€</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func uikit_resize(oriImg:<span class="built_in">UIImage</span>?,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    let hasAlpha = <span class="literal">false</span></span><br><span class="line">    let scale: <span class="built_in">CGFloat</span> = <span class="number">0.0</span> <span class="comment">// Automatically use scale factor of main screen</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     åˆ›å»ºä¸€ä¸ªå›¾ç‰‡ç±»å‹çš„ä¸Šä¸‹æ–‡ã€‚è°ƒç”¨UIGraphicsBeginImageContextWithOptionså‡½æ•°å°±å¯è·å¾—ç”¨æ¥å¤„ç†å›¾ç‰‡çš„å›¾å½¢ä¸Šä¸‹æ–‡ã€‚åˆ©ç”¨è¯¥ä¸Šä¸‹æ–‡ï¼Œä½ å°±å¯ä»¥åœ¨å…¶ä¸Šè¿›è¡Œç»˜å›¾ï¼Œå¹¶ç”Ÿæˆå›¾ç‰‡</span></span><br><span class="line"><span class="comment">     sizeï¼šè¡¨ç¤ºæ‰€è¦åˆ›å»ºçš„å›¾ç‰‡çš„å°ºå¯¸</span></span><br><span class="line"><span class="comment">     opaqueï¼šè¡¨ç¤ºè¿™ä¸ªå›¾å±‚æ˜¯å¦å®Œå…¨é€æ˜ï¼Œå¦‚æœå›¾å½¢å®Œå…¨ä¸ç”¨é€æ˜æœ€å¥½è®¾ç½®ä¸ºYESä»¥ä¼˜åŒ–ä½å›¾çš„å­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥è®©å›¾å±‚åœ¨æ¸²æŸ“çš„æ—¶å€™æ•ˆç‡æ›´é«˜</span></span><br><span class="line"><span class="comment">     scaleï¼šæŒ‡å®šç”Ÿæˆå›¾ç‰‡çš„ç¼©æ”¾å› å­ï¼Œè¿™ä¸ªç¼©æ”¾å› å­ä¸UIImageçš„scaleå±æ€§æ‰€æŒ‡çš„å«ä¹‰æ˜¯ä¸€è‡´çš„ã€‚ä¼ å…¥0åˆ™è¡¨ç¤ºè®©å›¾ç‰‡çš„ç¼©æ”¾å› å­æ ¹æ®å±å¹•çš„åˆ†è¾¨ç‡è€Œå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°çš„å›¾ç‰‡ä¸ç®¡æ˜¯åœ¨å•åˆ†è¾¨ç‡è¿˜æ˜¯è§†ç½‘è†œå±ä¸Šçœ‹èµ·æ¥éƒ½ä¼šå¾ˆå¥½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, !hasAlpha, scale)</span><br><span class="line">    oriImg!.draw(<span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    let resizedImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>()</span><br><span class="line">    <span class="keyword">return</span> resizedImage!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//in iOS 10 UIGraphicsImageRenderer</span></span><br><span class="line"><span class="comment">//    let render  = UIGraphicsImageRenderer(size: size)</span></span><br><span class="line"><span class="comment">//    return render.image(actions: &#123; (context) in</span></span><br><span class="line"><span class="comment">//        oriImg?.draw(in: CGRect(origin: .zero, size: size))</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CoreGraphics"><a href="#CoreGraphics" class="headerlink" title="CoreGraphics"></a>CoreGraphics</h3><p> CGBitmapContextCreate &amp; CGContextDrawImage</p>
<p> CoreGraphics / Quartz 2Dæä¾›äº†ä¸€å¥—è¾ƒä½çº§åˆ«çš„APIï¼Œå…è®¸è¿›è¡Œæ›´é«˜çº§çš„é…ç½®ã€‚ ç»™å®šä¸€ä¸ªCGImageï¼Œä½¿ç”¨ä¸´æ—¶ä½å›¾ä¸Šä¸‹æ–‡æ¥æ¸²æŸ“ç¼©æ”¾åçš„å›¾åƒã€‚<br> ä½¿ç”¨CoreGraphicså›¾åƒçš„è´¨é‡ä¸UIKitå›¾åƒç›¸åŒã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func coreGraphics_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>)-&gt;<span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    let bitsPerComponent = cgImage.bitsPerComponent</span><br><span class="line">    let bytesPerRow = cgImage.bytesPerRow</span><br><span class="line">    let colorSpace = cgImage.colorSpace</span><br><span class="line">    let bitmapInfo = cgImage.bitmapInfo</span><br><span class="line">    </span><br><span class="line">    let context = <span class="built_in">CGContext</span>(data: <span class="literal">nil</span>,</span><br><span class="line">                                  width: Int(size.width),</span><br><span class="line">                                  height: Int(size.height),</span><br><span class="line">                                  bitsPerComponent: bitsPerComponent,</span><br><span class="line">                                  bytesPerRow: bytesPerRow,</span><br><span class="line">                                  space: colorSpace!,</span><br><span class="line">                                  bitmapInfo: bitmapInfo.rawValue)</span><br><span class="line">    </span><br><span class="line">    context?.interpolationQuality = .high</span><br><span class="line">    </span><br><span class="line">    context?.draw(cgImage, <span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    guard let resizedImage = context?.makeImage() <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: resizedImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ImageIO"><a href="#ImageIO" class="headerlink" title="ImageIO"></a>ImageIO</h3><p> CGImageSourceCreateThumbnailAtIndex</p>
<p> Image I / Oæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ä½†é²œä¸ºäººçŸ¥çš„ç”¨äºå¤„ç†å›¾åƒçš„æ¡†æ¶ã€‚ ç‹¬ç«‹äºCore Graphicsï¼Œå®ƒå¯ä»¥åœ¨è®¸å¤šä¸åŒæ ¼å¼ä¹‹é—´è¯»å–å’Œå†™å…¥ï¼Œè®¿é—®ç…§ç‰‡å…ƒæ•°æ®ä»¥åŠæ‰§è¡Œå¸¸è§çš„å›¾åƒå¤„ç†æ“ä½œã€‚ è¿™ä¸ªåº“æä¾›äº†è¯¥å¹³å°ä¸Šæœ€å¿«çš„å›¾åƒç¼–ç å™¨å’Œè§£ç å™¨ï¼Œå…·æœ‰å…ˆè¿›çš„ç¼“å­˜æœºåˆ¶ï¼Œç”šè‡³å¯ä»¥é€æ­¥åŠ è½½å›¾åƒ</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func imageIO_resize(url:URL,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    let options: [<span class="built_in">CFString</span>: Any] = [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageIfAbsent: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately: <span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize: max(size.width, size.height)</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    guard let imageSource = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>),</span><br><span class="line">        let image = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSource, <span class="number">0</span>, options as <span class="built_in">CFDictionary</span>)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: image)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="CoreImage"><a href="#CoreImage" class="headerlink" title="CoreImage"></a>CoreImage</h3><p> é‡Œé¢æä¾›äº†å¼ºå¤§é«˜æ•ˆçš„å›¾åƒå¤„ç†åŠŸèƒ½ï¼Œç”¨æ¥å¯¹åŸºäºåƒç´ çš„å›¾åƒè¿›è¡Œæ“ä½œä¸åˆ†æã€‚IOSæä¾›äº†å¾ˆå¤šå¼ºå¤§çš„æ»¤é•œ(Filter)ï¼Œè¿™äº›Filteræä¾›äº†å„ç§å„æ ·çš„æ•ˆæœï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡æ»¤é•œé“¾å°†å„ç§æ•ˆæœçš„Filterå åŠ èµ·æ¥ï¼Œå½¢æˆå¼ºå¤§çš„è‡ªå®šä¹‰æ•ˆæœï¼Œå¦‚æœä½ å¯¹è¯¥æ•ˆæœä¸æ»¡æ„ï¼Œè¿˜å¯ä»¥å­ç±»åŒ–æ»¤é•œã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">let sharedContext = <span class="built_in">CIContext</span>(options: [.useSoftwareRenderer : <span class="literal">false</span>])</span><br><span class="line">func coreImage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    let scale = (Double)(size.width) / (Double)(oriImg.size.width)</span><br><span class="line">    </span><br><span class="line">    let image = <span class="built_in">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    </span><br><span class="line">    let filter = <span class="built_in">CIFilter</span>(name: <span class="string">"CILanczosScaleTransform"</span>)</span><br><span class="line">    filter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">    filter?.setValue(<span class="built_in">NSNumber</span>(value:scale), forKey: kCIInputScaleKey)</span><br><span class="line">    filter?.setValue(<span class="number">1.0</span>, forKey:kCIInputAspectRatioKey)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    guard let outputCIImage = filter?.outputImage,</span><br><span class="line">        let outputCGImage = sharedContext.createCGImage(outputCIImage,</span><br><span class="line">                                                        from: outputCIImage.extent)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="vImage"><a href="#vImage" class="headerlink" title="vImage"></a>vImage</h3><p> ä½¿ç”¨CPUçš„çŸ¢é‡å¤„ç†å™¨å¤„ç†å¤§å›¾åƒã€‚ å¼ºå¤§çš„å›¾åƒå¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬Core Graphicså’ŒCore Videoäº’æ“ä½œï¼Œæ ¼å¼è½¬æ¢å’Œå›¾åƒå¤„ç†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func vimage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    var format = vImage_CGImageFormat(bitsPerComponent: <span class="number">8</span>, bitsPerPixel: <span class="number">32</span>, colorSpace: <span class="literal">nil</span>,</span><br><span class="line">                                      bitmapInfo: <span class="built_in">CGBitmapInfo</span>(rawValue: <span class="built_in">CGImageAlphaInfo</span>.first.rawValue),</span><br><span class="line">                                      version: <span class="number">0</span>, decode: <span class="literal">nil</span>, renderingIntent: .defaultIntent)</span><br><span class="line">    </span><br><span class="line">    var sourceBuffer = vImage_Buffer()</span><br><span class="line">    defer &#123;</span><br><span class="line">        free(sourceBuffer.data)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var error = vImageBuffer_InitWithCGImage(&amp;sourceBuffer, &amp;format, <span class="literal">nil</span>, cgImage, numericCast(kvImageNoFlags))</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a destination buffer</span></span><br><span class="line">    let scale = oriImg.scale</span><br><span class="line">    let destWidth = Int(size.width)</span><br><span class="line">    let destHeight = Int(size.height)</span><br><span class="line">    let bytesPerPixel = cgImage.bitsPerPixel / <span class="number">8</span></span><br><span class="line">    let destBytesPerRow = destWidth * bytesPerPixel</span><br><span class="line">    </span><br><span class="line">    let destData = UnsafeMutablePointer&lt;<span class="built_in">UInt8</span>&gt;.allocate(capacity: destHeight * destBytesPerRow)</span><br><span class="line">    defer &#123;        </span><br><span class="line">        destData.deallocate()</span><br><span class="line">    &#125;</span><br><span class="line">    var destBuffer = vImage_Buffer(data: destData, height: vImagePixelCount(destHeight), width: vImagePixelCount(destWidth), rowBytes: destBytesPerRow)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// scale the image</span></span><br><span class="line">    error = vImageScale_ARGB8888(&amp;sourceBuffer, &amp;destBuffer, <span class="literal">nil</span>, numericCast(kvImageHighQualityResampling))</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a CGImage from vImage_Buffer</span></span><br><span class="line">    var destCGImage = vImageCreateCGImageFromBuffer(&amp;destBuffer, &amp;format, <span class="literal">nil</span>, <span class="literal">nil</span>, numericCast(kvImageNoFlags), &amp;error)?.takeRetainedValue()</span><br><span class="line">    guard error == kvImageNoError <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// create a UIImage</span></span><br><span class="line">    let resizedImage = destCGImage.flatMap &#123;</span><br><span class="line">        <span class="built_in">UIImage</span>(cgImage: $<span class="number">0</span>, scale: <span class="number">0.0</span>, orientation: oriImg.imageOrientation)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    destCGImage = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">return</span> resizedImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>iOSå›¾ç‰‡</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>å›¾ç‰‡</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡-ImageIOä»‹ç»</title>
    <url>/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-ImageIO%E4%BB%8B%E7%BB%8D/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»ä¸‹iOSä¸­ImageIOçš„æ¦‚è§ˆä¸åº”ç”¨<br><a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/ImageIOGuide/imageio_intro/ikpg_intro.html#//apple_ref/doc/uid/TP40005462-CH201-TPXREF101" target="_blank" rel="noopener">Image I/O Programming Guide</a></p>
</blockquote>
<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p> ImageIOæ¡†æ¶æä¾›äº†è¯»å–ä¸å†™å…¥å›¾ç‰‡æ•°æ®çš„åŸºæœ¬æ–¹æ³•ï¼Œä½¿ç”¨å®ƒå¯ä»¥ç›´æ¥è·å–åˆ°å›¾ç‰‡æ–‡ä»¶çš„å†…å®¹æ•°æ®ï¼ŒImageIOå…·æœ‰å¾ˆå¤šç‰¹æ€§ <code>Macå¹³å°ä¸Šæœ€å¿«çš„å›¾åƒè§£ç å™¨å’Œç¼–ç å™¨</code> <code>é€æ­¥åŠ è½½å›¾åƒçš„èƒ½åŠ›`</code>æ”¯æŒå›¾åƒå…ƒæ•°æ®<code></code>æœ‰æ•ˆç¼“å­˜` ImageIOæ¡†æ¶ä¸­åŒ…å«6ä¸ªå¤´æ–‡ä»¶:</p>
<ol>
<li>ImageIO.CGImageAnimation</li>
<li>ImageIO.CGImageDestination è´Ÿè´£å†™å…¥å›¾ç‰‡æ•°æ®ã€‚</li>
<li>ImageIO.CGImageMetadata å›¾ç‰‡æ–‡ä»¶å…ƒæ•°æ®ç±»</li>
<li>ImageIO.CGImageProperties å®šä¹‰äº†æ¡†æ¶ä¸­ä½¿ç”¨çš„å­—ç¬¦ä¸²å¸¸é‡å’Œå®ã€‚</li>
<li>ImageIO.CGImageSource è´Ÿè´£è¯»å–å›¾ç‰‡æ•°æ®ã€‚</li>
<li><p>ImageIO.ImageIOBase é¢„å¤„ç†é€»è¾‘</p>
<a id="more"></a>
</li>
</ol>
<h2 id="è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"><a href="#è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼" class="headerlink" title="è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"></a>è·å–æ”¯æŒçš„å›¾ç‰‡æ ¼å¼</h2><p>ImageIO æ¡†æ¶äº†è§£å¤§å¤šæ•°å¸¸è§çš„å›¾åƒæ–‡ä»¶æ ¼å¼ï¼Œä¾‹å¦‚JPEGï¼ŒJPEG2000ï¼ŒRAWï¼ŒTIFFï¼ŒBMPå’ŒPNGã€‚å¹¶éæ¯ä¸ªå¹³å°éƒ½æ”¯æŒæ‰€æœ‰æ ¼å¼<br>é€šè¿‡ CGImageSourceCopyTypeIdentifiers å’Œ CGImageDestinationCopyTypeIdentifiers å¯ä»¥çœ‹åˆ°æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//è¿”å›Image IO æ”¯æŒçš„ç»Ÿä¸€ç±»å‹æ ‡è¯†ç¬¦ï¼ˆUTIï¼‰æ•°ç»„ä½œä¸ºå›¾åƒæºã€‚</span></span><br><span class="line">let mySourceTypes = <span class="built_in">CGImageSourceCopyTypeIdentifiers</span>()</span><br><span class="line"><span class="comment">//è¿”å›Image IO æ”¯æŒçš„ç»Ÿä¸€ç±»å‹æ ‡è¯†ç¬¦ï¼ˆUTIï¼‰çš„æ•°ç»„ä½œä¸ºå›¾åƒç›®æ ‡ã€‚</span></span><br><span class="line">let myDestTypes = <span class="built_in">CGImageDestinationCopyTypeIdentifiers</span>()</span><br></pre></td></tr></table></figure>
<h2 id="åŸºæœ¬ä½¿ç”¨-è·å–å›¾ç‰‡-ç¼©ç•¥å›¾"><a href="#åŸºæœ¬ä½¿ç”¨-è·å–å›¾ç‰‡-ç¼©ç•¥å›¾" class="headerlink" title="åŸºæœ¬ä½¿ç”¨|è·å–å›¾ç‰‡ ç¼©ç•¥å›¾"></a>åŸºæœ¬ä½¿ç”¨|è·å–å›¾ç‰‡ ç¼©ç•¥å›¾</h2><p>åœ¨å¹³æ—¶å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨UIImageæ¥è¯»å–å›¾ç‰‡ï¼ŒUIImageæ”¯æŒçš„å›¾ç‰‡åŒ…æ‹¬pngä¸jpgç­‰ï¼Œä½†æ˜¯ç±»ä¼¼icoå›¾æ ‡ï¼ŒUIImageé»˜è®¤æ˜¯æ— æ³•æ˜¾ç¤ºçš„ï¼Œ<br>å¯ä»¥é€šè¿‡ImageIOæ¡†æ¶æ¥åœ¨iOSç³»ç»Ÿä¸­ä½¿ç”¨icoå›¾æ ‡ï¼Œç¤ºä¾‹å¦‚ä¸‹</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func getImage() -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    guard let url = Bundle.main.url(forResource: <span class="string">"image.ico"</span>, withExtension: <span class="literal">nil</span>) <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//ä»URLåˆ›å»ºå›¾åƒæºã€‚</span></span><br><span class="line">    guard let imageSource = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//è·å–å›¾ç‰‡</span></span><br><span class="line">    guard let cgImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123; <span class="keyword">return</span> <span class="literal">nil</span>&#125;</span><br><span class="line">    <span class="comment">//è·å–ç¼©ç•¥å›¾</span></span><br><span class="line">    let thumb = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSource, <span class="number">0</span>, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: cgImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è·å–ç¼©ç•¥å›¾"><a href="#è·å–ç¼©ç•¥å›¾" class="headerlink" title="è·å–ç¼©ç•¥å›¾"></a>è·å–ç¼©ç•¥å›¾</h3><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func downsample(imageAt imageURL:URL,to pointSize:<span class="built_in">CGSize</span>,scale:<span class="built_in">CGFloat</span>)-&gt;<span class="built_in">UIImage</span>&#123;</span><br><span class="line">    let imageSourceOptions = [kCGImageSourceShouldCache:<span class="literal">false</span>] as <span class="built_in">CFDictionary</span></span><br><span class="line">    let imageSouce = <span class="built_in">CGImageSourceCreateWithURL</span>(imageURL as <span class="built_in">CFURL</span>, imageSourceOptions)!</span><br><span class="line">    </span><br><span class="line">    let maxDimensionInPixels = max(pointSize.width,pointSize.height) * scale</span><br><span class="line">    let downsampleOptions =</span><br><span class="line">     [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageAlways:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize:maxDimensionInPixels</span><br><span class="line">     ] as <span class="built_in">CFDictionary</span></span><br><span class="line">    </span><br><span class="line">    let downsampledImage = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSouce, <span class="number">0</span>, downsampleOptions)!</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: downsampledImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¸è¿›æ¸²æŸ“å¤§å›¾"><a href="#æ¸è¿›æ¸²æŸ“å¤§å›¾" class="headerlink" title="æ¸è¿›æ¸²æŸ“å¤§å›¾"></a>æ¸è¿›æ¸²æŸ“å¤§å›¾</h2><p>æ¸è¿›å¼è§£ç ï¼ˆProgressive Decodingï¼‰ï¼Œå³ä¸éœ€è¦å®Œæ•´çš„å›¾åƒæµæ•°æ®ï¼Œå…è®¸è§£ç éƒ¨åˆ†å¸§ï¼ˆå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œä¼šæ˜¯å›¾åƒçš„éƒ¨åˆ†åŒºåŸŸï¼‰ï¼Œå¯¹éƒ¨åˆ†ä½¿ç”¨äº†æ¸è¿›å¼ç¼–ç çš„æ ¼å¼ï¼ˆå‚è€ƒï¼š<a href="https://en.wikipedia.org/wiki/Interlacing_(bitmaps" target="_blank" rel="noopener">æ¸è¿›å¼ç¼–ç </a>)ï¼‰ï¼Œåˆ™æ›´å¯ä»¥è§£ç å‡ºç›¸å¯¹æ¨¡ç³Šä½†å®Œæ•´çš„å›¾åƒã€‚æ¯”å¦‚è¯´ï¼ŒJPEGæ”¯æŒä¸‰ç§æ–¹å¼çš„æ¸è¿›å¼ç¼–ç ï¼ŒåŒ…æ‹¬Baselineï¼Œinterlacedï¼Œä»¥åŠprogressive</p>
<p>ä½¿ç”¨ImageIOæ¡†æ¶å¯ä»¥å®ç°å¤§å›¾æ¸è¿›æ¸²æŸ“çš„æ•ˆæœï¼Œä¸€èˆ¬åœ¨å¯¹å¤§å›¾ç‰‡è¿›è¡Œç½‘ç»œè¯·æ±‚æ—¶ï¼Œå¯ä»¥è·å–ä¸€éƒ¨åˆ†æ•°æ®å°±åŠ è½½ä¸€éƒ¨åˆ†æ•°æ®<br>åˆ›å»ºä¸€ä¸ªç©ºçš„CGImageSourceï¼Œç„¶ååœ¨æ¯æ¬¡æ”¶åˆ°æ•°æ®çš„æ—¶å€™è°ƒç”¨CGImageSourceUpdateDataæ›´æ–°imageSourceçš„æ•°æ®ï¼Œæ¥ç€è°ƒç”¨CGImageSourceCreateImageAtIndexè·å–æœ€æ–°çš„å›¾ç‰‡å³å¯</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//demoä½¿ç”¨è®¡æ—¶å™¨æ¨¡æ‹Ÿ</span></span><br><span class="line"><span class="keyword">class</span> ProgressiveLoadViewController : <span class="built_in">UIViewController</span>&#123;</span><br><span class="line">    </span><br><span class="line">    deinit &#123;</span><br><span class="line">        incrementTimer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private var data = Data()</span><br><span class="line">    private var progress: Int = <span class="number">0</span></span><br><span class="line">    private var incrementTimer: Timer? &#123;</span><br><span class="line">        didSet &#123;</span><br><span class="line">            oldValue?.invalidate()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private var cgImageSource = <span class="built_in">CGImageSourceCreateIncremental</span>(<span class="literal">nil</span>)</span><br><span class="line">    </span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        guard let data = try? Data(contentsOf: URL(string: <span class="string">"some url"</span>)!) <span class="keyword">else</span> &#123;</span><br><span class="line">            print(<span class="string">"failed to load image source"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">self</span>.data = data</span><br><span class="line">        <span class="keyword">self</span>.progress = <span class="number">0</span></span><br><span class="line">        <span class="comment">//è¦æ¸è¿›æ˜¾ç¤ºçš„å›¾ç‰‡</span></span><br><span class="line">        guard let cgImage = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(<span class="keyword">self</span>.cgImageSource, <span class="number">0</span>, <span class="literal">nil</span>) <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        let uiImage = <span class="built_in">UIImage</span>(cgImage: cgImage)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func viewWillAppear(_ animated: Bool) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.incrementTimer = Timer.scheduledTimer(timeInterval: <span class="number">0.25</span>, target: <span class="keyword">self</span>,</span><br><span class="line">                                                   selector: <span class="meta">#selector(self.incrementImage), userInfo: nil, repeats: true)</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @objc func incrementImage()&#123;</span><br><span class="line">        <span class="keyword">self</span>.progress += <span class="number">500</span></span><br><span class="line">        let chunk = <span class="keyword">self</span>.data.prefix(<span class="keyword">self</span>.progress)</span><br><span class="line">        <span class="keyword">if</span> chunk.count == <span class="keyword">self</span>.data.count &#123;</span><br><span class="line">            <span class="keyword">self</span>.incrementTimer = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">CGImageSourceUpdateData</span>(<span class="keyword">self</span>.cgImageSource, Data(chunk) as <span class="built_in">CFData</span>, chunk.count == <span class="keyword">self</span>.data.count)</span><br><span class="line">                </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®"><a href="#è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®" class="headerlink" title="è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®"></a>è¯»å–å›¾åƒæ ¼å¼å…ƒæ•°æ®</h2><p>åˆ›å»ºå¥½CGImageSourceä¹‹åï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç«‹å³è§£ç ã€‚ä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€äº›ç›¸å…³çš„å›¾åƒä¿¡æ¯ï¼ŒåŒ…æ‹¬å›¾åƒçš„æ ¼å¼ï¼Œå›¾åƒæ•°é‡ï¼ŒEXIFå…ƒæ•°æ®ç­‰ã€‚åœ¨çœŸæ­£è§£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°è¿™äº›æ•°æ®ï¼Œè¿›è¡Œä¸€äº›å¤„ç†ï¼Œä¹‹åå†å¼€å§‹è§£ç è¿‡ç¨‹ã€‚</p>
<p>å…¶ä¸­ï¼Œè¿™äº›ä¿¡æ¯å¯ä»¥ç›´æ¥åœ¨CGImageSourceä¸Šè·å–ï¼š</p>
<ul>
<li>å›¾åƒæ ¼å¼ï¼šCGImageSourceGetType</li>
<li>å›¾åƒæ•°é‡ï¼ˆåŠ¨å›¾ï¼‰ï¼šCGImageSourceGetCount</li>
</ul>
<p>å…¶ä»–çš„ï¼Œéœ€è¦é€šè¿‡è·å–å±æ€§åˆ—è¡¨æ¥æŸ¥è¯¢ã€‚å¯¹äºå›¾åƒå®¹å™¨çš„å±æ€§ï¼ˆEXIFç­‰ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨CGImageSourceCopyPropertieså³å¯ï¼Œç„¶åæ ¹æ®ä¸åŒçš„Keyå»è·å–å¯¹åº”çš„ä¿¡æ¯ã€‚</p>
<p>å…¶å®è‹¹æœè¿˜æœ‰ä¸€å¥—CGImageSourceCopyMetadataAtIndexï¼Œå¯¹åº”çš„æ•°æ®ä¸æ˜¯å­—å…¸ï¼Œè€Œæ˜¯ä¸€ä¸ªCGImageMetadataï¼Œå†é€šè¿‡å…¶ä»–æ–¹æ³•å»å–ã€‚è¿™å¥—APIä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¯»å–æ•°æ®å’Œå‰è€…æ˜¯å®Œå…¨å…¼å®¹ä¸€è‡´çš„ï¼Œä¼˜ç‚¹æ˜¯èƒ½å¤Ÿè¿›è¡Œè‡ªå®šä¹‰æ‰©å±•ï¼ˆæ¯”å¦‚è¯´ä½ æœ‰éæ ‡å‡†çš„å›¾åƒä¿¡æ¯æƒ³è‡ªå·±æ·»åŠ å’Œåˆ é™¤ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ä½¿ç”¨å‰è€…å°±è¶³å¤Ÿäº†ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">CGImageSourceCopyPropertiesAtIndex</span>æ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸ä¸­å¯èƒ½åŒ…å«å¦‚ä¸‹æœ‰æ„ä¹‰çš„é”®ï¼š</span><br><span class="line"></span><br><span class="line"><span class="comment">//TIFFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyTIFFDictionary;</span><br><span class="line">/GIFä¿¡æ¯å­—å…¸</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyGIFDictionary;</span><br><span class="line"><span class="comment">//JFIFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyJFIFDictionary;</span><br><span class="line"><span class="comment">//EXifä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyExifDictionary;</span><br><span class="line"><span class="comment">//PNGä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyPNGDictionary;</span><br><span class="line"><span class="comment">//IPTCä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyIPTCDictionary;</span><br><span class="line"><span class="comment">//GPSä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyGPSDictionary;</span><br><span class="line"><span class="comment">//åŸå§‹ä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyRawDictionary;</span><br><span class="line"><span class="comment">//CIFFä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyCIFFDictionary;</span><br><span class="line"><span class="comment">//ä½³èƒ½ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerCanonDictionary;</span><br><span class="line"><span class="comment">//å°¼åº·ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerNikonDictionary;</span><br><span class="line"><span class="comment">//æŸ¯å°¼å¡ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerMinoltaDictionary;</span><br><span class="line"><span class="comment">//å¯Œå£«ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerFujiDictionary;</span><br><span class="line"><span class="comment">//å¥¥æ—å·´æ–¯ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerOlympusDictionary;</span><br><span class="line"><span class="comment">//å®¾å¾—ç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerPentaxDictionary;</span><br><span class="line"><span class="comment">//å¯¹åº”Photoshopç›¸ç‰‡çš„ä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImageProperty8BIMDictionary;</span><br><span class="line"><span class="comment">//NDGä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyDNGDictionary ;</span><br><span class="line"><span class="comment">//ExifAuxä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyExifAuxDictionary;</span><br><span class="line"><span class="comment">//OpenEXRä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyOpenEXRDictionary;</span><br><span class="line"><span class="comment">//Appleç›¸æœºä¿¡æ¯å­—å…¸</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">CFStringRef</span> kCGImagePropertyMakerAppleDictionary ;</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h2 id="æ˜¾ç¤ºGIF"><a href="#æ˜¾ç¤ºGIF" class="headerlink" title="æ˜¾ç¤ºGIF"></a>æ˜¾ç¤ºGIF</h2><ol>
<li>é¦–å…ˆä½¿ç”¨ImageIOåº“ä¸­çš„CGImageSourceåŠ è½½Gifæ–‡ä»¶ã€‚</li>
<li>é€šè¿‡CGImageSourceè·å–åˆ°Gifæ–‡ä»¶ä¸­çš„æ€»çš„å¸§æ•°ï¼Œä»¥åŠæ¯ä¸€å¸§çš„æ˜¾ç¤ºæ—¶é—´ã€‚</li>
<li>é€šè¿‡CAKeyframeAnimationæ¥å®ŒæˆGifåŠ¨ç”»çš„æ’­æ”¾ã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func getGif(url:URL)&#123;</span><br><span class="line">    guard let source = <span class="built_in">CGImageSourceCreateWithURL</span>(url as <span class="built_in">NSURL</span>, <span class="literal">nil</span>) <span class="keyword">else</span> &#123;<span class="keyword">return</span>;&#125;;</span><br><span class="line">    <span class="comment">//è·å–gifä¸­å›¾ç‰‡çš„ä¸ªæ•°</span></span><br><span class="line">    let count = <span class="built_in">CGImageSourceGetCount</span>(source)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="number">0.</span>..count &#123;</span><br><span class="line">        let image = <span class="built_in">CGImageSourceCreateImageAtIndex</span>(source, index, <span class="literal">nil</span>)</span><br><span class="line">        <span class="comment">//è·å–å›¾ç‰‡ä¿¡æ¯</span></span><br><span class="line">        let info = <span class="built_in">CGImageSourceCopyProperties</span>(source, <span class="literal">nil</span>) as! <span class="built_in">NSDictionary</span></span><br><span class="line">        let width = info[kCGImagePropertyWidth]</span><br><span class="line">        let height = info[kCGImagePropertyHeight]</span><br><span class="line">        let timeDic = info[kCGImagePropertyGIFDictionary]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åˆ›å»ºåŠ¨ç”»å›¾ç‰‡"><a href="#åˆ›å»ºåŠ¨ç”»å›¾ç‰‡" class="headerlink" title="åˆ›å»ºåŠ¨ç”»å›¾ç‰‡"></a>åˆ›å»ºåŠ¨ç”»å›¾ç‰‡</h2><ol>
<li>é¦–å…ˆï¼Œå®ƒåˆ›å»ºä¸€å¯¹å­—å…¸æ¥ä¿å­˜åŠ¨ç”»å±æ€§ã€‚ç¬¬ä¸€ä¸ªå­—å…¸æŒ‡å®šåŠ¨ç”»PNGåœ¨åœæ­¢åˆ°æœ€åä¸€å¸§ä¹‹å‰åº”é‡å¤å…¶åŠ¨ç”»çš„æ—¶é—´ã€‚ç¬¬äºŒä¸ªå­—å…¸æŒ‡å®šåºåˆ—ä¸­æ¯ä¸ªå¸§ä½¿ç”¨çš„å¸§å»¶è¿Ÿã€‚</li>
<li>åˆ›å»ºå›¾åƒç›®æ ‡ä¹‹åï¼Œä»£ç å°†è®¾ç½®ç›®æ ‡å›¾åƒçš„æ–‡ä»¶å±æ€§ï¼Œç„¶åä¸€æ¬¡æ·»åŠ ä¸€ä¸ªå¸§ã€‚</li>
<li>æœ€åï¼ŒCGImageDestinationFinalizeè°ƒç”¨è¯¥æ–¹æ³•ä»¥å®ŒæˆåŠ¨ç”»PNGã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func createAnimatePng(fileURL:<span class="built_in">CFURL</span>,kUTTypePNG:<span class="built_in">CFString</span>,imageForFrame)&#123;</span><br><span class="line">    let loopCount = <span class="number">1</span></span><br><span class="line">    let frameCount = <span class="number">60</span></span><br><span class="line">     </span><br><span class="line">    var fileProperties = <span class="built_in">NSMutableDictionary</span>()</span><br><span class="line">    fileProperties.setObject(kCGImagePropertyPNGDictionary, forKey: <span class="built_in">NSDictionary</span>(dictionary: [kCGImagePropertyAPNGLoopCount: frameCount]))</span><br><span class="line">     </span><br><span class="line">    var frameProperties = <span class="built_in">NSMutableDictionary</span>()</span><br><span class="line">    frameProperties.setObject(kCGImagePropertyPNGDictionary, forKey: <span class="built_in">NSDictionary</span>(dictionary: [kCGImagePropertyAPNGDelayTime: <span class="number">1.0</span> / Double(frameCount)]))</span><br><span class="line">     </span><br><span class="line">    guard let destination = <span class="built_in">CGImageDestinationCreateWithURL</span>(fileURL, kUTTypePNG, frameCount, <span class="literal">nil</span>) <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Provide error handling here.</span></span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="built_in">CGImageDestinationSetProperties</span>(destination, fileProperties.copy() as? <span class="built_in">NSDictionary</span>)</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0.</span>.&lt;frameCount &#123;</span><br><span class="line">        autoreleasepool &#123;</span><br><span class="line">            let radians = M_PI * <span class="number">2.0</span> * Double(i) / Double(frameCount)</span><br><span class="line">            guard let image = imageForFrame(size: <span class="built_in">CGSize</span>(width: <span class="number">300</span>, height: <span class="number">300</span>)) <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">CGImageDestinationAddImage</span>(destination, image, frameProperties)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> !<span class="built_in">CGImageDestinationFinalize</span>(destination) &#123;</span><br><span class="line">        <span class="comment">// Provide error handling here.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å›¾ç‰‡ç¼–ç -CGImageDestination"><a href="#å›¾ç‰‡ç¼–ç -CGImageDestination" class="headerlink" title="å›¾ç‰‡ç¼–ç  | CGImageDestination"></a>å›¾ç‰‡ç¼–ç  | CGImageDestination</h2><p>imageIOä¸­ä½¿ç”¨CGImageDestinationå¯¹é™æ€å›¾çš„ç¼–ç ï¼ŒåŸºæœ¬å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>åˆ›å»ºCGImageDestination</li>
<li>æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage</li>
<li>ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†</li>
</ul>
<h3 id="1-åˆ›å»ºCGImageDestination"><a href="#1-åˆ›å»ºCGImageDestination" class="headerlink" title="1. åˆ›å»ºCGImageDestination"></a>1. åˆ›å»ºCGImageDestination</h3><p>CGImageDestinationçš„åˆ›å»ºä¹Ÿæœ‰ä¸‰ä¸ªæ¥å£ï¼Œä½ éœ€è¦æä¾›ä¸€ä¸ªè¾“å‡ºçš„ç›®æ ‡æ¥è¾“å‡ºè§£ç åçš„æ•°æ®ã€‚åŒæ—¶ï¼Œç”±äºç¼–ç éœ€è¦æä¾›æ–‡ä»¶æ ¼å¼ï¼Œä½ éœ€è¦æŒ‡æ˜å¯¹åº”ç¼–ç çš„æ–‡ä»¶æ ¼å¼ï¼Œç”¨çš„æ˜¯UTI Typeã€‚å¯¹äºé™æ€å›¾æ¥è¯´ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°çš„æ•°é‡éƒ½å†™1å³å¯ã€‚</p>
<ul>
<li>CGImageDestinationCreateWithDataï¼šæŒ‡å®šä¸€ä¸ªå¯å˜äºŒè¿›åˆ¶æ•°æ®ä½œä¸ºè¾“å‡º</li>
<li>CGImageDestinationCreateWithURLï¼šæŒ‡å®šä¸€ä¸ªæ–‡ä»¶è·¯å¾„ä½œä¸ºè¾“å‡º</li>
<li>CGImageDestinationCreateWithDataConsumerï¼šæŒ‡å®šä¸€ä¸ªDataConsumerä½œä¸ºè¾“å‡º</li>
</ul>
<h3 id="2-æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage"><a href="#2-æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage" class="headerlink" title="2. æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage"></a>2. æ·»åŠ å›¾åƒæ ¼å¼å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰å’ŒCGImage</h3><p>æ¥ä¸‹æ¥å°±æ˜¯æ·»åŠ å›¾åƒäº†ï¼Œç”±äºCGImageåªæ˜¯åŒ…å«åŸºæœ¬çš„å›¾åƒä¿¡æ¯ï¼Œå¾ˆå¤šé¢å¤–ä¿¡æ¯æ¯”å¦‚è¯´EXIFéƒ½å·²ç»ä¸¢å¤±äº†ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦ï¼Œå¯ä»¥æ·»åŠ å¯¹åº”çš„å…ƒä¿¡æ¯ã€‚ä¸åƒè§£ç é‚£æ ·æä¾›äº†ä¸¤ä¸ªAPIåˆ†åˆ«è·å–å…ƒä¿¡æ¯å’Œå›¾åƒã€‚ä½¿ç”¨çš„æ¥å£æ˜¯CGImageDestinationAddImageã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœæœ‰è‡ªå®šä¹‰çš„å…ƒä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡å¦å¤–çš„CGImageDestinationAddImageAndMetadataæ¥æ·»åŠ CGImageMetadataï¼Œè¿™ä¸ªä¸Šé¢è§£ç ä¹Ÿè¯´åˆ°è¿‡ï¼Œè¿™é‡Œå°±ä¸è§£é‡Šäº†ã€‚</p>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªImageIOæœ€å¼ºå¤§çš„åŠŸèƒ½ï¼Œå«åšCGImageDestinationAddImageFromSourceï¼ˆè¿™ä¸ªä¸œè¥¿å¯ä»¥åª²ç¾vImageConvert_AnyToAnyï¼Œåç»­æ•™ç¨‹ä¼šè°ˆåˆ°ï¼‰ï¼Œè¿™ä¸ªèƒ½å¤Ÿä»ä¸€ä¸ªä»»æ„çš„CGImageSourceï¼Œæ·»åŠ ä¸€ä¸ªå›¾åƒå¸§åˆ°ä»»æ„ä¸€ä¸ªCGImageDestinationã€‚è¿™ä¸ªä¸€èˆ¬çš„ç”¨é€”ï¼Œå°±æ˜¯ä¸“é—¨ç»™å›¾åƒè½¬æ¢å™¨ç”¨çš„ï¼Œæ¯”å¦‚è¯´ä»å›¾åƒæ ¼å¼Aï¼Œè½¬æ¢åˆ°å›¾åƒæ ¼å¼Bã€‚æˆ‘ä»¬ä¸éœ€è¦å…ˆè§£ç åˆ°Açš„UIImageï¼Œå†é€šè¿‡ç¼–ç åˆ°Bçš„NSDataï¼Œç›´æ¥åœ¨ä¸­é—´å°±è¿›è¡Œäº†è½¬æ¢ã€‚èƒ½å¤Ÿæå¤§åœ°æå‡è½¬æ¢æ•ˆç‡ï¼ˆImage/IOåº•å±‚å°±æ˜¯é€šè¿‡vImageï¼Œä¼ çš„æ˜¯Bitmapçš„å¼•ç”¨ï¼Œæ²¡æœ‰é¢å¤–çš„æ¶ˆè€—ï¼‰ã€‚ä¸è¿‡è¿™ç¯‡æ•™ç¨‹ä¾§é‡äºImage/IOçš„ç¼–ç å’Œè§£ç ï¼Œè½¬æ¢å¯ä»¥è‡ªè¡Œå‚è€ƒå¤„ç†ï¼Œä¸å†è¯¦ç»†è¯´æ˜äº†ã€‚</p>
<h3 id="3-ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†"><a href="#3-ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†" class="headerlink" title="3. ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†"></a>3. ç¼–ç å¾—åˆ°NSDataï¼Œæ¸…ç†</h3><p>å½“æ·»åŠ å®Œæˆæ‰€æœ‰éœ€è¦ç¼–ç çš„CGImageä¹‹åï¼Œæœ€åä¸€æ­¥ï¼Œå°±æ˜¯è¿›è¡Œç¼–ç ï¼Œå¾—åˆ°å›¾åƒæ ¼å¼çš„æ•°æ®ã€‚è¿™é‡Œç›´æ¥ç”¨ä¸€ä¸ªæ–¹æ³•CGImageDestinationFinalizeå³å¯ï¼Œç¼–ç å¾—åˆ°çš„æ•°æ®ï¼Œä¼šå†™å…¥æœ€æ—©åˆå§‹åŒ–æ—¶æä¾›çš„Dataæˆ–è€…DataConsumerã€‚</p>
]]></content>
      <categories>
        <category>iOSå›¾ç‰‡</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>å›¾ç‰‡</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡-åƒç´ æ“ä½œ</title>
    <url>/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E5%83%8F%E7%B4%A0%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»ä¸‹å¸¸è§çš„å‡ ç§å¯¹å›¾ç‰‡çš„åƒç´ çº§æ“ä½œ<br>1.ä¿®æ”¹é¢œè‰² 2. é¢œè‰²ç©ºé—´å˜åŒ– 3.lsb éšè—ä¿¡æ¯ 4. é¢œè‰²æ··åˆ  5. é©¬èµ›å…‹</p>
</blockquote>
<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>åœ¨ <a href="../iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç /">iOSå›¾ç‰‡-ä½å›¾ä¿¡æ¯ä¸å›¾ç‰‡è§£ç </a> ä¸­ä»‹ç»äº†ä½å›¾ä¿¡æ¯ä¸­åƒç´  é¢œè‰²ç©ºé—´ç­‰æ¦‚å¿µã€‚è¿™æ¬¡æ¥å®è·µä¸€ä¸‹å¦‚ä½•å¯¹å›¾ç‰‡çš„åƒç´ è¿›è¡Œæ“ä½œã€‚ä½å›¾åˆè¢«å«åšç‚¹é˜µå›¾åƒï¼Œä¹Ÿå°±æ˜¯è¯´ä½å›¾åŒ…å«äº†ä¸€å¤§å †çš„åƒç´ ç‚¹ä¿¡æ¯ï¼Œè¿™äº›åƒç´ ç‚¹å°±æ˜¯è¯¥å›¾ç‰‡ä¸­çš„ç‚¹ï¼Œæœ‰äº†å›¾ç‰‡ä¸­æ¯ä¸ªåƒç´ ç‚¹çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±çŸ¥é“å¦‚ä½•å¯¹å›¾ç‰‡è¿›è¡Œåƒç´ çº§æ“ä½œäº†ã€‚</p>
<h2 id="å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²"><a href="#å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²" class="headerlink" title="å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²"></a>å°†ä¸€å¼ å›¾ç‰‡ä¿®æ”¹ä¸ºè“è‰²</h2><p>ç”±äºåœ¨iOSå¼€å‘ä¸­ä½¿ç”¨çš„ä½å›¾å¤§éƒ¨åˆ†æ˜¯32ä½RGBAæ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè¯´ä¸‹è¿™ç§æ¨¡å¼çš„ç®€å•å›¾åƒå¤„ç†ã€‚<br>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ä»€ä¹ˆæ˜¯32ä½RGBAæ¨¡å¼çš„ä½å›¾ã€‚32ä½å°±è¡¨ç¤ºä¸€ä¸ªè¿™ç§æ¨¡å¼ä½å›¾çš„ä¸€ä¸ªåƒç´ æ‰€å å†…å­˜ä¸º32ä½ï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚çš„é•¿åº¦ã€‚Rã€Gã€Bã€Aåˆ†åˆ«ä»£è¡¨redï¼Œgreenï¼Œblueå’Œalphaï¼Œä¹Ÿå°±æ˜¯é¢œè‰²ç»„æˆçš„ä¸‰åŸè‰²ä¸é€æ˜åº¦å€¼ã€‚RGBAæ¯ä¸€ä¸ªå ç”¨ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ã€‚<br>çŸ¥é“äº†ä¸Šé¢è¿™äº›ï¼Œæˆ‘ä»¬å°±æœ‰äº†æ€è·¯ï¼šé€šè¿‡æ”¹å˜æ¯ä¸€ä¸ªåƒç´ ä¸­çš„RGBAå€¼æ¥è¿›è¡Œä¸€äº›ä½å›¾å›¾åƒçš„å¤„ç†äº†ã€‚</p>
 <a id="more"></a>
<p>ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p>
<p>å°†åŸå›¾ç‰‡ <img src="/res/iOSImg/Share.png" alt> è½¬æ¢ä¸ºè“è‰²å›¾ç‰‡<br><img src="/res/iOSImg/sample1ResultImg.png" alt></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹1 å°†ä¸€å¼ å›¾ç‰‡å˜ä¸ºè“è‰²</span></span><br><span class="line"><span class="built_in">UIImage</span>* sampleImg1 = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"share.png"</span>];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">UIImage</span>* sample1ResultImg = [<span class="keyword">self</span>.class sample1With:sampleImg1];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç¤ºä¾‹1 å°†ä¸€å¼ å›¾ç‰‡å˜ä¸ºè“è‰² END"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span>*)sample1With:(<span class="built_in">UIImage</span>*)originImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾ åƒç´ rgbaä¿¡æ¯</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"><span class="comment">//            NSLog(@"r %d,g %d,b %d,a %d",thisR,thisG,thisB,thisA);</span></span><br><span class="line">            <span class="keyword">if</span>(thisA)&#123;<span class="comment">//é€æ˜ä¸å¤„ç† å…¶ä»–å˜ä¸ºè“è‰²</span></span><br><span class="line">                thisR = <span class="number">0</span>;</span><br><span class="line">                thisG = <span class="number">0</span>;</span><br><span class="line">                thisB = <span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²"><a href="#åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²" class="headerlink" title="åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²"></a>åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰²</h2><p>iOS æ”¯æŒçš„ç»„åˆä¸å¤š <a href="https://developer.apple.com/library/archive/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB" target="_blank" rel="noopener">Supported Pixel Formats</a></p>
<p>è¿™é‡Œå°è¯•å°†åƒç´ æ ¼å¼è‰²å½©ç©ºé—´å˜ä¸ºç°è‰² ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p>
<p>å°†åŸå›¾ç‰‡  <img src="/res/iOSImg/rgb_cs.png" style="width:80%"> è½¬æ¢ä¸ºç°è‰²é¢œè‰²ç©ºé—´å›¾ç‰‡ <img src="/res/iOSImg/grey_cs.png" style="width:80%"></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹2 åƒç´ æ ¼å¼ é¢œè‰²ç©ºé—´å˜ä¸ºç°è‰²</span></span><br><span class="line"><span class="built_in">UIImage</span>* sampleImg2 = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"channel.png"</span>];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="built_in">UIImage</span>* sample1ResultImg = [<span class="keyword">self</span>.class sample2With:sampleImg2];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"ç¤ºä¾‹2 é¢œè‰²ç©ºé—´å˜åŒ– END"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...å…¶ä»–åŒä¸Šä¾‹</span></span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceGray</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaOnly);</span><br><span class="line"><span class="comment">//å»æ‰åƒç´ å¤„ç†éƒ¨åˆ†</span></span><br></pre></td></tr></table></figure>
<h2 id="LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡"><a href="#LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡" class="headerlink" title="LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡"></a>LSBæ–¹å¼éšè—äºŒç»´ç åˆ°ä¸€å¼ å›¾ç‰‡</h2><p><a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E4%BD%8E%E6%9C%89%E6%95%88%E4%BD%8D" target="_blank" rel="noopener">LSB</a>ï¼Œæœ€ä½æœ‰æ•ˆä½ï¼Œè‹±æ–‡æ˜¯Least Significant Bit ã€‚æˆ‘ä»¬çŸ¥é“å›¾åƒåƒç´ ä¸€èˆ¬æ˜¯ç”±RGBä¸‰åŸè‰²ï¼ˆå³çº¢ç»¿è“ï¼‰ç»„æˆçš„ï¼Œæ¯ä¸€ç§é¢œè‰²å ç”¨8ä½ï¼Œ0x00~0xFFï¼Œå³ä¸€å…±æœ‰256ç§é¢œè‰²ï¼Œä¸€å…±åŒ…å«äº†256çš„3æ¬¡æ–¹çš„é¢œè‰²ï¼Œé¢œè‰²å¤ªå¤šï¼Œè€Œäººçš„è‚‰çœ¼èƒ½åŒºåˆ†çš„åªæœ‰å…¶ä¸­ä¸€å°éƒ¨åˆ†ï¼Œè¿™å¯¼è‡´äº†å½“æˆ‘ä»¬ä¿®æ”¹RGBé¢œè‰²åˆ†é‡ä¸­æœ€ä½çš„äºŒè¿›åˆ¶ä½çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„è‚‰çœ¼æ˜¯åŒºåˆ†ä¸å‡ºæ¥çš„ã€‚</p>
<p>é‰´äºLSBæƒ³æ³•ï¼Œä¸€å¼ æ™®é€šçš„äºŒç»´ç å›¾ç‰‡åªæœ‰é»‘è‰²å’Œç™½è‰²ã€‚é‚£ä¹ˆå¯¹äºRGBAçš„å›¾ç‰‡ å¯ä»¥ä¿®æ”¹Rçš„æœ€ä½ä½ã€‚0è¡¨ç¤ºç™½è‰² 1è¡¨ç¤ºé»‘è‰²ï¼Œè¿™æ ·å¤„ç†åè‚‰çœ¼çœ‹ä¸å‡ºåŸå›¾ä¿®æ”¹çš„ç—•è¿¹ã€‚</p>
<p>ç¤ºä¾‹ä»£ç  æ•ˆæœå¦‚ä¸‹: </p>
<p>å·¦å›¾æ˜¯åŸå›¾ å³å›¾æ˜¯ç»è¿‡LSBæ“ä½œçš„å›¾ï¼Œè‚‰çœ¼å®Œå…¨çœ‹ä¸å‡ºåŒºåˆ«</p>
<p><img src="/res/iOSImg/LSB.png" alt></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¤ºä¾‹3 åœ¨ä¸€å¼ å›¾ç‰‡ä¸­ä½¿ç”¨lsbæ–¹å¼éšè—äºŒç»´ç  ã€‚</span></span><br><span class="line"><span class="comment">//ä¾‹å­é‡Œç®€å•å¤„ç†äº† åŸå›¾å’ŒäºŒç»´ç å¤§å°ç›¸åŒ</span></span><br><span class="line"><span class="built_in">UIImage</span>* oriImg = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"channel.png"</span>];</span><br><span class="line"><span class="built_in">UIImage</span>* qrImg = [<span class="keyword">self</span>.class createQRForAlreadySpliceString:<span class="string">@"ä¸€äº›ä¿¡æ¯"</span> size:<span class="built_in">CGSizeMake</span>(<span class="number">300</span>, <span class="number">300</span>)];</span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="comment">//å°†äºŒç»´ç å›¾ç‰‡ä¿¡æ¯è—å…¥åŸå›¾ å¾—åˆ°result</span></span><br><span class="line">    <span class="built_in">UIImage</span>* result = [<span class="keyword">self</span> handleImage:oriImg hideQrImage:qrImg];</span><br><span class="line">    <span class="comment">//ä»resultä¸­è§£æå¾—åˆ°äºŒç»´ç </span></span><br><span class="line">    <span class="built_in">UIImage</span>* qrResult = [<span class="keyword">self</span> handleHideImage:result];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//MARK: å›¾ç‰‡å¤„ç† éšè—äºŒç»´ç å›¾ç‰‡</span></span><br><span class="line">- (<span class="built_in">UIImage</span>*)handleImage:(<span class="built_in">UIImage</span>*)originImg hideQrImage:(<span class="built_in">UIImage</span>*)qrImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line">    <span class="built_in">UInt32</span> * inputQRPixels;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRef</span> inputQRCGImage = [qrImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRWidth = <span class="built_in">CGImageGetWidth</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRHeight = <span class="built_in">CGImageGetHeight</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputQRBytesPerRow = bytesPerPixel * inputQRWidth;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line">    inputQRPixels = (<span class="built_in">UInt32</span> *)calloc(inputQRHeight * inputQRWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGContextRef</span> qrcontext = <span class="built_in">CGBitmapContextCreate</span>(inputQRPixels, inputQRWidth, inputQRHeight,</span><br><span class="line">                                                 bitsPerComponent, inputQRBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(qrcontext, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputQRWidth, inputQRHeight), inputQRCGImage);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"><span class="comment">//            NSLog(@"r %d,g %d,b %d,a %d",thisR,thisG,thisB,thisA);</span></span><br><span class="line">            <span class="comment">//äºŒç»´ç </span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentQRPixel = inputQRPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> qrcolor = *currentQRPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> qrthisR,qrthisG,qrthisB,qrthisA;</span><br><span class="line">            qrthisR=R(qrcolor);</span><br><span class="line">            qrthisG=G(qrcolor);</span><br><span class="line">            qrthisB=B(qrcolor);</span><br><span class="line">            qrthisA=A(qrcolor);</span><br><span class="line">            <span class="comment">//é€æ˜åº¦0ä¿¡æ¯ä¼šä¸¢å¤±</span></span><br><span class="line">            <span class="keyword">if</span>(thisA == <span class="number">0</span>)&#123;</span><br><span class="line">                thisA = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åƒç´ æœ€ä½ä½å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span>(qrthisR &lt; <span class="number">128</span>)&#123;<span class="comment">//äºŒç»´ç ç™½è‰² è®¾ç½®æœ€ä½ä½ä¸º0</span></span><br><span class="line">                thisR ^= (thisR &amp; ( <span class="number">1</span> &lt;&lt; <span class="number">0</span>) ) ^ (<span class="number">0</span> &lt;&lt; <span class="number">0</span>) ;</span><br><span class="line"><span class="comment">//                thisA = 255;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="comment">//äºŒç»´ç é»‘è‰² è®¾ç½®æœ€ä½ä½ä¸º1</span></span><br><span class="line">                thisR ^= (thisR &amp; ( <span class="number">1</span> &lt;&lt; <span class="number">0</span>) ) ^ (<span class="number">1</span> &lt;&lt; <span class="number">0</span>) ;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputQRCGImage);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(qrcontext);</span><br><span class="line">    free(inputQRPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//MARK: å›¾ç‰‡å¤„ç† è§£æäºŒç»´ç </span></span><br><span class="line">- (<span class="built_in">UIImage</span>*)handleHideImage:(<span class="built_in">UIImage</span>*)originImg</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="built_in">NSUInteger</span> bytesPerPixel = <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">NSUInteger</span> bitsPerComponent = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®šä¹‰æœ€é«˜32ä½æ•´å½¢æŒ‡é’ˆ *inputPixels</span></span><br><span class="line">    <span class="built_in">UInt32</span> * inputPixels;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è½¬æ¢å›¾ç‰‡ä¸ºCGImageRef,è·å–å‚æ•°ï¼šé•¿å®½é«˜ï¼Œæ¯ä¸ªåƒç´ çš„å­—èŠ‚æ•°ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªRçš„æ¯”ç‰¹æ•°</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> inputCGImage = [originImg <span class="built_in">CGImage</span>];</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputWidth = <span class="built_in">CGImageGetWidth</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputHeight = <span class="built_in">CGImageGetHeight</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">NSUInteger</span> inputBytesPerRow = bytesPerPixel * inputWidth;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¼€è¾Ÿå†…å­˜åŒºåŸŸ,æŒ‡å‘é¦–åƒç´ åœ°å€</span></span><br><span class="line">    inputPixels = (<span class="built_in">UInt32</span> *)calloc(inputHeight * inputWidth, <span class="keyword">sizeof</span>(<span class="built_in">UInt32</span>));</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ ¹æ®æŒ‡é’ˆï¼Œå‰é¢çš„å‚æ•°ï¼Œåˆ›å»ºåƒç´ å±‚</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(inputPixels, inputWidth, inputHeight,</span><br><span class="line">                                                 bitsPerComponent, inputBytesPerRow, colorSpace,</span><br><span class="line">                                                 kCGImageAlphaPremultipliedLast | kCGBitmapByteOrder32Big);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//æ ¹æ®ç›®å‰åƒç´ åœ¨ç•Œé¢ç»˜åˆ¶å›¾åƒ</span></span><br><span class="line">    <span class="built_in">CGContextDrawImage</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, inputWidth, inputHeight), inputCGImage);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">            <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">            thisR=R(color);</span><br><span class="line">            thisG=G(color);</span><br><span class="line">            thisB=B(color);</span><br><span class="line">            thisA=A(color);</span><br><span class="line"> </span><br><span class="line">            <span class="comment">//åƒç´ æœ€ä½ä½å¤„ç†</span></span><br><span class="line">            <span class="keyword">int</span> tag = (thisR &gt;&gt; <span class="number">0</span>) &amp; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(tag == <span class="number">0</span>)&#123;<span class="comment">//æœ€ä½ä½ä¸º0 ç™½è‰²</span></span><br><span class="line">                thisR=<span class="number">255</span>;</span><br><span class="line">                thisG=<span class="number">255</span>;</span><br><span class="line">                thisB=<span class="number">255</span>;</span><br><span class="line">                thisA=<span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;<span class="comment">//æœ€ä½ä½ä¸º1 é»‘è‰²</span></span><br><span class="line">                thisR=<span class="number">0</span>;</span><br><span class="line">                thisG=<span class="number">0</span>;</span><br><span class="line">                thisB=<span class="number">0</span>;</span><br><span class="line">                thisA=<span class="number">255</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            *currentPixel = RGBAMake(thisR, thisG, thisB, thisA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ›å»ºæ–°å›¾</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> newCGImage = <span class="built_in">CGBitmapContextCreateImage</span>(context);</span><br><span class="line">    <span class="built_in">UIImage</span> * processedImage = [<span class="built_in">UIImage</span> imageWithCGImage:newCGImage];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é‡Šæ”¾</span></span><br><span class="line">    <span class="built_in">CGImageRelease</span>(inputCGImage);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    free(inputPixels);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> processedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶LSBçš„æ–¹å¼ä¹Ÿèƒ½éšè—æ–‡å­—ç­‰å…¶ä»–ä¿¡æ¯ã€‚ä¸ä¹‹ç±»ä¼¼çš„æƒ³æ³•è¿˜æœ‰ å¯ä»¥æ ¹æ®å®¹å·®è¿›è¡Œä¿¡æ¯çš„éšè—ã€‚</p>
<p>è‹¥æ˜¯æœ‰ä¸¤å¼ å›¾ç‰‡ï¼Œåˆ™å¯¹ä¸¤å¼ å›¾ç‰‡çš„æ¯ä¸€ä¸ªåƒç´ ç‚¹è¿›è¡Œå¯¹æ¯”ï¼Œè®¾ç½®ä¸€ä¸ªå®¹å·®çš„é˜ˆå€¼Î±ï¼Œè¶…å‡ºè¿™ä¸ªé˜ˆå€¼çš„åƒç´ ç‚¹RGBå€¼è®¾ç½®ä¸º(255,255,255),è‹¥æ˜¯æ²¡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è®¾ç½®è¯¥åƒç´ ç‚¹çš„RGBå€¼ä¸º(0,0,0)ã€‚å› æ­¤ï¼Œé€šè¿‡è°ƒæ•´ä¸åŒçš„Î±å€¼ï¼Œå¯ä»¥ä½¿å¯¹æ¯”ç”Ÿæˆçš„å›¾ç‰‡å‘ˆç°ä¸åŒçš„ç”»é¢ã€‚æ¯”å¦‚ä¸¤å¼ å›¾å®Œå…¨ä¸€æ ·ï¼Œè®¾ç½®é˜ˆå€¼Î±ä¸ºä»»ä½•å€¼ï¼Œæœ€åå¾—åˆ°çš„å¯¹æ¯”å›¾éƒ½åªä¼šæ˜¯å…¨é»‘ã€‚è‹¥ä¸¤å¼ å›¾æ¯ä¸€ä¸ªåƒç´ ç‚¹éƒ½ä¸åŒï¼Œé˜ˆå€¼Î±è®¾ç½®ä¸º1ï¼Œåˆ™å¯¹æ¯”å›¾å°†æ˜¯å…¨ç™½ã€‚å¦‚æœå°†éšè—ä¿¡æ¯é™„åŠ åˆ°æŸäº›åƒç´ ç‚¹ä¸Šï¼Œè¿™æ—¶è°ƒæ•´é˜ˆå€¼Î±å³å¯çœ‹åˆ°éšè—ä¿¡æ¯ã€‚</p>
<h3 id="JPEGå‹ç¼©"><a href="#JPEGå‹ç¼©" class="headerlink" title="JPEGå‹ç¼©"></a>JPEGå‹ç¼©</h3><p>ç›®å‰ä¾‹å­ä¸­æœ‰ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜å°±æ˜¯ï¼Œç»è¿‡LSBæ“ä½œåçš„å›¾ç‰‡æ˜¯éœ€è¦æ— æŸçš„æ‰èƒ½ è§£æå‡ºæ•°æ®æ¥ã€‚å‡è®¾å›¾ç‰‡ç»è¿‡JPEGå‹ç¼©å å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å°†äºŒç»´ç å›¾ç‰‡ä¿¡æ¯è—å…¥åŸå›¾ å¾—åˆ°result</span></span><br><span class="line"><span class="built_in">UIImage</span>* result = [<span class="keyword">self</span> handleImage:oriImg hideQrImage:qrImg];</span><br><span class="line"><span class="built_in">NSData</span>* resultData = <span class="built_in">UIImageJPEGRepresentation</span>(result, <span class="number">0.9</span>);</span><br><span class="line">result = [<span class="built_in">UIImage</span> imageWithData:resultData];</span><br><span class="line"><span class="comment">//ä»resultä¸­è§£æå¾—åˆ°äºŒç»´ç </span></span><br><span class="line"><span class="built_in">UIImage</span>* qrResult = [<span class="keyword">self</span> handleHideImage:result];</span><br></pre></td></tr></table></figure>
<p>åˆ™qrResultä¼šå¾—åˆ°å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/res/iOSImg/qrResult_1.png" alt></p>
<p>è¿™æ˜¯ç”±äºJPEGå›¾åƒæ ¼å¼ä½¿ç”¨ç¦»æ•£ä½™å¼¦å˜æ¢ï¼ˆDiscrete Cosine Transformï¼ŒDCTï¼‰å‡½æ•°æ¥å‹ç¼©å›¾åƒï¼Œè€Œè¿™ä¸ªå›¾åƒå‹ç¼©æ–¹æ³•çš„æ ¸å¿ƒæ˜¯ï¼šé€šè¿‡è¯†åˆ«æ¯ä¸ª8Ã—8åƒç´ å—ä¸­ç›¸é‚»åƒç´ ä¸­çš„é‡å¤åƒç´ æ¥å‡å°‘æ˜¾ç¤ºå›¾åƒæ‰€éœ€çš„ä½æ•°ï¼Œå¹¶ä½¿ç”¨è¿‘ä¼¼ä¼°ç®—æ³•é™ä½å…¶å†—ä½™åº¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠDCTçœ‹ä½œä¸€ä¸ªç”¨äºæ‰§è¡Œå‹ç¼©çš„è¿‘ä¼¼è®¡ç®—æ–¹æ³•ã€‚å› ä¸ºä¸¢å¤±äº†éƒ¨åˆ†æ•°æ®ï¼Œä¾‹å­ä¸­æœ€ä½ä½ä¿¡æ¯å…¶å®å·²ç»è¢«æ”¹å˜ã€‚</p>
<h2 id="æ··è‰²æ¨¡å¼"><a href="#æ··è‰²æ¨¡å¼" class="headerlink" title="æ··è‰²æ¨¡å¼"></a>æ··è‰²æ¨¡å¼</h2><p>åœ¨PS çš„æ··è‰²æ¨¡å¼ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯ä»¥é€‰é¡¹ï¼Œæ··åˆæ¨¡å¼çš„åŸºæœ¬åŸç†å°±æ˜¯å–Aå±‚ä»»æ„ä¸€ä¸ªåƒç´ a [R1, G1, B1]ï¼Œä¸Bå±‚å¯¹åº”ä½ç½®çš„åƒç´ b [R2, G2, B2] è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œå¾—åˆ°c [R3, G3, B3]ã€‚æœ‰å…´è¶£å¯ä»¥çœ‹ä¸‹ <a href="https://zhuanlan.zhihu.com/p/23905865" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« å½»åº•ææ¸…PSæ··åˆæ¨¡å¼çš„åŸç†</a></p>
<p>åŸºäºè¿™ç§æƒ³æ³• æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸‹PSçš„æ··åˆæ¨¡å¼ï¼š</p>
<p><img src="/res/iOSImg/colorMix.png" alt></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">// åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">                <span class="built_in">UInt32</span> *currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line">                <span class="built_in">UInt32</span> color = *currentPixel;</span><br><span class="line">                <span class="built_in">UInt32</span> thisR,thisG,thisB,thisA;</span><br><span class="line">                <span class="comment">// è¿™é‡Œç›´æ¥ç§»ä½è·å¾—RBGAçš„å€¼,ä»¥åŠè¾“å‡ºå†™çš„éå¸¸å¥½ï¼</span></span><br><span class="line">                thisR = R(color);</span><br><span class="line">                thisG = G(color);</span><br><span class="line">                thisB = B(color);</span><br><span class="line">                thisA = A(color);</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">UInt32</span> newR,newG,newB;</span><br><span class="line">                newR = [<span class="keyword">self</span> SoftLight:thisR];</span><br><span class="line">                newG = [<span class="keyword">self</span> SoftLight:thisG];</span><br><span class="line">                newB = [<span class="keyword">self</span> SoftLight:thisB];</span><br><span class="line">                </span><br><span class="line">                *currentPixel = RGBAMake(newR,</span><br><span class="line">                                         newG,</span><br><span class="line">                                         newB,</span><br><span class="line">                                         thisA);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<p>Color Burn é¢œè‰²åŠ æ·±ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)ColorBurn:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//    C=A-(Aåç›¸Ã—Båç›¸)/B</span></span><br><span class="line"><span class="comment">//    å¦‚æœä¸Šå±‚è¶Šæš—ï¼Œåˆ™ä¸‹å±‚è·å–çš„å…‰è¶Šå°‘ï¼ŒåŠ æ·±æ•ˆæœè¶Šæ˜æ˜¾ã€‚</span></span><br><span class="line"><span class="comment">//    ã€å¦‚æœä¸Šå±‚ä¸ºå…¨é»‘è‰²ï¼Œåˆ™ä¸‹å±‚é¢œè‰²å€¼ä¸æ˜¯255çš„åƒç´ å…¨å˜æˆ0ã€‘ï¼Œ</span></span><br><span class="line"><span class="comment">//    å¦‚æœä¸Šå±‚ä¸ºå…¨ç™½è‰²ï¼Œåˆ™æ ¹æœ¬ä¸ä¼šå½±å“ä¸‹å±‚ã€‚</span></span><br><span class="line"><span class="comment">//    ç»“æœæœ€äº®çš„åœ°æ–¹ä¸ä¼šé«˜äºä¸‹å±‚çš„åƒç´ å€¼ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    resultValue = originValue - (<span class="number">255</span> - originValue) * (<span class="number">255</span> - bValue) / bValue;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Color Dodge é¢œè‰²å‡æ·¡ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)ColorDodge:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//C=A+(AÃ—B)/Båç›¸</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼å’Œä¸Šä¸€ä¸ªæ¨¡å¼åˆšå¥½ç›¸åã€‚</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼ä¸‹ï¼Œä¸Šå±‚çš„äº®åº¦å†³å®šäº†ä¸‹å±‚çš„æš´éœ²ç¨‹åº¦ã€‚</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šå±‚è¶Šäº®ï¼Œä¸‹å±‚è·å–çš„å…‰è¶Šå¤šï¼Œä¹Ÿå°±æ˜¯è¶Šäº®ã€‚</span></span><br><span class="line"><span class="comment">//å¦‚æœä¸Šå±‚æ˜¯çº¯é»‘è‰²ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰äº®åº¦ï¼Œåˆ™æ ¹æœ¬ä¸ä¼šå½±å“ä¸‹å±‚ï¼Œ</span></span><br><span class="line"><span class="comment">//ã€å¦‚æœä¸Šå±‚æ˜¯çº¯ç™½è‰²ï¼Œåˆ™ä¸‹å±‚é¢œè‰²å€¼ä¸æ˜¯0çš„åƒç´ å…¨å˜æˆ255ã€‘ã€‚</span></span><br><span class="line"><span class="comment">//ç»“æœæœ€é»‘çš„åœ°æ–¹ä¸ä¼šä½äºä¸‹å±‚çš„åƒç´ å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">128</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    resultValue = originValue + originValue * bValue / (<span class="number">255</span> - bValue);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hard Light å¼ºå…‰ï¼š</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">int</span>)HardLight:(<span class="keyword">int</span>)originValue &#123;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//B&lt;=128åˆ™ C=(AÃ—B)/128</span></span><br><span class="line"><span class="comment">//B&gt;128åˆ™ C=255-(Aåç›¸Ã—Båç›¸)/128</span></span><br><span class="line"><span class="comment">//è¯¥æ¨¡å¼å®Œå…¨ç›¸å¯¹åº”äºOverlayï¼ˆå åŠ ï¼‰æ¨¡å¼ä¸‹ï¼Œä¸¤ä¸ªå›¾å±‚è¿›è¡Œæ¬¡åºäº¤æ¢çš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">//å¦‚è¿‡ä¸Šå±‚çš„é¢œè‰²é«˜äº50%ç°ï¼Œåˆ™ä¸‹å±‚è¶Šäº®ï¼Œåä¹‹è¶Šæš—ã€‚</span></span><br><span class="line"><span class="comment">//ã€å¦‚æœå°†ä¸Šå±‚å›¾å±‚è®¾ä¸ºå åŠ ï¼Œä¸‹å±‚è®¾ä¸ºå¼ºå…‰ï¼Œåˆ™æ”¹å˜å›¾å±‚é¡ºåºä¸å½±å“ç»“æœã€‚ã€‘</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> bValue = <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">int</span> resultValue = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(bValue &lt;= <span class="number">128</span>)&#123;</span><br><span class="line">        resultValue =   originValue * bValue / <span class="number">128</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        resultValue = <span class="number">255</span> - (<span class="number">255</span> - originValue) * (<span class="number">255</span> - bValue) / <span class="number">128</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (resultValue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (resultValue &gt; <span class="number">255</span>) &#123;</span><br><span class="line">        resultValue = <span class="number">255</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> resultValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘ç°ä¸€ç¯‡æ–‡ç«  <a href="https://juejin.im/post/5cd17612f265da037a3d0183" target="_blank" rel="noopener">iOSâ€”â€”éšå½¢æ°´å°çš„å®ç°å’Œã€é¢œè‰²åŠ æ·±ã€ç®—æ³•</a> æ–‡ä¸­è¯´ç”¨ é¢œè‰²åŠ æ·±æ¥æ˜¾ç¤ºéšå½¢æ°´å°ï¼Œä½†æ˜¯æˆ‘æ¢äº†å‡ å¼ å›¾ç‰‡å®è·µäº†ä¸€ä¸‹ æ•ˆæœä¸ç†æƒ³ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å®è·µä¸‹ã€‚</p>
<h2 id="é©¬èµ›å…‹"><a href="#é©¬èµ›å…‹" class="headerlink" title="é©¬èµ›å…‹"></a>é©¬èµ›å…‹</h2><p>ç®€å•é©¬èµ›å…‹æ ¸å¿ƒç®—æ³•çš„å¤§æ¦‚åŸç†å°±æ˜¯æŠŠæŸä¸€ä¸ªç‚¹çš„é¢œè‰²èµ‹å€¼ç»™å®ƒå‘¨å›´çš„æŒ‡å®šåŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸå¤§å°å¯ä»¥æˆ‘ä»¬è‡ªå·±æ¥å®šä¹‰ã€‚</p>
<p>æŒ‰ç…§è¿™ç§æƒ³æ³•å¯ä»¥åšåˆ°ï¼š</p>
<p><img src="/res/iOSImg/msk.png" alt></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="comment">//åƒç´ å¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; inputHeight; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputWidth; i++) &#123;</span><br><span class="line">            <span class="comment">//åŸå›¾ åƒç´ rgbaä¿¡æ¯</span></span><br><span class="line">            <span class="built_in">UInt32</span> * currentPixel = inputPixels + (j * inputWidth) + i;</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line">            <span class="keyword">float</span> markP = <span class="number">10</span>;<span class="comment">//10x10åŒºåŸŸ</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> centerX = <span class="number">0</span> , centerY = <span class="number">0</span>;</span><br><span class="line">            centerX =  floor(i/markP)*markP + <span class="number">0.5</span>*markP;</span><br><span class="line">            centerX = centerX &gt;= (inputWidth<span class="number">-1</span>) ? (inputWidth<span class="number">-1</span>) : centerX;</span><br><span class="line">            centerY =  floor(j/markP)*markP + <span class="number">0.5</span>*markP;</span><br><span class="line">            centerY = centerY &gt;= (inputHeight<span class="number">-1</span>) ? (inputHeight<span class="number">-1</span>) : centerY;</span><br><span class="line">            <span class="built_in">UInt32</span> * centerPixel = inputPixels + (centerY * inputWidth) + centerX;</span><br><span class="line">            <span class="built_in">UInt32</span> centerColor = *centerPixel;</span><br><span class="line">            <span class="built_in">UInt32</span> centerR,centerG,centerB,centerA;</span><br><span class="line">            centerR=R(centerColor);</span><br><span class="line">            centerG=G(centerColor);</span><br><span class="line">            centerB=B(centerColor);</span><br><span class="line">            centerA=A(centerColor);</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            *currentPixel = RGBAMake(centerR, centerG, centerB, centerA);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>
<h2 id="æå–ä¸»è‰²è°ƒ"><a href="#æå–ä¸»è‰²è°ƒ" class="headerlink" title="æå–ä¸»è‰²è°ƒ"></a>æå–ä¸»è‰²è°ƒ</h2><p>ref:<br><a href="https://github.com/tangdiforx/iOSPalette" target="_blank" rel="noopener">iOS-palette</a><br><a href="https://developer.android.com/reference/android/support/v7/palette/package-summary" target="_blank" rel="noopener">android-palette</a><br><a href="https://github.com/google/palette.js" target="_blank" rel="noopener">js-palette</a></p>
<p>éå†ä¸€éå›¾ç‰‡çš„æ‰€æœ‰åƒç´ ä¿¡æ¯ï¼Œç„¶åç»Ÿè®¡ä¸€ä¸‹å“ªä¸ªRGBå€¼æœ€å¤šï¼Œä¸å°±æ˜¯ä¸»è‰²è°ƒå˜›ï¼Ÿä½†æ˜¯äººçœ¼å’Œå†·å†°å†°çš„æ•°æ®è¿˜æ˜¯å­˜åœ¨å·®å¼‚çš„ã€‚ Paletteé€šè¿‡é¥±å’Œåº¦ç­›é€‰ é¢œè‰²åŒºåŸŸè§£å†³é¢œè‰²åˆ†æ•£æ¥é€‰å‡ºä¸»è‰²è°ƒã€‚å‚è€ƒ<a href="https://www.jianshu.com/p/01df6010dded" target="_blank" rel="noopener">iOSå›¾ç‰‡ç²¾ç¡®æå–ä¸»è‰²è°ƒç®—æ³•iOS-Palette</a></p>
<p><img src="https://upload-images.jianshu.io/upload_images/5806025-9188b291498651e7.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/720/format/webp" alt></p>
]]></content>
      <categories>
        <category>iOSå›¾ç‰‡</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>å›¾ç‰‡</tag>
      </tags>
  </entry>
  <entry>
    <title>iOSå›¾ç‰‡-æœ€ä½³å®è·µ</title>
    <url>/quick-start/%E5%9B%BE%E7%89%87/iOS%E5%9B%BE%E7%89%87-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<blockquote>
<p>ä»‹ç»ä¸‹ wwdc 2018 Image and Graphics Best Practices ä¸­å›¾ç‰‡å¤„ç†è§£å‹ç›¸å…³çŸ¥è¯†ç‚¹<br>ref: <a href="https://developer.apple.com/videos/play/wwdc2018/219" target="_blank" rel="noopener">Image and Graphics Best Practices</a></p>
</blockquote>
<h2 id="å›¾ç‰‡å¤„ç†è¿‡ç¨‹"><a href="#å›¾ç‰‡å¤„ç†è¿‡ç¨‹" class="headerlink" title="å›¾ç‰‡å¤„ç†è¿‡ç¨‹"></a>å›¾ç‰‡å¤„ç†è¿‡ç¨‹</h2><p>ä¸€å¼ å›¾ç‰‡ä»ç£ç›˜ä¸­æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼šä»ç£ç›˜åŠ è½½åŸå§‹å‹ç¼©çš„å›¾ç‰‡ä¿¡æ¯ã€è§£ç äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®ä¸ºä½å›¾ã€æ¸²æŸ“å›¾ç‰‡æœ€ç»ˆç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</p>
<!-- ![](/res/imgBestP/imgBestP1.png) -->
<p><img src="/res/imgBestP/imgBestP1.png" width="80%"></p>
<p>åœ¨å®é™…çš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼ŒUIImageè´Ÿè´£è§£å‹Data Bufferå†…å®¹å¹¶ç”³è¯·bufferï¼ˆImage Bufferï¼‰å­˜å‚¨è§£å‹åçš„å›¾ç‰‡ä¿¡æ¯ï¼Œç„¶åUIImageViewè´Ÿè´£å°†Image Buffer æ‹·è´è‡³ framebufferï¼Œç”¨äºç»™æ˜¾ç¤ºç¡¬ä»¶æä¾›é¢œè‰²ä¿¡æ¯ã€‚</p>
<p>è§£å‹è¿‡ç¨‹æ˜¯ä¸€ä¸ªå¤§é‡å ç”¨CPUèµ„æºçš„å·¥ä½œï¼Œå› æ­¤UIImage ä¼šretainå­˜å‚¨è§£å‹åä¿¡æ¯çš„Image Bufferä»¥ä¾¿ç»™é‡å¤çš„æ¸²æŸ“å·¥ä½œæä¾›ä¿¡æ¯ï¼ŒImage Bufferä¸å›¾ç‰‡çš„å®é™…å°ºå¯¸æœ‰å…³ï¼ˆç†è®ºå€¼ä¸ºheight <em> width </em> 4 bytesï¼‰ï¼Œä¸å›¾ç‰‡æ–‡ä»¶å¤§å°æ— å…³ã€‚è‹¥æ˜¯åœ¨TableViewç­‰åˆ—è¡¨ä¸­è¿ç»­åŠ è½½å¤šå¼ å›¾ç‰‡ï¼Œä¾¿ä¼šå¼•å‘è¿ç»­çš„å¤§å—å†…å­˜åˆ†é…ï¼Œè¿™å°†å¯¹Memoryå’ŒCPUå¸¦æ¥æ²‰é‡çš„è´Ÿæ‹…ã€‚</p>
<a id="more"></a>
<h3 id="Data-Buffer-Image-Buffer-Frame-Buffer"><a href="#Data-Buffer-Image-Buffer-Frame-Buffer" class="headerlink" title="Data Buffer / Image Buffer / Frame Buffer"></a>Data Buffer / Image Buffer / Frame Buffer</h3><p>å›¾ç‰‡å¤„ç†è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸‰ç§buffer</p>
<h4 id="Data-Buffer"><a href="#Data-Buffer" class="headerlink" title="Data Buffer"></a>Data Buffer</h4><!-- ![](/res/imgBestP/imgBestP2.png) -->
<p><img src="/res/imgBestP/imgBestP2.png" width="80%"><br>Data Bufferå­˜å‚¨äº†å›¾ç‰‡çš„å…ƒæ•°æ®ï¼Œæˆ‘ä»¬å¸¸è§çš„å›¾ç‰‡æ ¼å¼ï¼Œjpegï¼Œpngç­‰éƒ½æ˜¯å‹ç¼©å›¾ç‰‡æ ¼å¼ã€‚Data Bufferçš„å†…å­˜å¤§å°å°±æ˜¯æºå›¾ç‰‡åœ¨ç£ç›˜ä¸­çš„å¤§å°ã€‚</p>
<h4 id="Image-Buffer"><a href="#Image-Buffer" class="headerlink" title="Image Buffer"></a>Image Buffer</h4><!-- ![](/res/imgBestP/imgBestP3.png) -->
<p><img src="/res/imgBestP/imgBestP3.png" width="80%"><br>Image Bufferå­˜å‚¨çš„å°±æ˜¯å›¾ç‰‡è§£ç åçš„åƒç´ æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ä½å›¾ã€‚ Bufferä¸­æ¯ä¸€ä¸ªå…ƒç´ æè¿°çš„ä¸€ä¸ªåƒç´ çš„é¢œè‰²ä¿¡æ¯ï¼Œbufferçš„sizeå’Œå›¾ç‰‡çš„sizeæˆæ­£ç›¸å…³å…³ç³»ã€‚</p>
<h4 id="Frame-Buffer"><a href="#Frame-Buffer" class="headerlink" title="Frame Buffer"></a>Frame Buffer</h4><!-- ![](/res/imgBestP/imgBestP4.png) -->
<p><img src="/res/imgBestP/imgBestP3.png" width="80%"></p>
<p>Frame Buffer å­˜å‚¨äº†appæ¯å¸§çš„å®é™…è¾“å‡ºã€‚åœ¨åº”ç”¨ç¨‹åºæ›´æ–°å›¾å±‚æ—¶ï¼ŒUIKitå°†windowåŠå…¶subviewsæ¸²æŸ“è‡³framebufferï¼Œè¿™ä¸ªframebufferæä¾›æ¯ä¸ªåƒç´ çš„ä¿¡æ¯ä»¥ä¾›æ˜¾ç¤ºç¡¬ä»¶å®šæ—¶è¯»å–ï¼Œè¯»å–çš„é¢‘ç‡ä¸€èˆ¬ä¸º60Hzï¼Œä½†åœ¨ipadä¸Šå¯æå‡è‡³120Hzã€‚</p>
<h3 id="åŠ è½½å’Œè§£å‹"><a href="#åŠ è½½å’Œè§£å‹" class="headerlink" title="åŠ è½½å’Œè§£å‹"></a>åŠ è½½å’Œè§£å‹</h3><p><img src="/res/imgBestP/imgBestP5.png" alt></p>
<p>ä¸€èˆ¬ä½¿ç”¨imageNamed:æˆ–è€…imageWithData:ä»å†…å­˜ä¸­åŠ è½½å›¾ç‰‡ç”ŸæˆUIImageçš„å®ä¾‹ï¼Œæ­¤åˆ»å›¾ç‰‡å¹¶ä¸ä¼šè§£å‹ï¼Œå½“ RunLoop å‡†å¤‡å¤„ç†å›¾ç‰‡æ˜¾ç¤ºçš„äº‹åŠ¡ï¼ˆCATransactionï¼‰æ—¶ï¼Œæ‰è¿›è¡Œè§£å‹ï¼Œè€Œè¿™ä¸ªè§£å‹è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­çš„ï¼Œè¿™æ˜¯å¯¼è‡´å¡é¡¿çš„é‡è¦å› ç´ ã€‚</p>
<p>è§£ç åçš„å›¾ç‰‡å†…å­˜å ç”¨ä¼šæ¯”åŸå›¾å¤§å°å¤§å¾ˆå¤šã€‚ImageBufferæŒ‰ç…§æ¯ä¸ªåƒç´ RGBAå››ä¸ªå­—èŠ‚å¤§å°ï¼Œä¸€å¼ 1080pçš„å›¾ç‰‡è§£ç åçš„ä½å›¾å¤§å°æ˜¯1920 <em> 1080 </em> 4 / 1024 / 1024ï¼Œçº¦7.9mbï¼Œè€ŒåŸå›¾å‡è®¾æ˜¯jpgï¼Œå‹ç¼©æ¯”1æ¯”20ï¼Œå¤§çº¦350kbï¼Œå¯è§è§£ç åçš„å†…å­˜å ç”¨æ˜¯ç›¸å½“å¤§çš„</p>
<h4 id="imageNamed-æ–¹æ³•"><a href="#imageNamed-æ–¹æ³•" class="headerlink" title="imageNamed: æ–¹æ³•"></a>imageNamed: æ–¹æ³•</h4><p>é€šè¿‡ imageNamed åˆ›å»º UIImage æ—¶ï¼Œç³»ç»Ÿå®é™…ä¸Šåªæ˜¯åœ¨ Bundle å†…æŸ¥æ‰¾åˆ°æ–‡ä»¶åï¼Œç„¶åæŠŠè¿™ä¸ªæ–‡ä»¶åæ”¾åˆ° UIImage é‡Œè¿”å›ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œå®é™…çš„æ–‡ä»¶è¯»å–å’Œè§£ç ã€‚å½“ UIImage ç¬¬ä¸€æ¬¡æ˜¾ç¤ºåˆ°å±å¹•ä¸Šæ—¶ï¼Œå…¶å†…éƒ¨çš„è§£ç æ–¹æ³•æ‰ä¼šè¢«è°ƒç”¨ï¼ŒåŒæ—¶è§£ç ç»“æœä¼šä¿å­˜åˆ°ä¸€ä¸ªå…¨å±€ç¼“å­˜å»ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›ç¼“å­˜éƒ½æ˜¯å…¨å±€çš„ï¼Œå¹¶ä¸ä¼šå› ä¸ºå½“å‰UIImageå®ä¾‹çš„é‡Šæ”¾è€Œæ¸…é™¤ï¼Œåœ¨æ”¶åˆ°å†…å­˜è­¦å‘Šæˆ–è€… APP ç¬¬ä¸€æ¬¡è¿›å…¥åå°æ‰æœ‰å¯èƒ½ä¼šæ¸…é™¤ï¼Œè€Œè¿™ä¸ªæ¸…é™¤çš„æ—¶æœºå’Œå†…å®¹æ˜¯ç³»ç»Ÿå†³å®šçš„ï¼Œæˆ‘ä»¬æ— æ³•å¹²æ¶‰ã€‚</p>
<h4 id="imageWithData-æ–¹æ³•"><a href="#imageWithData-æ–¹æ³•" class="headerlink" title="imageWithData: æ–¹æ³•"></a>imageWithData: æ–¹æ³•</h4><p>é€šè¿‡æ•°æ®åˆ›å»º UIImage æ—¶ï¼ŒUIImage åº•å±‚æ˜¯è°ƒç”¨ ImageIO çš„ CGImageSourceCreateWithData() æ–¹æ³•ã€‚è¯¥æ–¹æ³•æœ‰ä¸ªå‚æ•°å« ShouldCacheï¼Œåœ¨ 64 ä½çš„è®¾å¤‡ä¸Šï¼Œè¿™ä¸ªå‚æ•°æ˜¯é»˜è®¤å¼€å¯çš„ã€‚è¿™ä¸ªå›¾ç‰‡ä¹Ÿæ˜¯åŒæ ·åœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºåˆ°å±å¹•æ—¶æ‰ä¼šè¢«è§£ç ï¼Œéšåè§£ç æ•°æ®è¢«ç¼“å­˜åˆ° CGImage å†…éƒ¨ã€‚ä¸ imageNamed åˆ›å»ºçš„å›¾ç‰‡ä¸åŒï¼Œå¦‚æœè¿™ä¸ªå›¾ç‰‡è¢«é‡Šæ”¾æ‰ï¼Œå…¶å†…éƒ¨çš„è§£ç æ•°æ®ä¹Ÿä¼šè¢«ç«‹åˆ»é‡Šæ”¾ã€‚</p>
<p><strong>ä¸¤ç§åŠ è½½æ–¹å¼çš„åŒºåˆ«</strong> ä»ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼ŒimageNamed:ä½¿ç”¨æ—¶ä¼šäº§ç”Ÿå…¨å±€çš„å†…å­˜å ç”¨ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡ä½¿ç”¨åŒä¸€å¼ å›¾ç‰‡æ—¶æ€§èƒ½å¾ˆå¥½ï¼›imageWithData:ä¸ä¼šæœ‰å…¨å±€çš„å†…å­˜å ç”¨ï¼Œä½†å¯¹äºåŒä¸€å¼ å›¾ç‰‡æ¯æ¬¡åŠ è½½å’Œè§£å‹éƒ½ä¼šâ€œä»å¤´å¼€å§‹â€ã€‚ç”±æ­¤å¯è§ï¼ŒimageNamed:é€‚åˆâ€œå°â€ä¸”â€œä½¿ç”¨é¢‘ç¹â€çš„å›¾ç‰‡ï¼ŒimageWithData:é€‚åˆâ€œå¤§â€ä¸”â€œä½é¢‘ä½¿ç”¨â€çš„å›¾ç‰‡ã€‚</p>
<h4 id="æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ"><a href="#æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ" class="headerlink" title="æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ"></a>æ€ä¹ˆèƒ½é¿å…ç¼“å­˜å‘¢ï¼Ÿ</h4><ol>
<li>æ‰‹åŠ¨è°ƒç”¨ CGImageSourceCreateWithData() æ¥åˆ›å»ºå›¾ç‰‡ï¼Œå¹¶æŠŠ ShouldCache å’Œ ShouldCacheImmediately å…³æ‰ã€‚è¿™ä¹ˆåšä¼šå¯¼è‡´æ¯æ¬¡å›¾ç‰‡æ˜¾ç¤ºåˆ°å±å¹•æ—¶ï¼Œè§£ç æ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨ï¼Œé€ æˆå¾ˆå¤§çš„ CPU å ç”¨ã€‚</li>
<li>æŠŠå›¾ç‰‡ç”¨ CGContextDrawImage() ç»˜åˆ¶åˆ°ç”»å¸ƒä¸Šï¼Œç„¶åæŠŠç”»å¸ƒçš„æ•°æ®å–å‡ºæ¥å½“ä½œå›¾ç‰‡ã€‚è¿™ä¹Ÿæ˜¯å¸¸è§çš„ç½‘ç»œå›¾ç‰‡åº“çš„åšæ³•ã€‚</li>
</ol>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><h3 id="å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾"><a href="#å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾" class="headerlink" title="å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾"></a>å¤§å›¾ä½¿ç”¨ç¼©ç•¥å›¾</h3><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯èƒ½ä¸šåŠ¡ä¸­éœ€è¦è½½å…¥ä¸€å¼ å¾ˆå¤§çš„å›¾ç‰‡ã€‚è¿™æ—¶ï¼Œè‹¥è¿˜ä½¿ç”¨å¸¸è§„çš„æ–¹å¼åŠ è½½ä¼šå ç”¨è¿‡å¤šçš„å†…å­˜ï¼›å†µä¸”ï¼Œè‹¥å›¾ç‰‡çš„åƒç´ è¿‡å¤§ï¼ˆç›®å‰ä¸»æµ iOS è®¾å¤‡æœ€é«˜æ”¯æŒ 4096 x 4096 çº¹ç†å°ºå¯¸ï¼‰ï¼Œåœ¨æ˜¾ç¤ºçš„æ—¶å€™ CPU å’Œ GPU éƒ½ä¼šæ¶ˆè€—é¢å¤–çš„èµ„æºæ¥å¤„ç†å›¾ç‰‡ã€‚å¯ä»¥é‡‡ç”¨imageIO apiæ¥ç”Ÿæˆç¼©ç•¥å›¾</p>
<p><img src="/res/imgBestP/imgBestP6.png" alt></p>
<p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼ŒæŒ‡å®šæ˜¾ç¤ºåŒºåŸŸå¤§å°</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func downsample(imageAt imageURL:URL,to pointSize:<span class="built_in">CGSize</span>,scale:<span class="built_in">CGFloat</span>)-&gt;<span class="built_in">UIImage</span>&#123;</span><br><span class="line"><span class="comment">//è®¾ç½®kCGImageSourceShouldCacheä¸ºfalseï¼Œé¿å…ç¼“å­˜è§£ç åçš„æ•°æ®ï¼Œ64ä½è®¾ç½®ä¸Šé»˜è®¤æ˜¯å¼€å¯ç¼“å­˜çš„</span></span><br><span class="line">    let imageSourceOptions = [kCGImageSourceShouldCache:<span class="literal">false</span>] as <span class="built_in">CFDictionary</span></span><br><span class="line">    let imageSouce = <span class="built_in">CGImageSourceCreateWithURL</span>(imageURL as <span class="built_in">CFURL</span>, imageSourceOptions)!</span><br><span class="line">    </span><br><span class="line">    let maxDimensionInPixels = max(pointSize.width,pointSize.height) * scale</span><br><span class="line"><span class="comment">//è®¾ç½®kCGImageSourceShouldCacheImmediatelyä¸ºtrueï¼Œé¿å…åœ¨éœ€è¦æ¸²æŸ“çš„æ—¶å€™æ‰åšè§£ç ï¼Œé»˜è®¤é€‰é¡¹æ˜¯false    </span></span><br><span class="line">    let downsampleOptions =</span><br><span class="line">     [</span><br><span class="line">        kCGImageSourceCreateThumbnailFromImageAlways:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceShouldCacheImmediately:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceCreateThumbnailWithTransform:<span class="literal">true</span>,</span><br><span class="line">        kCGImageSourceThumbnailMaxPixelSize:maxDimensionInPixels</span><br><span class="line">     ] as <span class="built_in">CFDictionary</span></span><br><span class="line">    </span><br><span class="line">    let downsampledImage = <span class="built_in">CGImageSourceCreateThumbnailAtIndex</span>(imageSouce, <span class="number">0</span>, downsampleOptions)!</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: downsampledImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä»–ç¼©ç•¥æ–¹æ³•å¯ä»¥çœ‹<a href="../iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•">iOSå›¾ç‰‡-å›¾ç‰‡ç¼©ç•¥æ–¹æ³•</a></p>
<h3 id="å¤§å›¾ä½¿ç”¨CATiledLayer"><a href="#å¤§å›¾ä½¿ç”¨CATiledLayer" class="headerlink" title="å¤§å›¾ä½¿ç”¨CATiledLayer"></a>å¤§å›¾ä½¿ç”¨CATiledLayer</h3><p>æœ‰äº›æ—¶å€™ä½ å¯èƒ½éœ€è¦ç»˜åˆ¶ä¸€ä¸ªå¾ˆå¤§çš„å›¾ç‰‡ï¼Œå¸¸è§çš„ä¾‹å­å°±æ˜¯ä¸€ä¸ªé«˜åƒç´ çš„ç…§ç‰‡æˆ–è€…æ˜¯åœ°çƒè¡¨é¢çš„è¯¦ç»†åœ°å›¾ã€‚iOSåº”ç”¨é€šç•…è¿è¡Œåœ¨å†…å­˜å—é™çš„è®¾å¤‡ä¸Šï¼Œæ‰€ä»¥è¯»å–æ•´ä¸ªå›¾ç‰‡åˆ°å†…å­˜ä¸­æ˜¯ä¸æ˜æ™ºçš„ã€‚è½½å…¥å¤§å›¾å¯èƒ½ä¼šç›¸å½“åœ°æ…¢ï¼Œé‚£äº›å¯¹ä½ çœ‹ä¸Šå»æ¯”è¾ƒæ–¹ä¾¿çš„åšæ³•ï¼ˆåœ¨ä¸»çº¿ç¨‹è°ƒç”¨UIImageçš„-imageNamed:æ–¹æ³•æˆ–è€…-imageWithContentsOfFile:æ–¹æ³•ï¼‰å°†ä¼šé˜»å¡ä½ çš„ç”¨æˆ·ç•Œé¢ï¼Œè‡³å°‘ä¼šå¼•èµ·åŠ¨ç”»å¡é¡¿ç°è±¡ã€‚</p>
<p>èƒ½é«˜æ•ˆç»˜åˆ¶åœ¨iOSä¸Šçš„å›¾ç‰‡ä¹Ÿæœ‰ä¸€ä¸ªå¤§å°é™åˆ¶ã€‚æ‰€æœ‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å›¾ç‰‡æœ€ç»ˆéƒ½ä¼šè¢«è½¬åŒ–ä¸ºOpenGLçº¹ç†ï¼ŒåŒæ—¶OpenGLæœ‰ä¸€ä¸ªæœ€å¤§çš„çº¹ç†å°ºå¯¸ï¼ˆé€šå¸¸æ˜¯20482048ï¼Œæˆ–40964096ï¼Œè¿™ä¸ªå–å†³äºè®¾å¤‡å‹å·ï¼‰ã€‚å¦‚æœä½ æƒ³åœ¨å•ä¸ªçº¹ç†ä¸­æ˜¾ç¤ºä¸€ä¸ªæ¯”è¿™å¤§çš„å›¾ï¼Œå³ä¾¿å›¾ç‰‡å·²ç»å­˜åœ¨äºå†…å­˜ä¸­äº†ï¼Œä½ ä»ç„¶ä¼šé‡åˆ°å¾ˆå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºCore Animationå¼ºåˆ¶ç”¨CPUå¤„ç†å›¾ç‰‡è€Œä¸æ˜¯æ›´å¿«çš„GPUï¼ˆè§ç¬¬12ç« ã€é€Ÿåº¦çš„æ›²è°ƒã€ï¼Œå’Œç¬¬13ç« ã€é«˜æ•ˆç»˜å›¾ã€ï¼Œå®ƒæ›´åŠ è¯¦ç»†åœ°è§£é‡Šäº†è½¯ä»¶ç»˜åˆ¶å’Œç¡¬ä»¶ç»˜åˆ¶ï¼‰ã€‚</p>
<p>CATiledLayerä¸ºè½½å…¥å¤§å›¾é€ æˆçš„æ€§èƒ½é—®é¢˜æä¾›äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼šå°†å¤§å›¾åˆ†è§£æˆå°ç‰‡ç„¶åå°†ä»–ä»¬å•ç‹¬æŒ‰éœ€è½½å…¥ã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"ViewController.h"</span></span></span><br><span class="line"><span class="meta">#import </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIScrollView</span> *scrollView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    <span class="comment">//add the tiled layer</span></span><br><span class="line">    <span class="built_in">CATiledLayer</span> *tileLayer = [<span class="built_in">CATiledLayer</span> layer];ï¿¼</span><br><span class="line">    tileLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">2048</span>, <span class="number">2048</span>);</span><br><span class="line">    tileLayer.delegate = <span class="keyword">self</span>; [<span class="keyword">self</span>.scrollView.layer addSublayer:tileLayer];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//configure the scroll view</span></span><br><span class="line">    <span class="keyword">self</span>.scrollView.contentSize = tileLayer.frame.size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw layer</span></span><br><span class="line">    [tileLayer setNeedsDisplay];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drawLayer:(<span class="built_in">CATiledLayer</span> *)layer inContext:(<span class="built_in">CGContextRef</span>)ctx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//determine tile coordinate</span></span><br><span class="line">    <span class="built_in">CGRect</span> bounds = <span class="built_in">CGContextGetClipBoundingBox</span>(ctx);</span><br><span class="line">    <span class="built_in">NSInteger</span> x = floor(bounds.origin.x / layer.tileSize.width);</span><br><span class="line">    <span class="built_in">NSInteger</span> y = floor(bounds.origin.y / layer.tileSize.height);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//load tile image</span></span><br><span class="line">    <span class="built_in">NSString</span> *imageName = [<span class="built_in">NSString</span> stringWithFormat: <span class="string">@"Snowman_%02i_%02i"</span>, x, y];</span><br><span class="line">    <span class="built_in">NSString</span> *imagePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:imageName ofType:<span class="string">@"jpg"</span>];</span><br><span class="line">    <span class="built_in">UIImage</span> *tileImage = [<span class="built_in">UIImage</span> imageWithContentsOfFile:imagePath];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//draw tile</span></span><br><span class="line">    <span class="built_in">UIGraphicsPushContext</span>(ctx);</span><br><span class="line">    [tileImage drawInRect:bounds];</span><br><span class="line">    <span class="built_in">UIGraphicsPopContext</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h3 id="å¼‚æ­¥åŠ è½½è§£å‹"><a href="#å¼‚æ­¥åŠ è½½è§£å‹" class="headerlink" title="å¼‚æ­¥åŠ è½½è§£å‹"></a>å¼‚æ­¥åŠ è½½è§£å‹</h3><p>å¯¹äºåŠ è½½è¿‡ç¨‹ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§æˆ–åŠ è½½é¢‘ç¹å½±å“äº†å¸§ç‡ï¼ˆæ¯”å¦‚åˆ—è¡¨å±•ç¤ºå¤§å›¾ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å¼‚æ­¥æ–¹å¼åŠ è½½å›¾ç‰‡ï¼Œå‡å°‘ä¸»çº¿ç¨‹çš„å‹åŠ›,è§£å‹æ˜¯è€—æ—¶çš„ï¼Œè€Œç³»ç»Ÿé»˜è®¤æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸šç•Œé€šå¸¸æœ‰ä¸€ç§åšæ³•æ˜¯ï¼Œå¼‚æ­¥å¼ºåˆ¶è§£å‹ï¼Œä¹Ÿå°±æ˜¯åœ¨å¼‚æ­¥çº¿ç¨‹ä¸»åŠ¨å°†äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®è§£å‹æˆä½å›¾æ•°æ®ï¼Œä½¿ç”¨CGBitmapContextCreate(â€¦)ç³»åˆ—æ–¹æ³•å°±èƒ½å®ç°ã€‚ä»£ç å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let serialQueue = DispatchQueue(label: &quot;Decode queue&quot;)</span><br><span class="line">func collectionView(_ collectionView:UICollectionView,prefetcgItemAt indexPaths:[IndexPath])&#123;</span><br><span class="line">    //å¼‚æ­¥è§£å‹ ç”Ÿæˆç¼©ç•¥å›¾</span><br><span class="line">    for indexPath in indexPaths&#123;</span><br><span class="line">        serialQueue.async &#123;</span><br><span class="line">            let downsampledImage = downsample(images[IndexPath])</span><br><span class="line">            DispatchQueue.main.async &#123;self.update(at:IndexPath.with:downsampledImage)&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆç†ä½¿ç”¨drawæ–¹æ³•"><a href="#åˆç†ä½¿ç”¨drawæ–¹æ³•" class="headerlink" title="åˆç†ä½¿ç”¨drawæ–¹æ³•"></a>åˆç†ä½¿ç”¨<code>draw</code>æ–¹æ³•</h3><p>é‡è½½<code>draw</code>æ–¹æ³•ä¼šå¯¼è‡´å†…å­˜çˆ†æ¶¨ã€‚åŸå› å¦‚ä¸‹ï¼š</p>
<p><img src="/res/imgBestP/imgBestP7.png" alt></p>
<p>ä¸€æ—¦ä½ å®ç°äº†<em>CALayerDelegate</em>åè®®ä¸­çš„<code>-drawLayer:inContext:</code>æ–¹æ³•æˆ–è€…UIViewä¸­çš„<code>-drawRect:</code>æ–¹æ³•ï¼ˆå…¶å®å°±æ˜¯å‰è€…çš„åŒ…è£…æ–¹æ³•ï¼‰ï¼ŒCALayeråˆ›å»ºäº†ä¸€ä¸ªåˆé€‚å°ºå¯¸çš„ç©ºå¯„å®¿å›¾ï¼ˆå°ºå¯¸ç”±boundså’ŒcontentsScaleå†³å®šï¼‰å’Œä¸€ä¸ªCore Graphicsçš„ç»˜åˆ¶ä¸Šä¸‹æ–‡ç¯å¢ƒ(Backing Store)ï¼Œä¸ºç»˜åˆ¶å¯„å®¿å›¾åšå‡†å¤‡ï¼Œå®ƒä½œä¸ºctxå‚æ•°ä¼ å…¥ã€‚å›¾å±‚å°±åˆ›å»ºäº†ä¸€ä¸ªç»˜åˆ¶ä¸Šä¸‹æ–‡(Backing Store)ï¼Œè¿™ä¸ªä¸Šä¸‹æ–‡éœ€è¦çš„å†…å­˜å¯ä»è¿™ä¸ªå…¬å¼å¾—å‡ºï¼šå›¾å±‚å®½ <em> å›¾å±‚é«˜</em> 4 å­—èŠ‚ï¼Œå®½é«˜çš„å•ä½å‡ä¸ºåƒç´ ã€‚ä»¥iphone6ä¸ºä¾‹ï¼Œ750 <em> 1134 </em> 4 å­—èŠ‚ â‰ˆ 3.4 Mb ã€‚</p>
<p>æ€»ç»“ä¸‹è¿™ç§ä½¿ç”¨drawRectç»˜åˆ¶æ–¹æ¡ˆçš„é—®é¢˜</p>
<ol>
<li>Backing Storeçš„åˆ›å»ºé€ æˆäº†ä¸å¿…è¦çš„å†…å­˜å¼€é”€</li>
<li>UIImageå…ˆç»˜åˆ¶åˆ°Backing Storeï¼Œå†æ¸²æŸ“åˆ°frameBufferï¼Œä¸­é—´å¤šäº†ä¸€å±‚å†…å­˜æ‹·è´</li>
<li>èƒŒæ™¯é¢œè‰²ä¸éœ€è¦ç»˜åˆ¶åˆ°Backing Storeï¼Œç›´æ¥ä½¿ç”¨BackGroundColorç»˜åˆ¶åˆ°FrameBuffer</li>
</ol>
<p>æ‰€ä»¥ï¼Œæ­£ç¡®çš„å®ç°å§¿åŠ¿æ˜¯å°†è¿™ä¸ªå¤§çš„viewæ‹†åˆ†æˆå°çš„subviewé€ä¸ªå®ç°ã€‚</p>
<h3 id="æ¨èä½¿ç”¨Image-Assets"><a href="#æ¨èä½¿ç”¨Image-Assets" class="headerlink" title="æ¨èä½¿ç”¨Image Assets"></a>æ¨èä½¿ç”¨Image Assets</h3><p>åŸºäºåç§°å’Œç‰¹æ•ˆä¼˜åŒ–äº†æŸ¥æ‰¾æ•ˆç‡ï¼Œæ›´å¿«çš„æŸ¥æ‰¾å›¾ç‰‡<br>è¿è¡Œæ—¶ï¼Œå¯¹å†…å­˜çš„ç®¡ç†ä¹Ÿæœ‰ä¼˜åŒ–<br>App Slicingï¼Œappå®‰è£…åŒ…ç˜¦èº«ã€‚iOS 9 åä¼šä» Image Assets ä¸­ä¿ç•™è®¾å¤‡æ”¯æŒçš„å›¾ç‰‡ ï¼ˆ2x æˆ–è€… 3xï¼‰<br>iOS 11 åçš„ Preserve Vector Dataã€‚æ”¯æŒçŸ¢é‡å›¾çš„åŠŸèƒ½ï¼Œæ”¾å¤§ä¹Ÿä¸ä¼šå¤±çœŸ</p>
<h3 id="Advanced-Image-Effects"><a href="#Advanced-Image-Effects" class="headerlink" title="Advanced Image Effects"></a>Advanced Image Effects</h3><p>å¯¹äºå›¾ç‰‡çš„å®æ—¶å¤„ç†æ¨èä½¿ç”¨CoreImageæ¡†æ¶ã€‚<br>ä¾‹å¦‚å°†ä¸€å¼ å›¾ç‰‡çš„ç°åº¦å€¼è¿›è¡Œè°ƒæ•´è¿™æ ·çš„æ“ä½œï¼Œæœ‰æ»´å°ä¼™ä¼´å¯èƒ½ä½¿ç”¨CoreGraphicsè·å–å›¾åƒçš„æ¯ä¸ªåƒç´ ç‚¹æ•°æ®ï¼Œç„¶åæ”¹å˜ç°åº¦å€¼ï¼Œæœ€ç»ˆç”Ÿæˆç›®æ ‡å›¾æ ‡ï¼Œè¿™ç§åšæ³•å°†å¤§é‡gpuæ“…é•¿çš„å·¥ä½œæ”¾åœ¨äº†cpuä¸Šå¤„ç†ï¼Œåˆç†çš„åšæ³•æ˜¯: ä½¿ç”¨CoreImageçš„æ»¤é•œfilteræˆ–è€…metalï¼ŒOpenGLçš„shaderï¼Œè®©å›¾åƒå¤„ç†çš„å·¥ä½œäº¤ç»™GPUå»åšã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">let sharedContext = <span class="built_in">CIContext</span>(options: [.useSoftwareRenderer : <span class="literal">false</span>])</span><br><span class="line">func coreImage_resize(oriImg:<span class="built_in">UIImage</span>,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>? &#123;</span><br><span class="line">    </span><br><span class="line">    guard  let cgImage = oriImg.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">    let scale = (Double)(size.width) / (Double)(oriImg.size.width)</span><br><span class="line">    let image = <span class="built_in">CIImage</span>(cgImage: cgImage)</span><br><span class="line">    </span><br><span class="line">    let filter = <span class="built_in">CIFilter</span>(name: <span class="string">"CILanczosScaleTransform"</span>)</span><br><span class="line">    filter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">    filter?.setValue(<span class="built_in">NSNumber</span>(value:scale), forKey: kCIInputScaleKey)</span><br><span class="line">    filter?.setValue(<span class="number">1.0</span>, forKey:kCIInputAspectRatioKey)</span><br><span class="line">    </span><br><span class="line">    guard let outputCIImage = filter?.outputImage,</span><br><span class="line">        let outputCGImage = sharedContext.createCGImage(outputCIImage,</span><br><span class="line">                                                        from: outputCIImage.extent)</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIImage</span>(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Drawing-Off-Screen"><a href="#Drawing-Off-Screen" class="headerlink" title="Drawing Off-Screen"></a>Drawing Off-Screen</h3><p>å¯¹äºéœ€è¦ç¦»å±æ¸²æŸ“çš„åœºæ™¯æ¨èä½¿ç”¨UIGraphicsImageRendereræ›¿ä»£UIGraphicsBeginImageContextï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¹¶ä¸”æ”¯æŒå¹¿è‰²åŸŸã€‚</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">func uikit_resize(oriImg:<span class="built_in">UIImage</span>?,size:<span class="built_in">CGSize</span>) -&gt; <span class="built_in">UIImage</span>?&#123;</span><br><span class="line">    let hasAlpha = <span class="literal">false</span></span><br><span class="line">    let scale: <span class="built_in">CGFloat</span> = <span class="number">0.0</span> <span class="comment">// Automatically use scale factor of main screen</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">UIGraphicsBeginImageContextWithOptions</span>(size, !hasAlpha, scale)</span><br><span class="line">    oriImg!.draw(<span class="keyword">in</span>: <span class="built_in">CGRect</span>(origin: .zero, size: size))</span><br><span class="line">    </span><br><span class="line">    let resizedImage = <span class="built_in">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="built_in">UIGraphicsEndImageContext</span>()</span><br><span class="line">    <span class="keyword">return</span> resizedImage!</span><br><span class="line"></span><br><span class="line">    <span class="comment">//in iOS 10 UIGraphicsImageRenderer</span></span><br><span class="line"><span class="comment">//    let render  = UIGraphicsImageRenderer(size: size)</span></span><br><span class="line"><span class="comment">//    return render.image(actions: &#123; (context) in</span></span><br><span class="line"><span class="comment">//        oriImg?.draw(in: CGRect(origin: .zero, size: size))</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>iOSå›¾ç‰‡</category>
      </categories>
      <tags>
        <tag>iOS</tag>
        <tag>å›¾ç‰‡</tag>
      </tags>
  </entry>
</search>
